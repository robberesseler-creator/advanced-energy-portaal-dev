<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Magazijn">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<title>Magazijn</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script>
  firebase.initializeApp({
    apiKey: "AIzaSyBKU-wCjV4Au4ngRG52Zmmxbzc3N3D8VBU",
    authDomain: "advanced-intranet.firebaseapp.com",
    projectId: "advanced-intranet",
    storageBucket: "advanced-intranet.firebasestorage.app",
    messagingSenderId: "309856938024",
    appId: "1:309856938024:web:2108715f92c5dea2da2d1d"
  });
  const db = firebase.firestore();
  const storage = firebase.storage();

  // Upload foto naar Firebase Storage, retourneert download URL
  async function uploadToStorage(dataUrl, path) {
    try {
      const response = await fetch(dataUrl);
      const blob = await response.blob();
      const ref = storage.ref().child(path);
      await ref.put(blob);
      const url = await ref.getDownloadURL();
      console.log('‚úÖ Foto ge√ºpload:', path);
      return url;
    } catch(e) {
      console.warn('‚ö†Ô∏è Foto upload error:', e);
      return null;
    }
  }

  // Sync alle foto's zonder storageUrl naar Firebase Storage
  let syncRunning = false;
  async function syncPhotosToCloud() {
    if (syncRunning) return;
    syncRunning = true;
    const photoFields = ['photos','artikelPhotos','stickerPhotos','bonPhotos','schadePhotos','seriePhotos'];
    let uploaded = 0;
    for (const it of items) {
      if (it.deleted) continue;
      for (const field of photoFields) {
        if (!it[field]) continue;
        for (const photo of it[field]) {
          if (photo.storageUrl || !photo.data) continue;
          const path = 'magazijn/' + (it.uuid||it.id) + '/' + field + '/' + Date.now() + '_' + Math.random().toString(36).substr(2,4) + '.jpg';
          const url = await uploadToStorage(photo.data, path);
          if (url) {
            photo.storageUrl = url;
            photo.storagePath = path;
            uploaded++;
          }
        }
      }
    }
    syncRunning = false;
    if (uploaded > 0) {
      console.log('‚úÖ ' + uploaded + ' foto(s) naar cloud ge√ºpload');
      showToast(uploaded + ' foto(\'s) ge√ºpload naar cloud ‚òÅÔ∏è');
      // Sla op naar ZOWEL localStorage als Firestore
      saveData();
    }
  }
</script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap');
  :root{
    --bg:#0f1117;--surface:#181c27;--surface2:#1e2336;--border:#2a2f45;--border-hover:#3d4460;
    --accent:#4f8ef7;--accent2:#38d9a9;--text:#e8ecf5;--text2:#8b92b0;--text3:#555e7d;
    --success:#38d9a9;--danger:#ff5c5c;--warn:#f7c948;--radius:12px;--radius-sm:8px;
    /* Category colors */
    --cat-paars:#a78bfa;--cat-oranje:#f97316;--cat-geel:#f7c948;
    --cat-rood:#ff5c5c;--cat-blauw:#38b6ff;--cat-roze:#f472b6;--cat-wit:#e8ecf5;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  html{height:100%;-webkit-text-size-adjust:100%;}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;
    padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:#000;
    border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;}
  .logo{display:flex;align-items:center;gap:12px;cursor:pointer;}
  .logo svg{flex-shrink:0;}
  .logo-text{display:flex;flex-direction:column;gap:1px;}
  .logo-title{font-size:15px;font-weight:700;letter-spacing:-.3px;color:#fff;}
  .logo-sub{font-size:11px;font-weight:400;color:rgba(255,255,255,.7);}
  .hbtn{font-size:12px;color:var(--text2);background:var(--surface2);border:1px solid var(--border);
    padding:5px 12px;border-radius:20px;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;}
  .cam-inline{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;
    font-size:22px;filter:brightness(1.3) saturate(0);transition:all .2s;flex-shrink:0;}
  .cam-inline:hover{transform:scale(1.1);filter:brightness(1.5) saturate(0);}
  main{max-width:680px;margin:0 auto;padding:28px 16px 80px;}
  @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

  /* ‚ïê‚ïê HUB VIEW ‚ïê‚ïê */
  .hub-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:28px;}
  .hub-card{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);
    padding:24px 16px;cursor:pointer;transition:all .2s;text-align:center;position:relative;}
  .hub-card:hover{border-color:var(--border-hover);transform:translateY(-2px);}
  .hub-card .hc-icon{width:100%;height:6px;border-radius:3px;border:none;}
  .hub-card .hc-name{font-size:13px;font-weight:600;}
  .hc-top{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer;padding:4px 0;}
  .hub-card .hc-count{font-size:28px;font-weight:700;font-family:'DM Mono',monospace;}
  .hc-dual{display:flex;align-items:center;justify-content:center;gap:24px;margin-top:4px;}
  .hc-c{display:flex;flex-direction:column;align-items:center;gap:2px;padding:4px 8px;border-radius:8px;cursor:pointer;transition:background .15s;}
  .hc-c:hover{background:rgba(255,255,255,.04);}
  .hc-c-num{font-size:24px;font-weight:700;font-family:'DM Mono',monospace;line-height:1;}
  .hc-c-label{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;}
  .hc-c-ok .hc-c-num{color:var(--success);} .hc-c-ok .hc-c-label{color:rgba(56,217,169,.7);}
  .hc-c-nok .hc-c-num{color:var(--danger);} .hc-c-nok .hc-c-label{color:rgba(255,92,92,.7);}
  .hub-card.cat-paars{border-color:rgba(167,139,250,.55);} .hub-card.cat-paars .hc-count{color:var(--cat-paars);}
  .hub-card.cat-paars .hc-icon{background:var(--cat-paars);}
  .hub-card.cat-oranje{border-color:rgba(249,115,22,.55);} .hub-card.cat-oranje .hc-count{color:var(--cat-oranje);}
  .hub-card.cat-oranje .hc-icon{background:var(--cat-oranje);}
  .hub-card.cat-geel{border-color:rgba(247,201,72,.55);} .hub-card.cat-geel .hc-count{color:var(--cat-geel);}
  .hub-card.cat-geel .hc-icon{background:var(--cat-geel);}
  .hub-card.cat-rood{border-color:rgba(255,92,92,.55);} .hub-card.cat-rood .hc-count{color:var(--cat-rood);}
  .hub-card.cat-rood .hc-icon{background:var(--cat-rood);}
  .hub-card.cat-blauw{border-color:rgba(56,182,255,.55);} .hub-card.cat-blauw .hc-count{color:var(--cat-blauw);}
  .hub-card.cat-blauw .hc-icon{background:var(--cat-blauw);}
  .hub-card.cat-roze{border-color:rgba(244,114,182,.55);} .hub-card.cat-roze .hc-count{color:var(--cat-roze);}
  .hub-card.cat-roze .hc-icon{background:var(--cat-roze);}

  /* ‚ïê‚ïê SECTION VIEW ‚ïê‚ïê */
  .panel{display:none;animation:fadeUp .3s ease;} .panel.active{display:block;}
  .sec-header{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
  .sec-back{width:36px;height:36px;border-radius:50%;border:1px solid var(--border);background:var(--surface2);
    display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:var(--text);flex-shrink:0;}
  .sec-back:hover{border-color:var(--border-hover);}
  .sec-title{font-size:20px;font-weight:700;flex:1;}
  .sec-count{font-size:14px;font-weight:700;font-family:'DM Mono',monospace;background:var(--surface2);
    border:1px solid var(--border);padding:4px 12px;border-radius:20px;}

  /* Items list */
  .items{display:flex;flex-direction:column;gap:10px;}
  .item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;animation:fadeUp .3s ease;}
  .item-head{display:flex;align-items:center;gap:10px;padding:14px 16px;cursor:pointer;user-select:none;}
  .item-head:hover{background:rgba(255,255,255,.02);}
  .item-num{width:28px;height:28px;border-radius:50%;flex-shrink:0;background:var(--surface2);
    border:1px solid var(--border);display:flex;align-items:center;justify-content:center;
    font-size:11px;font-weight:700;font-family:'DM Mono',monospace;}
  .item-label{flex:1;font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .item-ts{font-size:10px;color:var(--text3);flex-shrink:0;}
  .item-supplier{display:flex;align-items:center;gap:4px;flex-shrink:0;}
  .item-supplier img{width:20px;height:20px;border-radius:4px;object-fit:contain;background:#fff;}
  .item-arrow{color:var(--text3);font-size:12px;transition:transform .25s;flex-shrink:0;}
  .item.open .item-arrow{transform:rotate(180deg);}
  .item-body{overflow:hidden;padding:0 16px;height:0;}
  .item.open .item-body{height:auto;padding:0 16px 16px;}
  .item-del{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);
    background:var(--surface2);display:flex;align-items:center;justify-content:center;
    font-size:13px;cursor:pointer;flex-shrink:0;color:#fff;}
  .item-del:hover{border-color:#ff5c5c;background:rgba(255,92,92,.12);}
  .status-badge{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;
    padding:2px 7px;border-radius:20px;flex-shrink:0;background:rgba(56,217,169,.12);color:var(--success);border:1px solid rgba(56,217,169,.25);}
  .cat-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;border:1px solid rgba(255,255,255,.15);}
  .project-badge{font-size:10px;font-weight:700;font-family:'DM Mono',monospace;padding:2px 7px;border-radius:20px;
    flex-shrink:0;background:var(--surface2);border:1px solid var(--border);color:var(--text2);}

  /* Form */
  label.fl{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;margin-top:14px;}
  textarea.note{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
    color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;resize:none;min-height:60px;outline:none;}
  textarea.note:focus{border-color:var(--accent);}
  .input-field{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
    color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;outline:none;}
  .input-field:focus{border-color:var(--accent);}

  /* Photos */
  .thumbrow{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;}
  .twrap{position:relative;width:80px;height:80px;border-radius:var(--radius-sm);overflow:hidden;
    border:2px solid var(--border);cursor:pointer;}
  .twrap:hover{border-color:var(--accent);}
  .twrap img{width:100%;height:100%;object-fit:cover;display:block;}
  .tdel{position:absolute;top:3px;right:3px;width:18px;height:18px;border-radius:50%;
    background:rgba(0,0,0,.8);border:none;color:#fff;font-size:11px;cursor:pointer;
    display:flex;align-items:center;justify-content:center;z-index:2;}
  .edit-badge{position:absolute;bottom:0;left:0;right:0;background:rgba(79,142,247,.85);
    color:#fff;font-size:9px;font-weight:700;text-align:center;padding:2px 0;}
  .photoarea{border:2px dashed var(--border);border-radius:var(--radius-sm);padding:22px 16px;
    text-align:center;cursor:pointer;position:relative;margin-bottom:10px;}
  .photoarea:hover{border-color:var(--accent);background:rgba(79,142,247,.04);}
  .photoarea input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}

  /* Supplier grid */
  .supplier-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;margin-bottom:12px;}
  .sup-btn{background:var(--surface2);border:2px solid var(--border);border-radius:var(--radius-sm);
    padding:8px 6px;cursor:pointer;text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px;transition:all .15s;}
  .sup-btn:hover{border-color:var(--border-hover);}
  .sup-btn.active{border-color:var(--accent);background:rgba(79,142,247,.08);}
  .sup-btn img{width:36px;height:36px;border-radius:6px;object-fit:contain;background:#fff;padding:2px;}
  .sup-btn .sup-name{font-size:9px;font-weight:600;color:var(--text2);line-height:1.2;}
  .sup-btn.active .sup-name{color:var(--accent);}
  .sup-add{border-style:dashed;}

  /* Buttons */
  .btn{padding:10px 20px;border:none;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;
    font-size:13px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;}
  .btn-p{background:linear-gradient(135deg,var(--accent),#3a7de8);color:#fff;}
  .btn-s{background:var(--surface2);border:1px solid var(--border);color:var(--text);}
  .btn-mail{background:linear-gradient(135deg,#a78bfa,#7c5cbf);color:#fff;}
  .btn-add{background:var(--surface2);border:2px dashed var(--border);color:var(--text2);width:100%;
    justify-content:center;padding:14px;font-size:14px;margin-top:12px;border-radius:var(--radius);}
  .btn-add:hover{border-color:var(--accent);color:var(--accent);}
  .btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;}

  /* Toast */
  .toast{display:none;background:var(--success);color:#0f2a22;font-size:13px;font-weight:600;
    padding:10px 18px;border-radius:12px;text-align:center;position:fixed;bottom:24px;left:50%;
    transform:translateX(-50%);z-index:9999;max-width:90vw;box-shadow:0 4px 20px rgba(0,0,0,.4);}
  .toast.show{display:block;animation:fadeUp .2s ease;}
  .toast.error{background:var(--danger);color:#fff;}

  /* Modal */
  .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;align-items:center;justify-content:center;}
  .modal-bg.show{display:flex;}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
    padding:24px;width:90%;max-width:400px;animation:slideUp .3s ease;}
  .modal h3{font-size:16px;font-weight:700;margin-bottom:16px;}
  .modal-actions{display:flex;gap:8px;margin-top:16px;}

  /* Lightbox */
  .lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:300;align-items:center;justify-content:center;cursor:pointer;}
  .lightbox.show{display:flex;}
  .lightbox img{max-width:95%;max-height:90vh;border-radius:8px;}

  /* Email preview */
  .email-preview{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
    padding:14px;margin-top:12px;font-size:12px;line-height:1.6;color:var(--text2);}

  /* ‚ïê‚ïê CAMERA WIZARD ‚ïê‚ïê */
  .wizard-overlay{display:none;position:fixed;inset:0;z-index:250;background:rgba(0,0,0,.85);
    align-items:center;justify-content:center;backdrop-filter:blur(8px);}
  .wizard-overlay.show{display:flex;}
  .wizard{background:var(--surface);border:1px solid var(--border);border-radius:16px;
    padding:28px 24px;width:92%;max-width:440px;animation:slideUp .35s ease;text-align:center;}
  .wizard h3{font-size:18px;font-weight:700;margin-bottom:6px;}
  .wizard .wiz-sub{font-size:13px;color:var(--text2);margin-bottom:24px;line-height:1.5;}
  .wiz-steps{display:flex;gap:12px;margin-bottom:24px;justify-content:center;}
  .wiz-step{display:flex;flex-direction:column;align-items:center;gap:8px;flex:1;max-width:160px;}
  .wiz-step-circle{width:60px;height:60px;border-radius:16px;border:2px dashed var(--border);
    display:flex;align-items:center;justify-content:center;font-size:24px;transition:all .3s;
    position:relative;overflow:hidden;}
  .wiz-step-circle.done{border-style:solid;border-color:var(--success);background:rgba(56,217,169,.08);}
  .wiz-step-circle.done img{width:100%;height:100%;object-fit:cover;border-radius:14px;}
  .wiz-step-label{font-size:11px;font-weight:600;color:var(--text2);}
  .wiz-step-num{position:absolute;top:-1px;left:-1px;width:20px;height:20px;border-radius:0 0 8px 0;
    background:var(--accent);color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;}
  .wiz-capture-area{position:relative;margin-bottom:16px;}
  .wiz-capture-btn{width:100%;padding:16px;border:2px dashed var(--accent);border-radius:var(--radius);
    background:rgba(79,142,247,.06);cursor:pointer;position:relative;transition:all .2s;}
  .wiz-capture-btn:hover{background:rgba(79,142,247,.12);border-color:#6da3fa;}
  .wiz-capture-btn input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
  .wiz-result{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
    padding:14px;margin-top:16px;text-align:left;}
  .wiz-result-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
  .wiz-result-row:last-child{margin-bottom:0;}
  .wiz-result-label{font-size:11px;font-weight:600;color:var(--text3);min-width:80px;}
  .wiz-result-value{font-size:13px;font-weight:600;flex:1;}
  .wiz-color-dot{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.2);}
  .wiz-match-banner{background:rgba(79,142,247,.1);border:1px solid rgba(79,142,247,.3);border-radius:var(--radius-sm);
    padding:12px;margin-top:12px;text-align:left;}
  .wiz-category-change{background:rgba(249,115,22,.1);border:1px solid rgba(249,115,22,.3);border-radius:var(--radius-sm);
    padding:12px;margin-top:12px;text-align:left;}
  .wiz-spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--border);
    border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .wiz-progress{margin-top:16px;}
  .wiz-progress-bar{height:4px;background:var(--surface2);border-radius:2px;overflow:hidden;}
  .wiz-progress-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .3s ease;}
  .wiz-progress-text{font-size:11px;color:var(--text3);margin-top:6px;}

  /* Locatie knoppen */
  .loc-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:16px;}
  .loc-btn{padding:16px 12px;background:var(--surface2);border:2px solid var(--border);border-radius:var(--radius);
    cursor:pointer;text-align:center;font-size:16px;font-weight:700;font-family:'DM Mono',monospace;
    transition:all .15s;color:var(--text);}
  .loc-btn:hover{border-color:var(--accent);background:rgba(79,142,247,.06);}
  .loc-btn:active{transform:scale(.97);}
  .loc-btn small{display:block;font-size:10px;font-weight:500;color:var(--text2);margin-top:2px;font-family:'DM Sans',sans-serif;}
  /* ‚ïê‚ïê EDITOR ‚ïê‚ïê */
  #editor-overlay{position:fixed;inset:0;z-index:999;background:#0a0c14;display:none;flex-direction:column;}
  #editor-overlay.open{display:flex;}
  .ed-topbar{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--surface);
    border-bottom:1px solid var(--border);flex-wrap:wrap;}
  .ed-title{font-size:13px;font-weight:700;color:var(--text);margin-right:4px;}
  .tool-sep{width:1px;height:26px;background:var(--border);margin:0 3px;flex-shrink:0;}
  .tbtn{width:36px;height:36px;border-radius:var(--radius-sm);border:1px solid var(--border);
    background:var(--surface2);color:var(--text);font-size:15px;cursor:pointer;
    display:flex;align-items:center;justify-content:center;flex-shrink:0;}
  .tbtn.active{background:var(--accent);border-color:var(--accent);}
  .tbtn.danger{border-color:rgba(255,92,92,.4);color:#ff5c5c;}
  .cswatch{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;flex-shrink:0;}
  .cswatch.active{border-color:#fff;box-shadow:0 0 0 2px rgba(255,255,255,.3);}
  .ed-actions{display:flex;gap:6px;margin-left:auto;flex-shrink:0;}
  .ed-canvas-wrap{flex:1;display:flex;align-items:center;justify-content:center;overflow:auto;background:#0a0c14;padding:8px;}
  #ed-canvas{max-width:100%;touch-action:none;cursor:crosshair;display:block;border-radius:4px;}

  @media(max-width:500px){.hub-grid{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>
<header>
  <div class="logo" onclick="goHome()">
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="16" cy="16" r="15" stroke="url(#ae-grad)" stroke-width="1.5" fill="rgba(79,142,247,.08)"/>
      <text x="16" y="21" text-anchor="middle" font-family="DM Sans,sans-serif" font-size="13" font-weight="700" fill="url(#ae-grad)">AE</text>
      <defs><linearGradient id="ae-grad" x1="0" y1="0" x2="32" y2="32"><stop offset="0%" stop-color="#6da3fa"/><stop offset="100%" stop-color="#4f8ef7"/></linearGradient></defs>
    </svg>
    <div class="logo-text">
      <div class="logo-title">Advanced Energy</div>
      <div class="logo-sub" id="header-date"></div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <div onclick="changeMagazijnier()" style="cursor:pointer;display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);padding:4px 12px;border-radius:20px">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span id="header-user" style="font-size:12px;font-weight:600;color:var(--text)"></span>
    </div>
    <button class="hbtn" onclick="exportData()">üíæ Export</button>
  </div>
</header>

<!-- ‚ïê‚ïê EDITOR ‚ïê‚ïê -->
<div id="editor-overlay">
  <div class="ed-topbar">
    <span class="ed-title">Foto bewerken</span>
    <button class="tbtn" id="tool-arrow" onclick="setTool('arrow')" title="Pijl">‚û§</button>
    <button class="tbtn" id="tool-line" onclick="setTool('line')" title="Lijn" style="font-size:18px;font-weight:700">‚ï±</button>
    <button class="tbtn" id="tool-rect" onclick="setTool('rect')" title="Rechthoek" style="font-size:18px;font-weight:700">‚ñ°</button>
    <button class="tbtn" id="tool-circle" onclick="setTool('circle')" title="Cirkel" style="font-size:20px;font-weight:700">‚óã</button>
    <button class="tbtn" id="tool-text" onclick="setTool('text')" title="Tekst" style="font-size:16px;font-weight:700">T</button>
    <button class="tbtn" id="tool-select" onclick="setTool('select')" title="Selecteren">üëÜ</button>
    <div class="tool-sep"></div>
    <div class="cswatch" id="csw-cat" style="background:#a78bfa" onclick="setColor(this.style.background,this)"></div>
    <div class="cswatch" style="background:#ffffff" onclick="setColor('#ffffff',this)"></div>
    <div class="cswatch" style="background:#000000;border:1px solid rgba(255,255,255,.3)" onclick="setColor('#000000',this)"></div>
    <div class="tool-sep"></div>
    <button class="tbtn" onclick="undoLast()" title="Ongedaan">‚Ü©Ô∏è</button>
    <button class="tbtn danger" id="tool-del-sel" onclick="deleteSelected()" title="Selectie verwijderen" style="display:none">‚úï</button>
    <div id="ed-font-ctrl" style="display:none">
      <button class="tbtn" onclick="changeFontSize(-4)" title="Kleiner" style="font-size:14px;width:32px;height:32px;font-weight:700">A-</button>
      <span id="ed-font-size" style="font-size:13px;color:var(--text);font-family:'DM Mono',monospace;min-width:28px;text-align:center;font-weight:700">18</span>
      <button class="tbtn" onclick="changeFontSize(4)" title="Groter" style="font-size:14px;width:32px;height:32px;font-weight:700">A+</button>
    </div>
    <div class="ed-actions">
      <button class="btn btn-p" onclick="saveEditor()" style="padding:8px 16px;font-size:13px">‚úÖ Opslaan</button>
      <button class="btn btn-s" onclick="closeEditor()" style="padding:8px 16px;font-size:13px">Terug</button>
    </div>
  </div>
  <div class="ed-canvas-wrap">
    <canvas id="ed-canvas"></canvas>
    <div id="text-overlay" style="display:none;position:absolute;background:rgba(0,0,0,.7);border:2px solid var(--accent);border-radius:var(--radius-sm);padding:8px;min-width:200px">
      <div style="display:flex;gap:6px;margin-bottom:8px;align-items:center">
        <label style="font-size:11px;color:var(--text2)">Grootte:</label>
        <select id="text-size" style="flex:1;padding:4px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:4px;font-size:12px">
          <option value="14">Klein</option><option value="18" selected>Normaal</option>
          <option value="24">Groot</option><option value="32">Extra groot</option><option value="48">XXL</option>
        </select>
      </div>
      <textarea id="text-input" placeholder="Typ tekst..." style="width:100%;min-height:60px;padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;resize:vertical;outline:none"></textarea>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button onclick="cancelTextInput()" style="flex:1;padding:6px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;color:var(--text);cursor:pointer;font-size:12px;font-weight:600">Terug</button>
        <button onclick="confirmTextInput()" style="flex:1;padding:6px;background:var(--accent);border:none;border-radius:4px;color:#fff;cursor:pointer;font-weight:600;font-size:12px">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê CAMERA WIZARD ‚ïê‚ïê -->
<div class="wizard-overlay" id="wizard-overlay">
  <div class="wizard" id="wizard-content"></div>
</div>

<main>
  <!-- HUB -->
  <div class="panel active" id="panel-hub">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
      <span style="font-size:24px;font-weight:700">Magazijn</span>
      <span class="cam-inline" onclick="startCameraWizard()" title="Scan product">üì∑</span>
    </div>
    <div style="color:var(--text2);font-size:13px;margin-bottom:24px">Selecteer een categorie</div>
    <div class="hub-grid">
      <div class="hub-card cat-paars">
        <div class="hc-top" onclick="openSection('paars')"><div class="hc-icon" style="background:var(--cat-paars)"></div><div class="hc-name">Spare part ‚Äî Stock</div></div>
        <div class="hc-dual"><div class="hc-c hc-c-ok" onclick="openSection('paars','complete')"><div class="hc-c-num" id="hub-paars-ok">0</div><div class="hc-c-label">‚úì compleet</div></div><div class="hc-c hc-c-nok" onclick="openSection('paars','incomplete')"><div class="hc-c-num" id="hub-paars-nok">0</div><div class="hc-c-label">‚úó open</div></div></div>
      </div>
      <div class="hub-card cat-oranje">
        <div class="hc-top" onclick="openSection('oranje')"><div class="hc-icon" style="background:var(--cat-oranje)"></div><div class="hc-name">Spare part ‚Äî Interventie</div></div>
        <div class="hc-dual"><div class="hc-c hc-c-ok" onclick="openSection('oranje','complete')"><div class="hc-c-num" id="hub-oranje-ok">0</div><div class="hc-c-label">‚úì compleet</div></div><div class="hc-c hc-c-nok" onclick="openSection('oranje','incomplete')"><div class="hc-c-num" id="hub-oranje-nok">0</div><div class="hc-c-label">‚úó open</div></div></div>
      </div>
      <div class="hub-card cat-geel">
        <div class="hc-top" onclick="openSection('geel')"><div class="hc-icon" style="background:var(--cat-geel)"></div><div class="hc-name">Niet volledig</div></div>
        <div class="hc-dual"><div class="hc-c hc-c-ok" onclick="openSection('geel','complete')"><div class="hc-c-num" id="hub-geel-ok">0</div><div class="hc-c-label">‚úì compleet</div></div><div class="hc-c hc-c-nok" onclick="openSection('geel','incomplete')"><div class="hc-c-num" id="hub-geel-nok">0</div><div class="hc-c-label">‚úó open</div></div></div>
      </div>
      <div class="hub-card cat-rood">
        <div class="hc-top" onclick="openSection('rood')"><div class="hc-icon" style="background:var(--cat-rood)"></div><div class="hc-name">Beschadigd / Retour lev.</div></div>
        <div class="hc-dual"><div class="hc-c hc-c-ok" onclick="openSection('rood','complete')"><div class="hc-c-num" id="hub-rood-ok">0</div><div class="hc-c-label">‚úì compleet</div></div><div class="hc-c hc-c-nok" onclick="openSection('rood','incomplete')"><div class="hc-c-num" id="hub-rood-nok">0</div><div class="hc-c-label">‚úó open</div></div></div>
      </div>
      <div class="hub-card cat-blauw">
        <div class="hc-top" onclick="openSection('blauw')"><div class="hc-icon" style="background:var(--cat-blauw)"></div><div class="hc-name">Retour van werf</div></div>
        <div class="hc-dual"><div class="hc-c hc-c-ok" onclick="openSection('blauw','complete')"><div class="hc-c-num" id="hub-blauw-ok">0</div><div class="hc-c-label">‚úì compleet</div></div><div class="hc-c hc-c-nok" onclick="openSection('blauw','incomplete')"><div class="hc-c-num" id="hub-blauw-nok">0</div><div class="hc-c-label">‚úó open</div></div></div>
      </div>
      <div class="hub-card cat-roze">
        <div class="hc-top" onclick="openSection('roze')"><div class="hc-icon" style="background:var(--cat-roze)"></div><div class="hc-name">Verbruikte spare parts</div></div>
        <div style="text-align:center;margin-top:4px"><div id="hub-roze-total" style="font-size:24px;font-weight:700;font-family:'DM Mono',monospace;color:var(--cat-roze);cursor:pointer" onclick="openSection('roze')">0</div><div style="font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;color:var(--text3)">totaal</div></div>
      </div>
    </div>
  </div>

  <!-- SECTION DETAIL -->
  <div class="panel" id="panel-section">
    <div class="sec-header">
      <div class="sec-back" onclick="backToHub()">‚Üê</div>
      <div class="sec-title" id="sec-title"></div>
      <div id="sec-count" style="display:flex;gap:8px;align-items:center"></div>
    </div>
    <div id="search-wrap" style="margin-bottom:12px;display:flex;gap:8px;align-items:center">
      <input class="input-field" id="search-input" type="search" placeholder="üîç Zoeken op omschrijving, project, serie..." oninput="applySearch()" style="font-size:12px;padding:8px 12px;flex:1"/>
      <div id="sort-toggle" style="display:flex;gap:4px;flex-shrink:0">
        <button onclick="setSort('newest')" id="sort-newest" class="sort-pill active" style="font-size:10px;font-weight:600;padding:6px 10px;border-radius:20px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;white-space:nowrap;font-family:'DM Sans',sans-serif;transition:all .15s">Nieuwste</button>
        <button onclick="setSort('modified')" id="sort-modified" class="sort-pill" style="font-size:10px;font-weight:600;padding:6px 10px;border-radius:20px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;white-space:nowrap;font-family:'DM Sans',sans-serif;transition:all .15s">Gewijzigd</button>
      </div>
    </div>
    <div class="items" id="items-container"></div>
    <button class="btn btn-add" onclick="addItem()" id="btn-add-item">+ Nieuw item toevoegen</button>
  </div>
</main>

<!-- Modals -->
<div class="modal-bg" id="modal-supplier">
  <div class="modal">
    <h3>Leverancier toevoegen</h3>
    <label class="fl" style="margin-top:0">Naam:</label>
    <input class="input-field" id="new-sup-name" placeholder="Naam leverancier" onkeydown="if(event.key==='Enter')saveNewSupplier()"/>
    <label class="fl">Logo:</label>
    <div style="position:relative">
      <input type="file" accept="image/*" id="new-sup-logo-file" style="position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%"/>
      <div id="sup-logo-preview" style="border:2px dashed var(--border);border-radius:var(--radius-sm);padding:10px;text-align:center;font-size:12px;color:var(--text2);cursor:pointer">Klik om logo te uploaden</div>
    </div>
    <label class="fl">E-mail:</label>
    <input class="input-field" id="new-sup-email" placeholder="info@leverancier.be" type="email" onkeydown="if(event.key==='Enter')saveNewSupplier()"/>
    <div class="modal-actions">
      <button class="btn btn-p" onclick="saveNewSupplier()">Opslaan</button>
      <button class="btn btn-s" onclick="closeModal('modal-supplier')">Annuleer</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-email">
  <div class="modal" style="max-width:500px">
    <h3>üìß E-mail naar leverancier</h3>
    <div id="email-content"></div>
    <div class="modal-actions">
      <button class="btn btn-mail" onclick="sendEmail()">üìß Verstuur via mail</button>
      <button class="btn btn-s" onclick="closeModal('modal-email')">Sluiten</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-del-sup">
  <div class="modal" style="text-align:center">
    <h3>Leverancier verwijderen?</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Ben je zeker dat je <strong id="del-sup-name"></strong> wil verwijderen?<br><span style="font-size:11px">Bestaande items behouden de leverancier info.</span></p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-p" style="background:linear-gradient(135deg,var(--danger),#cc3333);min-width:80px" onclick="confirmDeleteSup()">Ja</button>
      <button class="btn btn-s" style="min-width:80px" onclick="closeModal('modal-del-sup')">Nee</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-delete">
  <div class="modal">
    <h3>‚ö†Ô∏è Item verwijderen</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Dit item bevat foto's. Geef een reden of vervolgactie op om te verwijderen.</p>
    <label class="fl" style="margin-top:0">Reden / vervolgactie: <span style="color:var(--danger)">*</span></label>
    <textarea class="note" id="delete-reason" placeholder="Bijv. dubbel ingegeven, foutieve registratie, opgelost via credit nota..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();confirmDelete()}"></textarea>
    <div class="modal-actions">
      <button class="btn btn-p" style="background:linear-gradient(135deg,var(--danger),#cc3333)" onclick="confirmDelete()">Verwijderen</button>
      <button class="btn btn-s" onclick="closeModal('modal-delete')">Annuleer</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-category-change">
  <div class="modal" style="text-align:center">
    <h3>Categorie wijzigen?</h3>
    <div id="cat-change-content"></div>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:16px">
      <button class="btn btn-p" style="min-width:100px" onclick="confirmCategoryChange()">Ja, wijzig</button>
      <button class="btn btn-s" style="min-width:100px" onclick="denyCategoryChange()">Nee, behoud</button>
    </div>
  </div>
</div>

<div class="lightbox" id="lightbox" onclick="this.classList.remove('show')"><img id="lb-img"/></div>

<!-- ‚ïê‚ïê ACTIE MODAL (Spare part) ‚ïê‚ïê -->
<div class="modal-bg" id="modal-action">
  <div class="modal" style="max-width:400px">
    <h3 id="action-modal-title">‚ö° Actie</h3>
    <p style="font-size:12px;color:var(--text2);margin-bottom:4px" id="action-item-info"></p>

    <!-- STAP 1: kies type -->
    <div id="action-step1" style="margin:16px 0">
      <p style="font-size:12px;color:var(--text2);margin-bottom:10px">Kies een actie:</p>
      <div id="action-buttons" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>

    <!-- STAP 2: vul referentie in -->
    <div id="action-step2" style="display:none;margin:16px 0">
      <div id="action-type-badge" style="display:inline-block;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;color:#fff;margin-bottom:12px"></div>
      <button onclick="resetActionStep()" style="background:none;border:none;color:var(--text3);font-size:11px;cursor:pointer;margin-left:8px;text-decoration:underline">wijzig</button>
      <div id="action-ref-wrap">
        <label class="fl" style="margin-top:8px" id="action-ref-label">Referentie:</label>
        <input class="input-field" id="action-ref" placeholder="" onkeydown="if(event.key==='Enter')document.getElementById('action-note').focus()"/>
      </div>
      <div id="action-tech-wrap" style="display:none">
        <label class="fl" style="margin-top:8px">Naam technieker:</label>
        <input class="input-field" id="action-tech" placeholder="Naam van de technieker..." onkeydown="if(event.key==='Enter')document.getElementById('action-note').focus()"/>
      </div>
      <label class="fl">Opmerking (optioneel):</label>
      <textarea class="note" id="action-note" placeholder="Extra info..." rows="2"></textarea>
      <div style="display:flex;gap:8px;margin-top:14px">
        <button class="btn btn-p" onclick="confirmAction()" style="flex:1;padding:12px">‚úÖ Bevestigen</button>
        <button class="btn btn-s" onclick="closeModal('modal-action')" style="padding:12px">Annuleer</button>
      </div>
    </div>

    <div id="action-cancel1" class="modal-actions">
      <button class="btn btn-s" onclick="closeModal('modal-action')">Annuleer</button>
    </div>
  </div>
</div>

<div class="toast" id="global-toast"></div>

<script>
// ‚ïê‚ïê CATEGORIES ‚ïê‚ïê
const SEC={
  'paars':{label:'Spare part ‚Äî Stock',color:'#a78bfa',cssClass:'cat-paars'},
  'oranje':{label:'Spare part ‚Äî Interventie',color:'#f97316',cssClass:'cat-oranje'},
  'geel':{label:'Niet volledig',color:'#f7c948',cssClass:'cat-geel'},
  'rood':{label:'Beschadigd / Retour lev.',color:'#ff5c5c',cssClass:'cat-rood'},
  'blauw':{label:'Retour van werf',color:'#38b6ff',cssClass:'cat-blauw'},
  'roze':{label:'Verbruikte spare parts',color:'#f472b6',cssClass:'cat-roze'}
};

// Color detection reference ranges (HSL)
const COLOR_RANGES={
  'paars':{hMin:240,hMax:310,sMin:25,lMin:30,lMax:80},
  'oranje':{hMin:15,hMax:45,sMin:40,lMin:30,lMax:80},
  'geel':{hMin:45,hMax:70,sMin:40,lMin:40,lMax:90},
  'rood':{hMin:0,hMax:15,sMin:35,lMin:25,lMax:70,hMin2:340,hMax2:360},
  'blauw':{hMin:190,hMax:240,sMin:30,lMin:30,lMax:80},
  'wit':{hMin:0,hMax:360,sMin:0,sMax:15,lMin:80,lMax:100}
};

let activeSection='',items=[],nextId=1,toastTimer=null;
let currentLocation=null;
function updateLocation(){if(!navigator.geolocation)return;
  navigator.geolocation.getCurrentPosition(pos=>{currentLocation={lat:pos.coords.latitude.toFixed(5),lng:pos.coords.longitude.toFixed(5)};},()=>{currentLocation=null;},{enableHighAccuracy:false,timeout:5000,maximumAge:60000});}
updateLocation();setInterval(updateLocation,60000);
function locStr(){return currentLocation?currentLocation.lat+','+currentLocation.lng:'‚Äî';}
let suppliers=JSON.parse(localStorage.getItem('mag-suppliers')||'null')||[
  {id:'sma',name:'SMA',logo:'',email:''},{id:'enphase',name:'Enphase',logo:'',email:''},
  {id:'huawei',name:'Huawei',logo:'',email:''},{id:'solis',name:'Solis',logo:'',email:''},
  {id:'pylontech',name:'Pylontech',logo:'',email:''},{id:'daikin',name:'Daikin',logo:'',email:''},
  {id:'renson',name:'Renson',logo:'',email:''},
];
function saveSup(){localStorage.setItem('mag-suppliers',JSON.stringify(suppliers));
  // === FIREBASE SYNC ===
  try{
    const supsForCloud=suppliers.map(s=>{const copy=Object.assign({},s);copy.logo='';return copy;});
    db.collection('magazijn').doc('suppliers').set({
      suppliers:JSON.stringify(supsForCloud),
      lastUpdated:new Date().toISOString()
    }).then(()=>{console.log('‚úÖ Firebase: leveranciers opgeslagen');})
      .catch(e=>{console.warn('‚ö†Ô∏è Firebase suppliers save error:',e);});
  }catch(e){console.warn('Firebase sync error:',e);}
}

function deleteSupplier(sid){
  const sup=suppliers.find(s=>s.id===sid);if(!sup)return;
  const openItems=items.filter(i=>!i.deleted&&i.supplierId===sid).length;
  if(openItems>0){showToast(sup.name+' heeft nog '+openItems+' openstaand(e) item(s)','error');return;}
  deleteSupTarget=sid;
  document.getElementById('del-sup-name').textContent=sup.name;
  document.getElementById('modal-del-sup').classList.add('show');
}
let deleteSupTarget=null;
function confirmDeleteSup(){
  const sup=suppliers.find(s=>s.id===deleteSupTarget);
  if(sup){sup.deleted=true;sup.deletedAt=ts();sup.deletedBy=magazijnier;}
  closeModal('modal-del-sup');saveSup();renderItems();
  showToast((sup?sup.name:'Leverancier')+' verwijderd');
}
function activeSuppliers(){return suppliers.filter(s=>!s.deleted);}
function findSupplier(sid){return suppliers.find(s=>s.id===sid);}
function ts(){return new Date().toLocaleString('nl-BE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}
function initials(n){const l=(n||'?')[0].toUpperCase();return `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='40' height='40' fill='%23555' rx='6'/><text x='20' y='27' text-anchor='middle' fill='white' font-size='16' font-family='sans-serif'>${l}</text></svg>`;}
document.getElementById('header-date').textContent=new Date().toLocaleDateString('nl-BE',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

// ‚ïê‚ïê MAGAZIJNIER ‚ïê‚ïê
let magazijnier=localStorage.getItem('mag-user')||'';
function initUser(){
  if(!magazijnier){changeMagazijnier();}
  else{document.getElementById('header-user').textContent=magazijnier;}
}
function changeMagazijnier(){
  const name=prompt('Naam magazijnier:',magazijnier);
  if(name&&name.trim()){magazijnier=name.trim();localStorage.setItem('mag-user',magazijnier);
    document.getElementById('header-user').textContent=magazijnier;}
  else if(!magazijnier){magazijnier='Onbekend';localStorage.setItem('mag-user',magazijnier);
    document.getElementById('header-user').textContent=magazijnier;}
}

// ‚ïê‚ïê OCR (Tesseract.js) ‚ïê‚ïê
let tesseractLoaded=false;
function loadTesseract(){
  if(tesseractLoaded)return Promise.resolve();
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
    s.onload=()=>{tesseractLoaded=true;res();};s.onerror=rej;document.head.appendChild(s);
  });
}

function ocrFromImage(imgDataUrl){
  return loadTesseract().then(()=>{
    return Tesseract.recognize(imgDataUrl,'eng+nld',{})
      .then(({data:{text}})=>{
        const cleaned=text.replace(/[^a-zA-Z0-9\s\-\.\/]/g,'').trim();
        return cleaned;
      });
  });
}

function ocrSerial(id,files){
  if(!files||!files[0])return;
  const statusEl=document.getElementById('ocr-status-'+id);
  statusEl.style.display='block';statusEl.textContent='‚è≥ Foto wordt geanalyseerd...';
  const reader=new FileReader();
  reader.onload=e=>{
    loadTesseract().then(()=>{
      Tesseract.recognize(e.target.result,'eng',{})
      .then(({data:{text}})=>{
        const cleaned=text.replace(/[^a-zA-Z0-9\s\-\.\/]/g,'').trim();
        const parts=cleaned.split(/\s+/).filter(p=>p.length>=4);
        const serial=parts.join(' ').substring(0,60);
        if(serial){
          const inp=document.getElementById('serial-'+id);
          if(inp)inp.value=serial;
          updateField(id,'serial',serial);
          statusEl.textContent='‚úÖ Serienummer herkend: '+serial;
          showToast('Serienummer herkend');
        } else {
          statusEl.textContent='‚ùå Geen serienummer gevonden. Typ handmatig in.';
          showToast('Geen tekst herkend','error');
        }
        setTimeout(()=>{statusEl.style.display='none';},5000);
      }).catch(err=>{
        statusEl.textContent='‚ùå OCR mislukt: '+err.message;
        showToast('OCR mislukt','error');
      });
    }).catch(()=>{
      statusEl.textContent='‚ùå Tesseract kon niet geladen worden (geen internet?)';
      showToast('OCR niet beschikbaar','error');
    });
  };
  reader.readAsDataURL(files[0]);
}

// ‚ïê‚ïê COLOR DETECTION ‚ïê‚ïê
function rgbToHsl(r,g,b){
  r/=255;g/=255;b/=255;
  const max=Math.max(r,g,b),min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min){h=s=0;}else{
    const d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);
    switch(max){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break;}
  }
  return{h:Math.round(h*360),s:Math.round(s*100),l:Math.round(l*100)};
}

function detectStickerColor(imgDataUrl){
  return new Promise((resolve)=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      const size=200;
      canvas.width=size;canvas.height=size;
      const ctx=canvas.getContext('2d');
      // Sample center region of image (where sticker likely is)
      const sx=img.width*0.15,sy=img.height*0.15;
      const sw=img.width*0.7,sh=img.height*0.7;
      ctx.drawImage(img,sx,sy,sw,sh,0,0,size,size);
      const data=ctx.getImageData(0,0,size,size).data;

      // Collect color votes
      const votes={paars:0,oranje:0,geel:0,rood:0,blauw:0,wit:0};
      const pixelCount=size*size;
      for(let i=0;i<data.length;i+=4){
        const r=data[i],g=data[i+1],b=data[i+2],a=data[i+3];
        if(a<128)continue; // skip transparent
        const hsl=rgbToHsl(r,g,b);
        // Check white first (low saturation, high lightness)
        if(hsl.s<=15&&hsl.l>=80){votes.wit++;continue;}
        // Skip very dark or very desaturated pixels
        if(hsl.l<20||hsl.s<15)continue;
        // Check each color range
        if(matchColor(hsl,'paars'))votes.paars++;
        else if(matchColor(hsl,'oranje'))votes.oranje++;
        else if(matchColor(hsl,'geel'))votes.geel++;
        else if(matchColor(hsl,'rood'))votes.rood++;
        else if(matchColor(hsl,'blauw'))votes.blauw++;
      }

      // Find dominant color
      let best='',bestVotes=0;
      for(const[k,v]of Object.entries(votes)){
        if(v>bestVotes){bestVotes=v;best=k;}
      }
      const confidence=Math.round((bestVotes/pixelCount)*100);

      // Wit = normaal project, not relevant for magazijn
      if(best==='wit')best='';

      resolve({color:best,confidence,votes});
    };
    img.src=imgDataUrl;
  });
}

function matchColor(hsl,colorName){
  const range=COLOR_RANGES[colorName];
  if(!range)return false;
  const h=hsl.h,s=hsl.s,l=hsl.l;
  const sOk=s>=(range.sMin||0)&&(range.sMax===undefined||s<=range.sMax);
  const lOk=l>=(range.lMin||0)&&l<=(range.lMax||100);
  // Handle red wrapping around 0/360
  if(colorName==='rood'){
    return sOk&&lOk&&((h>=range.hMin&&h<=range.hMax)||(h>=range.hMin2&&h<=range.hMax2));
  }
  return sOk&&lOk&&h>=range.hMin&&h<=range.hMax;
}

// ‚ïê‚ïê PROJECT NUMBER EXTRACTION ‚ïê‚ïê
function extractProjectNumber(ocrText){
  // Common patterns: P-12345, PRJ-123, 2024-1234, PV12345, etc.
  const patterns=[
    /\b[A-Z]{1,4}[\-\.\/]?\d{3,8}\b/gi,   // P-12345, PRJ123, PV12345
    /\b\d{4}[\-\.\/]\d{3,6}\b/g,            // 2024-1234
    /\b\d{5,8}\b/g,                           // 12345678
    /\b[A-Z]{2,5}\d{2,8}\b/gi,              // PV12345
  ];
  for(const pat of patterns){
    const matches=ocrText.match(pat);
    if(matches&&matches.length>0){
      // Return first meaningful match
      return matches[0].toUpperCase();
    }
  }
  return '';
}

// ‚ïê‚ïê CAMERA WIZARD ‚ïê‚ïê
let wizStep=0;
let wizOverviewPhoto=null;
let wizStickerPhoto=null;
let wizDetectedColor='';
let wizDetectedProject='';
let wizMatchedItem=null;
let wizCategoryChangeTarget=null;

function startCameraWizard(){
  wizStep=0;wizOverviewPhoto=null;wizStickerPhoto=null;
  wizDetectedColor='';wizDetectedProject='';wizMatchedItem=null;
  document.getElementById('wizard-overlay').classList.add('show');
  renderWizard();
}

function closeWizard(){
  document.getElementById('wizard-overlay').classList.remove('show');
}

function renderWizard(){
  const wiz=document.getElementById('wizard-content');
  if(wizStep===0){
    // Step 0: Intro
    wiz.innerHTML=`
      <h3>üì∑ Product scannen</h3>
      <div class="wiz-sub">Neem 2 foto's om het product te registreren of bij te werken.</div>
      <div class="wiz-steps">
        <div class="wiz-step">
          <div class="wiz-step-circle"><span class="wiz-step-num">1</span>üì¶</div>
          <div class="wiz-step-label">Overzichtsfoto<br><small style="color:var(--text3)">Volledig product</small></div>
        </div>
        <div class="wiz-step">
          <div class="wiz-step-circle"><span class="wiz-step-num">2</span>üè∑Ô∏è</div>
          <div class="wiz-step-label">Stickerfoto<br><small style="color:var(--text3)">Close-up sticker</small></div>
        </div>
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn btn-p" style="flex:1" onclick="wizStep=1;renderWizard()">Start</button>
        <button class="btn btn-s" style="flex:1" onclick="closeWizard()">Annuleer</button>
      </div>`;
  } else if(wizStep===1){
    // Step 1: Overview photo
    wiz.innerHTML=`
      <h3>üì¶ Stap 1: Overzichtsfoto</h3>
      <div class="wiz-sub">Neem een foto van het volledige product op afstand.</div>
      <div class="wiz-steps">
        <div class="wiz-step">
          <div class="wiz-step-circle" id="wiz-preview-1">üì¶</div>
          <div class="wiz-step-label" style="color:var(--accent);font-weight:700">Overzicht</div>
        </div>
        <div class="wiz-step">
          <div class="wiz-step-circle" style="opacity:.4">üè∑Ô∏è</div>
          <div class="wiz-step-label">Sticker</div>
        </div>
      </div>
      <div class="wiz-capture-area">
        <div class="wiz-capture-btn">
          <input type="file" accept="image/*" capture="environment" onchange="wizCaptureOverview(this.files)"/>
          <div style="font-size:28px;margin-bottom:4px">üì∑</div>
          <div style="font-size:13px;color:var(--text2);font-weight:600">Tik om foto te maken</div>
        </div>
      </div>
      <button class="btn btn-s" style="width:100%" onclick="wizStep=0;renderWizard()">‚Üê Terug</button>`;
  } else if(wizStep===2){
    // Step 2: Sticker photo
    wiz.innerHTML=`
      <h3>üè∑Ô∏è Stap 2: Stickerfoto</h3>
      <div class="wiz-sub">Neem een close-up foto van de projectsticker op het product.</div>
      <div class="wiz-steps">
        <div class="wiz-step">
          <div class="wiz-step-circle done"><img src="${wizOverviewPhoto}"/></div>
          <div class="wiz-step-label" style="color:var(--success)">‚úì Overzicht</div>
        </div>
        <div class="wiz-step">
          <div class="wiz-step-circle" id="wiz-preview-2">üè∑Ô∏è</div>
          <div class="wiz-step-label" style="color:var(--accent);font-weight:700">Sticker</div>
        </div>
      </div>
      <div class="wiz-capture-area">
        <div class="wiz-capture-btn">
          <input type="file" accept="image/*" capture="environment" onchange="wizCaptureSticker(this.files)"/>
          <div style="font-size:28px;margin-bottom:4px">üì∑</div>
          <div style="font-size:13px;color:var(--text2);font-weight:600">Tik om sticker te fotograferen</div>
        </div>
      </div>
      <button class="btn btn-s" style="width:100%" onclick="wizStep=1;renderWizard()">‚Üê Terug</button>`;
  } else if(wizStep===3){
    // Step 3: Analyzing
    wiz.innerHTML=`
      <h3>üîç Analyseren...</h3>
      <div class="wiz-sub">Even geduld, we analyseren de sticker.</div>
      <div class="wiz-steps">
        <div class="wiz-step">
          <div class="wiz-step-circle done"><img src="${wizOverviewPhoto}"/></div>
          <div class="wiz-step-label" style="color:var(--success)">‚úì Overzicht</div>
        </div>
        <div class="wiz-step">
          <div class="wiz-step-circle done"><img src="${wizStickerPhoto}"/></div>
          <div class="wiz-step-label" style="color:var(--success)">‚úì Sticker</div>
        </div>
      </div>
      <div class="wiz-progress">
        <div class="wiz-progress-bar"><div class="wiz-progress-fill" id="wiz-prog-fill" style="width:10%"></div></div>
        <div class="wiz-progress-text" id="wiz-prog-text">Kleur herkennen...</div>
      </div>`;
    runAnalysis();
  } else if(wizStep===4){
    // Step 4: Results
    const catInfo=SEC[wizDetectedColor]||{label:'Onbekend',color:'#888'};
    const hasMatch=wizMatchedItem!==null;
    const catChanged=hasMatch&&wizMatchedItem.section!==wizDetectedColor;

    let resultHtml=`
      <h3>‚úÖ Analyse compleet</h3>
      <div class="wiz-steps">
        <div class="wiz-step">
          <div class="wiz-step-circle done"><img src="${wizOverviewPhoto}"/></div>
          <div class="wiz-step-label" style="color:var(--success)">‚úì</div>
        </div>
        <div class="wiz-step">
          <div class="wiz-step-circle done"><img src="${wizStickerPhoto}"/></div>
          <div class="wiz-step-label" style="color:var(--success)">‚úì</div>
        </div>
      </div>
      <div class="wiz-result">
        <div class="wiz-result-row">
          <div class="wiz-result-label">Kleur</div>
          <div class="wiz-result-value" style="display:flex;align-items:center;gap:8px">
            <div class="wiz-color-dot" style="background:${catInfo.color}"></div>
            ${catInfo.label}
          </div>
        </div>
        <div class="wiz-result-row">
          <div class="wiz-result-label">Project</div>
          <div class="wiz-result-value" style="font-family:'DM Mono',monospace">${wizDetectedProject||'<span style=color:var(--text3)>Niet herkend</span>'}</div>
        </div>
      </div>`;

    if(!wizDetectedColor){
      resultHtml+=`
        <div style="margin-top:12px;padding:12px;background:rgba(247,201,72,.1);border:1px solid rgba(247,201,72,.3);border-radius:var(--radius-sm);text-align:left">
          <div style="font-size:12px;font-weight:600;color:var(--warn);margin-bottom:4px">‚ö†Ô∏è Kleur niet herkend</div>
          <div style="font-size:11px;color:var(--text2)">De sticker kon niet automatisch herkend worden. Kies handmatig een categorie of het is een witte sticker (normaal project).</div>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px">
          ${Object.entries(SEC).map(([k,v])=>`<button class="btn btn-s" style="flex:1;min-width:100px;justify-content:center;font-size:11px" onclick="wizDetectedColor='${k}';renderWizard()"><div class="wiz-color-dot" style="background:${v.color};width:12px;height:12px"></div>${v.label}</button>`).join('')}
        </div>
        <button class="btn btn-s" style="width:100%;margin-top:8px" onclick="closeWizard()">Annuleer (witte sticker / regulier)</button>`;
    } else if(hasMatch&&catChanged){
      const oldCat=SEC[wizMatchedItem.section]||{label:'?',color:'#888'};
      resultHtml+=`
        <div class="wiz-category-change">
          <div style="font-size:12px;font-weight:700;color:var(--cat-oranje);margin-bottom:8px">‚ö†Ô∏è Categorie verschilt!</div>
          <div style="font-size:12px;color:var(--text2);line-height:1.5">
            Dit product (${wizDetectedProject}) zit momenteel in
            <strong style="color:${oldCat.color}">${oldCat.label}</strong>
            maar de sticker is nu
            <strong style="color:${catInfo.color}">${catInfo.label}</strong>.
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:14px">
          <button class="btn btn-p" style="flex:1" onclick="wizFinishWithCategoryChange()">Wijzig categorie</button>
          <button class="btn btn-s" style="flex:1" onclick="wizFinishKeepCategory()">Behoud huidige</button>
        </div>`;
    } else if(hasMatch){
      resultHtml+=`
        <div class="wiz-match-banner">
          <div style="font-size:12px;font-weight:700;color:var(--accent);margin-bottom:4px">üìã Bestaand item gevonden</div>
          <div style="font-size:12px;color:var(--text2)">Foto's worden toegevoegd aan item #${wizMatchedItem.id}: ${wizMatchedItem.description||'Geen omschrijving'}</div>
        </div>
        <div style="display:flex;gap:10px;margin-top:14px">
          <button class="btn btn-p" style="flex:1" onclick="wizFinishAddToExisting()">Foto's toevoegen</button>
          <button class="btn btn-s" style="flex:1" onclick="closeWizard()">Annuleer</button>
        </div>`;
    } else {
      resultHtml+=`
        <div class="wiz-match-banner" style="background:rgba(56,217,169,.08);border-color:rgba(56,217,169,.25)">
          <div style="font-size:12px;font-weight:700;color:var(--success);margin-bottom:4px">üÜï Nieuw item</div>
          <div style="font-size:12px;color:var(--text2)">Geen bestaand item gevonden. Er wordt een nieuw item aangemaakt in <strong>${catInfo.label}</strong>.</div>
        </div>
        <label class="fl" style="text-align:left">Projectnummer bevestigen:</label>
        <input class="input-field" id="wiz-project-confirm" value="${wizDetectedProject}" placeholder="Projectnummer..." style="margin-bottom:4px"/>
        <label class="fl" style="text-align:left">Omschrijving:</label>
        <input class="input-field" id="wiz-desc-input" placeholder="Korte omschrijving..." style="margin-bottom:4px"/>
        <div style="display:flex;gap:10px;margin-top:14px">
          <button class="btn btn-p" style="flex:1" onclick="wizFinishCreateNew()">Item aanmaken</button>
          <button class="btn btn-s" style="flex:1" onclick="closeWizard()">Annuleer</button>
        </div>`;
    }
    wiz.innerHTML=resultHtml;
  }
}

function wizCaptureOverview(files){
  if(!files||!files[0])return;
  const reader=new FileReader();
  reader.onload=e=>{
    processPhoto(e.target.result).then(dataUrl=>{
      wizOverviewPhoto=dataUrl;
      wizStep=2;renderWizard();
    });
  };
  reader.readAsDataURL(files[0]);
}

function wizCaptureSticker(files){
  if(!files||!files[0])return;
  const reader=new FileReader();
  reader.onload=e=>{
    processPhoto(e.target.result).then(dataUrl=>{
      wizStickerPhoto=dataUrl;
      wizStep=3;renderWizard();
    });
  };
  reader.readAsDataURL(files[0]);
}

function processPhoto(dataUrl){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');const max=1200;
      let w=img.width,h=img.height;
      if(w>max||h>max){if(w>h){h=h*(max/w);w=max;}else{w=w*(max/h);h=max;}}
      canvas.width=w;canvas.height=h;const ctx=canvas.getContext('2d');
      ctx.drawImage(img,0,0,w,h);
      const stamp=ts()+' ‚Äî '+magazijnier;ctx.font='bold 13px DM Sans,sans-serif';
      const tw=ctx.measureText(stamp).width;
      ctx.fillStyle='rgba(0,0,0,.6)';ctx.fillRect(w-tw-16,h-28,tw+12,24);
      ctx.fillStyle='#fff';ctx.fillText(stamp,w-tw-10,h-10);
      resolve(canvas.toDataURL('image/jpeg',.85));
    };
    img.src=dataUrl;
  });
}

async function runAnalysis(){
  const progFill=document.getElementById('wiz-prog-fill');
  const progText=document.getElementById('wiz-prog-text');

  // Step 1: Color detection
  progFill.style.width='30%';
  progText.textContent='üé® Kleur herkennen... (~5 sec)';
  const colorResult=await detectStickerColor(wizStickerPhoto);
  wizDetectedColor=colorResult.color;

  // Step 2: OCR
  progFill.style.width='60%';
  progText.textContent='üî§ Tekst lezen via OCR... (~10 sec)';
  try{
    const ocrText=await ocrFromImage(wizStickerPhoto);
    wizDetectedProject=extractProjectNumber(ocrText);
  }catch(e){
    wizDetectedProject='';
  }

  // Step 3: Match existing items
  progFill.style.width='85%';
  progText.textContent='üîç Matching met bestaande items... (~2 sec)';
  await new Promise(r=>setTimeout(r,400));

  if(wizDetectedProject){
    wizMatchedItem=items.find(i=>!i.deleted&&i.projectNumber&&
      i.projectNumber.toUpperCase()===wizDetectedProject.toUpperCase())||null;
  }else{
    wizMatchedItem=null;
  }

  progFill.style.width='100%';
  progText.textContent='‚úÖ Klaar!';
  await new Promise(r=>setTimeout(r,500));

  wizStep=4;renderWizard();
}

function wizFinishAddToExisting(){
  if(!wizMatchedItem)return;
  // Add photos to existing item
  if(!wizMatchedItem.photos)wizMatchedItem.photos=[];
  if(!wizMatchedItem.stickerPhotos)wizMatchedItem.stickerPhotos=[];
  wizMatchedItem.photos.push({data:wizOverviewPhoto,timestamp:ts()+' ‚Äî '+magazijnier});
  wizMatchedItem.stickerPhotos.push({data:wizStickerPhoto,timestamp:ts()+' ‚Äî '+magazijnier});
  wizMatchedItem.lastModified=ts();wizMatchedItem.modifiedBy=magazijnier;
  saveData();
  syncPhotosToCloud();
  closeWizard();
  openSection(wizMatchedItem.section);
  setTimeout(()=>{toggleItem(wizMatchedItem.id);},200);
  showToast('Foto\'s toegevoegd aan bestaand item');
}

function wizFinishWithCategoryChange(){
  if(!wizMatchedItem)return;
  const oldSection=wizMatchedItem.section;
  wizMatchedItem.section=wizDetectedColor;
  if(!wizMatchedItem.photos)wizMatchedItem.photos=[];
  if(!wizMatchedItem.stickerPhotos)wizMatchedItem.stickerPhotos=[];
  wizMatchedItem.photos.push({data:wizOverviewPhoto,timestamp:ts()+' ‚Äî '+magazijnier});
  wizMatchedItem.stickerPhotos.push({data:wizStickerPhoto,timestamp:ts()+' ‚Äî '+magazijnier});
  wizMatchedItem.categoryHistory=wizMatchedItem.categoryHistory||[];
  wizMatchedItem.categoryHistory.push({from:oldSection,to:wizDetectedColor,at:ts(),by:magazijnier});
  wizMatchedItem.lastModified=ts();wizMatchedItem.modifiedBy=magazijnier;
  saveData();
  syncPhotosToCloud();
  closeWizard();
  openSection(wizDetectedColor);
  setTimeout(()=>{toggleItem(wizMatchedItem.id);},200);
  showToast('Categorie gewijzigd & foto\'s toegevoegd');
}

function wizFinishKeepCategory(){
  if(!wizMatchedItem)return;
  if(!wizMatchedItem.photos)wizMatchedItem.photos=[];
  if(!wizMatchedItem.stickerPhotos)wizMatchedItem.stickerPhotos=[];
  wizMatchedItem.photos.push({data:wizOverviewPhoto,timestamp:ts()+' ‚Äî '+magazijnier});
  wizMatchedItem.stickerPhotos.push({data:wizStickerPhoto,timestamp:ts()+' ‚Äî '+magazijnier});
  wizMatchedItem.lastModified=ts();wizMatchedItem.modifiedBy=magazijnier;
  saveData();
  syncPhotosToCloud();
  closeWizard();
  openSection(wizMatchedItem.section);
  setTimeout(()=>{toggleItem(wizMatchedItem.id);},200);
  showToast('Foto\'s toegevoegd, categorie behouden');
}

function wizFinishCreateNew(){
  const projNum=(document.getElementById('wiz-project-confirm')||{}).value||wizDetectedProject;
  const desc=(document.getElementById('wiz-desc-input')||{}).value||'';
  const item={
    id:nextId++,uuid:genUUID(),section:wizDetectedColor,description:desc,supplierId:'',
    photos:[{data:wizOverviewPhoto,timestamp:ts()+' ‚Äî '+magazijnier}],
    stickerPhotos:[{data:wizStickerPhoto,timestamp:ts()+' ‚Äî '+magazijnier}],
    artikelPhotos:[],seriePhotos:[],schadePhotos:[],bonPhotos:[],reference:'',serial:'',projectNumber:projNum,
    emailSent:false,open:true,deleted:false,timestamp:ts(),createdBy:magazijnier
  };
  items.push(item);saveData();
  syncPhotosToCloud();
  closeWizard();
  openSection(wizDetectedColor);
  setTimeout(()=>{toggleItem(item.id);},200);
  showToast('Nieuw item aangemaakt in '+SEC[wizDetectedColor].label);
}

function ocrProjectFromPhoto(id,files){
  if(!files||!files[0])return;const it=items.find(i=>i.id==id);if(!it)return;
  showToast('Sticker wordt gelezen...');
  const reader=new FileReader();reader.onload=e=>{
    ocrFromImage(e.target.result).then(text=>{
      const pn=extractProjectNumber(text);
      if(pn){it.projectNumber=pn;addAudit(it,'projectnummer','OCR: '+pn);renderItems();saveData();showToast('Project: '+pn);}
      else{showToast('Geen projectnummer herkend','error');}
    }).catch(()=>showToast('OCR mislukt','error'));
  };reader.readAsDataURL(files[0]);}

// Also add location to audit entries
function addAuditLoc(item,action,details){
  if(!item.audit)item.audit=[];
  item.audit.push({at:new Date().toISOString(),ts:ts(),user:magazijnier,action:action,details:details||'',location:locStr()});
}

function addAudit(item,action,details){if(!item.audit)item.audit=[];
  item.audit.push({at:new Date().toISOString(),ts:ts(),user:magazijnier,action:action,details:details||'',location:locStr()});}
// ‚ïê‚ïê LEVERBON QUALITY CHECK ‚ïê‚ïê
function checkImageQuality(dataUrl){
  return new Promise(resolve=>{
    const img=new Image();img.onload=()=>{
      const canvas=document.createElement('canvas');
      const size=300;canvas.width=size;canvas.height=size;
      const ctx=canvas.getContext('2d');
      ctx.drawImage(img,0,0,size,size);
      const data=ctx.getImageData(0,0,size,size).data;

      // 1. Sharpness check via Laplacian variance
      const gray=[];
      for(let i=0;i<data.length;i+=4){gray.push(0.299*data[i]+0.587*data[i+1]+0.114*data[i+2]);}
      let lapSum=0,lapCount=0;
      for(let y=1;y<size-1;y++){for(let x=1;x<size-1;x++){
        const idx=y*size+x;
        const lap=gray[idx-size]+gray[idx+size]+gray[idx-1]+gray[idx+1]-4*gray[idx];
        lapSum+=lap*lap;lapCount++;}}
      const sharpness=Math.sqrt(lapSum/lapCount);

      // 2. Contrast check (std deviation of brightness)
      let sum=0;gray.forEach(g=>sum+=g);const mean=sum/gray.length;
      let varSum=0;gray.forEach(g=>varSum+=(g-mean)*(g-mean));
      const contrast=Math.sqrt(varSum/gray.length);

      // 3. Brightness check
      const brightness=mean;

      // Thresholds
      const isSharp=sharpness>8;
      const hasContrast=contrast>35;
      const goodBrightness=brightness>40&&brightness<230;

      const ok=isSharp&&hasContrast&&goodBrightness;
      let reason='';
      if(!isSharp)reason='Foto is onscherp/wazig';
      else if(!hasContrast)reason='Te weinig contrast ‚Äî tekst moeilijk leesbaar';
      else if(!goodBrightness)reason=brightness<=40?'Foto is te donker':'Foto is overbelicht';

      resolve({ok,sharpness:Math.round(sharpness),contrast:Math.round(contrast),brightness:Math.round(brightness),reason});
    };img.src=dataUrl;
  });
}

let pendingBonItemId=null;let pendingBonDataUrl=null;

function addBonPhoto(id,files){
  if(!files||!files[0])return;
  const it=items.find(i=>i.id==id);if(!it)return;
  if(!it.bonPhotos)it.bonPhotos=[];
  const statusEl=document.getElementById('bon-status-'+id);

  [...files].forEach(file=>{
    const reader=new FileReader();
    reader.onload=e=>{
      processPhoto(e.target.result).then(async dataUrl=>{
        // Show checking status
        if(statusEl){statusEl.style.display='block';
          statusEl.style.background='rgba(79,142,247,.1)';statusEl.style.borderColor='rgba(79,142,247,.3)';
          statusEl.style.color='var(--accent)';statusEl.innerHTML='<div class="wiz-spinner" style="width:14px;height:14px;border-width:2px;vertical-align:middle;margin-right:6px;display:inline-block"></div> Leesbaarheid controleren...';}

        const quality=await checkImageQuality(dataUrl);

        if(quality.ok){
          it.bonPhotos.push({data:dataUrl,timestamp:ts()+' ‚Äî '+magazijnier,qualityOk:true});
          addAudit(it,'bon_foto','Leverbon foto ‚Äî kwaliteit OK (scherpte: '+quality.sharpness+')');
          if(statusEl){statusEl.style.background='rgba(56,217,169,.1)';statusEl.style.color='var(--success)';
            statusEl.textContent='‚úÖ Leverbon goed leesbaar';setTimeout(()=>{statusEl.style.display='none';},3000);}
          renderItems();saveData();showToast('Leverbon toegevoegd');
        } else {
          // Bad quality ‚Äî ask to retake
          pendingBonItemId=id;pendingBonDataUrl=dataUrl;
          if(statusEl){statusEl.style.background='rgba(255,92,92,.1)';statusEl.style.color='var(--danger)';
            statusEl.innerHTML=`‚ö†Ô∏è ${quality.reason}. <strong>Maak de foto opnieuw</strong> of
              <span onclick="forceAcceptBonPhoto()" style="text-decoration:underline;cursor:pointer;color:var(--accent)">toch bewaren</span>`;}
          showToast(quality.reason+' ‚Äî neem opnieuw','error');
          addAudit(it,'bon_foto','Leverbon foto AFGEKEURD ‚Äî '+quality.reason+' (scherpte: '+quality.sharpness+', contrast: '+quality.contrast+')');
          saveData();
        }
      });
    };reader.readAsDataURL(file);
  });
}

function forceAcceptBonPhoto(){
  if(!pendingBonItemId||!pendingBonDataUrl)return;
  const it=items.find(i=>i.id==pendingBonItemId);if(!it)return;
  if(!it.bonPhotos)it.bonPhotos=[];
  it.bonPhotos.push({data:pendingBonDataUrl,timestamp:ts()+' ‚Äî '+magazijnier,qualityOk:false});
  addAudit(it,'bon_foto','Leverbon foto geforceerd bewaard (slechte kwaliteit)');
  const statusEl=document.getElementById('bon-status-'+pendingBonItemId);
  if(statusEl){statusEl.style.display='none';}
  pendingBonItemId=null;pendingBonDataUrl=null;
  renderItems();saveData();showToast('Leverbon bewaard (kwaliteit onvoldoende)');
}

// ‚ïê‚ïê SMART PHOTO CLASSIFICATION ‚ïê‚ïê
// Per-category requirements
const CAT_REQS={
  'paars':{
    need:['photos','artikelPhotos','serial'],
    optional:['bonPhotos','projectNumber','seriePhotos','schadePhotos'],
    labels:{photos:'Algemene productfoto',artikelPhotos:'Foto artikelnummer',seriePhotos:'Foto serienummer',schadePhotos:'Foto schade',bonPhotos:'Leverbon',projectNumber:'Projectnummer',serial:'Artikelnummer (via OCR)',artikelNr:'Artikelnummer (via OCR)'}
  },
  'oranje':{
    need:['photos','artikelPhotos','serial','projectNumber'],
    optional:['bonPhotos','seriePhotos','schadePhotos'],
    labels:{photos:'Algemene productfoto',artikelPhotos:'Foto artikelnummer',seriePhotos:'Foto serienummer',schadePhotos:'Foto schade',bonPhotos:'Leverbon',projectNumber:'Projectnummer (via OCR)',serial:'Serienummer (via OCR)',artikelNr:'Artikelnummer (via OCR)'}
  },
  'geel':{
    need:['photos','stickerPhotos','bonPhotos','projectNumber'],
    optional:['schadePhotos','seriePhotos','artikelPhotos'],
    labels:{photos:'Algemene productfoto',stickerPhotos:'Stickerfoto (projectnummer)',schadePhotos:'Foto schade',seriePhotos:'Foto serienummer',artikelPhotos:'Foto artikelnummer',bonPhotos:'Leverbon',projectNumber:'Projectnummer (via OCR)'}
  },
  'rood':{
    need:['photos','stickerPhotos','bonPhotos','projectNumber','schadePhotos','description'],
    optional:['seriePhotos','artikelPhotos'],
    labels:{photos:'Algemene productfoto',stickerPhotos:'Stickerfoto (projectnummer)',schadePhotos:'Foto schade',seriePhotos:'Foto serienummer',artikelPhotos:'Foto artikelnummer',bonPhotos:'Leverbon',projectNumber:'Projectnummer (via OCR)',description:'Omschrijving schade'}
  },
  'blauw':{
    need:['photos','stickerPhotos','projectNumber'],
    optional:['bonPhotos','schadePhotos','seriePhotos','artikelPhotos'],
    labels:{photos:'Algemene productfoto',stickerPhotos:'Stickerfoto (projectnummer)',schadePhotos:'Foto schade',seriePhotos:'Foto serienummer',artikelPhotos:'Foto artikelnummer',bonPhotos:'Leverbon',projectNumber:'Projectnummer (via OCR)'}
  },
  'roze':{
    need:['photos'],
    optional:['artikelPhotos','seriePhotos','schadePhotos','bonPhotos','stickerPhotos'],
    labels:{photos:'Algemene productfoto',artikelPhotos:'Foto artikelnummer',seriePhotos:'Foto serienummer',schadePhotos:'Foto schade',bonPhotos:'Leverbon',stickerPhotos:'Stickerfoto'}
  },
};

function classifyPhoto(dataUrl,section){
  return new Promise(resolve=>{
    const img=new Image();img.onload=()=>{
      const canvas=document.createElement('canvas');const size=200;
      canvas.width=size;canvas.height=size;
      const ctx=canvas.getContext('2d');
      ctx.drawImage(img,0,0,size,size);
      const data=ctx.getImageData(0,0,size,size).data;
      const totalPx=size*size;

      const colorVotes={paars:0,oranje:0,geel:0,rood:0,blauw:0};
      let satPixels=0,textLikePixels=0;
      const gray=[];

      for(let i=0;i<data.length;i+=4){
        const r=data[i],g=data[i+1],b=data[i+2];
        const gr=0.299*r+0.587*g+0.114*b;
        gray.push(gr);
        const hsl=rgbToHsl(r,g,b);
        if(hsl.s>30&&hsl.l>25&&hsl.l<80){
          satPixels++;
          if(matchColor(hsl,'paars'))colorVotes.paars++;
          else if(matchColor(hsl,'oranje'))colorVotes.oranje++;
          else if(matchColor(hsl,'geel'))colorVotes.geel++;
          else if(matchColor(hsl,'rood'))colorVotes.rood++;
          else if(matchColor(hsl,'blauw'))colorVotes.blauw++;
        }
        if(gr<40||gr>220)textLikePixels++;
      }

      let edgeCount=0;
      for(let y=1;y<size-1;y++){for(let x=1;x<size-1;x++){
        const idx=y*size+x;
        const gx=Math.abs(gray[idx+1]-gray[idx-1]);
        const gy=Math.abs(gray[idx+size]-gray[idx-size]);
        if(gx+gy>50)edgeCount++;
      }}
      const edgeDensity=edgeCount/totalPx;
      let gSum=0;gray.forEach(g=>gSum+=g);const gMean=gSum/gray.length;
      let gVar=0;gray.forEach(g=>gVar+=(g-gMean)*(g-gMean));
      const stdDev=Math.sqrt(gVar/gray.length);

      const satRatio=satPixels/totalPx;
      const bestColor=Object.entries(colorVotes).sort((a,b)=>b[1]-a[1])[0];
      const dominantColorRatio=bestColor[1]/totalPx;
      const textRatio=textLikePixels/totalPx;

      let type='photos';
      let detail='';
      const isSpare=(section==='paars'||section==='oranje');

      // LEVERBON: document detection
      if((edgeDensity>0.18&&textRatio>0.3&&stdDev>50)||(edgeDensity>0.12&&textRatio>0.45)){
        type='bonPhotos';
        detail='Document/leverbon gedetecteerd';
      }
      // STICKER with dominant color = projectnummer sticker
      else if(dominantColorRatio>0.08&&satRatio>0.15){
        type=isSpare?'artikelPhotos':'stickerPhotos';
        detail=isSpare?'Close-up (kleur gedetecteerd)':'Sticker: '+bestColor[0];
      }
      // Close-up with text = artikelnummer (spare parts)
      else if(isSpare&&edgeDensity>0.10&&textRatio>0.2){
        type='artikelPhotos';
        detail='Close-up met tekst (artikelnummer)';
      }
      // Default = product overview
      else{
        type='photos';
        detail='Algemene productfoto';
      }

      resolve({type,detail,dominantColor:bestColor[0],edgeDensity:Math.round(edgeDensity*100),textRatio:Math.round(textRatio*100)});
    };img.src=dataUrl;
  });
}

function getMissing(item){
  const reqs=CAT_REQS[item.section];if(!reqs)return[];
  const missing=[];
  const stringFields=['projectNumber','serial','artikelNr','description'];
  reqs.need.forEach(f=>{
    if(stringFields.includes(f)){
      if(!(item[f]&&item[f].trim()))missing.push(reqs.labels[f]||f);
    } else {
      if(!(item[f]||[]).length)missing.push(reqs.labels[f]||f);
    }
  });
  return missing;
}

function showMissingPopup(item){
  const missing=getMissing(item);
  if(!missing.length)return;
  const el=document.getElementById('classify-status-'+item.id);
  if(el){
    el.style.display='block';
    el.style.background='rgba(249,115,22,.1)';
    el.style.color='var(--cat-oranje)';
    el.innerHTML='‚ö†Ô∏è Nog verplicht: <strong>'+missing.join(', ')+'</strong>. Voeg deze foto\'s nog toe.';
  }
}

async function smartAddPhoto(id,files){
  if(!files||!files[0])return;
  const it=items.find(i=>i.id==id);if(!it)return;
  const statusEl=document.getElementById('classify-status-'+id);
  const isSpare=(it.section==='paars'||it.section==='oranje');
  const labels={photos:'üì¶ Algemeen',stickerPhotos:'üè∑Ô∏è Projectnummer',artikelPhotos:'üîç Artikelnummer',seriePhotos:'üî¢ Serienummer',schadePhotos:'‚ö†Ô∏è Schade',bonPhotos:'üìã Leverbon'};

  for(const file of [...files]){
    const dataUrl=await new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(file);});
    const processed=await processPhoto(dataUrl);

    if(statusEl){statusEl.style.display='block';
      statusEl.style.background='rgba(79,142,247,.1)';statusEl.style.color='var(--accent)';
      statusEl.innerHTML='<span class="wiz-spinner" style="width:14px;height:14px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:6px"></span>Foto analyseren...';}

    const result=await classifyPhoto(processed,it.section);

    // For leverbon: quality check
    if(result.type==='bonPhotos'){
      const quality=await checkImageQuality(processed);
      if(!quality.ok){
        if(statusEl){statusEl.style.background='rgba(255,92,92,.1)';statusEl.style.color='var(--danger)';
          statusEl.innerHTML=`‚ö†Ô∏è Leverbon herkend maar <strong>${quality.reason.toLowerCase()}</strong>. Neem opnieuw of
            <span onclick="forceSmartBon(${id})" style="text-decoration:underline;cursor:pointer;color:var(--accent)">toch bewaren</span>`;}
        window._pendingSmartBon={id,data:processed};
        addAudit(it,'bon_foto','Leverbon AFGEKEURD ‚Äî '+quality.reason);saveData();continue;
      }
      if(!it.bonPhotos)it.bonPhotos=[];
      it.bonPhotos.push({data:processed,timestamp:ts()+' ‚Äî '+magazijnier,qualityOk:true});
      addAudit(it,'bon_foto','Leverbon ‚Äî kwaliteit OK');
    } else {
      if(!it[result.type])it[result.type]=[];
      it[result.type].push({data:processed,timestamp:ts()+' ‚Äî '+magazijnier});
      addAudit(it,result.type==='artikelPhotos'?'artikel_foto':result.type==='stickerPhotos'?'sticker_foto':'foto_toegevoegd',
        'Auto: '+labels[result.type]+' ‚Äî '+result.detail);
    }

    // For artikelPhotos (spare parts): OCR for article/serial number
    if(result.type==='artikelPhotos'){
      try{
        if(statusEl){statusEl.innerHTML='<span class="wiz-spinner" style="width:14px;height:14px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:6px"></span>Artikelnummer lezen (OCR)...';}
        const ocrText=await ocrFromImage(processed);
        const pn=extractProjectNumber(ocrText);
        if(pn&&!it.serial){it.serial=pn;addAudit(it,'serienummer','OCR artikelnummer: '+pn);showToast('Artikelnr: '+pn);}
        else if(pn){showToast('OCR: '+pn);}
      }catch(e){}
    }

    // For sticker: OCR for project number + readability check
    if(result.type==='stickerPhotos'){
      const needsProject=(it.section!=='paars'); // paars = optional
      try{
        if(statusEl){statusEl.style.display='block';statusEl.style.background='rgba(79,142,247,.1)';statusEl.style.color='var(--accent)';
          statusEl.innerHTML='<span class="wiz-spinner" style="width:14px;height:14px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:6px"></span>Projectnummer lezen (OCR)...';}
        const ocrText=await ocrFromImage(processed);
        const pn=extractProjectNumber(ocrText);
        if(pn){
          it.projectNumber=pn;
          addAudit(it,'projectnummer','OCR sticker: '+pn);
          showToast('Project: '+pn);
        } else if(needsProject){
          // Project number required but not readable
          if(statusEl){statusEl.style.display='block';
            statusEl.style.background='rgba(255,92,92,.1)';statusEl.style.color='var(--danger)';
            statusEl.innerHTML='‚ö†Ô∏è <strong>Projectnummer niet leesbaar!</strong> Neem een scherpere foto van de sticker of <span onclick="manualProjectNr('+id+')" style="text-decoration:underline;cursor:pointer;color:var(--accent)">voer handmatig in</span>';}
          addAudit(it,'projectnummer','OCR sticker MISLUKT ‚Äî niet leesbaar');
          saveData();
          // Don't continue to missing check, keep warning visible
          renderItems();continue;
        }
      }catch(e){
        if(needsProject&&statusEl){
          statusEl.style.display='block';statusEl.style.background='rgba(255,92,92,.1)';statusEl.style.color='var(--danger)';
          statusEl.innerHTML='‚ö†Ô∏è <strong>OCR mislukt.</strong> Neem opnieuw of <span onclick="manualProjectNr('+id+')" style="text-decoration:underline;cursor:pointer;color:var(--accent)">voer handmatig in</span>';
        }
      }
    }

    // Show result briefly
    if(statusEl){
      const clr={photos:'rgba(79,142,247,.1)',stickerPhotos:'rgba(167,139,250,.1)',artikelPhotos:'rgba(56,217,169,.1)',bonPhotos:'rgba(247,201,72,.1)'};
      const clrT={photos:'var(--accent)',stickerPhotos:'var(--cat-paars)',artikelPhotos:'var(--success)',bonPhotos:'var(--warn)'};
      statusEl.style.background=clr[result.type]||clr.photos;
      statusEl.style.color=clrT[result.type]||clrT.photos;
      statusEl.textContent='‚úÖ '+labels[result.type]+' ‚Äî '+result.detail;
      showToast('Foto herkend als: '+(labels[result.type]||'Algemeen'));
    }

    it.lastModified=ts();it.modifiedBy=magazijnier;
    renderItems();saveData();

    // After short delay, show missing requirements if any
    await new Promise(r=>setTimeout(r,1500));
    showMissingPopup(it);
  }
}

function manualProjectNr(id){
  const pn=prompt('Voer projectnummer handmatig in:');
  if(pn&&pn.trim()){
    const it=items.find(i=>i.id==id);if(!it)return;
    it.projectNumber=pn.trim().toUpperCase();
    addAudit(it,'projectnummer','Handmatig ingevoerd: '+it.projectNumber);
    const statusEl=document.getElementById('classify-status-'+id);
    if(statusEl)statusEl.style.display='none';
    renderItems();saveData();showToast('Project: '+it.projectNumber);
    // Check remaining missing
    setTimeout(()=>showMissingPopup(it),500);
  }
}

function forceSmartBon(id){
  const pending=window._pendingSmartBon;if(!pending||pending.id!==id)return;
  const it=items.find(i=>i.id==id);if(!it)return;
  if(!it.bonPhotos)it.bonPhotos=[];
  it.bonPhotos.push({data:pending.data,timestamp:ts()+' ‚Äî '+magazijnier,qualityOk:false});
  addAudit(it,'bon_foto','Leverbon geforceerd bewaard');
  const statusEl=document.getElementById('classify-status-'+id);
  if(statusEl)statusEl.style.display='none';
  window._pendingSmartBon=null;
  renderItems();saveData();showToast('Leverbon bewaard');
}

// ‚ïê‚ïê NAVIGATION ‚ïê‚ïê
function goHome(){backToHub();}
let filterMode='all'; // 'all', 'complete', 'incomplete'

function openSection(sec,filter){
  cleanEmptyItems();
  activeSection=sec;
  filterMode=filter||'all';
  sortMode='newest';
  // Reset sort pill styling
  document.querySelectorAll('#sort-toggle button').forEach(b=>{
    b.style.borderColor='var(--border)';b.style.background='var(--surface2)';b.style.color='var(--text2)';
  });
  const nb=document.getElementById('sort-newest');
  if(nb){nb.style.borderColor='var(--accent)';nb.style.background='rgba(79,142,247,.12)';nb.style.color='var(--accent)';}
  // When opening via counter filter, collapse all items (list view)
  if(filter)items.filter(i=>i.section===sec).forEach(i=>i.open=false);
  document.getElementById('panel-hub').classList.remove('active');
  document.getElementById('panel-section').classList.add('active');
  renderItems();
}
function backToHub(){
  cleanEmptyItems();saveData();
  activeSection='';filterMode='all';sortMode='newest';
  const si=document.getElementById('search-input');if(si)si.value='';
  document.getElementById('panel-section').classList.remove('active');
  document.getElementById('panel-hub').classList.add('active');
  updateHub();
}
function applySearch(){renderItems();}
let sortMode='newest';
function setSort(mode){
  sortMode=mode;
  document.querySelectorAll('#sort-toggle button').forEach(b=>{
    b.style.borderColor='var(--border)';b.style.background='var(--surface2)';b.style.color='var(--text2)';
  });
  const active=document.getElementById('sort-'+mode);
  if(active){active.style.borderColor='var(--accent)';active.style.background='rgba(79,142,247,.12)';active.style.color='var(--accent)';}
  renderItems();
}
function updateHub(){
  Object.keys(SEC).forEach(s=>{
    const active=items.filter(i=>i.section===s&&!i.deleted&&!itemIsEmpty(i));
    if(s==='roze'){
      const totalEl=document.getElementById('hub-roze-total');
      if(totalEl)totalEl.textContent=active.length;
      return;
    }
    const complete=active.filter(i=>getMissing(i).length===0);
    const incomplete=active.filter(i=>getMissing(i).length>0);
    const okEl=document.getElementById('hub-'+s+'-ok');
    const nokEl=document.getElementById('hub-'+s+'-nok');
    if(okEl)okEl.textContent=complete.length;
    if(nokEl){nokEl.textContent=incomplete.length;nokEl.parentElement.style.display=incomplete.length?'':'none';}
  });
}

// ‚ïê‚ïê ITEMS ‚ïê‚ïê
function renderItems(){
  let f=items.filter(i=>i.section===activeSection&&!i.deleted);
  const allCount=f.length;
  const completeItems=f.filter(i=>!itemIsEmpty(i)&&getMissing(i).length===0);
  const incompleteItems=f.filter(i=>!itemIsEmpty(i)&&getMissing(i).length>0);

  // Apply filter
  if(filterMode==='complete')f=completeItems;
  else if(filterMode==='incomplete')f=incompleteItems;

  // Apply search
  const searchVal=(document.getElementById('search-input')?.value||'').trim().toLowerCase();
  if(searchVal){
    f=f.filter(i=>{
      const hay=[i.description||'',i.projectNumber||'',i.serial||'',i.reference||'',i.consumedBy||'',findSupplier(i.supplierId)?.name||''].join(' ').toLowerCase();
      return hay.includes(searchVal);
    });
  }

  // Apply sort
  if(sortMode==='modified'){
    f.sort((a,b)=>{
      const aT=a.lastModified||a.timestamp||'';
      const bT=b.lastModified||b.timestamp||'';
      return bT.localeCompare(aT);
    });
  } else {
    f.sort((a,b)=>b.id-a.id);
  }

  // Section title ‚Äî color reflects active filter
  const catInfo=SEC[activeSection]||{label:'?',color:'#888'};
  const titleColor=filterMode==='complete'?'var(--success)':filterMode==='incomplete'?'var(--danger)':catInfo.color;
  document.getElementById('sec-title').innerHTML=`<span onclick="filterMode='all';renderItems()" style="display:inline-block;width:14px;height:14px;border-radius:50%;background:${catInfo.color};margin-right:8px;vertical-align:middle;border:2px solid rgba(255,255,255,.2);cursor:pointer" title="Toon alles"></span><span style="color:${titleColor}">${catInfo.label}</span>`;
  // Hide add button for roze (auto-populated)
  const addBtn=document.getElementById('btn-add-item');
  if(addBtn)addBtn.style.display=activeSection==='roze'?'none':'';

  // Section header counters ‚Äî clickable
  document.getElementById('sec-count').innerHTML=
    `<span class="sec-count" style="color:${filterMode==='complete'?'#fff':'var(--success)'};border-color:rgba(56,217,169,${filterMode==='complete'?'.6':'.3'});cursor:pointer;${filterMode==='complete'?'background:rgba(56,217,169,.15)':''}" onclick="items.filter(i=>i.section===activeSection).forEach(i=>i.open=false);filterMode='complete';renderItems()">‚úì ${completeItems.length}</span>`+
    (incompleteItems.length?`<span class="sec-count" style="color:${filterMode==='incomplete'?'#fff':'var(--danger)'};border-color:rgba(255,92,92,${filterMode==='incomplete'?'.6':'.3'});cursor:pointer;${filterMode==='incomplete'?'background:rgba(255,92,92,.15)':''}" onclick="items.filter(i=>i.section===activeSection).forEach(i=>i.open=false);filterMode='incomplete';renderItems()">‚úó ${incompleteItems.length}</span>`:'')+
    (filterMode!=='all'?`<span class="sec-count" style="color:var(--text3);border-color:var(--border);cursor:pointer;font-size:11px" onclick="filterMode='all';renderItems()">Alle (${allCount})</span>`:'');
  const c=document.getElementById('items-container');
  if(!f.length){c.innerHTML=`<div style="text-align:center;padding:40px;color:var(--text3)"><div style="width:24px;height:24px;border-radius:50%;background:${catInfo.color};margin:0 auto 12px;border:2px solid rgba(255,255,255,.15)"></div><div style="font-size:13px">Nog geen items</div></div>`;return;}
  c.innerHTML=f.map((item,idx)=>{
   try{
    const sup=findSupplier(item.supplierId);
    const supHtml=sup?`<div class="item-supplier"><img src="${sup.logo||initials(sup.name)}" onerror="this.src='${initials(sup.name)}'"/></div>`:'';
    const reqs=CAT_REQS[item.section]||{need:[],optional:[],labels:{}};
    const supName=sup?sup.name:'';
    const itemTitle=(()=>{
      const s=item.section;const parts=[];
      if(supName)parts.push(supName);
      if(s==='paars'||s==='oranje'){
        parts.push(item.serial||(supName?'(geen nr)':''));
      } else if(s==='geel'||s==='blauw'){
        parts.push(item.projectNumber||(supName?'(geen project)':''));
      } else if(s==='rood'){
        const tagL={'retour-cn':'CN aangevraagd','retour-vervanging':'Retour aangevraagd','wacht-wisselstuk':'Wacht wisselstuk'};
        parts.push(item.roodTag?tagL[item.roodTag]:'‚ö† Beschadigd');
      } else if(s==='roze'){
        parts.push(item.consumedBy||'(geen technieker)');
      }
      const joined=parts.filter(p=>p).join(' ‚Äî ');
      return joined||'Nieuw item';
    })();
    return `<div class="item ${item.open?'open':''}" id="item-${item.id}">
      <div class="item-head" onclick="toggleItem(${item.id})">
        <div class="item-num" style="${itemIsEmpty(item)?'':getMissing(item).length===0?'background:rgba(56,217,169,.15);border-color:rgba(56,217,169,.4);color:var(--success)':'background:rgba(255,92,92,.12);border-color:rgba(255,92,92,.35);color:var(--danger)'}">${idx+1}</div>
        <div class="cat-dot" style="background:${catInfo.color}"></div>
        <div style="flex:1;min-width:0">
          <div class="item-label">${itemTitle}</div>
          <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:3px">
            ${item.projectNumber?`<div class="project-badge">${item.projectNumber}</div>`:''}
            ${supHtml}
            <div class="item-ts">${item.createdBy||''} ¬∑ ${item.timestamp}</div>
            ${item.emailSent?'<span class="status-badge">VERSTUURD</span>':''}
            ${item.status==='verbruikt'?'<span class="status-badge" style="background:rgba(244,114,182,.15);color:#f472b6;border-color:rgba(244,114,182,.3)">VERBRUIKT</span>':''}
            ${item.roodTag&&!item.roodCompleted?`<span class="status-badge" style="background:rgba(255,92,92,.12);color:var(--cat-rood);border-color:rgba(255,92,92,.3)">${{'retour-cn':'üìã CN aangevraagd','retour-vervanging':'üîÑ Retour aangevraagd','wacht-wisselstuk':'‚è≥ Wacht wisselstuk'}[item.roodTag]||item.roodTag}</span>`:''}
          </div>
        </div>
        ${ACTION_CFG[item.section]?`<button onclick="event.stopPropagation();itemAction(${item.id})" style="padding:4px 10px;font-size:10px;font-weight:700;border-radius:6px;border:1px solid var(--accent);background:rgba(79,142,247,.1);color:var(--accent);cursor:pointer;white-space:nowrap;transition:all .15s;flex-shrink:0" onmouseover="this.style.background='rgba(79,142,247,.25)'" onmouseout="this.style.background='rgba(79,142,247,.1)'">‚ö° Actie</button>`:''}
        <div class="item-arrow">‚ñº</div>
      </div>
      ${(()=>{
        if(item.section==='paars')return '';
        // Show only current assignment: interventie OR project (prefer most recent)
        let badge='';
        if(item.consumedBy){
          badge='<span style="font-size:11px;padding:2px 8px;border-radius:10px;background:#f472b620;border:1px solid #f472b630;color:#f472b6;font-weight:600">üöö Technieker: <span style="font-family:\'DM Mono\',monospace">'+item.consumedBy+'</span></span>';
        } else if(item.reference){
          badge='<span style="font-size:11px;padding:2px 8px;border-radius:10px;background:#f9731620;border:1px solid #f9731630;color:#f97316;font-weight:600">üîß Interventie: <span style="font-family:\'DM Mono\',monospace">'+item.reference+'</span></span>';
        } else if(item.projectNumber){
          badge='<span style="font-size:11px;padding:2px 8px;border-radius:10px;background:#a78bfa20;border:1px solid #a78bfa30;color:#a78bfa;font-weight:600">üìÅ Project: <span style="font-family:\'DM Mono\',monospace">'+item.projectNumber+'</span></span>';
        }
        if(!badge)return '';
        return '<div style="padding:4px 16px 4px 54px;background:rgba(255,255,255,.02);border-top:1px solid rgba(255,255,255,.04)">'+badge+'</div>';
      })()}
      ${(!itemIsEmpty(item)&&getMissing(item).length)?`<div style="padding:4px 16px 4px 54px;font-size:11px;color:var(--danger);background:rgba(255,92,92,.05);border-top:1px solid rgba(255,92,92,.1)">‚ö† ${getMissing(item).join(' ¬∑ ')}</div>`:''} 
      <div class="item-body">
        <label class="fl" style="margin-top:0">Foto's:</label>
        <div class="thumbrow">
          ${[...(item.photos||[]).map((p,pi)=>({p,pi,field:'photos',tag:'üì¶ Algemeen',tagColor:'var(--accent)'})),
             ...(item.artikelPhotos||[]).map((p,pi)=>({p,pi,field:'artikelPhotos',tag:'üîç Artikel',tagColor:'var(--success)'})),
             ...(item.seriePhotos||[]).map((p,pi)=>({p,pi,field:'seriePhotos',tag:'üî¢ Serie',tagColor:'#38b6ff'})),
             ...(item.stickerPhotos||[]).map((p,pi)=>({p,pi,field:'stickerPhotos',tag:'üè∑Ô∏è Project',tagColor:'var(--cat-paars)'})),
             ...(item.schadePhotos||[]).map((p,pi)=>({p,pi,field:'schadePhotos',tag:'‚ö†Ô∏è Schade',tagColor:'var(--danger)'})),
             ...(item.bonPhotos||[]).map((p,pi)=>({p,pi,field:'bonPhotos',tag:'üìã Bon',tagColor:'var(--warn)'}))
          ].map(x=>`<div class="twrap" onclick="openEditor(${item.id},${x.pi},'${x.field}')">
            <img src="${x.p.data}"/>
            <button class="tdel" onclick="event.stopPropagation();removePhoto(${item.id},${x.pi},'${x.field}')">√ó</button>
            <div onclick="event.stopPropagation();retagPhoto(${item.id},${x.pi},'${x.field}')" style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.75);color:${x.tagColor};font-size:10px;font-weight:700;text-align:center;padding:2px 0;cursor:pointer" title="Klik om tag te wijzigen">${x.tag}</div>
            ${x.p.qualityOk===false?'<div style="position:absolute;top:0;left:0;right:0;background:rgba(255,92,92,.85);color:#fff;font-size:8px;font-weight:700;text-align:center;padding:1px 0">‚ö†Ô∏è ONSCHERP</div>':''}
          </div>`).join('')}
        </div>
        <div class="photoarea">
          <input type="file" accept="image/*" capture="environment" multiple onchange="smartAddPhoto(${item.id},this.files)"/>
          <div style="font-size:24px;margin-bottom:4px">üì∑</div>
          <div style="font-size:12px;color:var(--text2)">Foto toevoegen</div>
          <div style="font-size:10px;color:var(--text3);margin-top:4px">Auto-herkenning: algemeen, artikelnr, serienr, schade, project, bon</div>
        </div>
        <div id="classify-status-${item.id}" style="display:none;font-size:11px;padding:8px;border-radius:var(--radius-sm);margin-bottom:10px"></div>

        <label class="fl">Leverancier:</label>
        <div class="supplier-grid">
          ${(()=>{
            const sups=activeSuppliers();
            const counts={};sups.forEach(s=>counts[s.id]=items.filter(i=>!i.deleted&&i.supplierId===s.id).length);
            const top5=sups.filter(s=>counts[s.id]>0).sort((a,b)=>counts[b.id]-counts[a.id]).slice(0,5);
            const rest=sups.filter(s=>!top5.includes(s)).sort((a,b)=>a.name.localeCompare(b.name));
            const sorted=[...top5,...rest];
            return sorted.map(s=>{const cnt=counts[s.id]||0;const isTop=top5.includes(s);return `<div class="sup-btn ${item.supplierId===s.id?'active':''}" onclick="pickSup(${item.id},'${s.id}')" style="position:relative${isTop&&cnt>0?';border-color:rgba(56,217,169,.3)':''}">
            ${cnt>0?`<div style="position:absolute;top:3px;left:3px;min-width:18px;height:18px;border-radius:9px;background:var(--accent);color:#fff;font-size:10px;font-weight:700;font-family:'DM Mono',monospace;display:flex;align-items:center;justify-content:center;padding:0 4px;z-index:2">${cnt}</div>`:''}
            <img src="${s.logo||initials(s.name)}" onerror="this.src='${initials(s.name)}'"/>
            <div class="sup-name">${s.name}</div>
          </div>`;}).join('')})()}
          <div class="sup-btn sup-add" onclick="openAddSupplier()"><div style="font-size:20px;color:var(--text3);height:36px;display:flex;align-items:center;justify-content:center">+</div><div class="sup-name">Toevoegen</div></div>
        </div>

        <label class="fl">Omschrijving:${item.section==='rood'?' <span style="font-weight:400;color:var(--danger)">* verplicht ‚Äî beschrijf de schade</span>':''}</label>
        <textarea class="note" placeholder="${item.section==='rood'?'Beschrijf de waargenomen beschadiging: wat is er stuk/beschadigd, waar zit de schade, hoe erg is het, eventuele oorzaak...':'Beschrijf het product/probleem...'}" oninput="updateField(${item.id},'description',this.value)" style="${item.section==='rood'&&!item.description?'border-color:rgba(255,92,92,.4)':''}">${item.description||''}</textarea>

        ${item.section!=='paars'?`
        <label class="fl">Projectnummer: <span style="font-weight:400;color:${(reqs.need||[]).includes('projectNumber')?'var(--danger)':'var(--text3)'}"> ${(reqs.need||[]).includes('projectNumber')?'* verplicht':'(optioneel)'}</span></label>
        <div style="display:flex;gap:8px;align-items:center">
          <input class="input-field" type="text" inputmode="numeric" pattern="[0-9]*" style="flex:1;font-family:'DM Mono',monospace;font-size:13px;border-color:${item.projectNumber?'var(--border)':(reqs.need||[]).includes('projectNumber')?'rgba(255,92,92,.4)':'var(--border)'}" placeholder="Projectnummer invoeren..." value="${item.projectNumber||''}" oninput="this.value=this.value.replace(/[^0-9]/g,'');updateField(${item.id},'projectNumber',this.value)"/>
          <div style="position:relative;flex-shrink:0"><input type="file" accept="image/*" capture="environment" onchange="ocrProjectFromPhoto(${item.id},this.files)" style="position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%"/>
            <button class="btn btn-s" style="padding:8px 12px;pointer-events:none">üè∑Ô∏è Scan</button></div>
        </div>`:''}

        ${item.section!=='blauw'&&item.section!=='paars'?`<div id="ref-wrap-${item.id}" style="opacity:${item.refSkipped?'0.25':'1'};transition:opacity .3s;${item.refSkipped?'pointer-events:none':''}">
          <div style="display:flex;align-items:center;gap:8px;margin-top:14px;margin-bottom:6px">
            <label class="fl" style="margin:0;flex:1">Referentie / ordernummer:</label>
            <div class="item-del" onclick="toggleSkip(${item.id},'refSkipped','ref-wrap-${item.id}')" title="${item.refSkipped?'Herstellen':'Overslaan'}" style="pointer-events:auto">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </div>
          </div>
          <input class="input-field" placeholder="Ordernr / referentie..." value="${item.reference||''}" oninput="updateField(${item.id},'reference',this.value)"/>
        </div>`:''}

        ${((reqs.need||[]).includes('serial')||item.serial)?`
        <div id="serial-wrap-${item.id}" style="opacity:${item.serialSkipped?'0.25':'1'};transition:opacity .3s;${item.serialSkipped?'pointer-events:none':''}">
          <div style="display:flex;align-items:center;gap:8px;margin-top:14px;margin-bottom:6px">
            <label class="fl" style="margin:0;flex:1">${item.section==='paars'?'Artikelnummer':'Serienummer'}: <span style="font-weight:400;color:${(reqs.need||[]).includes('serial')?'var(--danger)':'var(--text3)'}"> ${(reqs.need||[]).includes('serial')?'* verplicht (via OCR)':'(optioneel)'}</span></label>
            <div class="item-del" onclick="toggleSkip(${item.id},'serialSkipped','serial-wrap-${item.id}')" title="${item.serialSkipped?'Herstellen':'Overslaan'}" style="pointer-events:auto">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:stretch;margin-bottom:8px">
            <input class="input-field" id="serial-${item.id}" placeholder="${item.section==='paars'?'Artikelnummer...':'Serienummer...'}" value="${item.serial||''}" oninput="updateField(${item.id},'serial',this.value)" style="flex:1"/>
            <div style="position:relative;flex-shrink:0">
              <input type="file" accept="image/*" capture="environment" onchange="ocrSerial(${item.id},this.files)" style="position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%"/>
              <button class="btn btn-s" style="height:100%;padding:8px 12px;pointer-events:none">üì∑ OCR</button>
            </div>
          </div>
          <div id="ocr-status-${item.id}" style="font-size:11px;color:var(--text3);margin-bottom:8px;display:none"></div>
        </div>`:''}

        ${(item.categoryHistory&&item.categoryHistory.length)||(item.actions&&item.actions.length)?`
        <div style="margin-top:8px">
          <div onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none';this.querySelector('span').textContent=this.nextElementSibling.style.display==='none'?'‚ñ∂':'‚ñº'" style="font-size:11px;color:var(--text3);cursor:pointer;padding:4px 0;user-select:none">
            <span>‚ñ∂</span> üìã Toon historiek (${(item.categoryHistory||[]).length+(item.actions||[]).length})
          </div>
          <div style="display:none">
            ${item.categoryHistory&&item.categoryHistory.length?`
            <div style="font-size:11px;color:var(--text3);margin-top:4px;padding:8px;background:var(--surface2);border-radius:var(--radius-sm)">
              üîÑ Categorie-geschiedenis:<br>
              ${item.categoryHistory.map(ch=>`<span style="margin-left:8px">‚Ä¢ ${SEC[ch.from]?.label||ch.from} ‚Üí ${SEC[ch.to]?.label||ch.to} ‚Äî ${ch.at} (${ch.by})</span>`).join('<br>')}
            </div>`:''}
            ${item.actions&&item.actions.length?`
            <div style="font-size:11px;margin-top:4px;padding:8px;background:rgba(79,142,247,.06);border:1px solid rgba(79,142,247,.15);border-radius:var(--radius-sm)">
              ‚ö° Acties:<br>
              ${item.actions.map(a=>{
                const icons={'to-interventie':'üîß','to-project':'üìÅ','to-stock':'üì¶','to-other-project':'üìÅ','to-other-interventie':'üîß','meegeleverd':'üöö','interventie':'üîß','project':'üìÅ'};
                const labels={'to-interventie':'‚Üí Interventie','to-project':'‚Üí Project','to-stock':'‚Üí Stock','to-other-project':'‚Üí Ander project','to-other-interventie':'‚Üí Andere interventie','meegeleverd':'Meegeleverd','interventie':'‚Üí Interventie','project':'‚Üí Project'};
                return `<div style="margin:4px 0 0 8px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.04)">
                <span style="font-weight:700">${icons[a.type]||'‚ö°'} ${labels[a.type]||a.type}</span>
                ${a.ref?'<span style="color:var(--text);font-weight:600;font-family:\'DM Mono\',monospace"> '+a.ref+'</span>':''}
                ${a.tech?'<span style="color:var(--text)"> technieker: <strong>'+a.tech+'</strong></span>':''}
                ${a.note?'<span style="color:var(--text2)"> ‚Äî '+a.note+'</span>':''}
                <br><span style="color:var(--text3);font-size:10px">üë§ ${a.by} ¬∑ ${a.at}${a.fromRef?' ¬∑ van: '+a.fromRef:''}</span>
              </div>`;}).join('')}
            </div>`:''}
          </div>
        </div>`:''}

        <div style="font-size:11px;color:var(--text3);margin-top:8px;padding:8px;background:var(--surface2);border-radius:var(--radius-sm)">
          üìã ${item.timestamp} ‚Äî <strong>${item.createdBy||'?'}</strong>
          ${item.lastModified?` ¬∑ Laatst gewijzigd: ${item.lastModified} ‚Äî ${item.modifiedBy||''}`:''}
        </div>
        <div class="btn-row">
          ${item.section!=='roze'&&item.section!=='paars'?(getMissing(item).length===0?
            `<button class="btn btn-mail" onclick="prepEmail(${item.id})">üìß Mail leverancier</button>`:
            `<button class="btn btn-s" style="opacity:.4;cursor:not-allowed;flex:1" disabled>üìß Mail pas beschikbaar na volledig invullen</button>`):''}
          <button class="btn btn-s" onclick="deleteItem(${item.id})" style="color:var(--danger);border-color:rgba(255,92,92,.3)">üóë Verwijderen</button>
        </div>
      </div>
    </div>`;
   }catch(err){console.error('Render item error:',err,item);return `<div class="item"><div class="item-head" style="color:var(--danger)">‚ö† Render fout item #${item.id}</div></div>`;}
  }).join('');
}

function addItem(){
  try{
  filterMode='all';
  const item={id:nextId++,uuid:genUUID(),section:activeSection,description:'',supplierId:'',photos:[],artikelPhotos:[],seriePhotos:[],stickerPhotos:[],schadePhotos:[],bonPhotos:[],
    reference:'',serial:'',projectNumber:'',emailSent:false,open:true,deleted:false,timestamp:ts(),createdBy:magazijnier};
  items.push(item);items.filter(i=>i.section===activeSection&&i.id!==item.id).forEach(i=>i.open=false);
  renderItems();saveData();
  setTimeout(()=>{const el=document.getElementById('item-'+item.id);if(el)el.scrollIntoView({behavior:'smooth',block:'center'});},100);
  }catch(e){console.error('addItem error:',e);alert('Fout bij toevoegen: '+e.message);}
}
let actionItemId=null;
let actionType=null;

// Action button configs per section
const ACTION_CFG={
  'paars':[
    {type:'to-interventie',label:'üîß Toekennen aan interventie',bg:'linear-gradient(135deg,#f97316,#e8660a)',refLabel:'Interventienummer:',refPh:'Vul interventienummer in...'},
    {type:'to-project',label:'üìÅ Toekennen aan project',bg:'linear-gradient(135deg,#a78bfa,#8b5cf6)',refLabel:'Projectnummer:',refPh:'Vul projectnummer in...'},
  ],
  'oranje':[
    {type:'to-stock',label:'üì¶ Naar spare part stock',bg:'linear-gradient(135deg,#a78bfa,#8b5cf6)',refLabel:null},
    {type:'to-other-project',label:'üìÅ Toekennen aan ander project',bg:'linear-gradient(135deg,#f7c948,#e8b710)',refLabel:'Nieuw projectnummer:',refPh:'Vul projectnummer in...'},
    {type:'to-other-interventie',label:'üîß Toekennen aan andere interventie',bg:'linear-gradient(135deg,#f97316,#e8660a)',refLabel:'Nieuw interventienummer:',refPh:'Vul interventienummer in...'},
    {type:'meegeleverd',label:'üöö Meegeleverd met technieker',bg:'linear-gradient(135deg,#38d9a9,#20c997)',refLabel:null,techField:true},
  ],
  'geel':[
    {type:'geleverd',label:'‚úÖ Ontbrekende materialen werden geleverd',bg:'linear-gradient(135deg,#38d9a9,#20c997)',refLabel:null},
  ],
  'rood':[
    {type:'retour-cn',label:'üìã Creditnota aangevraagd',bg:''},
    {type:'retour-vervanging',label:'üîÑ Retour van toestel aangevraagd',bg:''},
    {type:'wacht-wisselstuk',label:'‚è≥ Wacht op wisselstuk',bg:''},
  ],
  'blauw':[
    {type:'vrije-voorraad',label:'üì¶ Naar vrije voorraad',bg:''},
    {type:'retour-leverancier',label:'üîÑ Retour naar leverancier',bg:''},
  ],
};

function itemAction(id){
  const it=items.find(i=>i.id==id);if(!it)return;
  actionItemId=id;
  let cfg=ACTION_CFG[it.section];
  if(!cfg){showToast('Actie nog niet beschikbaar voor deze categorie');return;}

  // Rood: dynamic actions based on current tag
  if(it.section==='rood'&&it.roodTag){
    if(it.roodTag==='retour-cn'){
      cfg=[{type:'cn-ontvangen',label:'‚úÖ Creditnota ontvangen',bg:''},
           {type:'change-rood-tag',label:'üîÑ Tag wijzigen',bg:''}];
    } else if(it.roodTag==='retour-vervanging'){
      cfg=[{type:'vervanging-ontvangen',label:'‚úÖ Vervangproduct ontvangen',bg:''},
           {type:'change-rood-tag',label:'üîÑ Tag wijzigen',bg:''}];
    } else if(it.roodTag==='wacht-wisselstuk'){
      cfg=[{type:'wisselstuk-ontvangen',label:'‚úÖ Wisselstuk ontvangen',bg:''},
           {type:'change-rood-tag',label:'üîÑ Tag wijzigen',bg:''}];
    }
  }

  document.getElementById('action-modal-title').innerHTML=
    `<span style="color:${SEC[it.section]?.color||'var(--text)'}">‚ö° Actie ‚Äî ${SEC[it.section]?.label||''}</span>`;
  document.getElementById('action-item-info').innerHTML=
    `<strong>${it.description||'Item #'+id}</strong>${it.projectNumber?' ¬∑ Project: '+it.projectNumber:''}${it.serial?' ¬∑ Serie: '+it.serial:''}`;
  // Build action buttons
  const btnWrap=document.getElementById('action-buttons');
  btnWrap.innerHTML=cfg.map(a=>`<button onclick="pickActionType('${a.type}')" style="width:100%;padding:12px 14px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--surface2);color:var(--text2);font-size:13px;font-weight:600;text-align:left;cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)';this.style.background='rgba(79,142,247,.08)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text2)';this.style.background='var(--surface2)'">${a.label}</button>`).join('');
  resetActionStep();
  document.getElementById('modal-action').classList.add('show');
}

function resetActionStep(){
  actionType=null;
  document.getElementById('action-step1').style.display='block';
  document.getElementById('action-step2').style.display='none';
  document.getElementById('action-cancel1').style.display='flex';
}

function pickActionType(type){
  try{
  actionType=type;
  const it=items.find(i=>i.id==actionItemId);if(!it)return;
  // Find action config ‚Äî check static config first, then dynamic rood actions
  let ac=null;
  const cfg=ACTION_CFG[it.section];
  if(cfg)ac=cfg.find(a=>a.type===type);
  // Dynamic rood completion actions
  if(!ac){
    const dynamicActions={
      'cn-ontvangen':{label:'‚úÖ Creditnota ontvangen',bg:''},
      'vervanging-ontvangen':{label:'‚úÖ Vervangproduct ontvangen',bg:''},
      'wisselstuk-ontvangen':{label:'‚úÖ Wisselstuk ontvangen',bg:''},
      'change-rood-tag':{label:'üîÑ Tag wijzigen',bg:''},
    };
    ac=dynamicActions[type];
  }
  if(!ac)return;

  document.getElementById('action-step1').style.display='none';
  document.getElementById('action-cancel1').style.display='none';
  document.getElementById('action-step2').style.display='block';

  const badge=document.getElementById('action-type-badge');
  badge.textContent=ac.label;
  badge.style.background='var(--surface2)';
  badge.style.border='1px solid var(--border)';
  badge.style.color='var(--text)';

  // Show/hide ref field
  const refWrap=document.getElementById('action-ref-wrap');
  const techWrap=document.getElementById('action-tech-wrap');
  if(ac.refLabel){
    refWrap.style.display='block';
    document.getElementById('action-ref-label').textContent=ac.refLabel;
    document.getElementById('action-ref').placeholder=ac.refPh||'';
    document.getElementById('action-ref').value='';
  } else {
    refWrap.style.display='none';
  }
  // Show/hide tech field
  if(ac.techField){
    techWrap.style.display='block';
    document.getElementById('action-tech').value='';
  } else {
    techWrap.style.display='none';
  }
  document.getElementById('action-note').value='';
  setTimeout(()=>{
    if(ac.refLabel)document.getElementById('action-ref').focus();
    else if(ac.techField)document.getElementById('action-tech').focus();
    else document.getElementById('action-note').focus();
  },100);
  }catch(e){console.error('pickActionType error:',e);alert('Fout: '+e.message);}
}

function genUUID(){return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:r&0x3|0x8).toString(16);});}

function confirmAction(){
  const it=items.find(i=>i.id==actionItemId);if(!it||!actionType)return;
  // Guard: prevent duplicate meegeleverd
  if(actionType==='meegeleverd'&&it.status==='verbruikt'){
    closeModal('modal-action');showToast('Item is al verbruikt','error');return;
  }
  // Prevent double-click
  if(it._actionLock)return;it._actionLock=true;
  const cfg=ACTION_CFG[it.section];
  const ac=cfg?cfg.find(a=>a.type===actionType):null;
  const ref=document.getElementById('action-ref').value.trim();
  const tech=document.getElementById('action-tech').value.trim();
  const note=document.getElementById('action-note').value.trim();

  // Validate required fields
  if(ac&&ac.refLabel&&!ref){
    document.getElementById('action-ref').style.borderColor='var(--danger)';
    document.getElementById('action-ref').focus();showToast('Vul een referentie in','error');delete it._actionLock;return;
  }
  if(ac&&ac.techField&&!tech){
    document.getElementById('action-tech').style.borderColor='var(--danger)';
    document.getElementById('action-tech').focus();showToast('Vul technieker naam in','error');delete it._actionLock;return;
  }

  // Destructive actions: show confirmation first
  const destructive={
    'meegeleverd':`<strong>${it.description||'Item'}</strong> wordt verplaatst naar <strong>Verbruikte spare parts</strong>.<br>Technieker: <strong>${tech}</strong><br><span style="color:var(--danger)">Dit kan niet ongedaan worden.</span>`,
    'geleverd':`<strong>${it.description||'Item'}</strong> wordt <strong>gearchiveerd</strong> als afgehandeld.<br><span style="color:var(--danger)">Item verdwijnt uit de lijst.</span>`,
    'cn-ontvangen':`<strong>${it.description||'Item'}</strong> wordt <strong>afgesloten</strong> ‚Äî creditnota ontvangen.<br><span style="color:var(--danger)">Item verdwijnt uit de lijst.</span>`,
    'vervanging-ontvangen':`<strong>${it.description||'Item'}</strong> wordt <strong>afgesloten</strong> ‚Äî vervangproduct ontvangen.<br><span style="color:var(--danger)">Item verdwijnt uit de lijst.</span>`,
    'wisselstuk-ontvangen':`<strong>${it.description||'Item'}</strong> wordt <strong>afgesloten</strong> ‚Äî wisselstuk ontvangen.<br><span style="color:var(--danger)">Item verdwijnt uit de lijst.</span>`,
    'vrije-voorraad':`<strong>${it.description||'Item'}</strong> wordt <strong>gearchiveerd</strong> als vrije voorraad.<br><span style="color:var(--danger)">Item verdwijnt uit de lijst.</span>`
  };

  if(destructive[actionType]&&!it._confirmShown){
    delete it._actionLock;
    // Replace step2 content with confirmation
    document.getElementById('action-step2').innerHTML=`
      <div style="padding:16px;background:rgba(255,92,92,.06);border:1px solid rgba(255,92,92,.2);border-radius:var(--radius-sm);margin-bottom:14px">
        <div style="font-size:13px;line-height:1.6;color:var(--text)">${destructive[actionType]}</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-p" onclick="items.find(i=>i.id==${it.id})._confirmShown=true;confirmAction()" style="flex:1;padding:12px;background:linear-gradient(135deg,var(--danger),#cc3333)">‚ö† Ja, bevestigen</button>
        <button class="btn btn-s" onclick="closeModal('modal-action');delete items.find(i=>i.id==${it.id})._confirmShown" style="padding:12px">Annuleer</button>
      </div>`;
    return;
  }
  delete it._confirmShown;

  // Build action entry (full history)
  const actionEntry={
    type:actionType,
    ref:ref||null,
    tech:tech||null,
    note:note||null,
    by:magazijnier,
    at:ts(),
    fromSection:it.section,
    fromRef:it.projectNumber||it.reference||null
  };
  if(!it.actions)it.actions=[];
  it.actions.push(actionEntry);
  it.lastModified=ts();
  it.modifiedBy=magazijnier;

  let toastMsg='';

  // Execute action logic
  if(actionType==='to-interventie'){
    // Paars ‚Üí Oranje: move to interventie
    const oldSec=it.section;
    it.section='oranje';
    it.reference=ref;
    if(!it.categoryHistory)it.categoryHistory=[];
    it.categoryHistory.push({from:oldSec,to:'oranje',at:ts(),by:magazijnier,reason:'Toegekend aan interventie: '+ref});
    addAudit(it,'actie','‚Üí Interventie: '+ref+' door '+magazijnier);
    toastMsg='Verplaatst naar Interventie: '+ref;

  } else if(actionType==='to-project'){
    // Paars ‚Üí Oranje: assign to project
    const oldSec=it.section;
    it.section='oranje';
    it.projectNumber=ref;
    if(!it.categoryHistory)it.categoryHistory=[];
    it.categoryHistory.push({from:oldSec,to:'oranje',at:ts(),by:magazijnier,reason:'Toegekend aan project: '+ref});
    addAudit(it,'actie','‚Üí Project: '+ref+' door '+magazijnier);
    toastMsg='Verplaatst naar Interventie ‚Äî Project: '+ref;

  } else if(actionType==='to-stock'){
    // Oranje ‚Üí Paars: return to stock
    const oldSec=it.section;
    it.section='paars';
    it.projectNumber='';
    it.reference='';
    if(!it.categoryHistory)it.categoryHistory=[];
    it.categoryHistory.push({from:oldSec,to:'paars',at:ts(),by:magazijnier,reason:'Terug naar stock'});
    addAudit(it,'actie','‚Üí Spare part stock door '+magazijnier+' (project/interventie gewist)');
    toastMsg='Terug naar Spare part stock';

  } else if(actionType==='to-other-project'){
    // Oranje: change project number
    const oldRef=it.projectNumber;
    it.projectNumber=ref;
    addAudit(it,'actie','Project gewijzigd: '+(oldRef||'‚Äî')+' ‚Üí '+ref+' door '+magazijnier);
    toastMsg='Project gewijzigd naar: '+ref;

  } else if(actionType==='to-other-interventie'){
    // Oranje: change interventie number
    const oldRef=it.reference;
    it.reference=ref;
    addAudit(it,'actie','Interventie gewijzigd: '+(oldRef||'‚Äî')+' ‚Üí '+ref+' door '+magazijnier);
    toastMsg='Interventie gewijzigd naar: '+ref;

  } else if(actionType==='meegeleverd'){
    // Oranje ‚Üí Roze: move item to verbruikte spare parts
    const oldSec=it.section;
    it.status='verbruikt';
    it.consumedBy=tech;
    it.consumedAt=ts();
    it.section='roze';
    it.sourceItemId=it.id;
    it.sourceSection=oldSec;
    if(!it.categoryHistory)it.categoryHistory=[];
    it.categoryHistory.push({from:oldSec,to:'roze',at:ts(),by:magazijnier,reason:'Meegeleverd met technieker: '+tech});
    addAudit(it,'actie','Meegeleverd met technieker: '+tech+' door '+magazijnier+(note?' ‚Äî '+note:''));
    toastMsg='Meegeleverd met '+tech+' ‚Üí Verbruikte spare parts';

  } else if(actionType==='geleverd'){
    // Geel: ontbrekende materialen geleverd ‚Äî archive item
    it.status='afgehandeld';
    it.deleted=true;
    it.deletedAt=ts();
    it.deletedBy=magazijnier;
    if(!it.categoryHistory)it.categoryHistory=[];
    it.categoryHistory.push({from:'geel',to:'afgehandeld',at:ts(),by:magazijnier,reason:'Ontbrekende materialen geleverd'});
    addAudit(it,'actie','Ontbrekende materialen geleverd ‚Äî afgesloten door '+magazijnier+(note?' ‚Äî '+note:''));
    toastMsg='Item afgesloten ‚Äî materialen geleverd';

  } else if(actionType==='retour-cn'||actionType==='retour-vervanging'||actionType==='wacht-wisselstuk'){
    // Rood: assign tag
    const tagLabels={'retour-cn':'Creditnota aangevraagd','retour-vervanging':'Retour van toestel aangevraagd','wacht-wisselstuk':'Wacht op wisselstuk'};
    it.roodTag=actionType;
    addAudit(it,'actie','Tag: '+tagLabels[actionType]+' door '+magazijnier+(note?' ‚Äî '+note:''));
    toastMsg='Tag toegekend: '+tagLabels[actionType];

  } else if(actionType==='cn-ontvangen'||actionType==='vervanging-ontvangen'||actionType==='wisselstuk-ontvangen'){
    // Rood: completion ‚Äî archive item
    const completionLabels={'cn-ontvangen':'Creditnota ontvangen','vervanging-ontvangen':'Vervangproduct ontvangen','wisselstuk-ontvangen':'Wisselstuk ontvangen'};
    it.roodCompleted=actionType;
    it.status='afgehandeld';
    it.deleted=true;
    it.deletedAt=ts();
    it.deletedBy=magazijnier;
    if(!it.categoryHistory)it.categoryHistory=[];
    it.categoryHistory.push({from:'rood',to:'afgehandeld',at:ts(),by:magazijnier,reason:completionLabels[actionType]});
    addAudit(it,'actie',completionLabels[actionType]+' ‚Äî afgesloten door '+magazijnier+(note?' ‚Äî '+note:''));
    toastMsg='Item afgesloten ‚Äî '+completionLabels[actionType];

  } else if(actionType==='change-rood-tag'){
    // Rood: reset tag so user can pick a new one
    const oldTag=it.roodTag;
    it.roodTag=null;
    addAudit(it,'actie','Tag gewijzigd (was: '+oldTag+') door '+magazijnier);
    delete it._actionLock;
    closeModal('modal-action');
    saveData();renderItems();updateHub();
    showToast('Tag verwijderd ‚Äî kies een nieuwe actie');
    // Reopen action modal with original options
    setTimeout(()=>itemAction(it.id),300);
    return;

  } else if(actionType==='vrije-voorraad'){
    // Blauw: naar vrije voorraad ‚Äî tag + archive
    it.status='vrije-voorraad';
    it.deleted=true;
    it.deletedAt=ts();
    it.deletedBy=magazijnier;
    if(!it.categoryHistory)it.categoryHistory=[];
    it.categoryHistory.push({from:'blauw',to:'vrije-voorraad',at:ts(),by:magazijnier,reason:'Naar vrije voorraad'});
    addAudit(it,'actie','Naar vrije voorraad ‚Äî afgesloten door '+magazijnier+(note?' ‚Äî '+note:''));
    toastMsg='Item afgesloten ‚Äî naar vrije voorraad';

  } else if(actionType==='retour-leverancier'){
    // Blauw ‚Üí Rood: move to beschadigd/retour
    const oldSec=it.section;
    it.section='rood';
    if(!it.categoryHistory)it.categoryHistory=[];
    it.categoryHistory.push({from:oldSec,to:'rood',at:ts(),by:magazijnier,reason:'Retour naar leverancier'});
    addAudit(it,'actie','‚Üí Retour naar leverancier door '+magazijnier+(note?' ‚Äî '+note:''));
    toastMsg='Verplaatst naar Beschadigd / Retour lev.';
  }

  closeModal('modal-action');
  delete it._actionLock;
  saveData();updateHub();
  backToHub();
  showToast(toastMsg);
}
function toggleItem(id){const it=items.find(i=>i.id==id);if(!it)return;const w=it.open;
  items.filter(i=>i.section===activeSection).forEach(i=>i.open=false);if(!w)it.open=true;renderItems();}
function updateField(id,f,v){const it=items.find(i=>i.id==id);if(it){it[f]=v;it.lastModified=ts();it.modifiedBy=magazijnier;}
  const titleFields=['description','serial','projectNumber','reference','supplierId'];
  if(titleFields.includes(f)){const el=document.querySelector(`#item-${id} .item-label`);if(el&&it){
    const sup=findSupplier(it.supplierId);const sn=sup?sup.name:'';const s=it.section;const parts=[];
    if(sn)parts.push(sn);
    if(s==='paars'||s==='oranje')parts.push(it.serial||(sn?'(geen nr)':''));
    else if(s==='geel'||s==='blauw')parts.push(it.projectNumber||(sn?'(geen project)':''));
    else if(s==='rood'){const tl={'retour-cn':'CN aangevraagd','retour-vervanging':'Retour aangevraagd','wacht-wisselstuk':'Wacht wisselstuk'};parts.push(it.roodTag?tl[it.roodTag]:'‚ö† Beschadigd');}
    else if(s==='roze')parts.push(it.consumedBy||'(geen technieker)');
    el.textContent=parts.filter(p=>p).join(' ‚Äî ')||'Nieuw item';
  }}saveData();}
function itemIsEmpty(it){
  return !(it.description&&it.description.trim())&&
    !(it.projectNumber&&it.projectNumber.trim())&&
    !(it.reference&&it.reference.trim())&&
    !(it.serial&&it.serial.trim())&&
    !it.supplierId&&
    !(it.photos||[]).length&&!(it.artikelPhotos||[]).length&&
    !(it.seriePhotos||[]).length&&!(it.schadePhotos||[]).length&&
    !(it.stickerPhotos||[]).length&&!(it.bonPhotos||[]).length;
}
function deleteItem(id){
  const it=items.find(i=>i.id==id);if(!it)return;
  if(itemIsEmpty(it)){
    // Hard delete ‚Äî remove entirely, no archive
    items=items.filter(i=>i.id!==id);
    // Reclaim ID if it was the last one created
    if(id===nextId-1)nextId--;
    renderItems();saveData();updateHub();showToast('Leeg item verwijderd');return;
  }
  const hasPhotos=((it.photos||[]).length+(it.artikelPhotos||[]).length+(it.seriePhotos||[]).length+(it.schadePhotos||[]).length+(it.stickerPhotos||[]).length+(it.bonPhotos||[]).length)>0;
  if(hasPhotos){showDeleteModal(id);}
  else{it.deleted=true;it.deletedAt=ts();it.deletedBy=magazijnier;addAudit(it,'gearchiveerd','Geen foto\'s');renderItems();saveData();updateHub();showToast('Item gearchiveerd');}
}
function showDeleteModal(id){
  deleteTargetId=id;document.getElementById('delete-reason').value='';
  document.getElementById('modal-delete').classList.add('show');
  setTimeout(()=>document.getElementById('delete-reason').focus(),100);
}
function confirmDelete(){
  const reason=document.getElementById('delete-reason').value.trim();
  if(!reason){showToast('Vul een reden / vervolgactie in','error');return;}
  const it=items.find(i=>i.id==deleteTargetId);
  if(it){it.deleted=true;it.deletedAt=ts();it.deletedBy=magazijnier;it.deleteReason=reason;}
  closeModal('modal-delete');renderItems();saveData();updateHub();showToast('Item verwijderd');
}
let deleteTargetId=null;
function retagPhoto(id,idx,fromField){
  const it=items.find(i=>i.id==id);if(!it)return;
  const opts=['photos:üì¶ Algemeen','artikelPhotos:üîç Artikelnummer','seriePhotos:üî¢ Serienummer','stickerPhotos:üè∑Ô∏è Projectnummer','schadePhotos:‚ö†Ô∏è Schade','bonPhotos:üìã Leverbon'];
  const labels=opts.map(o=>{const[k,l]=o.split(':');return k===fromField?null:l;}).filter(Boolean);
  const keys=opts.map(o=>{const[k]=o.split(':');return k===fromField?null:k;}).filter(Boolean);
  const choice=prompt('Kies nieuwe tag:\\n'+keys.map((k,i)=>(i+1)+'. '+labels[i]).join('\\n')+'\\n\\nTyp nummer (1-'+keys.length+'):');
  if(!choice)return;
  const ci=parseInt(choice)-1;
  if(ci<0||ci>=keys.length)return;
  const toField=keys[ci];
  // Move photo from fromField to toField
  const photo=(it[fromField]||[]).splice(idx,1)[0];
  if(!photo)return;
  if(!it[toField])it[toField]=[];
  it[toField].push(photo);
  addAudit(it,'foto_hertagd',fromField+' ‚Üí '+toField);
  // Trigger OCR if moved to artikelPhotos or seriePhotos or stickerPhotos
  if(toField==='artikelPhotos'||toField==='seriePhotos'){
    ocrFromImage(photo.data).then(text=>{
      const pn=extractProjectNumber(text);
      if(pn){
        if(toField==='seriePhotos'&&!it.serial){it.serial=pn;addAudit(it,'serienummer','OCR serie: '+pn);showToast('Serie: '+pn);}
        else if(toField==='artikelPhotos'&&!it.serial){it.serial=pn;addAudit(it,'artikelnummer','OCR artikel: '+pn);showToast('Artikelnr: '+pn);}
      }
      renderItems();saveData();
    }).catch(()=>{});
  }
  if(toField==='stickerPhotos'){
    ocrFromImage(photo.data).then(text=>{
      const pn=extractProjectNumber(text);
      if(pn&&!it.projectNumber){it.projectNumber=pn;addAudit(it,'projectnummer','OCR sticker retag: '+pn);showToast('Project: '+pn);}
      renderItems();saveData();
    }).catch(()=>{});
  }
  renderItems();saveData();updateHub();
}
function pickSup(id,sid){const it=items.find(i=>i.id==id);if(!it)return;it.supplierId=it.supplierId===sid?'':sid;it.lastModified=ts();it.modifiedBy=magazijnier;renderItems();saveData();}

function toggleSkip(id,field,wrapId){
  const it=items.find(i=>i.id==id);if(!it)return;
  it[field]=!it[field];
  const wrap=document.getElementById(wrapId);
  if(wrap){wrap.style.opacity=it[field]?'0.25':'1';wrap.style.pointerEvents=it[field]?'none':'';
    wrap.querySelectorAll('.item-del').forEach(b=>b.style.pointerEvents='auto');}
  if(it[field]){if(field==='refSkipped')it.reference='';if(field==='serialSkipped')it.serial='';}
  it.lastModified=ts();it.modifiedBy=magazijnier;saveData();
}

// ‚ïê‚ïê PHOTOS + TIMESTAMP ‚ïê‚ïê
function addPhotos(id,files,field){
  const it=items.find(i=>i.id==id);if(!it)return;
  if(!it[field])it[field]=[];
  [...files].forEach(file=>{
    const reader=new FileReader();
    reader.onload=e=>{
      processPhoto(e.target.result).then(dataUrl=>{
        it[field].push({data:dataUrl,timestamp:ts()+' ‚Äî '+magazijnier});
        renderItems();saveData();
        // Upload foto's naar cloud op achtergrond
        syncPhotosToCloud();
      });
    };reader.readAsDataURL(file);
  });
}
function removePhoto(id,idx,field){const it=items.find(i=>i.id==id);if(!it||!it[field])return;it[field].splice(idx,1);renderItems();saveData();}

// ‚ïê‚ïê EDITOR ‚ïê‚ïê
const edCanvas=document.getElementById('ed-canvas'),edCtx=edCanvas.getContext('2d');
let baseImg,annotations=[],selectedIdx=-1,curTool='arrow',curColor='#a78bfa',curSize=4;
let drawing=false,startX,startY,penPath=[],transformMode=null,transformHandle=null,origAnnotation=null;
let edItemId,edPhotoIdx,edPhotoField;

const CAT_COLORS={paars:'#a78bfa',oranje:'#f97316',geel:'#f7c948',rood:'#ff5c5c',blauw:'#38b6ff',roze:'#f472b6'};

function openEditor(itemId,idx,field){
  edItemId=itemId;edPhotoIdx=idx;edPhotoField=field;selectedIdx=-1;
  const it=items.find(i=>i.id==itemId);if(!it||!it[field])return;
  const photo=it[field][idx];
  // Restore saved annotations if any
  annotations=photo.annotations?JSON.parse(JSON.stringify(photo.annotations)):[];
  // Set category color as default
  const catCol=CAT_COLORS[it.section]||'#a78bfa';
  curColor=catCol;
  const catSwatch=document.getElementById('csw-cat');
  if(catSwatch){catSwatch.style.background=catCol;}
  document.querySelectorAll('.cswatch').forEach(s=>s.classList.remove('active'));
  if(catSwatch)catSwatch.classList.add('active');
  setTool('arrow');
  const img=new Image();img.onload=()=>{
    const maxW=window.innerWidth-16,maxH=window.innerHeight-180;
    let w=img.width,h=img.height;
    if(w>maxW){h=Math.round(h*maxW/w);w=maxW;}if(h>maxH){w=Math.round(w*maxH/h);h=maxH;}
    edCanvas.width=w;edCanvas.height=h;baseImg=img;redraw();
    document.getElementById('editor-overlay').classList.add('open');
  };
  // Load original (unannotated) image if available, otherwise current
  img.src=photo.originalData||photo.data;
}
function updateSelectionUI(){
  const delBtn=document.getElementById('tool-del-sel');
  const fontCtrl=document.getElementById('ed-font-ctrl');
  if(selectedIdx>=0){
    if(delBtn)delBtn.style.display='flex';
    if(fontCtrl&&annotations[selectedIdx]&&annotations[selectedIdx].type==='textbox'){
      fontCtrl.style.display='flex';fontCtrl.style.alignItems='center';fontCtrl.style.gap='6px';
      document.getElementById('ed-font-size').textContent=annotations[selectedIdx].fontSize;
    } else if(fontCtrl){fontCtrl.style.display='none';}
  } else {
    if(delBtn)delBtn.style.display='none';
    if(fontCtrl)fontCtrl.style.display='none';
  }
}
function deleteSelected(){if(selectedIdx>=0){annotations.splice(selectedIdx,1);selectedIdx=-1;updateSelectionUI();redraw();}}
function changeFontSize(delta){
  if(selectedIdx<0)return;const a=annotations[selectedIdx];
  if(a&&a.type==='textbox'){a.fontSize=Math.max(10,Math.min(72,a.fontSize+delta));
    document.getElementById('ed-font-size').textContent=a.fontSize;redraw();}
}
function redraw(){if(!baseImg)return;edCtx.drawImage(baseImg,0,0,edCanvas.width,edCanvas.height);
  annotations.forEach((a,i)=>{paintAnnotation(a);if(i===selectedIdx&&curTool==='select')drawSelBox(a);});updateSelectionUI();}
function drawSelBox(a){const b=getBounds(a);if(!b)return;edCtx.save();edCtx.strokeStyle='#4f8ef7';edCtx.lineWidth=2;edCtx.setLineDash([5,5]);
  edCtx.strokeRect(b.x,b.y,b.w,b.h);[[b.x,b.y],[b.x+b.w,b.y],[b.x,b.y+b.h],[b.x+b.w,b.y+b.h]].forEach(([x,y])=>{edCtx.fillStyle='#4f8ef7';edCtx.fillRect(x-5,y-5,10,10);});edCtx.restore();}
function getBounds(a){
  if(a.type==='textbox')return{x:a.x,y:a.y,w:a.w,h:a.h};
  if(['rect','circle','arrow','line'].includes(a.type))return{x:Math.min(a.x1,a.x2),y:Math.min(a.y1,a.y2),w:Math.abs(a.x2-a.x1)||4,h:Math.abs(a.y2-a.y1)||4};
  if(a.type==='pen'&&a.path&&a.path.length){let mx=Infinity,my=Infinity,MX=-Infinity,MY=-Infinity;
    a.path.forEach(p=>{if(p.x<mx)mx=p.x;if(p.y<my)my=p.y;if(p.x>MX)MX=p.x;if(p.y>MY)MY=p.y;});return{x:mx-5,y:my-5,w:MX-mx+10,h:MY-my+10};}
  return null;}
function hitTest(p,a){const b=getBounds(a);if(!b)return false;return p.x>=b.x&&p.x<=b.x+b.w&&p.y>=b.y&&p.y<=b.y+b.h;}
function getHandle(p,a){const b=getBounds(a);if(!b)return null;
  for(const h of[{n:'tl',x:b.x,y:b.y},{n:'tr',x:b.x+b.w,y:b.y},{n:'bl',x:b.x,y:b.y+b.h},{n:'br',x:b.x+b.w,y:b.y+b.h}])
    if(Math.abs(p.x-h.x)<14&&Math.abs(p.y-h.y)<14)return h.n;return null;}

function paintAnnotation(a){
  edCtx.save();edCtx.strokeStyle=a.color;edCtx.fillStyle=a.color;edCtx.lineWidth=a.size;edCtx.lineCap='round';edCtx.lineJoin='round';
  if(a.type==='pen'&&a.path){edCtx.beginPath();a.path.forEach((p,i)=>i===0?edCtx.moveTo(p.x,p.y):edCtx.lineTo(p.x,p.y));edCtx.stroke();}
  else if(a.type==='line'){edCtx.lineWidth=4;edCtx.beginPath();edCtx.moveTo(a.x1,a.y1);edCtx.lineTo(a.x2,a.y2);edCtx.stroke();}
  else if(a.type==='rect'){edCtx.lineWidth=4;edCtx.strokeRect(a.x1,a.y1,a.x2-a.x1,a.y2-a.y1);}
  else if(a.type==='circle'){edCtx.lineWidth=4;const rx=Math.abs(a.x2-a.x1)/2,ry=Math.abs(a.y2-a.y1)/2;
    edCtx.beginPath();edCtx.ellipse((a.x1+a.x2)/2,(a.y1+a.y2)/2,Math.max(rx,1),Math.max(ry,1),0,0,Math.PI*2);edCtx.stroke();}
  else if(a.type==='arrow'){
    edCtx.lineWidth=4;edCtx.beginPath();edCtx.moveTo(a.x1,a.y1);edCtx.lineTo(a.x2,a.y2);edCtx.stroke();
    const angle=Math.atan2(a.y2-a.y1,a.x2-a.x1),hl=18;
    edCtx.beginPath();edCtx.moveTo(a.x2,a.y2);
    edCtx.lineTo(a.x2-hl*Math.cos(angle-Math.PI/6),a.y2-hl*Math.sin(angle-Math.PI/6));
    edCtx.moveTo(a.x2,a.y2);
    edCtx.lineTo(a.x2-hl*Math.cos(angle+Math.PI/6),a.y2-hl*Math.sin(angle+Math.PI/6));
    edCtx.stroke();}
  else if(a.type==='textbox'){edCtx.font=`bold ${a.fontSize}px 'DM Sans',sans-serif`;edCtx.textBaseline='top';
    // Text shadow for readability
    edCtx.shadowColor='rgba(0,0,0,.6)';edCtx.shadowBlur=3;edCtx.shadowOffsetX=1;edCtx.shadowOffsetY=1;
    const words=a.text.split(' ');let line='',lines=[];const mw=a.w-10;
    words.forEach(w=>{const tl=line+w+' ';if(edCtx.measureText(tl).width>mw&&line!==''){lines.push(line);line=w+' ';}else line=tl;});
    if(line)lines.push(line);lines.forEach((l,i)=>edCtx.fillText(l.trim(),a.x+5,a.y+5+i*a.fontSize*1.3));}
  edCtx.restore();}

function getPos(e){const r=edCanvas.getBoundingClientRect(),s=e.touches?e.touches[0]:e;
  return{x:(s.clientX-r.left)*(edCanvas.width/r.width),y:(s.clientY-r.top)*(edCanvas.height/r.height)};}

edCanvas.addEventListener('pointerdown',e=>{e.preventDefault();const p=getPos(e);startX=p.x;startY=p.y;
  if(curTool==='select'){
    drawing=true;
    if(selectedIdx>=0){transformHandle=getHandle(p,annotations[selectedIdx]);
      if(transformHandle){transformMode='resize';origAnnotation=JSON.parse(JSON.stringify(annotations[selectedIdx]));return;}}
    for(let i=annotations.length-1;i>=0;i--){if(hitTest(p,annotations[i])){selectedIdx=i;transformMode='move';
      origAnnotation=JSON.parse(JSON.stringify(annotations[i]));redraw();return;}}
    selectedIdx=-1;transformMode=null;redraw();return;}
  drawing=true;
  if(curTool==='pen')penPath=[{x:p.x,y:p.y}];
},{passive:false});

edCanvas.addEventListener('pointermove',e=>{if(!drawing)return;e.preventDefault();const p=getPos(e);
  if(curTool==='select'&&transformMode==='move'&&selectedIdx>=0){const a=annotations[selectedIdx],dx=p.x-startX,dy=p.y-startY;
    if(['rect','circle','arrow','line'].includes(a.type)){a.x1=origAnnotation.x1+dx;a.y1=origAnnotation.y1+dy;a.x2=origAnnotation.x2+dx;a.y2=origAnnotation.y2+dy;}
    else if(a.type==='textbox'){a.x=origAnnotation.x+dx;a.y=origAnnotation.y+dy;}
    else if(a.type==='pen'&&a.path){a.path=origAnnotation.path.map(pt=>({x:pt.x+dx,y:pt.y+dy}));}
    redraw();return;}
  if(curTool==='select'&&transformMode==='resize'&&selectedIdx>=0){const a=annotations[selectedIdx];
    if(['rect','circle','arrow','line'].includes(a.type)){if(transformHandle==='tl'){a.x1=p.x;a.y1=p.y;}else if(transformHandle==='tr'){a.x2=p.x;a.y1=p.y;}
      else if(transformHandle==='bl'){a.x1=p.x;a.y2=p.y;}else if(transformHandle==='br'){a.x2=p.x;a.y2=p.y;}}
    else if(a.type==='textbox'){if(transformHandle==='br'){a.w=Math.max(40,p.x-a.x);a.h=Math.max(20,p.y-a.y);}
      else if(transformHandle==='tr'){a.w=Math.max(40,p.x-a.x);} else if(transformHandle==='bl'){a.h=Math.max(20,p.y-a.y);}}
    redraw();return;}
  if(curTool==='pen'){penPath.push({x:p.x,y:p.y});edCtx.save();edCtx.strokeStyle=curColor;edCtx.lineWidth=curSize;edCtx.lineCap='round';
    edCtx.beginPath();penPath.forEach((pt,i)=>i===0?edCtx.moveTo(pt.x,pt.y):edCtx.lineTo(pt.x,pt.y));edCtx.stroke();edCtx.restore();}
  else if(['rect','circle','arrow','line'].includes(curTool)){redraw();paintAnnotation({type:curTool,x1:startX,y1:startY,x2:p.x,y2:p.y,color:curColor,size:curSize});}
  else if(curTool==='text'){redraw();edCtx.save();edCtx.strokeStyle=curColor;edCtx.lineWidth=2;edCtx.setLineDash([5,5]);
    edCtx.strokeRect(startX,startY,p.x-startX,p.y-startY);edCtx.restore();}
},{passive:false});

edCanvas.addEventListener('pointerup',e=>{if(!drawing)return;e.preventDefault();const p=getPos(e);
  if(curTool==='select'){transformMode=null;transformHandle=null;origAnnotation=null;drawing=false;return;}
  if(curTool==='pen')annotations.push({type:'pen',path:[...penPath],color:curColor,size:curSize});
  else if(['rect','circle','arrow','line'].includes(curTool))annotations.push({type:curTool,x1:startX,y1:startY,x2:p.x,y2:p.y,color:curColor,size:curSize});
  else if(curTool==='text')showTextInput(startX,startY,p.x,p.y);
  drawing=false;redraw();
},{passive:false});

let textBoxBounds=null;
function showTextInput(x1,y1,x2,y2){const w=Math.abs(x2-x1),h=Math.abs(y2-y1);if(w<20||h<20)return;
  textBoxBounds={x:Math.min(x1,x2),y:Math.min(y1,y2),w,h};const ov=document.getElementById('text-overlay');
  const cr=edCanvas.getBoundingClientRect();ov.style.display='block';
  ov.style.left=(cr.left+textBoxBounds.x)+'px';ov.style.top=(cr.top+textBoxBounds.y+h+10)+'px';
  document.getElementById('text-input').value='';document.getElementById('text-input').focus();}
function confirmTextInput(){const t=document.getElementById('text-input').value.trim(),fs=parseInt(document.getElementById('text-size').value);
  if(t&&textBoxBounds)annotations.push({type:'textbox',text:t,x:textBoxBounds.x,y:textBoxBounds.y,w:textBoxBounds.w,h:textBoxBounds.h,fontSize:fs,color:curColor});
  document.getElementById('text-overlay').style.display='none';textBoxBounds=null;redraw();}
function cancelTextInput(){document.getElementById('text-overlay').style.display='none';textBoxBounds=null;redraw();}

function setTool(t){curTool=t;selectedIdx=-1;updateSelectionUI();
  document.querySelectorAll('.tbtn[id^="tool-"]').forEach(b=>b.classList.remove('active'));
  const el=document.getElementById('tool-'+t);if(el)el.classList.add('active');edCanvas.style.cursor=t==='select'?'default':'crosshair';redraw();}
function setColor(c,el){curColor=c;document.querySelectorAll('.cswatch').forEach(s=>s.classList.remove('active'));el.classList.add('active');
  // Update selected annotation color too
  if(selectedIdx>=0){annotations[selectedIdx].color=c;redraw();}}
function undoLast(){if(annotations.length){annotations.pop();selectedIdx=-1;updateSelectionUI();redraw();}}
function saveEditor(){const it=items.find(i=>i.id==edItemId);
  if(it&&it[edPhotoField]){
    const photo=it[edPhotoField][edPhotoIdx];
    // Save original unannotated image (only first time)
    if(!photo.originalData)photo.originalData=photo.data;
    // Save annotations as editable objects
    photo.annotations=JSON.parse(JSON.stringify(annotations));
    // Save flattened preview (with annotations burned in) for display/export
    photo.data=edCanvas.toDataURL('image/jpeg',.92);
    photo.editedAt=ts();
    addAudit(it,'foto_bewerkt',edPhotoField+' #'+(edPhotoIdx+1)+' ‚Äî '+annotations.length+' annotaties');}
  closeEditor();renderItems();saveData();}
function closeEditor(){document.getElementById('editor-overlay').classList.remove('open');}

// ‚ïê‚ïê SUPPLIERS ‚ïê‚ïê
let supLogoData='';
function openAddSupplier(){document.getElementById('modal-supplier').classList.add('show');
  document.getElementById('new-sup-name').value='';document.getElementById('new-sup-email').value='';supLogoData='';
  document.getElementById('sup-logo-preview').textContent='Klik om logo te uploaden';
  setTimeout(()=>document.getElementById('new-sup-name').focus(),100);}
function closeModal(id){document.getElementById(id).classList.remove('show');}
document.getElementById('new-sup-logo-file').addEventListener('change',function(e){const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{supLogoData=ev.target.result;
    document.getElementById('sup-logo-preview').innerHTML=`<img src="${supLogoData}" style="height:40px;border-radius:4px"/>`;};r.readAsDataURL(f);});
function saveNewSupplier(){const name=document.getElementById('new-sup-name').value.trim(),email=document.getElementById('new-sup-email').value.trim();
  if(!name){showToast('Naam is verplicht','error');return;}
  suppliers.push({id:'sup-'+Date.now(),name,logo:supLogoData,email});saveSup();closeModal('modal-supplier');
  renderItems();showToast(name+' toegevoegd');}

// ‚ïê‚ïê EMAIL ‚ïê‚ïê
let emailItemId=null;
function prepEmail(id){const it=items.find(i=>i.id==id);if(!it)return;
  if(!(it.photos||[]).length){showToast('Voeg eerst foto\'s van het product toe','error');return;}
  if(!it.supplierId){showToast('Selecteer eerst een leverancier','error');return;}
  if(!it.description){showToast('Vul eerst een omschrijving in','error');return;}
  emailItemId=id;const sup=findSupplier(it.supplierId);
  const pc=(it.photos||[]).length,ac=(it.artikelPhotos||[]).length,sc=(it.stickerPhotos||[]).length,bc=(it.bonPhotos||[]).length,tc=pc+ac+sc+bc;
  const types={'paars':'spare part (stock)','oranje':'spare part (interventie)','geel':'niet volledige levering','rood':'beschadigde levering / retour','blauw':'retour van werf'};
  const subj=`Melding ${types[it.section]||it.section}${it.projectNumber?' ‚Äî Project: '+it.projectNumber:''}${it.reference?' ‚Äî Ref: '+it.reference:''}`;
  const projLine=it.projectNumber?`Projectnummer: ${it.projectNumber}\n`:'';
  const refLine=it.reference?`Referentie: ${it.reference}\n`:'';
  const serialLine=it.serial?`Serienummer: ${it.serial}\n`:'';
  const body=`Beste ${sup.name},\n\nHierbij melden wij:\n\n${it.description}\n\n${projLine}${refLine}${serialLine}${tc?tc+' foto(s) in bijlage.\n\n':'\n'}Met vriendelijke groeten,\nAdvanced Energy\n\n---\nGeregistreerd: ${it.timestamp} door ${it.createdBy||'?'}\nVerstuurd: ${ts()} door ${magazijnier}`;
  window._eTo=sup.email||'';window._eSubj=subj;window._eBody=body;
  document.getElementById('email-content').innerHTML=`<div style="margin-bottom:8px"><strong>Aan:</strong> ${sup.name} ‚Äî ${sup.email||'(geen e-mail)'}</div>
    <div style="margin-bottom:8px"><strong>Onderwerp:</strong> ${subj}</div>
    <div class="email-preview">${body.replace(/\n/g,'<br>')}</div>
    ${tc?`<div style="margin-top:6px;font-size:11px;color:var(--text3)">${tc} foto(s) als bijlage</div>`:''}`;
  document.getElementById('modal-email').classList.add('show');}
function sendEmail(){window.open(`mailto:${window._eTo}?subject=${encodeURIComponent(window._eSubj)}&body=${encodeURIComponent(window._eBody)}`,'_blank');
  const it=items.find(i=>i.id==emailItemId);if(it){it.emailSent=true;it.emailSentAt=ts();it.emailSentBy=magazijnier;
    addAudit(it,'email_verstuurd',`Mail naar ${findSupplier(it.supplierId)?.name||'leverancier'}`);}
  closeModal('modal-email');renderItems();saveData();showToast('E-mail geopend');}

// ‚ïê‚ïê TOAST / PERSISTENCE ‚ïê‚ïê
function showToast(msg,type){const el=document.getElementById('global-toast');el.textContent=msg;
  el.className='toast show'+(type?' '+type:'');if(toastTimer)clearTimeout(toastTimer);toastTimer=setTimeout(()=>el.classList.remove('show'),3000);}
function cleanEmptyItems(){
  const before=items.length;
  items=items.filter(i=>!itemIsEmpty(i)||i.open);
  // Reclaim nextId if last items were removed
  if(items.length&&items.length<before){
    const maxId=Math.max(...items.map(i=>i.id),0);
    nextId=maxId+1;
  }
}
function saveData(){cleanEmptyItems();localStorage.setItem('mag-items',JSON.stringify(items));localStorage.setItem('mag-nextId',nextId);
  // === FIREBASE SYNC ===
  try{
    // Items opslaan zonder foto data (base64 te groot), maar WEL met storageUrls
    const itemsForCloud=items.map(i=>{
      const copy=Object.assign({},i);
      ['photos','artikelPhotos','stickerPhotos','bonPhotos','schadePhotos','seriePhotos'].forEach(f=>{
        if(copy[f]){copy[f]=copy[f].map(p=>({
          storageUrl:p.storageUrl||'',
          storagePath:p.storagePath||'',
          timestamp:p.timestamp||'',
          editedAt:p.editedAt||''
        }));}
      });
      return copy;
    });
    db.collection('magazijn').doc('items').set({
      items:JSON.stringify(itemsForCloud),
      nextId:nextId,
      lastUpdated:new Date().toISOString(),
      updatedBy:magazijnier||'onbekend'
    }).then(()=>{console.log('‚úÖ Firebase: items opgeslagen');})
      .catch(e=>{console.warn('‚ö†Ô∏è Firebase save error:',e);});
  }catch(e){console.warn('Firebase sync error:',e);}
}
function loadData(){const s=localStorage.getItem('mag-items');if(s){items=JSON.parse(s);items.forEach(i=>{i.open=false;if(!i.audit)i.audit=[];if(!i.status)i.status='open';if(!i.uuid)i.uuid=genUUID();});
  // Dedup: remove items with duplicate uuid, keep first
  const seen=new Set();const before=items.length;
  items=items.filter(i=>{
    if(!i.uuid)return true;
    if(seen.has(i.uuid))return false;seen.add(i.uuid);return true;
  });
  if(items.length<before){console.log('Dedup: verwijderd '+(before-items.length)+' dubbel(s)');
    localStorage.setItem('mag-items',JSON.stringify(items));} // auto-save cleanup
  }
  const sid=localStorage.getItem('mag-nextId');if(sid)nextId=parseInt(sid);
}
function exportData(){
  const active=items.filter(i=>!i.deleted);
  const archived=items.filter(i=>i.deleted);
  const d={exported:new Date().toISOString(),exportedBy:magazijnier,
    suppliers,activeItems:active,archivedItems:archived,
    stats:{total:items.length,active:active.length,archived:archived.length,
      byCategory:Object.fromEntries(Object.keys(SEC).map(s=>[s,active.filter(i=>i.section===s).length]))}};
  const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download='magazijn-'+new Date().toISOString().slice(0,10)+'.json';a.click();showToast('Ge√´xporteerd (incl. archief)');}

loadData();updateHub();initUser();

// === FIREBASE: Sync bestaande foto's naar cloud (achtergrond, 5 sec na laden) ===
setTimeout(()=>{syncPhotosToCloud();}, 5000);

// === FIREBASE: Laad data van cloud als localStorage leeg is ===
(function loadFromFirebase(){
  if(items.length>0)return; // localStorage heeft al data, skip
  db.collection('magazijn').doc('items').get().then(doc=>{
    if(doc.exists&&doc.data().items){
      const cloudItems=JSON.parse(doc.data().items);
      if(cloudItems.length>0&&items.length===0){
        items=cloudItems;items.forEach(i=>{i.open=false;if(!i.audit)i.audit=[];if(!i.status)i.status='open';if(!i.uuid)i.uuid=genUUID();});
        nextId=doc.data().nextId||1;
        localStorage.setItem('mag-items',JSON.stringify(items));
        localStorage.setItem('mag-nextId',nextId);
        updateHub();showToast('Data geladen vanuit cloud ‚òÅÔ∏è');
        console.log('‚úÖ Firebase: '+cloudItems.length+' items geladen');
      }
    }
  }).catch(e=>{console.warn('Firebase load error:',e);});
})();
</script>
</body>
</html>
