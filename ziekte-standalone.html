<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ziekte â€” Personeelbeheer</title>
<style>
:root{--bg:#f1f5f9;--card:#fff;--border:#e2e8f0;--text1:#0f172a;--text2:#475569;--text3:#94a3b8;--accent:#3b82f6;--red:#ef4444;--radius:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text1)}
.header{background:var(--card);border-bottom:1px solid var(--border);padding:20px 24px}
.header h1{font-size:20px;font-weight:700;margin-bottom:4px}
.header .sub{font-size:12px;color:var(--text3)}
.stats{display:flex;gap:12px;margin-top:16px}
.stat{flex:1;border-radius:var(--radius);padding:12px 16px;border:1px solid transparent}
.stat-val{font-size:24px;font-weight:700}
.stat-label{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.tabs-bar{display:flex;background:var(--card);border-bottom:1px solid var(--border);padding:0 24px}
.tab{padding:11px 18px;border:none;border-bottom:2px solid transparent;background:none;color:var(--text3);font-weight:600;font-size:13px;cursor:pointer}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-badge{background:#ef4444;color:#fff;font-size:10px;font-weight:700;padding:1px 6px;border-radius:10px;margin-left:6px}
.table-wrap{padding:16px 24px}
.table-card{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 14px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);border-bottom:2px solid var(--border)}
td{padding:10px 14px;border-bottom:1px solid #f1f5f9}
tr:hover td{background:#f8fafc}
.avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;font-weight:700;flex-shrink:0}
.person{display:flex;align-items:center;gap:8px}
.empty{text-align:center;padding:48px;color:var(--text3)}
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.bradford-card{margin-top:16px;padding:0 24px 24px}
.risk-low{background:#dcfce7;color:#166534;padding:2px 8px;border-radius:5px;font-size:11px;font-weight:600}
.risk-med{background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:5px;font-size:11px;font-weight:600}
.risk-high{background:#fee2e2;color:#991b1b;padding:2px 8px;border-radius:5px;font-size:11px;font-weight:600}
.footer{padding:8px 24px;font-size:11px;color:var(--text3);display:flex;justify-content:space-between}
</style>
</head>
<body>
<div id="app"><div class="loading"><div class="spinner"></div><p style="color:#64748b;font-size:14px;margin-top:16px">Laden...</p></div></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({apiKey:"AIzaSyBKU-wCjV4Au4ngRG52Zmmxbzc3N3D8VBU",authDomain:"advanced-intranet.firebaseapp.com",projectId:"advanced-intranet",storageBucket:"advanced-intranet.firebasestorage.app",messagingSenderId:"309856938024",appId:"1:309856938024:web:2108715f92c5dea2da2d1d"});
var db=firebase.firestore();
var people=[],departments=[],leaveTypes=[],requests=[];
var currentFilter='active';

var COLORS=["#3b82f6","#22c55e","#a855f7","#ef4444","#eab308","#ec4899","#06b6d4","#f97316"];
function ac(n){var h=0;for(var i=0;i<n.length;i++)h=n.charCodeAt(i)+((h<<5)-h);return COLORS[Math.abs(h)%COLORS.length]}
function ini(n){return n.split(' ').map(function(w){return w[0]}).join('').toUpperCase().slice(0,2)}
function gN(id){var p=people.find(function(x){return x.id===id});return p?p.firstName+' '+p.lastName:'?'}
function gD(id){var p=people.find(function(x){return x.id===id});if(!p)return'';var d=departments.find(function(x){return x.id===p.departmentId});return d?d.name:''}
function fD(d){try{return new Date(d).toLocaleDateString('nl-BE',{day:'2-digit',month:'short'})}catch(e){return d}}
function daysBetween(a,b){return Math.max(1,Math.round((new Date(b)-new Date(a))/86400000)+1)}

function render(){
  var td=new Date().toISOString().split('T')[0];
  var sick=requests.filter(function(r){return r.type==='ziekte'});
  var activeSick=sick.filter(function(r){return r.startDate<=td&&r.endDate>=td});
  var filtered=currentFilter==='active'?activeSick:sick;
  filtered.sort(function(a,b){return new Date(b.startDate)-new Date(a.startDate)});

  var h='<div class="header"><h1>ðŸ¤’ Ziekte</h1><p class="sub">Ziekmeldingen en Bradford Factor</p>';
  h+='<div class="stats">';
  h+='<div class="stat" style="background:#fef2f2;border-color:#ef444422"><div class="stat-val" style="color:#ef4444">'+activeSick.length+'</div><div class="stat-label">Actief ziek</div></div>';
  h+='<div class="stat" style="background:#fefce8;border-color:#eab30822"><div class="stat-val" style="color:#eab308">'+sick.length+'</div><div class="stat-label">Totaal meldingen</div></div>';
  var totalDays=sick.reduce(function(s,r){return s+daysBetween(r.startDate,r.endDate)},0);
  h+='<div class="stat" style="background:#f8fafc;border-color:#64748b22"><div class="stat-val" style="color:#64748b">'+totalDays+'</div><div class="stat-label">Totaal ziektedagen</div></div>';
  h+='</div></div>';

  // Tabs
  h+='<div class="tabs-bar">';
  h+='<button class="tab'+(currentFilter==='active'?' active':'')+'" onclick="setF(\'active\')">ðŸ¤’ Actief ziek';
  if(activeSick.length>0)h+='<span class="tab-badge">'+activeSick.length+'</span>';
  h+='</button>';
  h+='<button class="tab'+(currentFilter==='all'?' active':'')+'" onclick="setF(\'all\')">Alle meldingen</button>';
  h+='</div>';

  // Table
  h+='<div class="table-wrap"><div class="table-card">';
  if(filtered.length===0){
    h+='<div class="empty"><div style="font-size:36px;margin-bottom:8px">ðŸŽ‰</div>Geen ziekmeldingen</div>';
  }else{
    h+='<table><thead><tr><th>Medewerker</th><th>Afdeling</th><th>Van</th><th>Tot</th><th>Dagen</th><th>Status</th></tr></thead><tbody>';
    filtered.forEach(function(r){
      var n=gN(r.personId),isActive=r.startDate<=td&&r.endDate>=td;
      h+='<tr><td><div class="person"><div class="avatar" style="background:'+ac(n)+'">'+ini(n)+'</div><span style="font-weight:600">'+n+'</span></div></td>';
      h+='<td style="color:var(--text3);font-size:12px">'+gD(r.personId)+'</td>';
      h+='<td style="font-size:12px">'+fD(r.startDate)+'</td>';
      h+='<td style="font-size:12px">'+fD(r.endDate)+'</td>';
      h+='<td style="font-weight:600">'+daysBetween(r.startDate,r.endDate)+'d</td>';
      h+='<td>'+(isActive?'<span style="background:#fef2f2;color:#991b1b;padding:3px 10px;border-radius:6px;font-size:12px;font-weight:600">ðŸ”´ Actief ziek</span>':'<span style="background:#f1f5f9;color:#64748b;padding:3px 10px;border-radius:6px;font-size:12px;font-weight:600">Afgerond</span>')+'</td></tr>';
    });
    h+='</tbody></table>';
  }
  h+='</div></div>';

  // Bradford Factor
  h+='<div class="bradford-card"><div class="table-card">';
  h+='<div style="padding:14px;border-bottom:1px solid var(--border);font-weight:700;font-size:14px">ðŸ“Š Bradford Factor <span style="font-weight:400;font-size:11px;color:var(--text3)">(SÂ² Ã— D â€” rollende 52 weken)</span></div>';
  var oneYearAgo=new Date();oneYearAgo.setFullYear(oneYearAgo.getFullYear()-1);var cutoff=oneYearAgo.toISOString().split('T')[0];
  var bradford={};
  sick.filter(function(r){return r.endDate>=cutoff}).forEach(function(r){
    if(!bradford[r.personId])bradford[r.personId]={spells:0,days:0};
    bradford[r.personId].spells++;
    bradford[r.personId].days+=daysBetween(r.startDate,r.endDate);
  });
  var bList=Object.keys(bradford).map(function(id){var b=bradford[id];return{id:id,s:b.spells,d:b.days,score:b.spells*b.spells*b.days}}).sort(function(a,b){return b.score-a.score});
  if(bList.length===0){h+='<div class="empty">Geen ziekteverzuim in de afgelopen 12 maanden</div>';}
  else{
    h+='<table><thead><tr><th>Medewerker</th><th>Periodes (S)</th><th>Dagen (D)</th><th>Score</th><th>Risico</th></tr></thead><tbody>';
    bList.forEach(function(b){
      var n=gN(b.id),risk=b.score<50?'low':b.score<200?'med':'high';
      var riskLabel=risk==='low'?'Laag':risk==='med'?'Gemiddeld':'Hoog';
      h+='<tr><td><div class="person"><div class="avatar" style="background:'+ac(n)+'">'+ini(n)+'</div><span style="font-weight:600">'+n+'</span></div></td>';
      h+='<td>'+b.s+'</td><td>'+b.d+'</td><td style="font-weight:700">'+b.score+'</td>';
      h+='<td><span class="risk-'+risk+'">'+riskLabel+'</span></td></tr>';
    });
    h+='</tbody></table>';
  }
  h+='</div></div>';

  h+='<div class="footer"><span>'+filtered.length+' melding'+(filtered.length!==1?'en':'')+'</span><span>Real-time sync ðŸŸ¢</span></div>';
  document.getElementById('app').innerHTML=h;
}

function setF(f){currentFilter=f;render()}

db.collection('platform').doc('personeelbeheer').onSnapshot(function(doc){
  if(!doc.exists)return;var d=doc.data();
  if(d.people)people=JSON.parse(d.people);
  if(d.departments)departments=JSON.parse(d.departments);
  if(d.leaveTypes)leaveTypes=JSON.parse(d.leaveTypes);
  if(d.requests)requests=JSON.parse(d.requests);
  render();
});
</script>
</body>
</html>
