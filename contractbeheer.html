<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Contractbeheer ‚Äî Advanced Energy</title>
<style>
/* ‚ïê‚ïê‚ïê CSS STYLES ‚ïê‚ïê‚ïê */
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');

:root{
  --bg:#f0f4ff;--surface:#fff;--surface2:#f8faff;--surface3:#eef2fb;
  --text:#2d2d2d;--text2:#5a6377;--text3:#6b7280;
  --border:#e2e8f4;--border-hover:#c5cfe0;
  --accent:#3b82f6;--accent-bg:rgba(59,130,246,.08);--accent-border:rgba(59,130,246,.25);
  --success:#38d9a9;--success-bg:rgba(56,217,169,.1);
  --danger:#ff5c5c;--danger-bg:rgba(255,92,92,.08);--danger-border:rgba(255,92,92,.2);
  --warn:#f59e0b;--warn-bg:rgba(245,158,11,.08);
  --radius:14px;--radius-sm:8px;--radius-xs:6px;
  --shadow:0 2px 8px rgba(0,0,0,.06);--shadow-lg:0 8px 24px rgba(0,0,0,.1);
  --sidebar-w:240px;
}

*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;}
button{font-family:inherit;cursor:pointer;}
input,select,textarea{font-family:inherit;font-size:13px;}

/* Sidebar */
.sidebar{width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:250;}
.sb-header{padding:20px;border-bottom:1px solid var(--border);}
.sb-logo{display:flex;align-items:center;gap:10px;}
.sb-logo-icon{width:36px;height:36px;border-radius:50%;overflow:hidden;flex-shrink:0;}
.sb-logo-icon img{width:100%;height:100%;object-fit:contain;}
.sb-logo-text{font-weight:700;font-size:15px;line-height:1.2;}
.sb-logo-sub{font-size:11px;color:var(--text3);font-weight:400;}
.sb-nav{flex:1;padding:12px 10px;overflow-y:auto;}
.sb-section{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;
  color:var(--text3);padding:12px 10px 6px;}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);
  color:var(--text2);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;border:none;
  background:none;width:100%;text-align:left;}
.sb-item:hover{background:var(--surface2);color:var(--text);}
.sb-item.active{background:var(--accent-bg);color:var(--accent);font-weight:600;}
.sb-item-icon{font-size:16px;width:22px;text-align:center;}
.sb-item-badge{margin-left:auto;background:var(--danger);color:#fff;font-size:10px;font-weight:700;
  padding:2px 7px;border-radius:10px;min-width:20px;text-align:center;}
.sb-footer{padding:12px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text3);}

/* Role bar */
.role-bar{position:fixed;top:0;left:var(--sidebar-w);right:0;height:44px;background:var(--surface);
  border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;z-index:90;gap:12px;}
.role-bar-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:1px;}
.role-bar-right{margin-left:auto;display:flex;align-items:center;gap:12px;}
.env-badge{background:#3b82f6;color:#fff;font-size:10px;font-weight:700;padding:3px 10px;
  border-radius:10px;letter-spacing:1px;text-transform:uppercase;}

/* Main content */
.main{margin-left:var(--sidebar-w);padding-top:44px;flex:1;min-height:100vh;}
.page{max-width:1100px;margin:0 auto;padding:28px 32px;}
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;}
.page-title{font-size:22px;font-weight:700;}
.page-subtitle{font-size:13px;color:var(--text3);margin-top:2px;}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:20px;box-shadow:var(--shadow);transition:all .15s;}
.card-title{font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.card-grid{display:grid;gap:16px;}
.card-grid-2{grid-template-columns:1fr 1fr;}
.card-grid-3{grid-template-columns:1fr 1fr 1fr;}
.card-grid-4{grid-template-columns:1fr 1fr 1fr 1fr;}

/* Stats */
.stat{text-align:center;padding:16px;}
.stat-value{font-size:28px;font-weight:700;line-height:1;}
.stat-label{font-size:11px;color:var(--text3);margin-top:4px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;}

/* Tables */
.tbl{width:100%;border-collapse:collapse;font-size:13px;}
.tbl th{text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;
  color:var(--text3);padding:10px 12px;border-bottom:2px solid var(--border);}
.tbl td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
.tbl tr:hover td{background:var(--surface2);}
.tbl tr:last-child td{border-bottom:none;}

/* Badges */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:12px;
  font-size:11px;font-weight:600;white-space:nowrap;}
.badge-blue{background:rgba(59,130,246,.1);color:#3b82f6;}
.badge-green{background:rgba(34,197,94,.1);color:#22c55e;}
.badge-yellow{background:rgba(234,179,8,.1);color:#b45309;}
.badge-red{background:rgba(239,68,68,.1);color:#ef4444;}
.badge-gray{background:rgba(148,163,184,.1);color:#64748b;}
.badge-purple{background:rgba(168,85,247,.1);color:#a855f7;}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);
  font-size:13px;font-weight:600;border:1px solid var(--border);background:var(--surface);
  color:var(--text);transition:all .15s;}
.btn:hover{border-color:var(--border-hover);background:var(--surface2);}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent);}
.btn-primary:hover{background:#2563eb;border-color:#2563eb;}
.btn-primary-outline{background:rgba(59,130,246,.08);color:var(--accent);border-color:rgba(59,130,246,.35);}
.btn-primary-outline:hover{background:rgba(59,130,246,.15);border-color:var(--accent);}
.btn-danger{background:var(--danger-bg);color:var(--danger);border-color:var(--danger-border);}
.btn-danger:hover{background:rgba(255,92,92,.15);}
.btn-sm{padding:5px 12px;font-size:12px;}
.btn-icon{width:32px;height:32px;padding:0;display:inline-flex;align-items:center;justify-content:center;}

/* Dashed add button */
.btn-dashed{border-style:dashed;width:100%;justify-content:center;color:var(--text3);}

/* Forms */
.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;}
.form-label .req{color:var(--danger);}
.form-input{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);
  background:#fff;color:#000;font-size:13px;transition:border-color .15s;}
.form-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.1);}
.form-row{display:flex;gap:16px;}
.form-row>*{flex:1;}
select.form-input{cursor:pointer;}

/* Modal */
.modal-overlay{position:fixed;top:0;left:var(--sidebar-w);right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;display:none;
  align-items:stretch;justify-content:stretch;backdrop-filter:blur(2px);}
.modal-overlay.show{display:flex;}
.modal{background:var(--surface);border-radius:0;width:100%;max-width:none;
  max-height:none;overflow-y:auto;box-shadow:var(--shadow-lg);padding:24px 32px;margin:0;
  display:flex;flex-direction:column;}
.modal-title{font-size:18px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;
  justify-content:space-between;flex-shrink:0;}
.modal-close{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--surface);
  display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;color:var(--text3);}
.modal-close:hover{background:var(--surface2);color:var(--text);}
.modal-body{flex:1;overflow-y:auto;min-height:0;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;padding-top:16px;
  border-top:1px solid var(--border);flex-shrink:0;}
.modal-top-actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);}

/* Tabs */
.tabs{display:flex;gap:4px;border-bottom:2px solid var(--border);margin-bottom:20px;}
.tab{padding:10px 16px;font-size:13px;font-weight:600;color:var(--text3);cursor:pointer;
  border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}

/* Panels */
.panel{display:none;}
.panel.active{display:block;}

/* Avatar */
.avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:700;color:#fff;flex-shrink:0;}

/* Search */
.search-box{position:relative;}
.search-box input{padding-left:34px;}
.search-box::before{content:'üîç';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;}

/* Color dots */
.clr-dot{width:10px;height:10px;border-radius:50%;display:inline-block;flex-shrink:0;}

/* Chip */
.chip{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:12px;
  font-size:11px;font-weight:600;border:1px solid var(--border);background:var(--surface2);}

/* Timeline */
.timeline-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);}
.timeline-item:last-child{border-bottom:none;}
.timeline-dot{width:10px;height:10px;border-radius:50%;background:var(--accent);margin-top:5px;flex-shrink:0;}
.timeline-content{flex:1;}
.timeline-date{font-size:11px;color:var(--text3);font-weight:600;}
.timeline-text{font-size:13px;margin-top:2px;}

/* Status dots */
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px;}
.status-actief{background:var(--success);}
.status-vervallend{background:var(--warn);}
.status-verlopen{background:var(--danger);}
.status-opgezegd{background:var(--text3);}

/* Utility */
.flex-between{display:flex;justify-content:space-between;align-items:center;}
.text-muted{font-size:13px;color:var(--text3);}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:var(--radius-sm);
  font-size:13px;font-weight:600;box-shadow:var(--shadow-lg);z-index:300;transform:translateY(80px);
  opacity:0;transition:all .3s ease;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast-success{background:#065f46;color:#fff;}
.toast-error{background:#991b1b;color:#fff;}
.toast-warn{background:#92400e;color:#fff;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê HTML STRUCTURE ‚ïê‚ïê‚ïê -->

<!-- Sidebar -->
<nav class="sidebar" aria-label="Hoofdmenu">
  <div class="sb-header">
    <div class="sb-logo" onclick="showPage('dashboard')" style="cursor:pointer">
      <div class="sb-logo-icon"><img src="data:image/png;base64,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" alt="AE"/></div>
      <div>
        <div class="sb-logo-text">Contractbeheer</div>
        <div class="sb-logo-sub">Advanced Energy</div>
      </div>
    </div>
  </div>
  <div class="sb-nav">
    <div class="sb-section">Overzicht</div>
    <button class="sb-item active" data-page="dashboard" onclick="showPage('dashboard')">
      <span class="sb-item-icon">üìä</span>Dashboard
    </button>
    <div class="sb-section">Beheer</div>
    <button class="sb-item" data-page="contracts" onclick="showPage('contracts')">
      <span class="sb-item-icon">üìÑ</span>Contracten
    </button>
    <button class="sb-item" data-page="tasks" onclick="showPage('tasks')">
      <span class="sb-item-icon">‚è∞</span>Taken & Reminders
      <span class="sb-item-badge" id="badge-tasks" style="display:none">0</span>
    </button>
    <button class="sb-item" data-page="relations" onclick="showPage('relations')">
      <span class="sb-item-icon">üè¢</span>Relaties
    </button>
    <div class="sb-section">Configuratie</div>
    <button class="sb-item" data-page="settings" onclick="showPage('settings')">
      <span class="sb-item-icon">‚öôÔ∏è</span>Instellingen
    </button>
  </div>
  <div class="sb-footer">
    <div style="display:flex;justify-content:space-between;align-items:center">
      Contractbeheer v1.0
      <button onclick="resetData()" style="background:none;border:none;color:var(--text3);font-size:10px;cursor:pointer;text-decoration:underline" title="Alle data resetten naar standaardwaarden">üîÑ Reset</button>
    </div>
  </div>
</nav>

<!-- Role bar -->
<div class="role-bar">
  <span class="role-bar-label">Contractbeheer ‚Äî Advanced Energy</span>
  <div class="role-bar-right">
    <span class="env-badge">Development</span>
  </div>
</div>

<!-- Main content -->
<div class="main" role="main">

  <!-- Dashboard -->
  <div class="panel active" id="page-dashboard">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Dashboard</div><div class="page-subtitle">Overzicht contracten en deadlines</div></div>
      </div>
      <div class="card-grid card-grid-4" style="margin-bottom:20px">
        <div class="card" style="cursor:pointer" onclick="showPage('contracts')"><div class="stat"><div class="stat-value" id="st-total">0</div><div class="stat-label">Totaal actief</div></div></div>
        <div class="card" style="cursor:pointer" onclick="showPageFiltered('contracts','contract-status-filter','vervallend30')"><div class="stat"><div class="stat-value" id="st-30d" style="color:var(--danger)">0</div><div class="stat-label">Vervalt &lt; 30d</div></div></div>
        <div class="card" style="cursor:pointer" onclick="showPageFiltered('contracts','contract-status-filter','vervallend60')"><div class="stat"><div class="stat-value" id="st-60d" style="color:var(--warn)">0</div><div class="stat-label">Vervalt &lt; 60d</div></div></div>
        <div class="card" style="cursor:pointer" onclick="showPageFiltered('contracts','contract-status-filter','vervallend90')"><div class="stat"><div class="stat-value" id="st-90d" style="color:var(--accent)">0</div><div class="stat-label">Vervalt &lt; 90d</div></div></div>
      </div>
      <div class="card-grid card-grid-4" style="margin-bottom:20px">
        <div class="card"><div class="stat"><div class="stat-value" id="st-value" style="font-size:22px">‚Ç¨ 0</div><div class="stat-label">Totale waarde</div></div></div>
        <div class="card" style="cursor:pointer" onclick="showPageFiltered('contracts','contract-status-filter','verlopen')"><div class="stat"><div class="stat-value" id="st-expired" style="color:var(--danger)">0</div><div class="stat-label">Verlopen</div></div></div>
        <div class="card" style="cursor:pointer" onclick="showPageFiltered('contracts','contract-status-filter','opgezegd')"><div class="stat"><div class="stat-value" id="st-terminated" style="color:var(--text3)">0</div><div class="stat-label">Opgezegd</div></div></div>
        <div class="card" style="cursor:pointer" onclick="showPage('relations')"><div class="stat"><div class="stat-value" id="st-relations">0</div><div class="stat-label">Relaties</div></div></div>
      </div>
      <div class="card-grid card-grid-3" style="margin-bottom:20px">
        <div class="card" style="grid-column:span 2">
          <div class="card-title">‚è∞ Binnenkort vervallend</div>
          <div id="dash-expiring"><span class="text-muted">Geen contracten die binnenkort vervallen</span></div>
        </div>
        <div class="card">
          <div class="card-title">üìã Verdeling per type</div>
          <div id="dash-types"><span class="text-muted">Geen contracten</span></div>
        </div>
      </div>
      <div class="card-grid card-grid-2">
        <div class="card">
          <div class="card-title">üîî Opzegdeadlines</div>
          <div id="dash-notices"><span class="text-muted">Geen naderende opzegdeadlines</span></div>
        </div>
        <div class="card">
          <div class="card-title">üìù Recente wijzigingen</div>
          <div id="dash-recent"><span class="text-muted">Geen recente wijzigingen</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contracten -->
  <div class="panel" id="page-contracts">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Contracten</div><div class="page-subtitle">Overzicht van alle contracten</div></div>
        <button class="btn btn-primary-outline btn-sm" onclick="openContractModal()" id="btn-new-contract">‚ûï Nieuw contract</button>
      </div>
      <div class="card">
        <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">
          <div class="search-box" style="flex:1;min-width:200px">
            <input class="form-input" placeholder="Zoeken op naam, partij, referentie..." oninput="filterContracts(this.value)" id="contract-search">
          </div>
          <select class="form-input" style="width:160px" id="contract-type-filter" onchange="renderContracts()">
            <option value="">Alle types</option>
          </select>
          <select class="form-input" style="width:160px" id="contract-status-filter" onchange="renderContracts()">
            <option value="">Alle statussen</option>
            <option value="actief">Actief</option>
            <option value="vervallend30">Vervalt &lt; 30d</option>
            <option value="vervallend60">Vervalt &lt; 60d</option>
            <option value="vervallend90">Vervalt &lt; 90d</option>
            <option value="verlopen">Verlopen</option>
            <option value="opgezegd">Opgezegd</option>
          </select>
          <select class="form-input" style="width:160px" id="contract-dept-filter" onchange="renderContracts()">
            <option value="">Alle afdelingen</option>
          </select>
        </div>
        <div id="contracts-table"><span class="text-muted">Geen contracten gevonden</span></div>
      </div>
    </div>
  </div>

  <!-- Taken & Reminders -->
  <div class="panel" id="page-tasks">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Taken & Reminders</div><div class="page-subtitle">Deadlines, opzegtermijnen en verplichtingen</div></div>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="switchTasksTab('all',this)">Alle</button>
        <button class="tab" onclick="switchTasksTab('expiring',this)">üìÑ Vervallend</button>
        <button class="tab" onclick="switchTasksTab('notice',this)">üîî Opzegdeadlines</button>
        <button class="tab" onclick="switchTasksTab('expired',this)">üö® Verlopen</button>
        <button class="tab" onclick="switchTasksTab('done',this)">‚úÖ Afgehandeld</button>
      </div>
      <div class="card">
        <div id="tasks-list"><span class="text-muted">Geen openstaande taken</span></div>
      </div>
    </div>
  </div>

  <!-- Relaties -->
  <div class="panel" id="page-relations">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Relaties</div><div class="page-subtitle">Contractpartijen en leveranciers</div></div>
        <button class="btn btn-primary-outline btn-sm" onclick="openRelationModal()" id="btn-new-relation">‚ûï Nieuwe relatie</button>
      </div>
      <div class="card">
        <div style="display:flex;gap:12px;margin-bottom:16px">
          <div class="search-box" style="flex:1">
            <input class="form-input" placeholder="Zoeken op naam, contactpersoon..." oninput="filterRelations(this.value)" id="relation-search">
          </div>
        </div>
        <div id="relations-table"><span class="text-muted">Geen relaties gevonden</span></div>
      </div>
    </div>
  </div>

  <!-- Instellingen -->
  <div class="panel" id="page-settings">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Instellingen</div><div class="page-subtitle">Configuratie van types, reminders en koppelingen</div></div>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="showSettingsTab('types',this)">Contracttypes</button>
        <button class="tab" onclick="showSettingsTab('departments',this)">Afdelingen</button>
        <button class="tab" onclick="showSettingsTab('reminders',this)">Reminders</button>
      </div>
      <div id="settings-types" class="settings-panel"><span class="text-muted">Wordt geladen...</span></div>
      <div id="settings-departments" class="settings-panel" style="display:none"><span class="text-muted">Wordt geladen...</span></div>
      <div id="settings-reminders" class="settings-panel" style="display:none"><span class="text-muted">Wordt geladen...</span></div>
    </div>
  </div>

</div><!-- /main -->

<!-- Modal overlay -->
<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-title">
      <span id="modal-title-text"></span>
      <span id="modal-title-actions" style="display:flex;gap:8px;align-items:center"></span>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê DATA & CONFIG ‚ïê‚ïê‚ïê

const AVATARCOLORS=['#3b82f6','#22c55e','#a855f7','#ef4444','#eab308','#ec4899','#06b6d4','#f97316'];

const DEFAULT_CONTRACT_TYPES=[
  {id:'gebouw',name:'Gebouw',color:'#3b82f6',icon:'üè¢'},
  {id:'mobiliteit',name:'Mobiliteit',color:'#22c55e',icon:'üöó'},
  {id:'verzekering',name:'Verzekering',color:'#a855f7',icon:'üõ°Ô∏è'},
  {id:'energie',name:'Energie',color:'#f97316',icon:'‚ö°'},
  {id:'telecom',name:'Telecom',color:'#06b6d4',icon:'üì°'},
  {id:'onderhoud',name:'Onderhoud',color:'#eab308',icon:'üîß'},
  {id:'diversen',name:'Diversen',color:'#64748b',icon:'üìã'}
];

// Afdelingen worden gelezen uit Personeelbeheer (vb_departments) ‚Äî geen eigen lijst meer

const DEFAULT_REMINDER_SETTINGS={
  days:[30,60,90]
};

let activePage='dashboard';
let contractSearch='';
let relationSearch='';

// Data stores (localStorage backed, prefix cb_)
let contracts=[];
let contractTypes=[];
let relations=[];
let tasks=[];
let reminderSettings={};
let mutations=[]; // wijzigingslog

// ‚ïê‚ïê‚ïê CORE (data-helpers, autoSave, restore) ‚ïê‚ïê‚ïê

function uid(){return Date.now().toString(36)+'_'+Math.random().toString(36).substr(2,5);}

function autoSave(){
  try{
    localStorage.setItem('cb_contracts',JSON.stringify(contracts));
    localStorage.setItem('cb_contractTypes',JSON.stringify(contractTypes));
    localStorage.setItem('cb_relations',JSON.stringify(relations));
    localStorage.setItem('cb_tasks',JSON.stringify(tasks));
    localStorage.setItem('cb_reminderSettings',JSON.stringify(reminderSettings));
    localStorage.setItem('cb_mutations',JSON.stringify(mutations));
  }catch(e){console.error('autoSave error',e);}
}

function restore(){
  try{
    const c=localStorage.getItem('cb_contracts');if(c)contracts=JSON.parse(c);
    const ct=localStorage.getItem('cb_contractTypes');if(ct)contractTypes=JSON.parse(ct);
    const r=localStorage.getItem('cb_relations');if(r)relations=JSON.parse(r);
    const t=localStorage.getItem('cb_tasks');if(t)tasks=JSON.parse(t);
    const rs=localStorage.getItem('cb_reminderSettings');if(rs)Object.assign(reminderSettings,JSON.parse(rs));
    const m=localStorage.getItem('cb_mutations');if(m)mutations=JSON.parse(m);
  }catch(e){console.error('restore error',e);}
  // Defaults bij eerste gebruik
  if(!contractTypes.length)contractTypes=[...DEFAULT_CONTRACT_TYPES];
  if(!reminderSettings.days)reminderSettings={...DEFAULT_REMINDER_SETTINGS};
}

function resetData(){
  if(!confirm('Alle contractbeheer-data resetten naar standaardwaarden? Dit kan niet ongedaan worden.'))return;
  ['cb_contracts','cb_contractTypes','cb_relations','cb_tasks','cb_reminderSettings','cb_mutations'].forEach(k=>localStorage.removeItem(k));
  contracts=[];contractTypes=[];relations=[];tasks=[];mutations=[];
  reminderSettings={};
  restore();
  autoSave();
  showPage('dashboard');
  showToast('Data gereset naar standaardwaarden','success');
}

// Helpers
function getAvatarColor(name){let h=0;for(let i=0;i<name.length;i++)h=name.charCodeAt(i)+((h<<5)-h);return AVATARCOLORS[Math.abs(h)%AVATARCOLORS.length];}
function getInitials(name){return name.split(' ').filter(w=>w).map(w=>w[0]).join('').toUpperCase().substr(0,2);}
function formatDate(d){if(!d)return'-';return new Date(d).toLocaleDateString('nl-BE',{day:'2-digit',month:'2-digit',year:'numeric'});}
function formatCurrency(v){if(v===null||v===undefined||v==='')return'-';return new Intl.NumberFormat('nl-BE',{style:'currency',currency:'EUR'}).format(v);}
function daysUntil(dateStr){if(!dateStr)return Infinity;const d=new Date(dateStr);const now=new Date();now.setHours(0,0,0,0);d.setHours(0,0,0,0);return Math.ceil((d-now)/(1000*60*60*24));}

function formatPhone(val){
  if(!val)return'';
  let d=val.replace(/[^\d+]/g,'');
  if(d.startsWith('00'))d='+'+d.slice(2);
  if(d.startsWith('0')&&!d.startsWith('00'))d='+32'+d.slice(1);
  if(!d.startsWith('+'))d='+32'+d;
  const digits=d.replace(/\D/g,'');
  const local=digits.startsWith('32')?digits.slice(2):digits;
  if(local.length===9&&local.startsWith('4')){
    return`+32 ${local.slice(0,3)} ${local.slice(3,5)} ${local.slice(5,7)} ${local.slice(7,9)}`;
  }
  const zone1=['2','3','4','9'];
  if(local.length===8&&zone1.includes(local[0])){
    return`+32 ${local[0]} ${local.slice(1,4)} ${local.slice(4,6)} ${local.slice(6,8)}`;
  }
  if(local.length===8){
    return`+32 ${local.slice(0,2)} ${local.slice(2,4)} ${local.slice(4,6)} ${local.slice(6,8)}`;
  }
  let formatted='+32 ';const r=local.length>2?local.slice(2):local;
  for(let i=r.length;i>0;i-=2)formatted=r.slice(Math.max(0,i-2),i)+' '+formatted;
  return formatted.trim();
}

function addMutation(type,entity,entityId,description){
  mutations.unshift({id:uid(),type,entity,entityId,description,date:new Date().toISOString()});
  if(mutations.length>100)mutations=mutations.slice(0,100);
}

function getContractType(typeId){return contractTypes.find(t=>t.id===typeId)||{name:'Onbekend',color:'#64748b',icon:'üìã'};}
function getRelation(relId){return relations.find(r=>r.id===relId)||{name:'Onbekend'};}

// Cross-app koppelingen (read-only via localStorage)
function getDepartments(){
  try{const d=localStorage.getItem('vb_departments');if(d)return JSON.parse(d);}catch(e){}
  return [];
}
function getDepartment(deptId){
  if(!deptId)return{name:'-'};
  const deps=getDepartments();
  return deps.find(d=>d.id===deptId)||{name:deptId};
}
function getPeople(){
  try{const p=localStorage.getItem('vb_people');if(p)return JSON.parse(p).filter(x=>!x.archived);}catch(e){}
  return [];
}
function getPersonName(id){
  if(!id)return'-';
  const p=getPeople().find(x=>x.id===id);
  return p?(p.firstName||'')+' '+(p.lastName||''):'Onbekend';
}
function getVehicles(){
  try{const v=localStorage.getItem('fb_vehicles');if(v)return JSON.parse(v).filter(x=>x.status!=='gearchiveerd');}catch(e){}
  return [];
}
function getVehicleLabel(id){
  if(!id)return'-';
  const v=getVehicles().find(x=>x.id===id);
  return v?(v.brand+' '+v.model+' ('+v.plate+')'):'Onbekend voertuig';
}

function getContractStatus(contract){
  if(contract.status==='opgezegd')return{label:'Opgezegd',class:'badge-gray',dot:'status-opgezegd'};
  const days=daysUntil(contract.endDate);
  if(days<0)return{label:'Verlopen',class:'badge-red',dot:'status-verlopen'};
  if(days<=30)return{label:`Vervalt in ${days}d`,class:'badge-red',dot:'status-vervallend'};
  if(days<=60)return{label:`Vervalt in ${days}d`,class:'badge-yellow',dot:'status-vervallend'};
  if(days<=90)return{label:`Vervalt in ${days}d`,class:'badge-blue',dot:'status-vervallend'};
  return{label:'Actief',class:'badge-green',dot:'status-actief'};
}

// ‚ïê‚ïê‚ïê HUB / NAVIGATIE ‚ïê‚ïê‚ïê

function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast toast-'+type+' show';
  setTimeout(()=>t.classList.remove('show'),3000);
}

function showPage(page){
  closeModal();
  activePage=page;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  const el=document.getElementById('page-'+page);
  if(el)el.classList.add('active');
  document.querySelectorAll('.sb-item').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(b=>{
    if(b.onclick&&b.onclick.toString().includes("'"+page+"'"))b.classList.add('active');
  });
  if(page==='dashboard')renderDashboard();
  if(page==='contracts'){renderContracts();const b=document.getElementById('btn-new-contract');if(b)b.style.display=canCreate()?'':'none';}
  if(page==='tasks')renderTasks();
  if(page==='relations'){renderRelations();const b=document.getElementById('btn-new-relation');if(b)b.style.display=canCreate()?'':'none';}
  if(page==='settings')renderSettings();
}

function showPageFiltered(page,filterField,filterValue){
  closeModal();
  activePage=page;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  const panel=document.getElementById('page-'+page);
  if(panel)panel.classList.add('active');
  document.querySelectorAll('.sb-item').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(b=>{
    if(b.onclick&&b.onclick.toString().includes("'"+page+"'"))b.classList.add('active');
  });
  const el=document.getElementById(filterField);
  if(el)el.value=filterValue;
  if(page==='contracts')renderContracts();
  if(page==='tasks')renderTasks();
}

function showSettingsTab(tab,btn){
  document.querySelectorAll('.settings-panel').forEach(p=>p.style.display='none');
  const el=document.getElementById('settings-'+tab);
  if(el)el.style.display='block';
  btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  renderSettings();
}

function closeModal(){document.getElementById('modal-overlay').classList.remove('show');}

function openModal(title,html){
  document.getElementById('modal-title-text').textContent=title;
  document.getElementById('modal-title-actions').innerHTML='';
  document.getElementById('modal-body').innerHTML=html;
  document.getElementById('modal-overlay').classList.add('show');
  const firstInput=document.querySelector('#modal-body input,#modal-body select,#modal-body textarea');
  if(firstInput)setTimeout(()=>firstInput.focus(),100);
}

// Keyboard: Escape sluit modal, Enter submit, Ctrl+S opslaan
document.addEventListener('keydown',e=>{
  if(e.key==='Escape')closeModal();
  if(e.key==='s'&&(e.ctrlKey||e.metaKey)){e.preventDefault();autoSave();showToast('Data opgeslagen','success');}
  if(e.key==='Enter'&&!e.shiftKey){
    const overlay=document.getElementById('modal-overlay');
    if(overlay.classList.contains('show')){
      if(document.activeElement&&document.activeElement.tagName==='TEXTAREA')return;
      const saveBtn=overlay.querySelector('.btn-primary');
      if(saveBtn){e.preventDefault();saveBtn.click();}
    }
  }
});

// Filter helpers
function filterContracts(val){contractSearch=val.toLowerCase();renderContracts();}
function filterRelations(val){relationSearch=val.toLowerCase();renderRelations();}

// Badge updater
function updateTaskBadge(){
  const openTasks=getOpenTaskCount();
  const badge=document.getElementById('badge-tasks');
  if(openTasks>0){badge.style.display='';badge.textContent=openTasks;}
  else{badge.style.display='none';}
}

function getOpenTaskCount(){
  // Tel contracten met vervaldatum binnen reminder-dagen
  const days=reminderSettings.days||[30,60,90];
  const maxDays=Math.max(...days);
  return contracts.filter(c=>{
    if(c.status==='opgezegd')return false;
    const d=daysUntil(c.endDate);
    return d>=0&&d<=maxDays;
  }).length;
}

// ‚ïê‚ïê‚ïê RENDERING (placeholder ‚Äî wordt ingevuld in volgende blokken) ‚ïê‚ïê‚ïê

function renderDashboard(){
  const nonTerminated=contracts.filter(c=>c.status!=='opgezegd');
  const active=nonTerminated.filter(c=>daysUntil(c.endDate)>=0);
  const d30=nonTerminated.filter(c=>daysUntil(c.endDate)>=0&&daysUntil(c.endDate)<=30);
  const d60=nonTerminated.filter(c=>daysUntil(c.endDate)>=0&&daysUntil(c.endDate)<=60);
  const d90=nonTerminated.filter(c=>daysUntil(c.endDate)>=0&&daysUntil(c.endDate)<=90);
  const expired=nonTerminated.filter(c=>daysUntil(c.endDate)<0);
  const terminated=contracts.filter(c=>c.status==='opgezegd');
  const totalValue=active.reduce((s,c)=>s+(c.value||0),0);

  // Stat-kaarten rij 1
  document.getElementById('st-total').textContent=active.length;
  document.getElementById('st-30d').textContent=d30.length;
  document.getElementById('st-60d').textContent=d60.length;
  document.getElementById('st-90d').textContent=d90.length;

  // Stat-kaarten rij 2
  document.getElementById('st-value').textContent=formatCurrency(totalValue);
  document.getElementById('st-expired').textContent=expired.length;
  document.getElementById('st-terminated').textContent=terminated.length;
  document.getElementById('st-relations').textContent=relations.length;

  // Binnenkort vervallend (top 8)
  const expiring=[...nonTerminated].filter(c=>daysUntil(c.endDate)>=0&&daysUntil(c.endDate)<=90)
    .sort((a,b)=>daysUntil(a.endDate)-daysUntil(b.endDate)).slice(0,8);
  const expEl=document.getElementById('dash-expiring');
  if(!expiring.length){
    expEl.innerHTML='<span class="text-muted">Geen contracten die binnenkort vervallen</span>';
  }else{
    expEl.innerHTML=expiring.map(c=>{
      const type=getContractType(c.typeId);
      const st=getContractStatus(c);
      const rel=getRelation(c.relationId);
      const days=daysUntil(c.endDate);
      return`<div class="timeline-item" style="cursor:pointer" onclick="openContractDetail('${c.id}')">
        <div class="timeline-dot" style="background:${type.color}"></div>
        <div class="timeline-content">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="timeline-text" style="font-weight:600">${type.icon} ${c.name}</div>
            <span class="badge ${st.class}">${days}d</span>
          </div>
          <div class="timeline-date">${rel.name} ¬∑ ${formatDate(c.endDate)}${c.value?' ¬∑ '+formatCurrency(c.value):''}</div>
        </div>
      </div>`;
    }).join('');
  }

  // Verdeling per type
  const typesEl=document.getElementById('dash-types');
  const typeCounts={};
  active.forEach(c=>{typeCounts[c.typeId]=(typeCounts[c.typeId]||0)+1;});
  const typeEntries=Object.entries(typeCounts).sort((a,b)=>b[1]-a[1]);
  if(!typeEntries.length){
    typesEl.innerHTML='<span class="text-muted">Geen actieve contracten</span>';
  }else{
    const maxCount=Math.max(...typeEntries.map(e=>e[1]));
    typesEl.innerHTML=typeEntries.map(([tid,count])=>{
      const t=getContractType(tid);
      const pct=Math.round((count/maxCount)*100);
      return`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer" onclick="showPageFiltered('contracts','contract-type-filter','${tid}')">
        <span style="font-size:14px;width:20px;text-align:center">${t.icon}</span>
        <div style="flex:1;min-width:0">
          <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px">
            <span style="font-weight:600">${t.name}</span><span style="color:var(--text3)">${count}</span>
          </div>
          <div style="height:6px;background:var(--surface3);border-radius:3px;overflow:hidden">
            <div style="height:100%;width:${pct}%;background:${t.color};border-radius:3px"></div>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  // Opzegdeadlines
  const noticesEl=document.getElementById('dash-notices');
  const notices=[...nonTerminated].filter(c=>c.noticeDate&&daysUntil(c.noticeDate)<=60&&daysUntil(c.endDate)>=0)
    .sort((a,b)=>daysUntil(a.noticeDate)-daysUntil(b.noticeDate)).slice(0,6);
  if(!notices.length){
    noticesEl.innerHTML='<span class="text-muted">Geen naderende opzegdeadlines</span>';
  }else{
    noticesEl.innerHTML=notices.map(c=>{
      const dn=daysUntil(c.noticeDate);
      const type=getContractType(c.typeId);
      const icon=dn<=0?'üö®':dn<=14?'‚ö†Ô∏è':'üîî';
      const color=dn<=0?'var(--danger)':dn<=14?'var(--warn)':'var(--accent)';
      return`<div class="timeline-item" style="cursor:pointer" onclick="openContractDetail('${c.id}')">
        <div class="timeline-dot" style="background:${color}"></div>
        <div class="timeline-content">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="timeline-text" style="font-weight:600">${icon} ${c.name}</div>
            <span class="badge ${dn<=0?'badge-red':dn<=14?'badge-yellow':'badge-blue'}">${dn<=0?'Verstreken!':dn+'d'}</span>
          </div>
          <div class="timeline-date">${type.icon} Opzeggen v√≥√≥r ${formatDate(c.noticeDate)}</div>
        </div>
      </div>`;
    }).join('');
  }

  // Recente wijzigingen
  const recentEl=document.getElementById('dash-recent');
  const recent=mutations.slice(0,8);
  if(!recent.length){
    recentEl.innerHTML='<span class="text-muted">Geen recente wijzigingen</span>';
  }else{
    recentEl.innerHTML=recent.map(m=>{
      const icon=m.type==='create'?'üü¢':m.type==='update'?'üîµ':'üî¥';
      return`<div class="timeline-item">
        <div class="timeline-dot" style="background:var(--text3)"></div>
        <div class="timeline-content">
          <div class="timeline-date">${icon} ${new Date(m.date).toLocaleString('nl-BE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
          <div class="timeline-text">${m.description}</div>
        </div>
      </div>`;
    }).join('');
  }
}

function renderContracts(){
  // Vul filter-dropdowns
  const typeFilter=document.getElementById('contract-type-filter');
  const currentType=typeFilter.value;
  typeFilter.innerHTML='<option value="">Alle types</option>'+contractTypes.map(t=>
    `<option value="${t.id}" ${currentType===t.id?'selected':''}>${t.icon} ${t.name}</option>`).join('');

  const deptFilter=document.getElementById('contract-dept-filter');
  const currentDept=deptFilter.value;
  const deps=getDepartments();
  deptFilter.innerHTML='<option value="">Alle afdelingen</option>'+deps.map(d=>
    `<option value="${d.id}" ${currentDept===d.id?'selected':''}>${d.name}</option>`).join('');

  const statusFilter=document.getElementById('contract-status-filter').value;

  // Filter contracten
  let list=[...contracts];
  if(contractSearch){
    list=list.filter(c=>{
      const rel=getRelation(c.relationId);
      const type=getContractType(c.typeId);
      const hay=(c.name+' '+rel.name+' '+(c.reference||'')+' '+type.name).toLowerCase();
      return hay.includes(contractSearch);
    });
  }
  if(currentType)list=list.filter(c=>c.typeId===currentType);
  if(currentDept)list=list.filter(c=>c.departmentId===currentDept);
  if(statusFilter){
    list=list.filter(c=>{
      const days=daysUntil(c.endDate);
      if(statusFilter==='actief')return c.status!=='opgezegd'&&days>90;
      if(statusFilter==='vervallend30')return c.status!=='opgezegd'&&days>=0&&days<=30;
      if(statusFilter==='vervallend60')return c.status!=='opgezegd'&&days>=0&&days<=60;
      if(statusFilter==='vervallend90')return c.status!=='opgezegd'&&days>=0&&days<=90;
      if(statusFilter==='verlopen')return c.status!=='opgezegd'&&days<0;
      if(statusFilter==='opgezegd')return c.status==='opgezegd';
      return true;
    });
  }

  // Sorteer: meest dringend bovenaan
  list.sort((a,b)=>{
    if(a.status==='opgezegd'&&b.status!=='opgezegd')return 1;
    if(b.status==='opgezegd'&&a.status!=='opgezegd')return -1;
    return daysUntil(a.endDate)-daysUntil(b.endDate);
  });

  const el=document.getElementById('contracts-table');
  if(!list.length){
    el.innerHTML=contracts.length
      ?'<span class="text-muted">Geen contracten gevonden voor deze filters.</span>'
      :'<span class="text-muted">Geen contracten gevonden. Voeg een contract toe via de knop hierboven.</span>';
    return;
  }

  let html=`<table class="tbl"><thead><tr>
    <th>Type</th><th>Naam</th><th>Relatie</th><th>Afdeling</th><th>Startdatum</th><th>Einddatum</th><th>Waarde</th><th>Status</th><th style="width:80px"></th>
  </tr></thead><tbody>`;
  list.forEach(c=>{
    const type=getContractType(c.typeId);
    const rel=getRelation(c.relationId);
    const dept=getDepartment(c.departmentId);
    const st=getContractStatus(c);
    html+=`<tr style="cursor:pointer" onclick="openContractDetail('${c.id}')">
      <td><span class="clr-dot" style="background:${type.color}"></span> ${type.icon} ${type.name}</td>
      <td style="font-weight:600">${c.name}</td>
      <td>${rel.name}</td>
      <td>${dept.name}</td>
      <td>${formatDate(c.startDate)}</td>
      <td>${formatDate(c.endDate)}</td>
      <td>${formatCurrency(c.value)}</td>
      <td><span class="status-dot ${st.dot}"></span><span class="badge ${st.class}">${st.label}</span></td>
      <td style="text-align:right" onclick="event.stopPropagation()">
        ${canEdit()?`<button class="btn btn-icon btn-sm" onclick="openContractModal('${c.id}')" title="Bewerken">‚úèÔ∏è</button>`:''}
        ${canDelete()?`<button class="btn btn-icon btn-sm" onclick="deleteContract('${c.id}')" title="Verwijderen">üóë</button>`:''}
      </td></tr>`;
  });
  html+=`</tbody></table>
    ${canCreate()?`<button class="btn btn-dashed" style="margin-top:12px" onclick="openContractModal()">‚ûï Contract toevoegen</button>`:''}`;
  el.innerHTML=html;
}

let tasksTab='all';

function switchTasksTab(tab,btn){
  tasksTab=tab;
  btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  renderTasks();
}

function generateTasks(){
  // Genereer taken automatisch op basis van contracten en reminder-instellingen
  const items=[];
  const days=reminderSettings.days||[30,60,90];
  const maxDays=Math.max(...days);
  const nonTerminated=contracts.filter(c=>c.status!=='opgezegd');

  nonTerminated.forEach(c=>{
    const dEnd=daysUntil(c.endDate);
    const dNotice=c.noticeDate?daysUntil(c.noticeDate):null;
    const type=getContractType(c.typeId);
    const rel=getRelation(c.relationId);
    const isDone=tasks.find(t=>t.contractId===c.id&&t.done);

    // Verlopen contracten
    if(dEnd<0){
      items.push({contractId:c.id,category:'expired',priority:0,
        icon:'üö®',title:`Verlopen: ${c.name}`,
        subtitle:`${type.icon} ${rel.name} ¬∑ Verlopen op ${formatDate(c.endDate)}`,
        badgeClass:'badge-red',badgeText:`${Math.abs(dEnd)}d verlopen`,
        done:!!isDone,color:'var(--danger)'});
    }
    // Opzegdeadline verstreken
    if(dNotice!==null&&dNotice<=0&&dEnd>=0){
      items.push({contractId:c.id,category:'notice',priority:1,
        icon:'üö®',title:`Opzegdeadline verstreken: ${c.name}`,
        subtitle:`${type.icon} ${rel.name} ¬∑ Opzeggen was v√≥√≥r ${formatDate(c.noticeDate)}`,
        badgeClass:'badge-red',badgeText:'Verstreken!',
        done:!!isDone,color:'var(--danger)'});
    }
    // Opzegdeadline nadert
    if(dNotice!==null&&dNotice>0&&dNotice<=maxDays&&dEnd>=0){
      items.push({contractId:c.id,category:'notice',priority:2,
        icon:dNotice<=14?'‚ö†Ô∏è':'üîî',title:`Opzegdeadline: ${c.name}`,
        subtitle:`${type.icon} ${rel.name} ¬∑ Opzeggen v√≥√≥r ${formatDate(c.noticeDate)}`,
        badgeClass:dNotice<=14?'badge-yellow':'badge-blue',badgeText:`${dNotice}d`,
        done:!!isDone,color:dNotice<=14?'var(--warn)':'var(--accent)'});
    }
    // Contract vervalt binnenkort
    if(dEnd>=0&&dEnd<=maxDays){
      items.push({contractId:c.id,category:'expiring',priority:3,
        icon:dEnd<=30?'‚è∞':dEnd<=60?'üìÖ':'üìã',title:`Vervalt: ${c.name}`,
        subtitle:`${type.icon} ${rel.name} ¬∑ Einddatum ${formatDate(c.endDate)}${c.value?' ¬∑ '+formatCurrency(c.value):''}`,
        badgeClass:dEnd<=30?'badge-red':dEnd<=60?'badge-yellow':'badge-blue',badgeText:`${dEnd}d`,
        done:!!isDone,color:dEnd<=30?'var(--danger)':dEnd<=60?'var(--warn)':'var(--accent)'});
    }
  });

  items.sort((a,b)=>a.priority-b.priority||a.badgeText.localeCompare(b.badgeText));
  return items;
}

function renderTasks(){
  const el=document.getElementById('tasks-list');
  let items=generateTasks();

  // Filter op tab
  if(tasksTab==='expiring')items=items.filter(i=>i.category==='expiring');
  if(tasksTab==='notice')items=items.filter(i=>i.category==='notice');
  if(tasksTab==='expired')items=items.filter(i=>i.category==='expired');
  if(tasksTab==='done')items=items.filter(i=>i.done);
  if(tasksTab==='all')items=items.filter(i=>!i.done);

  if(!items.length){
    el.innerHTML=`<div style="text-align:center;padding:32px;color:var(--text3)">
      ${tasksTab==='done'?'‚úÖ Geen afgehandelde taken.':'üéâ Geen openstaande taken! Alle contracten zijn op orde.'}
    </div>`;
    updateTaskBadge();
    return;
  }

  let html=`<table class="tbl"><thead><tr>
    <th style="width:36px"></th><th>Taak</th><th>Details</th><th>Deadline</th><th style="width:80px"></th>
  </tr></thead><tbody>`;
  items.forEach(item=>{
    html+=`<tr style="${item.done?'opacity:.5':''}">
      <td><input type="checkbox" ${item.done?'checked':''} onchange="toggleTask('${item.contractId}',this.checked)" style="width:16px;height:16px;cursor:pointer"></td>
      <td style="font-weight:600;cursor:pointer" onclick="openContractDetail('${item.contractId}')">${item.icon} ${item.title}</td>
      <td style="font-size:12px;color:var(--text2)">${item.subtitle}</td>
      <td><span class="badge ${item.badgeClass}">${item.badgeText}</span></td>
      <td style="text-align:right">
        <button class="btn btn-icon btn-sm" onclick="openContractDetail('${item.contractId}')" title="Bekijken">üëÅ</button>
      </td></tr>`;
  });
  html+=`</tbody></table>`;
  el.innerHTML=html;
  updateTaskBadge();
}

function toggleTask(contractId,done){
  if(done){
    if(!tasks.find(t=>t.contractId===contractId))tasks.push({contractId,done:true,doneAt:new Date().toISOString()});
    else{const t=tasks.find(t=>t.contractId===contractId);if(t)t.done=true;t.doneAt=new Date().toISOString();}
  }else{
    tasks=tasks.filter(t=>t.contractId!==contractId);
  }
  autoSave();renderTasks();
}

function renderRelations(){
  const el=document.getElementById('relations-table');
  let list=[...relations];

  // Zoekfilter
  if(relationSearch){
    list=list.filter(r=>{
      const hay=(r.name+' '+r.contactPerson+' '+(r.email||'')+' '+(r.city||'')+' '+(r.type||'')).toLowerCase();
      return hay.includes(relationSearch);
    });
  }

  if(!list.length){
    el.innerHTML=relations.length
      ?'<span class="text-muted">Geen relaties gevonden voor deze zoekopdracht.</span>'
      :'<span class="text-muted">Geen relaties gevonden. Voeg een relatie toe via de knop hierboven.</span>';
    return;
  }

  let html=`<table class="tbl"><thead><tr>
    <th></th><th>Naam</th><th>Type</th><th>Contactpersoon</th><th>Telefoon</th><th>E-mail</th><th>Contracten</th><th style="width:80px"></th>
  </tr></thead><tbody>`;
  list.forEach(r=>{
    const count=contracts.filter(c=>c.relationId===r.id).length;
    const canDeleteRel=count===0;
    const color=getAvatarColor(r.name);
    const initials=getInitials(r.name);
    const typeBadge=relationTypeBadge(r.type);
    html+=`<tr>
      <td><div class="avatar" style="background:${color};width:30px;height:30px;font-size:11px">${initials}</div></td>
      <td style="font-weight:600;cursor:pointer" onclick="openRelationDetail('${r.id}')">${r.name}</td>
      <td>${typeBadge}</td>
      <td>${r.contactPerson||'-'}</td>
      <td>${r.phone?formatPhone(r.phone):'-'}</td>
      <td>${r.email||'-'}</td>
      <td>${count}</td>
      <td style="text-align:right">
        ${canEdit()?`<button class="btn btn-icon btn-sm" onclick="openRelationModal('${r.id}')" title="Bewerken">‚úèÔ∏è</button>`:''}
        ${canDeleteRel
          ?(canDelete()?`<button class="btn btn-icon btn-sm" onclick="deleteRelation('${r.id}')" title="Verwijderen">üóë</button>`:'')
          :`<span title="${count} contract(en) gekoppeld" style="cursor:help">üîí</span>`}
      </td></tr>`;
  });
  html+=`</tbody></table>
    ${canCreate()?`<button class="btn btn-dashed" style="margin-top:12px" onclick="openRelationModal()">‚ûï Relatie toevoegen</button>`:''}`;
  el.innerHTML=html;
}

function relationTypeBadge(type){
  const map={
    leverancier:{class:'badge-blue',label:'Leverancier'},
    klant:{class:'badge-green',label:'Klant'},
    overheid:{class:'badge-purple',label:'Overheid'},
    intern:{class:'badge-yellow',label:'Intern'},
    andere:{class:'badge-gray',label:'Andere'}
  };
  const m=map[type]||map.andere;
  return `<span class="badge ${m.class}">${m.label}</span>`;
}

function openRelationModal(editId){
  const r=editId?relations.find(x=>x.id===editId):null;
  const title=r?'Relatie bewerken':'Nieuwe relatie';
  const html=`
    <div class="form-row">
      <div class="form-group"><label class="form-label">Bedrijfsnaam <span class="req">*</span></label>
        <input class="form-input" id="rel-name" value="${r?r.name:''}" placeholder="bv. Proximus NV"></div>
      <div class="form-group"><label class="form-label">Type</label>
        <select class="form-input" id="rel-type">
          <option value="leverancier" ${r&&r.type==='leverancier'?'selected':''}>Leverancier</option>
          <option value="klant" ${r&&r.type==='klant'?'selected':''}>Klant</option>
          <option value="overheid" ${r&&r.type==='overheid'?'selected':''}>Overheid</option>
          <option value="intern" ${r&&r.type==='intern'?'selected':''}>Intern</option>
          <option value="andere" ${r&&r.type==='andere'?'selected':''}>Andere</option>
        </select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Contactpersoon</label>
        <input class="form-input" id="rel-contact" value="${r?r.contactPerson||'':''}" placeholder="Naam contactpersoon"></div>
      <div class="form-group"><label class="form-label">Functie</label>
        <input class="form-input" id="rel-function" value="${r?r.contactFunction||'':''}" placeholder="bv. Account Manager"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Telefoon</label>
        <input class="form-input" id="rel-phone" value="${r?r.phone||'':''}" placeholder="0467 70 90 49" onblur="this.value=formatPhone(this.value)"></div>
      <div class="form-group"><label class="form-label">E-mail</label>
        <input type="email" class="form-input" id="rel-email" value="${r?r.email||'':''}" placeholder="info@bedrijf.be"></div>
    </div>
    <div class="form-group"><label class="form-label">Adres</label>
      <input class="form-input" id="rel-address" value="${r?r.address||'':''}" placeholder="Straat + nummer"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Postcode</label>
        <input class="form-input" id="rel-zip" value="${r?r.zip||'':''}" placeholder="2000"></div>
      <div class="form-group"><label class="form-label">Stad</label>
        <input class="form-input" id="rel-city" value="${r?r.city||'':''}" placeholder="Antwerpen"></div>
    </div>
    <div class="form-group"><label class="form-label">BTW-nummer</label>
      <input class="form-input" id="rel-vat" value="${r?r.vat||'':''}" placeholder="BE 0123.456.789"></div>
    <div class="form-group"><label class="form-label">Opmerkingen</label>
      <textarea class="form-input" id="rel-notes" rows="3" placeholder="Interne opmerkingen...">${r?r.notes||'':''}</textarea></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveRelation('${editId||''}')">Opslaan</button>
    </div>`;
  openModal(title,html);
}

function saveRelation(editId){
  const name=document.getElementById('rel-name').value.trim();
  if(!name){showToast('Bedrijfsnaam is verplicht','error');return;}
  const data={
    name,
    type:document.getElementById('rel-type').value,
    contactPerson:document.getElementById('rel-contact').value.trim(),
    contactFunction:document.getElementById('rel-function').value.trim(),
    phone:document.getElementById('rel-phone').value.trim(),
    email:document.getElementById('rel-email').value.trim(),
    address:document.getElementById('rel-address').value.trim(),
    zip:document.getElementById('rel-zip').value.trim(),
    city:document.getElementById('rel-city').value.trim(),
    vat:document.getElementById('rel-vat').value.trim(),
    notes:document.getElementById('rel-notes').value.trim()
  };
  if(editId){
    const r=relations.find(x=>x.id===editId);
    if(r)Object.assign(r,data);
    addMutation('update','relatie',editId,`Relatie "${name}" bijgewerkt`);
    showToast('Relatie bijgewerkt');
  }else{
    const id=uid();
    relations.push({id,...data,createdAt:new Date().toISOString()});
    addMutation('create','relatie',id,`Relatie "${name}" aangemaakt`);
    showToast('Relatie aangemaakt');
  }
  autoSave();closeModal();renderRelations();
}

function deleteRelation(id){
  const r=relations.find(x=>x.id===id);
  if(!r)return;
  const count=contracts.filter(c=>c.relationId===id).length;
  if(count>0){showToast(`Kan niet verwijderen: ${count} contract(en) gekoppeld`,'error');return;}
  if(!confirm(`Relatie "${r.name}" verwijderen?`))return;
  relations=relations.filter(x=>x.id!==id);
  addMutation('delete','relatie',id,`Relatie "${r.name}" verwijderd`);
  autoSave();renderRelations();
  showToast('Relatie verwijderd');
}

function openRelationDetail(id){
  const r=relations.find(x=>x.id===id);
  if(!r)return;
  const typeBadge=relationTypeBadge(r.type);
  const linkedContracts=contracts.filter(c=>c.relationId===id);
  let contractsHtml='<span class="text-muted">Geen gekoppelde contracten</span>';
  if(linkedContracts.length){
    contractsHtml=`<table class="tbl"><thead><tr><th>Naam</th><th>Type</th><th>Einddatum</th><th>Status</th></tr></thead><tbody>`;
    linkedContracts.forEach(c=>{
      const type=getContractType(c.typeId);
      const st=getContractStatus(c);
      contractsHtml+=`<tr>
        <td style="font-weight:600">${type.icon} ${c.name}</td>
        <td><span class="clr-dot" style="background:${type.color}"></span> ${type.name}</td>
        <td>${formatDate(c.endDate)}</td>
        <td><span class="badge ${st.class}">${st.label}</span></td>
      </tr>`;
    });
    contractsHtml+=`</tbody></table>`;
  }

  const html=`
    <div class="modal-top-actions">
      <div></div>
      <button class="btn btn-sm" onclick="openRelationModal('${r.id}')">‚úèÔ∏è Bewerken</button>
    </div>
    <div class="card-grid card-grid-2" style="margin-bottom:20px">
      <div>
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">Bedrijfsgegevens</div>
        <div style="font-size:14px;font-weight:700;margin-bottom:4px">${r.name}</div>
        <div style="margin-bottom:4px">${typeBadge}</div>
        ${r.vat?`<div style="font-size:13px;color:var(--text2);margin-bottom:2px">BTW: ${r.vat}</div>`:''}
        ${r.address?`<div style="font-size:13px;color:var(--text2)">${r.address}${r.zip||r.city?', '+[r.zip,r.city].filter(Boolean).join(' '):''}</div>`:''}
      </div>
      <div>
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">Contactgegevens</div>
        ${r.contactPerson?`<div style="font-size:13px;margin-bottom:2px"><strong>${r.contactPerson}</strong>${r.contactFunction?' ‚Äî '+r.contactFunction:''}</div>`:''}
        ${r.phone?`<div style="font-size:13px;color:var(--text2);margin-bottom:2px">üìû ${formatPhone(r.phone)}</div>`:''}
        ${r.email?`<div style="font-size:13px;color:var(--text2)">‚úâÔ∏è ${r.email}</div>`:''}
        ${!r.contactPerson&&!r.phone&&!r.email?'<span class="text-muted">Geen contactgegevens</span>':''}
      </div>
    </div>
    ${r.notes?`<div class="card" style="margin-bottom:20px;background:var(--surface2)"><div class="card-title">üí¨ Opmerkingen</div><div style="font-size:13px;white-space:pre-line">${r.notes}</div></div>`:''}
    <div class="card-title">üìÑ Gekoppelde contracten (${linkedContracts.length})</div>
    ${contractsHtml}`;
  openModal(r.name,html);
}

function renderSettings(){
  renderSettingsTypes();
  renderSettingsDepartments();
  renderSettingsReminders();
}

// ‚îÄ‚îÄ Contracttypes ‚îÄ‚îÄ

function renderSettingsTypes(){
  const el=document.getElementById('settings-types');
  let html=`<div class="card"><div class="card-title">üìã Contracttypes
    ${canCreate()?`<button class="btn btn-primary-outline btn-sm" style="margin-left:auto" onclick="openTypeModal()">‚ûï Type toevoegen</button>`:''}</div>
    <table class="tbl"><thead><tr><th>Kleur</th><th>Icoon</th><th>Naam</th><th>Contracten</th>${canEdit()?'<th style="width:80px"></th>':''}</tr></thead><tbody>`;
  contractTypes.forEach(t=>{
    const count=contracts.filter(c=>c.typeId===t.id).length;
    const canDeleteType=count===0;
    html+=`<tr>
      <td><span class="clr-dot" style="background:${t.color}"></span></td>
      <td>${t.icon}</td>
      <td style="font-weight:600">${t.name}</td>
      <td>${count}</td>
      ${canEdit()?`<td style="text-align:right">
        <button class="btn btn-icon btn-sm" onclick="openTypeModal('${t.id}')" title="Bewerken">‚úèÔ∏è</button>
        ${canDeleteType
          ?(canDelete()?`<button class="btn btn-icon btn-sm" onclick="deleteType('${t.id}')" title="Verwijderen">üóë</button>`:'')
          :`<span title="${count} contract(en) gekoppeld" style="cursor:help">üîí</span>`}
      </td>`:''}
    </tr>`;
  });
  html+=`</tbody></table>
    ${canCreate()?`<button class="btn btn-dashed" style="margin-top:12px" onclick="openTypeModal()">‚ûï Type toevoegen</button>`:''}</div>`;
  el.innerHTML=html;
}

function openTypeModal(editId){
  const t=editId?contractTypes.find(x=>x.id===editId):null;
  const title=t?'Contracttype bewerken':'Nieuw contracttype';
  const html=`
    <div class="form-group"><label class="form-label">Naam <span class="req">*</span></label>
      <input class="form-input" id="type-name" value="${t?t.name:''}" placeholder="bv. Leasing"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Icoon</label>
        <input class="form-input" id="type-icon" value="${t?t.icon:'üìã'}" placeholder="Emoji"></div>
      <div class="form-group"><label class="form-label">Kleur</label>
        <input type="color" class="form-input" id="type-color" value="${t?t.color:'#3b82f6'}" style="height:38px;padding:4px"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveType('${editId||''}')">Opslaan</button>
    </div>`;
  openModal(title,html);
}

function saveType(editId){
  const name=document.getElementById('type-name').value.trim();
  if(!name){showToast('Naam is verplicht','error');return;}
  const icon=document.getElementById('type-icon').value.trim()||'üìã';
  const color=document.getElementById('type-color').value;
  if(editId){
    const t=contractTypes.find(x=>x.id===editId);
    if(t){t.name=name;t.icon=icon;t.color=color;}
    addMutation('update','contracttype',editId,`Contracttype "${name}" bijgewerkt`);
    showToast('Contracttype bijgewerkt');
  }else{
    const id=uid();
    contractTypes.push({id,name,icon,color});
    addMutation('create','contracttype',id,`Contracttype "${name}" aangemaakt`);
    showToast('Contracttype aangemaakt');
  }
  autoSave();closeModal();renderSettings();
}

function deleteType(id){
  const t=contractTypes.find(x=>x.id===id);
  if(!t)return;
  const count=contracts.filter(c=>c.typeId===id).length;
  if(count>0){showToast(`Kan niet verwijderen: ${count} contract(en) gekoppeld`,'error');return;}
  if(!confirm(`Contracttype "${t.name}" verwijderen?`))return;
  contractTypes=contractTypes.filter(x=>x.id!==id);
  addMutation('delete','contracttype',id,`Contracttype "${t.name}" verwijderd`);
  autoSave();renderSettings();
  showToast('Contracttype verwijderd');
}

// ‚îÄ‚îÄ Afdelingen (read-only uit Personeelbeheer) ‚îÄ‚îÄ

function renderSettingsDepartments(){
  const el=document.getElementById('settings-departments');
  const deps=getDepartments();
  if(!deps.length){
    el.innerHTML=`<div class="card" style="text-align:center;padding:40px">
      <div style="font-size:32px;margin-bottom:8px">‚ö†Ô∏è</div>
      <div style="font-size:14px;color:var(--text3);margin-bottom:4px">Geen afdelingen gevonden</div>
      <div style="font-size:12px;color:var(--text3)">Open eerst de <strong>Personeelbeheer</strong>-app en voeg afdelingen toe.<br>Afdelingen worden daar centraal beheerd en hier automatisch overgenomen.</div>
    </div>`;
    return;
  }
  let html=`<div class="card"><div class="card-title">üè¨ Afdelingen <span class="badge badge-blue" style="margin-left:8px">uit Personeelbeheer</span></div>
    <p style="font-size:12px;color:var(--text3);margin-bottom:12px">Afdelingen worden centraal beheerd in de Personeelbeheer-app. Wijzigingen daar worden hier automatisch zichtbaar.</p>
    <table class="tbl"><thead><tr><th>Naam</th><th>Contracten gekoppeld</th></tr></thead><tbody>`;
  deps.forEach(d=>{
    const count=contracts.filter(c=>c.departmentId===d.id).length;
    html+=`<tr>
      <td style="font-weight:600">${d.name}</td>
      <td>${count}</td>
    </tr>`;
  });
  html+=`</tbody></table></div>`;
  el.innerHTML=html;
}

// ‚îÄ‚îÄ Reminder-instellingen ‚îÄ‚îÄ

function renderSettingsReminders(){
  const el=document.getElementById('settings-reminders');
  const days=reminderSettings.days||[30,60,90];
  let html=`<div class="card"><div class="card-title">‚è∞ Reminder-instellingen</div>
    <p style="font-size:13px;color:var(--text2);margin-bottom:16px">
      Configureer op hoeveel dagen v√≥√≥r de einddatum van een contract een herinnering moet verschijnen.
      Reminders worden getoond op het dashboard en in de takenpagina.
    </p>
    <div id="reminder-days-list">`;
  days.forEach((d,i)=>{
    html+=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
      <input type="number" class="form-input reminder-day-input" value="${d}" min="1" max="365" style="width:100px">
      <span style="font-size:13px;color:var(--text2)">dagen v√≥√≥r einddatum</span>
      <button class="btn btn-icon btn-sm" onclick="removeReminderDay(${i})" title="Verwijderen">üóë</button>
    </div>`;
  });
  html+=`</div>
    <button class="btn btn-dashed" style="margin-top:4px;margin-bottom:16px" onclick="addReminderDay()">‚ûï Reminder toevoegen</button>
    <div class="modal-actions" style="margin-top:0">
      <button class="btn btn-primary" onclick="saveReminderSettings()">Opslaan</button>
    </div></div>`;
  el.innerHTML=html;
}

function addReminderDay(){
  reminderSettings.days=reminderSettings.days||[];
  reminderSettings.days.push(30);
  autoSave();renderSettingsReminders();
}

function removeReminderDay(index){
  if(reminderSettings.days.length<=1){showToast('Minimaal √©√©n reminder vereist','error');return;}
  reminderSettings.days.splice(index,1);
  autoSave();renderSettingsReminders();
}

function saveReminderSettings(){
  const inputs=document.querySelectorAll('.reminder-day-input');
  const days=[];
  let valid=true;
  inputs.forEach(inp=>{
    const v=parseInt(inp.value);
    if(isNaN(v)||v<1||v>365){valid=false;return;}
    days.push(v);
  });
  if(!valid){showToast('Ongeldige waarde (1-365 dagen)','error');return;}
  days.sort((a,b)=>a-b);
  reminderSettings.days=days;
  addMutation('update','settings','reminders',`Reminder-instellingen bijgewerkt: ${days.join(', ')} dagen`);
  autoSave();updateTaskBadge();renderSettingsReminders();
  showToast('Reminder-instellingen opgeslagen');
}

// ‚ïê‚ïê‚ïê CONTRACT CRUD & DETAIL (Blok 4) ‚ïê‚ïê‚ïê

function openContractModal(editId){
  const c=editId?contracts.find(x=>x.id===editId):null;
  const title=c?'Contract bewerken':'Nieuw contract';

  const typeOpts=contractTypes.map(t=>
    `<option value="${t.id}" ${c&&c.typeId===t.id?'selected':''}>${t.icon} ${t.name}</option>`).join('');
  const relOpts=`<option value="">‚Äî Selecteer relatie ‚Äî</option>`+relations.map(r=>
    `<option value="${r.id}" ${c&&c.relationId===r.id?'selected':''}>${r.name}</option>`).join('');

  // Afdelingen uit Personeelbeheer
  const deps=getDepartments();
  const deptOpts=deps.length
    ?`<option value="">‚Äî Selecteer afdeling ‚Äî</option>`+deps.map(d=>
      `<option value="${d.id}" ${c&&c.departmentId===d.id?'selected':''}>${d.name}</option>`).join('')
    :`<option value="">‚ö†Ô∏è Open eerst Personeelbeheer</option>`;

  // Verantwoordelijke uit Personeelbeheer
  const people=getPeople();
  const personOpts=people.length
    ?`<option value="">‚Äî Geen verantwoordelijke ‚Äî</option>`+people.map(p=>
      `<option value="${p.id}" ${c&&c.responsiblePersonId===p.id?'selected':''}>${(p.firstName||'')+' '+(p.lastName||'')}</option>`).join('')
    :`<option value="">‚ö†Ô∏è Open eerst Personeelbeheer</option>`;

  // Voertuigen uit Fleetbeheer (relevant bij mobiliteit/verzekering)
  const vehicles=getVehicles();
  const vehicleOpts=vehicles.length
    ?`<option value="">‚Äî Geen voertuig ‚Äî</option>`+vehicles.map(v=>
      `<option value="${v.id}" ${c&&c.vehicleId===v.id?'selected':''}>${v.brand} ${v.model} (${v.plate})</option>`).join('')
    :`<option value="">‚ö†Ô∏è Open eerst Fleetbeheer</option>`;

  const statusOpts=['actief','opgezegd'].map(s=>
    `<option value="${s}" ${c&&c.status===s?'selected':''}>${s.charAt(0).toUpperCase()+s.slice(1)}</option>`).join('');

  const html=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0 24px">
      <div class="form-group"><label class="form-label">Contractnaam <span class="req">*</span></label>
        <input class="form-input" id="ct-name" value="${c?c.name:''}" placeholder="bv. Huurovereenkomst kantoor Deurne"></div>
      <div class="form-group"><label class="form-label">Relatie <span class="req">*</span></label>
        <select class="form-input" id="ct-relation">${relOpts}</select></div>
      <div class="form-group"><label class="form-label">Contracttype <span class="req">*</span></label>
        <select class="form-input" id="ct-type">${typeOpts}</select></div>
      <div class="form-group"><label class="form-label">Afdeling</label>
        <select class="form-input" id="ct-dept">${deptOpts}</select></div>
      <div class="form-group"><label class="form-label">Verantwoordelijke</label>
        <select class="form-input" id="ct-person">${personOpts}</select></div>
      <div class="form-group"><label class="form-label">Gekoppeld voertuig</label>
        <select class="form-input" id="ct-vehicle">${vehicleOpts}</select></div>
      <div class="form-group"><label class="form-label">Startdatum <span class="req">*</span></label>
        <input type="date" class="form-input" id="ct-start" value="${c?c.startDate:''}"></div>
      <div class="form-group"><label class="form-label">Einddatum <span class="req">*</span></label>
        <input type="date" class="form-input" id="ct-end" value="${c?c.endDate:''}" onchange="calcOpzegDatum()"></div>
      <div class="form-group"><label class="form-label">Opzegtermijn (maanden)</label>
        <input type="number" class="form-input" id="ct-opzeg" value="${c?c.noticePeriod||'':''}" min="0" placeholder="bv. 3" onchange="calcOpzegDatum()"></div>
      <div class="form-group"><label class="form-label">Opzegdatum <span style="font-weight:400;color:var(--text3)">(berekend)</span></label>
        <input type="date" class="form-input" id="ct-opzeg-date" value="${c?c.noticeDate||'':''}" style="background:var(--surface2)"></div>
      <div class="form-group"><label class="form-label">Contractwaarde (‚Ç¨)</label>
        <input type="number" class="form-input" id="ct-value" value="${c?c.value||'':''}" min="0" step="0.01" placeholder="bv. 12000"></div>
      <div class="form-group"><label class="form-label">Status</label>
        <select class="form-input" id="ct-status">${statusOpts}</select></div>
      <div class="form-group" style="grid-column:1/-1"><label class="form-label">Referentie / Kenmerk</label>
        <input class="form-input" id="ct-ref" value="${c?c.reference||'':''}" placeholder="bv. Polisnummer, dossiernummer..."></div>
      <div class="form-group" style="grid-column:1/-1"><label class="form-label">Opmerkingen</label>
        <textarea class="form-input" id="ct-notes" rows="3" placeholder="Interne opmerkingen...">${c?c.notes||'':''}</textarea></div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveContract('${editId||''}')">Opslaan</button>
    </div>`;
  openModal(title,html);
  calcOpzegDatum();
}

function calcOpzegDatum(){
  const endVal=document.getElementById('ct-end').value;
  const months=parseInt(document.getElementById('ct-opzeg').value);
  const dateEl=document.getElementById('ct-opzeg-date');
  if(endVal&&months>0){
    const d=new Date(endVal);
    d.setMonth(d.getMonth()-months);
    dateEl.value=d.toISOString().split('T')[0];
  }else{
    dateEl.value='';
  }
}

function saveContract(editId){
  const name=document.getElementById('ct-name').value.trim();
  const relationId=document.getElementById('ct-relation').value;
  const typeId=document.getElementById('ct-type').value;
  const startDate=document.getElementById('ct-start').value;
  const endDate=document.getElementById('ct-end').value;

  if(!name){showToast('Contractnaam is verplicht','error');return;}
  if(!relationId){showToast('Selecteer een relatie','error');return;}
  if(!typeId){showToast('Selecteer een contracttype','error');return;}
  if(!startDate){showToast('Startdatum is verplicht','error');return;}
  if(!endDate){showToast('Einddatum is verplicht','error');return;}
  if(endDate<startDate){showToast('Einddatum moet na startdatum liggen','error');return;}

  const data={
    name,relationId,typeId,
    departmentId:document.getElementById('ct-dept').value,
    responsiblePersonId:document.getElementById('ct-person').value||null,
    vehicleId:document.getElementById('ct-vehicle').value||null,
    startDate,endDate,
    noticePeriod:parseInt(document.getElementById('ct-opzeg').value)||0,
    noticeDate:document.getElementById('ct-opzeg-date').value,
    value:parseFloat(document.getElementById('ct-value').value)||null,
    status:document.getElementById('ct-status').value,
    reference:document.getElementById('ct-ref').value.trim(),
    notes:document.getElementById('ct-notes').value.trim()
  };

  if(editId){
    const c=contracts.find(x=>x.id===editId);
    if(c)Object.assign(c,data,{updatedAt:new Date().toISOString()});
    addMutation('update','contract',editId,`Contract "${name}" bijgewerkt`);
    showToast('Contract bijgewerkt');
  }else{
    const id=uid();
    contracts.push({id,...data,files:[],comments:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});
    addMutation('create','contract',id,`Contract "${name}" aangemaakt`);
    showToast('Contract aangemaakt');
  }
  autoSave();closeModal();renderContracts();updateTaskBadge();renderDashboard();
}

function deleteContract(id){
  const c=contracts.find(x=>x.id===id);
  if(!c)return;
  if(!confirm(`Contract "${c.name}" verwijderen? Dit kan niet ongedaan worden.`))return;
  contracts=contracts.filter(x=>x.id!==id);
  addMutation('delete','contract',id,`Contract "${c.name}" verwijderd`);
  autoSave();renderContracts();updateTaskBadge();renderDashboard();
  showToast('Contract verwijderd');
}

function openContractDetail(id){
  const c=contracts.find(x=>x.id===id);
  if(!c)return;
  const type=getContractType(c.typeId);
  const rel=getRelation(c.relationId);
  const dept=getDepartment(c.departmentId);
  const st=getContractStatus(c);
  const daysLeft=daysUntil(c.endDate);
  const daysNotice=c.noticeDate?daysUntil(c.noticeDate):null;

  // Opzegtermijn-indicator
  let noticeHtml='';
  if(c.noticeDate&&c.status!=='opgezegd'){
    if(daysNotice!==null&&daysNotice<=0){
      noticeHtml=`<div style="background:var(--danger-bg);border:1px solid var(--danger-border);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:16px;font-size:13px">
        üö® <strong>Opzegdatum verstreken!</strong> De opzegdatum was ${formatDate(c.noticeDate)}. Neem onmiddellijk actie.</div>`;
    }else if(daysNotice!==null&&daysNotice<=30){
      noticeHtml=`<div style="background:var(--warn-bg);border:1px solid rgba(245,158,11,.2);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:16px;font-size:13px">
        ‚ö†Ô∏è <strong>Opzegdeadline nadert!</strong> Nog ${daysNotice} dagen om op te zeggen (v√≥√≥r ${formatDate(c.noticeDate)}).</div>`;
    }
  }

  // Looptijd voortgangsbalk
  const startMs=new Date(c.startDate).getTime();
  const endMs=new Date(c.endDate).getTime();
  const nowMs=Date.now();
  const totalDays=Math.max(1,Math.round((endMs-startMs)/(1000*60*60*24)));
  const elapsedDays=Math.round((nowMs-startMs)/(1000*60*60*24));
  const pct=Math.min(100,Math.max(0,Math.round((elapsedDays/totalDays)*100)));
  const barColor=pct>=90?'var(--danger)':pct>=75?'var(--warn)':'var(--accent)';
  const progressHtml=`<div style="margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3);font-weight:600;margin-bottom:4px">
      <span>${formatDate(c.startDate)}</span><span>${pct}% verlopen ¬∑ ${daysLeft>0?daysLeft+'d resterend':'Verlopen'}</span><span>${formatDate(c.endDate)}</span>
    </div>
    <div style="height:8px;background:var(--surface3);border-radius:4px;overflow:hidden">
      <div style="height:100%;width:${pct}%;background:${barColor};border-radius:4px;transition:width .3s"></div>
    </div>
    ${c.noticeDate?`<div style="position:relative;height:12px;margin-top:-2px"><div style="position:absolute;left:${Math.min(100,Math.max(0,Math.round(((new Date(c.noticeDate).getTime()-startMs)/(endMs-startMs))*100)))}%;transform:translateX(-50%);font-size:10px;color:var(--warn)" title="Opzegdatum: ${formatDate(c.noticeDate)}">‚ñ≤</div></div>`:''}
  </div>`;

  // Versie-historiek (uit mutations log)
  const history=mutations.filter(m=>m.entityId===id).slice(0,20);

  const html=`
    <div class="modal-top-actions">
      <div style="display:flex;gap:8px">
        ${canEdit()?(c.status!=='opgezegd'?`<button class="btn btn-sm btn-danger" onclick="terminateContract('${c.id}')">‚ùå Opzeggen</button>`:
        `<button class="btn btn-sm" onclick="reactivateContract('${c.id}')">üîÑ Heractiveren</button>`):''}
      </div>
      ${canEdit()?`<button class="btn btn-sm" onclick="openContractModal('${c.id}')">‚úèÔ∏è Bewerken</button>`:''}
    </div>
    ${noticeHtml}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:16px">
      <div class="card" style="padding:16px">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:10px">Contractgegevens</div>
        <div style="font-size:16px;font-weight:700;margin-bottom:6px">${type.icon} ${c.name}</div>
        <div style="font-size:13px;margin-bottom:4px"><span class="clr-dot" style="background:${type.color}"></span> ${type.name} ¬∑ ${dept.name}</div>
        <div style="font-size:13px;margin-bottom:4px"><span class="status-dot ${st.dot}"></span><span class="badge ${st.class}">${st.label}</span></div>
        ${c.responsiblePersonId?`<div style="font-size:12px;color:var(--text2);margin-top:6px">üë§ ${getPersonName(c.responsiblePersonId)}</div>`:''}
        ${c.vehicleId?`<div style="font-size:12px;color:var(--text2);margin-top:4px">üöó ${getVehicleLabel(c.vehicleId)}</div>`:''}
        ${c.reference?`<div style="font-size:12px;color:var(--text2);margin-top:4px">üìå ${c.reference}</div>`:''}
        <div style="font-size:11px;color:var(--text3);margin-top:8px">Aangemaakt: ${formatDate(c.createdAt)} ¬∑ Laatst gewijzigd: ${formatDate(c.updatedAt)}</div>
      </div>
      <div class="card" style="padding:16px">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:10px">Relatie & Financieel</div>
        <div style="font-size:14px;font-weight:600;margin-bottom:4px;cursor:pointer;color:var(--accent)" onclick="openRelationDetail('${rel.id||''}')">üè¢ ${rel.name}</div>
        ${c.value?`<div style="font-size:22px;font-weight:700;color:var(--accent);margin-top:8px">${formatCurrency(c.value)}</div>
          <div style="font-size:11px;color:var(--text3)">${totalDays>0?formatCurrency(c.value/12)+' /maand':''}${c.value&&totalDays>0?' ¬∑ '+formatCurrency(c.value/totalDays*30.44)+' /maand (pro rata)':''}</div>`:''}
      </div>
    </div>
    ${progressHtml}
    <div class="card-grid card-grid-4" style="margin-bottom:20px">
      <div class="card" style="padding:12px;text-align:center">
        <div style="font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;margin-bottom:4px">Startdatum</div>
        <div style="font-size:14px;font-weight:700">${formatDate(c.startDate)}</div>
      </div>
      <div class="card" style="padding:12px;text-align:center">
        <div style="font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;margin-bottom:4px">Einddatum</div>
        <div style="font-size:14px;font-weight:700;color:${daysLeft<=30?'var(--danger)':daysLeft<=60?'var(--warn)':'inherit'}">${formatDate(c.endDate)}</div>
      </div>
      <div class="card" style="padding:12px;text-align:center">
        <div style="font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;margin-bottom:4px">Opzegtermijn</div>
        <div style="font-size:14px;font-weight:700">${c.noticePeriod?c.noticePeriod+' mnd':'-'}</div>
      </div>
      <div class="card" style="padding:12px;text-align:center">
        <div style="font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;margin-bottom:4px">Opzegdatum</div>
        <div style="font-size:14px;font-weight:700;color:${daysNotice!==null&&daysNotice<=30?'var(--danger)':'inherit'}">${c.noticeDate?formatDate(c.noticeDate):'-'}</div>
      </div>
    </div>
    ${c.notes?`<div class="card" style="margin-bottom:20px;background:var(--surface2);padding:16px"><div style="font-size:12px;font-weight:600;color:var(--text3);margin-bottom:6px">üìù Opmerkingen</div><div style="font-size:13px;white-space:pre-line">${c.notes}</div></div>`:''}
    <div class="tabs" id="detail-tabs">
      <button class="tab active" onclick="switchDetailTab('files',this)">üìé Bestanden (${(c.files||[]).length})</button>
      <button class="tab" onclick="switchDetailTab('comments',this)">üí¨ Opmerkingen (${(c.comments||[]).length})</button>
      <button class="tab" onclick="switchDetailTab('history',this)">üïê Wijzigingslog (${history.length})</button>
    </div>
    <div id="detail-tab-files">${renderDetailFiles(c)}</div>
    <div id="detail-tab-comments" style="display:none">${renderDetailComments(c)}</div>
    <div id="detail-tab-history" style="display:none">${renderDetailHistory(history)}</div>`;
  openModal(c.name,html);
}

function switchDetailTab(tab,btn){
  ['files','comments','history'].forEach(t=>{
    const el=document.getElementById('detail-tab-'+t);
    if(el)el.style.display=t===tab?'block':'none';
  });
  btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
}

function renderDetailFiles(c){
  const files=c.files||[];
  let html=`<div style="display:flex;justify-content:flex-end;margin-bottom:12px">
    <button class="btn btn-sm btn-primary-outline" onclick="addContractFile('${c.id}')">‚ûï Bestand registreren</button></div>`;
  if(files.length){
    html+=`<table class="tbl"><thead><tr><th>üìé Naam</th><th>Type</th><th>Uploaddatum</th><th style="width:40px"></th></tr></thead><tbody>`;
    files.forEach((f,i)=>{
      html+=`<tr><td style="font-weight:500">${f.name}</td><td><span class="badge badge-gray">${f.fileType||'-'}</span></td><td>${formatDate(f.uploadDate)}</td>
        <td><button class="btn btn-icon btn-sm" onclick="removeContractFile('${c.id}',${i})" title="Verwijderen">üóë</button></td></tr>`;
    });
    html+=`</tbody></table>`;
  }else{
    html+=`<div style="text-align:center;padding:24px;color:var(--text3)">üìé Nog geen bestanden geregistreerd.<br><span style="font-size:12px">Klik op "‚ûï Bestand registreren" om een bestandsverwijzing toe te voegen.</span></div>`;
  }
  return html;
}

function renderDetailComments(c){
  const comments=c.comments||[];
  let html=`<div style="display:flex;justify-content:flex-end;margin-bottom:12px">
    <button class="btn btn-sm btn-primary-outline" onclick="addContractComment('${c.id}')">‚ûï Opmerking</button></div>`;
  if(comments.length){
    html+=comments.map(cm=>{
      const icon=cm.type==='status'?'‚ö°':'üí¨';
      const dotColor=cm.type==='status'?'var(--warn)':'var(--accent)';
      return`<div class="timeline-item">
        <div class="timeline-dot" style="background:${dotColor}"></div>
        <div class="timeline-content">
          <div class="timeline-date">${icon} ${new Date(cm.date).toLocaleString('nl-BE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
          <div class="timeline-text">${cm.text}</div>
        </div></div>`;
    }).join('');
  }else{
    html+=`<div style="text-align:center;padding:24px;color:var(--text3)">üí¨ Nog geen opmerkingen.<br><span style="font-size:12px">Voeg een opmerking toe om de contracthistoriek bij te houden.</span></div>`;
  }
  return html;
}

function renderDetailHistory(history){
  if(!history.length)return`<div style="text-align:center;padding:24px;color:var(--text3)">üïê Geen wijzigingsgeschiedenis beschikbaar.</div>`;
  return history.map(m=>`<div class="timeline-item">
    <div class="timeline-dot" style="background:var(--text3)"></div>
    <div class="timeline-content">
      <div class="timeline-date">${new Date(m.date).toLocaleString('nl-BE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
      <div class="timeline-text">${m.description}</div>
    </div></div>`).join('');
}

function terminateContract(id){
  const c=contracts.find(x=>x.id===id);
  if(!c)return;
  const reason=prompt('Reden van opzegging (optioneel):');
  if(reason===null)return;
  c.status='opgezegd';
  c.updatedAt=new Date().toISOString();
  if(!c.comments)c.comments=[];
  c.comments.unshift({text:`‚ùå Contract opgezegd${reason?': '+reason:''}`,date:new Date().toISOString(),type:'status'});
  addMutation('update','contract',id,`Contract "${c.name}" opgezegd`);
  autoSave();renderContracts();updateTaskBadge();renderDashboard();
  openContractDetail(id);
  showToast('Contract opgezegd');
}

function reactivateContract(id){
  const c=contracts.find(x=>x.id===id);
  if(!c)return;
  if(!confirm(`Contract "${c.name}" heractiveren?`))return;
  c.status='actief';
  c.updatedAt=new Date().toISOString();
  if(!c.comments)c.comments=[];
  c.comments.unshift({text:'üîÑ Contract geheractiveerd',date:new Date().toISOString(),type:'status'});
  addMutation('update','contract',id,`Contract "${c.name}" geheractiveerd`);
  autoSave();renderContracts();updateTaskBadge();renderDashboard();
  openContractDetail(id);
  showToast('Contract geheractiveerd');
}

function addContractFile(id){
  const name=prompt('Bestandsnaam (bv. Huurcontract_2024.pdf):');
  if(!name)return;
  const fileType=prompt('Bestandstype (bv. PDF, Word, Excel):');
  const c=contracts.find(x=>x.id===id);
  if(!c)return;
  if(!c.files)c.files=[];
  c.files.push({name,fileType:fileType||'-',uploadDate:new Date().toISOString()});
  c.updatedAt=new Date().toISOString();
  addMutation('update','contract',id,`Bestand "${name}" toegevoegd aan "${c.name}"`);
  autoSave();openContractDetail(id);
  showToast('Bestand geregistreerd');
}

function removeContractFile(id,index){
  const c=contracts.find(x=>x.id===id);
  if(!c||!c.files)return;
  const f=c.files[index];
  if(!confirm(`Bestand "${f.name}" verwijderen?`))return;
  c.files.splice(index,1);
  c.updatedAt=new Date().toISOString();
  addMutation('update','contract',id,`Bestand "${f.name}" verwijderd uit "${c.name}"`);
  autoSave();openContractDetail(id);
  showToast('Bestand verwijderd');
}

function addContractComment(id){
  const text=prompt('Opmerking:');
  if(!text)return;
  const c=contracts.find(x=>x.id===id);
  if(!c)return;
  if(!c.comments)c.comments=[];
  c.comments.unshift({text,date:new Date().toISOString(),type:'comment'});
  c.updatedAt=new Date().toISOString();
  addMutation('update','contract',id,`Opmerking toegevoegd aan "${c.name}"`);
  autoSave();openContractDetail(id);
  showToast('Opmerking toegevoegd');
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê

function loadDemoData(){
  if(contracts.length>0||relations.length>0)return; // Alleen bij eerste gebruik

  // Demo relaties
  relations=[
    {id:'r1',name:'Proximus NV',type:'leverancier',contactPerson:'Jan Vermeersch',contactFunction:'Account Manager',phone:'0478 12 34 56',email:'jan.vermeersch@proximus.be',address:'Koning Albert II-laan 27',zip:'1030',city:'Brussel',vat:'BE 0202.239.951',notes:'',createdAt:'2024-01-15T00:00:00'},
    {id:'r2',name:'Immobel SA',type:'leverancier',contactPerson:'Marie Dubois',contactFunction:'Property Manager',phone:'02 422 45 11',email:'m.dubois@immobel.be',address:'Rue de la R√©gence 58',zip:'1000',city:'Brussel',vat:'BE 0405.966.675',notes:'Contacteer altijd via e-mail',createdAt:'2024-02-01T00:00:00'},
    {id:'r3',name:'Ethias NV',type:'leverancier',contactPerson:'Peter Willems',contactFunction:'Makelaar',phone:'04 220 31 11',email:'peter.willems@ethias.be',address:'Rue des Croisiers 24',zip:'4000',city:'Luik',vat:'BE 0404.484.654',notes:'',createdAt:'2024-03-01T00:00:00'},
    {id:'r4',name:'Engie Electrabel',type:'leverancier',contactPerson:'Sophie Maes',contactFunction:'Key Account',phone:'078 35 33 33',email:'sophie.maes@engie.com',address:'Boulevard Sim√≥n Bol√≠var 34',zip:'1000',city:'Brussel',vat:'BE 0418.570.220',notes:'Contract loopt via Luminus framework',createdAt:'2024-04-01T00:00:00'},
    {id:'r5',name:'Dexia Lease',type:'leverancier',contactPerson:'Thomas De Smet',contactFunction:'Lease Consultant',phone:'02 222 51 11',email:'t.desmet@dexia.be',address:'Pachecolaan 44',zip:'1000',city:'Brussel',vat:'BE 0860.035.296',notes:'',createdAt:'2024-05-01T00:00:00'}
  ];

  // Demo contracten
  const today=new Date();
  const fmt=d=>{const dd=new Date(today);dd.setDate(dd.getDate()+d);return dd.toISOString().split('T')[0];};
  const fmtPast=d=>{const dd=new Date(today);dd.setDate(dd.getDate()-d);return dd.toISOString().split('T')[0];};

  contracts=[
    {id:'c1',name:'Huurovereenkomst kantoor Deurne',typeId:'gebouw',relationId:'r2',departmentId:'dept-directie',
      responsiblePersonId:'x5',vehicleId:null,
      startDate:'2022-01-01',endDate:fmt(45),noticePeriod:3,noticeDate:fmt(45-90),
      value:48000,status:'actief',reference:'Gebouw Deurne - Bisschoppenhoflaan 120',notes:'Jaarlijkse indexatie op 01/01',
      files:[{name:'Huurcontract_2022.pdf',fileType:'PDF',uploadDate:'2022-01-05T00:00:00'}],
      comments:[{text:'Indexatie 2025 doorgevoerd: +3.2%',date:'2025-01-10T00:00:00',type:'comment'}],
      createdAt:'2022-01-01T00:00:00',updatedAt:'2025-01-10T00:00:00'},
    {id:'c2',name:'Telecom pakket kantoor',typeId:'telecom',relationId:'r1',departmentId:'dept-back',
      responsiblePersonId:'x14',vehicleId:null,
      startDate:'2023-06-01',endDate:fmt(22),noticePeriod:2,noticeDate:fmt(22-60),
      value:3600,status:'actief',reference:'',notes:'Inclusief 5 mobiele lijnen',
      files:[],comments:[],createdAt:'2023-06-01T00:00:00',updatedAt:'2023-06-01T00:00:00'},
    {id:'c3',name:'Omnium verzekering wagenpark',typeId:'verzekering',relationId:'r3',departmentId:'dept-directie',
      responsiblePersonId:'x5',vehicleId:null,
      startDate:'2024-01-01',endDate:fmt(310),noticePeriod:3,noticeDate:fmt(310-90),
      value:18500,status:'actief',reference:'Polis AE-2024-0145',notes:'5 voertuigen gedekt',
      files:[{name:'Polisblad_2024.pdf',fileType:'PDF',uploadDate:'2024-01-10T00:00:00'}],
      comments:[],createdAt:'2024-01-01T00:00:00',updatedAt:'2024-01-10T00:00:00'},
    {id:'c4',name:'Energiecontract gas + elektriciteit',typeId:'energie',relationId:'r4',departmentId:'dept-install',
      responsiblePersonId:'x5',vehicleId:null,
      startDate:'2023-01-01',endDate:fmt(72),noticePeriod:2,noticeDate:fmt(72-60),
      value:24000,status:'actief',reference:'',notes:'Vast tarief tot einde looptijd',
      files:[],comments:[{text:'Nieuwe tarieven aangevraagd voor verlenging',date:fmtPast(5)+'T00:00:00',type:'comment'}],
      createdAt:'2023-01-01T00:00:00',updatedAt:fmtPast(5)+'T00:00:00'},
    {id:'c5',name:'Leasing bestelwagen Mercedes Sprinter',typeId:'mobiliteit',relationId:'r5',departmentId:'dept-install',
      responsiblePersonId:'x5',vehicleId:'v1',
      startDate:'2022-03-15',endDate:fmt(15),noticePeriod:1,noticeDate:fmt(15-30),
      value:14400,status:'actief',reference:'',notes:'48 maanden / 120.000 km',
      files:[{name:'Leasingovereenkomst.pdf',fileType:'PDF',uploadDate:'2022-03-20T00:00:00'}],
      comments:[],createdAt:'2022-03-15T00:00:00',updatedAt:'2022-03-20T00:00:00'},
    {id:'c6',name:'Onderhoudscontract HVAC',typeId:'onderhoud',relationId:'r2',departmentId:'dept-install',
      responsiblePersonId:null,vehicleId:null,
      startDate:'2024-04-01',endDate:fmtPast(10),noticePeriod:1,noticeDate:fmtPast(40),
      value:4800,status:'actief',reference:'Gebouw Deurne',notes:'Kwartaalonderhoudsbeurt',
      files:[],comments:[],createdAt:'2024-04-01T00:00:00',updatedAt:'2024-04-01T00:00:00'}
  ];

  autoSave();
}

function init(){
  restore();
  loadDemoData();
  autoSave();
  updateTaskBadge();
  renderDashboard();
  detectShell();
}

// ‚ïê‚ïê‚ïê SHELL INTEGRATIE ‚ïê‚ïê‚ïê

const shellPermissions={canCreate:true,canEdit:true,canDelete:true,role:'admin'};
const isInIframe=window.self!==window.top;

function detectShell(){
  if(isInIframe){
    // Verberg eigen sidebar en role bar ‚Äî shell neemt navigatie over
    const sb=document.querySelector('.sidebar');if(sb)sb.style.display='none';
    const rb=document.querySelector('.role-bar');if(rb)rb.style.display='none';
    const main=document.querySelector('.main');if(main){main.style.marginLeft='0';main.style.paddingTop='0';}
  }
}

window.addEventListener('message',e=>{
  if(e.data&&e.data.type==='shell:permissions'){
    shellPermissions.canCreate=!!e.data.canCreate;
    shellPermissions.canEdit=!!e.data.canEdit;
    shellPermissions.canDelete=!!e.data.canDelete;
    shellPermissions.role=e.data.role||'gebruiker';
    if(e.data.allowedSections)shellPermissions.allowedSections=e.data.allowedSections;
    applyPermissions();
  }
});

function applyPermissions(){
  // Verberg secties op basis van allowedSections
  if(isInIframe&&shellPermissions.allowedSections){
    document.querySelectorAll('.sb-item[data-page]').forEach(el=>{
      const page=el.getAttribute('data-page');
      el.style.display=shellPermissions.allowedSections.includes(page)?'':'none';
    });
    // Verberg ook instellingen-tab
    const settingsTab=document.querySelector('[data-page="settings"]');
    if(settingsTab)settingsTab.style.display=isAdmin()?'':'none';
    // Redirect als huidige pagina niet toegankelijk
    if(shellPermissions.allowedSections.indexOf(activePage)===-1&&activePage!=='dashboard'){
      showPage('dashboard');return;
    }
  }
  // Herrender actieve pagina zodat knoppen correct verschijnen
  if(activePage==='contracts')renderContracts();
  if(activePage==='relations')renderRelations();
  if(activePage==='settings')renderSettings();
  if(activePage==='dashboard')renderDashboard();
}

// Helper: geeft lege string terug als actie niet mag
function canCreate(){return shellPermissions.canCreate;}
function canEdit(){return shellPermissions.canEdit;}
function canDelete(){return shellPermissions.canDelete;}
function isAdmin(){return shellPermissions.role==='admin';}

init();
</script>
</body>
</html>
