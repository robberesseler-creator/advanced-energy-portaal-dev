<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Energy ‚Äî Plenion Dashboard</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap');
:root{--bg:#0f1117;--surface:#181c27;--surface2:#1e2336;--header:#000;--accent:#4f8ef7;--accent2:#38d9a9;--success:#38d9a9;--danger:#ff5c5c;--warn:#f7c948;--text:#e8ecf5;--text2:#8b92b0;--text3:#555e7d;--border:#2a2f45;--border-h:#3d4460;--r:12px;--rs:8px}
*{box-sizing:border-box;margin:0;padding:0}body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex}::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.sb{width:260px;background:var(--surface);border-right:1px solid var(--border);position:fixed;top:0;bottom:0;left:0;z-index:100;display:flex;flex-direction:column}.sb-logo{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:11px}.sb-logo-icon{width:34px;height:34px;border-radius:6px;background:linear-gradient(135deg,#4f8ef7,#38d9a9);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:.72rem}.sb-nav{flex:1;padding:14px 10px;overflow-y:auto}.sb-sec{font-family:'DM Mono',monospace;font-size:.5rem;text-transform:uppercase;letter-spacing:3px;color:var(--text3);padding:14px 12px 6px}.ni{display:flex;align-items:center;gap:11px;padding:10px 12px;border-radius:var(--rs);color:var(--text2);cursor:pointer;font-size:.86rem;font-weight:500;margin-bottom:2px;position:relative;transition:all .15s;user-select:none}.ni:hover{background:rgba(79,142,247,.06)}.ni.a{background:rgba(79,142,247,.1);color:var(--accent);font-weight:600}.ni.a::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:18px;background:var(--accent);border-radius:0 2px 2px 0}.ni-icon{width:20px;text-align:center;font-size:1rem;flex-shrink:0}.ni-badge{background:var(--accent);color:#fff;font-size:.62rem;font-weight:700;padding:1px 7px;border-radius:10px;min-width:20px;text-align:center}.sb-user{padding:14px 18px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px}.sb-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,rgba(79,142,247,.2),rgba(56,217,169,.2));color:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.68rem}
.mn{margin-left:260px;flex:1;position:relative}.hd{height:56px;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 28px;gap:14px;background:var(--header);position:sticky;top:0;z-index:50}.hd-title{flex:1;font-size:1rem;font-weight:700}.hd-sub{color:var(--text3);font-weight:400;font-size:.8rem;margin-left:8px}.live{display:flex;align-items:center;gap:7px;margin-right:14px}.live-dot{width:8px;height:8px;background:var(--success);border-radius:50%;box-shadow:0 0 8px rgba(56,217,169,.5);animation:pulse 2s ease-in-out infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}.cnt{padding:24px 28px}.mono{font-family:'DM Mono',monospace}
.ds-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:24px}.ds-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px 18px;position:relative;overflow:hidden;transition:all .2s;cursor:pointer}.ds-card:hover{border-color:var(--border-h);transform:translateY(-1px)}.ds-card .bar{position:absolute;top:0;left:0;width:3px;height:100%;border-radius:0 2px 2px 0;opacity:.7}.ds-label{font-family:'DM Mono',monospace;font-size:.48rem;text-transform:uppercase;letter-spacing:2px;color:var(--text3);margin-bottom:5px}.ds-val{font-size:1.7rem;font-weight:700;letter-spacing:-1px;line-height:1;margin-bottom:3px}.ds-sub{font-size:.65rem;color:var(--text3)}
.ql-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:24px}.ql-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:20px 14px;cursor:pointer;transition:all .2s;text-align:center}.ql-card:hover{border-color:var(--border-h);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.2)}.ql-icon{font-size:32px;margin-bottom:10px}.ql-title{font-weight:700;font-size:.82rem;margin-bottom:3px}.ql-desc{font-size:.66rem;color:var(--text2);line-height:1.4}.ql-count{display:inline-block;margin-top:7px;font-family:'DM Mono',monospace;font-size:.65rem;padding:2px 9px;border-radius:12px;background:rgba(79,142,247,.1);color:var(--accent);font-weight:600}
.cat-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:24px}.cc{background:var(--surface);border:2px solid var(--border);border-radius:var(--r);padding:16px 12px;text-align:center;cursor:pointer;transition:all .2s}.cc:hover{border-color:var(--border-h);transform:translateY(-2px)}.cc-bar{width:100%;height:4px;border-radius:2px;margin-bottom:10px}.cc-num{font-size:1.6rem;font-weight:700;font-family:'DM Mono',monospace;line-height:1}.cc-label{font-size:.6rem;color:var(--text2);margin-top:6px;line-height:1.3}
.fl{display:flex;align-items:center;gap:10px;margin-bottom:18px;flex-wrap:wrap}.sr{position:relative;flex:0 0 240px}.sr svg{position:absolute;left:10px;top:50%;transform:translateY(-50%)}.sr input{width:100%;padding-left:34px}input,select,textarea{background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.83rem;padding:10px 12px;outline:none}input:focus,select:focus,textarea:focus{border-color:var(--accent)}textarea{resize:vertical;min-height:60px}select{color:var(--text2);font-size:.8rem;cursor:pointer;appearance:none;padding-right:30px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23555e7d' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 9px center}.btn{padding:8px 14px;border-radius:var(--rs);border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;font-size:.8rem;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .15s}.btn:hover{border-color:var(--border-h);color:var(--text)}.btn-p{background:linear-gradient(135deg,#4f8ef7,#3a7de8);border:none;color:#fff}.btn-p:hover{opacity:.9}.btn-s{background:linear-gradient(135deg,#38d9a9,#2bc49a);border:none;color:#fff;display:inline-flex;align-items:center;gap:6px}.btn-s:hover{opacity:.9;color:#fff}.btn-add{background:linear-gradient(135deg,#4f8ef7,#3a7de8);border:none;color:#fff;display:inline-flex;align-items:center;gap:6px;padding:9px 16px;font-size:.82rem;border-radius:var(--rs);font-weight:600;cursor:pointer;transition:all .15s}.btn-add:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 12px rgba(79,142,247,.3)}
.tw{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}.ts{overflow-x:auto}table{width:100%;border-collapse:collapse;min-width:800px}th{padding:12px 14px;font-family:'DM Mono',monospace;font-size:.55rem;text-transform:uppercase;letter-spacing:2px;color:var(--text3);text-align:left;border-bottom:1px solid var(--border);background:rgba(0,0,0,.15);white-space:nowrap}td{padding:11px 14px}tbody tr{border-bottom:1px solid var(--border);transition:background .1s}tbody tr:hover{background:rgba(79,142,247,.02)}.tf{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-top:1px solid var(--border);font-size:.76rem;color:var(--text3)}
.cb{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:6px;font-size:.68rem;font-weight:600}.cd{width:7px;height:7px;border-radius:50%;display:inline-block}.sd{display:inline-flex;align-items:center;gap:5px;font-size:.76rem}.pb{display:inline-block;padding:2px 7px;border-radius:5px;font-size:.68rem;font-weight:600}.tag{display:inline-block;padding:2px 7px;border-radius:5px;font-size:.68rem;font-weight:600;margin-right:3px}
.vb{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--surface2);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text3);transition:all .15s;flex-shrink:0}.vb:hover{border-color:var(--border-h);color:var(--text);background:rgba(255,255,255,.05)}
.mbg{position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}.mbg.show{display:flex}.mdl{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:700px;width:92%;max-height:85vh;overflow:auto}.mdl-h{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px}.mdl-x{background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);font-size:16px}.mdl-g{display:grid;grid-template-columns:1fr 1fr;gap:14px;font-size:.85rem;margin-bottom:20px}.mdl-lb{font-family:'DM Mono',monospace;font-size:.55rem;text-transform:uppercase;letter-spacing:2px;color:var(--text3);margin-bottom:4px}.mdl-v{color:var(--text);font-weight:500}.ps{margin-bottom:16px}.ps-t{font-family:'DM Mono',monospace;font-size:.55rem;text-transform:uppercase;letter-spacing:2px;color:var(--text3);margin-bottom:8px}.pg{display:flex;gap:8px;flex-wrap:wrap}.pt{width:110px;height:110px;object-fit:cover;border-radius:var(--rs);border:1px solid var(--border);cursor:pointer}
.pnl{display:none}.pnl.a{display:block}.empty{text-align:center;padding:60px 20px;color:var(--text3)}.empty-icon{font-size:48px;margin-bottom:12px;opacity:.5}.empty-title{font-size:1rem;font-weight:600;color:var(--text2);margin-bottom:6px}.empty-sub{font-size:.82rem}
.confirm-bg{position:fixed;inset:0;z-index:300;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);backdrop-filter:blur(6px)}.confirm-bg.show{display:flex}.confirm-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px;max-width:420px;width:90%;text-align:center;animation:popIn .2s ease}@keyframes popIn{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}.confirm-icon{font-size:48px;margin-bottom:16px}.confirm-title{font-size:1.1rem;font-weight:700;margin-bottom:8px}.confirm-sub{font-size:.85rem;color:var(--text2);margin-bottom:24px;line-height:1.5}.confirm-btns{display:flex;gap:10px;justify-content:center}.confirm-btns .btn{min-width:120px;padding:10px 20px;font-size:.85rem}
.flow-bar{display:flex;align-items:center;gap:0;margin-bottom:20px;padding:14px 18px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);flex-wrap:wrap}.flow-step{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:.72rem;font-weight:600;color:var(--text3)}.flow-step.done{background:rgba(56,217,169,.1);color:var(--success)}.flow-step.active{background:rgba(79,142,247,.15);color:var(--accent)}.flow-arrow{color:var(--text3);font-size:.7rem;margin:0 2px}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--success);color:#fff;padding:12px 24px;border-radius:var(--r);font-weight:600;font-size:.85rem;z-index:400;box-shadow:0 8px 32px rgba(56,217,169,.3);transition:transform .3s ease}.toast.show{transform:translateX(-50%) translateY(0)}
/* ADD FORM MODAL */
.add-bg{position:fixed;inset:0;z-index:250;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);backdrop-filter:blur(4px)}.add-bg.show{display:flex}
.add-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:520px;width:92%;max-height:85vh;overflow:auto;animation:popIn .2s ease}
.add-title{font-size:1rem;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:8px}
.fg{margin-bottom:14px}.fg label{display:block;font-family:'DM Mono',monospace;font-size:.55rem;text-transform:uppercase;letter-spacing:2px;color:var(--text3);margin-bottom:5px}.fg input,.fg select,.fg textarea{width:100%}
.fg-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.chk-grid{display:flex;flex-wrap:wrap;gap:8px}.chk-item{display:flex;align-items:center;gap:6px;padding:6px 12px;border:1px solid var(--border);border-radius:var(--rs);cursor:pointer;font-size:.78rem;font-weight:500;transition:all .15s;user-select:none}.chk-item:hover{border-color:var(--border-h)}.chk-item.on{border-color:var(--accent);background:rgba(79,142,247,.1);color:var(--accent)}
.add-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
</style>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
</head>
<body>
<aside class="sb"><div class="sb-logo"><div class="sb-logo-icon">AE</div><div><div style="font-weight:700;font-size:.88rem;letter-spacing:.3px">Advanced Energy</div><div class="mono" style="font-size:.55rem;text-transform:uppercase;letter-spacing:2px;color:var(--text3)">Plenion</div></div></div><div class="sb-nav"><div class="sb-sec">Overzicht</div><div class="ni a" data-tab="dashboard" onclick="go(this)"><span class="ni-icon">üìä</span><span style="flex:1">Dashboard</span></div><div class="sb-sec">Applicaties</div><div class="ni" data-tab="magazijn" onclick="go(this)"><span class="ni-icon">üì¶</span><span style="flex:1">Magazijn</span><span class="ni-badge" id="mag-badge">0</span></div><div class="ni" data-tab="bezoeksrapport" onclick="go(this)"><span class="ni-icon">üìã</span><span style="flex:1">Bezoeksrapport</span><span class="ni-badge" id="br-badge" style="display:none">0</span></div><div class="ni" data-tab="projecten" onclick="go(this)"><span class="ni-icon">üìÅ</span><span style="flex:1">Projecten</span><span class="ni-badge" id="pj-badge" style="display:none">0</span></div><div class="ni" data-tab="montage" onclick="go(this)"><span class="ni-icon">üîß</span><span style="flex:1">Montage</span><span class="ni-badge" id="mt-badge" style="display:none">0</span></div><div class="ni" data-tab="service" onclick="go(this)"><span class="ni-icon">üõ†Ô∏è</span><span style="flex:1">Service</span><span class="ni-badge" id="sv-badge" style="display:none">0</span></div><div class="ni" data-tab="onderhoud" onclick="go(this)"><span class="ni-icon">üîÑ</span><span style="flex:1">Onderhoud</span><span class="ni-badge" id="oh-badge" style="display:none">0</span></div><div class="sb-sec">Beheer</div><div class="ni" data-tab="instellingen" onclick="go(this)"><span class="ni-icon">‚öôÔ∏è</span><span style="flex:1">Instellingen</span></div></div><div class="sb-user"><div class="sb-avatar">AD</div><div><div style="font-size:.8rem;font-weight:600">Admin</div><div class="mono" style="font-size:.58rem;color:var(--success);text-transform:uppercase;letter-spacing:1px">Online</div></div></div></aside>
<div class="mn"><header class="hd"><div class="hd-title" id="hd-t">üìä Dashboard <span class="hd-sub">‚Äî Overzicht</span></div><div class="live"><span class="live-dot"></span><span class="mono" style="font-size:.58rem;text-transform:uppercase;letter-spacing:2px;color:var(--success)">Live</span></div><button class="btn" onclick="location.reload()">‚Üª Vernieuwen</button></header>
<div class="cnt">
<!-- DASHBOARD --><div class="pnl a" id="p-dashboard"><div class="ds-grid" id="ds-cards"></div><h3 style="font-size:.9rem;font-weight:600;margin-bottom:14px;color:var(--text2)">Snelle links</h3><div class="ql-grid"><div class="ql-card" onclick="go(document.querySelector('[data-tab=magazijn]'))"><div class="ql-icon">üì¶</div><div class="ql-title">Magazijn</div><div class="ql-desc">Registraties & stock</div><div class="ql-count" id="ql-mag">0</div></div><div class="ql-card" onclick="go(document.querySelector('[data-tab=bezoeksrapport]'))"><div class="ql-icon">üìã</div><div class="ql-title">Bezoeksrapport</div><div class="ql-desc">Ingezonden rapporten</div><div class="ql-count" id="ql-br">0</div></div><div class="ql-card" onclick="go(document.querySelector('[data-tab=projecten]'))"><div class="ql-icon">üìÅ</div><div class="ql-title">Projecten</div><div class="ql-desc">Actieve projecten</div><div class="ql-count" id="ql-pj">0</div></div><div class="ql-card" onclick="go(document.querySelector('[data-tab=montage]'))"><div class="ql-icon">üîß</div><div class="ql-title">Montage</div><div class="ql-desc">Installaties</div><div class="ql-count" id="ql-mt">0</div></div><div class="ql-card" onclick="go(document.querySelector('[data-tab=service]'))"><div class="ql-icon">üõ†Ô∏è</div><div class="ql-title">Service</div><div class="ql-desc">Interventies</div><div class="ql-count" id="ql-sv">0</div></div><div class="ql-card" onclick="go(document.querySelector('[data-tab=onderhoud]'))"><div class="ql-icon">üîÑ</div><div class="ql-title">Onderhoud</div><div class="ql-desc">Contracten</div><div class="ql-count" id="ql-oh">0</div></div></div><h3 style="font-size:.9rem;font-weight:600;margin:24px 0 14px;color:var(--text2)">Laatste activiteit</h3><div id="ds-act" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:20px"><div style="color:var(--text3);font-size:.82rem">Laden...</div></div></div>
<!-- MAGAZIJN --><div class="pnl" id="p-magazijn"><div class="cat-grid" id="cat-cards"></div><div class="fl"><div class="sr"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input id="mag-search" placeholder="Zoeken..." oninput="renderMag()"></div><select id="mag-filter" onchange="renderMag()"><option value="">Alle Categorie√´n</option><option value="paars">Spare part ‚Äî Stock</option><option value="oranje">Spare part ‚Äî Interventie</option><option value="geel">Niet volledig</option><option value="rood">Beschadigd / Retour lev.</option><option value="blauw">Retour van werf</option><option value="roze">Verbruikte spare parts</option></select><button class="btn-add" onclick="window.open('magazijn.html','_blank')" title="Opent de magazijn-app (zelfde als op GSM)">üì± Open Magazijn App</button><div style="flex:1"></div><span style="font-size:.75rem;color:var(--text3)" id="mag-rc">0</span></div><div class="tw"><div class="ts"><table><thead><tr><th>#</th><th>Categorie</th><th>Omschrijving</th><th>Project</th><th>Ref.</th><th>Serial</th><th>Status</th><th>Datum</th><th>Foto's</th><th></th></tr></thead><tbody id="mag-tb"></tbody></table></div><div class="tf"><div id="mag-tc">0</div></div></div></div>
<!-- BEZOEKSRAPPORT --><div class="pnl" id="p-bezoeksrapport"><div class="flow-bar"><div class="flow-step active">üìã Bezoeksrapport</div><span class="flow-arrow">‚Üí</span><div class="flow-step">‚úÖ Klaar markeren</div><span class="flow-arrow">‚Üí</span><div class="flow-step">üìÅ Project aangemaakt</div><span class="flow-arrow">‚Üí</span><div class="flow-step">üîß Montage / üõ†Ô∏è Service</div></div><div class="fl"><div class="sr"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input id="br-search" placeholder="Zoeken op klant, adres, type..." oninput="renderBR()"></div><select id="br-filter" onchange="renderBR()"><option value="">Alle types</option><option value="solar">Zon / Thuisbatterij</option><option value="airmo">Lucht/Lucht Mono</option><option value="airmu">Lucht/Lucht Multi</option><option value="airwater">Lucht/Water</option><option value="geo">Geothermie</option><option value="charge">Laadpaal</option></select><span style="font-size:.68rem;color:var(--text3);background:var(--surface2);padding:5px 12px;border-radius:var(--rs);border:1px solid var(--border)">üì± Rapporten worden via de GSM-app aangemaakt</span><div style="flex:1"></div><span style="font-size:.75rem;color:var(--text3)" id="br-rc">0</span></div><div class="tw"><div class="ts"><table><thead><tr><th>Klant</th><th>Adres</th><th>Types</th><th>Items</th><th>Foto's</th><th>Datum</th><th style="text-align:center">Acties</th></tr></thead><tbody id="br-tb"></tbody></table></div><div class="tf"><div id="br-tc">0</div></div></div></div>
<!-- PROJECTEN --><div class="pnl" id="p-projecten"><div class="flow-bar"><div class="flow-step done">üìã Rapport ingediend</div><span class="flow-arrow">‚Üí</span><div class="flow-step done">‚úÖ Klaar gemarkeerd</div><span class="flow-arrow">‚Üí</span><div class="flow-step active">üìÅ Project actief</div><span class="flow-arrow">‚Üí</span><div class="flow-step">üîß Montage / üõ†Ô∏è Service</div></div><div class="fl"><div class="sr"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input id="pj-search" placeholder="Zoeken op klant, adres..." oninput="renderPJ()"></div><select id="pj-filter" onchange="renderPJ()"><option value="">Alle statussen</option><option value="nieuw">Nieuw</option><option value="gepland">Gepland</option><option value="bezig">Bezig</option><option value="afgerond">Afgerond</option></select><div style="flex:1"></div><span style="font-size:.75rem;color:var(--text3)" id="pj-rc">0</span></div><div class="tw"><div class="ts"><table><thead><tr><th>Klant</th><th>Adres</th><th>Types</th><th>Status</th><th>Project datum</th><th style="text-align:center">Doorsturen</th><th></th></tr></thead><tbody id="pj-tb"></tbody></table></div><div class="tf"><div id="pj-tc">0</div></div></div></div>
<!-- MONTAGE --><div class="pnl" id="p-montage"><div class="fl"><div class="sr"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input id="mt-search" placeholder="Zoeken..." oninput="renderMT()"></div><select id="mt-filter" onchange="renderMT()"><option value="">Alle statussen</option><option value="gepland">Gepland</option><option value="bezig">Bezig</option><option value="afgerond">Afgerond</option><option value="wacht">Wacht op materiaal</option></select><button class="btn-add" onclick="openAdd('montage')">Ôºã Toevoegen</button><div style="flex:1"></div><span style="font-size:.75rem;color:var(--text3)" id="mt-rc">0</span></div><div class="tw"><div class="ts"><table><thead><tr><th>Klant</th><th>Adres</th><th>Type</th><th>Team</th><th>Status</th><th>Datum</th><th>Foto's</th><th></th></tr></thead><tbody id="mt-tb"></tbody></table></div><div class="tf"><div id="mt-tc">0</div></div></div></div>
<!-- SERVICE --><div class="pnl" id="p-service"><div class="fl"><div class="sr"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input id="sv-search" placeholder="Zoeken..." oninput="renderSV()"></div><select id="sv-filter" onchange="renderSV()"><option value="">Alle statussen</option><option value="open">Open</option><option value="bezig">In behandeling</option><option value="wacht">Wacht</option><option value="afgerond">Afgerond</option></select><select id="sv-prio" onchange="renderSV()"><option value="">Alle prioriteiten</option><option value="hoog">Hoog</option><option value="normaal">Normaal</option><option value="laag">Laag</option></select><button class="btn-add" onclick="openAdd('service')">Ôºã Toevoegen</button><div style="flex:1"></div><span style="font-size:.75rem;color:var(--text3)" id="sv-rc">0</span></div><div class="tw"><div class="ts"><table><thead><tr><th>Klant</th><th>Adres</th><th>Probleem</th><th>Type</th><th>Prioriteit</th><th>Status</th><th>Datum</th><th>Foto's</th><th></th></tr></thead><tbody id="sv-tb"></tbody></table></div><div class="tf"><div id="sv-tc">0</div></div></div></div>
<!-- ONDERHOUD --><div class="pnl" id="p-onderhoud"><div class="fl"><div class="sr"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input id="oh-search" placeholder="Zoeken..." oninput="renderOH()"></div><select id="oh-filter" onchange="renderOH()"><option value="">Alle statussen</option><option value="actief">Actief</option><option value="verlopen">Verlopen</option><option value="gepland">Gepland</option><option value="uitgevoerd">Uitgevoerd</option></select><button class="btn-add" onclick="openAdd('onderhoud')">Ôºã Toevoegen</button><div style="flex:1"></div><span style="font-size:.75rem;color:var(--text3)" id="oh-rc">0</span></div><div class="tw"><div class="ts"><table><thead><tr><th>Klant</th><th>Adres</th><th>Type</th><th>Contract</th><th>Laatste beurt</th><th>Volgende</th><th>Status</th><th>Foto's</th><th></th></tr></thead><tbody id="oh-tb"></tbody></table></div><div class="tf"><div id="oh-tc">0</div></div></div></div>
<!-- INSTELLINGEN --><div class="pnl" id="p-instellingen"><div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:48px 40px;text-align:center"><div style="font-size:56px;margin-bottom:16px">‚öôÔ∏è</div><div style="font-size:1.2rem;font-weight:700;margin-bottom:8px">Instellingen</div><div style="color:var(--text2);font-size:.85rem;max-width:460px;margin:0 auto">Komt binnenkort.</div></div></div>
</div></div>
<!-- DETAIL MODAL --><div class="mbg" id="modal" onclick="closeModal()"><div class="mdl" onclick="event.stopPropagation()"><div class="mdl-h"><div><h3 style="font-size:1.1rem;font-weight:700;margin-bottom:6px" id="m-title"></h3><div id="m-cat"></div></div><button class="mdl-x" onclick="closeModal()">‚úï</button></div><div class="mdl-g" id="m-fields"></div><div id="m-photos"></div><div id="m-extra"></div></div></div>
<!-- CONFIRM MODAL --><div class="confirm-bg" id="confirm-modal" onclick="closeConfirm()"><div class="confirm-box" onclick="event.stopPropagation()"><div class="confirm-icon">‚úÖ</div><div class="confirm-title">Rapport klaar markeren?</div><div class="confirm-sub" id="confirm-sub"></div><div class="confirm-btns"><button class="btn" onclick="closeConfirm()">Annuleren</button><button class="btn btn-s" id="confirm-ok" onclick="doKlaar()">‚úÖ Ja, markeer klaar</button></div></div></div>
<!-- ADD MODAL (simple forms for montage/service/onderhoud) --><div class="add-bg" id="add-modal" onclick="closeAdd()"><div class="add-box" onclick="event.stopPropagation()"><div class="add-title" id="add-title"></div><div id="add-form"></div><div class="add-actions"><button class="btn" onclick="closeAdd()">Annuleren</button><button class="btn-add" onclick="submitAdd()">Ôºã Toevoegen</button></div></div></div>
<div class="toast" id="toast"></div>
<script>
firebase.initializeApp({apiKey:"AIzaSyBKU-wCjV4Au4ngRG52Zmmxbzc3N3D8VBU",authDomain:"advanced-intranet.firebaseapp.com",projectId:"advanced-intranet",storageBucket:"advanced-intranet.firebasestorage.app",messagingSenderId:"309856938024",appId:"1:309856938024:web:2108715f92c5dea2da2d1d"});
var db=firebase.firestore(),storage=firebase.storage();
var SEC={paars:{l:'Spare part ‚Äî Stock',c:'#a78bfa'},oranje:{l:'Spare part ‚Äî Interventie',c:'#f97316'},geel:{l:'Niet volledig',c:'#f7c948'},rood:{l:'Beschadigd / Retour lev.',c:'#ff5c5c'},blauw:{l:'Retour van werf',c:'#38b6ff'},roze:{l:'Verbruikte spare parts',c:'#f472b6'}};
var PF=['photos','artikelPhotos','stickerPhotos','bonPhotos','schadePhotos','seriePhotos'];
var PL={photos:'üì¶ Product',artikelPhotos:'üîç Artikelnr',stickerPhotos:'üè∑Ô∏è Sticker',bonPhotos:'üìã Leverbon',schadePhotos:'‚ö†Ô∏è Schade',seriePhotos:'üî¢ Serienr'};
var BL={solar:'‚òÄÔ∏èüîã Zon / Thuisbatterij',airmo:'üå°Ô∏è Lucht/Lucht Mono',airmu:'üå°Ô∏è Lucht/Lucht Multi',airwater:'üíß Lucht/Water',geo:'üåç Geothermie',charge:'‚ö° Laadpaal'};
var BC={solar:'#f7c948',airmo:'#ff8c42',airmu:'#ff8c42',airwater:'#38b6ff',geo:'#4caf50',charge:'#a78bfa'};
var ST={open:{c:'var(--accent)',l:'Open'},nieuw:{c:'var(--accent)',l:'Nieuw'},bezig:{c:'var(--warn)',l:'In behandeling'},gepland:{c:'#38b6ff',l:'Gepland'},wacht:{c:'#a78bfa',l:'Wacht'},afgerond:{c:'var(--success)',l:'Afgerond'},actief:{c:'var(--success)',l:'Actief'},verlopen:{c:'var(--danger)',l:'Verlopen'},uitgevoerd:{c:'var(--accent)',l:'Uitgevoerd'}};
var PR={hoog:{c:'var(--danger)',l:'üî¥ Hoog'},normaal:{c:'var(--warn)',l:'üü° Normaal'},laag:{c:'var(--text3)',l:'‚ö™ Laag'}};
var IT={solar:'‚òÄÔ∏è Zon',airmo:'üå°Ô∏è Airco Mono',airmu:'üå°Ô∏è Airco Multi',airwater:'üíß Lucht/Water',geo:'üåç Geo',charge:'‚ö° Laadpaal',batterij:'üîã Batterij'};
var IC={solar:'#f7c948',airmo:'#ff8c42',airmu:'#ff8c42',airwater:'#38b6ff',geo:'#4caf50',charge:'#a78bfa',batterij:'#f7c948'};
var magItems=[],brItems=[],pjItems=[],mtItems=[],svItems=[],ohItems=[],catFilter='',pendingId='',addMod='';
var titles={dashboard:'üìä Dashboard <span class="hd-sub">‚Äî Overzicht</span>',magazijn:'üì¶ Magazijn <span class="hd-sub">‚Äî Registraties</span>',bezoeksrapport:'üìã Bezoeksrapport <span class="hd-sub">‚Äî Rapporten</span>',projecten:'üìÅ Projecten <span class="hd-sub">‚Äî Actieve projecten</span>',montage:'üîß Montage <span class="hd-sub">‚Äî Opdrachten</span>',service:'üõ†Ô∏è Service <span class="hd-sub">‚Äî Interventies</span>',onderhoud:'üîÑ Onderhoud <span class="hd-sub">‚Äî Contracten</span>',instellingen:'‚öôÔ∏è Instellingen'};
var EYE='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
var DLI='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
function fmt(d){if(!d)return'‚Äî';try{return new Date(d).toLocaleDateString('nl-BE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}catch(e){return d}}
function stB(s){var x=ST[s]||{c:'var(--text3)',l:s||'‚Äî'};return'<span class="sd"><span class="cd" style="background:'+x.c+'"></span>'+x.l+'</span>'}
function prB(p){var x=PR[p]||{c:'var(--text3)',l:p||'‚Äî'};return'<span style="font-size:.72rem;font-weight:600;color:'+x.c+'">'+x.l+'</span>'}
function itB(t){var b=t?t.split('-')[0]:t;var c=IC[b]||'#555e7d';var l=IT[b]||t||'‚Äî';return'<span class="tag" style="background:'+c+'1a;color:'+c+'">'+l+'</span>'}
function tTags(types){return(types||[]).map(function(t){var b=t.split('-')[0];return'<span class="tag" style="background:'+(BC[b]||'#555e7d')+'1a;color:'+(BC[b]||'#555e7d')+'">'+(BL[b]||t)+'</span>'}).join('')}
function phB(n,cl){if(!n)return'‚Äî';return'<span class="pb" style="background:'+(cl?'rgba(56,217,169,.12)':'rgba(139,146,176,.1)')+';color:'+(cl?'var(--success)':'var(--text2)')+'">üì∑ '+n+(cl?' ‚òÅÔ∏è':'')+'</span>'}
function setBdg(id,n){var e=document.getElementById(id);if(!e)return;if(n>0){e.style.display='';e.textContent=n}else e.style.display='none'}
function cntPh(d){var t=0,c=false;if(!d)return{t:0,c:false};Object.values(d).forEach(function(v){if(!v)return;var u=(v.storageUrls||[]).filter(function(x){return x&&x.startsWith('http')});var p=(v.photos||[]).filter(function(x){return typeof x==='string'&&x.startsWith('http')});t+=Math.max(u.length,p.length,v.photoCount||0);if(u.length||p.length)c=true});return{t:t,c:c}}
function emR(cols,icon,title,sub){return'<tr><td colspan="'+cols+'" class="empty"><div class="empty-icon">'+icon+'</div><div class="empty-title">'+title+'</div><div class="empty-sub">'+sub+'</div></td></tr>'}
function ldR(cols){return'<tr><td colspan="'+cols+'" style="text-align:center;padding:40px;color:var(--text2)">‚è≥ Laden...</td></tr>'}
function toast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show')},3000)}
function go(el){var tab=el.dataset.tab;document.querySelectorAll('.ni').forEach(function(n){n.classList.remove('a')});el.classList.add('a');document.querySelectorAll('.pnl').forEach(function(p){p.classList.remove('a')});var p=document.getElementById('p-'+tab);if(p)p.classList.add('a');document.getElementById('hd-t').innerHTML=titles[tab]||tab;if(tab==='magazijn'){renderCat();renderMag()}if(tab==='bezoeksrapport')renderBR();if(tab==='projecten')renderPJ();if(tab==='montage')renderMT();if(tab==='service')renderSV();if(tab==='onderhoud')renderOH();if(tab==='dashboard')renderDash()}
function closeModal(){document.getElementById('modal').classList.remove('show')}
function closeConfirm(){document.getElementById('confirm-modal').classList.remove('show');pendingId=''}
function closeAdd(){document.getElementById('add-modal').classList.remove('show');addMod=''}

// ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê
function renderDash(){document.getElementById('ds-cards').innerHTML=[{l:'Magazijn',v:magItems.length,c:'var(--accent)',s:'Items',t:'magazijn'},{l:'Rapporten',v:brItems.length,c:'#f7c948',s:'Ingezonden',t:'bezoeksrapport'},{l:'Projecten',v:pjItems.length,c:'#38b6ff',s:'Actief',t:'projecten'},{l:'Montage',v:mtItems.length,c:'#f472b6',s:'Opdrachten',t:'montage'},{l:'Service',v:svItems.length,c:'#a78bfa',s:'Tickets',t:'service'},{l:'Onderhoud',v:ohItems.length,c:'var(--success)',s:'Contracten',t:'onderhoud'}].map(function(s){return'<div class="ds-card" onclick="go(document.querySelector(\'[data-tab='+s.t+']\'))"><div class="bar" style="background:'+s.c+'"></div><div class="ds-label">'+s.l+'</div><div class="ds-val" style="color:'+s.c+'">'+s.v+'</div><div class="ds-sub">'+s.s+'</div></div>'}).join('');document.getElementById('ql-mag').textContent=magItems.length;document.getElementById('ql-br').textContent=brItems.length;document.getElementById('ql-pj').textContent=pjItems.length;document.getElementById('ql-mt').textContent=mtItems.length;document.getElementById('ql-sv').textContent=svItems.length;document.getElementById('ql-oh').textContent=ohItems.length;document.getElementById('ds-act').innerHTML='<div style="color:var(--text3);font-size:.82rem">'+magItems.length+' magazijn items ¬∑ '+brItems.length+' rapporten ¬∑ '+pjItems.length+' projecten ¬∑ '+mtItems.length+' montages ¬∑ '+svItems.length+' tickets ¬∑ '+ohItems.length+' contracten</div>'}

// ‚ïê‚ïê‚ïê MAGAZIJN ‚ïê‚ïê‚ïê
function renderCat(){document.getElementById('cat-cards').innerHTML=Object.entries(SEC).map(function(e){var k=e[0],cfg=e[1];var n=magItems.filter(function(i){return i.section===k}).length;var a=catFilter===k;return'<div class="cc'+(a?' a':'')+'" style="'+(a?'border-color:'+cfg.c+'88':'')+'" onclick="catFilter=catFilter===\''+k+'\'?\'\':\''+k+'\';document.getElementById(\'mag-filter\').value=catFilter;renderCat();renderMag()"><div class="cc-bar" style="background:'+cfg.c+'"></div><div class="cc-num" style="color:'+cfg.c+'">'+n+'</div><div class="cc-label">'+cfg.l+'</div></div>'}).join('')}
function renderMag(){var s=document.getElementById('mag-search').value.toLowerCase(),f=document.getElementById('mag-filter').value||catFilter;var fl=magItems.filter(function(i){if(f&&i.section!==f)return false;if(s){var v=[i.description,i.projectNumber,i.reference,i.serial].map(function(x){return(x||'').toLowerCase()});if(!v.some(function(x){return x.includes(s)}))return false}return true});var tb=document.getElementById('mag-tb');if(!fl.length)tb.innerHTML=emR(10,'üì¶','Geen items','Klik Ôºã Toevoegen om een item te registreren');else tb.innerHTML=fl.map(function(item){var sec=SEC[item.section]||{l:item.section,c:'#555e7d'};var tp=PF.reduce(function(a,f){return a+((item[f]||[]).length)},0);var sc=item.status==='afgehandeld'?'var(--success)':'var(--accent)';var st=item.status==='afgehandeld'?'Afgehandeld':'Open';return'<tr><td class="mono" style="font-size:.76rem;color:var(--text3)">'+item.id+'</td><td><span class="cb" style="background:'+sec.c+'1a;color:'+sec.c+'"><span class="cd" style="background:'+sec.c+'"></span>'+sec.l+'</span></td><td style="font-weight:600;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(item.description||'‚Äî')+'</td><td class="mono" style="font-size:.76rem;color:var(--text2)">'+(item.projectNumber||'‚Äî')+'</td><td style="font-size:.8rem;color:var(--text2)">'+(item.reference||'‚Äî')+'</td><td class="mono" style="font-size:.72rem;color:var(--text2)">'+(item.serial||'‚Äî')+'</td><td><span class="sd"><span class="cd" style="background:'+sc+'"></span>'+st+'</span></td><td class="mono" style="font-size:.7rem;color:var(--text3);white-space:nowrap">'+(item.timestamp||'‚Äî')+'</td><td>'+phB(tp,false)+'</td><td><button class="vb" onclick="openMagM('+item.id+')">'+EYE+'</button></td></tr>'}).join('');document.getElementById('mag-rc').textContent=fl.length+' items';document.getElementById('mag-tc').innerHTML='Toont '+fl.length+' van '+magItems.length}
function openMagM(id){var item=magItems.find(function(i){return i.id===id});if(!item)return;var sec=SEC[item.section]||{l:'',c:'#555e7d'};document.getElementById('m-title').textContent='Item #'+item.id;document.getElementById('m-cat').innerHTML='<span class="cb" style="background:'+sec.c+'1a;color:'+sec.c+'">'+sec.l+'</span>';document.getElementById('m-fields').innerHTML=[['Omschrijving',item.description],['Project',item.projectNumber],['Referentie',item.reference],['Serial',item.serial],['Leverancier',item.supplierId],['Datum',item.timestamp],['Door',item.createdBy]].map(function(e){return'<div><div class="mdl-lb">'+e[0]+'</div><div class="mdl-v">'+(e[1]||'‚Äî')+'</div></div>'}).join('');document.getElementById('m-photos').innerHTML='';document.getElementById('m-extra').innerHTML='';document.getElementById('modal').classList.add('show')}

// ‚ïê‚ïê‚ïê BEZOEKSRAPPORT ‚ïê‚ïê‚ïê
function renderBR(){var s=(document.getElementById('br-search').value||'').toLowerCase(),f=document.getElementById('br-filter').value;var fl=brItems.filter(function(item){if(f&&!(item.completedTypes||[]).some(function(t){return t===f||t.startsWith(f+'-')}))return false;if(s){var v=[item.klantNaam||'',item.klantAdres||''].map(function(x){return x.toLowerCase()});if(!v.some(function(x){return x.includes(s)}))return false}return true});var tb=document.getElementById('br-tb');if(!fl.length)tb.innerHTML=emR(7,'üìã','Geen rapporten','Klik Ôºã Toevoegen om een rapport aan te maken');else tb.innerHTML=fl.map(function(item){var ph=cntPh(item._itemData);return'<tr><td style="font-weight:600">'+(item.klantNaam||'‚Äî')+'</td><td style="font-size:.8rem;color:var(--text2);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(item.klantAdres||'‚Äî')+'</td><td style="max-width:240px">'+tTags(item.completedTypes)+'</td><td class="mono" style="font-size:.76rem;color:var(--text2)">'+Object.keys(item._itemData||{}).length+'</td><td>'+phB(ph.t,ph.c)+'</td><td class="mono" style="font-size:.7rem;color:var(--text3);white-space:nowrap">'+fmt(item.updatedAt)+'</td><td style="white-space:nowrap;text-align:center"><div style="display:flex;align-items:center;gap:5px;justify-content:center"><button class="vb" onclick="openBRM(\''+item.id+'\')" title="Bekijken">'+EYE+'</button><button class="btn btn-s" onclick="askKlaar(\''+item.id+'\')" style="padding:5px 12px;font-size:.7rem;border-radius:6px">‚úÖ Klaar</button></div></td></tr>'}).join('');document.getElementById('br-rc').textContent=fl.length+' rapporten';document.getElementById('br-tc').innerHTML='Toont '+fl.length+' van '+brItems.length}
function openBRM(id){var item=brItems.find(function(i){return i.id===id});if(!item)return;document.getElementById('m-title').textContent=item.klantNaam||'Klant';document.getElementById('m-cat').innerHTML='<span style="font-size:.8rem;color:var(--text2)">'+(item.klantAdres||'')+'</span>';document.getElementById('m-fields').innerHTML=[['Klant',item.klantNaam],['Adres',item.klantAdres],['Aangemaakt',fmt(item.createdAt)],['Bijgewerkt',fmt(item.updatedAt)]].map(function(e){return'<div><div class="mdl-lb">'+e[0]+'</div><div class="mdl-v">'+(e[1]||'‚Äî')+'</div></div>'}).join('');document.getElementById('m-photos').innerHTML='';document.getElementById('m-extra').innerHTML=tTags(item.completedTypes);document.getElementById('modal').classList.add('show')}
function askKlaar(id){var item=brItems.find(function(i){return i.id===id});if(!item)return;pendingId=id;document.getElementById('confirm-sub').innerHTML='<strong>'+(item.klantNaam||'Klant')+'</strong> ‚Äî '+(item.klantAdres||'')+'<br><br>Dit rapport wordt verplaatst naar <strong>Projecten</strong>.';document.getElementById('confirm-modal').classList.add('show')}
async function doKlaar(){if(!pendingId)return;var idx=brItems.findIndex(function(i){return i.id===pendingId});if(idx===-1)return;var item=brItems[idx];var now=new Date().toISOString();
  try{
    // Build clean project doc
    var pjDoc={klantNaam:item.klantNaam||'',klantAdres:item.klantAdres||'',completedTypes:item.completedTypes||[],bronRapportId:item.id,bronType:'bezoekrapport',status:'nieuw',promotedAt:now,createdAt:item.createdAt||now,updatedAt:now};
    if(item.itemData)pjDoc.itemData=item.itemData;
    // Write to projecten
    var ref=await db.collection('projecten').add(pjDoc);
    // Delete from bezoekrapport
    await db.collection('bezoekrapport').doc(item._docId||item.id).delete();
    // Update local arrays
    pjDoc.id=ref.id;pjDoc._docId=ref.id;pjDoc._itemData=item._itemData||{};
    pjItems.unshift(pjDoc);brItems.splice(idx,1);
    toast('‚úÖ Project aangemaakt voor '+(item.klantNaam||'klant'));
  }catch(e){console.error(e);toast('‚ö†Ô∏è Fout: '+e.message);closeConfirm();return}
  closeConfirm();setBdg('br-badge',brItems.length);setBdg('pj-badge',pjItems.length);renderBR();renderPJ();renderDash()}

// ‚ïê‚ïê‚ïê PROJECTEN ‚ïê‚ïê‚ïê
function renderPJ(){var s=(document.getElementById('pj-search').value||'').toLowerCase(),f=document.getElementById('pj-filter').value;var fl=pjItems.filter(function(item){if(f&&item.status!==f)return false;if(s){var v=[item.klantNaam||'',item.klantAdres||''].map(function(x){return x.toLowerCase()});if(!v.some(function(x){return x.includes(s)}))return false}return true});var tb=document.getElementById('pj-tb');if(!fl.length)tb.innerHTML=emR(7,'üìÅ','Geen projecten','Markeer een rapport als "Klaar" om een project aan te maken');else tb.innerHTML=fl.map(function(item){return'<tr><td style="font-weight:600">'+(item.klantNaam||'‚Äî')+'</td><td style="font-size:.8rem;color:var(--text2);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(item.klantAdres||'‚Äî')+'</td><td style="max-width:200px">'+tTags(item.completedTypes)+'</td><td><select style="font-size:.72rem;padding:4px 22px 4px 6px;border-radius:6px;min-width:90px" onchange="chgPJSt(\''+item.id+'\',this.value)"><option value="nieuw"'+(item.status==='nieuw'?' selected':'')+'>Nieuw</option><option value="gepland"'+(item.status==='gepland'?' selected':'')+'>Gepland</option><option value="bezig"'+(item.status==='bezig'?' selected':'')+'>Bezig</option><option value="afgerond"'+(item.status==='afgerond'?' selected':'')+'>Afgerond</option></select></td><td class="mono" style="font-size:.7rem;color:var(--text3);white-space:nowrap">'+fmt(item.promotedAt||item.createdAt)+'</td><td style="text-align:center;white-space:nowrap"><button class="btn" style="padding:4px 10px;font-size:.68rem;margin-right:4px" onclick="sendTo(\'montage\',\''+item.id+'\')">üîß Montage</button><button class="btn" style="padding:4px 10px;font-size:.68rem" onclick="sendTo(\'service\',\''+item.id+'\')">üõ†Ô∏è Service</button></td><td><button class="vb" onclick="openPJM(\''+item.id+'\')">'+EYE+'</button></td></tr>'}).join('');document.getElementById('pj-rc').textContent=fl.length+' projecten';document.getElementById('pj-tc').innerHTML='Toont '+fl.length+' van '+pjItems.length}
function openPJM(id){var item=pjItems.find(function(i){return i.id===id});if(!item)return;document.getElementById('m-title').textContent='üìÅ '+(item.klantNaam||'');document.getElementById('m-cat').innerHTML='<span style="font-size:.8rem;color:var(--text2)">'+(item.klantAdres||'')+'</span>';document.getElementById('m-fields').innerHTML=[['Klant',item.klantNaam],['Adres',item.klantAdres],['Status',(ST[item.status]||{}).l||''],['Project datum',fmt(item.promotedAt)]].map(function(e){return'<div><div class="mdl-lb">'+e[0]+'</div><div class="mdl-v">'+(e[1]||'‚Äî')+'</div></div>'}).join('');document.getElementById('m-photos').innerHTML='';document.getElementById('m-extra').innerHTML=tTags(item.completedTypes);document.getElementById('modal').classList.add('show')}

// ‚ïê‚ïê‚ïê MONTAGE / SERVICE / ONDERHOUD ‚ïê‚ïê‚ïê
function renderMT(){var s=(document.getElementById('mt-search').value||'').toLowerCase(),f=document.getElementById('mt-filter').value;var fl=mtItems.filter(function(i){if(f&&i.status!==f)return false;if(s){var v=[i.klantNaam||'',i.klantAdres||'',i.team||''].map(function(x){return x.toLowerCase()});if(!v.some(function(x){return x.includes(s)}))return false}return true});var tb=document.getElementById('mt-tb');if(!fl.length)tb.innerHTML=emR(8,'üîß','Geen opdrachten','Klik Ôºã Toevoegen of stuur door vanuit Projecten');else tb.innerHTML=fl.map(function(i){var ph=cntPh(i._itemData);return'<tr><td style="font-weight:600">'+(i.klantNaam||'‚Äî')+'</td><td style="font-size:.8rem;color:var(--text2)">'+(i.klantAdres||'‚Äî')+'</td><td>'+itB(i.installatieType)+'</td><td style="font-size:.8rem;color:var(--text2)">'+(i.team||'‚Äî')+'</td><td><select style="font-size:.72rem;padding:4px 22px 4px 6px;border-radius:6px;min-width:90px" onchange="chgSt(mtItems,\''+i.id+'\',this.value,\'mt\')"><option value="gepland"'+(i.status==='gepland'?' selected':'')+'>Gepland</option><option value="bezig"'+(i.status==='bezig'?' selected':'')+'>Bezig</option><option value="wacht"'+(i.status==='wacht'?' selected':'')+'>Wacht</option><option value="afgerond"'+(i.status==='afgerond'?' selected':'')+'>Afgerond</option></select></td><td class="mono" style="font-size:.7rem;color:var(--text3)">'+fmt(i.geplandeDatum||i.updatedAt)+'</td><td>'+phB(ph.t,ph.c)+'</td><td><button class="vb" onclick="openGenM(\'montage\',\''+i.id+'\')">'+EYE+'</button></td></tr>'}).join('');document.getElementById('mt-rc').textContent=fl.length;document.getElementById('mt-tc').textContent='Toont '+fl.length+' van '+mtItems.length}
function renderSV(){var s=(document.getElementById('sv-search').value||'').toLowerCase(),f=document.getElementById('sv-filter').value,p=document.getElementById('sv-prio').value;var fl=svItems.filter(function(i){if(f&&i.status!==f)return false;if(p&&i.prioriteit!==p)return false;if(s){var v=[i.klantNaam||'',i.klantAdres||'',i.probleem||''].map(function(x){return x.toLowerCase()});if(!v.some(function(x){return x.includes(s)}))return false}return true});var tb=document.getElementById('sv-tb');if(!fl.length)tb.innerHTML=emR(9,'üõ†Ô∏è','Geen tickets','Klik Ôºã Toevoegen of stuur door vanuit Projecten');else tb.innerHTML=fl.map(function(i){var ph=cntPh(i._itemData);return'<tr><td style="font-weight:600">'+(i.klantNaam||'‚Äî')+'</td><td style="font-size:.8rem;color:var(--text2)">'+(i.klantAdres||'‚Äî')+'</td><td style="font-size:.8rem">'+(i.probleem||'‚Äî')+'</td><td>'+itB(i.installatieType)+'</td><td>'+prB(i.prioriteit)+'</td><td><select style="font-size:.72rem;padding:4px 22px 4px 6px;border-radius:6px;min-width:90px" onchange="chgSt(svItems,\''+i.id+'\',this.value,\'sv\')"><option value="open"'+(i.status==='open'?' selected':'')+'>Open</option><option value="bezig"'+(i.status==='bezig'?' selected':'')+'>Bezig</option><option value="wacht"'+(i.status==='wacht'?' selected':'')+'>Wacht</option><option value="afgerond"'+(i.status==='afgerond'?' selected':'')+'>Afgerond</option></select></td><td class="mono" style="font-size:.7rem;color:var(--text3)">'+fmt(i.updatedAt)+'</td><td>'+phB(ph.t,ph.c)+'</td><td><button class="vb" onclick="openGenM(\'service\',\''+i.id+'\')">'+EYE+'</button></td></tr>'}).join('');document.getElementById('sv-rc').textContent=fl.length;document.getElementById('sv-tc').textContent='Toont '+fl.length+' van '+svItems.length}
function renderOH(){var s=(document.getElementById('oh-search').value||'').toLowerCase(),f=document.getElementById('oh-filter').value;var fl=ohItems.filter(function(i){if(f&&i.status!==f)return false;if(s){var v=[i.klantNaam||'',i.klantAdres||''].map(function(x){return x.toLowerCase()});if(!v.some(function(x){return x.includes(s)}))return false}return true});var tb=document.getElementById('oh-tb');if(!fl.length)tb.innerHTML=emR(9,'üîÑ','Geen contracten','Klik Ôºã Toevoegen');else tb.innerHTML=fl.map(function(i){var ph=cntPh(i._itemData);return'<tr><td style="font-weight:600">'+(i.klantNaam||'‚Äî')+'</td><td style="font-size:.8rem;color:var(--text2)">'+(i.klantAdres||'‚Äî')+'</td><td>'+itB(i.installatieType)+'</td><td class="mono" style="font-size:.76rem;color:var(--text2)">'+(i.contractNr||'‚Äî')+'</td><td class="mono" style="font-size:.7rem;color:var(--text3)">'+fmt(i.laatsteBeurt)+'</td><td class="mono" style="font-size:.7rem;color:var(--text3)">'+fmt(i.volgendeBeurt)+'</td><td><select style="font-size:.72rem;padding:4px 22px 4px 6px;border-radius:6px;min-width:90px" onchange="chgSt(ohItems,\''+i.id+'\',this.value,\'oh\')"><option value="actief"'+(i.status==='actief'?' selected':'')+'>Actief</option><option value="verlopen"'+(i.status==='verlopen'?' selected':'')+'>Verlopen</option><option value="gepland"'+(i.status==='gepland'?' selected':'')+'>Gepland</option><option value="uitgevoerd"'+(i.status==='uitgevoerd'?' selected':'')+'>Uitgevoerd</option></select></td><td>'+phB(ph.t,ph.c)+'</td><td><button class="vb" onclick="openGenM(\'onderhoud\',\''+i.id+'\')">'+EYE+'</button></td></tr>'}).join('');document.getElementById('oh-rc').textContent=fl.length;document.getElementById('oh-tc').textContent='Toont '+fl.length+' van '+ohItems.length}
function openGenM(mod,id){var list={montage:mtItems,service:svItems,onderhoud:ohItems}[mod]||[];var item=list.find(function(i){return i.id===id});if(!item)return;document.getElementById('m-title').textContent=({montage:'üîß',service:'üõ†Ô∏è',onderhoud:'üîÑ'}[mod]||'')+' '+(item.klantNaam||'');document.getElementById('m-cat').innerHTML='<span style="font-size:.8rem;color:var(--text2)">'+(item.klantAdres||'')+'</span>';var f=[['Klant',item.klantNaam],['Adres',item.klantAdres]];if(item.installatieType)f.push(['Type',IT[item.installatieType]||item.installatieType]);if(item.team)f.push(['Team',item.team]);if(item.probleem)f.push(['Probleem',item.probleem]);if(item.prioriteit)f.push(['Prioriteit',(PR[item.prioriteit]||{}).l||'']);if(item.contractNr)f.push(['Contract',item.contractNr]);if(item.status)f.push(['Status',(ST[item.status]||{}).l||'']);document.getElementById('m-fields').innerHTML=f.map(function(e){return'<div><div class="mdl-lb">'+e[0]+'</div><div class="mdl-v">'+(e[1]||'‚Äî')+'</div></div>'}).join('');document.getElementById('m-photos').innerHTML='';document.getElementById('m-extra').innerHTML='';document.getElementById('modal').classList.add('show')}

// ‚ïê‚ïê‚ïê ADD FORMS ‚ïê‚ïê‚ïê
// Doorsturen: Project ‚Üí Montage of Service (pre-filled klantdata)
async function sendTo(target,pjId){
  var item=pjItems.find(function(i){return i.id===pjId});if(!item)return;
  var now=new Date().toISOString();
  var type=(item.completedTypes||[])[0]||'solar';
  try{
    if(target==='montage'){
      var doc={klantNaam:item.klantNaam||'',klantAdres:item.klantAdres||'',installatieType:type,team:'',status:'gepland',geplandeDatum:now,updatedAt:now,bronProjectId:pjId};
      var ref=await db.collection('montage').add(doc);
      doc.id=ref.id;doc._docId=ref.id;doc._itemData=item._itemData||{};
      mtItems.unshift(doc);setBdg('mt-badge',mtItems.length);renderMT();
      toast('üîß Montage aangemaakt voor '+(item.klantNaam||'klant'));
    }else{
      var doc={klantNaam:item.klantNaam||'',klantAdres:item.klantAdres||'',installatieType:type,probleem:'',prioriteit:'normaal',status:'open',updatedAt:now,bronProjectId:pjId};
      var ref=await db.collection('service').add(doc);
      doc.id=ref.id;doc._docId=ref.id;doc._itemData=item._itemData||{};
      svItems.unshift(doc);setBdg('sv-badge',svItems.length);renderSV();
      toast('üõ†Ô∏è Service-ticket aangemaakt voor '+(item.klantNaam||'klant'));
    }
    // Update project status in Firestore
    item.status='bezig';
    await db.collection('projecten').doc(item._docId||item.id).update({status:'bezig',updatedAt:now});
    renderPJ();renderDash();
    go(document.querySelector('[data-tab='+target+']'));
  }catch(e){console.error(e);toast('‚ö†Ô∏è Fout: '+e.message)}
}
// Status wijzigen: Projecten
function chgPJSt(id,val){var item=pjItems.find(function(i){return i.id===id});if(item){item.status=val;item.updatedAt=new Date().toISOString();db.collection('projecten').doc(item._docId||item.id).update({status:val,updatedAt:item.updatedAt}).catch(function(e){console.error(e)});toast('üìÅ Status ‚Üí '+(ST[val]||{}).l);renderDash()}}
// Status wijzigen: generic (montage/service/onderhoud)
var COL_MAP={mt:'montage',sv:'service',oh:'onderhoud'};
function chgSt(list,id,val,prefix){var item=list.find(function(i){return i.id===id});if(item){item.status=val;item.updatedAt=new Date().toISOString();var col=COL_MAP[prefix];if(col)db.collection(col).doc(item._docId||item.id).update({status:val,updatedAt:item.updatedAt}).catch(function(e){console.error(e)});toast('‚úÖ Status ‚Üí '+(ST[val]||{}).l);renderDash()}}
var typeOpts='<option value="solar">‚òÄÔ∏è Zonnepanelen</option><option value="airmo">üå°Ô∏è Airco Mono</option><option value="airmu">üå°Ô∏è Airco Multi</option><option value="airwater">üíß Lucht/Water</option><option value="geo">üåç Geothermie</option><option value="charge">‚ö° Laadpaal</option><option value="batterij">üîã Thuisbatterij</option>';
var catOpts='<option value="paars">üü£ Spare part ‚Äî Stock</option><option value="oranje">üü† Spare part ‚Äî Interventie</option><option value="geel">üü° Niet volledig</option><option value="rood">üî¥ Beschadigd / Retour lev.</option><option value="blauw">üîµ Retour van werf</option><option value="roze">ü©∑ Verbruikte spare parts</option>';
var ADD_TITLES={magazijn:'üì¶ Magazijn',bezoeksrapport:'üìã Bezoeksrapport',montage:'üîß Montage-opdracht toevoegen',service:'üõ†Ô∏è Service-ticket toevoegen',onderhoud:'üîÑ Onderhoudscontract toevoegen'};
function togChk(el){el.classList.toggle('on');if(addMod==='bezoeksrapport')updateBRFields()}
function gv(id){var e=document.getElementById(id);return e?e.value.trim():''}

// Apps that have a full mobile version ‚Äî open in new tab
var APP_URLS={
  bezoeksrapport:'bezoekrapport.html',
  magazijn:'plenion-magazijn__9_.html'
};
function openAdd(mod){
  // Bezoeksrapport & Magazijn: open the real mobile app
  if(APP_URLS[mod]){window.open(APP_URLS[mod],'_blank');return}
  // Other modules: simple form
  addMod=mod;
  document.getElementById('add-title').textContent=ADD_TITLES[mod]||'Toevoegen';
  document.getElementById('add-form').innerHTML=buildForm(mod);
  document.getElementById('add-modal').classList.add('show');
}

function buildForm(mod){
  if(mod==='montage') return '<div class="fg-row"><div class="fg"><label>Klantnaam <span style="color:var(--danger)">*</span></label><input id="af-klant" placeholder="Jan Peeters"></div><div class="fg"><label>Adres <span style="color:var(--danger)">*</span></label><input id="af-adres" placeholder="Straat nr, postcode Stad"></div></div>'+
    '<div class="fg-row"><div class="fg"><label>Type installatie <span style="color:var(--danger)">*</span></label><select id="af-type">'+typeOpts+'</select></div><div class="fg"><label>Team</label><select id="af-team"><option>Team Alpha</option><option>Team Bravo</option><option>Team Charlie</option></select></div></div>'+
    '<div class="fg-row"><div class="fg"><label>Status</label><select id="af-status"><option value="gepland">Gepland</option><option value="bezig">Bezig</option></select></div><div class="fg"><label>Geplande datum</label><input id="af-datum" type="date"></div></div>'+
    '<div class="fg"><label>Notities montage</label><textarea id="af-notes" placeholder="Bijzonderheden voor het team..."></textarea></div>';

  if(mod==='service') return '<div class="fg-row"><div class="fg"><label>Klantnaam <span style="color:var(--danger)">*</span></label><input id="af-klant" placeholder="Jan Peeters"></div><div class="fg"><label>Adres <span style="color:var(--danger)">*</span></label><input id="af-adres" placeholder="Straat nr, postcode Stad"></div></div>'+
    '<div class="fg"><label>Probleem omschrijving <span style="color:var(--danger)">*</span></label><textarea id="af-probleem" placeholder="Beschrijf het probleem zo gedetailleerd mogelijk..."></textarea></div>'+
    '<div class="fg-row"><div class="fg"><label>Type installatie</label><select id="af-type">'+typeOpts+'</select></div><div class="fg"><label>Prioriteit</label><select id="af-prio"><option value="hoog">üî¥ Hoog</option><option value="normaal" selected>üü° Normaal</option><option value="laag">‚ö™ Laag</option></select></div></div>'+
    '<div class="fg"><label>Foutcode (optioneel)</label><input id="af-fout" placeholder="Bijv. F31, E15..."></div>'+
    '<div class="fg"><label>Notities</label><textarea id="af-notes" placeholder="Extra info voor de technieker..."></textarea></div>';

  if(mod==='onderhoud') return '<div class="fg-row"><div class="fg"><label>Klantnaam <span style="color:var(--danger)">*</span></label><input id="af-klant" placeholder="Jan Peeters"></div><div class="fg"><label>Adres <span style="color:var(--danger)">*</span></label><input id="af-adres" placeholder="Straat nr, postcode Stad"></div></div>'+
    '<div class="fg-row"><div class="fg"><label>Type installatie</label><select id="af-type">'+typeOpts+'</select></div><div class="fg"><label>Contractnummer</label><input id="af-contr" placeholder="OC-2026-..."></div></div>'+
    '<div class="fg-row"><div class="fg"><label>Status</label><select id="af-status"><option value="actief">Actief</option><option value="gepland">Gepland</option></select></div><div class="fg"><label>Volgende beurt</label><input id="af-datum" type="date"></div></div>'+
    '<div class="fg"><label>Notities</label><textarea id="af-notes" placeholder="Onderhoudsinstructies..."></textarea></div>';
  return '';
}

async function submitAdd(){
  var now=new Date().toISOString();
  try{
  if(addMod==='montage'){
    if(!gv('af-klant')){toast('‚ö†Ô∏è Vul een klantnaam in');return}
    var doc={klantNaam:gv('af-klant'),klantAdres:gv('af-adres'),installatieType:gv('af-type'),team:gv('af-team'),status:gv('af-status'),geplandeDatum:gv('af-datum')?new Date(gv('af-datum')).toISOString():now,updatedAt:now,notities:gv('af-notes')};
    var ref=await db.collection('montage').add(doc);
    doc.id=ref.id;doc._docId=ref.id;doc._itemData={};
    mtItems.unshift(doc);setBdg('mt-badge',mtItems.length);renderMT();
  }else if(addMod==='service'){
    if(!gv('af-klant')){toast('‚ö†Ô∏è Vul een klantnaam in');return}
    if(!gv('af-probleem')){toast('‚ö†Ô∏è Beschrijf het probleem');return}
    var doc={klantNaam:gv('af-klant'),klantAdres:gv('af-adres'),probleem:gv('af-probleem'),installatieType:gv('af-type'),prioriteit:gv('af-prio'),status:'open',foutcode:gv('af-fout'),notities:gv('af-notes'),updatedAt:now};
    var ref=await db.collection('service').add(doc);
    doc.id=ref.id;doc._docId=ref.id;doc._itemData={};
    svItems.unshift(doc);setBdg('sv-badge',svItems.length);renderSV();
  }else if(addMod==='onderhoud'){
    if(!gv('af-klant')){toast('‚ö†Ô∏è Vul een klantnaam in');return}
    var doc={klantNaam:gv('af-klant'),klantAdres:gv('af-adres'),installatieType:gv('af-type'),contractNr:gv('af-contr'),status:gv('af-status'),volgendeBeurt:gv('af-datum')?new Date(gv('af-datum')).toISOString():'',laatsteBeurt:'',notities:gv('af-notes'),updatedAt:now};
    var ref=await db.collection('onderhoud').add(doc);
    doc.id=ref.id;doc._docId=ref.id;doc._itemData={};
    ohItems.unshift(doc);setBdg('oh-badge',ohItems.length);renderOH();
  }
  toast('‚úÖ Toegevoegd!');closeAdd();renderDash();
  }catch(e){console.error(e);toast('‚ö†Ô∏è Fout: '+e.message)}
}

// ‚ïê‚ïê‚ïê FIREBASE DATA LOADING ‚ïê‚ïê‚ïê
async function loadAll(){
  try{
    // Magazijn
    var magSnap=await db.collection('magazijn').orderBy('timestamp','desc').get();
    magItems=[];magSnap.forEach(function(doc){var d=doc.data();d._docId=doc.id;magItems.push(d)});

    // Bezoeksrapport
    var brSnap=await db.collection('bezoekrapport').orderBy('updatedAt','desc').get();
    brItems=[];brSnap.forEach(function(doc){
      var d=doc.data();d.id=doc.id;d._docId=doc.id;
      // Parse itemData JSON string if present
      if(typeof d.itemData==='string'){try{d._itemData=JSON.parse(d.itemData)}catch(e){d._itemData={}}}
      else d._itemData=d.itemData||{};
      brItems.push(d);
    });

    // Projecten
    var pjSnap=await db.collection('projecten').orderBy('promotedAt','desc').get();
    pjItems=[];pjSnap.forEach(function(doc){
      var d=doc.data();d.id=doc.id;d._docId=doc.id;
      if(typeof d.itemData==='string'){try{d._itemData=JSON.parse(d.itemData)}catch(e){d._itemData={}}}
      else d._itemData=d.itemData||{};
      pjItems.push(d);
    });

    // Montage
    var mtSnap=await db.collection('montage').orderBy('updatedAt','desc').get();
    mtItems=[];mtSnap.forEach(function(doc){var d=doc.data();d.id=doc.id;d._docId=doc.id;d._itemData=d._itemData||{};mtItems.push(d)});

    // Service
    var svSnap=await db.collection('service').orderBy('updatedAt','desc').get();
    svItems=[];svSnap.forEach(function(doc){var d=doc.data();d.id=doc.id;d._docId=doc.id;d._itemData=d._itemData||{};svItems.push(d)});

    // Onderhoud
    var ohSnap=await db.collection('onderhoud').orderBy('updatedAt','desc').get();
    ohItems=[];ohSnap.forEach(function(doc){var d=doc.data();d.id=doc.id;d._docId=doc.id;d._itemData=d._itemData||{};ohItems.push(d)});

  }catch(e){
    console.error('Firebase load error:',e);
    toast('‚ö†Ô∏è Fout bij laden: '+e.message);
  }
  // Update badges & render
  setBdg('mag-badge',magItems.length);setBdg('br-badge',brItems.length);setBdg('pj-badge',pjItems.length);setBdg('mt-badge',mtItems.length);setBdg('sv-badge',svItems.length);setBdg('oh-badge',ohItems.length);
  renderDash();
}
loadAll();
</script>
</body>
</html>
