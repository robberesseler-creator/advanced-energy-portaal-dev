<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Energy ‚Äî Plenion Dashboard</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='url(%23g)'/><defs><linearGradient id='g' x1='0' y1='0' x2='32' y2='32'><stop stop-color='%234f8ef7'/><stop offset='1' stop-color='%2338d9a9'/></linearGradient></defs><text x='16' y='22' text-anchor='middle' fill='white' font-size='14' font-weight='bold' font-family='sans-serif'>AE</text></svg>">
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap');
:root{
  --bg:#0f1117;--surface:#181c27;--surface2:#1e2336;--header:#000;
  --accent:#4f8ef7;--accent2:#38d9a9;
  --success:#38d9a9;--danger:#ff5c5c;--warn:#f7c948;
  --text:#e8ecf5;--text2:#8b92b0;--text3:#555e7d;
  --border:#2a2f45;--border-h:#3d4460;
  --r:12px;--rs:8px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* SIDEBAR */
.sb{width:256px;background:var(--surface);border-right:1px solid var(--border);position:fixed;top:0;bottom:0;left:0;z-index:100;display:flex;flex-direction:column;}
.sb-logo{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:11px;}
.sb-logo-icon{width:34px;height:34px;border-radius:6px;background:linear-gradient(135deg,#4f8ef7,#38d9a9);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:.72rem;}
.sb-nav{flex:1;padding:14px 10px;overflow-y:auto;}
.sb-sec{font-family:'DM Mono',monospace;font-size:.5rem;text-transform:uppercase;letter-spacing:3px;color:var(--text3);padding:12px 12px 6px;}
.ni{display:flex;align-items:center;gap:11px;padding:9px 12px;border-radius:var(--rs);color:var(--text2);cursor:pointer;font-size:.86rem;font-weight:500;margin-bottom:2px;position:relative;transition:all .15s;user-select:none;}
.ni:hover{background:rgba(79,142,247,.06);}
.ni.a{background:rgba(79,142,247,.1);color:var(--accent);font-weight:600;}
.ni.a::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:18px;background:var(--accent);border-radius:0 2px 2px 0;}
.ni-badge{background:var(--accent);color:#fff;font-size:.62rem;font-weight:700;padding:1px 7px;border-radius:10px;min-width:20px;text-align:center;}
.sb-user{padding:14px 18px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.sb-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,rgba(79,142,247,.2),rgba(56,217,169,.2));color:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.68rem;}

/* MAIN */
.mn{margin-left:256px;flex:1;position:relative;}
.hd{height:56px;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 28px;gap:14px;background:var(--header);position:sticky;top:0;z-index:50;}
.hd-title{flex:1;font-size:1rem;font-weight:700;}
.hd-sub{color:var(--text3);font-weight:400;font-size:.8rem;margin-left:8px;}
.live{display:flex;align-items:center;gap:7px;margin-right:14px;}
.live-dot{width:8px;height:8px;background:var(--success);border-radius:50%;box-shadow:0 0 8px rgba(56,217,169,.5);animation:pulse 2s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.cnt{padding:24px 28px;}
.mono{font-family:'DM Mono',monospace;}

/* STAT CARDS (dashboard) */
.ds-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
.ds-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:18px 20px;position:relative;overflow:hidden;}
.ds-card .bar{position:absolute;top:0;left:0;width:3px;height:100%;border-radius:0 2px 2px 0;opacity:.7;}
.ds-label{font-family:'DM Mono',monospace;font-size:.52rem;text-transform:uppercase;letter-spacing:2px;color:var(--text3);margin-bottom:6px;}
.ds-val{font-size:1.85rem;font-weight:700;letter-spacing:-1px;line-height:1;margin-bottom:4px;}
.ds-sub{font-size:.7rem;color:var(--text3);}

/* CATEGORY CARDS */
.cat-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:24px;}
.cc{background:var(--surface);border:2px solid var(--border);border-radius:var(--r);padding:16px 12px;text-align:center;cursor:pointer;transition:all .2s;}
.cc:hover{border-color:var(--border-h);transform:translateY(-2px);}
.cc.a{border-width:2px;}
.cc-bar{width:100%;height:4px;border-radius:2px;margin-bottom:10px;}
.cc-num{font-size:1.6rem;font-weight:700;font-family:'DM Mono',monospace;line-height:1;}
.cc-label{font-size:.6rem;color:var(--text2);margin-top:6px;line-height:1.3;}

/* FILTERS */
.fl{display:flex;align-items:center;gap:10px;margin-bottom:18px;flex-wrap:wrap;}
.sr{position:relative;flex:0 0 280px;}
.sr svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);}
.sr input{width:100%;padding-left:34px;}
input,select{background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.83rem;padding:10px 12px;outline:none;}
input:focus{border-color:var(--accent);}
select{color:var(--text2);font-size:.8rem;cursor:pointer;appearance:none;padding-right:30px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23555e7d' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 9px center;}
.btn{padding:8px 14px;border-radius:var(--rs);border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;font-size:.8rem;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .15s;}
.btn:hover{border-color:var(--border-h);color:var(--text);}
.btn-p{background:linear-gradient(135deg,#4f8ef7,#3a7de8);border:none;color:#fff;}
.btn-p:hover{opacity:.9;}

/* TABLE */
.tw{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.ts{overflow-x:auto;}
table{width:100%;border-collapse:collapse;min-width:1000px;}
th{padding:12px 14px;font-family:'DM Mono',monospace;font-size:.55rem;text-transform:uppercase;letter-spacing:2px;color:var(--text3);text-align:left;border-bottom:1px solid var(--border);background:rgba(0,0,0,.15);white-space:nowrap;}
td{padding:12px 14px;}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
tbody tr:hover{background:rgba(79,142,247,.02);}
.tf{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-top:1px solid var(--border);font-size:.76rem;color:var(--text3);}

/* BADGES */
.cb{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:6px;font-size:.68rem;font-weight:600;}
.cd{width:7px;height:7px;border-radius:50%;display:inline-block;}
.sd{display:inline-flex;align-items:center;gap:5px;font-size:.76rem;}
.pb{display:inline-block;padding:2px 7px;border-radius:5px;font-size:.68rem;font-weight:600;}
.tag{display:inline-block;padding:2px 7px;border-radius:5px;font-size:.68rem;font-weight:600;margin-right:3px;}

/* VIEW BTN */
.vb{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--surface2);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text3);transition:all .15s;}
.vb:hover{border-color:var(--border-h);color:var(--text);background:rgba(255,255,255,.05);}

/* MODAL */
.mbg{position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);}
.mbg.show{display:flex;}
.mdl{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:640px;width:92%;max-height:85vh;overflow:auto;}
.mdl-h{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;}
.mdl-x{background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);font-size:16px;}
.mdl-g{display:grid;grid-template-columns:1fr 1fr;gap:14px;font-size:.85rem;margin-bottom:20px;}
.mdl-lb{font-family:'DM Mono',monospace;font-size:.55rem;text-transform:uppercase;letter-spacing:2px;color:var(--text3);margin-bottom:4px;}
.mdl-v{color:var(--text);font-weight:500;}
.ps{margin-bottom:16px;}
.ps-t{font-family:'DM Mono',monospace;font-size:.55rem;text-transform:uppercase;letter-spacing:2px;color:var(--text3);margin-bottom:8px;}
.pg{display:flex;gap:8px;flex-wrap:wrap;}
.pt{width:110px;height:110px;object-fit:cover;border-radius:var(--rs);border:1px solid var(--border);cursor:pointer;}
.pp{width:110px;height:110px;border-radius:var(--rs);border:2px dashed var(--border);background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:.65rem;color:var(--text3);text-align:center;padding:8px;}
.pt-ts{font-size:.58rem;color:var(--text3);margin-top:3px;max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.al{max-height:140px;overflow:auto;background:rgba(0,0,0,.2);border-radius:var(--rs);padding:10px;}
.ae{font-size:.7rem;color:var(--text2);margin-bottom:4px;display:flex;gap:8px;}
.at{color:var(--text3);font-family:'DM Mono',monospace;font-size:.62rem;flex-shrink:0;}

/* PANELS */
.pnl{display:none;}.pnl.a{display:block;}
.empty{text-align:center;padding:60px 20px;color:var(--text3);}
.empty-icon{font-size:48px;margin-bottom:12px;opacity:.5;}
.empty-title{font-size:1rem;font-weight:600;color:var(--text2);margin-bottom:6px;}
.empty-sub{font-size:.82rem;}
.coming{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:40px;text-align:center;}
.coming-icon{font-size:56px;margin-bottom:16px;}
.coming-title{font-size:1.1rem;font-weight:700;margin-bottom:8px;}
.coming-sub{color:var(--text2);font-size:.85rem;max-width:400px;margin:0 auto;}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sb">
  <div class="sb-logo">
    <div class="sb-logo-icon">AE</div>
    <div>
      <div style="font-weight:700;font-size:.88rem;letter-spacing:.3px">Advanced Energy</div>
      <div class="mono" style="font-size:.55rem;text-transform:uppercase;letter-spacing:2px;color:var(--text3)">Plenion</div>
    </div>
  </div>
  <div class="sb-nav">
    <div class="sb-sec">Overzicht</div>
    <div class="ni a" data-tab="dashboard" onclick="go(this)">
      <span>üìä</span><span style="flex:1">Dashboard</span>
    </div>

    <div class="sb-sec">Applicaties</div>
    <div class="ni" data-tab="magazijn" onclick="go(this)">
      <span>üì¶</span><span style="flex:1">Magazijn</span><span class="ni-badge" id="mag-badge">0</span>
    </div>
    <div class="ni" data-tab="bezoeksrapport" onclick="go(this)">
      <span>üìã</span><span style="flex:1">Bezoeksrapport</span><span class="ni-badge" id="br-badge" style="display:none">0</span>
    </div>
    <div class="ni" data-tab="daikin" onclick="go(this)">
      <span>‚úÖ</span><span style="flex:1">Daikin Checklist</span>
    </div>

    <div class="sb-sec">Beheer</div>
    <div class="ni" data-tab="instellingen" onclick="go(this)">
      <span>‚öôÔ∏è</span><span style="flex:1">Instellingen</span>
    </div>
  </div>
  <div class="sb-user">
    <div class="sb-avatar">AD</div>
    <div>
      <div style="font-size:.8rem;font-weight:600">Admin</div>
      <div class="mono" style="font-size:.58rem;color:var(--success);text-transform:uppercase;letter-spacing:1px">Online</div>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="mn">
  <header class="hd">
    <div class="hd-title" id="hd-t">üìä Dashboard <span class="hd-sub">‚Äî Overzicht</span></div>
    <div class="live"><span class="live-dot"></span><span class="mono" style="font-size:.58rem;text-transform:uppercase;letter-spacing:2px;color:var(--success)">Live</span></div>
    <button class="btn" onclick="loadMagazijn()">‚Üª Vernieuwen</button>
  </header>

  <div class="cnt">

    <!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
    <div class="pnl a" id="p-dashboard">
      <div class="ds-grid" id="ds-cards"></div>

      <h3 style="font-size:.9rem;font-weight:600;margin-bottom:14px;color:var(--text2)">Snelle links</h3>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;">
        <div onclick="go(document.querySelector('[data-tab=magazijn]'))" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:24px 20px;cursor:pointer;transition:all .2s;" onmouseover="this.style.borderColor='var(--border-h)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border)';this.style.transform='none'">
          <div style="font-size:32px;margin-bottom:10px">üì¶</div>
          <div style="font-weight:700;font-size:.9rem;margin-bottom:4px">Magazijn</div>
          <div style="font-size:.75rem;color:var(--text2)">Bekijk alle registraties, foto's en statussen</div>
        </div>
        <div onclick="go(document.querySelector('[data-tab=bezoeksrapport]'))" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:24px 20px;cursor:pointer;transition:all .2s;" onmouseover="this.style.borderColor='var(--border-h)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border)';this.style.transform='none'">
          <div style="font-size:32px;margin-bottom:10px">üìã</div>
          <div style="font-weight:700;font-size:.9rem;margin-bottom:4px">Bezoeksrapport</div>
          <div style="font-size:.75rem;color:var(--text2)">Ingezonden bezoeksrapporten bekijken</div>
        </div>
        <div onclick="go(document.querySelector('[data-tab=daikin]'))" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:24px 20px;cursor:pointer;transition:all .2s;" onmouseover="this.style.borderColor='var(--border-h)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border)';this.style.transform='none'">
          <div style="font-size:32px;margin-bottom:10px">‚úÖ</div>
          <div style="font-weight:700;font-size:.9rem;margin-bottom:4px">Daikin Checklist</div>
          <div style="font-size:.75rem;color:var(--text2)">Daikin checklists en inspecties</div>
        </div>
      </div>

      <h3 style="font-size:.9rem;font-weight:600;margin:24px 0 14px;color:var(--text2)">Laatste activiteit</h3>
      <div id="ds-activity" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:20px;">
        <div style="color:var(--text3);font-size:.82rem">Nog geen activiteit geladen</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê MAGAZIJN ‚ïê‚ïê‚ïê -->
    <div class="pnl" id="p-magazijn">
      <div class="cat-grid" id="cat-cards"></div>
      <div class="fl">
        <div class="sr">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input id="mag-search" placeholder="Zoeken op omschrijving, project, ref..." oninput="renderTable()">
        </div>
        <select id="mag-filter" onchange="renderTable()">
          <option value="">Alle Categorie√´n</option>
          <option value="paars">Spare part ‚Äî Stock</option>
          <option value="oranje">Spare part ‚Äî Interventie</option>
          <option value="geel">Niet volledig</option>
          <option value="rood">Beschadigd / Retour lev.</option>
          <option value="blauw">Retour van werf</option>
          <option value="roze">Verbruikte spare parts</option>
        </select>
        <div style="flex:1"></div>
        <span style="font-size:.75rem;color:var(--text3)" id="rc">0 items</span>
      </div>
      <div class="tw">
        <div class="ts"><table><thead><tr>
          <th>#</th><th>Categorie</th><th>Omschrijving</th><th>Project</th><th>Ref.</th><th>Serial</th><th>Status</th><th>Datum</th><th>Foto's</th><th></th>
        </tr></thead><tbody id="mag-tb"></tbody></table></div>
        <div class="tf"><div id="tc">Toont 0 van 0 items</div></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê BEZOEKSRAPPORT ‚ïê‚ïê‚ïê -->
    <div class="pnl" id="p-bezoeksrapport">
      <div class="fl">
        <div class="sr">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input id="br-search" placeholder="Zoeken op klant, adres, type..." oninput="renderBRTable()">
        </div>
        <select id="br-filter" onchange="renderBRTable()">
          <option value="">Alle types</option>
          <option value="solar">Zon / Thuisbatterij</option>
          <option value="airmo">Lucht/Lucht Mono</option>
          <option value="airmu">Lucht/Lucht Multi</option>
          <option value="airwater">Lucht/Water</option>
          <option value="geo">Geothermie</option>
          <option value="charge">Laadpaal</option>
        </select>
        <button class="btn" onclick="loadBezoeksrapporten()">‚Üª Vernieuwen</button>
        <div style="flex:1"></div>
        <span style="font-size:.75rem;color:var(--text3)" id="br-rc">0 rapporten</span>
      </div>
      <div class="tw">
        <div class="ts"><table><thead><tr>
          <th>Klant</th><th>Adres</th><th>Types</th><th>Items</th><th>Foto's</th><th>Datum</th><th></th>
        </tr></thead><tbody id="br-tb"></tbody></table></div>
        <div class="tf"><div id="br-tc">Toont 0 van 0 rapporten</div></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê DAIKIN CHECKLIST ‚ïê‚ïê‚ïê -->
    <div class="pnl" id="p-daikin">
      <div class="coming">
        <div class="coming-icon">‚úÖ</div>
        <div class="coming-title">Daikin Checklist</div>
        <div class="coming-sub">Hier komen de ingezonden Daikin checklists en inspecties. De data wordt automatisch opgehaald zodra het checklist-formulier gekoppeld is aan Firebase.</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê INSTELLINGEN ‚ïê‚ïê‚ïê -->
    <div class="pnl" id="p-instellingen">
      <div class="coming">
        <div class="coming-icon">‚öôÔ∏è</div>
        <div class="coming-title">Instellingen</div>
        <div class="coming-sub">Gebruikersbeheer, rollen, notificatie-instellingen en meer. Komt binnenkort beschikbaar.</div>
      </div>
    </div>

  </div>
</div>

<!-- DETAIL MODAL (Magazijn) -->
<div class="mbg" id="modal" onclick="closeModal()">
  <div class="mdl" onclick="event.stopPropagation()">
    <div class="mdl-h">
      <div><h3 style="font-size:1.1rem;font-weight:700;margin-bottom:6px" id="m-title"></h3><div id="m-cat"></div></div>
      <button class="mdl-x" onclick="closeModal()">‚úï</button>
    </div>
    <div class="mdl-g" id="m-fields"></div>
    <div id="m-photos"></div>
    <div id="m-audit"></div>
  </div>
</div>

<!-- DETAIL MODAL (Bezoeksrapport) -->
<div class="mbg" id="br-modal" onclick="closeBRModal()">
  <div class="mdl" style="max-width:760px" onclick="event.stopPropagation()">
    <div class="mdl-h">
      <div><h3 style="font-size:1.1rem;font-weight:700;margin-bottom:6px" id="br-m-title"></h3><div id="br-m-sub" style="font-size:.8rem;color:var(--text2)"></div></div>
      <button class="mdl-x" onclick="closeBRModal()">‚úï</button>
    </div>
    <div class="mdl-g" id="br-m-fields"></div>
    <div id="br-m-types"></div>
    <div id="br-m-items"></div>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" async></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyBKU-wCjV4Au4ngRG52Zmmxbzc3N3D8VBU",
  authDomain:"advanced-intranet.firebaseapp.com",
  projectId:"advanced-intranet",
  storageBucket:"advanced-intranet.firebasestorage.app",
  messagingSenderId:"309856938024",
  appId:"1:309856938024:web:2108715f92c5dea2da2d1d"
});
const db=firebase.firestore();

const SEC={
  paars:{label:'Spare part ‚Äî Stock',color:'#a78bfa',icon:'üü£'},
  oranje:{label:'Spare part ‚Äî Interventie',color:'#f97316',icon:'üü†'},
  geel:{label:'Niet volledig',color:'#f7c948',icon:'üü°'},
  rood:{label:'Beschadigd / Retour lev.',color:'#ff5c5c',icon:'üî¥'},
  blauw:{label:'Retour van werf',color:'#38b6ff',icon:'üîµ'},
  roze:{label:'Verbruikte spare parts',color:'#f472b6',icon:'ü©∑'}
};
const PL={photos:'üì¶ Product',artikelPhotos:'üîç Artikelnr',stickerPhotos:'üè∑Ô∏è Sticker',bonPhotos:'üìã Leverbon',schadePhotos:'‚ö†Ô∏è Schade',seriePhotos:'üî¢ Serienr'};
const PF=['photos','artikelPhotos','stickerPhotos','bonPhotos','schadePhotos','seriePhotos'];

let magItems=[];
let catFilter='';
const titles={dashboard:'üìä Dashboard <span class="hd-sub">‚Äî Overzicht</span>',magazijn:'üì¶ Magazijn <span class="hd-sub">‚Äî Alle registraties</span>',bezoeksrapport:'üìã Bezoeksrapport <span class="hd-sub">‚Äî Ingezonden rapporten</span>',daikin:'‚úÖ Daikin Checklist <span class="hd-sub">‚Äî Inspecties</span>',instellingen:'‚öôÔ∏è Instellingen <span class="hd-sub">‚Äî Configuratie</span>'};

// ‚ïê‚ïê NAVIGATION ‚ïê‚ïê
function go(el){
  const tab=el.dataset.tab;
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('a'));
  el.classList.add('a');
  document.querySelectorAll('.pnl').forEach(p=>p.classList.remove('a'));
  const p=document.getElementById('p-'+tab);
  if(p)p.classList.add('a');
  document.getElementById('hd-t').innerHTML=titles[tab]||tab;
  if(tab==='magazijn')loadMagazijn();
  if(tab==='bezoeksrapport')loadBezoeksrapporten();
  if(tab==='dashboard')renderDashboard();
}

// ‚ïê‚ïê DASHBOARD ‚ïê‚ïê
function renderDashboard(){
  const total=magItems.length;
  const cats=Object.entries(SEC).map(([k,v])=>({key:k,...v,count:magItems.filter(i=>i.section===k).length}));
  const open=magItems.filter(i=>!i.status||i.status==='open').length;
  const done=magItems.filter(i=>i.status==='afgehandeld').length;
  const withMail=magItems.filter(i=>i.emailSent).length;

  document.getElementById('ds-cards').innerHTML=[
    {label:'Totaal Items',value:total,color:'var(--accent)',sub:'In het magazijn'},
    {label:'Open',value:open,color:'var(--warn)',sub:'Nog af te handelen'},
    {label:'Mail Verstuurd',value:withMail,color:'#a78bfa',sub:'Wacht op leverancier'},
    {label:'Afgehandeld',value:done,color:'var(--success)',sub:'Afgerond'}
  ].map(s=>`<div class="ds-card"><div class="bar" style="background:${s.color}"></div><div class="ds-label">${s.label}</div><div class="ds-val" style="color:${s.color}">${s.value}</div><div class="ds-sub">${s.sub}</div></div>`).join('');

  // Last 5 activities
  const activities=[];
  magItems.forEach(item=>{
    if(item.audit){item.audit.forEach(a=>{activities.push({...a,itemId:item.id,desc:item.description});});}
  });
  activities.sort((a,b)=>(b.at||'').localeCompare(a.at||''));
  const last5=activities.slice(0,5);
  if(last5.length>0){
    document.getElementById('ds-activity').innerHTML=last5.map(a=>`<div style="display:flex;gap:10px;align-items:flex-start;padding:8px 0;border-bottom:1px solid var(--border)">
      <span class="mono" style="font-size:.65rem;color:var(--text3);flex-shrink:0;min-width:130px">${a.ts||''}</span>
      <span style="font-size:.82rem"><strong style="color:var(--text)">#${a.itemId}</strong> ${a.desc?'('+a.desc+')':''} ‚Äî üë§ ${a.user}: ${a.action}${a.details?' ‚Äî '+a.details:''}</span>
    </div>`).join('');
  }else{
    document.getElementById('ds-activity').innerHTML='<div style="color:var(--text3);font-size:.82rem;padding:10px">Nog geen activiteit</div>';
  }
}

// ‚ïê‚ïê LOAD MAGAZIJN ‚ïê‚ïê
async function loadMagazijn(){
  document.getElementById('mag-tb').innerHTML='<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text2)">‚è≥ Data laden uit Firebase...</td></tr>';
  try{
    const snap=await db.collection('magazijn').doc('items').get();
    if(snap.exists&&snap.data().items){
      magItems=JSON.parse(snap.data().items).filter(i=>!i.deleted);
    }else{magItems=[];}
  }catch(e){
    document.getElementById('mag-tb').innerHTML='<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--danger)">‚ö†Ô∏è Fout: '+e.message+'</td></tr>';
    return;
  }
  document.getElementById('mag-badge').textContent=magItems.length||'';
  renderCards();
  renderTable();
  renderDashboard();
}

// ‚ïê‚ïê CATEGORY CARDS ‚ïê‚ïê
function renderCards(){
  const el=document.getElementById('cat-cards');
  el.innerHTML=Object.entries(SEC).map(([key,cfg])=>{
    const count=magItems.filter(i=>i.section===key).length;
    const active=catFilter===key;
    return `<div class="cc${active?' a':''}" style="${active?'border-color:'+cfg.color+'88':''}" onclick="catFilter=catFilter==='${key}'?'':'${key}';document.getElementById('mag-filter').value=catFilter;renderCards();renderTable()">
      <div class="cc-bar" style="background:${cfg.color}"></div>
      <div class="cc-num" style="color:${cfg.color}">${count}</div>
      <div class="cc-label">${cfg.label}</div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê TABLE ‚ïê‚ïê
function renderTable(){
  const search=document.getElementById('mag-search').value.toLowerCase();
  const filter=document.getElementById('mag-filter').value||catFilter;
  const filtered=magItems.filter(i=>{
    if(filter&&i.section!==filter)return false;
    if(search){const d=(i.description||'').toLowerCase(),p=(i.projectNumber||'').toLowerCase(),r=(i.reference||'').toLowerCase(),s=(i.serial||'').toLowerCase();
      if(!d.includes(search)&&!p.includes(search)&&!r.includes(search)&&!s.includes(search))return false;}
    return true;
  });
  const tb=document.getElementById('mag-tb');
  if(!filtered.length){
    tb.innerHTML='<tr><td colspan="10" class="empty"><div class="empty-icon">üì¶</div><div class="empty-title">Geen items gevonden</div><div class="empty-sub">Pas je filters aan of voeg items toe via de Magazijn app</div></td></tr>';
  }else{
    tb.innerHTML=filtered.map(item=>{
      const sec=SEC[item.section]||{label:item.section,color:'#555e7d'};
      const tp=PF.reduce((s,f)=>s+(item[f]?.length||0),0);
      const hc=PF.some(f=>item[f]?.some(p=>p.storageUrl));
      const sc=item.status==='afgehandeld'?'var(--success)':item.emailSent?'var(--warn)':'var(--accent)';
      const st=item.status==='afgehandeld'?'Afgehandeld':item.emailSent?'Mail':'Open';
      return `<tr>
        <td class="mono" style="font-size:.76rem;color:var(--text3)">${item.id}</td>
        <td><span class="cb" style="background:${sec.color}1a;color:${sec.color}"><span class="cd" style="background:${sec.color}"></span>${sec.label}</span></td>
        <td style="font-weight:600;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${item.description||'‚Äî'}</td>
        <td class="mono" style="font-size:.76rem;color:var(--text2)">${item.projectNumber||'‚Äî'}</td>
        <td style="font-size:.8rem;color:var(--text2)">${item.reference||'‚Äî'}</td>
        <td class="mono" style="font-size:.72rem;color:var(--text2)">${item.serial||'‚Äî'}</td>
        <td><span class="sd"><span class="cd" style="background:${sc}"></span>${st}</span></td>
        <td class="mono" style="font-size:.7rem;color:var(--text3);white-space:nowrap">${item.timestamp||'‚Äî'}</td>
        <td>${tp>0?`<span class="pb" style="background:${hc?'rgba(56,217,169,.12)':'rgba(139,146,176,.1)'};color:${hc?'var(--success)':'var(--text2)'}">üì∑ ${tp}${hc?' ‚òÅÔ∏è':''}</span>`:'‚Äî'}</td>
        <td><button class="vb" onclick="openModal(${item.id})" title="Bekijken"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></td>
      </tr>`;
    }).join('');
  }
  document.getElementById('rc').textContent=filtered.length+' items';
  document.getElementById('tc').innerHTML=`Toont <strong style="color:var(--text2)">${filtered.length}</strong> van <strong style="color:var(--text2)">${magItems.length}</strong> items`;
}

// ‚ïê‚ïê DETAIL MODAL ‚ïê‚ïê
function openModal(id){
  const item=magItems.find(i=>i.id===id);if(!item)return;
  const sec=SEC[item.section]||{label:item.section,color:'#555e7d'};
  document.getElementById('m-title').textContent='Item #'+item.id;
  document.getElementById('m-cat').innerHTML=`<span class="cb" style="background:${sec.color}1a;color:${sec.color}"><span class="cd" style="background:${sec.color}"></span>${sec.label}</span>`;
  const sc=item.status==='afgehandeld'?'var(--success)':item.emailSent?'var(--warn)':'var(--accent)';
  const st=item.status==='afgehandeld'?'‚úÖ Afgehandeld':item.emailSent?'üìß Mail verstuurd':'Open';
  document.getElementById('m-fields').innerHTML=[['Omschrijving',item.description],['Projectnummer',item.projectNumber],['Referentie',item.reference],['Serienummer',item.serial],['Leverancier',item.supplierId],['Geregistreerd',item.timestamp],['Door',item.createdBy]].map(([k,v])=>`<div><div class="mdl-lb">${k}</div><div class="mdl-v">${v||'‚Äî'}</div></div>`).join('')+
    `<div><div class="mdl-lb">Status</div><div><span class="cb" style="background:${sc};color:#fff;opacity:.85;padding:4px 10px">${st}</span></div></div>`;

  let ph='';
  PF.forEach(f=>{
    const photos=item[f];if(!photos||!photos.length)return;
    ph+=`<div class="ps"><div class="ps-t">${PL[f]||f}</div><div class="pg">`;
    photos.forEach(p=>{
      ph+=p.storageUrl?`<div><img src="${p.storageUrl}" class="pt" onclick="window.open('${p.storageUrl}','_blank')"/><div class="pt-ts">${p.timestamp||''}</div></div>`
        :`<div><div class="pp">Alleen lokaal</div><div class="pt-ts">${p.timestamp||''}</div></div>`;
    });
    ph+=`</div></div>`;
  });
  document.getElementById('m-photos').innerHTML=ph;

  if(item.audit&&item.audit.length){
    document.getElementById('m-audit').innerHTML=`<div class="ps-t" style="margin-top:12px">Activiteit</div><div class="al">${item.audit.map(a=>`<div class="ae"><span class="at">${a.ts||''}</span><span>üë§ ${a.user}: ${a.action}${a.details?' ‚Äî '+a.details:''}</span></div>`).join('')}</div>`;
  }else{document.getElementById('m-audit').innerHTML='';}
  document.getElementById('modal').classList.add('show');
}
function closeModal(){document.getElementById('modal').classList.remove('show');}

// ‚ïê‚ïê BEZOEKSRAPPORT DATA ‚ïê‚ïê
let brItems=[];

const BR_TYPE_LABELS={
  solar:'‚òÄÔ∏èüîã Zon / Thuisbatterij',
  airmo:'üå°Ô∏è Lucht/Lucht Mono',
  airmu:'üå°Ô∏è Lucht/Lucht Multi',
  airwater:'üíß Lucht/Water',
  geo:'üåç Geothermie',
  charge:'‚ö° Laadpaal'
};
const BR_TYPE_COLORS={
  solar:'#f7c948',airmo:'#ff8c42',airmu:'#ff8c42',airwater:'#38b6ff',geo:'#4caf50',charge:'#a78bfa'
};

async function loadBezoeksrapporten(){
  document.getElementById('br-tb').innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text2)">‚è≥ Rapporten laden uit Firebase...</td></tr>';
  try{
    const snap=await db.collection('bezoekrapport').get();
    brItems=[];
    snap.forEach(doc=>{
      const d=doc.data();
      brItems.push({id:doc.id,...d,_itemData:d.itemData?JSON.parse(d.itemData):{}});
    });
    // Sorteer op datum (nieuwste eerst)
    brItems.sort((a,b)=>(b.updatedAt||b.createdAt||'').localeCompare(a.updatedAt||a.createdAt||''));
  }catch(e){
    document.getElementById('br-tb').innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--danger)">‚ö†Ô∏è Fout: '+e.message+'</td></tr>';
    return;
  }
  const badge=document.getElementById('br-badge');
  if(brItems.length>0){badge.style.display='';badge.textContent=brItems.length;}
  else{badge.style.display='none';}
  renderBRTable();
}

function renderBRTable(){
  const search=(document.getElementById('br-search').value||'').toLowerCase();
  const filter=document.getElementById('br-filter').value;
  const filtered=brItems.filter(item=>{
    if(filter){
      const types=item.completedTypes||[];
      // Zoek ook in types die beginnen met de filter key (airmo-1, airmu-2 etc)
      if(!types.some(t=>t===filter||t.startsWith(filter+'-'))) return false;
    }
    if(search){
      const naam=(item.klantNaam||'').toLowerCase();
      const adres=(item.klantAdres||'').toLowerCase();
      const types=(item.completedTypes||[]).map(t=>BR_TYPE_LABELS[t]||t).join(' ').toLowerCase();
      if(!naam.includes(search)&&!adres.includes(search)&&!types.includes(search)) return false;
    }
    return true;
  });
  const tb=document.getElementById('br-tb');
  if(!filtered.length){
    tb.innerHTML='<tr><td colspan="7" class="empty"><div class="empty-icon">üìã</div><div class="empty-title">Geen rapporten gevonden</div><div class="empty-sub">Rapporten verschijnen hier zodra ze worden ingezonden via de mobiele app</div></td></tr>';
  }else{
    tb.innerHTML=filtered.map(item=>{
      const types=(item.completedTypes||[]);
      const typeTags=types.map(t=>{
        const baseType=t.split('-')[0];
        const color=BR_TYPE_COLORS[baseType]||'#555e7d';
        const label=BR_TYPE_LABELS[baseType]||t;
        return `<span class="tag" style="background:${color}1a;color:${color}">${label}</span>`;
      }).join('');
      // Tel items en foto's
      const data=item._itemData||{};
      const totalItems=Object.keys(data).length;
      let totalPhotos=0;
      let hasCloud=false;
      Object.values(data).forEach(d=>{
        const urls=(d.storageUrls||[]).filter(u=>u&&u.startsWith('http'));
        const photos=(d.photos||[]).filter(p=>typeof p==='string'&&p.startsWith('http'));
        const pc=d.photoCount||0;
        // Tel het maximum van alle bronnen
        totalPhotos+=Math.max(urls.length, photos.length, pc);
        if(urls.length>0||photos.length>0) hasCloud=true;
      });
      const datum=item.updatedAt?new Date(item.updatedAt).toLocaleDateString('nl-BE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';
      return `<tr>
        <td style="font-weight:600">${item.klantNaam||'‚Äî'}</td>
        <td style="font-size:.8rem;color:var(--text2);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${item.klantAdres||'‚Äî'}</td>
        <td style="max-width:280px">${typeTags||'‚Äî'}</td>
        <td class="mono" style="font-size:.76rem;color:var(--text2)">${totalItems}</td>
        <td>${totalPhotos>0?`<span class="pb" style="background:${hasCloud?'rgba(56,217,169,.12)':'rgba(139,146,176,.1)'};color:${hasCloud?'var(--success)':'var(--text2)'}">üì∑ ${totalPhotos}${hasCloud?' ‚òÅÔ∏è':''}</span>`:'‚Äî'}</td>
        <td class="mono" style="font-size:.7rem;color:var(--text3);white-space:nowrap">${datum}</td>
        <td style="white-space:nowrap"><button class="vb" onclick="openBRModal('${item.id}')" title="Bekijken"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button> <button class="vb" onclick="generateBRPdf('${item.id}')" title="Download PDF" style="margin-left:4px"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button></td>
      </tr>`;
    }).join('');
  }
  document.getElementById('br-rc').textContent=filtered.length+' rapporten';
  document.getElementById('br-tc').innerHTML=`Toont <strong style="color:var(--text2)">${filtered.length}</strong> van <strong style="color:var(--text2)">${brItems.length}</strong> rapporten`;
}

function openBRModal(docId){
  const item=brItems.find(i=>i.id===docId);
  if(!item) return;
  document.getElementById('br-m-title').textContent=item.klantNaam||'Onbekende klant';
  document.getElementById('br-m-sub').textContent=item.klantAdres||'';

  // Basis velden
  const datum=item.updatedAt?new Date(item.updatedAt).toLocaleDateString('nl-BE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';
  const created=item.createdAt?new Date(item.createdAt).toLocaleDateString('nl-BE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';
  document.getElementById('br-m-fields').innerHTML=[
    ['Klant',item.klantNaam],['Adres',item.klantAdres],['Aangemaakt',created],['Laatst bijgewerkt',datum]
  ].map(([k,v])=>`<div><div class="mdl-lb">${k}</div><div class="mdl-v">${v||'‚Äî'}</div></div>`).join('');

  // Types overzicht
  const types=item.completedTypes||[];
  document.getElementById('br-m-types').innerHTML=`<div class="ps"><div class="ps-t">Ingevulde checklists</div><div style="display:flex;gap:6px;flex-wrap:wrap">${types.map(t=>{
    const baseType=t.split('-')[0];
    const color=BR_TYPE_COLORS[baseType]||'#555e7d';
    const label=BR_TYPE_LABELS[baseType]||t;
    return `<span class="tag" style="background:${color}1a;color:${color};padding:4px 10px;font-size:.75rem">${label}</span>`;
  }).join('')}</div></div>`;

  // Items per type
  const data=item._itemData||{};
  let itemsHtml='';
  Object.entries(data).forEach(([sk,d])=>{
    if(!d) return;
    const hasPhotos=(d.storageUrls||[]).some(u=>u&&u.startsWith('http'));
    const hasNotes=d.notes&&d.notes.trim();
    const hasPhotoCount=(d.photoCount||0)>0;
    // Check of er extra velden zijn ingevuld
    const hasFields=d.fixType||d.unitType||d.connType||d.phaseType||d.location||d.strings||d.mppTrackers||d.mountType||d.fuelType||d.buildYear||d.insulation||d.woningType||d.boilerTemp||d.totalSqm;
    const hasAnyData=hasPhotos||hasNotes||hasPhotoCount||hasFields;
    if(!hasAnyData) return;

    itemsHtml+=`<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:14px;margin-bottom:10px">`;
    itemsHtml+=`<div style="font-weight:600;font-size:.85rem;margin-bottom:8px">${sk}</div>`;

    // Foto's tonen (uit storageUrls of photos array)
    let validUrls=(d.storageUrls||[]).filter(u=>u&&u.startsWith('http'));
    // Fallback: sommige oude rapporten hebben URLs in photos array
    if(validUrls.length===0){
      validUrls=(d.photos||[]).filter(p=>typeof p==='string'&&p.startsWith('http'));
    }
    if(validUrls.length>0){
      itemsHtml+=`<div class="pg" style="margin-bottom:8px">`;
      validUrls.forEach(url=>{
        itemsHtml+=`<img src="${url}" class="pt" onclick="window.open('${url}','_blank')" style="width:90px;height:90px"/>`;
      });
      itemsHtml+=`</div>`;
    } else if((d.photoCount||0)>0){
      itemsHtml+=`<div style="font-size:.72rem;color:var(--warn);margin-bottom:6px">‚è≥ ${d.photoCount} foto('s) nog niet gesynchroniseerd</div>`;
    }

    // Notities
    if(hasNotes){
      itemsHtml+=`<div style="font-size:.82rem;color:var(--text2);white-space:pre-wrap;line-height:1.5">${d.notes}</div>`;
    }

    // Extra velden tonen
    const extraFields=[];
    if(d.fixType) extraFields.push(['Bevestiging',d.fixType]);
    if(d.unitType) extraFields.push(['Binnenunit',d.unitType]);
    if(d.connType) extraFields.push(['Aansluiting',d.connType]);
    if(d.phaseType) extraFields.push(['Fase',d.phaseType]);
    if(d.location) extraFields.push(['Locatie',d.location]);
    if(d.strings) extraFields.push(['Strings',d.strings]);
    if(d.mppTrackers) extraFields.push(['MPP Trackers',d.mppTrackers]);
    if(d.mountType) extraFields.push(['Montage',d.mountType]);
    if(d.fuelType) extraFields.push(['Brandstof',d.fuelType+(d.fuelAmount?' ‚Äî '+d.fuelAmount+(d.fuelType==='gas'?' m¬≥':' liter'):'')]);
    if(d.buildYear) extraFields.push(['Bouwjaar',d.buildYear]);
    if(d.insulation) extraFields.push(['Isolatie',d.insulation]);
    if(d.woningType) extraFields.push(['Woning',d.woningType]);
    if(d.boilerTemp) extraFields.push(['Keteltemp',d.boilerTemp+'¬∞C']);
    if(d.totalSqm) extraFields.push(['Opp.',d.totalSqm+' m¬≤']);
    if(d.boardType){
      const bt=d.boardType;
      const parts=[];
      if(bt.moeilijk) parts.push('Moeilijk bord');
      if(bt.extra) parts.push('Extra bord');
      if(parts.length) extraFields.push(['Bord',parts.join(', ')]);
    }
    if(d.sqmRows&&d.sqmRows.length>0){
      const rows=d.sqmRows.filter(r=>r.floor&&r.sqm);
      if(rows.length) extraFields.push(['Vloerverw.',rows.map(r=>`${r.floor}: ${r.sqm} m¬≤`).join(', ')]);
    }
    if(d.radRows&&d.radRows.length>0){
      const rows=d.radRows.filter(r=>r.floor&&r.count);
      if(rows.length) extraFields.push(['Radiatoren',rows.map(r=>`${r.floor}: ${r.count}√ó`).join(', ')]);
    }

    if(extraFields.length>0){
      itemsHtml+=`<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">${extraFields.map(([k,v])=>`<span style="font-size:.68rem;background:rgba(79,142,247,.1);color:var(--accent);padding:3px 8px;border-radius:5px;font-weight:600">${k}: ${v}</span>`).join('')}</div>`;
    }

    itemsHtml+=`</div>`;
  });
  document.getElementById('br-m-items').innerHTML=itemsHtml||'<div style="color:var(--text3);font-size:.82rem">Geen items gevonden in dit rapport</div>';

  document.getElementById('br-modal').classList.add('show');
}

function closeBRModal(){document.getElementById('br-modal').classList.remove('show');}

// ‚ïê‚ïê PDF GENERATIE (Bezoeksrapport) ‚ïê‚ïê
async function generateBRPdf(docId){
  const item=brItems.find(i=>i.id===docId);
  if(!item) return;
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const pw=210,ph=297,ml=14,mr=14,cw=pw-ml-mr;
  let y=14;

  function checkSpace(needed){
    if(y+needed>ph-18){doc.addPage();y=14;}
  }

  // ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ
  doc.setFillColor(15,17,23);
  doc.rect(0,0,pw,36,'F');
  doc.setTextColor(232,236,245);
  doc.setFontSize(18);doc.setFont('helvetica','bold');
  doc.text('Bezoekrapport',ml,16);
  doc.setFontSize(9);doc.setFont('helvetica','normal');
  doc.setTextColor(139,146,176);
  doc.text('Advanced Energy ‚Äî Plenion',ml,23);
  const datum=item.updatedAt?new Date(item.updatedAt).toLocaleDateString('nl-BE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';
  doc.text(datum,pw-mr,16,{align:'right'});
  y=42;

  // ‚îÄ‚îÄ KLANTGEGEVENS ‚îÄ‚îÄ
  doc.setFillColor(240,244,255);
  doc.roundedRect(ml,y,cw,22,2,2,'F');
  doc.setDrawColor(200,210,230);doc.setLineWidth(0.3);
  doc.roundedRect(ml,y,cw,22,2,2,'S');
  doc.setTextColor(40,40,40);
  doc.setFontSize(8);doc.setFont('helvetica','bold');
  doc.text('KLANT',ml+6,y+7);
  doc.setFontSize(12);
  doc.text(item.klantNaam||'‚Äî',ml+6,y+15);
  doc.setFontSize(8);doc.setFont('helvetica','normal');
  doc.text('ADRES',ml+cw/2,y+7);
  doc.setFontSize(10);
  doc.text(item.klantAdres||'‚Äî',ml+cw/2,y+15);
  y+=28;

  // ‚îÄ‚îÄ TYPES OVERZICHT ‚îÄ‚îÄ
  const types=item.completedTypes||[];
  if(types.length>0){
    doc.setFontSize(8);doc.setFont('helvetica','bold');doc.setTextColor(100,100,100);
    doc.text('INGEVULDE CHECKLISTS',ml,y+4);
    y+=8;
    doc.setFontSize(9);doc.setFont('helvetica','normal');doc.setTextColor(40,40,40);
    types.forEach(t=>{
      const baseType=t.split('-')[0];
      const label=BR_TYPE_LABELS[baseType]||t;
      doc.text('‚Ä¢ '+label.replace(/[\u{2600}-\u{27BF}\u{1F300}-\u{1F9FF}]\u{FE0F}?/gu,'').trim(),ml+4,y+4);
      y+=5;
    });
    y+=4;
  }

  // ‚îÄ‚îÄ ITEMS ‚îÄ‚îÄ
  const data=item._itemData||{};
  const entries=Object.entries(data).filter(([sk,d])=>{
    if(!d) return false;
    const hasPhotos=(d.storageUrls||[]).some(u=>u&&u.startsWith('http'));
    const hasNotes=d.notes&&d.notes.trim();
    const hasPhotoCount=(d.photoCount||0)>0;
    const hasFields=d.fixType||d.unitType||d.connType||d.phaseType||d.location||d.strings||d.mppTrackers||d.mountType||d.fuelType||d.buildYear||d.insulation||d.woningType||d.boilerTemp||d.totalSqm;
    return hasPhotos||hasNotes||hasPhotoCount||hasFields;
  });

  for(const [sk,d] of entries){
    checkSpace(30);

    // Item header
    doc.setFillColor(230,235,245);
    doc.roundedRect(ml,y,cw,8,1,1,'F');
    doc.setFontSize(9);doc.setFont('helvetica','bold');doc.setTextColor(40,40,40);
    doc.text(sk,ml+4,y+5.5);
    y+=11;

    // Extra velden
    const fields=[];
    if(d.fixType) fields.push('Bevestiging: '+d.fixType);
    if(d.unitType) fields.push('Binnenunit: '+d.unitType);
    if(d.connType) fields.push('Aansluiting: '+d.connType);
    if(d.phaseType) fields.push('Fase: '+d.phaseType);
    if(d.location) fields.push('Locatie: '+d.location);
    if(d.strings) fields.push('Strings: '+d.strings);
    if(d.mppTrackers) fields.push('MPP: '+d.mppTrackers);
    if(d.mountType) fields.push('Montage: '+d.mountType);
    if(d.fuelType) fields.push('Brandstof: '+d.fuelType+(d.fuelAmount?' ‚Äî '+d.fuelAmount+(d.fuelType==='gas'?' m¬≥':' L'):''));
    if(d.buildYear) fields.push('Bouwjaar: '+d.buildYear);
    if(d.insulation) fields.push('Isolatie: '+d.insulation);
    if(d.woningType) fields.push('Woning: '+d.woningType);
    if(d.boilerTemp) fields.push('Keteltemp: '+d.boilerTemp+'¬∞C');
    if(d.totalSqm) fields.push('Opp: '+d.totalSqm+' m¬≤');
    if(d.boardType){
      const parts=[];
      if(d.boardType.moeilijk) parts.push('Moeilijk bord');
      if(d.boardType.extra) parts.push('Extra bord');
      if(parts.length) fields.push('Bord: '+parts.join(', '));
    }
    if(d.sqmRows&&d.sqmRows.length>0){
      const rows=d.sqmRows.filter(r=>r.floor&&r.sqm);
      if(rows.length) fields.push('Vloerverw: '+rows.map(r=>r.floor+': '+r.sqm+' m¬≤').join(', '));
    }
    if(d.radRows&&d.radRows.length>0){
      const rows=d.radRows.filter(r=>r.floor&&r.count);
      if(rows.length) fields.push('Radiatoren: '+rows.map(r=>r.floor+': '+r.count+'√ó').join(', '));
    }

    if(fields.length>0){
      doc.setFontSize(7);doc.setFont('helvetica','normal');doc.setTextColor(80,80,80);
      fields.forEach(f=>{
        checkSpace(5);
        doc.text(f,ml+4,y+3);
        y+=4;
      });
      y+=2;
    }

    // Notities
    if(d.notes&&d.notes.trim()){
      checkSpace(12);
      doc.setFillColor(248,248,248);
      const lines=doc.splitTextToSize(d.notes.trim(),cw-16);
      const noteH=lines.length*3.8+6;
      doc.roundedRect(ml+4,y,cw-8,noteH,1,1,'F');
      doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(40,40,40);
      doc.text(lines,ml+8,y+5);
      y+=noteH+3;
    }

    // Foto's laden vanuit storageUrls of photos array
    let photoUrls=(d.storageUrls||[]).filter(u=>u&&u.startsWith('http'));
    if(photoUrls.length===0){
      photoUrls=(d.photos||[]).filter(p=>typeof p==='string'&&p.startsWith('http'));
    }

    if(photoUrls.length>0){
      checkSpace(40);
      const maxPerRow=3;
      const gap=3;
      const imgW=(cw-8-(maxPerRow-1)*gap)/maxPerRow;
      const imgH=38;
      let px=ml+4;

      for(let i=0;i<photoUrls.length;i++){
        if(i>0&&i%maxPerRow===0){
          y+=imgH+gap;px=ml+4;
          checkSpace(imgH+gap);
        }
        try{
          const b64=await new Promise((resolve,reject)=>{
            const img=new Image();
            img.crossOrigin='anonymous';
            img.onload=()=>{
              const canvas=document.createElement('canvas');
              canvas.width=img.naturalWidth;
              canvas.height=img.naturalHeight;
              const ctx=canvas.getContext('2d');
              ctx.drawImage(img,0,0);
              resolve(canvas.toDataURL('image/jpeg',0.8));
            };
            img.onerror=()=>reject(new Error('Foto laden mislukt'));
            img.src=photoUrls[i];
          });
          doc.addImage(b64,'JPEG',px,y,imgW,imgH);
        }catch(e){
          doc.setFillColor(230,230,230);
          doc.roundedRect(px,y,imgW,imgH,1,1,'F');
          doc.setFontSize(7);doc.setTextColor(150,150,150);
          doc.text('Foto niet beschikbaar',px+imgW/2,y+imgH/2,{align:'center'});
        }
        doc.setDrawColor(200,200,200);doc.rect(px,y,imgW,imgH);
        px+=imgW+gap;
      }
      y+=imgH+4;
    }

    y+=4;
  }

  // ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ
  const pageCount=doc.internal.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setDrawColor(180,180,180);doc.setLineWidth(0.3);
    doc.line(ml,ph-10,pw-mr,ph-10);
    doc.setFontSize(7);doc.setFont('helvetica','normal');doc.setTextColor(120,120,120);
    doc.text('Pagina '+i+' / '+pageCount,pw/2,ph-6,{align:'center'});
    doc.text('Plenion Bezoekrapport',ml,ph-6);
    doc.text(new Date().toLocaleDateString('nl-BE'),pw-mr,ph-6,{align:'right'});
  }

  const filename=item.klantNaam?'Bezoekrapport_'+item.klantNaam.replace(/[^a-zA-Z0-9]/g,'_')+'.pdf':'Bezoekrapport.pdf';
  doc.save(filename);
}

// ‚ïê‚ïê INIT ‚ïê‚ïê
loadMagazijn();
</script>
</body>
</html>
