<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Personeelbeheer â€” Advanced Energy</title>
<style>
/* â•â•â• CSS STYLES â•â•â• */
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');

:root{
  --bg:#f0f4ff;--surface:#fff;--surface2:#f8faff;--surface3:#eef2fb;
  --text:#2d2d2d;--text2:#5a6377;--text3:#6b7280;
  --border:#e2e8f4;--border-hover:#c5cfe0;
  --accent:#3b82f6;--accent-bg:rgba(59,130,246,.08);--accent-border:rgba(59,130,246,.25);
  --success:#38d9a9;--success-bg:rgba(56,217,169,.1);
  --danger:#ff5c5c;--danger-bg:rgba(255,92,92,.08);--danger-border:rgba(255,92,92,.2);
  --warn:#f59e0b;--warn-bg:rgba(245,158,11,.08);
  --radius:14px;--radius-sm:8px;--radius-xs:6px;
  --shadow:0 2px 8px rgba(0,0,0,.06);--shadow-lg:0 8px 24px rgba(0,0,0,.1);
  --sidebar-w:240px;
  /* Verloftype kleuren */
  --clr-wettelijk:#3b82f6;--clr-adv:#22c55e;--clr-overuren:#eab308;
  --clr-ziekte:#ef4444;--clr-onbetaald:#94a3b8;--clr-opleiding:#a855f7;
}

*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;}
button{font-family:inherit;cursor:pointer;}
input,select,textarea{font-family:inherit;font-size:13px;}

/* Sidebar */
.sidebar{width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:250;}
.sb-header{padding:20px;border-bottom:1px solid var(--border);}
.sb-logo{display:flex;align-items:center;gap:10px;}
.sb-logo-icon{width:36px;height:36px;border-radius:50%;overflow:hidden;flex-shrink:0;}
.sb-logo-icon img{width:100%;height:100%;object-fit:contain;}
.sb-logo-text{font-weight:700;font-size:15px;line-height:1.2;}
.sb-logo-sub{font-size:11px;color:var(--text3);font-weight:400;}
.sb-nav{flex:1;padding:12px 10px;overflow-y:auto;}
.sb-section{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;
  color:var(--text3);padding:12px 10px 6px;}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);
  color:var(--text2);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;border:none;
  background:none;width:100%;text-align:left;}
.sb-item:hover{background:var(--surface2);color:var(--text);}
.sb-item.active{background:var(--accent-bg);color:var(--accent);font-weight:600;}
.sb-item-icon{font-size:16px;width:22px;text-align:center;}
.sb-item-badge{margin-left:auto;background:var(--danger);color:#fff;font-size:10px;font-weight:700;
  padding:2px 7px;border-radius:10px;min-width:20px;text-align:center;}
.sb-footer{padding:12px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text3);}

/* Role switcher */
.role-bar{position:fixed;top:0;left:var(--sidebar-w);right:0;height:44px;background:var(--surface);
  border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;z-index:90;gap:12px;}
.role-bar-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:1px;}
.role-btn{padding:5px 14px;border-radius:20px;border:1px solid var(--border);background:var(--surface);
  font-size:12px;font-weight:600;color:var(--text2);transition:all .15s;}
.role-btn:hover{border-color:var(--accent);color:var(--accent);}
.role-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}
.role-bar-right{margin-left:auto;display:flex;align-items:center;gap:12px;}
.env-badge{background:#3b82f6;color:#fff;font-size:10px;font-weight:700;padding:3px 10px;
  border-radius:10px;letter-spacing:1px;text-transform:uppercase;}

/* Main content */
.main{margin-left:var(--sidebar-w);padding-top:44px;flex:1;min-height:100vh;}
.page{max-width:1100px;margin:0 auto;padding:28px 32px;}
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;}
.page-title{font-size:22px;font-weight:700;}
.page-subtitle{font-size:13px;color:var(--text3);margin-top:2px;}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:20px;box-shadow:var(--shadow);transition:all .15s;}
.card-title{font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.card-grid{display:grid;gap:16px;}
.card-grid-2{grid-template-columns:1fr 1fr;}
.card-grid-3{grid-template-columns:1fr 1fr 1fr;}
.card-grid-4{grid-template-columns:1fr 1fr 1fr 1fr;}

/* Stats */
.stat{text-align:center;padding:16px;}
.stat-value{font-size:28px;font-weight:700;line-height:1;}
.stat-label{font-size:11px;color:var(--text3);margin-top:4px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;}

/* Tables */
.tbl{width:100%;border-collapse:collapse;font-size:13px;}
.tbl th{text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;
  color:var(--text3);padding:10px 12px;border-bottom:2px solid var(--border);}
.tbl td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
.tbl tr:hover td{background:var(--surface2);}
.tbl tr:last-child td{border-bottom:none;}

/* Badges */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:12px;
  font-size:11px;font-weight:600;white-space:nowrap;}
.badge-blue{background:rgba(59,130,246,.1);color:#3b82f6;}
.badge-green{background:rgba(34,197,94,.1);color:#22c55e;}
.badge-yellow{background:rgba(234,179,8,.1);color:#b45309;}
.badge-red{background:rgba(239,68,68,.1);color:#ef4444;}
.badge-gray{background:rgba(148,163,184,.1);color:#64748b;}
.badge-purple{background:rgba(168,85,247,.1);color:#a855f7;}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);
  font-size:13px;font-weight:600;border:1px solid var(--border);background:var(--surface);
  color:var(--text);transition:all .15s;}
.btn:hover{border-color:var(--border-hover);background:var(--surface2);}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent);}
.btn-primary:hover{background:#2563eb;border-color:#2563eb;}
.btn-primary-outline{background:rgba(59,130,246,.08);color:var(--accent);border-color:rgba(59,130,246,.35);}
.btn-primary-outline:hover{background:rgba(59,130,246,.15);border-color:var(--accent);}
.btn-danger{background:var(--danger-bg);color:var(--danger);border-color:var(--danger-border);}
.btn-danger:hover{background:rgba(255,92,92,.15);}
.btn-sm{padding:5px 12px;font-size:12px;}
.btn-icon{width:32px;height:32px;padding:0;display:inline-flex;align-items:center;justify-content:center;}

/* Forms */
.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;}
.form-label .req{color:var(--danger);}
.form-input{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);
  background:#fff;color:#000;font-size:13px;transition:border-color .15s;}
.form-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.1);}
.form-row{display:flex;gap:16px;}
.form-row>*{flex:1;}
select.form-input{cursor:pointer;}

/* Modal */
.modal-overlay{position:fixed;top:0;left:var(--sidebar-w);right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;display:none;
  align-items:stretch;justify-content:stretch;backdrop-filter:blur(2px);}
.modal-overlay.show{display:flex;}
.modal{background:var(--surface);border-radius:0;width:100%;max-width:none;
  max-height:none;overflow-y:auto;box-shadow:var(--shadow-lg);padding:24px 32px;margin:0;
  display:flex;flex-direction:column;}
.modal.modal-wide{max-width:none;}
.modal-title{font-size:18px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;
  justify-content:space-between;flex-shrink:0;}
.modal-close{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--surface);
  display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;color:var(--text3);}
.modal-close:hover{background:var(--surface2);color:var(--text);}
.modal-body{flex:1;overflow-y:auto;min-height:0;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;padding-top:16px;
  border-top:1px solid var(--border);flex-shrink:0;}


/* Utility classes (C2) */
.flex-between{display:flex;justify-content:space-between;align-items:center;}
.flex-between.mb4{margin-bottom:4px;}
.flex-between.mb6{margin-bottom:6px;}
.flex-between.mb8{margin-bottom:8px;}
.flex-between.mb10{margin-bottom:10px;}
.summary-label{font-size:12px;color:var(--text3);}
.summary-val{font-weight:600;}
.summary-val-lg{font-weight:700;font-size:16px;}
.summary-val-accent{font-weight:700;font-size:16px;color:var(--accent);}
.summary-val-danger{font-weight:700;color:var(--danger);}
.section-title{font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:12px;}
.formula-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;font-size:11px;color:var(--text3);line-height:1.6;}
.modal-top-actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:var(--radius-sm);
  font-size:13px;font-weight:600;box-shadow:var(--shadow-lg);z-index:300;transform:translateY(80px);
  opacity:0;transition:all .3s ease;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast-success{background:#065f46;color:#fff;}
.toast-error{background:#991b1b;color:#fff;}
.toast-warn{background:#92400e;color:#fff;}

/* Color dots */
.clr-dot{width:10px;height:10px;border-radius:50%;display:inline-block;flex-shrink:0;}

/* Tag/chip */
.chip{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:12px;
  font-size:11px;font-weight:600;border:1px solid var(--border);background:var(--surface2);}

/* Tabs */
.tabs{display:flex;gap:4px;border-bottom:2px solid var(--border);margin-bottom:20px;}
.tab{padding:10px 16px;font-size:13px;font-weight:600;color:var(--text3);cursor:pointer;
  border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}

/* Hide/show panels */
.panel{display:none;}
.panel.active{display:block;}

/* Avatar */
.avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:700;color:#fff;flex-shrink:0;}

/* Search */
.search-box{position:relative;}
.search-box input{padding-left:34px;}
.search-box::before{content:'ğŸ”';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;}

/* Saldo bar */
/* Utility classes */
</style>
</head>
<body>

<!-- â•â•â• HTML STRUCTURE â•â•â• -->

<!-- Sidebar -->
<nav class="sidebar" aria-label="Hoofdmenu">
  <div class="sb-header">
    <div class="sb-logo" onclick="showPage('dashboard')" style="cursor:pointer">
      <div class="sb-logo-icon"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAKMWlDQ1BJQ0MgUHJvZmlsZQAAeJydlndUU9kWh8+9N71QkhCKlNBraFICSA29SJEuKjEJEErAkAAiNkRUcERRkaYIMijggKNDkbEiioUBUbHrBBlE1HFwFBuWSWStGd+8ee/Nm98f935rn73P3Wfvfda6AJD8gwXCTFgJgAyhWBTh58WIjYtnYAcBDPAAA2wA4HCzs0IW+EYCmQJ82IxsmRP4F726DiD5+yrTP4zBAP+flLlZIjEAUJiM5/L42VwZF8k4PVecJbdPyZi2NE3OMErOIlmCMlaTc/IsW3z2mWUPOfMyhDwZy3PO4mXw5Nwn4405Er6MkWAZF+cI+LkyviZjg3RJhkDGb+SxGXxONgAoktwu5nNTZGwtY5IoMoIt43kA4EjJX/DSL1jMzxPLD8XOzFouEiSniBkmXFOGjZMTi+HPz03ni8XMMA43jSPiMdiZGVkc4XIAZs/8WRR5bRmyIjvYODk4MG0tbb4o1H9d/JuS93aWXoR/7hlEH/jD9ld+mQ0AsKZltdn6h21pFQBd6wFQu/2HzWAvAIqyvnUOfXEeunxeUsTiLGcrq9zcXEsBn2spL+jv+p8Of0NffM9Svt3v5WF485M4knQxQ143bmZ6pkTEyM7icPkM5p+H+B8H/nUeFhH8JL6IL5RFRMumTCBMlrVbyBOIBZlChkD4n5r4D8P+pNm5lona+BHQllgCpSEaQH4eACgqESAJe2Qr0O99C8ZHA/nNi9GZmJ37z4L+fVe4TP7IFiR/jmNHRDK4ElHO7Jr8WgI0IABFQAPqQBvoAxPABLbAEbgAD+ADAkEoiARxYDHgghSQAUQgFxSAtaAYlIKtYCeoBnWgETSDNnAYdIFj4DQ4By6By2AE3AFSMA6egCnwCsxAEISFyBAVUod0IEPIHLKFWJAb5AMFQxFQHJQIJUNCSAIVQOugUqgcqobqoWboW+godBq6AA1Dt6BRaBL6FXoHIzAJpsFasBFsBbNgTzgIjoQXwcnwMjgfLoK3wJVwA3wQ7oRPw5fgEVgKP4GnEYAQETqiizARFsJGQpF4JAkRIauQEqQCaUDakB6kH7mKSJGnyFsUBkVFMVBMlAvKHxWF4qKWoVahNqOqUQdQnag+1FXUKGoK9RFNRmuizdHO6AB0LDoZnYsuRlegm9Ad6LPoEfQ4+hUGg6FjjDGOGH9MHCYVswKzGbMb0445hRnGjGGmsVisOtYc64oNxXKwYmwxtgp7EHsSewU7jn2DI+J0cLY4X1w8TogrxFXgWnAncFdwE7gZvBLeEO+MD8Xz8MvxZfhGfA9+CD+OnyEoE4wJroRIQiphLaGS0EY4S7hLeEEkEvWITsRwooC4hlhJPEQ8TxwlviVRSGYkNimBJCFtIe0nnSLdIr0gk8lGZA9yPFlM3kJuJp8h3ye/UaAqWCoEKPAUVivUKHQqXFF4pohXNFT0VFysmK9YoXhEcUjxqRJeyUiJrcRRWqVUo3RU6YbStDJV2UY5VDlDebNyi/IF5UcULMWI4kPhUYoo+yhnKGNUhKpPZVO51HXURupZ6jgNQzOmBdBSaaW0b2iDtCkVioqdSrRKnkqNynEVKR2hG9ED6On0Mvph+nX6O1UtVU9Vvuom1TbVK6qv1eaoeajx1UrU2tVG1N6pM9R91NPUt6l3qd/TQGmYaYRr5Grs0Tir8XQObY7LHO6ckjmH59zWhDXNNCM0V2ju0xzQnNbS1vLTytKq0jqj9VSbru2hnaq9Q/uE9qQOVcdNR6CzQ+ekzmOGCsOTkc6oZPQxpnQ1df11Jbr1uoO6M3rGelF6hXrtevf0Cfos/ST9Hfq9+lMGOgYhBgUGrQa3DfGGLMMUw12G/YavjYyNYow2GHUZPTJWMw4wzjduNb5rQjZxN1lm0mByzRRjyjJNM91tetkMNrM3SzGrMRsyh80dzAXmu82HLdAWThZCiwaLG0wS05OZw2xljlrSLYMtCy27LJ9ZGVjFW22z6rf6aG1vnW7daH3HhmITaFNo02Pzq62ZLde2xvbaXPJc37mr53bPfW5nbse322N3055qH2K/wb7X/oODo4PIoc1h0tHAMdGx1vEGi8YKY21mnXdCO3k5rXY65vTW2cFZ7HzY+RcXpkuaS4vLo3nG8/jzGueNueq5clzrXaVuDLdEt71uUnddd457g/sDD30PnkeTx4SnqWeq50HPZ17WXiKvDq/XbGf2SvYpb8Tbz7vEe9CH4hPlU+1z31fPN9m31XfKz95vhd8pf7R/kP82/xsBWgHcgOaAqUDHwJWBfUGkoAVB1UEPgs2CRcE9IXBIYMj2kLvzDecL53eFgtCA0O2h98KMw5aFfR+OCQ8Lrwl/GGETURDRv4C6YMmClgWvIr0iyyLvRJlESaJ6oxWjE6Kbo1/HeMeUx0hjrWJXxl6K04gTxHXHY+Oj45vipxf6LNy5cDzBPqE44foi40V5iy4s1licvvj4EsUlnCVHEtGJMYktie85oZwGzvTSgKW1S6e4bO4u7hOeB28Hb5Lvyi/nTyS5JpUnPUp2Td6ePJninlKR8lTAFlQLnqf6p9alvk4LTduf9ik9Jr09A5eRmHFUSBGmCfsytTPzMoezzLOKs6TLnJftXDYlChI1ZUPZi7K7xTTZz9SAxESyXjKa45ZTk/MmNzr3SJ5ynjBvYLnZ8k3LJ/J9879egVrBXdFboFuwtmB0pefK+lXQqqWrelfrry5aPb7Gb82BtYS1aWt/KLQuLC98uS5mXU+RVtGaorH1futbixWKRcU3NrhsqNuI2ijYOLhp7qaqTR9LeCUXS61LK0rfb+ZuvviVzVeVX33akrRlsMyhbM9WzFbh1uvb3LcdKFcuzy8f2x6yvXMHY0fJjpc7l+y8UGFXUbeLsEuyS1oZXNldZVC1tep9dUr1SI1XTXutZu2m2te7ebuv7PHY01anVVda926vYO/Ner/6zgajhop9mH05+x42Rjf2f836urlJo6m06cN+4X7pgYgDfc2Ozc0tmi1lrXCrpHXyYMLBy994f9Pdxmyrb6e3lx4ChySHHn+b+O31w0GHe4+wjrR9Z/hdbQe1o6QT6lzeOdWV0iXtjusePhp4tLfHpafje8vv9x/TPVZzXOV42QnCiaITn07mn5w+lXXq6enk02O9S3rvnIk9c60vvG/wbNDZ8+d8z53p9+w/ed71/LELzheOXmRd7LrkcKlzwH6g4wf7HzoGHQY7hxyHui87Xe4Znjd84or7ldNXva+euxZw7dLI/JHh61HXb95IuCG9ybv56Fb6ree3c27P3FlzF3235J7SvYr7mvcbfjT9sV3qID0+6j068GDBgztj3LEnP2X/9H686CH5YcWEzkTzI9tHxyZ9Jy8/Xvh4/EnWk5mnxT8r/1z7zOTZd794/DIwFTs1/lz0/NOvm1+ov9j/0u5l73TY9P1XGa9mXpe8UX9z4C3rbf+7mHcTM7nvse8rP5h+6PkY9PHup4xPn34D94Tz+6TMXDkAABHzSURBVHja3Vt5eBXV2f/NmZm7L9lXQwIk7HuACAkEpIAoRfBpXb4PQZGKS62t0Nrn8euq1lZrWz+LVRsoi4ogVhG1DcqakAQCJIEgYQlL9tzce5N779xl7syc8/1xA5IaloSg8L3PM8+de5Z35v2dM+e87++cw+E6S41TeryiyfNyRbPXVNPmQ31HEC6/DH9YRVjRQBiDQACzyCPGKCLNbsSQeCvGpkZhXFr0iiGJ9leu5/tx10NpcV37mk9Pti3efdaNEy4JHUEF0CgIBxAAhDFwABilIIyBMQbGKDTKQFUKjVJw0GDXixgUZ8W0zATMHZH6SV5m4ndvWAAcfnnSO9UtJe9UN6OqxQdF1aDjCQQwhDUKVdEASgEAIsdBx3MgYCCMQdUowqoGRdUALVKGJxQiR6BoGjRZBc8TjE6NwsIJ/fHfOQNnJNqMO24IAJyBcPbKQ40HVlU2oq4jAIPIQ+QAv6yCagwxBh5ZMSaMSrBiWLwF/aONZxIt+p12vVCj40k7AIRVGuORlWGt3tCsMy4p+WiLB4cb3Tjh8KJDCoEDB5PIR0AKyUiNsWBpbhaenDF8cpzFUPqtAVBQ1cxeKD2HM+4gbHoOlFJIsopYg4j8flH4blY8pqRHP5gZY17bG/2n2nzLik61vrH1SAN2Hm9Buy8Ig56AgENACiE93opn7xyDR/KHct8oACfbA4t+tL127b9qXbDoePAM8ARlZEUbsXhUMu4fnrRwYLTpnb78VmvbvMveLT/zxpqSE6ht9sBsFEA1hqBfxuxRafjfhbk/G5wU9fJ1B+C9mrZzT+6o7ecOhBFtEOD0h5Fm0eGp8alYkZPOXe9ZpSMgj/p70fGqP39ejSaXhCiLHh2+IGJMOqxcNAX335rFXTcAfllSx35bVg+bSMAoRSCs4uGRSfhVbvqsVKvhc3yD0tjun/+rLQc/LNhTA6NIwAEI+EN4dv54vPC9W7k+B2DpF7WsoKoF8WYR7kAYKSYRr80YWDk/K24svkX56NBZ/xPri0yN7RKiTHp0uHx4aMYI/OORGVyfAbCw8BR7+6gDSRYRLT4Z+bfYsG7OoHnpNsNW3AByzulbtPDN7WuLvmxAjN0It9OH+/KH4r0nZnPXDMAjO86wt6pakGTRocUXwv2D47DhzsEcbkC5d+U2trG4BjFRJridPiyZORKrH/nOZd+VXC7zN/sb2VuHHUiy6tEihfHwiMQb1ngA2PjELO7B6cPhbvcjJtaK1YVV+MX7paxXAHxQ6z74q/1NSLSIaPGHcf+QWKyalXnDGn9e1jwyg7sndzDcHX5Ex1rx3KZSvF92kvUIgDNeed5ju+vG2XU83CEV+ak2bJgz6IY3/rxsevJ2LndoKjxSCGaTHsve+gKnWz2PXzUATxbXb3HJKhiARJOIt2cPvB03mbz3w9n/lWA3gQFwS0E8vmrHyqsCYP1xV8MnZz2I1QuQwhremJ6xM82qL7zZAEiLtW546we3BQIhBXarEf8uP4W1u4+yKwLw6wMtqTYdj7aQioeHxWFu/+jbcJPKvHEDzA/dNhweTxBGsx6/2FiCdn8o+5IA/L6ildV6wiAckGIW8XxO6mTc5PLivZPvTIgxgxCCuqZ2rPx35YFLAvDGMRdseh4dsoanRyci0awrvdkBSIoyf7Z8bjb8viCMFgNWFlbCLQVzvgbA34462VlfGAwMmXY9lo9J4vD/RJ6ZN57L6hcHyhiaHV68W1RTdj5PuDD4nWyHUSDwhTU8MzoB/3ONDz127Fjh0KFDZ/e0njsgj33g7bJDUkgBTwBGGTgGoJM6A4swRqAUYADAAMYuyj9/ARwYmMZAOOBUczs4AETksWbXUXQB4EBb4Nm8j09BTzgYDTwWDoqZdy0AHKmuLlv9j3U5vakbVmnMrlMO+AMyQLiIoRQXGaZGDKcUoBFDwehX+ZReAACsswylEEUeAuGg1wk4dKoF+042f5STlTxfAIBP6nzPhzQGjTLM7WdFhk1/TUFOSUlZTktzM4qKitmUKXk9i885aHajCK6TLaaUgqMX9wD+IkMvBoZG8ulXvYBjDKzzP6MUlFHwhEcoHMKW8lN3XegBu1okGHmCoKphXrrd9eE1GF9fX/+bl1/+E6xWK4qLS3pcP9Fq3HWyzfc4pUwPDoyLtD/AGN9the7SL1k2MuYxRnUmvXj6dwCEMz75u5M/rgVPgBg9j6nJlmXX0vo7d+7+paKqoJRiyJBBvdKRFW/92zc1QJJDztDPO8IUGgWy7HoMtOs/6K0yh6NtcWVVFURRhMVixvTp02b1VpcrqIz6JgAQqtzByRpj0CjFyBgD9l2Dsj17itaEgiFQxpCbOwlRUVE9psnaQsro27bWVg5ZV4WZG6vw+b2j+3Q63r59B6usrALHccjOHguhpkMGz3FQGDA0ytB7srLDM+PF378EUacD4ThMm5b/8Pm8dUeawotGpuiuRg9lEJ1BFW0BBS5937f42bNnUVBQAFEU0dBQD1LvV8BzkRmnv1VX1vuRv/QLn88HRVEwZsxoJCYkrAaAGpd/2aNbvxQPNnn+cLW6RMJB4DkIpO99saysLMTGxiIuLg4ejwfEJWsgXOShiSah165vWdk+6HR6CIKA6dOnvXA+/fWKpjcC/jDeKD/3s6vVxSI9ATzX9wBERdmrOC6yiNPe3g5BUigADiLhYBP5071RumvXbvb+5n+CcAQjRgxHv35pF/yoT063Q2/VY1N1M045paWZcZaCqwFAIBycwTDePFDHmKYBmgaoKjhKEQ7KmDMmY0VmcnSPV47NZvNBQRBGMwYEgyEICo2EyHxkwbKjNwAU7y2FTqeDqqiYPj1/08V5cwdE4zWnF3JQwcqyM38HcEUAeHAwiQRtgSCWfXoUCMpAKAQEg0A4DLS1472f3/VHAD0GQBTFVkIIKKVQFOXypOjVyL795f6W1lZQSpGZNRCDBmXd24VdGpf6oFUkMOkFvFNRh2ZvcOaVBsG2kIqOgIKOYKfbi06P7/wv+yr5mqdBkXCQNQaNMYQ1FtVTBUVFxSZREKAoCqZPy6/82qATY1r7wJYja945VI9AIISCstPbcBk6Ptkklr56pA2yHAbX2e2ZqgGaCqaqIJoGOSBjTEbC870xWFGUREojbrMoihAsIoGkaFAog1fRBvQo6DlSvb9g1T9ACEF6v34YNWpkt6tEP5rQ75VNVQ3LOZ2AVfuuPMw8NTL+iqNfb4M1v9+fraoqeJ6H0WgEidXzoAxQKENrQJ3UE2W79xRPIDyBoiiYOjVPvlS5CSn2FTMHxEGhDGfbfFi55zjDtyRud/totdNVt9vtIGlmEVpnEHXGF771ahWdPFW7rrb2NAhHkJychJyciZf1op66NWMnY4BOJ+D1Pccvq7um5vjWw4ePVJw4cXJjXwPQ1NQESikopUhKSgQZEqWHxiKkwZcdoZ64vQ9wHBAOh5E7+crU4czM+Nsmp0eDATja4Ma7+2q77QVen2/Suxs2zX3zrVVjNm/+8J7r4QmenwXS09NBxsQY9/IcBx0hqHZfHQD1DQ2/rKk5AZ7nERsbg2nTpl6Vx/LEpAGqolKIAo9Xtx+9BB/AKUajASaTCQZD3/vCtbW1EAQRhBAMGjQIZGyc4Q9ROh48AU54ZNR6Qt+/8si/9zeapkIOh5GTM/GqH37/mDRx7C3RAOGwv7YF/zp8rr7bqZAy0M4NVX0pjY2NP6+vbwDPE1itVgwZMniF0N+q3zr901qUtqiQVA27m/1vAnj/ktFaW9vCP/35NQiCCJPRhMmTbp1+uYee84Tm8RzCqkZtAuH8q8tqUXm6FRzH4c+FVbdcmhnioKoqnE7XPQAjjIEHGNf5SxhjYsQtYML5NEqp0WQyHY6Ojv6sO52VlZUv+nw+CIKA9PR0pKSkvCIAwLRkC3Y2ShAJh4/PeaKv4PWtl2UZlFJMunUi7Hb7rkuVHbvhCBu77hB0mgIqK2CyDKIqsBhEcDzDruoG7D/V8v7EzKTvd+Oxwd3ejpde+uNGRVWhqQoUVYV68aUo0DQVqqqBMQqn04U777wDl/Iziov3QhAEhMNhZGeP+4oWn5tmfdbAE5gEgj1NEs565W43JHo8nmkVFRHCw2g0IC9v8gOXMv5npQ2sosELX1hDi1+GQ5LRJslo9QThkxVIsoKwL4hfby773n/EAUSWw5BlGaFQCH6/H36/H5LkhyRJXS6fzwev1wev1wuv1wuPx4NgMNjt+zQ3Nz9VUVEJvV4PnU6HvLzcbRc4wex40+8mbzn5QoUziGBYw/oT7o+7Q7GsbP9OSZIAAOPHj0N8fPzb3X4mQXX0AzvOIr9/NHhVAVWMgKKCKWEwRQHCCpiigM+Ig6yoaHT57kmNtW4CAJvFsn/16rUIBINglEZaWNOgqSo0TYvca5H7C2mqBoCio8ODjIz0bgEoLNz2F4/HA71ej8GDB+M8ZX9hXWBRVrRa0uIXbDqCNTWubpWUHzgEvV4HTaOYOiXvks5YvFGoQg/2H6X+ouv/JUsW9zoOXr16VXfe36iHHloCs9kMn0/CHXfcjoKCt7quDD06LE7sb9UB4FDrlfHioeYu8/SeomLW3t4OVVUxdMhg3HJL6gs3y8rQxx9vrWpoaATHcUhNTcbMmTMvOHxdosFHh8XCq2gQCAeL2DVQ3LevHDpdhNWaMjVv9c1ivNvtnrdx4yZYrVb4fD4sWDAfVqt1X7cAPDMmketnFpFqFvHkyETuq65/0OlwtIFSioEDBiBz4ICHbxYACgpWbXG5nKCUIi0tDQsWLBjfhRb/zwrPjE3EkiFxXdJKS/fFCqIITdOQNyW36GYxvqSkhH366WeIioqCJElYunQJLBbLwS58wNfc1RFdQ9Hqo1/uWb/+XRBCkJZ2C0YMHzb1ZjDe4XA89Nhjj8NoNMLj8WDKlDzMnv31fYPkyiiWTSGEQNM05OZOarlZWv/5519Y3d7eAY7jYLfb8ZOf/PjH3ZW7LADHjh3/7OzZcxAEATabFeOzxyXfDMY/99zzrKrqMKxWKyRJwk9/ugLJycmv9hgAl9s1R5ZlCIIASfJj46bN7EY3/qWXXmZffLEdsbExaGtrw9KlSzB16qWj1csCkJc7mcvNnQSv1wuDwYCysv1Yt/4dduN2+9+xzz77F+Li4uBwtOHuuxdg8eLFvd8qCwB3L7iLmzA+G16vF3a7HRUVVXjtr68zl9s9/0YxvLW19ZGnn17Odu7cibi4WDgcDtxxxxysWLH82jdLn5fNmz9kxXtLYbNZ4PcHYLGYcffd86tGjxo55tue6v668nW4XW5YLBY4HA7cddc8LF/+dN9tl78QUGz7ghUWfg69XgfKGORQCBMnTsAdc2bP6s1K8LWI0+m87+23391QWFgIvT7CHPkkCYseWIjFixf1/YGJC6RC1eGjH3zw4TBJ8sNkMsLn88JmsyE/fypmfmfGdd9ZJklSdmHhtgMffbQFTqcTVpsVXo8XVqsVP/zh48jPz79+R2YuRv+f/9yy4Uj10Qu8nd/vR3xcHHJyJmD8+PEPJiTEr+1Lw5ubm5/avafoL9u370BjQwNMZjOopkGSJEycOBGPPfboM6mpKS/1VO81tVhZ2X6lcNvngsPhgMFgAKUUwWAQZpMJmZkDMXLUSGRlZv4gMTGhoLdGf/nlsb+Ul5ejuvooPB4PDIYI++7zSUhOTsJ9992L2bNnfbPH5v4z1i4q2lu1t6QETqcLoiiCEA5yKAxNU2E0GpGQEI+U1BSkJCcjLi6u2Waz7TQaDTWCILgAQFHUhGAwMLyjwzPH4XCY6xsacO7cOTQ1NcPn84FwBKJOhKIoCAWDSEhIwMyZMzF37p25Npu15Frev8++WZ8kjT9QfrB8//5y1NXXQwmHIQgCOI6DpmkIKwoo1SJzLyHgCQ+O48AYhappUBQFaifDAwbwPAEhBKoaYZ8FnkdGRgby86ciP3/q9Mtxkd8KAF2599MFR6qrHz5+/ARaWloR8PsjB6K5CNsLRHaAnj80TTv3AGqUgnZSXQBgNBqRnJyMYcOHIXvcuH8PHTpkTl+/63UftVtaW5fVnat7pa6u3tzc3AyX2wWfT0IoGIKqqmCMghACnU4Hs8WC2JhoJCenICMjHf37Z6xISUm5rsfn/w8Uh4feajwuOgAAAABJRU5ErkJggg==" alt="AE"/></div>
      <div>
        <div class="sb-logo-text">Personeelbeheer</div>
        <div class="sb-logo-sub">Advanced Energy</div>
      </div>
    </div>
  </div>
  <div class="sb-nav">
    <div class="sb-section">Overzicht</div>
    <button class="sb-item active" data-page="dashboard" onclick="showPage('dashboard')">
      <span class="sb-item-icon">ğŸ“Š</span>Dashboard
    </button>
    <button class="sb-item" data-page="wallchart" onclick="showPage('wallchart')">
      <span class="sb-item-icon">ğŸ—“</span>Wallchart
    </button>
    <div class="sb-section">Beheer</div>
    <button class="sb-item" data-page="requests" onclick="showPage('requests')">
      <span class="sb-item-icon">ğŸ“¥</span>Aanvragen
      <span class="sb-item-badge" id="badge-requests" style="display:none">0</span>
    </button>
    <button class="sb-item" data-page="people" onclick="showPage('people')">
      <span class="sb-item-icon">ğŸ‘¥</span>Medewerkers
    </button>
    <button class="sb-item" data-page="departments" onclick="showPage('departments')">
      <span class="sb-item-icon">ğŸ“‚</span>Departments
    </button>
    <button class="sb-item" data-page="sickness" onclick="showPage('sickness')">
      <span class="sb-item-icon">ğŸ¤’</span>Ziekte
    </button>
    <div class="sb-section">Configuratie</div>
    <button class="sb-item" data-page="types" onclick="showPage('types')">
      <span class="sb-item-icon">ğŸ·ï¸</span>Afwezigheidstypes
    </button>
    <button class="sb-item" data-page="settings" onclick="showPage('settings')">
      <span class="sb-item-icon">âš™ï¸</span>Instellingen
    </button>
    <button class="sb-item" data-page="reports" onclick="showPage('reports')">
      <span class="sb-item-icon">ğŸ“ˆ</span>Rapportage
    </button>
  </div>
  <div class="sb-footer">
    <div style="display:flex;justify-content:space-between;align-items:center">
      Personeelbeheer v1.0
      <button onclick="resetData()" style="background:none;border:none;color:var(--text3);font-size:10px;cursor:pointer;text-decoration:underline" title="Alle data resetten naar standaardwaarden">ğŸ”„ Reset</button>
    </div>
  </div>
</nav>

<!-- Role bar -->
<div class="role-bar">
  <span class="role-bar-label">Rol:</span>
  <button class="role-btn active" onclick="setRole('admin',this)">Admin</button>
  <button class="role-btn" onclick="setRole('approver',this)">Approver</button>
  <button class="role-btn" onclick="setRole('user',this)">User</button>
  <div class="role-bar-right">
    <span class="env-badge">Development</span>
  </div>
</div>

<!-- Main content -->
<div class="main" role="main">

  <!-- Dashboard -->
  <div class="panel active" id="page-dashboard">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Dashboard</div><div class="page-subtitle">Overzicht verlof en afwezigheden</div></div>
      </div>
      <div class="card-grid card-grid-3" style="margin-bottom:20px">
        <div class="card" style="cursor:pointer" onclick="highlightCard('card-absent')"><div class="stat"><div class="stat-value" id="st-absent">0</div><div class="stat-label">Afwezig vandaag</div></div></div>
        <div class="card" style="cursor:pointer" onclick="highlightCard('card-absent')"><div class="stat"><div class="stat-value" id="st-sick" style="color:var(--danger)">0</div><div class="stat-label">Ziek vandaag</div></div></div>
        <div class="card" style="cursor:pointer" onclick="highlightCard('card-pending')"><div class="stat"><div class="stat-value" id="st-pending" style="color:var(--warn)">0</div><div class="stat-label">Openstaande aanvragen</div></div></div>
      </div>
      <div class="card-grid card-grid-2">
        <div class="card" id="card-absent">
          <div class="card-title">ğŸ“… Afwezig vandaag</div>
          <div id="dash-absent"><span style="font-size:13px;color:var(--text3)">Niemand afwezig</span></div>
          <div id="dash-sick-section"></div>
        </div>
        <div class="card" id="card-pending">
          <div class="card-title">ğŸ“¥ Openstaande aanvragen</div>
          <div id="dash-pending"><span style="font-size:13px;color:var(--text3)">Geen openstaande aanvragen</span></div>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <div class="card-title">ğŸ‡§ğŸ‡ª Aankomende feestdagen</div>
        <div id="dash-holidays"></div>
      </div>
    </div>
  </div>

  <!-- Medewerkers -->
  <div class="panel" id="page-people">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title" id="people-title">Medewerkers</div><div class="page-subtitle" id="people-count">0 medewerkers</div></div>
        <div id="people-header-actions">
          <button class="btn btn-sm btn-primary-outline" onclick="openPersonModal()" id="btn-new-person">â• Medewerker toevoegen</button>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="showPeopleTab('employees',this)">ğŸ‘¥ Medewerkers</button>
        <button class="tab" onclick="showPeopleTab('candidates',this)">ğŸ“„ Kandidaten <span id="cand-badge"></span></button>
      </div>
      <!-- Medewerkers tab -->
      <div id="people-tab-employees">
        <div class="card">
          <div style="display:flex;gap:12px;margin-bottom:16px;align-items:center">
            <div class="search-box" style="flex:1"><input class="form-input" placeholder="Zoek medewerker..." oninput="filterPeople(this.value)"/></div>
            <select class="form-input" style="width:180px" onchange="filterPeopleDept(this.value)">
              <option value="">Alle departments</option>
            </select>
            <select class="form-input" style="width:160px" id="people-status-filter" onchange="peopleStatusFilter=this.value;renderPeople()">
              <option value="active">Actieve medewerkers</option>
              <option value="archived">Gearchiveerd</option>
              <option value="all">Alle medewerkers</option>
            </select>
          </div>
          <table class="tbl">
            <thead><tr>
              <th style="cursor:pointer;user-select:none" onclick="sortPeople('name')">Medewerker <span id="sort-name" style="opacity:.3;display:inline-block;width:12px;text-align:center">â†•</span></th>
              <th style="cursor:pointer;user-select:none" onclick="sortPeople('dept')">Department <span id="sort-dept" style="opacity:.3;display:inline-block;width:12px;text-align:center">â†•</span></th>
              <th style="cursor:pointer;user-select:none" onclick="sortPeople('role')">Rol <span id="sort-role" style="opacity:.3;display:inline-block;width:12px;text-align:center">â†•</span></th>
              <th>ğŸ“± GSM</th>
              <th style="cursor:pointer;user-select:none" onclick="sortPeople('schedule')">Rooster <span id="sort-schedule" style="opacity:.3;display:inline-block;width:12px;text-align:center">â†•</span></th>
              <th style="cursor:pointer;user-select:none" onclick="sortPeople('saldo')">Saldo <span id="sort-saldo" style="opacity:.3;display:inline-block;width:12px;text-align:center">â†•</span></th>
              <th>Saldo OV</th>
              <th></th>
            </tr></thead>
            <tbody id="people-table"></tbody>
          </table>
        </div>
      </div>
      <!-- Kandidaten tab -->
      <div id="people-tab-candidates" style="display:none">
        <div class="card-grid card-grid-4" style="margin-bottom:16px">
          <div class="card"><div class="stat"><div class="stat-value" id="cand-st-new" style="color:var(--accent)">0</div><div class="stat-label">Nieuw</div></div></div>
          <div class="card"><div class="stat"><div class="stat-value" id="cand-st-interview" style="color:var(--warn)">0</div><div class="stat-label">Gesprek gepland</div></div></div>
          <div class="card"><div class="stat"><div class="stat-value" id="cand-st-hired" style="color:var(--success)">0</div><div class="stat-label">Aangenomen</div></div></div>
          <div class="card"><div class="stat"><div class="stat-value" id="cand-st-rejected" style="color:var(--danger)">0</div><div class="stat-label">Afgewezen</div></div></div>
        </div>
        <div class="card">
          <div style="display:flex;gap:12px;margin-bottom:16px">
            <div class="search-box" style="flex:1"><input class="form-input" placeholder="Zoek kandidaat..." oninput="searchCandidates(this.value)"/></div>
            <select class="form-input" style="width:160px" id="cand-status-filter" onchange="renderCandidates()">
              <option value="">Alle statussen</option>
              <option value="nieuw">Nieuw</option>
              <option value="gesprek_gepland">Gesprek gepland</option>
              <option value="aangenomen">Aangenomen</option>
              <option value="afgewezen">Afgewezen</option>
            </select>
            <select class="form-input" style="width:160px" id="cand-channel-filter" onchange="renderCandidates()">
              <option value="">Alle kanalen</option>
            </select>
          </div>
          <table class="tbl">
            <thead><tr><th>Kandidaat</th><th>Kanaal</th><th>Positie</th><th>Status</th><th>CV</th><th>Gesprek</th><th></th></tr></thead>
            <tbody id="candidates-table"></tbody>
          </table>
          <button class="btn btn-sm" style="margin-top:12px;width:100%;justify-content:center;border-style:dashed;color:var(--text3)" onclick="openCandidateModal()">â• Kandidaat toevoegen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Departments -->
  <div class="panel" id="page-departments">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Departments</div><div class="page-subtitle" id="dept-count">0 departments</div></div>
        <button class="btn btn-sm btn-primary-outline" onclick="openDeptModal()">â• Department toevoegen</button>
      </div>
      <div class="card-grid card-grid-3" id="dept-grid"></div>
    </div>
  </div>

  <!-- Afwezigheidstypes -->
  <div class="panel" id="page-types">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Afwezigheidstypes</div><div class="page-subtitle">Configureer verlof- en afwezigheidstypes, kleuren en saldo-instellingen</div></div>
        <button class="btn btn-sm btn-primary-outline" onclick="openTypeModal()">â• Type toevoegen</button>
      </div>
      <div class="card">
        <table class="tbl">
          <thead><tr><th>Type</th><th>Categorie</th><th>Betaald</th><th>Saldo bijhouden</th><th>Standaard dagen</th><th></th></tr></thead>
          <tbody id="types-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Instellingen -->
  <div class="panel" id="page-settings">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Instellingen</div><div class="page-subtitle">Werkroosters, feestdagen en jaarovergang</div></div>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="showSettingsTab('schedules',this)">Werkroosters</button>
        <button class="tab" onclick="showSettingsTab('holidays',this)">Feestdagen</button>
        <button class="tab" onclick="showSettingsTab('yearend',this)">Jaarovergang</button>
        <button class="tab" onclick="showSettingsTab('notifications',this)">Notificaties</button>
        <button class="tab" onclick="showSettingsTab('barema',this)">ğŸ’° Barema PC 149.01</button>
        <button class="tab" onclick="showSettingsTab('ancienniteit',this)">ğŸ– AnciÃ«nniteit</button>
        <button class="tab" onclick="showSettingsTab('verlofregels',this)">ğŸ“ Verlofregels</button>
      </div>
      <div id="settings-schedules" class="settings-panel">
        <div class="card">
          <div class="card-title">Werkroosters</div>
          <table class="tbl">
            <thead><tr><th>Naam</th><th>Dagen/week</th><th>Uren/dag</th><th>Halve dagen</th><th></th></tr></thead>
            <tbody id="schedules-table"></tbody>
          </table>
          <button class="btn btn-sm" style="margin-top:12px" onclick="openScheduleModal()">â• Rooster toevoegen</button>
        </div>
      </div>
      <div id="settings-holidays" class="settings-panel" style="display:none">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div class="card-title" style="margin-bottom:0">ğŸ‡§ğŸ‡ª Belgische feestdagen</div>
            <div style="display:flex;gap:8px;align-items:center">
              <label class="form-label" style="margin:0">Regio:</label>
              <select class="form-input" style="width:160px" onchange="setRegion(this.value)" id="region-select">
                <option value="vlaanderen">Vlaanderen</option>
                <option value="wallonie">WalloniÃ«</option>
                <option value="brussel">Brussel</option>
              </select>
            </div>
          </div>
          <table class="tbl">
            <thead><tr><th>Datum</th><th>Feestdag</th><th>Actief</th></tr></thead>
            <tbody id="holidays-table"></tbody>
          </table>
        </div>
      </div>
      <div id="settings-yearend" class="settings-panel" style="display:none">
        <div class="card">
          <div class="card-title">Jaarovergang instellingen</div>
          <div class="form-group">
            <label class="form-label">Overdracht restdagen</label>
            <select class="form-input" id="yearend-mode" onchange="saveSettings()">
              <option value="none">Geen overdracht â€” restdagen vervallen</option>
              <option value="unlimited">Volledige overdracht â€” alles gaat mee</option>
              <option value="max5">Maximum 5 dagen overdragen</option>
              <option value="max10">Maximum 10 dagen overdragen</option>
              <option value="custom">Aangepast maximum</option>
            </select>
          </div>
          <div class="form-group" id="yearend-custom-row" style="display:none">
            <label class="form-label">Maximum aantal dagen</label>
            <input type="number" class="form-input" id="yearend-custom-days" min="1" max="50" value="5" style="width:120px" onchange="saveSettings()"/>
          </div>
        </div>
      </div>
      <div id="settings-notifications" class="settings-panel" style="display:none">
        <div class="card">
          <div class="card-title">Notificatie-instellingen</div>
          <div class="form-group">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px">
              <input type="checkbox" id="notif-email" checked onchange="saveSettings()"/> E-mail notificaties bij nieuwe aanvraag
            </label>
          </div>
          <div class="form-group">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px">
              <input type="checkbox" id="notif-sick" checked onchange="saveSettings()"/> E-mail/SMS bij ziekmelding naar HR + divisie
            </label>
          </div>
        </div>
      </div>
      <div id="settings-barema" class="settings-panel" style="display:none">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div>
              <div class="card-title" style="margin-bottom:2px">ğŸ’° Barema â€” PC 149.01 Elektriciens</div>
              <div style="font-size:11px;color:var(--text3)">Minimumuurlonen per categorie Â· 40u/week</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-sm btn-primary-outline" onclick="addBaremaPeriod()">â• Nieuw barema</button>
              <button class="btn btn-sm btn-primary-outline" onclick="addBaremaIndexation()">â• Nieuwe indexatie</button>
              <button class="btn btn-sm" onclick="openBulkIndexation()" style="background:rgba(34,197,94,.12);color:#16a34a;border-color:#22c55e">ğŸ“ˆ Indexatie toepassen</button>
            </div>
          </div>
          <div style="overflow-x:auto">
            <table class="tbl" id="barema-table">
              <thead id="barema-thead"></thead>
              <tbody id="barema-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="settings-ancienniteit" class="settings-panel" style="display:none">
        <div class="card">
          <div style="margin-bottom:16px">
            <div class="card-title" style="margin-bottom:2px">ğŸ– AnciÃ«nniteitstoeslag â€” PC 149.01</div>
            <div style="font-size:11px;color:var(--text3)">Procentuele toeslag op minimumuurloon</div>
          </div>
          <table class="tbl" id="ancienniteit-table">
            <thead><tr><th style="width:100px">Toeslag</th><th>Omschrijving</th></tr></thead>
            <tbody id="ancienniteit-tbody"></tbody>
          </table>
        </div>
      </div>
      <div id="settings-verlofregels" class="settings-panel" style="display:none">
        <div class="card">
          <div style="margin-bottom:16px">
            <div class="card-title" style="margin-bottom:2px">ğŸ“ Verlofregels</div>
            <div style="font-size:11px;color:var(--text3)">Configureer beperkingen voor verlofaanvragen. Bij overschrijding verschijnt een waarschuwing (geen blokkering).</div>
          </div>
          <div id="verlofregels-content"></div>
        </div>
      </div>
    </div>
  <div class="panel" id="page-wallchart">
    <div class="page" style="max-width:1400px">
      <div class="page-header">
        <div><div class="page-title">Wallchart</div><div class="page-subtitle" id="wc-subtitle">Planningsoverzicht</div></div>
        <div style="display:flex;gap:8px;align-items:center">
          <select class="form-input" style="width:160px" id="wc-dept" onchange="renderWallchart()">
            <option value="">Alle departments</option>
          </select>
          <button class="btn btn-sm" onclick="wcPrev()">â—€</button>
          <button class="btn btn-sm" onclick="wcToday()">Vandaag</button>
          <button class="btn btn-sm" onclick="wcNext()">â–¶</button>
          <button class="btn btn-sm" id="wc-mode-btn" onclick="toggleWcMode()">Maand</button>
        </div>
      </div>
      <div class="card" style="overflow-x:auto;padding:12px">
        <div id="wc-legend" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;font-size:11px"></div>
        <table class="tbl" id="wc-table" style="font-size:11px;min-width:800px">
          <thead id="wc-thead"></thead>
          <tbody id="wc-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Aanvragen -->
  <div class="panel" id="page-requests">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Aanvragen</div><div class="page-subtitle" id="req-count">Verlofaanvragen beheren</div></div>
        <button class="btn btn-sm btn-primary-outline" onclick="openRequestModal()">â• Nieuwe aanvraag</button>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="filterRequests('pending',this)">â³ Openstaand <span id="req-badge-pending"></span></button>
        <button class="tab" onclick="filterRequests('approved',this)">âœ… Goedgekeurd</button>
        <button class="tab" onclick="filterRequests('rejected',this)">âŒ Geweigerd</button>
        <button class="tab" onclick="filterRequests('all',this)">Alles</button>
      </div>
      <div class="card">
        <div style="display:flex;gap:12px;margin-bottom:16px">
          <div class="search-box" style="flex:1"><input class="form-input" placeholder="Zoek op naam..." oninput="searchRequests(this.value)"/></div>
          <select class="form-input" style="width:180px" id="req-dept-filter" onchange="renderRequests()">
            <option value="">Alle departments</option>
          </select>
        </div>
        <div id="req-bulk-bar" style="display:none;padding:10px 14px;background:var(--accent);color:#fff;border-radius:var(--radius-sm);margin-bottom:12px;display:none;align-items:center;gap:12px;font-size:13px">
          <span id="req-bulk-count" style="font-weight:700"></span>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="btn btn-sm" onclick="bulkApprove()" style="background:#fff;color:var(--success);border:none;font-weight:700">âœ… Goedkeuren</button>
            <button class="btn btn-sm" onclick="bulkReject()" style="background:#fff;color:var(--danger);border:none;font-weight:700">âŒ Weigeren</button>
            <button class="btn btn-sm" onclick="clearSelection()" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,.4)">Annuleren</button>
          </div>
        </div>
        <table class="tbl">
          <thead><tr><th id="req-th-check" style="width:32px;display:none"><input type="checkbox" id="req-check-all" onchange="toggleAllRequests(this.checked)" style="cursor:pointer"/></th><th>Medewerker</th><th>Type</th><th>Periode</th><th>Dagen</th><th>Status</th><th>Conflicten</th><th></th></tr></thead>
          <tbody id="requests-table"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Ziekte -->
  <div class="panel" id="page-sickness">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Ziekte</div><div class="page-subtitle">Ziekmeldingen en doktersbriefjes</div></div>
        <button class="btn btn-sm btn-primary-outline" onclick="openSicknessModal()">â• Ziekmelding registreren</button>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="filterSickness('active',this)">ğŸ¤’ Actief ziek</button>
        <button class="tab" onclick="filterSickness('all',this)">Alle meldingen</button>
      </div>
      <div class="card">
        <table class="tbl">
          <thead><tr><th>Medewerker</th><th>Van</th><th>Tot</th><th>Dagen</th><th>Briefje</th><th>Notificaties</th><th></th></tr></thead>
          <tbody id="sickness-table"></tbody>
        </table>
      </div>
      <div class="card" style="margin-top:16px">
        <div class="card-title">ğŸ“Š Bradford Factor <span style="font-weight:400;font-size:11px;color:var(--text3)">(SÂ² Ã— D â€” rollende 52 weken)</span></div>
        <table class="tbl">
          <thead><tr>
            <th>Medewerker</th><th>Periodes (S)</th><th>Totaal dagen (D)</th>
            <th style="cursor:pointer;user-select:none" onclick="sortBradford()">Bradford Score <span id="sort-bradford" style="display:inline-block;width:12px;text-align:center">â†“</span></th>
            <th>Risico</th>
          </tr></thead>
          <tbody id="bradford-table"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Rapportage -->
  <div class="panel" id="page-reports">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Rapportage</div><div class="page-subtitle" id="rp-year-label">Overzichten 2026</div></div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-sm" onclick="exportReportCSV()">ğŸ“Š CSV Export</button>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="showReportTab('overview',this)">ğŸ“Š Jaaroverzicht</button>
        <button class="tab" onclick="showReportTab('perPerson',this)">ğŸ‘¤ Per medewerker</button>
        <button class="tab" onclick="showReportTab('perType',this)">ğŸ·ï¸ Per type</button>
      </div>
      <!-- Jaaroverzicht -->
      <div id="report-overview" class="report-panel">
        <div class="card-grid card-grid-4" style="margin-bottom:16px">
          <div class="card"><div class="stat"><div class="stat-value" id="rp-total-days">0</div><div class="stat-label">Totaal opgenomen</div></div></div>
          <div class="card"><div class="stat"><div class="stat-value" id="rp-total-sick" style="color:var(--danger)">0</div><div class="stat-label">Ziektedagen</div></div></div>
          <div class="card"><div class="stat"><div class="stat-value" id="rp-total-extern" style="color:var(--warn)">0</div><div class="stat-label">Extern (opgelegd)</div></div></div>
          <div class="card"><div class="stat"><div class="stat-value" id="rp-avg-per-person" style="color:var(--accent)">0</div><div class="stat-label">Gem. per medewerker</div></div></div>
        </div>
        <div class="card-grid card-grid-2">
          <div class="card">
            <div class="card-title">ğŸ“Š Afwezigheden per maand</div>
            <div id="rp-chart-legend" style="display:flex;gap:12px;font-size:11px;margin-bottom:8px"></div>
            <div style="display:flex;gap:2px">
              <div id="rp-chart-axis" style="display:flex;flex-direction:column;justify-content:space-between;width:28px;font-size:9px;color:var(--text3);text-align:right;padding:0 4px 18px 0"></div>
              <div style="flex:1">
                <div id="rp-month-chart" style="display:flex;align-items:flex-end;gap:3px;height:140px;padding:0;border-bottom:1px solid var(--border);border-left:1px solid var(--border)"></div>
                <div id="rp-month-labels" style="display:flex;gap:3px;font-size:10px;color:var(--text3);padding-top:4px"></div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">ğŸ·ï¸ Verdeling per type</div>
            <div id="rp-type-donut"></div>
          </div>
        </div>
      </div>
      <!-- Per medewerker -->
      <div id="report-perPerson" class="report-panel" style="display:none">
        <div class="card">
          <table class="tbl">
            <thead><tr><th>Medewerker</th><th>Department</th><th>Totaal recht</th><th>Opgenomen</th><th>Gepland</th><th>Resterend</th><th>Ziektedagen</th></tr></thead>
            <tbody id="rp-person-table"></tbody>
          </table>
        </div>
      </div>
      <!-- Per type -->
      <div id="report-perType" class="report-panel" style="display:none">
        <div class="card">
          <table class="tbl">
            <thead><tr><th>Type</th><th>Categorie</th><th>Totaal dagen</th><th>Aantal aanvragen</th><th>Gem. duur</th></tr></thead>
            <tbody id="rp-type-table"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Modal container -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-title"><span id="modal-title-text"></span><span id="modal-title-actions" style="display:flex;gap:6px;margin-left:auto;margin-right:8px"></span><button class="modal-close" onclick="closeModal()">âœ•</button></div>
    <div id="modal-body" class="modal-body"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
// â•â•â• DATA & CONFIG â•â•â•

const AVATARCOLORS=['#3b82f6','#22c55e','#a855f7','#ef4444','#eab308','#ec4899','#06b6d4','#f97316'];

const DEFAULT_TYPES=[
  // Verlof (aangevraagd door medewerker)
  {id:'wettelijk',name:'Wettelijk verlof',color:'#3b82f6',symbol:'ğŸ–ï¸',paid:true,tracked:true,defaultDays:20,category:'verlof'},
  {id:'adv',name:'ADV',color:'#22c55e',symbol:'ğŸ“…',paid:true,tracked:true,defaultDays:12,category:'adv'},
  {id:'ancienniteit',name:'AnciÃ«nniteitsverlof',color:'#10b981',symbol:'ğŸ…',paid:true,tracked:true,defaultDays:0,category:'verlof'},
  {id:'overuren',name:'Overuren',color:'#eab308',symbol:'â±ï¸',paid:true,tracked:true,defaultDays:0,category:'overuren'},
  {id:'onbetaald',name:'Onbetaald verlof',color:'#94a3b8',symbol:'âšª',paid:false,tracked:true,defaultDays:0,category:'verlof'},
  {id:'opleiding',name:'Opleiding',color:'#a855f7',symbol:'ğŸ“š',paid:true,tracked:false,defaultDays:0,category:'verlof'},
  {id:'huwelijk',name:'Huwelijk medewerker',color:'#ec4899',symbol:'ğŸ’’',paid:true,tracked:false,defaultDays:2,category:'verlof'},
  {id:'huwelijk-kind',name:'Huwelijk kind',color:'#ec4899',symbol:'ğŸ’',paid:true,tracked:false,defaultDays:1,category:'verlof'},
  {id:'overlijden-1',name:'Overlijden partner/kind',color:'#374151',symbol:'ğŸ•¯ï¸',paid:true,tracked:false,defaultDays:3,category:'verlof'},
  {id:'overlijden-2',name:'Overlijden ouder/schoonouder',color:'#374151',symbol:'ğŸ•¯ï¸',paid:true,tracked:false,defaultDays:3,category:'verlof'},
  {id:'overlijden-3',name:'Overlijden broer/zus/schoon-',color:'#6b7280',symbol:'ğŸ•¯ï¸',paid:true,tracked:false,defaultDays:2,category:'verlof'},
  {id:'geboorte',name:'Geboorteverlof',color:'#06b6d4',symbol:'ğŸ‘¶',paid:true,tracked:false,defaultDays:20,category:'verlof'},
  {id:'ouderschaps',name:'Ouderschapsverlof',color:'#0891b2',symbol:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§',paid:false,tracked:false,defaultDays:0,category:'verlof'},
  {id:'communie',name:'Plechtige communie kind',color:'#8b5cf6',symbol:'â›ª',paid:true,tracked:false,defaultDays:1,category:'verlof'},
  {id:'verhuizing',name:'Verhuizing',color:'#f59e0b',symbol:'ğŸ“¦',paid:true,tracked:false,defaultDays:1,category:'verlof'},
  {id:'sollicitatie',name:'Sollicitatieverlof',color:'#64748b',symbol:'ğŸ¤',paid:true,tracked:false,defaultDays:0,category:'verlof'},
  {id:'familiaal',name:'Familiaal verlof',color:'#f472b6',symbol:'ğŸ‘ª',paid:false,tracked:false,defaultDays:0,category:'verlof'},
  {id:'dokter',name:'Doktersbezoek',color:'#14b8a6',symbol:'ğŸ©º',paid:true,tracked:false,defaultDays:0,category:'verlof'},
  {id:'juridisch',name:'Juridische verplichting',color:'#78716c',symbol:'âš–ï¸',paid:true,tracked:false,defaultDays:0,category:'verlof'},
  // Ziekte
  {id:'ziekte',name:'Ziekte',color:'#ef4444',symbol:'ğŸ¤’',paid:true,tracked:false,defaultDays:0,category:'ziekte'},
  {id:'arbeidsongeval',name:'Arbeidsongeval',color:'#dc2626',symbol:'ğŸš‘',paid:true,tracked:false,defaultDays:0,category:'ziekte'},
  {id:'hospitalisatie',name:'Hospitalisatie',color:'#b91c1c',symbol:'ğŸ¥',paid:true,tracked:false,defaultDays:0,category:'ziekte'},
  // Extern (opgelegd)
  {id:'tech-werkloos',name:'Technische werkloosheid',color:'#f97316',symbol:'ğŸ­',paid:false,tracked:false,defaultDays:0,category:'extern'},
  {id:'weerverlet',name:'Weerverlet',color:'#0369a1',symbol:'ğŸŒ§ï¸',paid:false,tracked:false,defaultDays:0,category:'extern'},
  {id:'economisch',name:'Economische werkloosheid',color:'#b45309',symbol:'ğŸ“‰',paid:false,tracked:false,defaultDays:0,category:'extern'},
  {id:'collectief',name:'Collectieve sluiting',color:'#7c3aed',symbol:'ğŸ”’',paid:true,tracked:false,defaultDays:0,category:'extern'}
];

const BE_HOLIDAYS_2025=[
  {date:'2025-01-01',name:'Nieuwjaar',all:true},
  {date:'2025-04-21',name:'Paasmaandag',all:true},
  {date:'2025-05-01',name:'Dag van de Arbeid',all:true},
  {date:'2025-05-29',name:'O.L.H. Hemelvaart',all:true},
  {date:'2025-06-09',name:'Pinkstermaandag',all:true},
  {date:'2025-07-11',name:'Vlaamse feestdag',regions:['vlaanderen']},
  {date:'2025-07-21',name:'Nationale feestdag',all:true},
  {date:'2025-08-15',name:'O.L.V. Hemelvaart',all:true},
  {date:'2025-09-27',name:'Franstalige Gemeenschapsdag',regions:['wallonie','brussel']},
  {date:'2025-11-01',name:'Allerheiligen',all:true},
  {date:'2025-11-11',name:'Wapenstilstand',all:true},
  {date:'2025-12-25',name:'Kerstmis',all:true}
];
const BE_HOLIDAYS_2026=[
  {date:'2026-01-01',name:'Nieuwjaar',all:true},
  {date:'2026-04-06',name:'Paasmaandag',all:true},
  {date:'2026-05-01',name:'Dag van de Arbeid',all:true},
  {date:'2026-05-14',name:'O.L.H. Hemelvaart',all:true},
  {date:'2026-05-25',name:'Pinkstermaandag',all:true},
  {date:'2026-07-11',name:'Vlaamse feestdag',regions:['vlaanderen']},
  {date:'2026-07-21',name:'Nationale feestdag',all:true},
  {date:'2026-08-15',name:'O.L.V. Hemelvaart',all:true},
  {date:'2026-09-27',name:'Franstalige Gemeenschapsdag',regions:['wallonie','brussel']},
  {date:'2026-11-01',name:'Allerheiligen',all:true},
  {date:'2026-11-11',name:'Wapenstilstand',all:true},
  {date:'2026-12-25',name:'Kerstmis',all:true}
];

const DEFAULT_SCHEDULES=[
  {id:'fulltime',name:'Voltijds (5/5)',daysPerWeek:5,hoursPerDay:8,halfDays:true},
  {id:'fourfifths',name:'4/5 regime',daysPerWeek:4,hoursPerDay:8,halfDays:true},
  {id:'halftime',name:'Halftijds',daysPerWeek:5,hoursPerDay:4,halfDays:false}
];

let currentRole='admin';
let activePage='dashboard';

// Data stores (localStorage backed)
let departments=[];
let people=[];
let leaveTypes=[];
let schedules=[];
let requests=[];
let candidates=[];
let channels=[];

const DEFAULT_CHANNELS=[
  {id:'indeed',name:'Indeed',color:'#2164f3'},
  {id:'linkedin',name:'LinkedIn',color:'#0077b5'},
  {id:'spontaan',name:'Spontaan',color:'#22c55e'},
  {id:'referral',name:'Doorverwijzing',color:'#a855f7'},
  {id:'vdab',name:'VDAB',color:'#ef4444'},
  {id:'andere',name:'Andere',color:'#94a3b8'}
];
let settings={region:'vlaanderen',yearendMode:'max5',yearendCustomDays:5,
  notifEmail:true,notifSick:true};

// Verlofregels per department
let verlofregels=[];
const DEFAULT_VERLOFREGELS=[
  {id:'max-afwezig',label:'Max. gelijktijdig afwezig',desc:'Maximum aantal medewerkers dat tegelijk afwezig mag zijn binnen een department',icon:'ğŸš«',perDept:true,defaults:{}},
  {id:'min-bezetting',label:'Min. bezetting',desc:'Minimum aantal medewerkers dat aanwezig moet zijn binnen een department',icon:'ğŸ‘¥',perDept:true,defaults:{}},
  {id:'max-opeenvolgend',label:'Max. opeenvolgende verlofdagen',desc:'Maximum aantal aaneensluitende verlofdagen per aanvraag',icon:'ğŸ“…',perDept:false,value:15},
  {id:'min-vooraf',label:'Min. dagen op voorhand',desc:'Minimum aantal werkdagen dat een aanvraag op voorhand moet worden ingediend',icon:'â°',perDept:false,value:5}
];

// Barema PC 149.01 data
const BAREMA_CATEGORIES=[
  {id:'A',name:'Hulpwerkman',desc:'Geen of beperkte vakkennis. Voert eenvoudige taken uit onder toezicht.'},
  {id:'B',name:'Geoefend werkman 2e cat.',desc:'Bezit basisvaardigheden door ervaring of korte opleiding.'},
  {id:'C',name:'Geoefend werkman 1e cat.',desc:'Kan eenvoudige vakkundige werkzaamheden zelfstandig uitvoeren.'},
  {id:'D',name:'Geschoolde arbeider 3e cat.',desc:'Gekwalificeerd vakman. Voert vakkundige werken zelfstandig uit.'},
  {id:'E',name:'Geschoolde arbeider 2e cat.',desc:'Ervaren vakman. Werkt zelfstandig op basis van plan en lastenboek.'},
  {id:'F',name:'Geschoolde arbeider 1e cat.',desc:'Hoogst gekwalificeerd. Geeft leiding, controleert, past plannen aan.'}
];
let baremaData=[];  // [{date:'2026-01-01', rates:{A:15.82,B:16.41,...}}]

// AnciÃ«nniteit PC 149.01: +1% na 1j, +0.5%/j vanaf 2j, max 13%
let ancienniteitData=[];  // [{years:0,pct:0},{years:1,pct:1.00},...]

// Salaris mutatie-types (admin-uitbreidbaar)
let salaryReasonTypes=[
  {id:'start',name:'Startsalaris',icon:'ğŸŸ¢',system:true},
  {id:'index',name:'Indexatie',icon:'ğŸ“ˆ',system:true},
  {id:'ancienniteit',name:'AnciÃ«nniteit',icon:'ğŸ–',system:true},
  {id:'ervaring',name:'Ervaring',icon:'â­',system:false},
  {id:'promotie',name:'Promotie',icon:'ğŸš€',system:false},
  {id:'diploma',name:'Diploma',icon:'ğŸ“',system:false}
];

// Werkgeverskost componenten PC 149.01 arbeiders
let werkgeverskostData=[
  {id:'rsz',name:'RSZ werkgever',pct:30.57,editable:true},
  {id:'vakantie-trim',name:'Jaarlijkse vakantie (trimestrieel)',pct:5.57,editable:true},
  {id:'vakantie-jaar',name:'Jaarlijkse vakantie (jaarlijks)',pct:10.27,editable:true},
  {id:'eindejaar',name:'Eindejaarspremie',pct:8.33,editable:true},
  {id:'arbeidsongevallen',name:'Arbeidsongevallenverzekering',pct:2.50,editable:true},
  {id:'fbz',name:'FBZ (Fonds bestaanszekerheid)',pct:5.00,editable:true},
  {id:'sap',name:'Aanvullend pensioen (SAP)',pct:1.10,editable:true}
];

// Uurkost parameters
let uurkostParams={
  werkdagenJaar:260,
  verlofDagen:20,
  feestdagen:10,
  advDagen:12,
  urenPerDag:8
};

// â•â•â• CORE (data-helpers, autoSave, restore) â•â•â•


const SALARY_TYPE_START='start';

function formatPhone(val){
  if(!val)return '';
  var digits=val.replace(/[^\d+]/g,'');
  var hasPlus=digits.startsWith('+');
  digits=digits.replace(/\+/g,'');
  if(hasPlus&&digits.startsWith('32'))digits=digits.substring(2);
  else if(!hasPlus&&digits.startsWith('0032'))digits=digits.substring(4);
  if(digits.startsWith('0'))digits=digits.substring(1);
  if(digits.length===0)return '';
  // Belgische nummers: 9 cijfers (GSM 4xx) of 8 cijfers (vast)
  // 1-cijfer zonecodes: 2(Brussel),3(Antwerpen),4(Luik),9(Gent)
  var singleZone=['2','3','4','9'];
  var parts=[];
  if(digits.length===9&&digits.charAt(0)==='4'){
    // GSM: 4xx xx xx xx
    parts=[digits.substring(0,3),digits.substring(3,5),digits.substring(5,7),digits.substring(7,9)];
  } else if(digits.length===8&&singleZone.indexOf(digits.charAt(0))!==-1){
    // Vast 1-cijfer zone: x xxx xx xx
    parts=[digits.substring(0,1),digits.substring(1,4),digits.substring(4,6),digits.substring(6,8)];
  } else if(digits.length===8){
    // Vast 2-cijfer zone: xx xx xx xx
    parts=[digits.substring(0,2),digits.substring(2,4),digits.substring(4,6),digits.substring(6,8)];
  } else {
    // Onbekend formaat: groepeer van rechts per 2
    var i=digits.length;
    while(i>0){var take=Math.min(2,i);parts.unshift(digits.substring(i-take,i));i-=take;}
  }
  return '+32 '+parts.join(' ');
}

function sanitize(str){
  if(!str)return '';
  const d=document.createElement('div');d.textContent=str;return d.innerHTML;
}

function isValidDate(dateStr){
  if(!dateStr)return false;
  const d=new Date(dateStr);
  return d instanceof Date && !isNaN(d.getTime());
}

function disableBtnTemporarily(btn){
  if(!btn)return;
  btn.disabled=true;btn.style.opacity='.5';
  setTimeout(function(){btn.disabled=false;btn.style.opacity='1';},1000);
}

function uid(){return Date.now().toString(36)+'_'+Math.random().toString(36).substr(2,5);}

function autoSave(){
  try{
    localStorage.setItem('vb_departments',JSON.stringify(departments));
    localStorage.setItem('vb_people',JSON.stringify(people));
    localStorage.setItem('vb_leaveTypes',JSON.stringify(leaveTypes));
    localStorage.setItem('vb_schedules',JSON.stringify(schedules));
    localStorage.setItem('vb_requests',JSON.stringify(requests));
    localStorage.setItem('vb_candidates',JSON.stringify(candidates));
    localStorage.setItem('vb_channels',JSON.stringify(channels));
    localStorage.setItem('vb_settings',JSON.stringify(settings));
    localStorage.setItem('vb_barema',JSON.stringify(baremaData));
    localStorage.setItem('vb_ancienniteit',JSON.stringify(ancienniteitData));
    localStorage.setItem('vb_salaryReasons',JSON.stringify(salaryReasonTypes));
    localStorage.setItem('vb_werkgeverskost',JSON.stringify(werkgeverskostData));
    localStorage.setItem('vb_uurkostParams',JSON.stringify(uurkostParams));
    localStorage.setItem('vb_verlofregels',JSON.stringify(verlofregels));
  }catch(e){showToast('Opslag fout: '+e.message,'error');}
}

function restore(){
  try{
    const d=localStorage.getItem('vb_departments');if(d)departments=JSON.parse(d);
    const p=localStorage.getItem('vb_people');if(p)people=JSON.parse(p);
    const t=localStorage.getItem('vb_leaveTypes');if(t)leaveTypes=JSON.parse(t);
    const s=localStorage.getItem('vb_schedules');if(s)schedules=JSON.parse(s);
    const r=localStorage.getItem('vb_requests');if(r)requests=JSON.parse(r);
    const ca=localStorage.getItem('vb_candidates');if(ca)candidates=JSON.parse(ca);
    const ch=localStorage.getItem('vb_channels');if(ch)channels=JSON.parse(ch);
    const st=localStorage.getItem('vb_settings');if(st)Object.assign(settings,JSON.parse(st));
    const ba=localStorage.getItem('vb_barema');if(ba)baremaData=JSON.parse(ba);
    const anc=localStorage.getItem('vb_ancienniteit');if(anc)ancienniteitData=JSON.parse(anc);
    const sr=localStorage.getItem('vb_salaryReasons');if(sr)salaryReasonTypes=JSON.parse(sr);
    const wk=localStorage.getItem('vb_werkgeverskost');if(wk)werkgeverskostData=JSON.parse(wk);
    const up=localStorage.getItem('vb_uurkostParams');if(up)uurkostParams=JSON.parse(up);
    const vr=localStorage.getItem('vb_verlofregels');if(vr)verlofregels=JSON.parse(vr);
  }catch(e){console.error('Restore error:',e);}
  if(leaveTypes.length===0){leaveTypes=[...DEFAULT_TYPES];}
  else{
    // Add missing default types (upgrade path)
    DEFAULT_TYPES.forEach(dt=>{if(!leaveTypes.find(t=>t.id===dt.id))leaveTypes.push({...dt});});
  }
  if(schedules.length===0)schedules=DEFAULT_SCHEDULES.map(s=>({...s}));
  if(channels.length===0){channels=[...DEFAULT_CHANNELS];}
  else{DEFAULT_CHANNELS.forEach(dc=>{if(!channels.find(c=>c.id===dc.id))channels.push({...dc});});}
}

function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast toast-'+type+' show';
  setTimeout(()=>t.classList.remove('show'),3000);
}

function fullName(p){return (p.firstName||'')+' '+(p.lastName||'');}
function getInitials(name){return name.split(' ').map(w=>w[0]).join('').toUpperCase().substr(0,2);}
function getChannelName(id){const ch=channels.find(c=>c.id===id);return ch?ch.name:id;}
function getChannelColor(id){const ch=channels.find(c=>c.id===id);return ch?ch.color:'#94a3b8';}
function getAvatarColor(name){let h=0;for(let i=0;i<name.length;i++)h=name.charCodeAt(i)+((h<<5)-h);return AVATARCOLORS[Math.abs(h)%AVATARCOLORS.length];}

function formatDate(d){return new Date(d).toLocaleDateString('nl-BE',{day:'2-digit',month:'2-digit',year:'numeric'});}
function formatDateShort(d){return new Date(d).toLocaleDateString('nl-BE',{day:'numeric',month:'short'});}

// â•â•â• HUB / NAVIGATIE â•â•â•

function highlightCard(cardId){
  var el=document.getElementById(cardId);
  if(!el)return;
  el.scrollIntoView({behavior:'smooth',block:'center'});
  el.style.transition='box-shadow .2s, transform .2s';
  el.style.boxShadow='0 0 0 3px var(--accent)';
  el.style.transform='scale(1.02)';
  setTimeout(function(){
    el.style.boxShadow='';
    el.style.transform='';
  },1500);
}

function showPage(page){
  // Always close any open modal first
  closeModal();
  // P8: Clear bulk selection state
  document.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
  activePage=page;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.querySelectorAll('.sb-item').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(b=>{
    if(b.onclick&&b.onclick.toString().includes("'"+page+"'"))b.classList.add('active');
  });
  if(page==='people'){renderPeople();const b=document.getElementById('btn-new-person');if(b)b.style.display=canCreate()?'':'none';}
  if(page==='departments')renderDepartments();
  if(page==='types')renderTypes();
  if(page==='settings')renderSettings();
  if(page==='dashboard')renderDashboard();
  if(page==='requests')renderRequests();
  if(page==='sickness')renderSickness();
  if(page==='wallchart')renderWallchart();
  if(page==='reports')renderReports();
}

function setRole(role,btn){
  currentRole=role;
  document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  showToast('Rol gewijzigd naar: '+role,'success');
}

function showSettingsTab(tab,btn){
  document.querySelectorAll('.settings-panel').forEach(p=>p.style.display='none');
  document.getElementById('settings-'+tab).style.display='block';
  btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  if(tab==='barema')renderBarema();
  if(tab==='ancienniteit')renderAncienniteit();
}

function closeModal(){document.getElementById('modal-overlay').classList.remove('show');}

let _confirmResolve=null;
function confirmDialog(msg){
  return new Promise(resolve=>{
    _confirmResolve=resolve;
    const overlay=document.createElement('div');
    overlay.id='confirm-overlay';
    overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:10001';
    overlay.innerHTML=`<div style="background:#fff;border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)">
      <div style="font-size:14px;line-height:1.5;margin-bottom:20px;white-space:pre-line">${msg}</div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" onclick="resolveConfirm(false)">Annuleren</button>
        <button class="btn btn-primary" onclick="resolveConfirm(true)">Bevestigen</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
  });
}
function resolveConfirm(val){
  const el=document.getElementById('confirm-overlay');
  if(el)el.remove();
  if(_confirmResolve)_confirmResolve(val);
  _confirmResolve=null;
}

let _promptResolve=null;
function promptDialog(msg,placeholder){
  return new Promise(resolve=>{
    _promptResolve=resolve;
    const overlay=document.createElement('div');
    overlay.id='prompt-overlay';
    overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:10001';
    overlay.innerHTML=`<div style="background:#fff;border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)">
      <div style="font-size:14px;line-height:1.5;margin-bottom:12px">${msg}</div>
      <input class="form-input" id="prompt-input" placeholder="${placeholder||''}" style="margin-bottom:16px"/>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" onclick="resolvePrompt(null)">Annuleren</button>
        <button class="btn btn-primary" onclick="resolvePrompt(document.getElementById('prompt-input').value)">OK</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
    setTimeout(()=>{const inp=document.getElementById('prompt-input');if(inp)inp.focus();},50);
  });
}
function resolvePrompt(val){
  const el=document.getElementById('prompt-overlay');
  if(el)el.remove();
  if(_promptResolve)_promptResolve(val);
  _promptResolve=null;
}

function openModal(title,html,wide){
  const modal=document.querySelector('.modal');
  modal.classList.toggle('modal-wide',!!wide);
  document.getElementById('modal-title-text').textContent=title;
  document.getElementById('modal-title-actions').innerHTML='';
  document.getElementById('modal-body').innerHTML=html;
  document.getElementById('modal-overlay').classList.add('show');
  const firstInput=document.querySelector('#modal-body input,#modal-body select');
  if(firstInput)setTimeout(()=>firstInput.focus(),100);
}

// â•â•â• RENDERING â•â•â•

let peopleTab='employees';
let candSearch='';

function showPeopleTab(tab,btn){
  peopleTab=tab;
  document.getElementById('people-tab-employees').style.display=tab==='employees'?'block':'none';
  document.getElementById('people-tab-candidates').style.display=tab==='candidates'?'block':'none';
  btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  const actions=document.getElementById('people-header-actions');
  if(tab==='employees'){
    actions.innerHTML=canCreate()?'<button class="btn btn-sm btn-primary-outline" onclick="openPersonModal()">â• Medewerker toevoegen</button>':'';
    document.getElementById('people-title').textContent='Medewerkers';
    renderPeople();
  }else{
    actions.innerHTML=canCreate()?'<button class="btn btn-sm btn-primary-outline" onclick="openCandidateModal()">â• Kandidaat toevoegen</button>':'';
    document.getElementById('people-title').textContent='Kandidaten';
    renderCandidates();
  }
}

function renderCandidates(){
  const tbody=document.getElementById('candidates-table');
  const statusFilter=document.getElementById('cand-status-filter').value;
  const channelFilter=document.getElementById('cand-channel-filter').value;
  
  let filtered=[...candidates];
  if(statusFilter)filtered=filtered.filter(c=>c.status===statusFilter);
  if(channelFilter)filtered=filtered.filter(c=>c.channel===channelFilter);
  if(candSearch){
    const q=candSearch.toLowerCase();
    filtered=filtered.filter(c=>c.name.toLowerCase().includes(q)||(c.position||'').toLowerCase().includes(q));
  }
  filtered.sort((a,b)=>new Date(b.createdDate)-new Date(a.createdDate));

  // Stats
  document.getElementById('cand-st-new').textContent=candidates.filter(c=>c.status==='nieuw').length;
  document.getElementById('cand-st-interview').textContent=candidates.filter(c=>c.status==='gesprek_gepland').length;
  document.getElementById('cand-st-hired').textContent=candidates.filter(c=>c.status==='aangenomen').length;
  document.getElementById('cand-st-rejected').textContent=candidates.filter(c=>c.status==='afgewezen').length;
  
  const newCount=candidates.filter(c=>c.status==='nieuw'||c.status==='gesprek_gepland').length;
  document.getElementById('cand-badge').textContent=newCount>0?` (${newCount})`:'';
  document.getElementById('people-count').textContent=peopleTab==='employees'?
    people.length+' medewerker'+(people.length!==1?'s':''):
    candidates.length+' kandidaat'+(candidates.length!==1?'kandidaten':'');

  // Populate channel filter dynamically
  const chFilter=document.getElementById('cand-channel-filter');
  const chFilterVal=chFilter.value;
  chFilter.innerHTML='<option value="">Alle kanalen</option>'+channels.map(ch=>`<option value="${ch.id}">${ch.name}</option>`).join('');
  chFilter.value=chFilterVal;

  const statusLabels={nieuw:'ğŸ†• Nieuw',gesprek_gepland:'ğŸ“… Gesprek gepland',aangenomen:'âœ… Aangenomen',afgewezen:'âŒ Afgewezen'};
  const statusBadges={nieuw:'badge-blue',gesprek_gepland:'badge-yellow',aangenomen:'badge-green',afgewezen:'badge-red'};

  if(filtered.length===0){
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3)">Geen kandidaten gevonden. Klik op "Kandidaat toevoegen" om te starten.</td></tr>';
    return;
  }
  tbody.innerHTML=filtered.map(c=>{
    const chColor=getChannelColor(c.channel);
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:10px">
        <div class="avatar" style="background:${getAvatarColor(c.name)};width:32px;height:32px;font-size:12px">${getInitials(c.name)}</div>
        <div><div style="font-weight:600">${c.name}</div>
        <div style="font-size:11px;color:var(--text3)">${c.email||'Geen e-mail'}</div></div>
      </div></td>
      <td><span class="badge" style="background:${chColor}1a;color:${chColor}">${getChannelName(c.channel)}</span></td>
      <td style="font-size:13px">${c.position||'â€”'}</td>
      <td><span class="badge ${statusBadges[c.status]||'badge-gray'}">${statusLabels[c.status]||c.status}</span></td>
      <td>${c.cvFile?'<span class="badge badge-green">ğŸ“„ CV</span>':'<span style="color:var(--text3);font-size:12px">â€”</span>'}</td>
      <td>${c.interviews&&c.interviews.length>0?`<span class="badge badge-blue">ğŸ’¬ ${c.interviews.length}</span>`:
        '<span style="color:var(--text3);font-size:12px">â€”</span>'}</td>
      <td style="text-align:right;white-space:nowrap">
        <button class="btn btn-sm" onclick="viewCandidate('${c.id}')" title="Details" aria-label="Details">ğŸ‘</button>
        <button class="btn btn-sm" onclick="openCandidateModal('${c.id}')" title="Bewerken" aria-label="Bewerken">âœï¸</button>
        ${c.status!=='aangenomen'?`<button class="btn btn-sm" onclick="hireCandidate('${c.id}')" title="Aannemen" aria-label="Aannemen" style="color:var(--success)">âœ…</button>`:''}
        <button class="btn btn-sm btn-danger" onclick="deleteCandidate('${c.id}')" title="Verwijderen" aria-label="Verwijderen">ğŸ—‘</button>
      </td>
    </tr>`;
  }).join('');
}

function searchCandidates(q){candSearch=q;renderCandidates();}

function openChannelsModal(returnCandidateId){
  const rows=channels.map(ch=>{
    const inUse=candidates.filter(c=>c.channel===ch.id).length;
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
      <span class="clr-dot" style="background:${ch.color};width:12px;height:12px"></span>
      <span style="flex:1;font-weight:600;font-size:13px">${ch.name}</span>
      <span style="font-size:11px;color:var(--text3)">${inUse} kandidaat${inUse!==1?'en':''}</span>
      <button class="btn btn-sm btn-icon" onclick="editChannel('${ch.id}','${returnCandidateId}')" title="Bewerken" aria-label="Bewerken">âœï¸</button>
      ${inUse===0?`<button class="btn btn-sm btn-icon btn-danger" onclick="deleteChannel('${ch.id}','${returnCandidateId}')" title="Verwijderen" aria-label="Verwijderen">ğŸ—‘</button>`
        :`<span style="font-size:11px;color:var(--text3);padding:0 6px" title="Kan niet verwijderd worden â€” ${inUse} kandidaat${inUse!==1?'en':''} gekoppeld">ğŸ”’</span>`}
    </div>`;
  }).join('');
  
  openModal('Kanalen beheren',`
    <div style="margin-bottom:16px">${rows||'<div style="color:var(--text3);font-size:13px;text-align:center;padding:16px">Nog geen kanalen</div>'}</div>
    <div style="border-top:1px solid var(--border);padding-top:16px">
      <div style="font-weight:700;font-size:13px;margin-bottom:10px">Kanaal toevoegen</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Naam <span class="req">*</span></label>
          <input class="form-input" id="mch-name" placeholder="Bv. StepStone" onkeydown="if(event.key==='Enter')addChannel('${returnCandidateId}')"/>
        </div>
        <div class="form-group">
          <label class="form-label">Kleur</label>
          <input type="color" class="form-input" id="mch-color" value="#3b82f6" style="width:60px;height:36px;padding:2px"/>
        </div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="addChannel('${returnCandidateId}')">â• Toevoegen</button>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="${returnCandidateId?`openCandidateModal('${returnCandidateId}')`:'closeModal()'}">Terug</button>
    </div>
  `);
}

function editChannel(chId,returnCandidateId){
  const ch=channels.find(c=>c.id===chId);if(!ch)return;
  openModal('Kanaal bewerken',`
    <div class="form-group">
      <label class="form-label">Naam <span class="req">*</span></label>
      <input class="form-input" id="mche-name" value="${ch.name}" onkeydown="if(event.key==='Enter')saveEditChannel('${chId}','${returnCandidateId}')"/>
    </div>
    <div class="form-group">
      <label class="form-label">Kleur</label>
      <input type="color" class="form-input" id="mche-color" value="${ch.color}" style="width:60px;height:36px;padding:2px"/>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="openChannelsModal('${returnCandidateId}')">Annuleren</button>
      <button class="btn btn-primary" onclick="saveEditChannel('${chId}','${returnCandidateId}')">Opslaan</button>
    </div>
  `);
}

function saveEditChannel(chId,returnCandidateId){
  const name=document.getElementById('mche-name').value.trim();
  const color=document.getElementById('mche-color').value;
  if(!name){showToast('Naam is verplicht','error');return;}
  const ch=channels.find(c=>c.id===chId);
  if(ch){ch.name=name;ch.color=color;}
  autoSave();
  showToast('Kanaal bijgewerkt');
  openChannelsModal(returnCandidateId);
}

function addChannel(returnCandidateId){
  const name=document.getElementById('mch-name').value.trim();
  const color=document.getElementById('mch-color').value;
  if(!name){showToast('Naam is verplicht','error');return;}
  const id=name.toLowerCase().replace(/[^a-z0-9]/g,'-');
  if(channels.find(c=>c.id===id)){showToast('Dit kanaal bestaat al','error');return;}
  channels.push({id,name,color});
  autoSave();
  showToast('Kanaal toegevoegd');
  openChannelsModal(returnCandidateId);
}

async function deleteChannel(id,returnCandidateId){
  const ch=channels.find(c=>c.id===id);
  const inUse=candidates.filter(c=>c.channel===id).length;
  if(inUse>0){showToast(`Kan niet verwijderen: ${inUse} kandidaat/kandidaten gebruiken dit kanaal`,'error');return;}
  if(!await confirmDialog(`Kanaal "${ch?ch.name:id}" verwijderen?`))return;
  channels=channels.filter(c=>c.id!==id);
  autoSave();
  showToast('Kanaal verwijderd');
  openChannelsModal(returnCandidateId);
}

function openCandidateModal(id){
  const c=id?candidates.find(x=>x.id===id):null;
  openModal(c?'Kandidaat bewerken':'Kandidaat toevoegen',`
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Naam <span class="req">*</span></label>
        <input class="form-input" id="mc-name" value="${c?c.name:''}"/>
      </div>
      <div class="form-group">
        <label class="form-label">E-mail</label>
        <input class="form-input" type="email" id="mc-email" value="${c?c.email||'':''}"/>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Telefoon</label>
        <input class="form-input" id="mc-phone" value="${c?c.phone||'':''}"/>
      </div>
      <div class="form-group">
        <label class="form-label">Positie / Functie</label>
        <input class="form-input" id="mc-position" value="${c?c.position||'':''}" placeholder="Bv. Installateur, Servicetechnicus"/>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Kanaal <span class="req">*</span> <button class="btn btn-sm btn-icon" onclick="openChannelsModal('${id||''}')" title="Kanalen beheren" aria-label="Kanalen beheren" style="margin-left:4px;vertical-align:middle;width:24px;height:24px;font-size:11px">âœï¸</button></label>
        <select class="form-input" id="mc-channel">
          ${channels.map(ch=>`<option value="${ch.id}" ${c&&c.channel===ch.id?'selected':''}>${ch.name}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-input" id="mc-status">
          <option value="nieuw" ${c&&c.status==='nieuw'?'selected':''}>ğŸ†• Nieuw</option>
          <option value="gesprek_gepland" ${c&&c.status==='gesprek_gepland'?'selected':''}>ğŸ“… Gesprek gepland</option>
          <option value="aangenomen" ${c&&c.status==='aangenomen'?'selected':''}>âœ… Aangenomen</option>
          <option value="afgewezen" ${c&&c.status==='afgewezen'?'selected':''}>âŒ Afgewezen</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">CV uploaden (PDF/afbeelding)</label>
      <input type="file" accept=".pdf,image/*" class="form-input" id="mc-cv" style="padding:6px"/>
      ${c&&c.cvFile?`<div style="margin-top:6px;font-size:12px;color:var(--success)">ğŸ“„ CV reeds geÃ¼pload (${c.cvFileName||'bestand'})</div>`:''}
    </div>
    <div class="form-group">
      <label class="form-label">Notities</label>
      <textarea class="form-input" id="mc-notes" rows="3" style="resize:vertical" placeholder="Eerste indruk, opmerkingen...">${c?c.notes||'':''}</textarea>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveCandidate('${id||''}')">Opslaan</button>
    </div>
  `);
  // Handle CV upload
  document.getElementById('mc-cv').addEventListener('change',function(e){
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=function(ev){
      document.getElementById('mc-cv').dataset.fileData=ev.target.result;
      document.getElementById('mc-cv').dataset.fileName=file.name;
    };
    reader.readAsDataURL(file);
  });
}

function saveCandidate(id){
  const name=document.getElementById('mc-name').value.trim();
  const email=document.getElementById('mc-email').value.trim();
  const phone=document.getElementById('mc-phone').value.trim();
  const position=document.getElementById('mc-position').value.trim();
  const channel=document.getElementById('mc-channel').value;
  const status=document.getElementById('mc-status').value;
  const notes=document.getElementById('mc-notes').value.trim();
  const cvInput=document.getElementById('mc-cv');
  
  if(!name){showToast('Naam is verplicht','error');return;}
  
  const data={name,email,phone,position,channel,status,notes};
  
  if(cvInput.dataset.fileData){
    data.cvFile=cvInput.dataset.fileData;
    data.cvFileName=cvInput.dataset.fileName;
  }
  
  if(id){
    const c=candidates.find(x=>x.id===id);
    if(c){
      // Preserve existing CV if no new one uploaded
      if(!data.cvFile&&c.cvFile){data.cvFile=c.cvFile;data.cvFileName=c.cvFileName;}
      if(!data.cvFile){data.cvFile=c.cvFile;data.cvFileName=c.cvFileName;}
      Object.assign(c,data);
    }
  }else{
    candidates.push({id:uid(),...data,interviews:[],createdDate:new Date().toISOString().split('T')[0]});
  }
  closeModal();autoSave();renderCandidates();
  showToast('Kandidaat opgeslagen');
}

function viewCandidate(id){
  const c=candidates.find(x=>x.id===id);if(!c)return;
  const statusLabels={nieuw:'ğŸ†• Nieuw',gesprek_gepland:'ğŸ“… Gesprek gepland',aangenomen:'âœ… Aangenomen',afgewezen:'âŒ Afgewezen'};
  
  let interviewHtml='';
  if(c.interviews&&c.interviews.length>0){
    interviewHtml=c.interviews.map((iv,i)=>`
      <div style="padding:12px;background:var(--surface2);border-radius:var(--radius-xs);margin-bottom:8px;border-left:3px solid var(--accent)">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <span style="font-weight:700;font-size:13px">ğŸ’¬ Gesprek ${i+1} â€” ${formatDate(iv.date)}</span>
          <button class="btn btn-sm btn-danger" onclick="deleteInterview('${c.id}',${i})">ğŸ—‘</button>
        </div>
        ${iv.interviewer?`<div style="font-size:12px;color:var(--text3);margin-bottom:4px">Interviewer: ${iv.interviewer}</div>`:''}
        <div style="font-size:13px;white-space:pre-wrap">${iv.summary}</div>
        ${iv.rating?`<div style="margin-top:6px">${'â­'.repeat(iv.rating)}${'â˜†'.repeat(5-iv.rating)}</div>`:''}
      </div>
    `).join('');
  }
  
  openModal(`ğŸ“„ ${c.name}`,`
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:12px;background:var(--surface2);border-radius:var(--radius-sm)">
      <div class="avatar" style="background:${getAvatarColor(c.name)}">${getInitials(c.name)}</div>
      <div style="flex:1">
        <div style="font-weight:700">${c.name}</div>
        <div style="font-size:12px;color:var(--text3)">${c.position||'Geen positie opgegeven'}</div>
      </div>
      <span class="badge ${c.status==='aangenomen'?'badge-green':c.status==='afgewezen'?'badge-red':'badge-blue'}">${statusLabels[c.status]||c.status}</span>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:13px;margin-bottom:20px">
      <div><span style="color:var(--text3)">E-mail:</span> <strong>${c.email||'â€”'}</strong></div>
      <div><span style="color:var(--text3)">Telefoon:</span> <strong>${c.phone||'â€”'}</strong></div>
      <div><span style="color:var(--text3)">Kanaal:</span> <strong>${getChannelName(c.channel)}</strong></div>
      <div><span style="color:var(--text3)">Ontvangen:</span> <strong>${c.createdDate?formatDate(c.createdDate):'â€”'}</strong></div>
    </div>
    ${c.cvFile?`<div style="margin-bottom:16px"><a href="${c.cvFile}" download="${c.cvFileName||'cv.pdf'}" class="btn btn-sm">ğŸ“„ CV downloaden (${c.cvFileName||'bestand'})</a></div>`:''}
    ${c.notes?`<div style="padding:10px;background:var(--surface2);border-radius:var(--radius-xs);font-size:13px;margin-bottom:16px"><strong>Notities:</strong><div style="margin-top:4px;white-space:pre-wrap">${c.notes}</div></div>`:''}
    <div style="margin-bottom:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <span style="font-weight:700;font-size:14px">ğŸ’¬ Sollicitatiegesprekken (${c.interviews?c.interviews.length:0})</span>
        <button class="btn btn-sm btn-primary-outline" onclick="openInterviewModal('${c.id}')">â• Gesprek toevoegen</button>
      </div>
      ${interviewHtml||'<div style="font-size:13px;color:var(--text3);padding:12px;text-align:center">Nog geen gesprekken geregistreerd</div>'}
    </div>
    <div class="modal-actions">
      ${c.status!=='aangenomen'?`<button class="btn" onclick="hireCandidate('${c.id}');closeModal()" style="color:var(--success)">âœ… Aannemen</button>`:''}
      <button class="btn" onclick="closeModal()">Sluiten</button>
    </div>
  `);
}

function openInterviewModal(candidateId){
  const c=candidates.find(x=>x.id===candidateId);if(!c)return;
  const today=new Date().toISOString().split('T')[0];
  openModal(`ğŸ’¬ Gesprek toevoegen â€” ${c.name}`,`
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Datum <span class="req">*</span></label>
        <input class="form-input" type="date" id="mi-date" value="${today}"/>
      </div>
      <div class="form-group">
        <label class="form-label">Interviewer</label>
        <select class="form-input" id="mi-interviewer">
          <option value="">Selecteer...</option>
          ${people.filter(p=>p.role==='admin'||p.isApprover).map(p=>`<option value="${fullName(p)}">${fullName(p)}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Beoordeling</label>
      <div style="display:flex;gap:8px" id="mi-rating-btns">
        ${[1,2,3,4,5].map(n=>`<button class="btn btn-sm" onclick="setInterviewRating(${n},this)">${'â­'.repeat(n)}</button>`).join('')}
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Samenvatting gesprek <span class="req">*</span></label>
      <textarea class="form-input" id="mi-summary" rows="6" style="resize:vertical" placeholder="Indruk, sterke punten, aandachtspunten, conclusie..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="viewCandidate('${candidateId}')">Terug</button>
      <button class="btn btn-primary" onclick="saveInterview('${candidateId}')">Opslaan</button>
    </div>
  `);
}

let interviewRating=0;
function setInterviewRating(n,btn){
  interviewRating=n;
  btn.parentElement.querySelectorAll('.btn').forEach((b,i)=>{
    b.classList.toggle('btn-primary',i<n);
  });
}

function saveInterview(candidateId){
  const date=document.getElementById('mi-date').value;
  const interviewer=document.getElementById('mi-interviewer').value;
  const summary=document.getElementById('mi-summary').value.trim();
  if(!date){showToast('Datum is verplicht','error');return;}
  if(!summary){showToast('Samenvatting is verplicht','error');return;}
  const c=candidates.find(x=>x.id===candidateId);if(!c)return;
  if(!c.interviews)c.interviews=[];
  c.interviews.push({date,interviewer,summary,rating:interviewRating});
  if(c.status==='nieuw')c.status='gesprek_gepland';
  interviewRating=0;
  autoSave();viewCandidate(candidateId);
  showToast('Gesprek opgeslagen');
}

async function deleteInterview(candidateId,idx){
  if(!await confirmDialog('Gespreknotitie verwijderen?'))return;
  const c=candidates.find(x=>x.id===candidateId);
  if(c&&c.interviews){c.interviews.splice(idx,1);autoSave();viewCandidate(candidateId);}
}

async function deleteCandidate(id){
  if(!await confirmDialog('Kandidaat verwijderen?'))return;
  candidates=candidates.filter(c=>c.id!==id);
  autoSave();renderCandidates();showToast('Kandidaat verwijderd');
}

async function hireCandidate(id){
  const c=candidates.find(x=>x.id===id);if(!c)return;
  if(!await confirmDialog(`${c.name} aannemen en omzetten naar medewerker?`))return;
  // Open a modal to fill in employee-specific fields
  openModal(`âœ… ${c.name} aannemen`,`
    <div style="padding:12px;background:var(--success-bg);border-radius:var(--radius-xs);margin-bottom:16px;font-size:13px">
      <strong>ğŸ“„ ${c.name}</strong> wordt omgezet naar medewerker. Vul de ontbrekende gegevens aan.
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Naam</label>
        <input class="form-input" id="mh-name" value="${c.name}" readonly style="background:var(--surface2)"/>
      </div>
      <div class="form-group">
        <label class="form-label">E-mail <span class="req">*</span></label>
        <input class="form-input" type="email" id="mh-email" value="${c.email||''}"/>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Department <span class="req">*</span></label>
        <select class="form-input" id="mh-dept">
          <option value="">Selecteer...</option>
          ${departments.map(d=>`<option value="${d.id}">${d.name}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Rol</label>
        <select class="form-input" id="mh-role">
          <option value="user">User</option>
          <option value="approver">Approver</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Startdatum <span class="req">*</span></label>
        <input class="form-input" type="date" id="mh-start"/>
      </div>
      <div class="form-group">
        <label class="form-label">Werkrooster</label>
        <select class="form-input" id="mh-schedule">
          ${schedules.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="confirmHire('${c.id}')">âœ… Bevestigen & aannemen</button>
    </div>
  `);
}

function confirmHire(candidateId){
  const c=candidates.find(x=>x.id===candidateId);if(!c)return;
  const email=document.getElementById('mh-email').value.trim();
  const departmentId=document.getElementById('mh-dept').value;
  const role=document.getElementById('mh-role').value;
  const startDate=document.getElementById('mh-start').value;
  const scheduleId=document.getElementById('mh-schedule').value;
  
  if(!email){showToast('E-mail is verplicht','error');return;}
  if(!departmentId){showToast('Department is verplicht','error');return;}
  if(!startDate){showToast('Startdatum is verplicht','error');return;}
  
  // Create employee from candidate - split candidate name
  const nameParts=c.name.split(' ');
  const firstName=nameParts[0]||'';
  const lastName=nameParts.slice(1).join(' ')||'';
  people.push({
    id:uid(),firstName,lastName,email,departmentId,role,isApprover:false,statuut:'bediende',paritairComite:'',startDate,scheduleId,
    gsm:'',tel:'',iban:'',birthDate:'',werkGsm:'',noodNaam:'',noodRelatie:'',noodGsm:'',
    allowanceAdjustments:[],candidateId:c.id
  });
  
  // Update candidate status
  c.status='aangenomen';
  c.hiredDate=new Date().toISOString().split('T')[0];
  
  closeModal();autoSave();renderCandidates();renderPeople();renderDepartments();
  showToast(`${c.name} is aangenomen en toegevoegd als medewerker ğŸ‰`);
}

function renderDepartments(){
  const grid=document.getElementById('dept-grid');
  if(departments.length===0){
    grid.innerHTML='<div class="card" style="grid-column:1/-1;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px">ğŸ“‚</div><div style="color:var(--text3);font-size:13px">Nog geen departments. Klik op "Department toevoegen" om te starten.</div></div>';
  }else{
    grid.innerHTML=departments.map(d=>{
      const count=people.filter(p=>p.departmentId===d.id&&!p.archived).length;
      const approver=people.find(p=>p.id===d.approverId);
      return `<div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div style="font-weight:700;font-size:15px">${d.name}</div>
          <div style="display:flex;gap:4px">
            <button class="btn btn-sm btn-icon" onclick="openDeptModal('${d.id}')" title="Bewerken" aria-label="Bewerken">âœï¸</button>
            <button class="btn btn-sm btn-icon btn-danger" onclick="deleteDept('${d.id}')" title="Verwijderen" aria-label="Verwijderen">ğŸ—‘</button>
          </div>
        </div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:6px">ğŸ‘¥ ${count} medewerker${count!==1?'s':''}</div>
        <div style="font-size:12px;color:var(--text2)">Approver: ${approver?`<span style="font-weight:600">${fullName(approver).split(' ')[0]}</span>`:'<span style="color:var(--danger)">Niet toegewezen</span>'}</div>
      </div>`;
    }).join('');
  }
  document.getElementById('dept-count').textContent=departments.length+' department'+(departments.length!==1?'s':'');
}

let peopleSortKey='name', peopleSortAsc=true;

function sortPeople(key){
  if(peopleSortKey===key)peopleSortAsc=!peopleSortAsc;
  else{peopleSortKey=key;peopleSortAsc=true;}
  renderPeople();
}

function renderPeople(){
  // Update sort indicators
  ['name','dept','role','schedule','saldo'].forEach(k=>{
    const el=document.getElementById('sort-'+k);
    if(el)el.textContent=peopleSortKey===k?(peopleSortAsc?'â†‘':'â†“'):'â†•';
    if(el)el.style.opacity=peopleSortKey===k?'1':'.3';
  });

  const tbody=document.getElementById('people-table');
  const deptSelect=document.querySelector('#people-tab-employees select');
  deptSelect.innerHTML='<option value="">Alle departments</option>'+departments.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
  
  const activePeople=people.filter(p=>peopleStatusFilter==='all'?true:peopleStatusFilter==='archived'?p.archived:!p.archived);
  const activeCount=people.filter(p=>!p.archived).length;
  const archivedCount=people.filter(p=>p.archived).length;

  if(activePeople.length===0){
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3)">Nog geen medewerkers. Klik op "Medewerker toevoegen" om te starten.</td></tr>';
  }else{
    const sorted=[...activePeople].sort((a,b)=>{
      // Archived always at bottom
      if(a.archived&&!b.archived)return 1;
      if(!a.archived&&b.archived)return -1;
      let va,vb;
      if(peopleSortKey==='name'){va=fullName(a).toLowerCase();vb=fullName(b).toLowerCase();}
      else if(peopleSortKey==='dept'){const da=departments.find(d=>d.id===a.departmentId);const db=departments.find(d=>d.id===b.departmentId);va=(da?da.name:'').toLowerCase();vb=(db?db.name:'').toLowerCase();}
      else if(peopleSortKey==='role'){const order=p=>(p.role==='admin'?0:2)-(p.isApprover?1:0);va=order(a);vb=order(b);}
      else if(peopleSortKey==='schedule'){const sa=schedules.find(s=>s.id===a.scheduleId);const sb=schedules.find(s=>s.id===b.scheduleId);va=(sa?sa.name:'').toLowerCase();vb=(sb?sb.name:'').toLowerCase();}
      else if(peopleSortKey==='saldo'){va=getTotalAllowance(a)-getUsedDays(a.id);vb=getTotalAllowance(b)-getUsedDays(b.id);}
      else{va=0;vb=0;}
      if(va<vb)return peopleSortAsc?-1:1;
      if(va>vb)return peopleSortAsc?1:-1;
      return 0;
    });
    tbody.innerHTML=sorted.map(p=>{
      const isArchived=p.archived;
      const dept=departments.find(d=>d.id===p.departmentId);
      const schedule=schedules.find(s=>s.id===p.scheduleId);
      const roleBadge=p.role==='admin'?'badge-red':'badge-gray';
      const roleBadges=`<div style="display:flex;flex-direction:column;align-items:center;gap:3px"><span class="badge ${roleBadge}" style="min-width:70px;text-align:center;display:inline-block">${p.role}</span>${p.isApprover?'<span class="badge badge-purple" style="min-width:70px;text-align:center;display:inline-block">approver</span>':''}</div>`;
      const totalDays=getTotalAllowance(p);
      const usedDays=getUsedDays(p.id);
      const remaining=totalDays-usedDays;
      const phone=p.werkGsm||p.gsm||p.tel||'';
      return `<tr style="cursor:pointer;${isArchived?'opacity:.5;background:var(--surface2);':''}" onclick="if(!event.target.closest('button,a'))openPersonModal('${p.id}')">
        <td><div style="display:flex;align-items:center;gap:10px">
          <div class="avatar" style="background:${isArchived?'#aaa':getAvatarColor(fullName(p))}">${getInitials(fullName(p))}</div>
          <div><div style="font-weight:600">${fullName(p)}${isArchived?' <span class="badge badge-gray" style="font-size:10px;margin-left:4px">ğŸ“¦ Archief</span>':''}</div><div style="font-size:11px;color:var(--text3)">${p.email}</div></div>
        </div></td>
        <td>${dept?dept.name:'â€”'}</td>
        <td>${roleBadges}</td>
        <td style="font-size:12px">${phone?`<a href="tel:${phone}" style="color:var(--text);text-decoration:none">${phone}</a>`:'<span style="color:var(--text3)">â€”</span>'}</td>
        <td>${schedule?schedule.name:'â€”'}</td>
        <td style="text-align:center">
          ${isArchived?'<span style="font-size:12px;color:var(--text3)">â€”</span>':`
          <span style="font-size:12px;font-weight:600;color:${remaining>5?'var(--text)':remaining>0?'var(--warn)':'var(--danger)'}">${remaining}/${totalDays}d</span>`}
        </td>
        <td style="text-align:center">
          ${isArchived?'<span style="font-size:12px;color:var(--text3)">â€”</span>':`
          <span style="font-size:12px;font-weight:600;cursor:pointer;color:var(--accent);text-decoration:underline dotted" onclick="openPersonModal('${p.id}');setTimeout(function(){var f=document.getElementById('mp-saldo-ov');if(f){f.scrollIntoView({block:'center'});f.focus();}},200)" title="Klik om aan te passen">${p.saldoOV!=null?p.saldoOV+'u':'â€”'}</span>`}
        </td>
        <td style="text-align:right">
          ${isArchived?`
            <button class="btn btn-sm" onclick="unarchivePerson('${p.id}')" title="Heractiveren" aria-label="Heractiveren">â™»ï¸</button>
          `:`
            <button class="btn btn-sm" onclick="openPersonModal('${p.id}')">âœï¸</button>
            <button class="btn btn-sm" onclick="openSaldoModal('${p.id}')">ğŸ“Š</button>
            <button class="btn btn-sm" onclick="openChecklist('${p.id}')" title="Onboarding checklist" aria-label="Onboarding checklist" style="color:var(--accent)">â˜‘ï¸</button>
            <button class="btn btn-sm" onclick="archivePerson('${p.id}')" title="Archiveren" aria-label="Archiveren" style="color:var(--text3)">ğŸ“¦</button>
          `}
        </td>
      </tr>`;
    }).join('');
  }
  document.getElementById('people-count').textContent=activeCount+' medewerker'+(activeCount!==1?'s':'')+(archivedCount>0?' Â· '+archivedCount+' gearchiveerd':'');
}

function renderTypes(){
  const tbody=document.getElementById('types-table');
  const catLabels={verlof:'ğŸ–ï¸ Verlof (aangevraagd)',adv:'ğŸ“… ADV',overuren:'â±ï¸ Overuren',ziekte:'ğŸ¤’ Ziekte',extern:'ğŸ­ Extern (opgelegd)'};
  const catOrder=['verlof','adv','overuren','ziekte','extern'];
  const protectedIds=['wettelijk','adv','ziekte','tech-werkloos','weerverlet'];
  let html='';
  catOrder.forEach(cat=>{
    const types=leaveTypes.filter(t=>t.category===cat);
    if(types.length===0)return;
    const catBadge=cat==='extern'?'badge-yellow':cat==='ziekte'?'badge-red':'badge-blue';
    html+=`<tr><td colspan="6" style="background:var(--surface2);font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);padding:8px 12px">${catLabels[cat]||cat}</td></tr>`;
    html+=types.map(t=>`<tr>
      <td><div style="display:flex;align-items:center;gap:8px">
        <span class="clr-dot" style="background:${t.color}"></span>
        <span>${t.symbol}</span>
        <span style="font-weight:600">${t.name}</span>
      </div></td>
      <td><span class="badge ${catBadge}">${cat==='extern'?'Extern â€” geen saldo':'Verlof'}</span></td>
      <td>${t.paid?'âœ… Betaald':'âŒ Onbetaald'}</td>
      <td>${t.tracked?'âœ… Ja':'âŒ Nee'}</td>
      <td>${t.tracked?t.defaultDays+' dagen':'â€”'}</td>
      <td style="text-align:right">
        <button class="btn btn-sm" onclick="openTypeModal('${t.id}')">âœï¸</button>
        ${!protectedIds.includes(t.id)?`<button class="btn btn-sm btn-danger" onclick="deleteType('${t.id}')">ğŸ—‘</button>`:''}
      </td>
    </tr>`).join('');
  });
  tbody.innerHTML=html;
}

function renderSettings(){
  // Schedules
  const stbl=document.getElementById('schedules-table');
  stbl.innerHTML=schedules.map(s=>`<tr>
    <td style="font-weight:600">${s.name}</td>
    <td>${s.daysPerWeek} dagen</td>
    <td>${s.hoursPerDay}u</td>
    <td>${s.halfDays?'âœ… Ja':'âŒ Nee'}</td>
    <td style="text-align:right">
      <button class="btn btn-sm" onclick="openScheduleModal('${s.id}')">âœï¸</button>
      <button class="btn btn-sm btn-danger" onclick="deleteSchedule('${s.id}')">ğŸ—‘</button>
    </td>
  </tr>`).join('');

  // Holidays
  const holidays=[...BE_HOLIDAYS_2025,...BE_HOLIDAYS_2026];
  const htbl=document.getElementById('holidays-table');
  const region=settings.region||'vlaanderen';
  document.getElementById('region-select').value=region;
  htbl.innerHTML=holidays.filter(h=>h.all||h.regions&&h.regions.includes(region)).map(h=>`<tr>
    <td style="font-weight:600">${formatDate(h.date)}</td>
    <td>${h.name}</td>
    <td>âœ…</td>
  </tr>`).join('');

  // Year end
  document.getElementById('yearend-mode').value=settings.yearendMode||'max5';
  document.getElementById('yearend-custom-days').value=settings.yearendCustomDays||5;
  document.getElementById('yearend-custom-row').style.display=settings.yearendMode==='custom'?'block':'none';

  // Notifications
  document.getElementById('notif-email').checked=settings.notifEmail!==false;
  document.getElementById('notif-sick').checked=settings.notifSick!==false;

  // Verlofregels
  renderVerlofregels();
}

function renderVerlofregels(){
  // Init defaults if empty
  if(verlofregels.length===0)verlofregels=JSON.parse(JSON.stringify(DEFAULT_VERLOFREGELS));
  const container=document.getElementById('verlofregels-content');
  if(!container)return;
  const activeDepts=departments.filter(d=>people.some(p=>p.departmentId===d.id&&!p.archived));
  let html='';

  verlofregels.forEach(rule=>{
    html+='<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px">';
    html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
    html+='<div><span style="font-size:16px;margin-right:6px">'+rule.icon+'</span><strong style="font-size:14px">'+rule.label+'</strong></div>';
    html+='</div>';
    html+='<div style="font-size:12px;color:var(--text3);margin-bottom:12px">'+rule.desc+'</div>';

    if(rule.perDept){
      // Per department tabel
      html+='<table class="tbl" style="font-size:12px"><thead><tr><th>Department</th><th style="width:80px">Medewerkers</th><th style="width:120px">Waarde</th></tr></thead><tbody>';
      activeDepts.forEach(dept=>{
        const empCount=people.filter(p=>p.departmentId===dept.id&&!p.archived).length;
        const val=rule.defaults&&rule.defaults[dept.id]!==undefined?rule.defaults[dept.id]:'';
        html+='<tr>';
        html+='<td style="font-weight:600">'+dept.name+'</td>';
        html+='<td style="text-align:center"><span class="badge badge-blue">'+empCount+'</span></td>';
        html+='<td><input type="number" min="0" class="form-input" style="padding:4px 8px;font-size:12px;text-align:center" value="'+(val!==''?val:'')+'" placeholder="â€”" onblur="saveVerlofRegel(\''+rule.id+'\',\''+dept.id+'\',this.value)"/></td>';
        html+='</tr>';
      });
      html+='</tbody></table>';
    } else {
      // Globale waarde
      html+='<div style="display:flex;align-items:center;gap:12px">';
      html+='<label style="font-size:13px;font-weight:600">Waarde:</label>';
      html+='<input type="number" min="0" class="form-input" style="width:80px;padding:4px 8px;font-size:13px;text-align:center" value="'+(rule.value||'')+'" onblur="saveVerlofRegel(\''+rule.id+'\',null,this.value)"/>';
      html+='<span style="font-size:12px;color:var(--text3)">dagen</span>';
      html+='</div>';
    }
    html+='</div>';
  });

  container.innerHTML=html;
}

function saveVerlofRegel(ruleId,deptId,value){
  const rule=verlofregels.find(r=>r.id===ruleId);
  if(!rule)return;
  const num=value===''?'':parseInt(value);
  if(deptId){
    if(!rule.defaults)rule.defaults={};
    if(num===''||isNaN(num))delete rule.defaults[deptId];
    else rule.defaults[deptId]=num;
  } else {
    rule.value=num===''||isNaN(num)?'':num;
  }
  autoSave();
}

function checkVerlofregels(personId,startDate,endDate,days){
  // Returns array of warnings (not blocking)
  const warnings=[];
  const p=people.find(x=>x.id===personId);
  if(!p||verlofregels.length===0)return warnings;
  const dept=departments.find(d=>d.id===p.departmentId);

  verlofregels.forEach(rule=>{
    if(rule.id==='max-afwezig'&&rule.defaults&&dept){
      const maxVal=rule.defaults[dept.id];
      if(maxVal!==undefined&&maxVal!==''){
        // Count approved absences overlapping with this period
        const overlapping=requests.filter(r=>r.personId!==personId&&r.status==='approved'
          &&r.startDate<=endDate&&r.endDate>=startDate
          &&people.find(px=>px.id===r.personId&&px.departmentId===p.departmentId));
        if(overlapping.length>=maxVal){
          warnings.push({icon:'ğŸš«',msg:'Max. gelijktijdig afwezig ('+maxVal+') in '+dept.name+' bereikt: '+overlapping.length+' collega\u2019s al afwezig'});
        }
      }
    }
    if(rule.id==='min-bezetting'&&rule.defaults&&dept){
      const minVal=rule.defaults[dept.id];
      if(minVal!==undefined&&minVal!==''){
        const deptPeople=people.filter(px=>px.departmentId===p.departmentId&&!px.archived).length;
        const overlapping=requests.filter(r=>r.personId!==personId&&r.status==='approved'
          &&r.startDate<=endDate&&r.endDate>=startDate
          &&people.find(px=>px.id===r.personId&&px.departmentId===p.departmentId));
        const remaining=deptPeople-overlapping.length-1; // -1 for current requester
        if(remaining<minVal){
          warnings.push({icon:'ğŸ‘¥',msg:'Min. bezetting ('+minVal+') in '+dept.name+' niet gehaald: nog '+remaining+' aanwezig'});
        }
      }
    }
    if(rule.id==='max-opeenvolgend'&&rule.value){
      if(days>rule.value){
        warnings.push({icon:'ğŸ“…',msg:'Max. '+rule.value+' opeenvolgende verlofdagen overschreden ('+days+' aangevraagd)'});
      }
    }
    if(rule.id==='min-vooraf'&&rule.value){
      const today=new Date();
      const start=new Date(startDate);
      const diffDays=Math.floor((start-today)/(1000*60*60*24));
      if(diffDays<rule.value){
        warnings.push({icon:'â°',msg:'Min. '+rule.value+' dagen op voorhand aanvragen (nog '+diffDays+' dagen)'});
      }
    }
  });
  return warnings;
}

function renderDashboard(){
  // Today's absent
  const today=new Date().toISOString().split('T')[0];
  const absent=requests.filter(r=>r.status==='approved'&&r.type!=='ziekte'&&r.startDate<=today&&r.endDate>=today);
  const sick=requests.filter(r=>r.type==='ziekte'&&r.startDate<=today&&r.endDate>=today);
  const pending=requests.filter(r=>r.status==='pending');
  const next7=new Date();next7.setDate(next7.getDate()+7);
  const next7Str=next7.toISOString().split('T')[0];
  const upcoming=requests.filter(r=>r.status==='approved'&&r.startDate>today&&r.startDate<=next7Str);

  document.getElementById('st-absent').textContent=absent.length;
  document.getElementById('st-pending').textContent=pending.length;
  document.getElementById('st-sick').textContent=sick.length;

  // Absent list
  const absentDiv=document.getElementById('dash-absent');
  if(absent.length===0){
    absentDiv.innerHTML='<span style="font-size:13px;color:var(--text3)">Niemand afwezig vandaag ğŸ‰</span>';
  }else{
    absentDiv.innerHTML=absent.map(r=>{
      const person=people.find(p=>p.id===r.personId);
      const type=leaveTypes.find(t=>t.id===r.type);
      return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="viewRequest('${r.id}')">
        <div class="avatar" style="background:${person?getAvatarColor(fullName(person)):'#ccc'};width:28px;height:28px;font-size:11px">${person?getInitials(fullName(person)):'?'}</div>
        <div style="flex:1"><div style="font-size:13px;font-weight:600">${person?fullName(person):'Onbekend'}</div></div>
        <span class="badge" style="background:${type?type.color+'1a':'#eee'};color:${type?type.color:'#999'}">${type?type.symbol+' '+type.name:'?'}</span>
      </div>`;
    }).join('');
  }

  // Pending
  const pendDiv=document.getElementById('dash-pending');
  if(pending.length===0){
    pendDiv.innerHTML='<span style="font-size:13px;color:var(--text3)">Geen openstaande aanvragen âœ…</span>';
  }else{
    pendDiv.innerHTML=pending.slice(0,5).map(r=>{
      const person=people.find(p=>p.id===r.personId);
      const type=leaveTypes.find(t=>t.id===r.type);
      const dept=person?departments.find(d=>d.id===person.departmentId):null;
      const approver=dept&&dept.approverId?people.find(p=>p.id===dept.approverId):null;
      const approverColor=approver?getAvatarColor(fullName(approver)):'#999';
      return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="viewRequest('${r.id}')">
        <div style="flex:1"><div style="font-size:13px;font-weight:600">${person?fullName(person):'Onbekend'}</div>
        <div style="font-size:11px;color:var(--text3)">${formatDateShort(r.startDate)} â†’ ${formatDateShort(r.endDate)}</div></div>
        ${approver?`<span class="badge" style="background:${approverColor}18;color:${approverColor};font-size:10px;min-width:64px;text-align:center;display:inline-block">${approver.firstName}</span>`:''}
        <span class="badge" style="background:${type?type.color+'1a':'#eee'};color:${type?type.color:'#999'}">${type?type.symbol:'?'}</span>
      </div>`;
    }).join('');
  }

  // Sick today list â€” inside absent card
  const sickSection=document.getElementById('dash-sick-section');
  if(sick.length===0){
    sickSection.innerHTML='';
  }else{
    sickSection.innerHTML=`<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--danger);margin-bottom:8px">ğŸ¤’ Ziek vandaag</div>
      ${sick.map(r=>{
        const person=people.find(p=>p.id===r.personId);
        const dept=person?departments.find(d=>d.id===person.departmentId):null;
        return `<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--surface3);cursor:pointer" onclick="viewRequest('${r.id}')">
          <div class="avatar" style="background:${person?getAvatarColor(fullName(person)):'#ccc'};width:26px;height:26px;font-size:10px">${person?getInitials(fullName(person)):'?'}</div>
          <div style="flex:1"><div style="font-size:13px;font-weight:600">${person?fullName(person):'Onbekend'}</div>
          <div style="font-size:11px;color:var(--text3)">${dept?dept.name:''} Â· sinds ${formatDateShort(r.startDate)}</div></div>
          <span style="font-size:12px;font-weight:600;color:var(--text3)">${r.days}d</span>
        </div>`;
      }).join('')}
    </div>`;
  }

  // Upcoming holidays
  const holidays=[...BE_HOLIDAYS_2025,...BE_HOLIDAYS_2026].filter(h=>h.date>=today&&(h.all||(h.regions&&h.regions.includes(settings.region))));
  const holDiv=document.getElementById('dash-holidays');
  holDiv.innerHTML=holidays.slice(0,5).map(h=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
    <span style="font-size:18px">ğŸ‡§ğŸ‡ª</span>
    <div style="flex:1"><div style="font-size:13px;font-weight:600">${h.name}</div></div>
    <span style="font-size:12px;color:var(--text3);font-weight:600">${formatDate(h.date)}</span>
  </div>`).join('');

  // Badge counts
  const br=document.getElementById('badge-requests');
  if(pending.length>0){br.textContent=pending.length;br.style.display='';}
  else{br.style.display='none';}
}

let reqFilter='pending';
let reqSearch='';

let selectedRequests=new Set();

function renderRequests(){
  const tbody=document.getElementById('requests-table');
  const deptFilter=document.getElementById('req-dept-filter').value;
  // Update dept filter options
  const deptSelect=document.getElementById('req-dept-filter');
  const currentVal=deptSelect.value;
  deptSelect.innerHTML='<option value="">Alle departments</option>'+departments.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
  deptSelect.value=currentVal;

  let filtered=requests.filter(r=>r.type!=='ziekte');
  if(reqFilter!=='all')filtered=filtered.filter(r=>r.status===reqFilter);
  if(deptFilter){
    filtered=filtered.filter(r=>{
      const p=people.find(x=>x.id===r.personId);
      return p&&p.departmentId===deptFilter;
    });
  }
  if(reqSearch){
    const q=reqSearch.toLowerCase();
    filtered=filtered.filter(r=>{
      const p=people.find(x=>x.id===r.personId);
      return p&&fullName(p).toLowerCase().includes(q);
    });
  }
  filtered.sort((a,b)=>new Date(b.startDate)-new Date(a.startDate));

  const pendingCount=requests.filter(r=>r.status==='pending'&&r.type!=='ziekte').length;
  document.getElementById('req-badge-pending').textContent=pendingCount>0?` (${pendingCount})`:'';

  // Show checkboxes only when viewing pending and more than 1
  const showCheck=reqFilter==='pending'&&filtered.length>1;
  document.getElementById('req-th-check').style.display=showCheck?'':'none';
  updateBulkBar();

  if(filtered.length===0){
    tbody.innerHTML=`<tr>${showCheck?'<td></td>':''}<td colspan="7" style="text-align:center;padding:40px;color:var(--text3)">Geen aanvragen gevonden</td></tr>`;
    return;
  }
  tbody.innerHTML=filtered.map(r=>{
    const person=people.find(p=>p.id===r.personId);
    const type=leaveTypes.find(t=>t.id===r.type);
    const conflicts=getConflicts(r);
    const statusBadge=r.status==='pending'?'badge-yellow':r.status==='approved'?'badge-green':'badge-red';
    const statusText=r.status==='pending'?'â³ Openstaand':r.status==='approved'?'âœ… Goedgekeurd':'âŒ Geweigerd';
    const dayLabel=r.halfDay?'Â½ dag ('+r.halfDayPeriod+')':r.days+'d';
    const isChecked=selectedRequests.has(r.id);
    return `<tr style="${isChecked?'background:var(--accent-bg);':''}">
      ${showCheck?`<td><input type="checkbox" ${isChecked?'checked':''} onchange="toggleRequestSelect('${r.id}',this.checked)" style="cursor:pointer"/></td>`:''}
      <td><div style="display:flex;align-items:center;gap:10px">
        <div class="avatar" style="background:${person?getAvatarColor(fullName(person)):'#ccc'};width:28px;height:28px;font-size:11px">${person?getInitials(fullName(person)):'?'}</div>
        <div style="font-weight:600;font-size:13px">${person?fullName(person):'Onbekend'}</div>
      </div></td>
      <td><span class="badge" style="background:${type?type.color+'1a':'#eee'};color:${type?type.color:'#999'}">${type?type.symbol+' '+type.name:'?'}</span></td>
      <td style="font-size:12px">${formatDate(r.startDate)}${r.startDate!==r.endDate?' â†’ '+formatDate(r.endDate):''}</td>
      <td style="font-weight:600">${dayLabel}</td>
      <td><span class="badge ${statusBadge}">${statusText}</span></td>
      <td>${conflicts.length>0?`<span class="badge badge-yellow" title="${conflicts.join(', ')}">âš ï¸ ${conflicts.length}</span>`:
        '<span style="color:var(--text3);font-size:12px">â€”</span>'}</td>
      <td style="text-align:right">
        ${r.status==='pending'?`
          <button class="btn btn-sm btn-primary" onclick="approveRequest('${r.id}')" style="background:var(--success);border-color:var(--success)">âœ…</button>
          <button class="btn btn-sm btn-danger" onclick="rejectRequest('${r.id}')">âŒ</button>
        `:''}
        <button class="btn btn-sm" onclick="viewRequest('${r.id}')">ğŸ‘</button>
        <button class="btn btn-sm btn-danger" onclick="deleteRequest('${r.id}')">ğŸ—‘</button>
      </td>
    </tr>`;
  }).join('');
}

function toggleRequestSelect(id,checked){
  if(checked)selectedRequests.add(id);
  else selectedRequests.delete(id);
  updateBulkBar();
  renderRequests();
}

function toggleAllRequests(checked){
  const pending=requests.filter(r=>r.status==='pending'&&r.type!=='ziekte');
  if(checked)pending.forEach(r=>selectedRequests.add(r.id));
  else selectedRequests.clear();
  updateBulkBar();
  renderRequests();
}

function updateBulkBar(){
  const bar=document.getElementById('req-bulk-bar');
  if(selectedRequests.size>0){
    bar.style.display='flex';
    document.getElementById('req-bulk-count').textContent=selectedRequests.size+' geselecteerd';
  }else{
    bar.style.display='none';
  }
}

function clearSelection(){
  selectedRequests.clear();
  document.getElementById('req-check-all').checked=false;
  updateBulkBar();
  renderRequests();
}

async function bulkApprove(){
  if(!await confirmDialog(`${selectedRequests.size} aanvra${selectedRequests.size===1?'ag':'gen'} goedkeuren?`))return;
  selectedRequests.forEach(id=>{
    const r=requests.find(x=>x.id===id);
    if(r&&r.status==='pending'){r.status='approved';r.decidedDate=new Date().toISOString().split('T')[0];}
  });
  selectedRequests.clear();
  autoSave();renderRequests();renderDashboard();
  showToast('Aanvragen goedgekeurd âœ…');
}

async function bulkReject(){
  const reason=await promptDialog('Reden van weigering (optioneel):','Bv. onvoldoende bezetting');
  if(reason===null)return;
  selectedRequests.forEach(id=>{
    const r=requests.find(x=>x.id===id);
    if(r&&r.status==='pending'){r.status='rejected';r.rejectReason=reason;r.decidedDate=new Date().toISOString().split('T')[0];}
  });
  selectedRequests.clear();
  autoSave();renderRequests();renderDashboard();
  showToast('Aanvragen geweigerd');
}

function filterRequests(status,btn){
  reqFilter=status;
  btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  renderRequests();
}

function searchRequests(q){reqSearch=q;renderRequests();}

function getConflicts(request){
  const person=people.find(p=>p.id===request.personId);
  if(!person)return[];
  const sameDept=people.filter(p=>p.departmentId===person.departmentId&&p.id!==person.id);
  const conflicts=[];
  sameDept.forEach(p=>{
    const overlapping=requests.filter(r=>r.personId===p.id&&r.status==='approved'&&
      r.startDate<=request.endDate&&r.endDate>=request.startDate);
    overlapping.forEach(r=>{
      const type=leaveTypes.find(t=>t.id===r.type);
      conflicts.push(`${fullName(p)} (${type?type.name:'?'}: ${formatDateShort(r.startDate)}â€“${formatDateShort(r.endDate)})`);
    });
  });
  return conflicts;
}

function calcWorkDays(start,end){
  let count=0;
  const d=new Date(start);
  const e=new Date(end);
  while(d<=e){
    const dow=d.getDay();
    if(dow!==0&&dow!==6)count++;
    d.setDate(d.getDate()+1);
  }
  return count;
}

function openRequestModal(id){
  const r=id?requests.find(x=>x.id===id):null;
  const isEdit=!!r;
  openModal(isEdit?'Aanvraag bewerken':'Nieuwe verlofaanvraag',`
    <div class="form-group">
      <label class="form-label">Medewerker <span class="req">*</span></label>
      <select class="form-input" id="mr-person" ${isEdit?'disabled':''}>
        <option value="">Selecteer...</option>
        ${people.map(p=>`<option value="${p.id}" ${r&&r.personId===p.id?'selected':''}>${fullName(p)}</option>`).join('')}
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Verloftype <span class="req">*</span></label>
      <select class="form-input" id="mr-type">
        ${`<optgroup label="Verlof (aangevraagd)">${leaveTypes.filter(t=>t.category!=='ziekte'&&t.category!=='extern').map(t=>`<option value="${t.id}" ${r&&r.type===t.id?'selected':''}>${t.symbol} ${t.name}</option>`).join('')}</optgroup>
        <optgroup label="Extern (opgelegd)">${leaveTypes.filter(t=>t.category==='extern').map(t=>`<option value="${t.id}" ${r&&r.type===t.id?'selected':''}>${t.symbol} ${t.name}</option>`).join('')}</optgroup>`}
      </select>
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px">
        <input type="checkbox" id="mr-half" ${r&&r.halfDay?'checked':''} onchange="toggleHalfDay()"/> Halve dag
      </label>
    </div>
    <div id="mr-halfday-opts" style="display:${r&&r.halfDay?'block':'none'};margin-bottom:16px">
      <div class="form-group">
        <label class="form-label">Periode</label>
        <div style="display:flex;gap:8px">
          <button class="btn btn-sm ${r&&r.halfDayPeriod==='VM'?'btn-primary':''}" onclick="setHalfDayPeriod('VM',this)" id="mr-half-vm">â˜€ï¸ Voormiddag</button>
          <button class="btn btn-sm ${r&&r.halfDayPeriod==='NM'?'btn-primary':''}" onclick="setHalfDayPeriod('NM',this)" id="mr-half-nm">ğŸŒ™ Namiddag</button>
        </div>
      </div>
    </div>
    <div class="form-row" id="mr-date-row">
      <div class="form-group">
        <label class="form-label">Van <span class="req">*</span></label>
        <input class="form-input" type="date" id="mr-start" value="${r?r.startDate:''}" onchange="updateDayCount()"/>
      </div>
      <div class="form-group" id="mr-end-group">
        <label class="form-label">Tot <span class="req">*</span></label>
        <input class="form-input" type="date" id="mr-end" value="${r?r.endDate:''}" onchange="updateDayCount()"/>
      </div>
    </div>
    <div id="mr-daycount" style="font-size:12px;color:var(--text3);margin-bottom:12px"></div>
    <div id="mr-conflicts" style="margin-bottom:12px"></div>
    <div class="form-group">
      <label class="form-label">Opmerking</label>
      <textarea class="form-input" id="mr-comment" rows="2" style="resize:vertical">${r?r.comment||'':''}</textarea>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveRequest('${id||''}')">Opslaan</button>
    </div>
  `);
  if(r)updateDayCount();
}

let selectedHalfDayPeriod='VM';

function toggleHalfDay(){
  const half=document.getElementById('mr-half').checked;
  document.getElementById('mr-halfday-opts').style.display=half?'block':'none';
  document.getElementById('mr-end-group').style.display=half?'none':'';
  if(half){
    document.getElementById('mr-end').value=document.getElementById('mr-start').value;
    selectedHalfDayPeriod='VM';
    document.getElementById('mr-half-vm').classList.add('btn-primary');
    document.getElementById('mr-half-nm').classList.remove('btn-primary');
  }
  updateDayCount();
}

function setHalfDayPeriod(period,btn){
  selectedHalfDayPeriod=period;
  document.getElementById('mr-half-vm').classList.toggle('btn-primary',period==='VM');
  document.getElementById('mr-half-nm').classList.toggle('btn-primary',period==='NM');
}

function updateDayCount(){
  const start=document.getElementById('mr-start').value;
  const end=document.getElementById('mr-end').value;
  const half=document.getElementById('mr-half').checked;
  const dcDiv=document.getElementById('mr-daycount');
  const cfDiv=document.getElementById('mr-conflicts');
  
  if(!start){dcDiv.textContent='';cfDiv.innerHTML='';return;}
  
  const effectiveEnd=half?start:end;
  if(!effectiveEnd){dcDiv.textContent='';cfDiv.innerHTML='';return;}
  
  const days=half?0.5:calcWorkDays(start,effectiveEnd);
  dcDiv.innerHTML=`<span style="font-weight:600;color:var(--accent)">${days} werkdag${days!==1?'en':''}</span>`;
  
  // Check saldo
  const personId=document.getElementById('mr-person').value;
  const typeId=document.getElementById('mr-type').value;
  if(personId){
    const person=people.find(p=>p.id===personId);
    const type=leaveTypes.find(t=>t.id===typeId);
    if(person&&type&&type.tracked){
      const typeAllowance=getAllowanceForType(person,typeId);
      const typeUsed=getUsedDays(person.id,typeId);
      const typeRemaining=typeAllowance-typeUsed;
      if(days>typeRemaining){
        dcDiv.innerHTML+=` <span style="color:var(--danger);font-weight:600">âš ï¸ Onvoldoende ${type.name} saldo (rest: ${typeRemaining}d)</span>`;
      }
    }
  }
  
  // Check conflicts
  if(personId){
    const fakeReq={personId,startDate:start,endDate:effectiveEnd};
    const conflicts=getConflicts(fakeReq);
    if(conflicts.length>0){
      cfDiv.innerHTML=`<div style="padding:10px;border-radius:var(--radius-xs);background:var(--warn-bg);border:1px solid rgba(245,158,11,.2);font-size:12px">
        <div style="font-weight:700;color:var(--warn);margin-bottom:4px">âš ï¸ Conflicten gedetecteerd:</div>
        ${conflicts.map(c=>`<div style="color:var(--text2);padding:2px 0">â€¢ ${c}</div>`).join('')}
      </div>`;
    }else{
      cfDiv.innerHTML='';
    }
  }
}

async function saveRequest(id){
  const personId=document.getElementById('mr-person').value;
  const type=document.getElementById('mr-type').value;
  const startDate=document.getElementById('mr-start').value;
  const half=document.getElementById('mr-half').checked;
  const endDate=half?startDate:document.getElementById('mr-end').value;
  const comment=document.getElementById('mr-comment').value.trim();
  
  if(!personId){showToast('Selecteer een medewerker','error');return;}
  if(!startDate){showToast('Startdatum is verplicht','error');return;}
  if(!half&&!endDate){showToast('Einddatum is verplicht','error');return;}
  if(!half&&endDate<startDate){showToast('Einddatum moet na startdatum liggen','error');return;}
  
  const days=half?0.5:calcWorkDays(startDate,endDate);
  
  // Check verlofregels
  const warnings=checkVerlofregels(personId,startDate,endDate,days);
  if(warnings.length>0&&!id){
    const warnMsg=warnings.map(w=>w.icon+' '+w.msg).join('\n');
    if(!await confirmDialog('âš ï¸ Verlofregels:\n\n'+warnMsg+'\n\nToch doorgaan?'))return;
  }
  
  const typeObj=leaveTypes.find(t=>t.id===type);
  const isExtern=typeObj&&typeObj.category==='extern';
  
  const data={personId,type,startDate,endDate,days,
    halfDay:half,halfDayPeriod:half?selectedHalfDayPeriod:'',
    comment,status:isExtern?'approved':'pending'};
  
  if(id){
    const r=requests.find(x=>x.id===id);
    if(r)Object.assign(r,data);
  }else{
    requests.push({id:uid(),...data});
  }
  closeModal();autoSave();renderRequests();renderDashboard();
  showToast(isExtern?'Externe afwezigheid geregistreerd (geen goedkeuring nodig)':'Aanvraag opgeslagen');
}

async function approveRequest(id){
  const r=requests.find(x=>x.id===id);
  if(!r)return;
  const conflicts=getConflicts(r);
  if(conflicts.length>0){
    if(!await confirmDialog(`âš ï¸ Er zijn ${conflicts.length} conflict(en):\n\n${conflicts.join('\n')}\n\nToch goedkeuren?`))return;
  }
  r.status='approved';r.decidedDate=new Date().toISOString().split('T')[0];
  autoSave();renderRequests();renderDashboard();
  showToast('Aanvraag goedgekeurd âœ…');
}

async function rejectRequest(id){
  const comment=await promptDialog('Reden van weigering (optioneel):','Bv. onvoldoende bezetting');
  if(comment===null)return;
  const r=requests.find(x=>x.id===id);
  if(!r)return;
  r.status='rejected';r.rejectReason=comment;r.decidedDate=new Date().toISOString().split('T')[0];
  autoSave();renderRequests();renderDashboard();
  showToast('Aanvraag geweigerd');
}

function viewRequest(id){
  const r=requests.find(x=>x.id===id);if(!r)return;
  const person=people.find(p=>p.id===r.personId);
  const type=leaveTypes.find(t=>t.id===r.type);
  const dept=person?departments.find(d=>d.id===person.departmentId):null;
  const conflicts=getConflicts(r);
  const dayLabel=r.halfDay?'Â½ dag ('+r.halfDayPeriod+')':r.days+' werkdag'+(r.days!==1?'en':'');
  
  // Saldo berekening per type
  let saldoHtml='';
  if(person){
    const trackedTypes=leaveTypes.filter(t=>t.tracked&&t.category!=='extern');
    const pendingTotal=requests.filter(x=>x.personId===person.id&&x.status==='pending')
      .reduce((s,x)=>{const t=leaveTypes.find(lt=>lt.id===x.type);return s+((t&&t.tracked)?(x.halfDay?0.5:x.days||0):0);},0);
    
    const rows=trackedTypes.map(t=>{
      const total=getAllowanceForType(person,t.id);
      if(total===0&&t.id!=='wettelijk'&&t.id!=='adv')return '';
      const used=getUsedDays(person.id,t.id);
      const pending=requests.filter(x=>x.personId===person.id&&x.type===t.id&&x.status==='pending')
        .reduce((s,x)=>s+(x.halfDay?0.5:x.days||0),0);
      const remaining=total-used;
      const isCurrentType=t.id===r.type;
      return `<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;${isCurrentType?'background:'+t.color+'0d;border-radius:var(--radius-xs);font-weight:600;':''}" >
        <span class="clr-dot" style="background:${t.color}"></span>
        <span style="flex:1;font-size:12px">${t.symbol} ${t.name}</span>
        <span style="font-size:12px;color:${remaining>5?'var(--success)':remaining>0?'var(--warn)':'var(--danger)'};font-weight:700">${remaining}d</span>
        <span style="font-size:10px;color:var(--text3)">/ ${total}d</span>
      </div>`;
    }).filter(Boolean).join('');

    saldoHtml=`<div style="padding:12px;background:var(--surface2);border-radius:var(--radius-sm);margin-bottom:16px">
      <div style="font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">Saldo ${fullName(person)}</div>
      ${rows}
      ${pendingTotal>0?`<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);display:flex;align-items:center;gap:8px;font-size:12px">
        <span style="flex:1;color:var(--warn)">â³ In behandeling</span>
        <span style="font-weight:700;color:var(--warn)">${pendingTotal}d</span>
      </div>`:''}
    </div>`;
  }

  openModal('Aanvraag details',`
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:12px;background:var(--surface2);border-radius:var(--radius-sm)">
      <div class="avatar" style="background:${person?getAvatarColor(fullName(person)):'#ccc'}">${person?getInitials(fullName(person)):'?'}</div>
      <div><div style="font-weight:700">${person?fullName(person):'Onbekend'}</div><div style="font-size:12px;color:var(--text3)">${dept?dept.name:''}</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:13px;margin-bottom:16px">
      <div><span style="color:var(--text3)">Type:</span> <span class="badge" style="background:${type?type.color+'1a':'#eee'};color:${type?type.color:'#999'}">${type?type.symbol+' '+type.name:'?'}</span></div>
      <div><span style="color:var(--text3)">Dagen:</span> <strong>${dayLabel}</strong></div>
      <div><span style="color:var(--text3)">Van:</span> <strong>${formatDate(r.startDate)}</strong></div>
      <div><span style="color:var(--text3)">Tot:</span> <strong>${formatDate(r.endDate)}</strong></div>
      <div><span style="color:var(--text3)">Status:</span> <span class="badge ${r.status==='approved'?'badge-green':r.status==='rejected'?'badge-red':'badge-yellow'}">${r.status==='approved'?'âœ… Goedgekeurd':r.status==='rejected'?'âŒ Geweigerd':'â³ Openstaand'}</span></div>
      ${r.decidedDate?`<div><span style="color:var(--text3)">Beslist op:</span> <strong>${formatDate(r.decidedDate)}</strong></div>`:''}
    </div>
    ${saldoHtml}
    ${r.comment?`<div style="padding:10px;background:var(--surface2);border-radius:var(--radius-xs);font-size:12px;margin-bottom:12px"><strong>Opmerking:</strong> ${r.comment}</div>`:''}
    ${r.rejectReason?`<div style="padding:10px;background:var(--danger-bg);border-radius:var(--radius-xs);font-size:12px;margin-bottom:12px;border:1px solid var(--danger-border)"><strong>Reden weigering:</strong> ${r.rejectReason}</div>`:''}
    ${conflicts.length>0?`<div style="padding:10px;border-radius:var(--radius-xs);background:var(--warn-bg);border:1px solid rgba(245,158,11,.2);font-size:12px;margin-bottom:12px">
      <div style="font-weight:700;color:var(--warn);margin-bottom:4px">âš ï¸ Conflicten:</div>
      ${conflicts.map(c=>`<div style="color:var(--text2);padding:2px 0">â€¢ ${c}</div>`).join('')}
    </div>`:''}
    ${r.status==='pending'?`<div class="modal-actions">
      <button class="btn btn-danger" onclick="rejectRequest('${r.id}');closeModal()">âŒ Weigeren</button>
      <button class="btn btn-primary" onclick="approveRequest('${r.id}');closeModal()" style="background:var(--success);border-color:var(--success)">âœ… Goedkeuren</button>
    </div>`:'<div class="modal-actions"><button class="btn" onclick="closeModal()">Sluiten</button></div>'}
  `);
}

async function deleteRequest(id){
  if(!await confirmDialog('Aanvraag verwijderen?'))return;
  const r=requests.find(x=>x.id===id);
  if(r&&r.status==='approved'){
    // Auto refund saldo
    showToast('Aanvraag verwijderd â€” saldo automatisch teruggestort');
  }
  requests=requests.filter(x=>x.id!==id);
  autoSave();renderRequests();renderDashboard();
  if(!r||r.status!=='approved')showToast('Aanvraag verwijderd');
}

// --- Sickness ---
let sickFilter='active';

function renderSickness(){
  const tbody=document.getElementById('sickness-table');
  const today=new Date().toISOString().split('T')[0];
  let sickRequests=requests.filter(r=>r.type==='ziekte');
  if(sickFilter==='active'){
    sickRequests=sickRequests.filter(r=>r.endDate>=today);
  }
  sickRequests.sort((a,b)=>new Date(b.startDate)-new Date(a.startDate));
  
  if(sickRequests.length===0){
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3)">Geen ziekmeldingen gevonden</td></tr>';
    return;
  }
  tbody.innerHTML=sickRequests.map(r=>{
    const person=people.find(p=>p.id===r.personId);
    const dept=person?departments.find(d=>d.id===person.departmentId):null;
    const isActive=r.endDate>=today;
    const hasCert=r.sickCertificate;
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:10px">
        <div class="avatar" style="background:${person?getAvatarColor(fullName(person)):'#ccc'};width:28px;height:28px;font-size:11px">${person?getInitials(fullName(person)):'?'}</div>
        <div><div style="font-weight:600;font-size:13px">${person?fullName(person):'Onbekend'}</div>
        <div style="font-size:11px;color:var(--text3)">${dept?dept.name:''}</div></div>
      </div></td>
      <td style="font-size:12px;font-weight:600">${formatDate(r.startDate)}</td>
      <td style="font-size:12px;font-weight:600">${formatDate(r.endDate)}</td>
      <td style="font-weight:600">${r.days}d</td>
      <td>${hasCert?'<span class="badge badge-green">âœ… Ontvangen</span>':'<span class="badge badge-yellow">âš ï¸ Ontbreekt</span>'}</td>
      <td>
        ${r.notifiedHR?'<span class="badge badge-green" style="font-size:10px">HR âœ…</span>':''}
        ${r.notifiedDept?'<span class="badge badge-green" style="font-size:10px">Divisie âœ…</span>':''}
        ${!r.notifiedHR&&!r.notifiedDept?'<span style="color:var(--text3);font-size:12px">â€”</span>':''}
      </td>
      <td style="text-align:right">
        ${!hasCert?`<button class="btn btn-sm" onclick="uploadCertificate('${r.id}')">ğŸ“„ Briefje</button>`:''}
        <button class="btn btn-sm" onclick="editSickness('${r.id}')">âœï¸</button>
        ${!r.notifiedHR?`<button class="btn btn-sm" onclick="notifySickness('${r.id}')" title="Mail/SMS versturen" aria-label="Mail/SMS versturen">ğŸ“§</button>`:''}
        <button class="btn btn-sm btn-danger" onclick="deleteSickness('${r.id}')">ğŸ—‘</button>
      </td>
    </tr>`;
  }).join('');

  // Bradford Factor calculation
  renderBradford();
}

let bradfordAsc=false;
function sortBradford(){bradfordAsc=!bradfordAsc;renderBradford();}

function renderBradford(){
  const tbody=document.getElementById('bradford-table');
  const now=new Date();
  const yearAgo=new Date(now);yearAgo.setFullYear(yearAgo.getFullYear()-1);
  const yearAgoStr=yearAgo.toISOString().split('T')[0];

  let scores=people.map(p=>{
    const sickReqs=requests.filter(r=>r.type==='ziekte'&&r.personId===p.id&&r.startDate>=yearAgoStr);
    const S=sickReqs.length; // number of spells
    const D=sickReqs.reduce((sum,r)=>sum+(r.halfDay?0.5:r.days||0),0); // total days
    const B=S*S*D; // Bradford Factor
    return {person:p,S,D,B};
  }).filter(x=>x.S>0);

  scores.sort((a,b)=>bradfordAsc?a.B-b.B:b.B-a.B);
  document.getElementById('sort-bradford').textContent=bradfordAsc?'â†‘':'â†“';

  if(scores.length===0){
    tbody.innerHTML='<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text3)">Geen ziekteverzuim in de afgelopen 52 weken</td></tr>';
    return;
  }

  tbody.innerHTML=scores.map(x=>{
    const riskColor=x.B>=900?'var(--danger)':x.B>=200?'var(--warn)':x.B>=50?'#f59e0b':'var(--success)';
    const riskLabel=x.B>=900?'Kritiek':x.B>=200?'Hoog':x.B>=50?'Aandacht':'Laag';
    const riskBadge=x.B>=900?'badge-red':x.B>=200?'badge-yellow':x.B>=50?'badge-yellow':'badge-green';
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:8px">
        <div class="avatar" style="background:${getAvatarColor(fullName(x.person))};width:26px;height:26px;font-size:10px">${getInitials(fullName(x.person))}</div>
        <span style="font-weight:600">${fullName(x.person)}</span>
      </div></td>
      <td style="text-align:center;font-weight:600">${x.S}</td>
      <td style="text-align:center;font-weight:600">${x.D}d</td>
      <td style="text-align:center;font-weight:700;font-size:15px;color:${riskColor}">${Math.round(x.B)}</td>
      <td><span class="badge ${riskBadge}">${riskLabel}</span></td>
    </tr>`;
  }).join('');
}

function filterSickness(filter,btn){
  sickFilter=filter;
  btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  renderSickness();
}

function openSicknessModal(id){
  const r=id?requests.find(x=>x.id===id):null;
  const today=new Date().toISOString().split('T')[0];
  openModal(r?'Ziekmelding bewerken':'Ziekmelding registreren',`
    <div class="form-group">
      <label class="form-label">Medewerker <span class="req">*</span></label>
      <select class="form-input" id="ms-person" ${r?'disabled':''}>
        <option value="">Selecteer...</option>
        ${people.map(p=>`<option value="${p.id}" ${r&&r.personId===p.id?'selected':''}>${fullName(p)}</option>`).join('')}
      </select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Van <span class="req">*</span></label>
        <input class="form-input" type="date" id="ms-start" value="${r?r.startDate:today}"/>
      </div>
      <div class="form-group">
        <label class="form-label">Tot (verwacht) <span class="req">*</span></label>
        <input class="form-input" type="date" id="ms-end" value="${r?r.endDate:today}"/>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Opmerking</label>
      <textarea class="form-input" id="ms-comment" rows="2" style="resize:vertical">${r?r.comment||'':''}</textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Doktersbriefje (afbeelding)</label>
      <input type="file" accept="image/*" class="form-input" id="ms-cert" style="padding:6px"/>
    </div>
    <div id="ms-ocr-result" style="display:none;margin-bottom:12px;padding:10px;background:var(--accent-bg);border-radius:var(--radius-xs);font-size:12px"></div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px">
        <input type="checkbox" id="ms-notify" checked/> Mail/SMS versturen naar HR + divisie-verantwoordelijke
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveSickness('${id||''}')">Registreren</button>
    </div>
  `);
  // OCR on file select
  document.getElementById('ms-cert').addEventListener('change',handleCertUpload);
}

function handleCertUpload(e){
  const file=e.target.files[0];
  if(!file)return;
  const resultDiv=document.getElementById('ms-ocr-result');
  resultDiv.style.display='block';
  resultDiv.innerHTML='<span style="color:var(--accent)">ğŸ”„ Briefje wordt verwerkt (OCR)...</span>';
  
  const reader=new FileReader();
  reader.onload=function(ev){
    // Simple OCR simulation â€” in production, use Tesseract.js
    // For now we extract what we can from the filename and show the image
    const img=ev.target.result;
    resultDiv.innerHTML=`
      <div style="font-weight:700;margin-bottom:6px">ğŸ“„ Doktersbriefje ontvangen</div>
      <div style="color:var(--text2)">OCR-analyse: voor volledige OCR-functionaliteit is Tesseract.js vereist (wordt geladen bij eerste gebruik).</div>
      <div style="margin-top:8px"><img src="${img}" style="max-width:200px;border-radius:var(--radius-xs);border:1px solid var(--border)" alt="Kandidaat foto"/></div>
    `;
    // Store the image data
    resultDiv.dataset.certImage=img;
  };
  reader.readAsDataURL(file);
}

function saveSickness(id){
  const personId=document.getElementById('ms-person').value;
  const startDate=document.getElementById('ms-start').value;
  const endDate=document.getElementById('ms-end').value;
  const comment=document.getElementById('ms-comment').value.trim();
  const notify=document.getElementById('ms-notify').checked;
  const certResult=document.getElementById('ms-ocr-result');
  const hasCert=certResult.dataset&&certResult.dataset.certImage;
  
  if(!personId){showToast('Selecteer een medewerker','error');return;}
  if(!startDate){showToast('Startdatum is verplicht','error');return;}
  if(!endDate){showToast('Einddatum is verplicht','error');return;}
  
  const days=calcWorkDays(startDate,endDate);
  const person=people.find(p=>p.id===personId);
  const dept=person?departments.find(d=>d.id===person.departmentId):null;
  const approver=dept?people.find(p=>p.id===dept.approverId):null;
  
  const data={personId,type:'ziekte',startDate,endDate,days,halfDay:false,halfDayPeriod:'',
    comment,status:'approved',sickCertificate:!!hasCert,certImage:hasCert||'',
    notifiedHR:false,notifiedDept:false};
  
  if(id){
    const r=requests.find(x=>x.id===id);
    if(r)Object.assign(r,data);
  }else{
    requests.push({id:uid(),...data});
  }
  
  // Send notifications
  if(notify){
    const r=requests[requests.length-1]||requests.find(x=>x.id===id);
    if(r){
      r.notifiedHR=true;r.notifiedDept=true;
      // Generate mailto/sms links
      const subject=encodeURIComponent(`Ziekmelding: ${person?fullName(person):'Medewerker'} â€” ${formatDate(startDate)} t/m ${formatDate(endDate)}`);
      const body=encodeURIComponent(`Beste,\n\n${person?fullName(person):'Een medewerker'} is ziek gemeld van ${formatDate(startDate)} tot ${formatDate(endDate)}.\n${comment?'Opmerking: '+comment+'\n':''}\nMet vriendelijke groeten,\nPersoneelbeheer Advanced Energy`);
      
      // Open mail client
      window.open(`mailto:hr@advancedenergy.be${approver?','+approver.email:''}?subject=${subject}&body=${body}`,'_blank');
      showToast('Ziekmelding geregistreerd â€” mail geopend ğŸ“§');
    }
  }else{
    showToast('Ziekmelding geregistreerd');
  }
  
  closeModal();autoSave();renderSickness();renderDashboard();
}

function editSickness(id){openSicknessModal(id);}

function uploadCertificate(id){
  const r=requests.find(x=>x.id===id);if(!r)return;
  openModal('Doktersbriefje uploaden',`
    <div class="form-group">
      <label class="form-label">Selecteer afbeelding van doktersbriefje</label>
      <input type="file" accept="image/*" class="form-input" id="uc-file" style="padding:6px"/>
    </div>
    <div id="uc-preview" style="margin-bottom:12px"></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveCertificate('${id}')">Opslaan</button>
    </div>
  `);
  document.getElementById('uc-file').addEventListener('change',function(e){
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=function(ev){
      document.getElementById('uc-preview').innerHTML=`<img src="${ev.target.result}" style="max-width:300px;border-radius:var(--radius-xs);border:1px solid var(--border)" alt="Foto preview"/>`;
      document.getElementById('uc-preview').dataset.img=ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function saveCertificate(id){
  const preview=document.getElementById('uc-preview');
  if(!preview.dataset.img){showToast('Selecteer eerst een afbeelding','error');return;}
  const r=requests.find(x=>x.id===id);
  if(r){r.sickCertificate=true;r.certImage=preview.dataset.img;}
  closeModal();autoSave();renderSickness();
  showToast('Doktersbriefje opgeslagen âœ…');
}

function notifySickness(id){
  const r=requests.find(x=>x.id===id);if(!r)return;
  const person=people.find(p=>p.id===r.personId);
  const dept=person?departments.find(d=>d.id===person.departmentId):null;
  const approver=dept?people.find(p=>p.id===dept.approverId):null;
  
  const subject=encodeURIComponent(`Ziekmelding: ${person?fullName(person):'Medewerker'} â€” ${formatDate(r.startDate)} t/m ${formatDate(r.endDate)}`);
  const body=encodeURIComponent(`Beste,\n\n${person?fullName(person):'Een medewerker'} is ziek gemeld van ${formatDate(r.startDate)} tot ${formatDate(r.endDate)}.\n${r.comment?'Opmerking: '+r.comment+'\n':''}\nMet vriendelijke groeten,\nPersoneelbeheer Advanced Energy`);
  
  window.open(`mailto:hr@advancedenergy.be${approver?','+approver.email:''}?subject=${subject}&body=${body}`,'_blank');
  r.notifiedHR=true;r.notifiedDept=true;
  autoSave();renderSickness();
  showToast('Mail geopend â€” notificatie verstuurd ğŸ“§');
}

async function deleteSickness(id){
  if(!await confirmDialog('Ziekmelding verwijderen?'))return;
  requests=requests.filter(x=>x.id!==id);
  autoSave();renderSickness();renderDashboard();
  showToast('Ziekmelding verwijderd');
}

// â•â•â• SAVE FUNCTIONS â•â•â•

// --- Departments ---
function openDeptModal(id){
  const d=id?departments.find(x=>x.id===id):null;
  openModal(d?'Department bewerken':'Department toevoegen',`
    <div class="form-group">
      <label class="form-label">Naam <span class="req">*</span></label>
      <input class="form-input" id="md-name" value="${d?d.name:''}" onkeydown="if(event.key==='Enter')saveDept('${id||''}')"/>
    </div>
    <div class="form-group">
      <label class="form-label">Approver</label>
      <select class="form-input" id="md-approver">
        <option value="">Geen approver</option>
        ${people.filter(p=>p.isApprover||p.role==='admin').map(p=>`<option value="${p.id}" ${d&&d.approverId===p.id?'selected':''}>${fullName(p)}</option>`).join('')}
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveDept('${id||''}')">Opslaan</button>
    </div>
  `);
}

function saveDept(id){
  const name=document.getElementById('md-name').value.trim();
  const approverId=document.getElementById('md-approver').value;
  if(!name){showToast('Naam is verplicht','error');return;}
  if(id){
    const d=departments.find(x=>x.id===id);
    if(d){d.name=name;d.approverId=approverId;}
  }else{
    departments.push({id:uid(),name,approverId});
  }
  closeModal();autoSave();renderDepartments();
  showToast('Department opgeslagen');
}

async function deleteDept(id){
  if(!await confirmDialog('Department verwijderen?'))return;
  const count=people.filter(p=>p.departmentId===id&&!p.archived).length;
  if(count>0){showToast(`Kan niet verwijderen: ${count} medewerker(s) toegewezen`,'error');return;}
  departments=departments.filter(d=>d.id!==id);
  autoSave();renderDepartments();showToast('Department verwijderd');
}

// --- People ---
function openPersonModal(id){
  const p=id?people.find(x=>x.id===id):null;
  openModal(p?'Medewerker bewerken':'Medewerker toevoegen',`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <!-- LINKS: Persoonlijk -->
      <div>
        <div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">Persoonlijke gegevens</div>
        <div class="form-group"><label class="form-label">Voornaam <span class="req">*</span></label><input class="form-input" id="mp-firstname" value="${p?p.firstName:''}"/></div>
        <div class="form-group"><label class="form-label">Naam <span class="req">*</span></label><input class="form-input" id="mp-lastname" value="${p?p.lastName:''}"/></div>
        <div class="form-group"><label class="form-label">E-mail <span class="req">*</span></label><input class="form-input" type="email" id="mp-email" value="${p?p.email:''}"/></div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ğŸ“± GSM</label><input class="form-input" type="tel" onblur="this.value=formatPhone(this.value)" id="mp-gsm" value="${p?p.gsm||'':''}" placeholder="+32 4xx xx xx xx"/></div>
          <div class="form-group"><label class="form-label">ğŸ“ Telefoon</label><input class="form-input" type="tel" onblur="this.value=formatPhone(this.value)" id="mp-tel" value="${p?p.tel||'':''}" placeholder="+32 xx xx xx xx"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ğŸ¦ Bankrekeningnummer</label><input class="form-input" type="text" id="mp-iban" value="${p?p.iban||'':''}" placeholder="BE00 0000 0000 0000"/></div>
          <div class="form-group"><label class="form-label">ğŸ‚ Geboortedatum</label><input class="form-input" type="date" id="mp-birthdate" value="${p?p.birthDate||'':''}"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ğŸ†” Rijksregisternummer</label><input class="form-input" type="text" id="mp-rrn" value="${p?p.rrn||'':''}" placeholder="00.00.00-000.00"/></div>
          <div class="form-group"></div>
        </div>
      </div>
      <!-- RECHTS: Bedrijfsgegevens -->
      <div>
        <div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">Bedrijfsgegevens</div>
        <div class="form-group"><label class="form-label">Department <span class="req">*</span></label>
          <select class="form-input" id="mp-dept" onchange="syncPersonFields()"><option value="">Selecteer...</option>
            ${departments.map(d=>`<option value="${d.id}" ${p&&p.departmentId===d.id?'selected':''}>${d.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group" id="mp-cat-group" style="display:none"><label class="form-label">Categorie</label>
          <select class="form-input" id="mp-cat">
            <option value="">Selecteer...</option>
            ${BAREMA_CATEGORIES.map(c=>`<option value="${c.id}" ${p&&p.baremaCategory===c.id?'selected':''}>${c.id} â€” ${c.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Statuut</label>
            <select class="form-input" id="mp-statuut" onchange="syncPersonFields()">
              <option value="bediende" ${p&&p.statuut==='bediende'?'selected':''}>Bediende</option>
              <option value="arbeider" ${p&&p.statuut==='arbeider'?'selected':''}>Arbeider</option>
              <option value="interim" ${p&&p.statuut==='interim'?'selected':''}>Interim</option>
              <option value="zelfstandige" ${p&&p.statuut==='zelfstandige'?'selected':''}>Zelfstandige</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">Paritair comitÃ©</label>
            <select class="form-input" id="mp-pc" onchange="syncPersonFields()">
              <option value="" ${!p||!p.paritairComite?'selected':''}>Selecteer...</option>
              <option value="200" ${p&&p.paritairComite==='200'?'selected':''}>200 â€” Bedienden</option>
              <option value="201" ${p&&p.paritairComite==='201'?'selected':''}>201 â€” Bedienden</option>
              <option value="149.01" ${p&&p.paritairComite==='149.01'?'selected':''}>149.01 â€” Arbeiders</option>
              <option value="nvt" ${p&&p.paritairComite==='nvt'?'selected':''}>N.v.t.</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Rol</label>
            <select class="form-input" id="mp-role" onchange="syncPersonFields()">
              <option value="user" ${p&&p.role==='user'?'selected':''}>User</option>
              <option value="admin" ${p&&p.role==='admin'?'selected':''}>Admin</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">Approver</label>
            <div style="display:flex;align-items:center;gap:8px;height:36px">
              <input type="checkbox" id="mp-approver" ${p&&p.isApprover?'checked':''} style="width:16px;height:16px;cursor:pointer"/>
              <label for="mp-approver" style="font-size:12px;color:var(--text2);cursor:pointer">Kan verlof goedkeuren</label>
            </div>
          </div>
          <div class="form-group"><label class="form-label">Werkrooster</label>
            <select class="form-input" id="mp-schedule">
              ${schedules.map(s=>`<option value="${s.id}" ${p&&p.scheduleId===s.id?'selected':''}>${s.name}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Startdatum</label><input class="form-input" type="date" id="mp-start" value="${p?p.startDate:''}"/></div>
          <div class="form-group"><label class="form-label">ğŸ“± Werk GSM</label><input class="form-input" type="tel" onblur="this.value=formatPhone(this.value)" id="mp-werkgsm" value="${p?p.werkGsm||'':''}" placeholder="+32 4xx xx xx xx"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ğŸ“‹ Saldo OV (uren)</label><input class="form-input" type="number" step="0.5" min="0" id="mp-saldo-ov" value="${p&&p.saldoOV!=null?p.saldoOV:''}" placeholder="0"/></div>
          <div class="form-group"></div>
        </div>
      </div>
    </div>
    <div style="margin-top:12px;padding-top:12px;border-top:2px dashed var(--border)">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
        <div>
          <div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">ğŸš¨ Noodnummer</div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Contactpersoon</label><input class="form-input" id="mp-nood-naam" value="${p?p.noodNaam||'':''}" placeholder="Naam"/></div>
            <div class="form-group"><label class="form-label">Relatie</label>
              <select class="form-input" id="mp-nood-relatie">
                <option value="" ${!p||!p.noodRelatie?'selected':''}>Selecteer...</option>
                <option value="partner" ${p&&p.noodRelatie==='partner'?'selected':''}>Partner</option>
                <option value="echtgeno(o)t(e)" ${p&&p.noodRelatie==='echtgeno(o)t(e)'?'selected':''}>Echtgeno(o)t(e)</option>
                <option value="mama" ${p&&p.noodRelatie==='mama'?'selected':''}>Mama</option>
                <option value="papa" ${p&&p.noodRelatie==='papa'?'selected':''}>Papa</option>
                <option value="broer" ${p&&p.noodRelatie==='broer'?'selected':''}>Broer</option>
                <option value="zus" ${p&&p.noodRelatie==='zus'?'selected':''}>Zus</option>
                <option value="vriend(in)" ${p&&p.noodRelatie==='vriend(in)'?'selected':''}>Vriend(in)</option>
                <option value="andere" ${p&&p.noodRelatie==='andere'?'selected':''}>Andere</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label class="form-label">ğŸ“± GSM noodcontact</label><input class="form-input" type="tel" onblur="this.value=formatPhone(this.value)" id="mp-nood-gsm" value="${p?p.noodGsm||'':''}" placeholder="+32 4xx xx xx xx"/></div>
        </div>
        <div></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="savePerson('${id||''}')">Opslaan</button>
    </div>
  `,true);
  if(p){
    const showSalary=p.paritairComite==='149.01';
    const showChecklist=p.statuut==='arbeider'||p.statuut==='bediende';
    document.getElementById('modal-title-actions').innerHTML=`
      <button class="btn btn-sm" onclick="closeModal();openSaldoModal('${id}')" style="font-size:11px">ğŸ“Š Saldo</button>
      ${showSalary?`<button class="btn btn-sm" onclick="closeModal();openSalaryModal('${id}')" style="font-size:11px">ğŸ’¶ Salaris</button>`:''}
      ${showChecklist?`<button class="btn btn-sm" onclick="closeModal();openChecklist('${id}')" style="font-size:11px;color:var(--accent)">â˜‘ï¸ Checklist</button>`:''}
      <button class="btn btn-sm" onclick="archivePerson('${id}')" style="font-size:11px;color:var(--text3)">ğŸ“¦ Archief</button>`;
  }
  setTimeout(syncPersonFields,50);
}

function syncPersonFields(){
  const dept=document.getElementById('mp-dept').value;
  const statuut=document.getElementById('mp-statuut');
  const pc=document.getElementById('mp-pc');
  const role=document.getElementById('mp-role');

  const arbeiderDepts=['dept-install','dept-service','dept-onderhoud'];
  const bediendeDepts=['dept-back','dept-verkoop'];
  const opts=statuut.querySelectorAll('option');
  // opts[0]=bediende, opts[1]=arbeider, opts[2]=interim, opts[3]=zelfstandige

  // Zelfstandige is altijd beschikbaar in elk department
  opts[3].disabled=false;

  if(arbeiderDepts.includes(dept)){
    opts[0].disabled=true;  // bediende niet
    opts[1].disabled=false; // arbeider wel
    opts[2].disabled=false; // interim wel
    if(statuut.value==='bediende')statuut.value='arbeider';
  }else if(bediendeDepts.includes(dept)){
    opts[0].disabled=false; // bediende wel
    opts[1].disabled=true;  // arbeider niet
    opts[2].disabled=false; // interim wel
    if(statuut.value==='arbeider')statuut.value='bediende';
  }else if(dept==='dept-directie'){
    opts[0].disabled=true;  // bediende niet
    opts[1].disabled=true;  // arbeider niet
    opts[2].disabled=true;  // interim niet
    if(statuut.value!=='zelfstandige')statuut.value='zelfstandige';
  }else{
    opts.forEach(o=>o.disabled=false);
  }

  // PC op basis van statuut
  if(statuut.value==='arbeider'){
    pc.value='149.01';pc.disabled=true;
  }else if(statuut.value==='interim'){
    // Interim kan arbeider (149.01) of bediende PC hebben â€” vrij te kiezen
    pc.disabled=false;
    if(pc.value==='nvt'||pc.value==='')pc.value='149.01';
  }else if(statuut.value==='zelfstandige'){
    pc.value='nvt';pc.disabled=true;
  }else if(statuut.value==='bediende'){
    pc.disabled=false;
    if(pc.value==='149.01'||pc.value==='nvt'||pc.value==='')pc.value='200';
  }

  // Categorie alleen bij PC 149.01
  const catGroup=document.getElementById('mp-cat-group');
  if(catGroup)catGroup.style.display=pc.value==='149.01'?'':'none';
}

function savePerson(id){
  const firstName=document.getElementById('mp-firstname').value.trim();
  const lastName=document.getElementById('mp-lastname').value.trim();
  const email=document.getElementById('mp-email').value.trim();
  const departmentId=document.getElementById('mp-dept').value;
  const role=document.getElementById('mp-role').value;
  const isApprover=document.getElementById('mp-approver').checked;
  const startDate=document.getElementById('mp-start').value;
  const scheduleId=document.getElementById('mp-schedule').value;
  const statuut=document.getElementById('mp-statuut').value;
  const paritairComite=document.getElementById('mp-pc').value;
  const baremaCategory=paritairComite==='149.01'?document.getElementById('mp-cat').value:'';
  const gsm=formatPhone(document.getElementById('mp-gsm').value.trim());
  const tel=formatPhone(document.getElementById('mp-tel').value.trim());
  const iban=document.getElementById('mp-iban').value.trim();
  const birthDate=document.getElementById('mp-birthdate').value;
  const rrn=document.getElementById('mp-rrn').value.trim();
  const saldoOVval=document.getElementById('mp-saldo-ov').value;
  const saldoOV=saldoOVval!==''?parseFloat(saldoOVval):null;
  const werkGsm=formatPhone(document.getElementById('mp-werkgsm').value.trim());
  const noodNaam=document.getElementById('mp-nood-naam').value.trim();
  const noodRelatie=document.getElementById('mp-nood-relatie').value;
  const noodGsm=formatPhone(document.getElementById('mp-nood-gsm').value.trim());
  if(!firstName){showToast('Voornaam is verplicht','error');return;}
  if(!lastName){showToast('Naam is verplicht','error');return;}
  if(!email){showToast('E-mail is verplicht','error');return;}
  if(!departmentId){showToast('Department is verplicht','error');return;}
  const data={firstName,lastName,email,departmentId,role,isApprover,statuut,paritairComite,baremaCategory,startDate,scheduleId,gsm,tel,iban,birthDate,rrn,saldoOV,werkGsm,noodNaam,noodRelatie,noodGsm};
  if(id){
    const p=people.find(x=>x.id===id);
    if(p){Object.assign(p,data);}
  }else{
    people.push({id:uid(),...data,allowanceAdjustments:[]});
  }
  closeModal();autoSave();renderPeople();renderDepartments();
  showToast('Medewerker opgeslagen');
}

async function archivePerson(id){
  if(!await confirmDialog('Medewerker archiveren? De medewerker verdwijnt uit de actieve lijst maar blijft beschikbaar in het archief.'))return;
  const p=people.find(x=>x.id===id);
  if(!p)return;
  p.archived=true;
  p.archivedDate=new Date().toISOString().split('T')[0];
  closeModal();autoSave();renderPeople();renderDepartments();showToast('Medewerker gearchiveerd ğŸ“¦');
}

async function unarchivePerson(id){
  if(!await confirmDialog('Medewerker heractiveren?'))return;
  const p=people.find(x=>x.id===id);
  if(!p)return;
  p.archived=false;
  p.archivedDate=null;
  autoSave();renderPeople();renderDepartments();showToast('Medewerker heractiveerd âœ…');
}

let peopleStatusFilter='active';

function filterPeople(query){
  const q=query.toLowerCase();
  document.querySelectorAll('#people-table tr').forEach(tr=>{
    tr.style.display=tr.textContent.toLowerCase().includes(q)?'':'none';
  });
}

function filterPeopleDept(deptId){
  if(!deptId){document.querySelectorAll('#people-table tr').forEach(tr=>tr.style.display='');return;}
  people.forEach((p,i)=>{
    const tr=document.querySelectorAll('#people-table tr')[i];
    if(tr)tr.style.display=p.departmentId===deptId?'':'none';
  });
}

// --- Saldo ---
function getAllowanceForType(person,typeId){
  const t=leaveTypes.find(x=>x.id===typeId);
  if(!t||!t.tracked)return 0;
  let days=t.defaultDays||0;
  if(person.allowanceAdjustments){
    person.allowanceAdjustments.forEach(a=>{
      if(a.typeId===typeId)days+=a.days;
    });
  }
  return days;
}

function getTotalAllowance(person){
  return leaveTypes.filter(t=>t.tracked).reduce((total,t)=>total+getAllowanceForType(person,t.id),0);
}

function getUsedDays(personId,typeId){
  return requests.filter(r=>r.personId===personId&&(r.status==='approved'||r.type==='ziekte')&&(typeId?r.type===typeId:true))
    .reduce((sum,r)=>{
      const type=leaveTypes.find(t=>t.id===r.type);
      if(!type||!type.tracked)return sum;
      return sum+(r.halfDay?0.5:r.days||0);
    },0);
}

function openChecklist(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  const isInterim=p.statuut==='interim';
  const isArbeiderOfBediende=p.statuut==='arbeider'||p.statuut==='bediende';

  // Basis checklist (iedereen)
  const sections=[
    {title:'Telefonie & hardware',items:[
      'Extra schermen','Toetsenbord & muis','Aanpassing telefonie keuzemenu (planning \u2013 verkoop \u2013 technisch \u2013 overig)']},
    {title:'Teamtel',items:[
      'Bestellen HP Elitebook','Bestellen Jabra Headset + aansluiten op computer','Microsoft licentie',
      'Aanmaken gebruiker in Outlook','Configuratie Keeper','Gebruiker + configuratie in 3CX telefooncentrale',
      'Configuratie HP printer - printen + scannen','Installatie Acrobat Reader','Directory AE']},
    {title:'Outlook',items:['Sharen van de agenda','Handtekening']},
    {title:'Keeper',items:['Wachtwoorden delen']},
    {title:'Daikin',items:['Account aanmaken']},
    {title:'Plenion',items:['Aanvraag Plenion licentie','Aanmaken personeelslid + toekennen juiste rol','Vakantiegoedkeuring','Linken met Outlook']},
    {title:'Office',items:['Toekennen bureau','Aankoop bureau materiaal \u2013 Schaar, balpen, fluo, nietjes machine + nietjes, perforator, tipp-ex, plakband, schriftje, lat/geodriehoek']},
    {title:'HR',items:['Inlichtingenfiche','Verlofmap','Welkom kaartje opsturen \u201Cwelkom in ons team \u2026 ! We kijken ernaar uit.\u201D']}
  ];

  // Extra sectie voor arbeiders en bedienden (niet interim)
  if(isArbeiderOfBediende){
    sections.push({title:'Administratie & verzekeringen',items:[
      'Mensura werkpostfiche','Payroll SDWorx','Aansluiten DKV verzekering','Aansluiten AXA verzekering','Arbeidsovereenkomst'
    ]});
  }

  const statuutLabel=p.statuut?p.statuut.charAt(0).toUpperCase()+p.statuut.slice(1):'';
  const dept=departments.find(d=>d.id===p.departmentId);
  const deptLabel=dept?dept.name:'';
  const totalItems=sections.reduce(function(s,sec){return s+sec.items.length;},0);
  const startFormatted=p.startDate?formatDate(p.startDate):'\u2014';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">'
    +'<div style="font-size:12px;color:var(--text3)">Startdatum: <strong style="color:var(--text)">'+startFormatted+'</strong>'
    +' &nbsp;\u2022&nbsp; '+statuutLabel+' \u2014 '+deptLabel
    +' &nbsp;\u2022&nbsp; <span id="checklist-progress">0/'+totalItems+' afgevinkt</span></div>'
    +'<button class="btn btn-sm btn-danger" onclick="confirmDeleteChecklist(\''+personId+'\')">\uD83D\uDDD1 Checklist verwijderen</button>'
    +'</div>';
  html+='<div id="checklist-container" style="max-height:65vh;overflow-y:auto">';
  sections.forEach(function(sec){
    html+='<div style="font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin:16px 0 8px;padding-bottom:4px;border-bottom:1px solid var(--border)">'+sec.title+'</div>';
    sec.items.forEach(function(item){
      html+='<label style="display:flex;align-items:flex-start;gap:10px;padding:6px 0;cursor:pointer;font-size:13px">'
        +'<input type="checkbox" class="checklist-cb" style="margin-top:2px;flex-shrink:0;width:16px;height:16px;accent-color:var(--accent)" onchange="checkChecklistComplete(\''+personId+'\')"/>'
        +'<span>'+item+'</span></label>';
    });
  });
  html+='</div>';
  openModal('\u2611\uFE0F Onboarding Checklist \u2014 '+fullName(p),html);
}

function checkChecklistComplete(personId){
  const cbs=document.querySelectorAll('.checklist-cb');
  const total=cbs.length;
  const checked=Array.from(cbs).filter(cb=>cb.checked).length;
  const prog=document.getElementById('checklist-progress');
  if(prog)prog.innerHTML=checked+'/'+total+' afgevinkt'+(checked===total?' &nbsp;<span style="color:var(--success);font-weight:700">\u2705 Volledig!</span>':'');
  if(checked===total){
    setTimeout(async function(){
      if(await confirmDialog('Alle items zijn afgevinkt! Checklist definitief verwijderen?')){
        closeModal();
        showToast('Onboarding checklist voltooid en verwijderd','success');
      }
    },400);
  }
}

async function confirmDeleteChecklist(personId){
  if(!await confirmDialog('Checklist definitief verwijderen voor deze medewerker? Dit kan niet ongedaan gemaakt worden.'))return;
  closeModal();
  showToast('Checklist verwijderd');
}

function openSaldoModal(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  const totalDays=getTotalAllowance(p);
  const usedDays=getUsedDays(p.id);
  const remaining=totalDays-usedDays;

  let typeSummary=leaveTypes.filter(t=>t.tracked).filter(t=>{
    const allowance=getAllowanceForType(p,t.id);
    const used=getUsedDays(p.id,t.id);
    const hasAdj=(p.allowanceAdjustments||[]).some(a=>a.typeId===t.id);
    return allowance>0||used>0||hasAdj;
  }).map(t=>{
    const allowance=getAllowanceForType(p,t.id);
    const used=getUsedDays(p.id,t.id);
    const rem=allowance-used;
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:6px"><span class="clr-dot" style="background:${t.color}"></span>${t.symbol} ${t.name}</div></td>
      <td style="text-align:center;font-weight:600">${allowance}</td>
      <td style="text-align:center;font-weight:600">${used}</td>
      <td style="text-align:center;font-weight:700;color:${rem>0?'var(--success)':rem===0?'var(--text3)':'var(--danger)'}">${rem}</td>
    </tr>`;
  }).join('');

  let adjustments='';
  if(p.allowanceAdjustments&&p.allowanceAdjustments.length>0){
    adjustments=p.allowanceAdjustments.map((a,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
      <span style="font-weight:600;color:${a.days>0?'var(--success)':'var(--danger)'};">${a.days>0?'+':''}\u200B${a.days}d</span>
      <span style="flex:1;color:var(--text2)">${a.reason}</span>
      <span style="color:var(--text3)">${formatDate(a.date)}</span>
      <button class="btn btn-sm btn-danger" onclick="removeAdjustment('${personId}',${i})">ğŸ—‘</button>
    </div>`).join('');
  }

  // Build mutation history: all approved requests + adjustments, chronological
  const year=new Date().getFullYear();
  const mutations=[];
  // Start saldo
  const baseSaldo=leaveTypes.filter(t=>t.tracked).reduce((s,t)=>s+(t.defaultDays||0),0);
  mutations.push({date:''+year+'-01-01',label:'Startsaldo '+year,type:'start',days:baseSaldo,delta:0});
  // Adjustments
  (p.allowanceAdjustments||[]).forEach(a=>{
    const t=leaveTypes.find(x=>x.id===a.typeId);
    mutations.push({date:a.date,label:'Aanpassing'+(a.reason?' â€” '+a.reason:'')+(t?' ('+t.name+')':''),type:'adjust',days:0,delta:a.days});
  });
  // Approved tracked requests
  requests.filter(r=>r.personId===p.id&&(r.status==='approved'||r.type==='ziekte')).forEach(r=>{
    const t=leaveTypes.find(x=>x.id===r.type);
    if(!t||!t.tracked)return;
    const d=r.halfDay?0.5:r.days||0;
    mutations.push({date:r.startDate,label:`${t.symbol} ${t.name} â€” ${formatDateShort(r.startDate)}${r.startDate!==r.endDate?' â†’ '+formatDateShort(r.endDate):''}`,type:'used',days:0,delta:-d,color:t.color});
  });
  // Pending requests
  requests.filter(r=>r.personId===p.id&&r.status==='pending').forEach(r=>{
    const t=leaveTypes.find(x=>x.id===r.type);
    if(!t||!t.tracked)return;
    const d=r.halfDay?0.5:r.days||0;
    mutations.push({date:r.startDate,label:`â³ ${t.symbol} ${t.name} â€” ${formatDateShort(r.startDate)}${r.startDate!==r.endDate?' â†’ '+formatDateShort(r.endDate):''} (pending)`,type:'pending',days:0,delta:-d,color:t.color});
  });
  mutations.sort((a,b)=>a.date.localeCompare(b.date));

  // Calculate running balance
  let runBalance=0;
  const mutHtml=mutations.map(m=>{
    if(m.type==='start')runBalance=m.days;
    else runBalance+=m.delta;
    const isPending=m.type==='pending';
    const deltaStr=m.type==='start'?`${m.days}d`:m.delta>0?`<span style="color:var(--success)">+${m.delta}d</span>`:`<span style="color:var(--danger)">${m.delta}d</span>`;
    return `<tr style="${isPending?'opacity:.5;font-style:italic':''}">
      <td style="font-size:11px;color:var(--text3);white-space:nowrap">${formatDate(m.date)}</td>
      <td style="font-size:12px">${m.color?`<span class="clr-dot" style="background:${m.color};margin-right:4px"></span>`:''}${m.label}</td>
      <td style="text-align:right;font-size:12px;font-weight:600">${deltaStr}</td>
      <td style="text-align:right;font-size:12px;font-weight:700;color:${runBalance>5?'var(--success)':runBalance>0?'var(--warn)':'var(--danger)'}">${runBalance}d</td>
    </tr>`;
  }).join('');

  openModal(`ğŸ“Š Saldo â€” ${fullName(p)}`,`
    <div style="display:flex;gap:16px;margin-bottom:20px">
      <div style="flex:1;text-align:center;padding:12px;background:var(--accent-bg);border-radius:var(--radius-sm)">
        <div style="font-size:24px;font-weight:700;color:var(--accent)">${totalDays}</div>
        <div style="font-size:11px;color:var(--text3);font-weight:600">TOTAAL</div>
      </div>
      <div style="flex:1;text-align:center;padding:12px;background:var(--warn-bg);border-radius:var(--radius-sm)">
        <div style="font-size:24px;font-weight:700;color:var(--warn)">${usedDays}</div>
        <div style="font-size:11px;color:var(--text3);font-weight:600">OPGENOMEN</div>
      </div>
      <div style="flex:1;text-align:center;padding:12px;background:${remaining>0?'var(--success-bg)':'var(--danger-bg)'};border-radius:var(--radius-sm)">
        <div style="font-size:24px;font-weight:700;color:${remaining>0?'var(--success)':'var(--danger)'}">${remaining}</div>
        <div style="font-size:11px;color:var(--text3);font-weight:600">RESTEREND</div>
      </div>
    </div>
    <table class="tbl" style="margin-bottom:16px">
      <thead><tr><th>Type</th><th style="text-align:center">Recht</th><th style="text-align:center">Opgenomen</th><th style="text-align:center">Rest</th></tr></thead>
      <tbody>${typeSummary}</tbody>
    </table>
    <div style="margin-bottom:16px">
      <div style="font-weight:700;font-size:13px;margin-bottom:8px">ğŸ“‹ Mutatiehistoriek</div>
      <div style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius-sm)">
        <table class="tbl" style="margin:0">
          <thead><tr><th>Datum</th><th>Omschrijving</th><th style="text-align:right">Mutatie</th><th style="text-align:right">Saldo</th></tr></thead>
          <tbody>${mutHtml}</tbody>
        </table>
      </div>
    </div>
    ${adjustments?`<div style="margin-bottom:16px"><div style="font-weight:700;font-size:13px;margin-bottom:8px">Aanpassingen</div>${adjustments}</div>`:''}
    <div style="border-top:1px solid var(--border);padding-top:16px">
      <div style="font-weight:700;font-size:13px;margin-bottom:12px">Saldo aanpassen</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Type</label>
          <select class="form-input" id="adj-type">
            ${leaveTypes.filter(t=>t.tracked).map(t=>`<option value="${t.id}">${t.symbol} ${t.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Dagen (+/-)</label>
          <input type="number" class="form-input" id="adj-days" placeholder="+2 of -1" onkeydown="if(event.key==='Enter')addAdjustment('${personId}')"/>
        </div>
        <div class="form-group">
          <label class="form-label">Reden <span class="req">*</span></label>
          <input class="form-input" id="adj-reason" placeholder="Bv. overdracht vorig jaar" onkeydown="if(event.key==='Enter')addAdjustment('${personId}')"/>
        </div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="addAdjustment('${personId}')">Aanpassing toevoegen</button>
    </div>
  `,true);
}

function addAdjustment(personId){
  const days=parseFloat(document.getElementById('adj-days').value);
  const reason=document.getElementById('adj-reason').value.trim();
  const typeId=document.getElementById('adj-type').value;
  if(isNaN(days)||days===0){showToast('Voer een geldig aantal dagen in','error');return;}
  if(!reason){showToast('Reden is verplicht','error');return;}
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  if(!p.allowanceAdjustments)p.allowanceAdjustments=[];
  p.allowanceAdjustments.push({typeId,days,reason,date:new Date().toISOString().split('T')[0]});
  autoSave();openSaldoModal(personId);
  showToast('Saldo aangepast');
}

async function removeAdjustment(personId,idx){
  if(!await confirmDialog('Aanpassing verwijderen?'))return;
  const p=people.find(x=>x.id===personId);
  if(p&&p.allowanceAdjustments){p.allowanceAdjustments.splice(idx,1);autoSave();openSaldoModal(personId);}
}

// --- Leave Types ---
function openTypeModal(id){
  const t=id?leaveTypes.find(x=>x.id===id):null;
  openModal(t?'Verloftype bewerken':'Verloftype toevoegen',`
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Naam <span class="req">*</span></label>
        <input class="form-input" id="mt-name" value="${t?t.name:''}"/>
      </div>
      <div class="form-group">
        <label class="form-label">Symbool</label>
        <input class="form-input" id="mt-symbol" value="${t?t.symbol:'ğŸ“‹'}" style="width:60px"/>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Kleur</label>
        <input type="color" class="form-input" id="mt-color" value="${t?t.color:'#3b82f6'}" style="width:60px;height:36px;padding:2px"/>
      </div>
      <div class="form-group">
        <label class="form-label">Categorie</label>
        <select class="form-input" id="mt-cat">
          <option value="verlof" ${t&&t.category==='verlof'?'selected':''}>Verlof (aangevraagd)</option>
          <option value="adv" ${t&&t.category==='adv'?'selected':''}>ADV</option>
          <option value="overuren" ${t&&t.category==='overuren'?'selected':''}>Overuren</option>
          <option value="ziekte" ${t&&t.category==='ziekte'?'selected':''}>Ziekte</option>
          <option value="extern" ${t&&t.category==='extern'?'selected':''}>Extern (opgelegd â€” geen saldo)</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Betaald</label>
        <select class="form-input" id="mt-paid">
          <option value="true" ${t&&t.paid?'selected':''}>Ja</option>
          <option value="false" ${t&&!t.paid?'selected':''}>Nee</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Saldo bijhouden</label>
        <select class="form-input" id="mt-tracked">
          <option value="true" ${t&&t.tracked?'selected':''}>Ja</option>
          <option value="false" ${t&&!t.tracked?'selected':''}>Nee</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Standaard dagen per jaar</label>
      <input type="number" class="form-input" id="mt-days" value="${t?t.defaultDays:0}" min="0" style="width:120px"/>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveType('${id||''}')">Opslaan</button>
    </div>
  `);
}

function saveType(id){
  const name=document.getElementById('mt-name').value.trim();
  if(!name){showToast('Naam is verplicht','error');return;}
  const data={
    name,symbol:document.getElementById('mt-symbol').value,
    color:document.getElementById('mt-color').value,
    category:document.getElementById('mt-cat').value,
    paid:document.getElementById('mt-paid').value==='true',
    tracked:document.getElementById('mt-tracked').value==='true',
    defaultDays:parseInt(document.getElementById('mt-days').value)||0
  };
  if(id){
    const t=leaveTypes.find(x=>x.id===id);
    if(t)Object.assign(t,data);
  }else{
    leaveTypes.push({id:uid(),...data});
  }
  closeModal();autoSave();renderTypes();showToast('Verloftype opgeslagen');
}

async function deleteType(id){
  if(!await confirmDialog('Verloftype verwijderen?'))return;
  leaveTypes=leaveTypes.filter(t=>t.id!==id);
  autoSave();renderTypes();showToast('Verloftype verwijderd');
}

// --- Schedules ---
function openScheduleModal(id){
  const s=id?schedules.find(x=>x.id===id):null;
  openModal(s?'Rooster bewerken':'Rooster toevoegen',`
    <div class="form-group">
      <label class="form-label">Naam <span class="req">*</span></label>
      <input class="form-input" id="ms-name" value="${s?s.name:''}"/>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Dagen per week</label>
        <input type="number" class="form-input" id="ms-days" value="${s?s.daysPerWeek:5}" min="1" max="7"/>
      </div>
      <div class="form-group">
        <label class="form-label">Uren per dag</label>
        <input type="number" class="form-input" id="ms-hours" value="${s?s.hoursPerDay:8}" min="1" max="12"/>
      </div>
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px">
        <input type="checkbox" id="ms-half" ${s&&s.halfDays?'checked':''}/> Halve dagen toestaan
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveSchedule('${id||''}')">Opslaan</button>
    </div>
  `);
}

function saveSchedule(id){
  const name=document.getElementById('ms-name').value.trim();
  if(!name){showToast('Naam is verplicht','error');return;}
  const data={name,daysPerWeek:parseInt(document.getElementById('ms-days').value)||5,
    hoursPerDay:parseInt(document.getElementById('ms-hours').value)||8,
    halfDays:document.getElementById('ms-half').checked};
  if(id){
    const s=schedules.find(x=>x.id===id);
    if(s)Object.assign(s,data);
  }else{
    schedules.push({id:uid(),...data});
  }
  closeModal();autoSave();renderSettings();showToast('Rooster opgeslagen');
}

async function deleteSchedule(id){
  if(!await confirmDialog('Rooster verwijderen?'))return;
  const inUse=people.filter(p=>p.scheduleId===id).length;
  if(inUse>0){showToast(`Kan niet verwijderen: ${inUse} medewerker(s) gebruiken dit rooster`,'error');return;}
  schedules=schedules.filter(s=>s.id!==id);
  autoSave();renderSettings();showToast('Rooster verwijderd');
}

// --- Settings ---
function setRegion(v){settings.region=v;autoSave();renderSettings();}
function saveSettings(){
  settings.yearendMode=document.getElementById('yearend-mode').value;
  settings.yearendCustomDays=parseInt(document.getElementById('yearend-custom-days').value)||5;
  settings.notifEmail=document.getElementById('notif-email').checked;
  settings.notifSick=document.getElementById('notif-sick').checked;
  document.getElementById('yearend-custom-row').style.display=settings.yearendMode==='custom'?'block':'none';
  autoSave();showToast('Instellingen opgeslagen');
}

// â•â•â• VALIDATION â•â•â•
// (handled inline in save functions with toast feedback)

// â•â•â• BEREKENINGEN â•â•â•
// (getTotalAllowance, getUsedDays defined in SAVE FUNCTIONS section above)

// â•â•â• MEDIA â•â•â•
// (OCR for sick notes â€” Phase 2)

// â•â•â• EXPORT â•â•â•

// --- Wallchart ---
let wcDate=new Date();
let wcMode='month'; // 'month' or 'week'

function wcPrev(){
  if(wcMode==='month')wcDate.setMonth(wcDate.getMonth()-1);
  else wcDate.setDate(wcDate.getDate()-7);
  renderWallchart();
}
function wcNext(){
  if(wcMode==='month')wcDate.setMonth(wcDate.getMonth()+1);
  else wcDate.setDate(wcDate.getDate()+7);
  renderWallchart();
}
function wcToday(){wcDate=new Date();renderWallchart();}
function toggleWcMode(){
  wcMode=wcMode==='month'?'week':'month';
  document.getElementById('wc-mode-btn').textContent=wcMode==='month'?'Maand':'Week';
  renderWallchart();
}

function renderWallchart(){
  const deptFilter=document.getElementById('wc-dept').value;
  const deptSelect=document.getElementById('wc-dept');
  const curVal=deptSelect.value;
  deptSelect.innerHTML='<option value="">Alle departments</option>'+departments.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
  deptSelect.value=curVal;

  // Build date range
  let days=[];
  if(wcMode==='month'){
    const year=wcDate.getFullYear();
    const month=wcDate.getMonth();
    const daysInMonth=new Date(year,month+1,0).getDate();
    for(let i=1;i<=daysInMonth;i++)days.push(new Date(year,month,i));
    document.getElementById('wc-subtitle').textContent=wcDate.toLocaleDateString('nl-BE',{month:'long',year:'numeric'});
  }else{
    const start=new Date(wcDate);
    start.setDate(start.getDate()-start.getDay()+1);
    for(let i=0;i<7;i++){const d=new Date(start);d.setDate(start.getDate()+i);days.push(d);}
    document.getElementById('wc-subtitle').textContent=`Week ${getWeekNumber(days[0])} â€” ${days[0].toLocaleDateString('nl-BE',{day:'numeric',month:'short'})} t/m ${days[6].toLocaleDateString('nl-BE',{day:'numeric',month:'short',year:'numeric'})}`;
  }

  // Legend
  const legend=document.getElementById('wc-legend');
  legend.innerHTML=leaveTypes.map(t=>`<span style="display:flex;align-items:center;gap:4px"><span class="clr-dot" style="background:${t.color}"></span>${t.symbol} ${t.name}</span>`).join('');

  // Header
  const thead=document.getElementById('wc-thead');
  const today=new Date().toISOString().split('T')[0];
  const dayNames=['Zo','Ma','Di','Wo','Do','Vr','Za'];
  thead.innerHTML=`<tr><th style="min-width:140px;position:sticky;left:0;background:var(--surface);z-index:1">Medewerker</th>${days.map(d=>{
    const ds=d.toISOString().split('T')[0];
    const isToday=ds===today;
    const isWeekend=d.getDay()===0||d.getDay()===6;
    const isHoliday=isPublicHoliday(ds);
    return `<th style="min-width:${wcMode==='week'?'80':'28'}px;text-align:center;padding:4px 2px;
      ${isToday?'background:var(--accent-bg);color:var(--accent);font-weight:700;':''}
      ${isWeekend?'background:#f1f1f5;color:var(--text3);':''}
      ${isHoliday?'background:rgba(239,68,68,.08);color:var(--danger);':''}
      font-size:10px">${d.getDate()}<br>${dayNames[d.getDay()]}</th>`;
  }).join('')}</tr>`;

  // Body
  let filteredPeople=[...people];
  if(deptFilter)filteredPeople=filteredPeople.filter(p=>p.departmentId===deptFilter);

  const tbody=document.getElementById('wc-tbody');
  tbody.innerHTML=filteredPeople.map(p=>{
    const dept=departments.find(d=>d.id===p.departmentId);
    return `<tr>
      <td style="position:sticky;left:0;background:var(--surface);z-index:1;white-space:nowrap">
        <div style="display:flex;align-items:center;gap:6px">
          <div class="avatar" style="background:${getAvatarColor(fullName(p))};width:22px;height:22px;font-size:9px">${getInitials(fullName(p))}</div>
          <div><div style="font-weight:600;font-size:11px">${fullName(p)}</div>
          <div style="font-size:9px;color:var(--text3)">${dept?dept.name:''}</div></div>
        </div>
      </td>
      ${days.map(d=>{
        const ds=d.toISOString().split('T')[0];
        const isWeekend=d.getDay()===0||d.getDay()===6;
        const isHoliday=isPublicHoliday(ds);
        const req=requests.find(r=>r.personId===p.id&&r.status==='approved'&&r.startDate<=ds&&r.endDate>=ds);
        const type=req?leaveTypes.find(t=>t.id===req.type):null;
        let bg=isWeekend?'#f1f1f5':isHoliday?'rgba(239,68,68,.06)':'';
        let content='';
        if(type){
          const half=req.halfDay;
          bg=type.color+'33';
          content=`<span title="${type.name}${half?' ('+req.halfDayPeriod+')':''}: ${fullName(p)}" style="display:block;width:100%;height:100%;background:${type.color}${half?'66':'cc'};border-radius:3px;color:#fff;font-size:9px;line-height:${wcMode==='week'?'28':'22'}px;text-align:center">${type.symbol}</span>`;
        }
        return `<td style="padding:2px;text-align:center;background:${bg};height:${wcMode==='week'?'32':'26'}px">${content}</td>`;
      }).join('')}
    </tr>`;
  }).join('');
}

function isPublicHoliday(dateStr){
  const allHolidays=[...BE_HOLIDAYS_2025,...BE_HOLIDAYS_2026];
  const region=settings.region||'vlaanderen';
  return allHolidays.some(h=>h.date===dateStr&&(h.all||(h.regions&&h.regions.includes(region))));
}

function getWeekNumber(d){
  const date=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
  date.setUTCDate(date.getUTCDate()+4-(date.getUTCDay()||7));
  const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1));
  return Math.ceil((((date-yearStart)/86400000)+1)/7);
}

// --- Rapportage ---
let reportTab='overview';

function showReportTab(tab,btn){
  reportTab=tab;
  document.querySelectorAll('.report-panel').forEach(p=>p.style.display='none');
  document.getElementById('report-'+tab).style.display='block';
  if(btn){btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');}
  renderReports();
}

function renderReports(){
  const year=new Date().getFullYear();
  document.getElementById('rp-year-label').textContent='Overzichten '+year;
  const approvedReqs=requests.filter(r=>r.status==='approved'&&r.startDate.startsWith(year));

  // Overview stats
  const totalDays=approvedReqs.reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
  const sickDays=approvedReqs.filter(r=>r.type==='ziekte').reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
  const externDays=approvedReqs.filter(r=>{const t=leaveTypes.find(x=>x.id===r.type);return t&&t.category==='extern';}).reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
  document.getElementById('rp-total-days').textContent=totalDays;
  document.getElementById('rp-total-sick').textContent=sickDays;
  document.getElementById('rp-total-extern').textContent=externDays;
  document.getElementById('rp-avg-per-person').textContent=people.length>0?(totalDays/people.length).toFixed(1):'0';

  // Stacked bar chart per month, split by type
  const trackedTypes=leaveTypes.filter(t=>t.tracked||t.id==='ziekte');
  const monthData=Array.from({length:12},()=>({}));
  approvedReqs.forEach(r=>{
    const m=parseInt(r.startDate.split('-')[1])-1;
    const d=r.halfDay?0.5:r.days||0;
    monthData[m][r.type]=(monthData[m][r.type]||0)+d;
  });
  const monthTotals=monthData.map(m=>Object.values(m).reduce((s,v)=>s+v,0));
  const maxVal=Math.max(...monthTotals,1);

  // Legend
  const usedTypes=leaveTypes.filter(t=>approvedReqs.some(r=>r.type===t.id));
  document.getElementById('rp-chart-legend').innerHTML=usedTypes.map(t=>
    `<span style="display:flex;align-items:center;gap:4px"><span class="clr-dot" style="background:${t.color}"></span>${t.symbol} ${t.name}</span>`
  ).join('')||'<span style="color:var(--text3)">Geen data</span>';

  // Y-axis
  const steps=[0,Math.round(maxVal/2),Math.round(maxVal)];
  document.getElementById('rp-chart-axis').innerHTML=steps.reverse().map(v=>`<div>${v}d</div>`).join('');

  // Bars
  const monthNames=['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];
  const curMonth=new Date().getMonth();
  document.getElementById('rp-month-chart').innerHTML=monthData.map((m,i)=>{
    const total=monthTotals[i];
    const isCur=i===curMonth;
    const segments=leaveTypes.filter(t=>m[t.id]>0).map(t=>{
      const h=Math.max(1,(m[t.id]/maxVal)*130);
      return `<div title="${t.symbol} ${t.name}: ${m[t.id]}d" style="width:100%;height:${h}px;background:${t.color};opacity:${isCur?1:.7}"></div>`;
    }).join('');
    return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;gap:0">
      <div style="font-size:9px;font-weight:700;margin-bottom:2px;color:${isCur?'var(--accent)':'var(--text3)'}">${total>0?total:''}</div>
      <div style="width:100%;display:flex;flex-direction:column;border-radius:3px 3px 0 0;overflow:hidden">${segments||`<div style="width:100%;height:2px;background:var(--surface3)"></div>`}</div>
    </div>`;
  }).join('');
  document.getElementById('rp-month-labels').innerHTML=monthNames.map((m,i)=>
    `<div style="flex:1;text-align:center;${i===curMonth?'font-weight:700;color:var(--accent)':''}">${m}</div>`
  ).join('');

  // Type donut (horizontal bars as visual representation)
  const typeStats=leaveTypes.map(t=>{
    const d=approvedReqs.filter(r=>r.type===t.id).reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
    return {type:t,days:d};
  }).filter(x=>x.days>0).sort((a,b)=>b.days-a.days);
  const maxType=typeStats.length>0?typeStats[0].days:1;

  document.getElementById('rp-type-donut').innerHTML=typeStats.length===0
    ?'<div style="color:var(--text3);padding:20px;text-align:center">Geen data voor dit jaar</div>'
    :typeStats.map(x=>{
      const pct=Math.max(5,(x.days/maxType)*100);
      const share=totalDays>0?Math.round(x.days/totalDays*100):0;
      return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <div style="min-width:100px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px">
          <span class="clr-dot" style="background:${x.type.color}"></span>${x.type.symbol} ${x.type.name}
        </div>
        <div style="flex:1;height:22px;background:var(--surface3);border-radius:4px;overflow:hidden;position:relative">
          <div style="height:100%;width:${pct}%;background:${x.type.color};border-radius:4px;opacity:.8;transition:width .3s"></div>
        </div>
        <div style="min-width:60px;text-align:right;font-size:12px"><strong>${x.days}d</strong> <span style="color:var(--text3)">(${share}%)</span></div>
      </div>`;
    }).join('');

  // Per person table
  const ptBody=document.getElementById('rp-person-table');
  ptBody.innerHTML=people.map(p=>{
    const dept=departments.find(d=>d.id===p.departmentId);
    const total=getTotalAllowance(p);
    const used=getUsedDays(p.id);
    const today=new Date().toISOString().split('T')[0];
    const planned=requests.filter(r=>r.personId===p.id&&r.status==='approved'&&r.startDate>today)
      .reduce((s,r)=>{const t=leaveTypes.find(x=>x.id===r.type);return s+((t&&t.tracked)?(r.halfDay?0.5:r.days||0):0);},0);
    const sick=requests.filter(r=>r.personId===p.id&&r.type==='ziekte'&&r.startDate.startsWith(year))
      .reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
    const remaining=total-used;
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:8px">
        <div class="avatar" style="background:${getAvatarColor(fullName(p))};width:26px;height:26px;font-size:10px">${getInitials(fullName(p))}</div>
        <span style="font-weight:600">${fullName(p)}</span>
      </div></td>
      <td>${dept?dept.name:'â€”'}</td>
      <td style="font-weight:600">${total}d</td>
      <td>${used}d</td>
      <td>${planned}d</td>
      <td style="font-weight:700;color:${remaining>5?'var(--success)':remaining>0?'var(--warn)':'var(--danger)'}">${remaining}d</td>
      <td style="color:${sick>0?'var(--danger)':'var(--text3)'}">${sick}d</td>
    </tr>`;
  }).join('');

  // Per type table
  const ttBody=document.getElementById('rp-type-table');
  ttBody.innerHTML=leaveTypes.map(t=>{
    const typeReqs=approvedReqs.filter(r=>r.type===t.id);
    const totalD=typeReqs.reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
    const avgD=typeReqs.length>0?(totalD/typeReqs.length).toFixed(1):'â€”';
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:6px"><span class="clr-dot" style="background:${t.color}"></span>${t.symbol} <span style="font-weight:600">${t.name}</span></div></td>
      <td><span class="badge badge-gray">${t.category}</span></td>
      <td style="font-weight:600">${totalD}d</td>
      <td>${typeReqs.length}</td>
      <td>${avgD}d</td>
    </tr>`;
  }).join('');
}

// --- Export functies ---
function exportReportCSV(){
  const year=new Date().getFullYear();
  let csv='Medewerker;Department;Totaal recht;Opgenomen;Resterend;Ziektedagen\n';
  people.forEach(p=>{
    const dept=departments.find(d=>d.id===p.departmentId);
    const total=getTotalAllowance(p);
    const used=getUsedDays(p.id);
    const sick=requests.filter(r=>r.personId===p.id&&r.type==='ziekte'&&r.startDate.startsWith(year))
      .reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
    csv+=`${fullName(p)};${dept?dept.name:''};${total};${used};${total-used};${sick}\n`;
  });
  downloadFile('verlofoverzicht_'+year+'.csv',csv,'text/csv');
  showToast('CSV geÃ«xporteerd ğŸ“Š');
}

function downloadFile(filename,content,type){
  const blob=new Blob([content],{type:type+';charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

// â•â•â• SALARIS â•â•â•

function getBaremaRate(catId,date){
  // Get the applicable rate for a category at a given date
  const sorted=[...baremaData].sort((a,b)=>a.date.localeCompare(b.date));
  let rate=0;
  for(const p of sorted){
    if(p.date<=date)rate=p.rates[catId]||0;
  }
  return rate;
}

function getAncienniteitPct(startDate,atDate){
  if(!startDate||!atDate)return 0;
  const start=new Date(startDate);
  const at=new Date(atDate);
  let years=at.getFullYear()-start.getFullYear();
  if(at.getMonth()<start.getMonth()||(at.getMonth()===start.getMonth()&&at.getDate()<start.getDate()))years--;
  if(years<0)years=0;
  // Calculate from rules
  const rule1=ancienniteitData.find(a=>a.id==='anc1');
  const rule2=ancienniteitData.find(a=>a.id==='anc2');
  const rule3=ancienniteitData.find(a=>a.id==='anc3');
  const pct1=rule1?rule1.pct:1;
  const pctPerYear=rule2?rule2.pct:0.5;
  const maxPct=rule3?rule3.pct:13;
  if(years<1)return 0;
  if(years===1)return pct1;
  return Math.min(pct1+(years-1)*pctPerYear,maxPct);
}

function calcCurrentSalary(person){
  if(!person||!person.salaryHistory)return null;
  const today=new Date().toISOString().split('T')[0];
  const startMutation=person.salaryHistory.find(m=>m.type===SALARY_TYPE_START);
  if(!startMutation)return null;
  const startLoon=startMutation.amount;
  // Sum all non-start mutations up to today
  let totalMutations=0;
  person.salaryHistory.forEach(m=>{
    if(m.type!==SALARY_TYPE_START&&!m.deleted&&m.date<=today)totalMutations+=m.amount;
  });
  const currentRate=Math.round((startLoon+totalMutations)*100)/100;
  return {startLoon,totalMutations,currentRate};
}

function openSalaryModal(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;

  // Check if startsalaris exists, if not ask for it first
  if(!p.salaryHistory||!p.salaryHistory.find(m=>m.type===SALARY_TYPE_START)){
    openModal('ğŸ’¶ Startloon invullen',`
      <div style="max-width:400px">
        <div style="font-size:12px;color:var(--text2);margin-bottom:16px">Vul het startloon in voor <strong>${p.firstName} ${p.lastName}</strong>. Dit wordt het vaste referentiepunt voor de salaris-evolutie.</div>
        <div class="form-group">
          <label class="form-label">Startdatum</label>
          <input type="date" class="form-input" value="${p.startDate||''}" disabled style="background:var(--surface2);color:var(--text2)"/>
          <div style="font-size:10px;color:var(--text3);margin-top:4px">Overgenomen uit personeelsfiche</div>
        </div>
        <div class="form-group">
          <label class="form-label">Startloon (â‚¬/uur) <span class="req">*</span></label>
          <input type="number" step="0.01" min="0" class="form-input" id="start-salary-amount" placeholder="bv. 18.45" style="width:160px"/>
        </div>
        <div class="modal-actions">
          <button class="btn" onclick="closeModal();openPersonModal('${personId}')">Annuleren</button>
          <button class="btn btn-primary" onclick="saveStartSalary('${personId}')">Opslaan</button>
        </div>
      </div>
    `);
    return;
  }

  const cat=BAREMA_CATEGORIES.find(c=>c.id===p.baremaCategory);
  const catLabel=cat?`${cat.id} â€” ${cat.name}`:'Geen categorie';
  const today=new Date().toISOString().split('T')[0];
  const sal=calcCurrentSalary(p);
  const ancPct=getAncienniteitPct(p.startDate,today);
  // Calculate dienstjaren
  let dienstjaren=0;
  if(p.startDate){
    const start=new Date(p.startDate);const now=new Date(today);
    dienstjaren=now.getFullYear()-start.getFullYear();
    if(now.getMonth()<start.getMonth()||(now.getMonth()===start.getMonth()&&now.getDate()<start.getDate()))dienstjaren--;
    if(dienstjaren<0)dienstjaren=0;
  }

  // Build salary history timeline
  const history=p.salaryHistory||[];
  const sortedHistory=[...history].sort((a,b)=>b.date.localeCompare(a.date));

  // Non-system reason types for the add dropdown
  const addableTypes=salaryReasonTypes.filter(t=>t.id!=='start');

  openModal(`ğŸ’¶ Salaris â€” ${p.firstName} ${p.lastName}`,`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm" onclick="manageSalaryReasonTypes('${personId}')">âš™ï¸ Types beheren</button>
        <button class="btn btn-sm" onclick="openLoonberekening('${personId}')">ğŸ§® Loonberekening</button>
      </div>
      <button class="btn btn-sm" onclick="closeModal();openPersonModal('${personId}')">â† Terug naar fiche</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
      <div>
        <div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:12px">Huidig overzicht</div>
        <div class="card" style="padding:16px;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:12px;color:var(--text2)">Startloon</span>
            <span style="font-weight:600;font-size:13px">â‚¬ ${sal?sal.startLoon.toFixed(2):'â€”'} <span style="font-size:10px;color:var(--text3)">(${p.startDate?formatDate(p.startDate):'â€”'})</span></span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:12px;color:var(--text2)">Categorie</span>
            <span class="badge badge-purple" style="font-weight:700">${catLabel}</span>
          </div>
          ${sal&&sal.totalMutations!==0?`<div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:12px;color:var(--text2)">Mutaties</span>
            <span style="font-weight:600;font-size:12px;color:${sal.totalMutations>=0?'#0d9668':'var(--danger)'}">â‚¬ ${sal.totalMutations>0?'+':''}${sal.totalMutations.toFixed(2)}</span>
          </div>`:''}
          <div style="border-top:2px solid var(--border);padding-top:8px;margin-top:4px;display:flex;justify-content:space-between">
            <span style="font-weight:700;font-size:13px">Huidig uurloon</span>
            <span style="font-weight:700;font-size:16px;color:var(--accent)">â‚¬ ${sal?sal.currentRate.toFixed(2):'â€”'}</span>
          </div>
          ${sal&&sal.totalMutations!==0?`<div style="display:flex;justify-content:space-between;margin-top:6px">
            <span style="font-size:11px;color:var(--text3)">Groei t.o.v. startloon</span>
            <span style="font-size:11px;font-weight:600;color:${sal.totalMutations>=0?'#0d9668':'var(--danger)'}">â‚¬ ${sal.totalMutations>0?'+':''}${sal.totalMutations.toFixed(2)} (${sal.startLoon>0?(sal.totalMutations>0?'+':'')+(sal.totalMutations/sal.startLoon*100).toFixed(1):'0'}%)</span>
          </div>`:''}
        </div>
        <div style="font-size:11px;color:var(--text3)">
          Startdatum: ${p.startDate?formatDate(p.startDate):'â€”'} Â· ${dienstjaren} dienstjaar${dienstjaren!==1?'en':''}
        </div>
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3)">Salaris-historiek</div>
          <button class="btn btn-sm btn-primary-outline" onclick="addSalaryMutation('${personId}')">â• Mutatie</button>
        </div>
        <div style="max-height:320px;overflow-y:auto">
          <table class="tbl" style="font-size:12px">
            <thead><tr><th>Datum</th><th>Type</th><th style="text-align:right">Uurloon</th><th style="text-align:right">Verschil</th><th></th></tr></thead>
            <tbody>
              ${sortedHistory.length===0?'<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:16px">Nog geen mutaties</td></tr>'
              :(() => {
                // Calculate running totals in chronological order (exclude deleted)
                const chrono=[...history].sort((a,b)=>a.date.localeCompare(b.date));
                const runningMap={};let running=0;
                chrono.forEach(m=>{
                  if(m.deleted)return;
                  if(m.type===SALARY_TYPE_START)running=m.amount; else running=Math.round((running+m.amount)*100)/100;
                  runningMap[m.id]=running;
                });
                // Display newest first
                return sortedHistory.map(m=>{
                  const rt=salaryReasonTypes.find(t=>t.id===m.type);
                  const icon=rt?rt.icon:'ğŸ’°';
                  const typeName=rt?rt.name:m.type;
                  const isStart=m.type===SALARY_TYPE_START;
                  const isDel=!!m.deleted;
                  const rowStyle=isDel?'opacity:.45;text-decoration:line-through':'';
                  const delInfo=isDel?' <span style="text-decoration:none;font-size:9px;color:var(--danger);font-style:italic"> âœ• '+m.deleteReason+'</span>':'';
                  return '<tr style="'+rowStyle+'">'
                    +'<td>'+formatDate(m.date)+'</td>'
                    +'<td>'+icon+' '+typeName+(m.comment?' <span style="color:var(--text3);font-size:10px">â€” '+m.comment+'</span>':'')+delInfo+'</td>'
                    +'<td style="text-align:right;font-weight:700">'+(isDel?'â€”':'â‚¬ '+(runningMap[m.id]||0).toFixed(2))+'</td>'
                    +'<td style="text-align:right;font-weight:600;color:'+(isStart?'var(--text3)':m.amount>=0?'#0d9668':'var(--danger)')+'">'+
                      (isStart?'â€”':'â‚¬ '+(m.amount>=0?'+':'')+m.amount.toFixed(2))+'</td>'
                    +'<td style="width:30px">'+(isDel?'<span style="text-decoration:none;font-size:10px" title="Geannuleerd">âœ•</span>'
                      :m.locked?'<span title="Verwerkt â€” kan niet verwijderd worden" style="font-size:10px">ğŸ”’</span>'
                      :'<button class="btn-icon" style="width:24px;height:24px;font-size:11px;border:none;background:none;cursor:pointer;color:var(--danger)" onclick="deleteSalaryMutation(\''+personId+'\',\''+m.id+'\')" title="Annuleren" aria-label="Annuleren">ğŸ—‘</button>')+'</td>'
                    +'</tr>';
                }).join('');
              })()}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `);
}

function saveStartSalary(personId){
  const amount=parseFloat(document.getElementById('start-salary-amount').value);
  if(isNaN(amount)||amount<=0){showToast('Vul een geldig startloon in','error');return;}
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  if(!p.salaryHistory)p.salaryHistory=[];
  p.salaryHistory.push({id:uid(),date:p.startDate||new Date().toISOString().split('T')[0],type:'start',amount,comment:'Startloon',locked:true});
  autoSave();
  closeModal();openSalaryModal(personId);
  showToast('Startloon opgeslagen');
}

function addSalaryMutation(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  const sal=calcCurrentSalary(p);
  const currentRate=sal?sal.currentRate:0;
  const addableTypes=salaryReasonTypes.filter(t=>t.id!=='start');
  openModal('â• Salarismutatie toevoegen',`
    <div style="max-width:400px">
      <div class="form-group">
        <label class="form-label">Huidig uurloon</label>
        <div style="font-weight:700;font-size:16px;color:var(--accent);padding:4px 0">â‚¬ ${currentRate.toFixed(2)}</div>
      </div>
      <div class="form-group"><label class="form-label">Datum <span class="req">*</span></label>
        <input type="date" class="form-input" id="sm-date" value="${new Date().toISOString().split('T')[0]}"/>
      </div>
      <div class="form-group"><label class="form-label">Type <span class="req">*</span></label>
        <select class="form-input" id="sm-type">
          ${addableTypes.map(t=>`<option value="${t.id}">${t.icon} ${t.name}</option>`).join('')}
        </select>
      </div>
      <div class="form-group"><label class="form-label">Nieuw uurtarief (â‚¬/uur) <span class="req">*</span></label>
        <input type="number" step="0.01" min="0" class="form-input" id="sm-newrate" placeholder="bv. 19.50" style="width:160px" value="" oninput="updateMutationDiff(${currentRate})"/>
        <div id="sm-diff" style="font-size:11px;margin-top:4px;color:var(--text3)"></div>
      </div>
      <div class="form-group"><label class="form-label">Omschrijving <span class="req">*</span></label>
        <input type="text" class="form-input" id="sm-comment" placeholder="Reden voor loonwijziging"/>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal();openSalaryModal('${personId}')">Annuleren</button>
        <button class="btn btn-primary" onclick="confirmSalaryMutation('${personId}',${currentRate})">Toevoegen</button>
      </div>
    </div>
  `);
}

function updateMutationDiff(currentRate){
  const newRate=parseFloat(document.getElementById('sm-newrate').value);
  const el=document.getElementById('sm-diff');
  if(isNaN(newRate)||!el)return;
  const diff=Math.round((newRate-currentRate)*100)/100;
  el.innerHTML=diff>=0
    ?'<span style="color:#0d9668;font-weight:600">+â‚¬ '+diff.toFixed(2)+' verhoging</span>'
    :'<span style="color:var(--danger);font-weight:600">â‚¬ '+diff.toFixed(2)+' verlaging</span>';
}

function confirmSalaryMutation(personId,currentRate){
  const date=document.getElementById('sm-date').value;
  const type=document.getElementById('sm-type').value;
  const newRate=parseFloat(document.getElementById('sm-newrate').value);
  const comment=document.getElementById('sm-comment').value.trim();
  if(!date){showToast('Datum is verplicht','error');return;}
  if(!type){showToast('Type is verplicht','error');return;}
  if(!comment){showToast('Omschrijving is verplicht','error');return;}
  if(isNaN(newRate)||newRate<=0){showToast('Vul een geldig uurtarief in','error');return;}
  const amount=Math.round((newRate-currentRate)*100)/100;
  if(amount===0){showToast('Nieuw tarief is gelijk aan huidig tarief','error');return;}
  if(newRate<0){showToast('Uurloon kan niet negatief zijn','error');return;}
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  if(!p.salaryHistory)p.salaryHistory=[];
  p.salaryHistory.push({id:uid(),date,type,amount,comment,locked:false});
  autoSave();
  closeModal();openSalaryModal(personId);
  showToast('Salarismutatie toegevoegd');
}

async function deleteSalaryMutation(personId,mutationId){
  const p=people.find(x=>x.id===personId);
  if(!p||!p.salaryHistory)return;
  const m=p.salaryHistory.find(x=>x.id===mutationId);
  if(!m)return;
  // Ask for reason via custom dialog
  closeModal();
  openModal('ğŸ—‘ Mutatie annuleren','<div style="max-width:400px">'
    +'<div style="font-size:12px;color:var(--text2);margin-bottom:12px">Je staat op het punt een loonmutatie te annuleren. De mutatie blijft zichtbaar in de historiek als doorgestreept item.</div>'
    +'<div class="form-group"><label class="form-label">Reden voor annulering <span class="req">*</span></label>'
    +'<input type="text" class="form-input" id="sd-reason" placeholder="Waarom wordt deze mutatie geannuleerd?"/></div>'
    +'<div class="modal-actions">'
    +'<button class="btn" onclick="closeModal();openSalaryModal(\''+personId+'\')">Annuleren</button>'
    +'<button class="btn btn-primary" style="background:var(--danger);border-color:var(--danger)" onclick="confirmSoftDelete(\''+personId+'\',\''+mutationId+'\')">Annuleer mutatie</button>'
    +'</div></div>');
}

function confirmSoftDelete(personId,mutationId){
  const reason=document.getElementById('sd-reason').value.trim();
  if(!reason){showToast('Reden is verplicht','error');return;}
  const p=people.find(x=>x.id===personId);
  if(!p||!p.salaryHistory)return;
  const m=p.salaryHistory.find(x=>x.id===mutationId);
  if(!m)return;
  m.deleted=true;
  m.deletedDate=new Date().toISOString().split('T')[0];
  m.deleteReason=reason;
  autoSave();
  closeModal();openSalaryModal(personId);
  showToast('Mutatie geannuleerd');
}

function manageSalaryReasonTypes(personId){
  const custom=salaryReasonTypes.filter(t=>!t.system);
  openModal('âš™ï¸ Mutatie-types beheren',`
    <div style="max-width:400px">
      <div style="font-size:12px;color:var(--text2);margin-bottom:12px">Systeem-types (niet verwijderbaar): ${salaryReasonTypes.filter(t=>t.system).map(t=>t.icon+' '+t.name).join(', ')}</div>
      <table class="tbl" style="font-size:12px">
        <thead><tr><th>Icon</th><th>Naam</th><th></th></tr></thead>
        <tbody>
          ${custom.map(t=>`<tr>
            <td>${t.icon}</td>
            <td>${t.name}</td>
            <td style="width:30px"><button class="btn-icon" style="width:24px;height:24px;font-size:11px;border:none;background:none;cursor:pointer;color:var(--danger)" onclick="deleteSalaryReasonType('${t.id}','${personId}')" title="Verwijderen" aria-label="Verwijderen">ğŸ—‘</button></td>
          </tr>`).join('')}
          ${custom.length===0?'<tr><td colspan="3" style="text-align:center;color:var(--text3);padding:12px">Geen aangepaste types</td></tr>':''}
        </tbody>
      </table>
      <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
        <div style="font-weight:600;font-size:12px;margin-bottom:8px">Nieuw type toevoegen</div>
        <div class="form-row">
          <div class="form-group" style="flex:0 0 60px"><label class="form-label">Icon</label><input class="form-input" id="srt-icon" value="ğŸ’°" style="text-align:center"/></div>
          <div class="form-group"><label class="form-label">Naam</label><input class="form-input" id="srt-name" placeholder="bv. Certificaat"/></div>
        </div>
        <button class="btn btn-sm btn-primary-outline" onclick="addSalaryReasonType('${personId}')" style="width:100%">â• Toevoegen</button>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal();openSalaryModal('${personId}')">â† Terug</button>
      </div>
    </div>
  `);
}

function addSalaryReasonType(personId){
  const icon=document.getElementById('srt-icon').value.trim()||'ğŸ’°';
  const name=document.getElementById('srt-name').value.trim();
  if(!name){showToast('Naam is verplicht','error');return;}
  const id=name.toLowerCase().replace(/[^a-z0-9]/g,'-');
  if(salaryReasonTypes.find(t=>t.id===id)){showToast('Type bestaat al','error');return;}
  salaryReasonTypes.push({id,name,icon,system:false});
  autoSave();
  closeModal();manageSalaryReasonTypes(personId);
  showToast('Type toegevoegd');
}

async function deleteSalaryReasonType(typeId,personId){
  // Check if in use
  const inUse=people.some(p=>p.salaryHistory&&p.salaryHistory.some(m=>m.type===typeId));
  if(inUse){showToast('Type is in gebruik en kan niet verwijderd worden','error');return;}
  if(!await confirmDialog('Mutatie-type verwijderen?'))return;
  salaryReasonTypes=salaryReasonTypes.filter(t=>t.id!==typeId);
  autoSave();
  closeModal();manageSalaryReasonTypes(personId);
  showToast('Type verwijderd');
}

function openLoonberekening(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  const sal=calcCurrentSalary(p);
  const currentRate=sal?sal.currentRate:0;
  const cat=BAREMA_CATEGORIES.find(c=>c.id===p.baremaCategory);
  const catLabel=cat?cat.id+' \u2014 '+cat.name:'\u2014';
  const today=new Date().toISOString().split('T')[0];

  // Detect loonsimulatie: geen startdatum of < 4 maanden geleden
  let isSimulatie=false;
  if(!p.startDate){
    isSimulatie=true;
  } else {
    const start=new Date(p.startDate);
    const maanden=(new Date().getFullYear()-start.getFullYear())*12+(new Date().getMonth()-start.getMonth());
    if(maanden<4)isSimulatie=true;
  }

  // Get latest indexed barema rate
  const sortedBarema=[...baremaData].sort((a,b)=>b.date.localeCompare(a.date));
  const latestIndexed=sortedBarema.find(b=>b.indexed);
  const latestBarema=sortedBarema[0];
  const useBarema=latestIndexed||latestBarema;
  const baremaRate=useBarema&&p.baremaCategory?useBarema.rates[p.baremaCategory]||0:0;
  const baremaDate=useBarema?useBarema.date:'';
  const baremaIndexPct=useBarema&&useBarema.indexed?useBarema.indexPct:0;

  // AnciÃ«nniteit (0 bij simulatie)
  let dienstjaren=0;
  if(!isSimulatie&&p.startDate){
    const start=new Date(p.startDate);const now=new Date(today);
    dienstjaren=now.getFullYear()-start.getFullYear();
    if(now.getMonth()<start.getMonth()||(now.getMonth()===start.getMonth()&&now.getDate()<start.getDate()))dienstjaren--;
    if(dienstjaren<0)dienstjaren=0;
  }
  const ancPct=isSimulatie?0:getAncienniteitPct(p.startDate,today);
  const ancAmount=Math.round(baremaRate*ancPct)/100;
  const berekendMin=Math.round((baremaRate+ancAmount)*100)/100;
  const useRate=isSimulatie?baremaRate:currentRate;
  const verschil=Math.round((useRate-berekendMin)*100)/100;
  const isAbove=verschil>=0;
  const totalWgPct=werkgeverskostData.reduce((s,c)=>s+c.pct,0);
  const effectieveDagen=uurkostParams.werkdagenJaar-uurkostParams.verlofDagen-uurkostParams.feestdagen-uurkostParams.advDagen;
  const effectieveUren=effectieveDagen*uurkostParams.urenPerDag;

  // Uren/week uit werkrooster
  const schedule=schedules.find(s=>s.id===p.scheduleId);
  const urenPerWeek=schedule?(schedule.daysPerWeek*schedule.hoursPerDay):40;
  const wekenPerMaand=4.33;
  const scheduleLabel=schedule?schedule.name:'Voltijds (5/5)';

  const simBanner=isSimulatie?'<div style="background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.25);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:8px">'
    +'<span style="font-size:16px">\uD83D\uDD2E</span><div>'
    +'<div style="font-weight:700;font-size:12px;color:#3b82f6">Loonsimulatie</div>'
    +'<div style="font-size:10px;color:var(--text3)">'+(!p.startDate?'Geen startdatum ingevuld':'Minder dan 4 maanden in dienst')+' \u2014 berekening op basis van barema zonder anci\u00EBnniteit</div>'
    +'</div></div>':'';

  const vergelijkHtml=isSimulatie
    ?'<div style="display:flex;justify-content:space-between;margin-bottom:10px"><span style="font-size:12px;color:var(--text2)">Barema uurloon</span><span style="font-weight:700;font-size:16px;color:var(--accent)">\u20AC '+useRate.toFixed(2)+'</span></div>'
    :'<div style="display:flex;justify-content:space-between;margin-bottom:10px"><span style="font-size:12px;color:var(--text2)">Huidig uurloon</span><span style="font-weight:700;font-size:16px;color:var(--accent)">\u20AC '+currentRate.toFixed(2)+'</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:10px"><span style="font-size:12px;color:var(--text2)">Berekend minimum</span><span style="font-weight:700;font-size:16px">\u20AC '+berekendMin.toFixed(2)+'</span></div>'
    +'<div style="border-top:2px solid var(--border);padding-top:8px;display:flex;justify-content:space-between"><span style="font-weight:700;font-size:13px">Verschil</span><span style="font-weight:700;font-size:16px;color:'+(isAbove?'#0d9668':'var(--danger)')+'">\u20AC '+(verschil>0?'+':'')+verschil.toFixed(2)+'</span></div>';

  const formuleAncHtml=isSimulatie
    ?'<span style="font-size:10px;font-style:italic">Geen anci\u00EBnniteit (simulatie)</span><br/>'
    :'\u00D7 (1 + '+ancPct.toFixed(2)+'% anci\u00EBnniteit)<br/><span style="font-size:10px">('+dienstjaren+' dienstjaar'+(dienstjaren!==1?'en':'')+' \u2192 +\u20AC '+ancAmount.toFixed(2)+')</span><br/>';

  const formuleResult=isSimulatie?baremaRate.toFixed(2)+' barema startloon':berekendMin.toFixed(2)+' sectoraal minimum';

  let wgRows='';
  werkgeverskostData.forEach(function(c){
    wgRows+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:4px 0;color:var(--text2)">'+c.name+'</td>'
      +'<td style="padding:4px 0;text-align:right;width:70px"><input type="number" step="0.01" value="'+c.pct+'" style="width:60px;text-align:right;border:1px solid var(--border);border-radius:4px;padding:2px 4px;font-size:11px" onchange="updateWgKost(\''+c.id+'\',this.value,\''+personId+'\')"/> %</td></tr>';
  });

  openModal((isSimulatie?'\uD83D\uDD2E Loonsimulatie':'\uD83E\uDDEE Loonberekening')+' \u2014 '+p.firstName+' '+p.lastName,
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">'
    +'<button class="btn btn-sm" onclick="closeModal();openSalaryModal(\''+personId+'\')">\u2190 Terug naar salaris</button>'
    +'<button class="btn btn-sm btn-primary-outline" onclick="openLoonSimulatieVergelijk(\''+personId+'\')">\uD83D\uDCCA Loonsimulatie vergelijken</button>'
    +'</div>'
    +simBanner
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:24px"><div>'
    +'<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:12px">Vergelijking</div>'
    +'<div class="card" style="padding:16px;margin-bottom:12px">'+vergelijkHtml+'</div>'
    +'<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;font-size:11px;color:var(--text3);line-height:1.6;margin-bottom:12px">'
    +'<div style="font-weight:600;color:var(--text2);margin-bottom:4px">\uD83D\uDCD0 Formule '+(isSimulatie?'loonsimulatie':'berekend minimum')+':</div>'
    +'Barema '+catLabel+'<br/>\u20AC '+baremaRate.toFixed(2)+' <span style="font-size:10px">('+( baremaDate?formatDate(baremaDate):'\u2014')+(baremaIndexPct?' \u00B7 +'+baremaIndexPct+'% ge\u00EFndexeerd':'')+')</span><br/>'
    +formuleAncHtml
    +'<div style="border-top:1px dashed var(--border);margin-top:6px;padding-top:6px;font-weight:600;color:var(--text)">= \u20AC '+formuleResult+'</div></div>'
    +'<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px;margin-top:16px">Werkgeverskost componenten</div>'
    +'<div class="card" style="padding:12px"><table style="width:100%;font-size:11px;border-collapse:collapse">'
    +wgRows
    +'<tr style="font-weight:700"><td style="padding:6px 0">Totaal werkgeversbijdrage</td><td style="padding:6px 0;text-align:right" id="lb-wg-total">'+totalWgPct.toFixed(2)+' %</td></tr>'
    +'</table></div></div>'
    +'<div>'
    +'<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:12px">Bruto loonberekening</div>'
    +'<div class="card" style="padding:16px;margin-bottom:12px">'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text2)">Categorie</span><span class="badge badge-purple" style="font-weight:700">'+catLabel+'</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-size:12px;color:var(--text2)">Werkrooster</span><span style="font-size:12px;font-weight:600">'+scheduleLabel+' \u00B7 '+urenPerWeek+'u/week</span></div>'
    +'<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text2)">Bruto per week</span><span style="font-weight:600" id="lb-week">\u20AC 0.00</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text2)">Bruto per maand</span><span style="font-weight:700;font-size:14px;color:var(--accent)" id="lb-maand">\u20AC 0.00</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text2)">Werkelijke kost/uur</span><span style="font-weight:700;font-size:14px;color:var(--danger)" id="lb-uurkost-inline">\u20AC 0.00</span></div>'
    +'<div style="display:flex;justify-content:space-between"><span style="font-size:12px;color:var(--text2)">Bruto per jaar</span><span style="font-weight:600" id="lb-jaar">\u20AC 0.00</span></div></div></div>'
    +'<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">Werkelijke kost werkgever</div>'
    +'<div class="card" style="padding:16px">'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text2)">Bruto jaarloon</span><span style="font-weight:600" id="lb-bruto-jaar2">\u20AC 0.00</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text2)">Werkgeversbijdrage (<span id="lb-wg-pct2">'+totalWgPct.toFixed(1)+'</span>%)</span><span style="font-weight:600;color:var(--danger)" id="lb-wg-bedrag">\u20AC 0.00</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px;border-top:2px solid var(--border);padding-top:6px"><span style="font-weight:700;font-size:13px">Totale jaarkost</span><span style="font-weight:700;font-size:15px;color:var(--danger)" id="lb-totaal-jaar">\u20AC 0.00</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px;border-top:2px solid var(--border);padding-top:6px"><span style="font-weight:700;font-size:13px">Werkelijke uurkost</span><span style="font-weight:700;font-size:16px;color:var(--danger)" id="lb-uurkost">\u20AC 0.00</span></div></div>'
    +'<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;font-size:10px;color:var(--text3);line-height:1.5;margin-top:8px">'
    +'<div style="font-weight:600;color:var(--text2);margin-bottom:2px">\uD83D\uDCD0 Formule uurkost:</div>'
    +uurkostParams.werkdagenJaar+'d - '+uurkostParams.verlofDagen+' verlof - '+uurkostParams.feestdagen+' feest - '+uurkostParams.advDagen+' ADV = <strong>'+effectieveDagen+' werkdagen</strong><br/>'
    +effectieveDagen+'d \u00D7 '+uurkostParams.urenPerDag+'u = <strong>'+effectieveUren+' effectieve uren/jaar</strong><br/>'
    +'Uurkost = Totale jaarkost / '+effectieveUren+' uur</div></div></div>'
    +'<input type="hidden" id="lb-uren" value="'+urenPerWeek+'"/>'
    +'<input type="hidden" id="lb-weken" value="'+wekenPerMaand+'"/>'
  );
  setTimeout(function(){calcLoon(useRate)},50);
}

function updateWgKost(id,value,personId){
  const c=werkgeverskostData.find(x=>x.id===id);
  if(c)c.pct=parseFloat(value)||0;
  autoSave();
  const total=werkgeverskostData.reduce((s,c)=>s+c.pct,0);
  const el=document.getElementById('lb-wg-total');if(el)el.textContent=total.toFixed(2)+' %';
  const el2=document.getElementById('lb-wg-pct2');if(el2)el2.textContent=total.toFixed(1);
  // Recalc
  const p=people.find(x=>x.id===personId);
  if(p){const sal=calcCurrentSalary(p);if(sal)calcLoon(sal.currentRate);}
}

function calcLoon(uurloon){
  const uren=parseFloat(document.getElementById('lb-uren').value)||0;
  const weken=parseFloat(document.getElementById('lb-weken').value)||0;
  const week=Math.round(uurloon*uren*100)/100;
  const maand=Math.round(week*weken*100)/100;
  const jaar=Math.round(maand*12*100)/100;
  document.getElementById('lb-week').textContent='â‚¬ '+week.toFixed(2);
  document.getElementById('lb-maand').textContent='â‚¬ '+maand.toFixed(2);
  document.getElementById('lb-jaar').textContent='â‚¬ '+jaar.toFixed(2);

  // Werkgeverskost
  const totalWgPct=werkgeverskostData.reduce((s,c)=>s+c.pct,0);
  const wgBedrag=Math.round(jaar*totalWgPct)/100;
  const totaalJaar=Math.round((jaar+wgBedrag)*100)/100;
  const effectieveDagen=uurkostParams.werkdagenJaar-uurkostParams.verlofDagen-uurkostParams.feestdagen-uurkostParams.advDagen;
  const effectieveUren=effectieveDagen*uurkostParams.urenPerDag;
  const uurkost=effectieveUren>0?Math.round(totaalJaar/effectieveUren*100)/100:0;

  const el1=document.getElementById('lb-bruto-jaar2');if(el1)el1.textContent='â‚¬ '+jaar.toFixed(2);
  const el2=document.getElementById('lb-wg-bedrag');if(el2)el2.textContent='â‚¬ '+wgBedrag.toFixed(2);
  const el3=document.getElementById('lb-totaal-jaar');if(el3)el3.textContent='â‚¬ '+totaalJaar.toFixed(2);
  const el4=document.getElementById('lb-uurkost');if(el4)el4.textContent='â‚¬ '+uurkost.toFixed(2);
  const el5=document.getElementById('lb-uurkost-inline');if(el5)el5.textContent='â‚¬ '+uurkost.toFixed(2);
}

function openLoonSimulatieVergelijk(personId){
  var p=people.find(function(x){return x.id===personId});
  if(!p)return;
  var sal=calcCurrentSalary(p);
  var currentRate=sal?sal.currentRate:0;
  var cat=BAREMA_CATEGORIES.find(function(c){return c.id===p.baremaCategory});
  var catLabel=cat?cat.id+' \u2014 '+cat.name:'\u2014';
  var today=new Date().toISOString().split('T')[0];

  // Barema + anciÃ«nniteit = berekend minimum
  if(!baremaData||baremaData.length===0){showToast('Geen barema-data beschikbaar','warn');return;}
  var sortedBarema=baremaData.slice().sort(function(a,b){return b.date.localeCompare(a.date)});
  var latestIndexed=sortedBarema.find(function(b){return b.indexed});
  var useBarema=latestIndexed||sortedBarema[0];
  var baremaRate=useBarema&&p.baremaCategory?useBarema.rates[p.baremaCategory]||0:0;
  if(!p.baremaCategory){showToast('Categorie niet ingevuld voor deze medewerker','warn');}
  var ancPct=getAncienniteitPct(p.startDate,today);
  var ancAmount=Math.round(baremaRate*ancPct)/100;
  var berekendMin=Math.round((baremaRate+ancAmount)*100)/100;

  // Schedule
  var schedule=schedules.find(function(s){return s.id===p.scheduleId});
  var urenPerWeek=schedule?(schedule.daysPerWeek*schedule.hoursPerDay):40;
  var wekenPerMaand=4.33;
  var totalWgPct=werkgeverskostData.reduce(function(s,c){return s+c.pct},0);
  var effectieveDagen=uurkostParams.werkdagenJaar-uurkostParams.verlofDagen-uurkostParams.feestdagen-uurkostParams.advDagen;
  var effectieveUren=effectieveDagen*uurkostParams.urenPerDag;

  function calcCol(uurloon){
    var week=Math.round(uurloon*urenPerWeek*100)/100;
    var maand=Math.round(week*wekenPerMaand*100)/100;
    var jaar=Math.round(maand*12*100)/100;
    var wgBedrag=Math.round(jaar*totalWgPct)/100;
    var totaalJaar=Math.round((jaar+wgBedrag)*100)/100;
    var uurkost=effectieveUren>0?Math.round(totaalJaar/effectieveUren*100)/100:0;
    return {week:week,maand:maand,jaar:jaar,wgBedrag:wgBedrag,totaalJaar:totaalJaar,uurkost:uurkost};
  }

  var c1=calcCol(currentRate);
  var c2=calcCol(berekendMin);

  function colHtml(label,color,uurloon,c,id){
    return '<div style="flex:1;min-width:180px;display:flex;flex-direction:column">'
      +'<div style="text-align:center;height:80px;display:flex;flex-direction:column;justify-content:center;align-items:center">'
      +'<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3)">'+label+'</div>'
      +'<div style="font-weight:700;font-size:20px;color:'+color+';margin-top:4px"'+(id?' id="sim-uurloon-'+id+'"':'')+'>'+'\u20AC '+uurloon.toFixed(2)+'</div>'
      +(id?'<input type="number" step="0.01" min="0" value="'+uurloon.toFixed(2)+'" style="width:100px;text-align:center;border:1px solid var(--border);border-radius:4px;padding:3px;font-size:12px;margin-top:4px" id="sim-input-'+id+'" oninput="updateSimCol(\''+id+'\',\''+personId+'\')"/>':'')
      +'</div>'
      +'<div class="card" style="padding:12px;font-size:11px;flex:1">'
      +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text3)">Bruto/week</span><span style="font-weight:600"'+(id?' id="sim-week-'+id+'"':'')+'>\u20AC '+c.week.toFixed(2)+'</span></div>'
      +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text3)">Bruto/maand</span><span style="font-weight:700;color:'+color+'"'+(id?' id="sim-maand-'+id+'"':'')+'>\u20AC '+c.maand.toFixed(2)+'</span></div>'
      +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text3)">Bruto/jaar</span><span style="font-weight:600"'+(id?' id="sim-jaar-'+id+'"':'')+'>\u20AC '+c.jaar.toFixed(2)+'</span></div>'
      +'<div style="border-top:1px solid var(--border);margin:6px 0;padding-top:6px">'
      +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text3)">WG-bijdrage</span><span style="font-weight:600;color:var(--text2)"'+(id?' id="sim-wg-'+id+'"':'')+'>\u20AC '+c.wgBedrag.toFixed(2)+'</span></div>'
      +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text3)">Totale jaarkost</span><span style="font-weight:700;color:var(--danger)"'+(id?' id="sim-totaal-'+id+'"':'')+'>\u20AC '+c.totaalJaar.toFixed(2)+'</span></div>'
      +'<div style="display:flex;justify-content:space-between"><span style="font-weight:700;color:var(--text)">Uurkost</span><span style="font-weight:700;font-size:13px;color:var(--danger)"'+(id?' id="sim-uurkost-'+id+'"':'')+'>\u20AC '+c.uurkost.toFixed(2)+'</span></div>'
      +'</div></div></div>';
  }

  // Store calc params globally for live update
  window._simParams={urenPerWeek:urenPerWeek,wekenPerMaand:wekenPerMaand,totalWgPct:totalWgPct,effectieveUren:effectieveUren};

  openModal('\uD83D\uDCCA Loonsimulatie vergelijken \u2014 '+p.firstName+' '+p.lastName,
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">'
    +'<button class="btn btn-sm" onclick="closeModal();openLoonberekening(\''+personId+'\')">\u2190 Terug naar loonberekening</button>'
    +'</div>'
    +'<div style="font-size:11px;color:var(--text3);margin-bottom:12px">'+catLabel+' \u00B7 '+urenPerWeek+'u/week \u00B7 WG-bijdrage '+totalWgPct.toFixed(1)+'% \u00B7 '+effectieveUren+' effectieve uren/jaar</div>'
    +'<div style="display:flex;gap:16px;align-items:stretch">'
    +colHtml('Huidig loon','var(--accent)',currentRate,c1,null)
    +colHtml('Berekend minimum','var(--text)',berekendMin,c2,null)
    +colHtml('Aangepast loon','#8b5cf6',currentRate,c1,'custom')
    +'</div>'
  );
}

function updateSimCol(id,personId){
  var input=document.getElementById('sim-input-'+id);
  if(!input)return;
  var uurloon=parseFloat(input.value)||0;
  var sp=window._simParams;
  var week=Math.round(uurloon*sp.urenPerWeek*100)/100;
  var maand=Math.round(week*sp.wekenPerMaand*100)/100;
  var jaar=Math.round(maand*12*100)/100;
  var wgBedrag=Math.round(jaar*sp.totalWgPct)/100;
  var totaalJaar=Math.round((jaar+wgBedrag)*100)/100;
  var uurkost=sp.effectieveUren>0?Math.round(totaalJaar/sp.effectieveUren*100)/100:0;

  var el=document.getElementById('sim-uurloon-'+id);if(el)el.textContent='\u20AC '+uurloon.toFixed(2);
  el=document.getElementById('sim-week-'+id);if(el)el.textContent='\u20AC '+week.toFixed(2);
  el=document.getElementById('sim-maand-'+id);if(el)el.textContent='\u20AC '+maand.toFixed(2);
  el=document.getElementById('sim-jaar-'+id);if(el)el.textContent='\u20AC '+jaar.toFixed(2);
  el=document.getElementById('sim-wg-'+id);if(el)el.textContent='\u20AC '+wgBedrag.toFixed(2);
  el=document.getElementById('sim-totaal-'+id);if(el)el.textContent='\u20AC '+totaalJaar.toFixed(2);
  el=document.getElementById('sim-uurkost-'+id);if(el)el.textContent='\u20AC '+uurkost.toFixed(2);
}


// â•â•â• BAREMA â•â•â•

function renderBarema(){
  const thead=document.getElementById('barema-thead');
  const tbody=document.getElementById('barema-tbody');
  if(!thead||!tbody)return;

  // Sort periods by date
  const sorted=[...baremaData].sort((a,b)=>a.date.localeCompare(b.date));

  // Check which indexed periods are fully applied
  const eligible=people.filter(function(p){
    return !p.archived&&p.paritairComite==='149.01'&&p.salaryHistory&&p.salaryHistory.find(function(m){return m.type===SALARY_TYPE_START;});
  });

  sorted.forEach(function(p){
    if(!p.indexed){p._applied=true;return;}
    var notApplied=eligible.filter(function(pe){
      return !pe.salaryHistory.some(function(m){return m.type==='index'&&m.date===p.date&&!m.deleted;});
    });
    p._applied=notApplied.length===0;
    p._remaining=notApplied.length;
  });

  // Header
  thead.innerHTML=`<tr>
    <th style="width:60px">Cat.</th>
    <th>Omschrijving</th>
    ${sorted.map(p=>{
      const isIdx=p.indexed;
      const notApplied=isIdx&&!p._applied;
      return `<th style="text-align:center;min-width:110px;${notApplied?'background:rgba(34,197,94,.10);':''}">
        ${notApplied?'<div style="margin-bottom:4px"><span style="display:inline-block;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;font-size:9px;font-weight:800;letter-spacing:1px;padding:2px 8px;border-radius:10px;text-transform:uppercase;box-shadow:0 1px 3px rgba(34,197,94,.4)">NEW</span></div>':''}
        <div style="font-weight:700;${notApplied?'color:#16a34a;':''}">${formatDate(p.date)}</div>
        <div style="font-size:10px;color:var(--text3);font-weight:400">â‚¬/uur Â· 40u${isIdx?' Â· <span style="color:#0d9668;font-weight:600">+'+p.indexPct+'%</span>':''}</div>
        ${notApplied?'<div style="font-size:9px;color:#16a34a;margin-top:2px">'+p._remaining+' medewerker'+(p._remaining>1?'s':'')+' nog toe te passen</div>':''}
      </th>`;
    }).join('')}
  </tr>`;

  // Body: one row per category
  tbody.innerHTML=BAREMA_CATEGORIES.map(cat=>{
    return `<tr>
      <td><span class="badge badge-purple" style="min-width:28px;text-align:center;font-weight:700">${cat.id}</span></td>
      <td><div style="font-weight:600;font-size:12px">${cat.name}</div><div style="font-size:10px;color:var(--text3)">${cat.desc}</div></td>
      ${sorted.map(p=>{
        const rate=p.rates[cat.id]||'';
        const notApplied=p.indexed&&!p._applied;
        return `<td style="text-align:center;${notApplied?'background:rgba(34,197,94,.06);':''}">
          <input type="number" step="0.01" min="0" value="${rate}" 
            style="width:80px;text-align:center;border:1px solid ${notApplied?'#22c55e':'var(--border)'};border-radius:var(--radius-sm);padding:4px 6px;font-size:13px;font-weight:600;${notApplied?'color:#16a34a;':''}"
            onchange="updateBaremaRate('${p.id}','${cat.id}',this.value)"/>
        </td>`;
      }).join('')}
    </tr>`;
  }).join('')

  // Footer row with delete buttons
  + `<tr style="border-top:2px solid var(--border)">
    <td colspan="2" style="font-size:11px;color:var(--text3);padding-top:8px">Periodes verwijderen:</td>
    ${sorted.map(p=>{
      const isUsed=people.some(pe=>pe.salaryHistory&&pe.salaryHistory.some(s=>s.baremaId===p.id));
      return `<td style="text-align:center;padding-top:8px">
        ${isUsed?`<span style="font-size:10px;color:var(--text3)" title="In gebruik â€” kan niet verwijderd worden">ğŸ”’</span>`
        :`<button class="btn btn-sm" style="font-size:10px;color:var(--danger)" onclick="deleteBaremaPeriod('${p.id}')" title="Verwijderen" aria-label="Verwijderen">ğŸ—‘</button>`}
      </td>`;
    }).join('')}
  </tr>`;
}

function updateBaremaRate(periodId,catId,value){
  const p=baremaData.find(x=>x.id===periodId);
  if(!p)return;
  p.rates[catId]=parseFloat(value)||0;
  autoSave();
}

async function addBaremaPeriod(){
  // Open modal asking for date
  openModal('Nieuwe barema-periode','<div class="form-group"><label class="form-label">Ingangsdatum</label><input type="date" class="form-input" id="barema-new-date" value="'+new Date().toISOString().split('T')[0]+'"/></div><div style="font-size:12px;color:var(--text3);margin-top:8px">De kolom wordt toegevoegd met lege uurlonen die je zelf invult.</div><div class="modal-actions"><button class="btn" onclick="closeModal()">Annuleren</button><button class="btn btn-primary" onclick="confirmAddBaremaPeriod()">Toevoegen</button></div>');
}

function confirmAddBaremaPeriod(){
  const dateInput=document.getElementById('barema-new-date');
  if(!dateInput||!dateInput.value){showToast('Kies een datum','error');return;}
  const date=dateInput.value;
  // Check duplicate
  if(baremaData.some(b=>b.date===date)){showToast('Er bestaat al een periode met deze datum','error');return;}
  const rates={};
  BAREMA_CATEGORIES.forEach(c=>rates[c.id]=0);
  // Pre-fill with last known rates + 2.23% index
  const sorted=[...baremaData].sort((a,b)=>b.date.localeCompare(a.date));
  if(sorted.length>0){
    const last=sorted[0].rates;
    BAREMA_CATEGORIES.forEach(c=>{rates[c.id]=last[c.id]||0;});
  }
  baremaData.push({id:uid(),date:date,rates:rates});
  autoSave();closeModal();renderBarema();
  showToast('Barema-periode toegevoegd');
}

async function deleteBaremaPeriod(id){
  if(!await confirmDialog('Barema-periode verwijderen?'))return;
  baremaData=baremaData.filter(b=>b.id!==id);
  autoSave();renderBarema();
  showToast('Barema-periode verwijderd');
}

function addBaremaIndexation(){
  // Check of de laatste indexatie al is toegepast op medewerkers
  const sorted=[...baremaData].sort((a,b)=>b.date.localeCompare(a.date));
  const lastIndexed=sorted.find(b=>b.indexed);
  if(lastIndexed){
    const eligible=people.filter(function(p){
      return !p.archived&&p.paritairComite==='149.01'&&p.salaryHistory&&p.salaryHistory.find(function(m){return m.type===SALARY_TYPE_START;});
    });
    const notApplied=eligible.filter(function(p){
      return !p.salaryHistory.some(function(m){return m.type==='index'&&m.date===lastIndexed.date&&!m.deleted;});
    });
    if(notApplied.length>0){
      showToast('De indexatie van '+formatDate(lastIndexed.date)+' (+'+lastIndexed.indexPct+'%) is nog niet toegepast op '+notApplied.length+' medewerker'+(notApplied.length>1?'s':'')+'. Pas eerst de huidige indexatie toe via "Indexatie toepassen".','error');
      return;
    }
  }
  openModal('â• Nieuwe indexatie',`
    <div class="form-group">
      <label class="form-label">Gaat in vanaf</label>
      <input type="date" class="form-input" id="barema-idx-date" value="${new Date().toISOString().split('T')[0]}"/>
    </div>
    <div class="form-group">
      <label class="form-label">Indexatie percentage (%)</label>
      <input type="number" step="0.01" min="0" class="form-input" id="barema-idx-pct" placeholder="bv. 2.23" style="width:160px"/>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">bv. 2.23 = +2,23% verhoging</div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="confirmBaremaIndexation()" style="background:#0d9668">Toepassen</button>
    </div>
  `);
}

function confirmBaremaIndexation(){
  const dateInput=document.getElementById('barema-idx-date');
  const pctInput=document.getElementById('barema-idx-pct');
  if(!dateInput||!dateInput.value){showToast('Kies een datum','error');return;}
  if(!pctInput||!pctInput.value||parseFloat(pctInput.value)===0){showToast('Vul een percentage in','error');return;}
  const date=dateInput.value;
  const pct=parseFloat(pctInput.value);
  if(baremaData.some(b=>b.date===date)){showToast('Er bestaat al een periode met deze datum','error');return;}
  // Get latest rates
  const sorted=[...baremaData].sort((a,b)=>b.date.localeCompare(a.date));
  const rates={};
  if(sorted.length>0){
    const last=sorted[0].rates;
    BAREMA_CATEGORIES.forEach(c=>{rates[c.id]=Math.round((last[c.id]||0)*(1+pct/100)*100)/100;});
  }else{
    BAREMA_CATEGORIES.forEach(c=>{rates[c.id]=0;});
  }
  baremaData.push({id:uid(),date:date,rates:rates,indexed:true,indexPct:pct});
  autoSave();closeModal();renderBarema();
  showToast('Indexatie +'+pct+'% toegepast âœ…');
}

function openBulkIndexation(){
  // Get all arbeiders/interim with PC 149.01 and salaryHistory
  const eligible=people.filter(function(p){
    return !p.archived&&p.paritairComite==='149.01'&&p.salaryHistory&&p.salaryHistory.find(function(m){return m.type===SALARY_TYPE_START;});
  });
  if(eligible.length===0){showToast('Geen medewerkers met PC 149.01 en actief startloon gevonden','warn');return;}

  let html='<div class="form-row"><div class="form-group">'
    +'<label class="form-label">Ingangsdatum</label>'
    +'<input type="date" class="form-input" id="bulk-idx-date" value="'+new Date().toISOString().split('T')[0]+'"/>'
    +'</div><div class="form-group">'
    +'<label class="form-label">Indexatie percentage (%)</label>'
    +'<input type="number" step="0.01" min="0" class="form-input" id="bulk-idx-pct" placeholder="bv. 2.23" oninput="previewBulkIndexation()"/>'
    +'<div style="font-size:11px;color:var(--text3);margin-top:4px">Op huidig uurloon per medewerker</div>'
    +'</div></div>';
  html+='<div id="bulk-idx-preview" style="margin-top:16px"></div>';
  html+='<div class="modal-actions">'
    +'<button class="btn" onclick="closeModal()">Annuleren</button>'
    +'<button class="btn btn-primary" id="bulk-idx-confirm" onclick="confirmBulkIndexation()" disabled style="background:#0d9668">Toepassen op <span id="bulk-idx-count">0</span> medewerkers</button>'
    +'</div>';
  openModal('ğŸ“ˆ Indexatie toepassen â€” PC 149.01',html);
  previewBulkIndexation();
}

function previewBulkIndexation(){
  const pctInput=document.getElementById('bulk-idx-pct');
  const pct=pctInput?parseFloat(pctInput.value):0;
  const dateInput=document.getElementById('bulk-idx-date');
  const date=dateInput?dateInput.value:'';
  const preview=document.getElementById('bulk-idx-preview');
  const confirmBtn=document.getElementById('bulk-idx-confirm');
  if(!preview)return;

  const eligible=people.filter(function(p){
    return !p.archived&&p.paritairComite==='149.01'&&p.salaryHistory&&p.salaryHistory.find(function(m){return m.type===SALARY_TYPE_START;});
  });

  // Check for duplicates: skip if person already has index mutation on this date
  const toApply=eligible.filter(function(p){
    return !p.salaryHistory.some(function(m){return m.type==='index'&&m.date===date&&!m.deleted;});
  });

  let html='<table class="tbl" style="font-size:12px"><thead><tr>'
    +'<th style="text-align:left">Medewerker</th><th>Cat.</th><th>Dept.</th>'
    +'<th style="text-align:right">Huidig â‚¬/u</th>';
  if(pct>0)html+='<th style="text-align:right">Verhoging</th><th style="text-align:right">Nieuw â‚¬/u</th>';
  html+='<th>Status</th></tr></thead><tbody>';

  var applyCount=0;
  eligible.forEach(function(p){
    const sal=calcCurrentSalary(p);
    if(!sal)return;
    const dept=departments.find(function(d){return d.id===p.departmentId;});
    const alreadyHas=p.salaryHistory.some(function(m){return m.type==='index'&&m.date===date&&!m.deleted;});
    const raise=pct>0?Math.round(sal.current*pct)/100:0;
    const newRate=Math.round((sal.current+raise)*100)/100;
    const status=alreadyHas
      ?'<span style="color:var(--warn);font-weight:600">âš ï¸ Al geÃ¯ndexeerd op deze datum</span>'
      :'<span style="color:var(--success)">âœ… Toe te passen</span>';
    if(!alreadyHas)applyCount++;
    html+='<tr'+(alreadyHas?' style="opacity:.5"':'')+'>';
    html+='<td style="font-weight:600">'+fullName(p)+'</td>';
    html+='<td style="text-align:center"><span class="badge badge-blue">'+( p.baremaCategory||'â€”')+'</span></td>';
    html+='<td>'+(dept?dept.name:'â€”')+'</td>';
    html+='<td style="text-align:right;font-weight:600">â‚¬ '+sal.current.toFixed(2)+'</td>';
    if(pct>0){
      html+='<td style="text-align:right;color:var(--success);font-weight:600">+â‚¬ '+raise.toFixed(2)+'</td>';
      html+='<td style="text-align:right;font-weight:700;color:var(--accent)">â‚¬ '+newRate.toFixed(2)+'</td>';
    }
    html+='<td>'+status+'</td>';
    html+='</tr>';
  });
  html+='</tbody></table>';

  if(applyCount===0&&pct>0){
    html+='<div style="margin-top:12px;padding:10px;background:var(--warn-bg);border-radius:var(--radius-sm);font-size:12px;color:var(--warn)">âš ï¸ Alle medewerkers zijn al geÃ¯ndexeerd op deze datum.</div>';
  }

  preview.innerHTML=html;
  var countSpan=document.getElementById('bulk-idx-count');
  if(countSpan)countSpan.textContent=applyCount;
  if(confirmBtn){confirmBtn.disabled=!(pct>0&&date&&applyCount>0);}
}

async function confirmBulkIndexation(){
  const pct=parseFloat(document.getElementById('bulk-idx-pct').value);
  const date=document.getElementById('bulk-idx-date').value;
  if(!pct||!date)return;

  const eligible=people.filter(function(p){
    return !p.archived&&p.paritairComite==='149.01'&&p.salaryHistory&&p.salaryHistory.find(function(m){return m.type===SALARY_TYPE_START;});
  });
  const toApply=eligible.filter(function(p){
    return !p.salaryHistory.some(function(m){return m.type==='index'&&m.date===date&&!m.deleted;});
  });

  if(!await confirmDialog('Indexatie +'+pct+'% toepassen op '+toApply.length+' medewerkers per '+formatDate(date)+'?'))return;

  var count=0;
  toApply.forEach(function(p){
    const sal=calcCurrentSalary(p);
    if(!sal)return;
    const raise=Math.round(sal.current*pct)/100;
    const newRate=Math.round((sal.current+raise)*100)/100;
    p.salaryHistory.push({
      id:uid(),
      type:'index',
      amount:newRate,
      date:date,
      comment:'Indexatie +'+pct+'%',
      locked:true
    });
    count++;
  });

  closeModal();autoSave();
  showToast('Loonindexatie +'+pct+'% toegepast op '+count+' medewerkers âœ…');
}

// â•â•â• ANCIÃ‹NNITEIT â•â•â•

function renderAncienniteit(){
  const tbody=document.getElementById('ancienniteit-tbody');
  if(!tbody)return;
  tbody.innerHTML=ancienniteitData.map(a=>`<tr>
    <td><input type="number" step="0.01" min="0" value="${a.pct}"
      style="width:70px;text-align:center;border:1px solid var(--border);border-radius:var(--radius-sm);padding:4px 6px;font-size:13px;font-weight:600"
      onchange="updateAncienniteit('${a.id}',this.value)"/> %</td>
    <td><input type="text" value="${a.desc}" class="form-input" style="border:none;background:transparent;padding:4px 0;font-size:13px"
      onchange="updateAncienniteitDesc('${a.id}',this.value)"/></td>
  </tr>`).join('');
}

function updateAncienniteit(id,value){
  const a=ancienniteitData.find(x=>x.id===id);
  if(a){a.pct=parseFloat(value)||0;}
  autoSave();
}

function updateAncienniteitDesc(id,value){
  const a=ancienniteitData.find(x=>x.id===id);
  if(a){a.desc=value;}
  autoSave();
}

// â•â•â• INIT â•â•â•

// Keyboard shortcuts
document.addEventListener('keydown',e=>{
  if(e.key==='Escape')closeModal();
});

async function resetData(){
  if(!await confirmDialog('âš ï¸ Alle data resetten naar standaardwaarden?\n\nDit verwijdert al je wijzigingen.'))return;
  localStorage.removeItem('vb_departments');
  localStorage.removeItem('vb_people');
  localStorage.removeItem('vb_types');
  localStorage.removeItem('vb_schedules');
  localStorage.removeItem('vb_requests');
  localStorage.removeItem('vb_candidates');
  localStorage.removeItem('vb_channels');
  localStorage.removeItem('vb_settings');
  localStorage.removeItem('vb_barema');
  localStorage.removeItem('vb_ancienniteit');
  localStorage.removeItem('vb_salaryReasons');
  localStorage.removeItem('vb_werkgeverskost');
  localStorage.removeItem('vb_uurkostParams');
  localStorage.removeItem('vb_verlofregels');
  location.reload();
}

restore();

// Force fresh data load once (version flag prevents repeat resets)
const SEED_VERSION='v16.1';
if(localStorage.getItem('vb_seed_version')!==SEED_VERSION){
  localStorage.removeItem('vb_departments');
  localStorage.removeItem('vb_people');
  localStorage.removeItem('vb_types');
  localStorage.removeItem('vb_schedules');
  localStorage.removeItem('vb_requests');
  localStorage.removeItem('vb_candidates');
  localStorage.removeItem('vb_channels');
  localStorage.removeItem('vb_settings');
  localStorage.removeItem('vb_barema');
  localStorage.removeItem('vb_ancienniteit');
  localStorage.removeItem('vb_salaryReasons');
  localStorage.removeItem('vb_werkgeverskost');
  localStorage.removeItem('vb_uurkostParams');
  localStorage.removeItem('vb_verlofregels');
  localStorage.setItem('vb_seed_version',SEED_VERSION);
  departments=[];people=[];leaveTypes=[];schedules=[];requests=[];candidates=[];channels=[];baremaData=[];ancienniteitData=[];verlofregels=[];
}

// Seed demo data
if(departments.length===0&&people.length===0){
  departments=[
    {id:'dept-install',name:'Installatie',approverId:''},
    {id:'dept-service',name:'Service',approverId:''},
    {id:'dept-back',name:'Backoffice',approverId:''},
    {id:'dept-directie',name:'Directie',approverId:''},
    {id:'dept-verkoop',name:'Verkoop',approverId:''},
    {id:'dept-onderhoud',name:'Onderhoud',approverId:''}
  ];
  people=[
    // Bestaande demo medewerkers â€” VERWIJDERD (vervangen door echte data)
    // XLS medewerkers met volledige gegevens
    {id:'x1',firstName:'Enderson',lastName:'Molla',email:'enderson@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2020-03-15',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'D',gsm:'+32 467 70 90 49',tel:'',werkGsm:'',iban:'BE71 0000 1234 5678',birthDate:'1995-08-22',noodNaam:'Greet Lemmens',noodRelatie:'vriend(in)',noodGsm:'+32 467 70 90 49',allowanceAdjustments:[],
      salaryHistory:[{id:'s1a',type:'start',amount:18.50,date:'2020-03-15',comment:'Startloon cat. D',locked:true},{id:'s1b',type:'index',amount:0.55,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s1c',type:'index',amount:0.44,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x2',firstName:'Jarno',lastName:'Vranckx',email:'jarno@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2021-06-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'D',gsm:'+32 472 99 48 07',tel:'',werkGsm:'',iban:'BE42 3631 0954 7162',birthDate:'1998-03-14',noodNaam:'Els Vranckx',noodRelatie:'mama',noodGsm:'+32 478 55 12 30',allowanceAdjustments:[],
      salaryHistory:[{id:'s2a',type:'start',amount:17.80,date:'2021-06-01',comment:'Startloon cat. D',locked:true},{id:'s2b',type:'index',amount:0.55,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s2c',type:'index',amount:0.44,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x3',firstName:'Rens',lastName:'Deschryver',email:'rens@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2019-09-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'E',gsm:'+32 468 25 48 25',tel:'',werkGsm:'',iban:'BE68 5390 0754 7034',birthDate:'1992-11-07',noodNaam:'Martine Van Meerbeek',noodRelatie:'mama',noodGsm:'+32 486 86 97 82',allowanceAdjustments:[],
      salaryHistory:[{id:'s3a',type:'start',amount:19.85,date:'2019-09-01',comment:'Startloon cat. E',locked:true},{id:'s3b',type:'ancienniteit',amount:0.40,date:'2021-09-01',comment:'2 jaar anciÃ«nniteit',locked:false},{id:'s3c',type:'index',amount:0.60,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s3d',type:'index',amount:0.46,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x4',firstName:'Amber',lastName:'Van Meerbeek',email:'amber@advancedenergy.be',departmentId:'dept-back',role:'user',isApprover:false,startDate:'2023-02-01',scheduleId:'fulltime',statuut:'bediende',gsm:'+32 479 14 88 23',tel:'',werkGsm:'',iban:'BE15 0017 5469 3921',birthDate:'2000-05-30',noodNaam:'Indy Bombeke',noodRelatie:'partner',noodGsm:'+32 479 38 17 94',allowanceAdjustments:[{typeId:'wettelijk',days:20,reason:'Saldo aanpassing',date:'2026-01-01'}]},
    {id:'x5',firstName:'Bert',lastName:'Resseler',email:'bert@advancedenergy.be',departmentId:'dept-directie',role:'admin',isApprover:true,startDate:'2015-01-15',scheduleId:'fulltime',statuut:'zelfstandige',gsm:'+32 495 56 06 07',tel:'+32 16 15 24 24',werkGsm:'+32 495 56 06 07',iban:'BE62 5100 0754 7061',birthDate:'1970-09-18',noodNaam:'Katja Kestens',noodRelatie:'echtgeno(o)t(e)',noodGsm:'+32 496 57 74 26',allowanceAdjustments:[]},
    {id:'x6',firstName:'Cedric',lastName:'Bosteels',email:'cedric@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2022-01-10',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'C',gsm:'+32 491 20 07 09',tel:'',werkGsm:'',iban:'BE91 7340 2162 8049',birthDate:'1997-01-25',noodNaam:'Ann Van Dun',noodRelatie:'mama',noodGsm:'+32 472 81 42 88',allowanceAdjustments:[],
      salaryHistory:[{id:'s6a',type:'start',amount:17.20,date:'2022-01-10',comment:'Startloon cat. C',locked:true},{id:'s6b',type:'index',amount:0.50,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s6c',type:'correctie',amount:0.35,date:'2025-06-01',comment:'Correctie na evaluatie',locked:false},{id:'s6d',type:'index',amount:0.40,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x7',firstName:'Charly',lastName:'Vanderstappen',email:'charly@advancedenergy.be',departmentId:'dept-onderhoud',role:'user',isApprover:false,startDate:'2023-09-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'C',gsm:'+32 492 61 95 99',tel:'',werkGsm:'',iban:'BE47 0016 5924 7856',birthDate:'2001-06-12',noodNaam:'Nina Elskens',noodRelatie:'vriend(in)',noodGsm:'+32 497 50 24 26',allowanceAdjustments:[],
      salaryHistory:[{id:'s7a',type:'start',amount:17.50,date:'2023-09-01',comment:'Startloon cat. C',locked:true},{id:'s7b',type:'index',amount:0.50,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s7c',type:'index',amount:0.40,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x8',firstName:'Chris',lastName:'Vanroelen',email:'chris@advancedenergy.be',departmentId:'dept-verkoop',role:'user',isApprover:false,startDate:'2022-06-01',scheduleId:'fulltime',statuut:'bediende',gsm:'+32 473 95 96 38',tel:'',werkGsm:'+32 473 95 96 38',iban:'BE03 2200 5468 7712',birthDate:'1988-12-03',noodNaam:'Lies Peeters',noodRelatie:'echtgeno(o)t(e)',noodGsm:'+32 486 21 30 57',allowanceAdjustments:[]},
    {id:'x9',firstName:'Jarne',lastName:'Boudt',email:'jarne@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2021-11-15',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'D',gsm:'+32 465 66 42 68',tel:'',werkGsm:'',iban:'BE56 7370 3209 4815',birthDate:'1999-04-09',noodNaam:'Ulrika Coussement',noodRelatie:'partner',noodGsm:'+32 499 72 49 67',allowanceAdjustments:[],
      salaryHistory:[{id:'s9a',type:'start',amount:18.00,date:'2021-11-15',comment:'Startloon cat. D',locked:true},{id:'s9b',type:'ancienniteit',amount:0.20,date:'2023-11-15',comment:'2 jaar anciÃ«nniteit',locked:false},{id:'s9c',type:'index',amount:0.55,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s9d',type:'index',amount:0.44,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x10',firstName:'Kinza',lastName:'Janssens',email:'kinza@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2024-03-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'B',gsm:'+32 468 92 31 50',tel:'',werkGsm:'',iban:'BE29 3630 5184 7720',birthDate:'2002-10-17',noodNaam:'Assimina Grammenidis',noodRelatie:'mama',noodGsm:'+32 499 11 94 69',allowanceAdjustments:[],
      salaryHistory:[{id:'s10a',type:'start',amount:16.63,date:'2024-03-01',comment:'Startloon cat. B barema',locked:true},{id:'s10b',type:'index',amount:0.37,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x11',firstName:'Lander',lastName:'Resseler',email:'lander@advancedenergy.be',departmentId:'dept-directie',role:'admin',isApprover:true,startDate:'2017-03-01',scheduleId:'fulltime',statuut:'zelfstandige',gsm:'+32 491 50 98 32',tel:'',werkGsm:'+32 491 50 98 32',iban:'BE84 3200 6845 9030',birthDate:'1993-07-21',noodNaam:'Katja Kestens',noodRelatie:'mama',noodGsm:'+32 496 57 74 26',allowanceAdjustments:[]},
    {id:'x12',firstName:'Lukas',lastName:'Cornet',email:'lukas@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2018-04-15',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'E',gsm:'+32 490 40 67 78',tel:'',werkGsm:'',iban:'BE78 0014 7895 2134',birthDate:'1994-02-28',noodNaam:'Judit Kechtermans',noodRelatie:'mama',noodGsm:'+32 485 16 44 17',allowanceAdjustments:[],
      salaryHistory:[{id:'s12a',type:'start',amount:19.50,date:'2018-04-15',comment:'Startloon cat. E',locked:true},{id:'s12b',type:'ancienniteit',amount:0.35,date:'2020-04-15',comment:'2 jaar anciÃ«nniteit',locked:false},{id:'s12c',type:'ancienniteit',amount:0.25,date:'2022-04-15',comment:'4 jaar anciÃ«nniteit',locked:false},{id:'s12d',type:'index',amount:0.60,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s12e',type:'index',amount:0.46,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x13',firstName:'Luca',lastName:'Crocket',email:'luca@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2025-06-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'A',gsm:'+32 489 30 11 42',tel:'',werkGsm:'',iban:'BE55 0013 9028 5577',birthDate:'2003-09-05',noodNaam:'Nathalie Crocket',noodRelatie:'mama',noodGsm:'+32 476 90 12 55',allowanceAdjustments:[],archived:true,archivedDate:'2025-12-01',
      salaryHistory:[{id:'s13a',type:'start',amount:15.69,date:'2025-06-01',comment:'Startloon cat. A barema',locked:true}]},
    {id:'x14',firstName:'Mien',lastName:'Puttemans',email:'mien@advancedenergy.be',departmentId:'dept-back',role:'user',isApprover:false,startDate:'2021-09-01',scheduleId:'fulltime',statuut:'bediende',gsm:'+32 493 02 04 25',tel:'',werkGsm:'',iban:'BE10 7310 4598 0126',birthDate:'1996-12-11',noodNaam:'Jan Puttemans',noodRelatie:'papa',noodGsm:'+32 495 25 32 50',allowanceAdjustments:[]},
    {id:'x15',firstName:'Nick',lastName:'de Ridder',email:'nick@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2019-04-01',scheduleId:'fulltime',statuut:'zelfstandige',gsm:'+32 493 56 12 91',tel:'',werkGsm:'',iban:'BE67 0689 0514 8012',birthDate:'1990-03-29',noodNaam:'Jitske',noodRelatie:'vriend(in)',noodGsm:'+32 476 38 98 31',allowanceAdjustments:[]},
    {id:'x16',firstName:'Nicolas',lastName:'Voorspoels',email:'nicolas@advancedenergy.be',departmentId:'dept-verkoop',role:'user',isApprover:false,startDate:'2023-11-01',scheduleId:'fulltime',statuut:'bediende',gsm:'+32 476 44 89 05',tel:'',werkGsm:'',iban:'BE21 3751 0098 4465',birthDate:'1991-08-15',noodNaam:'Laura De Hondt',noodRelatie:'echtgeno(o)t(e)',noodGsm:'+32 499 30 78 38',allowanceAdjustments:[]},
    {id:'x17',firstName:'Pieter-Jan',lastName:'De Clercq',email:'pietjan@advancedenergy.be',departmentId:'dept-onderhoud',role:'user',isApprover:false,startDate:'2022-08-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'C',gsm:'+32 472 55 14 14',tel:'',werkGsm:'',iban:'BE39 0018 2076 3142',birthDate:'1997-11-02',noodNaam:'Jo de Clercq',noodRelatie:'papa',noodGsm:'+32 475 85 75 00',allowanceAdjustments:[],
      salaryHistory:[{id:'s17a',type:'start',amount:17.50,date:'2022-08-01',comment:'Startloon cat. C',locked:true},{id:'s17b',type:'index',amount:0.50,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s17c',type:'ancienniteit',amount:0.30,date:'2025-08-01',comment:'3 jaar anciÃ«nniteit',locked:false},{id:'s17d',type:'index',amount:0.40,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x18',firstName:'Robbe',lastName:'Resseler',email:'robbe@advancedenergy.be',departmentId:'dept-directie',role:'admin',isApprover:true,startDate:'2016-06-01',scheduleId:'fulltime',statuut:'zelfstandige',gsm:'+32 471 65 80 37',tel:'',werkGsm:'+32 471 65 80 37',iban:'BE85 3200 6845 9047',birthDate:'1991-04-14',noodNaam:'Katja Kestens',noodRelatie:'mama',noodGsm:'+32 496 57 74 26',allowanceAdjustments:[]},
    {id:'x19',firstName:'Wout',lastName:'Verbaenen',email:'wout@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2020-11-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'D',gsm:'+32 477 76 23 02',tel:'',werkGsm:'',iban:'BE44 2100 4185 6033',birthDate:'1996-07-04',noodNaam:'Sandra',noodRelatie:'andere',noodGsm:'+32 494 24 14 72',allowanceAdjustments:[],
      salaryHistory:[{id:'s19a',type:'start',amount:18.20,date:'2020-11-01',comment:'Startloon cat. D',locked:true},{id:'s19b',type:'ancienniteit',amount:0.30,date:'2022-11-01',comment:'2 jaar anciÃ«nniteit',locked:false},{id:'s19c',type:'index',amount:0.55,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s19d',type:'index',amount:0.44,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x20',firstName:'Stef',lastName:'Aerts',email:'stef@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2026-04-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'C',gsm:'+32 485 33 20 17',tel:'',werkGsm:'',iban:'BE23 7340 5512 0098',birthDate:'1999-02-10',noodNaam:'Karolien Aerts',noodRelatie:'mama',noodGsm:'+32 478 60 11 34',allowanceAdjustments:[],
      salaryHistory:[{id:'s20a',type:'start',amount:18.45,date:'2026-04-01',comment:'Startloon cat. C barema 2026',locked:true}]}
  ];
  departments[0].approverId='x5';  // Installatie -> Bert Resseler
  departments[1].approverId='x5';  // Service -> Bert Resseler
  departments[2].approverId='x14'; // Backoffice -> Mien Puttemans
  departments[3].approverId='x5';  // Directie -> Bert Resseler
  departments[4].approverId='x8';  // Verkoop -> Chris Vanroelen
  departments[5].approverId='x17'; // Onderhoud -> Pieter-Jan De Clercq
  
  const today=new Date();
  const todayStr=today.toISOString().split('T')[0];
  const tomorrow=new Date(today);tomorrow.setDate(today.getDate()+1);
  const nextWeek=new Date(today);nextWeek.setDate(today.getDate()+5);
  const nextWeekStr=nextWeek.toISOString().split('T')[0];
  const lastWeek=new Date(today);lastWeek.setDate(today.getDate()-5);
  const lastWeekStr=lastWeek.toISOString().split('T')[0];
  const lastWeekEnd=new Date(today);lastWeekEnd.setDate(today.getDate()-3);
  const lastWeekEndStr=lastWeekEnd.toISOString().split('T')[0];
  const twoWeeks=new Date(today);twoWeeks.setDate(today.getDate()+12);
  const twoWeeksStr=twoWeeks.toISOString().split('T')[0];
  const twoWeeksEnd=new Date(today);twoWeeksEnd.setDate(today.getDate()+16);
  const twoWeeksEndStr=twoWeeksEnd.toISOString().split('T')[0];
  const threeWeeks=new Date(today);threeWeeks.setDate(today.getDate()+20);
  const threeWeeksStr=threeWeeks.toISOString().split('T')[0];
  const threeWeeksEnd=new Date(today);threeWeeksEnd.setDate(today.getDate()+21);
  const threeWeeksEndStr=threeWeeksEnd.toISOString().split('T')[0];
  const jan6='2026-01-06',jan9='2026-01-09';
  const jan19='2026-01-19',jan20='2026-01-20';
  const feb2='2026-02-02',feb6='2026-02-06';

  requests=[
    // Goedgekeurd - vandaag afwezig
    {id:'r1',personId:'x9',type:'wettelijk',startDate:todayStr,endDate:tomorrow.toISOString().split('T')[0],days:2,halfDay:false,status:'approved',comment:'Gezinsuitstap'},
    {id:'r2',personId:'x12',type:'ziekte',startDate:todayStr,endDate:tomorrow.toISOString().split('T')[0],days:2,halfDay:false,status:'approved',comment:'Griep'},
    {id:'r3',personId:'x7',type:'wettelijk',startDate:todayStr,endDate:todayStr,days:1,halfDay:true,halfDayPeriod:'VM',status:'approved',comment:'Doktersbezoek'},
    // Goedgekeurd - afgelopen week
    {id:'r4',personId:'x5',type:'wettelijk',startDate:lastWeekStr,endDate:lastWeekEndStr,days:3,halfDay:false,status:'approved',comment:'Familiebezoek'},
    {id:'r5',personId:'x6',type:'adv',startDate:lastWeekStr,endDate:lastWeekStr,days:1,halfDay:false,status:'approved',comment:''},
    {id:'r6',personId:'x14',type:'wettelijk',startDate:lastWeekStr,endDate:lastWeekEndStr,days:3,halfDay:false,status:'approved',comment:'Verhuizing'},
    // Goedgekeurd - komende week
    {id:'r7',personId:'x19',type:'wettelijk',startDate:nextWeekStr,endDate:nextWeekStr,days:1,halfDay:false,status:'approved',comment:''},
    {id:'r8',personId:'x17',type:'adv',startDate:nextWeekStr,endDate:nextWeekStr,days:1,halfDay:false,status:'approved',comment:''},
    // Goedgekeurd - over 2 weken
    {id:'r9',personId:'x1',type:'wettelijk',startDate:twoWeeksStr,endDate:twoWeeksEndStr,days:5,halfDay:false,status:'approved',comment:'Vakantie'},
    {id:'r10',personId:'x3',type:'wettelijk',startDate:twoWeeksStr,endDate:twoWeeksStr,days:1,halfDay:false,status:'approved',comment:''},
    // Openstaand (pending) - te beoordelen
    {id:'r11',personId:'x2',type:'wettelijk',startDate:threeWeeksStr,endDate:threeWeeksEndStr,days:2,halfDay:false,status:'pending',comment:'Weekendje weg'},
    {id:'r12',personId:'x10',type:'wettelijk',startDate:twoWeeksStr,endDate:twoWeeksEndStr,days:5,halfDay:false,status:'pending',comment:'Skivakantie'},
    {id:'r13',personId:'x8',type:'adv',startDate:nextWeekStr,endDate:nextWeekStr,days:1,halfDay:false,status:'pending',comment:''},
    {id:'r14',personId:'x16',type:'wettelijk',startDate:threeWeeksStr,endDate:threeWeeksStr,days:1,halfDay:false,status:'pending',comment:'Huwelijksfeest'},
    // Geweigerd
    {id:'r15',personId:'x15',type:'wettelijk',startDate:nextWeekStr,endDate:nextWeekStr,days:1,halfDay:false,status:'rejected',rejectReason:'Te veel collega\'s afwezig die dag',comment:''},
    // Eerdere ziekte
    {id:'r16',personId:'x6',type:'ziekte',startDate:jan6,endDate:jan9,days:4,halfDay:false,status:'approved',comment:'Covid'},
    {id:'r17',personId:'x19',type:'ziekte',startDate:jan19,endDate:jan20,days:2,halfDay:false,status:'approved',comment:'Buikgriep'},
    // Eerder verlof (jan/feb) voor rapportage
    {id:'r18',personId:'x5',type:'wettelijk',startDate:jan6,endDate:jan9,days:4,halfDay:false,status:'approved',comment:''},
    {id:'r19',personId:'x11',type:'wettelijk',startDate:feb2,endDate:feb6,days:5,halfDay:false,status:'approved',comment:'Krokusvakantie'},
    {id:'r20',personId:'x18',type:'wettelijk',startDate:feb2,endDate:feb6,days:5,halfDay:false,status:'approved',comment:'Krokusvakantie'},
    {id:'r21',personId:'x4',type:'adv',startDate:jan6,endDate:jan6,days:1,halfDay:false,status:'approved',comment:''},
    // Extern (tech werkloosheid)
    {id:'r22',personId:'x1',type:'tech-werkloos',startDate:jan19,endDate:jan20,days:2,halfDay:false,status:'approved',comment:'Geen werk beschikbaar'},
    {id:'r23',personId:'x2',type:'tech-werkloos',startDate:jan19,endDate:jan20,days:2,halfDay:false,status:'approved',comment:'Geen werk beschikbaar'},
    // Klein verlet
    {id:'r24',personId:'x17',type:'verhuizing',startDate:'2025-10-15',endDate:'2025-10-15',days:1,halfDay:false,status:'approved',comment:'Verhuis naar Mechelen'},
    {id:'r25',personId:'x9',type:'geboorte',startDate:'2025-09-08',endDate:'2025-10-03',days:20,halfDay:false,status:'approved',comment:'Geboorte dochter'},
    {id:'r26',personId:'x12',type:'communie',startDate:'2025-05-10',endDate:'2025-05-10',days:1,halfDay:false,status:'approved',comment:'Communie neefje'},
    {id:'r27',personId:'x6',type:'arbeidsongeval',startDate:'2025-07-14',endDate:'2025-07-25',days:10,halfDay:false,status:'approved',comment:'Val van ladder op werf'},
    // Weerverlet
    {id:'r28',personId:'x1',type:'weerverlet',startDate:'2025-12-22',endDate:'2025-12-23',days:2,halfDay:false,status:'approved',comment:'Sneeuwval - werf ontoegankelijk'},
    {id:'r29',personId:'x3',type:'weerverlet',startDate:'2025-12-22',endDate:'2025-12-23',days:2,halfDay:false,status:'approved',comment:'Sneeuwval - werf ontoegankelijk'},
    {id:'r30',personId:'x19',type:'opleiding',startDate:'2025-11-17',endDate:'2025-11-18',days:2,halfDay:false,status:'approved',comment:'HVAC opleiding Daikin'},
    {id:'r31',personId:'x7',type:'opleiding',startDate:'2025-11-17',endDate:'2025-11-18',days:2,halfDay:false,status:'approved',comment:'HVAC opleiding Daikin'},
    // Nieuwe types in gebruik
    {id:'r32',personId:'x14',type:'dokter',startDate:nextWeekStr,endDate:nextWeekStr,days:1,halfDay:true,halfDayPeriod:'VM',status:'approved',comment:'Tandarts'},
    {id:'r33',personId:'x12',type:'familiaal',startDate:lastWeekStr,endDate:lastWeekStr,days:1,halfDay:false,status:'approved',comment:'Ziek kind ophalen crÃ¨che'},
    {id:'r34',personId:'x3',type:'ancienniteit',startDate:threeWeeksStr,endDate:threeWeeksStr,days:1,halfDay:false,status:'pending',comment:''},
    {id:'r35',personId:'x6',type:'hospitalisatie',startDate:'2025-08-04',endDate:'2025-08-08',days:5,halfDay:false,status:'approved',comment:'Knie-operatie na arbeidsongeval'},
    {id:'r36',personId:'x10',type:'dokter',startDate:twoWeeksStr,endDate:twoWeeksStr,days:1,halfDay:true,halfDayPeriod:'NM',status:'pending',comment:'Controle huisarts'},
    {id:'r37',personId:'x8',type:'juridisch',startDate:'2025-06-20',endDate:'2025-06-20',days:1,halfDay:false,status:'approved',comment:'Oproep vredegerecht'}
  ];
  autoSave();
}

// Seed barema data
if(baremaData.length===0){
  baremaData=[
    {id:'bar1',date:'2025-01-01',rates:{A:15.69,B:16.63,C:18.05,D:19.61,E:20.71,F:21.97}},
    {id:'bar2',date:'2026-01-01',rates:{A:16.04,B:17.00,C:18.45,D:20.05,E:21.17,F:22.46}}
  ];
  autoSave();
}

// Seed anciÃ«nniteit data
if(ancienniteitData.length===0){
  ancienniteitData=[
    {id:'anc1',pct:1,desc:'na 1 jaar dienst'},
    {id:'anc2',pct:0.50,desc:'per extra jaar dienst'},
    {id:'anc3',pct:13,desc:'maximale anciÃ«nniteit'}
  ];
  autoSave();
}

// â•â•â• SHELL INTEGRATIE â•â•â•

const shellPermissions={canCreate:true,canEdit:true,canDelete:true,role:'admin'};
const isInIframe=window.self!==window.top;

function detectShell(){
  if(isInIframe){
    const sb=document.querySelector('.sidebar');if(sb)sb.style.display='none';
    const rb=document.querySelector('.role-bar');if(rb)rb.style.display='none';
    const main=document.querySelector('.main');if(main){main.style.marginLeft='0';main.style.paddingTop='0';}
  }
}

window.addEventListener('message',e=>{
  if(e.data&&e.data.type==='shell:permissions'){
    shellPermissions.canCreate=!!e.data.canCreate;
    shellPermissions.canEdit=!!e.data.canEdit;
    shellPermissions.canDelete=!!e.data.canDelete;
    shellPermissions.role=e.data.role||'gebruiker';
    if(e.data.allowedSections)shellPermissions.allowedSections=e.data.allowedSections;
    applyPermissions();
  }
});

function applyPermissions(){
  if(isInIframe&&shellPermissions.allowedSections){
    document.querySelectorAll('.sb-item[data-page]').forEach(el=>{
      const page=el.getAttribute('data-page');
      el.style.display=shellPermissions.allowedSections.includes(page)?'':'none';
    });
    // Check of huidige pagina nog toegankelijk is
    const page=document.querySelector('.panel.active');
    if(page){
      const id=page.id.replace('page-','');
      if(shellPermissions.allowedSections.indexOf(id)===-1&&id!=='dashboard'){
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById('page-dashboard').classList.add('active');
        renderDashboard();return;
      }
    }
  }
  const page=document.querySelector('.panel.active');
  if(page){
    const id=page.id.replace('page-','');
    if(id==='dashboard')renderDashboard();
    if(id==='people')renderPeople();
    if(id==='departments')renderDepartments();
  }
}

function canCreate(){return shellPermissions.canCreate;}
function canEdit(){return shellPermissions.canEdit;}
function canDelete(){return shellPermissions.canDelete;}
function isAdmin(){return shellPermissions.role==='admin';}

detectShell();
renderDashboard();
</script>
</body>
</html>
