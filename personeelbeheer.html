<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Personeelbeheer â€” Advanced Energy</title>
<style>
/* â•â•â• CSS STYLES â•â•â• */
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');

:root{
  --bg:#f0f4ff;--surface:#fff;--surface2:#f8faff;--surface3:#eef2fb;
  --text:#2d2d2d;--text2:#5a6377;--text3:#6b7280;
  --border:#e2e8f4;--border-hover:#c5cfe0;
  --accent:#3b82f6;--accent-bg:rgba(59,130,246,.08);--accent-border:rgba(59,130,246,.25);
  --success:#38d9a9;--success-bg:rgba(56,217,169,.1);
  --danger:#ff5c5c;--danger-bg:rgba(255,92,92,.08);--danger-border:rgba(255,92,92,.2);
  --warn:#f59e0b;--warn-bg:rgba(245,158,11,.08);
  --radius:14px;--radius-sm:8px;--radius-xs:6px;
  --shadow:0 2px 8px rgba(0,0,0,.06);--shadow-lg:0 8px 24px rgba(0,0,0,.1);
  --sidebar-w:240px;
  /* Verloftype kleuren */
  --clr-wettelijk:#3b82f6;--clr-adv:#22c55e;
  --clr-ziekte:#ef4444;--clr-onbetaald:#94a3b8;--clr-opleiding:#a855f7;
}

*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;}
button{font-family:inherit;cursor:pointer;}
input,select,textarea{font-family:inherit;font-size:13px;}

/* Sidebar */
.sidebar{width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:250;}
.sb-header{padding:20px;border-bottom:1px solid var(--border);}
.sb-logo{display:flex;align-items:center;gap:10px;}
.sb-logo-icon{width:36px;height:36px;border-radius:50%;overflow:hidden;flex-shrink:0;}
.sb-logo-icon img{width:100%;height:100%;object-fit:contain;}
.sb-logo-text{font-weight:700;font-size:15px;line-height:1.2;}
.sb-logo-sub{font-size:11px;color:var(--text3);font-weight:400;}
.sb-nav{flex:1;padding:12px 10px;overflow-y:auto;}
.sb-section{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;
  color:var(--text3);padding:12px 10px 6px;}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);
  color:var(--text2);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;border:none;
  background:none;width:100%;text-align:left;}
.sb-item:hover{background:var(--surface2);color:var(--text);}
.sb-item.active{background:var(--accent-bg);color:var(--accent);font-weight:600;}
.sb-item-icon{font-size:16px;width:22px;text-align:center;}
.sb-item-badge{margin-left:auto;background:var(--danger);color:#fff;font-size:10px;font-weight:700;
  padding:2px 7px;border-radius:10px;min-width:20px;text-align:center;}
.sb-footer{padding:12px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text3);}

/* Role switcher */
.role-bar{position:fixed;top:0;left:var(--sidebar-w);right:0;height:44px;background:var(--surface);
  border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;z-index:90;gap:12px;}
.role-bar-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:1px;}
.role-btn{padding:5px 14px;border-radius:20px;border:1px solid var(--border);background:var(--surface);
  font-size:12px;font-weight:600;color:var(--text2);transition:all .15s;}
.role-btn:hover{border-color:var(--accent);color:var(--accent);}
.role-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}
.role-bar-right{margin-left:auto;display:flex;align-items:center;gap:12px;}
.env-badge{background:#3b82f6;color:#fff;font-size:10px;font-weight:700;padding:3px 10px;
  border-radius:10px;letter-spacing:1px;text-transform:uppercase;}

/* Main content */
.main{margin-left:var(--sidebar-w);padding-top:44px;flex:1;min-height:100vh;}
.page{max-width:1100px;margin:0 auto;padding:28px 32px;}
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;}
.page-title{font-size:22px;font-weight:700;}
.page-subtitle{font-size:13px;color:var(--text3);margin-top:2px;}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:20px;box-shadow:var(--shadow);transition:all .15s;}
.card-title{font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.card-grid{display:grid;gap:16px;}
.card-grid-2{grid-template-columns:1fr 1fr;}
.card-grid-3{grid-template-columns:1fr 1fr 1fr;}
.card-grid-4{grid-template-columns:1fr 1fr 1fr 1fr;}

/* Stats */
.stat{text-align:center;padding:16px;}
.stat-value{font-size:28px;font-weight:700;line-height:1;}
.stat-label{font-size:11px;color:var(--text3);margin-top:4px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;}

/* Tables */
.tbl{width:100%;border-collapse:collapse;font-size:13px;}
.tbl th{text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;
  color:var(--text3);padding:10px 12px;border-bottom:2px solid var(--border);}
.tbl td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
.tbl tr:hover td{background:var(--surface2);}
.tbl tr:last-child td{border-bottom:none;}

/* Badges */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:12px;
  font-size:11px;font-weight:600;white-space:nowrap;}
.badge-blue{background:rgba(59,130,246,.1);color:#3b82f6;}
.badge-green{background:rgba(34,197,94,.1);color:#22c55e;}
.badge-yellow{background:rgba(234,179,8,.1);color:#b45309;}
.badge-orange{background:rgba(249,115,22,.1);color:#c2410c;}
.badge-red{background:rgba(239,68,68,.1);color:#ef4444;}
.badge-gray{background:rgba(148,163,184,.1);color:#64748b;}
.badge-purple{background:rgba(168,85,247,.1);color:#a855f7;}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);
  font-size:13px;font-weight:600;border:1px solid var(--border);background:var(--surface);
  color:var(--text);transition:all .15s;}
.btn:hover{border-color:var(--border-hover);background:var(--surface2);}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent);}
.btn-primary:hover{background:#2563eb;border-color:#2563eb;}
.btn-primary-outline{background:rgba(59,130,246,.08);color:var(--accent);border-color:rgba(59,130,246,.35);}
.btn-primary-outline:hover{background:rgba(59,130,246,.15);border-color:var(--accent);}
.btn-danger{background:var(--danger-bg);color:var(--danger);border-color:var(--danger-border);}
.btn-danger:hover{background:rgba(255,92,92,.15);}
.btn-sm{padding:5px 12px;font-size:12px;}
.btn-icon{width:32px;height:32px;padding:0;display:inline-flex;align-items:center;justify-content:center;}

/* Forms */
.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;}
.fi{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:var(--accent-bg);color:var(--accent);font-size:10px;font-weight:700;cursor:pointer;vertical-align:middle;margin-left:2px;transition:all .15s;user-select:none;font-style:normal}
.fi:hover{background:var(--accent);color:#fff}
.fi-box{margin-top:6px;padding:8px 10px;background:var(--accent-bg);border-left:3px solid var(--accent);border-radius:0 var(--radius-xs) var(--radius-xs) 0;font-size:11px;color:var(--text2);line-height:1.5;font-weight:400}
.form-label .req{color:var(--danger);}
.form-input{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);
  background:#fff;color:#000;font-size:13px;transition:border-color .15s;}
.form-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.1);}
.form-row{display:flex;gap:16px;}
.form-row>*{flex:1;}
select.form-input{cursor:pointer;}

/* Modal */
.modal-overlay{position:fixed;top:0;left:var(--sidebar-w);right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;display:none;
  align-items:stretch;justify-content:stretch;backdrop-filter:blur(2px);}
.modal-overlay.show{display:flex;}
.modal{background:var(--surface);border-radius:0;width:100%;max-width:none;
  max-height:none;overflow-y:auto;box-shadow:var(--shadow-lg);padding:24px 32px;margin:0;
  display:flex;flex-direction:column;}
.modal.modal-wide{max-width:none;}
.modal-title{font-size:18px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;
  justify-content:space-between;flex-shrink:0;}
.modal-close{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--surface);
  display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;color:var(--text3);}
.modal-close:hover{background:var(--surface2);color:var(--text);}
.modal-body{flex:1;overflow-y:auto;min-height:0;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;padding-top:16px;
  border-top:1px solid var(--border);flex-shrink:0;}


/* Utility classes (C2) */
.flex-between{display:flex;justify-content:space-between;align-items:center;}
.flex-between.mb4{margin-bottom:4px;}
.flex-between.mb6{margin-bottom:6px;}
.flex-between.mb8{margin-bottom:8px;}
.flex-between.mb10{margin-bottom:10px;}
.summary-label{font-size:12px;color:var(--text3);}
.summary-val{font-weight:600;}
.summary-val-lg{font-weight:700;font-size:16px;}
.summary-val-accent{font-weight:700;font-size:16px;color:var(--accent);}
.summary-val-danger{font-weight:700;color:var(--danger);}
.section-title{font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:12px;}
.formula-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;font-size:11px;color:var(--text3);line-height:1.6;}
.modal-top-actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:var(--radius-sm);
  font-size:13px;font-weight:600;box-shadow:var(--shadow-lg);z-index:300;transform:translateY(80px);
  opacity:0;transition:all .3s ease;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast-success{background:#065f46;color:#fff;}
.toast-error{background:#991b1b;color:#fff;}
.toast-warn{background:#92400e;color:#fff;}

/* Color dots */
.clr-dot{width:10px;height:10px;border-radius:50%;display:inline-block;flex-shrink:0;}

/* Tag/chip */
.chip{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:12px;
  font-size:11px;font-weight:600;border:1px solid var(--border);background:var(--surface2);}

/* Tabs */
.tabs{display:flex;gap:4px;border-bottom:2px solid var(--border);margin-bottom:20px;}
.tab{padding:10px 16px;font-size:13px;font-weight:600;color:var(--text3);cursor:pointer;
  border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}

/* Hide/show panels */
.panel{display:none;}
.panel.active{display:block;}

/* Avatar */
.avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:700;color:#fff;flex-shrink:0;}

/* Search */
.search-box{position:relative;}
.search-box input{padding-left:34px;}
.search-box::before{content:'ğŸ”';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;}

/* Saldo bar */
/* Utility classes */
</style>
</head>
<body>

<!-- â•â•â• HTML STRUCTURE â•â•â• -->

<!-- Sidebar -->
<nav class="sidebar" aria-label="Hoofdmenu">
  <div class="sb-header">
    <div class="sb-logo" onclick="showPage('dashboard')" style="cursor:pointer">
      <div class="sb-logo-icon"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAKMWlDQ1BJQ0MgUHJvZmlsZQAAeJydlndUU9kWh8+9N71QkhCKlNBraFICSA29SJEuKjEJEErAkAAiNkRUcERRkaYIMijggKNDkbEiioUBUbHrBBlE1HFwFBuWSWStGd+8ee/Nm98f935rn73P3Wfvfda6AJD8gwXCTFgJgAyhWBTh58WIjYtnYAcBDPAAA2wA4HCzs0IW+EYCmQJ82IxsmRP4F726DiD5+yrTP4zBAP+flLlZIjEAUJiM5/L42VwZF8k4PVecJbdPyZi2NE3OMErOIlmCMlaTc/IsW3z2mWUPOfMyhDwZy3PO4mXw5Nwn4405Er6MkWAZF+cI+LkyviZjg3RJhkDGb+SxGXxONgAoktwu5nNTZGwtY5IoMoIt43kA4EjJX/DSL1jMzxPLD8XOzFouEiSniBkmXFOGjZMTi+HPz03ni8XMMA43jSPiMdiZGVkc4XIAZs/8WRR5bRmyIjvYODk4MG0tbb4o1H9d/JuS93aWXoR/7hlEH/jD9ld+mQ0AsKZltdn6h21pFQBd6wFQu/2HzWAvAIqyvnUOfXEeunxeUsTiLGcrq9zcXEsBn2spL+jv+p8Of0NffM9Svt3v5WF485M4knQxQ143bmZ6pkTEyM7icPkM5p+H+B8H/nUeFhH8JL6IL5RFRMumTCBMlrVbyBOIBZlChkD4n5r4D8P+pNm5lona+BHQllgCpSEaQH4eACgqESAJe2Qr0O99C8ZHA/nNi9GZmJ37z4L+fVe4TP7IFiR/jmNHRDK4ElHO7Jr8WgI0IABFQAPqQBvoAxPABLbAEbgAD+ADAkEoiARxYDHgghSQAUQgFxSAtaAYlIKtYCeoBnWgETSDNnAYdIFj4DQ4By6By2AE3AFSMA6egCnwCsxAEISFyBAVUod0IEPIHLKFWJAb5AMFQxFQHJQIJUNCSAIVQOugUqgcqobqoWboW+godBq6AA1Dt6BRaBL6FXoHIzAJpsFasBFsBbNgTzgIjoQXwcnwMjgfLoK3wJVwA3wQ7oRPw5fgEVgKP4GnEYAQETqiizARFsJGQpF4JAkRIauQEqQCaUDakB6kH7mKSJGnyFsUBkVFMVBMlAvKHxWF4qKWoVahNqOqUQdQnag+1FXUKGoK9RFNRmuizdHO6AB0LDoZnYsuRlegm9Ad6LPoEfQ4+hUGg6FjjDGOGH9MHCYVswKzGbMb0445hRnGjGGmsVisOtYc64oNxXKwYmwxtgp7EHsSewU7jn2DI+J0cLY4X1w8TogrxFXgWnAncFdwE7gZvBLeEO+MD8Xz8MvxZfhGfA9+CD+OnyEoE4wJroRIQiphLaGS0EY4S7hLeEEkEvWITsRwooC4hlhJPEQ8TxwlviVRSGYkNimBJCFtIe0nnSLdIr0gk8lGZA9yPFlM3kJuJp8h3ye/UaAqWCoEKPAUVivUKHQqXFF4pohXNFT0VFysmK9YoXhEcUjxqRJeyUiJrcRRWqVUo3RU6YbStDJV2UY5VDlDebNyi/IF5UcULMWI4kPhUYoo+yhnKGNUhKpPZVO51HXURupZ6jgNQzOmBdBSaaW0b2iDtCkVioqdSrRKnkqNynEVKR2hG9ED6On0Mvph+nX6O1UtVU9Vvuom1TbVK6qv1eaoeajx1UrU2tVG1N6pM9R91NPUt6l3qd/TQGmYaYRr5Grs0Tir8XQObY7LHO6ckjmH59zWhDXNNCM0V2ju0xzQnNbS1vLTytKq0jqj9VSbru2hnaq9Q/uE9qQOVcdNR6CzQ+ekzmOGCsOTkc6oZPQxpnQ1df11Jbr1uoO6M3rGelF6hXrtevf0Cfos/ST9Hfq9+lMGOgYhBgUGrQa3DfGGLMMUw12G/YavjYyNYow2GHUZPTJWMw4wzjduNb5rQjZxN1lm0mByzRRjyjJNM91tetkMNrM3SzGrMRsyh80dzAXmu82HLdAWThZCiwaLG0wS05OZw2xljlrSLYMtCy27LJ9ZGVjFW22z6rf6aG1vnW7daH3HhmITaFNo02Pzq62ZLde2xvbaXPJc37mr53bPfW5nbse322N3055qH2K/wb7X/oODo4PIoc1h0tHAMdGx1vEGi8YKY21mnXdCO3k5rXY65vTW2cFZ7HzY+RcXpkuaS4vLo3nG8/jzGueNueq5clzrXaVuDLdEt71uUnddd457g/sDD30PnkeTx4SnqWeq50HPZ17WXiKvDq/XbGf2SvYpb8Tbz7vEe9CH4hPlU+1z31fPN9m31XfKz95vhd8pf7R/kP82/xsBWgHcgOaAqUDHwJWBfUGkoAVB1UEPgs2CRcE9IXBIYMj2kLvzDecL53eFgtCA0O2h98KMw5aFfR+OCQ8Lrwl/GGETURDRv4C6YMmClgWvIr0iyyLvRJlESaJ6oxWjE6Kbo1/HeMeUx0hjrWJXxl6K04gTxHXHY+Oj45vipxf6LNy5cDzBPqE44foi40V5iy4s1licvvj4EsUlnCVHEtGJMYktie85oZwGzvTSgKW1S6e4bO4u7hOeB28Hb5Lvyi/nTyS5JpUnPUp2Td6ePJninlKR8lTAFlQLnqf6p9alvk4LTduf9ik9Jr09A5eRmHFUSBGmCfsytTPzMoezzLOKs6TLnJftXDYlChI1ZUPZi7K7xTTZz9SAxESyXjKa45ZTk/MmNzr3SJ5ynjBvYLnZ8k3LJ/J9879egVrBXdFboFuwtmB0pefK+lXQqqWrelfrry5aPb7Gb82BtYS1aWt/KLQuLC98uS5mXU+RVtGaorH1futbixWKRcU3NrhsqNuI2ijYOLhp7qaqTR9LeCUXS61LK0rfb+ZuvviVzVeVX33akrRlsMyhbM9WzFbh1uvb3LcdKFcuzy8f2x6yvXMHY0fJjpc7l+y8UGFXUbeLsEuyS1oZXNldZVC1tep9dUr1SI1XTXutZu2m2te7ebuv7PHY01anVVda926vYO/Ner/6zgajhop9mH05+x42Rjf2f836urlJo6m06cN+4X7pgYgDfc2Ozc0tmi1lrXCrpHXyYMLBy994f9Pdxmyrb6e3lx4ChySHHn+b+O31w0GHe4+wjrR9Z/hdbQe1o6QT6lzeOdWV0iXtjusePhp4tLfHpafje8vv9x/TPVZzXOV42QnCiaITn07mn5w+lXXq6enk02O9S3rvnIk9c60vvG/wbNDZ8+d8z53p9+w/ed71/LELzheOXmRd7LrkcKlzwH6g4wf7HzoGHQY7hxyHui87Xe4Znjd84or7ldNXva+euxZw7dLI/JHh61HXb95IuCG9ybv56Fb6ree3c27P3FlzF3235J7SvYr7mvcbfjT9sV3qID0+6j068GDBgztj3LEnP2X/9H686CH5YcWEzkTzI9tHxyZ9Jy8/Xvh4/EnWk5mnxT8r/1z7zOTZd794/DIwFTs1/lz0/NOvm1+ov9j/0u5l73TY9P1XGa9mXpe8UX9z4C3rbf+7mHcTM7nvse8rP5h+6PkY9PHup4xPn34D94Tz+6TMXDkAABHzSURBVHja3Vt5eBXV2f/NmZm7L9lXQwIk7HuACAkEpIAoRfBpXb4PQZGKS62t0Nrn8euq1lZrWz+LVRsoi4ogVhG1DcqakAQCJIEgYQlL9tzce5N779xl7syc8/1xA5IaloSg8L3PM8+de5Z35v2dM+e87++cw+E6S41TeryiyfNyRbPXVNPmQ31HEC6/DH9YRVjRQBiDQACzyCPGKCLNbsSQeCvGpkZhXFr0iiGJ9leu5/tx10NpcV37mk9Pti3efdaNEy4JHUEF0CgIBxAAhDFwABilIIyBMQbGKDTKQFUKjVJw0GDXixgUZ8W0zATMHZH6SV5m4ndvWAAcfnnSO9UtJe9UN6OqxQdF1aDjCQQwhDUKVdEASgEAIsdBx3MgYCCMQdUowqoGRdUALVKGJxQiR6BoGjRZBc8TjE6NwsIJ/fHfOQNnJNqMO24IAJyBcPbKQ40HVlU2oq4jAIPIQ+QAv6yCagwxBh5ZMSaMSrBiWLwF/aONZxIt+p12vVCj40k7AIRVGuORlWGt3tCsMy4p+WiLB4cb3Tjh8KJDCoEDB5PIR0AKyUiNsWBpbhaenDF8cpzFUPqtAVBQ1cxeKD2HM+4gbHoOlFJIsopYg4j8flH4blY8pqRHP5gZY17bG/2n2nzLik61vrH1SAN2Hm9Buy8Ig56AgENACiE93opn7xyDR/KHct8oACfbA4t+tL127b9qXbDoePAM8ARlZEUbsXhUMu4fnrRwYLTpnb78VmvbvMveLT/zxpqSE6ht9sBsFEA1hqBfxuxRafjfhbk/G5wU9fJ1B+C9mrZzT+6o7ecOhBFtEOD0h5Fm0eGp8alYkZPOXe9ZpSMgj/p70fGqP39ejSaXhCiLHh2+IGJMOqxcNAX335rFXTcAfllSx35bVg+bSMAoRSCs4uGRSfhVbvqsVKvhc3yD0tjun/+rLQc/LNhTA6NIwAEI+EN4dv54vPC9W7k+B2DpF7WsoKoF8WYR7kAYKSYRr80YWDk/K24svkX56NBZ/xPri0yN7RKiTHp0uHx4aMYI/OORGVyfAbCw8BR7+6gDSRYRLT4Z+bfYsG7OoHnpNsNW3AByzulbtPDN7WuLvmxAjN0It9OH+/KH4r0nZnPXDMAjO86wt6pakGTRocUXwv2D47DhzsEcbkC5d+U2trG4BjFRJridPiyZORKrH/nOZd+VXC7zN/sb2VuHHUiy6tEihfHwiMQb1ngA2PjELO7B6cPhbvcjJtaK1YVV+MX7paxXAHxQ6z74q/1NSLSIaPGHcf+QWKyalXnDGn9e1jwyg7sndzDcHX5Ex1rx3KZSvF92kvUIgDNeed5ju+vG2XU83CEV+ak2bJgz6IY3/rxsevJ2LndoKjxSCGaTHsve+gKnWz2PXzUATxbXb3HJKhiARJOIt2cPvB03mbz3w9n/lWA3gQFwS0E8vmrHyqsCYP1xV8MnZz2I1QuQwhremJ6xM82qL7zZAEiLtW546we3BQIhBXarEf8uP4W1u4+yKwLw6wMtqTYdj7aQioeHxWFu/+jbcJPKvHEDzA/dNhweTxBGsx6/2FiCdn8o+5IA/L6ildV6wiAckGIW8XxO6mTc5PLivZPvTIgxgxCCuqZ2rPx35YFLAvDGMRdseh4dsoanRyci0awrvdkBSIoyf7Z8bjb8viCMFgNWFlbCLQVzvgbA34462VlfGAwMmXY9lo9J4vD/RJ6ZN57L6hcHyhiaHV68W1RTdj5PuDD4nWyHUSDwhTU8MzoB/3ONDz127Fjh0KFDZ/e0njsgj33g7bJDUkgBTwBGGTgGoJM6A4swRqAUYADAAMYuyj9/ARwYmMZAOOBUczs4AETksWbXUXQB4EBb4Nm8j09BTzgYDTwWDoqZdy0AHKmuLlv9j3U5vakbVmnMrlMO+AMyQLiIoRQXGaZGDKcUoBFDwehX+ZReAACsswylEEUeAuGg1wk4dKoF+042f5STlTxfAIBP6nzPhzQGjTLM7WdFhk1/TUFOSUlZTktzM4qKitmUKXk9i885aHajCK6TLaaUgqMX9wD+IkMvBoZG8ulXvYBjDKzzP6MUlFHwhEcoHMKW8lN3XegBu1okGHmCoKphXrrd9eE1GF9fX/+bl1/+E6xWK4qLS3pcP9Fq3HWyzfc4pUwPDoyLtD/AGN9the7SL1k2MuYxRnUmvXj6dwCEMz75u5M/rgVPgBg9j6nJlmXX0vo7d+7+paKqoJRiyJBBvdKRFW/92zc1QJJDztDPO8IUGgWy7HoMtOs/6K0yh6NtcWVVFURRhMVixvTp02b1VpcrqIz6JgAQqtzByRpj0CjFyBgD9l2Dsj17itaEgiFQxpCbOwlRUVE9psnaQsro27bWVg5ZV4WZG6vw+b2j+3Q63r59B6usrALHccjOHguhpkMGz3FQGDA0ytB7srLDM+PF378EUacD4ThMm5b/8Pm8dUeawotGpuiuRg9lEJ1BFW0BBS5937f42bNnUVBQAFEU0dBQD1LvV8BzkRmnv1VX1vuRv/QLn88HRVEwZsxoJCYkrAaAGpd/2aNbvxQPNnn+cLW6RMJB4DkIpO99saysLMTGxiIuLg4ejwfEJWsgXOShiSah165vWdk+6HR6CIKA6dOnvXA+/fWKpjcC/jDeKD/3s6vVxSI9ATzX9wBERdmrOC6yiNPe3g5BUigADiLhYBP5071RumvXbvb+5n+CcAQjRgxHv35pF/yoT063Q2/VY1N1M045paWZcZaCqwFAIBycwTDePFDHmKYBmgaoKjhKEQ7KmDMmY0VmcnSPV47NZvNBQRBGMwYEgyEICo2EyHxkwbKjNwAU7y2FTqeDqqiYPj1/08V5cwdE4zWnF3JQwcqyM38HcEUAeHAwiQRtgSCWfXoUCMpAKAQEg0A4DLS1472f3/VHAD0GQBTFVkIIKKVQFOXypOjVyL795f6W1lZQSpGZNRCDBmXd24VdGpf6oFUkMOkFvFNRh2ZvcOaVBsG2kIqOgIKOYKfbi06P7/wv+yr5mqdBkXCQNQaNMYQ1FtVTBUVFxSZREKAoCqZPy6/82qATY1r7wJYja945VI9AIISCstPbcBk6Ptkklr56pA2yHAbX2e2ZqgGaCqaqIJoGOSBjTEbC870xWFGUREojbrMoihAsIoGkaFAog1fRBvQo6DlSvb9g1T9ACEF6v34YNWpkt6tEP5rQ75VNVQ3LOZ2AVfuuPMw8NTL+iqNfb4M1v9+fraoqeJ6H0WgEidXzoAxQKENrQJ3UE2W79xRPIDyBoiiYOjVPvlS5CSn2FTMHxEGhDGfbfFi55zjDtyRud/totdNVt9vtIGlmEVpnEHXGF771ahWdPFW7rrb2NAhHkJychJyciZf1op66NWMnY4BOJ+D1Pccvq7um5vjWw4ePVJw4cXJjXwPQ1NQESikopUhKSgQZEqWHxiKkwZcdoZ64vQ9wHBAOh5E7+crU4czM+Nsmp0eDATja4Ma7+2q77QVen2/Suxs2zX3zrVVjNm/+8J7r4QmenwXS09NBxsQY9/IcBx0hqHZfHQD1DQ2/rKk5AZ7nERsbg2nTpl6Vx/LEpAGqolKIAo9Xtx+9BB/AKUajASaTCQZD3/vCtbW1EAQRhBAMGjQIZGyc4Q9ROh48AU54ZNR6Qt+/8si/9zeapkIOh5GTM/GqH37/mDRx7C3RAOGwv7YF/zp8rr7bqZAy0M4NVX0pjY2NP6+vbwDPE1itVgwZMniF0N+q3zr901qUtqiQVA27m/1vAnj/ktFaW9vCP/35NQiCCJPRhMmTbp1+uYee84Tm8RzCqkZtAuH8q8tqUXm6FRzH4c+FVbdcmhnioKoqnE7XPQAjjIEHGNf5SxhjYsQtYML5NEqp0WQyHY6Ojv6sO52VlZUv+nw+CIKA9PR0pKSkvCIAwLRkC3Y2ShAJh4/PeaKv4PWtl2UZlFJMunUi7Hb7rkuVHbvhCBu77hB0mgIqK2CyDKIqsBhEcDzDruoG7D/V8v7EzKTvd+Oxwd3ejpde+uNGRVWhqQoUVYV68aUo0DQVqqqBMQqn04U777wDl/Iziov3QhAEhMNhZGeP+4oWn5tmfdbAE5gEgj1NEs565W43JHo8nmkVFRHCw2g0IC9v8gOXMv5npQ2sosELX1hDi1+GQ5LRJslo9QThkxVIsoKwL4hfby773n/EAUSWw5BlGaFQCH6/H36/H5LkhyRJXS6fzwev1wev1wuv1wuPx4NgMNjt+zQ3Nz9VUVEJvV4PnU6HvLzcbRc4wex40+8mbzn5QoUziGBYw/oT7o+7Q7GsbP9OSZIAAOPHj0N8fPzb3X4mQXX0AzvOIr9/NHhVAVWMgKKCKWEwRQHCCpiigM+Ig6yoaHT57kmNtW4CAJvFsn/16rUIBINglEZaWNOgqSo0TYvca5H7C2mqBoCio8ODjIz0bgEoLNz2F4/HA71ej8GDB+M8ZX9hXWBRVrRa0uIXbDqCNTWubpWUHzgEvV4HTaOYOiXvks5YvFGoQg/2H6X+ouv/JUsW9zoOXr16VXfe36iHHloCs9kMn0/CHXfcjoKCt7quDD06LE7sb9UB4FDrlfHioeYu8/SeomLW3t4OVVUxdMhg3HJL6gs3y8rQxx9vrWpoaATHcUhNTcbMmTMvOHxdosFHh8XCq2gQCAeL2DVQ3LevHDpdhNWaMjVv9c1ivNvtnrdx4yZYrVb4fD4sWDAfVqt1X7cAPDMmketnFpFqFvHkyETuq65/0OlwtIFSioEDBiBz4ICHbxYACgpWbXG5nKCUIi0tDQsWLBjfhRb/zwrPjE3EkiFxXdJKS/fFCqIITdOQNyW36GYxvqSkhH366WeIioqCJElYunQJLBbLwS58wNfc1RFdQ9Hqo1/uWb/+XRBCkJZ2C0YMHzb1ZjDe4XA89Nhjj8NoNMLj8WDKlDzMnv31fYPkyiiWTSGEQNM05OZOarlZWv/5519Y3d7eAY7jYLfb8ZOf/PjH3ZW7LADHjh3/7OzZcxAEATabFeOzxyXfDMY/99zzrKrqMKxWKyRJwk9/ugLJycmv9hgAl9s1R5ZlCIIASfJj46bN7EY3/qWXXmZffLEdsbExaGtrw9KlSzB16qWj1csCkJc7mcvNnQSv1wuDwYCysv1Yt/4dduN2+9+xzz77F+Li4uBwtOHuuxdg8eLFvd8qCwB3L7iLmzA+G16vF3a7HRUVVXjtr68zl9s9/0YxvLW19ZGnn17Odu7cibi4WDgcDtxxxxysWLH82jdLn5fNmz9kxXtLYbNZ4PcHYLGYcffd86tGjxo55tue6v668nW4XW5YLBY4HA7cddc8LF/+dN9tl78QUGz7ghUWfg69XgfKGORQCBMnTsAdc2bP6s1K8LWI0+m87+23391QWFgIvT7CHPkkCYseWIjFixf1/YGJC6RC1eGjH3zw4TBJ8sNkMsLn88JmsyE/fypmfmfGdd9ZJklSdmHhtgMffbQFTqcTVpsVXo8XVqsVP/zh48jPz79+R2YuRv+f/9yy4Uj10Qu8nd/vR3xcHHJyJmD8+PEPJiTEr+1Lw5ubm5/avafoL9u370BjQwNMZjOopkGSJEycOBGPPfboM6mpKS/1VO81tVhZ2X6lcNvngsPhgMFgAKUUwWAQZpMJmZkDMXLUSGRlZv4gMTGhoLdGf/nlsb+Ul5ejuvooPB4PDIYI++7zSUhOTsJ9992L2bNnfbPH5v4z1i4q2lu1t6QETqcLoiiCEA5yKAxNU2E0GpGQEI+U1BSkJCcjLi6u2Waz7TQaDTWCILgAQFHUhGAwMLyjwzPH4XCY6xsacO7cOTQ1NcPn84FwBKJOhKIoCAWDSEhIwMyZMzF37p25Npu15Frev8++WZ8kjT9QfrB8//5y1NXXQwmHIQgCOI6DpmkIKwoo1SJzLyHgCQ+O48AYhappUBQFaifDAwbwPAEhBKoaYZ8FnkdGRgby86ciP3/q9Mtxkd8KAF2599MFR6qrHz5+/ARaWloR8PsjB6K5CNsLRHaAnj80TTv3AGqUgnZSXQBgNBqRnJyMYcOHIXvcuH8PHTpkTl+/63UftVtaW5fVnat7pa6u3tzc3AyX2wWfT0IoGIKqqmCMghACnU4Hs8WC2JhoJCenICMjHf37Z6xISUm5rsfn/w8Uh4feajwuOgAAAABJRU5ErkJggg==" alt="AE"/></div>
      <div>
        <div class="sb-logo-text">Personeelbeheer</div>
        <div class="sb-logo-sub">Advanced Energy</div>
      </div>
    </div>
  </div>
  <div class="sb-nav">
    <div class="sb-section">Overzicht</div>
    <button class="sb-item active" data-page="dashboard" onclick="try{showPage('dashboard')}catch(e){document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});document.getElementById('page-dashboard').classList.add('active');document.querySelectorAll('.sb-item').forEach(function(b){b.classList.remove('active')});this.classList.add('active')}">
      <span class="sb-item-icon">ğŸ“Š</span>Dashboard
    </button>
    <button class="sb-item" data-page="wallchart" onclick="try{showPage('wallchart')}catch(e){document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});document.getElementById('page-wallchart').classList.add('active');document.querySelectorAll('.sb-item').forEach(function(b){b.classList.remove('active')});this.classList.add('active')}">
      <span class="sb-item-icon">ğŸ—“</span>Wallchart
    </button>
    <div class="sb-section">Beheer</div>
    <button class="sb-item" data-page="requests" onclick="try{showPage('requests')}catch(e){document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});document.getElementById('page-requests').classList.add('active');document.querySelectorAll('.sb-item').forEach(function(b){b.classList.remove('active')});this.classList.add('active')}">
      <span class="sb-item-icon">ğŸ“¥</span>Aanvragen
      <span class="sb-item-badge" id="badge-requests" style="display:none">0</span>
    </button>
    <button class="sb-item" data-page="people" onclick="try{showPage('people')}catch(e){document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});document.getElementById('page-people').classList.add('active');document.querySelectorAll('.sb-item').forEach(function(b){b.classList.remove('active')});this.classList.add('active')}">
      <span class="sb-item-icon">ğŸ‘¥</span>Medewerkers
      <span class="sb-item-badge" id="badge-interim" style="display:none;background:#eab308">0</span>
    </button>
    <button class="sb-item" data-page="departments" onclick="try{showPage('departments')}catch(e){document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});document.getElementById('page-departments').classList.add('active');document.querySelectorAll('.sb-item').forEach(function(b){b.classList.remove('active')});this.classList.add('active')}">
      <span class="sb-item-icon">ğŸ“‚</span>Departments
    </button>
    <button class="sb-item" data-page="sickness" onclick="try{showPage('sickness')}catch(e){document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});document.getElementById('page-sickness').classList.add('active');document.querySelectorAll('.sb-item').forEach(function(b){b.classList.remove('active')});this.classList.add('active')}">
      <span class="sb-item-icon">ğŸ¤’</span>Ziekte
    </button>
    <div class="sb-section">Configuratie</div>
    <button class="sb-item" data-page="types" onclick="try{showPage('types')}catch(e){document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});document.getElementById('page-types').classList.add('active');document.querySelectorAll('.sb-item').forEach(function(b){b.classList.remove('active')});this.classList.add('active')}">
      <span class="sb-item-icon">ğŸ·ï¸</span>Afwezigheidstypes
    </button>
    <button class="sb-item" data-page="settings" onclick="try{showPage('settings')}catch(e){document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});document.getElementById('page-settings').classList.add('active');document.querySelectorAll('.sb-item').forEach(function(b){b.classList.remove('active')});this.classList.add('active')}">
      <span class="sb-item-icon">âš™ï¸</span>Instellingen
    </button>
    <button class="sb-item" data-page="reports" onclick="try{showPage('reports')}catch(e){document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});document.getElementById('page-reports').classList.add('active');document.querySelectorAll('.sb-item').forEach(function(b){b.classList.remove('active')});this.classList.add('active')}">
      <span class="sb-item-icon">ğŸ“ˆ</span>Rapportage
    </button>
    <button class="sb-item" data-page="organigram" onclick="try{showPage('organigram')}catch(e){document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});document.getElementById('page-organigram').classList.add('active');document.querySelectorAll('.sb-item').forEach(function(b){b.classList.remove('active')});this.classList.add('active')}">
      <span class="sb-item-icon">ğŸ¢</span>Organigram
    </button>
  </div>
  <div class="sb-footer">
    <div style="display:flex;justify-content:space-between;align-items:center">
      Personeelbeheer v1.0
      <button onclick="resetData()" style="background:none;border:none;color:var(--text3);font-size:10px;cursor:pointer;text-decoration:underline" title="Alle data resetten naar standaardwaarden">ğŸ”„ Reset</button>
    </div>
  </div>
</nav>

<!-- Navigatie via event delegation - werkt altijd, onafhankelijk van andere scripts -->
<script>
document.addEventListener('click',function(e){
  var btn=e.target.closest('.sb-item[data-page]');
  if(!btn)return;
  var page=btn.getAttribute('data-page');
  if(!page)return;
  // Toggle panels
  var panels=document.querySelectorAll('.panel');
  for(var i=0;i<panels.length;i++)panels[i].classList.remove('active');
  var target=document.getElementById('page-'+page);
  if(target)target.classList.add('active');
  // Toggle sidebar active state
  var items=document.querySelectorAll('.sb-item');
  for(var i=0;i<items.length;i++)items[i].classList.remove('active');
  btn.classList.add('active');
  // Try to call render functions if available
  try{
    if(page==='dashboard'&&typeof renderDashboard==='function')renderDashboard();
    if(page==='requests'&&typeof renderRequests==='function')renderRequests();
    if(page==='people'&&typeof renderPeople==='function')renderPeople();
    if(page==='departments'&&typeof renderDepartments==='function')renderDepartments();
    if(page==='sickness'&&typeof renderSickness==='function')renderSickness();
    if(page==='wallchart'&&typeof renderWallchart==='function')renderWallchart();
    if(page==='types'&&typeof renderTypes==='function')renderTypes();
    if(page==='settings'&&typeof renderSettings==='function')renderSettings();
    if(page==='reports'&&typeof renderReports==='function')renderReports();
    if(page==='organigram'&&typeof renderOrganigram==='function')renderOrganigram();
  }catch(ex){}
});
</script>

<!-- Role bar -->
<div class="role-bar">
  <span class="role-bar-label">Rol:</span>
  <button class="role-btn active" onclick="setRole('admin',this)">Admin</button>
  <button class="role-btn" onclick="setRole('approver',this)">Approver</button>
  <button class="role-btn" onclick="setRole('user',this)">User</button>
  <div class="role-bar-right">
    <span class="env-badge">Development</span>
  </div>
</div>

<!-- Main content -->
<div class="main" role="main">

  <!-- Dashboard -->
  <div class="panel active" id="page-dashboard">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Dashboard</div><div class="page-subtitle">Overzicht verlof en afwezigheden</div></div>
      </div>
      <div class="card-grid card-grid-3" style="margin-bottom:20px">
        <div class="card" style="cursor:pointer" onclick="highlightCard('card-absent')"><div class="stat"><div class="stat-value" id="st-absent">0</div><div class="stat-label">Afwezig vandaag</div></div></div>
        <div class="card" style="cursor:pointer" onclick="highlightCard('card-absent')"><div class="stat"><div class="stat-value" id="st-sick" style="color:var(--danger)">0</div><div class="stat-label">Ziek vandaag</div></div></div>
        <div class="card" style="cursor:pointer" onclick="highlightCard('card-pending')"><div class="stat"><div class="stat-value" id="st-pending" style="color:var(--warn)">0</div><div class="stat-label">Openstaande aanvragen</div></div></div>
      </div>
      <div class="card-grid card-grid-2">
        <div class="card" id="card-absent">
          <div class="card-title">ğŸ“… Afwezig vandaag</div>
          <div id="dash-absent"><span style="font-size:13px;color:var(--text3)">Niemand afwezig</span></div>
          <div id="dash-sick-section"></div>
        </div>
        <div class="card" id="card-pending">
          <div class="card-title">ğŸ“¥ Openstaande aanvragen</div>
          <div id="dash-pending"><span style="font-size:13px;color:var(--text3)">Geen openstaande aanvragen</span></div>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <div class="card-title">ğŸ‡§ğŸ‡ª Aankomende feestdagen</div>
        <div id="dash-holidays"></div>
      </div>
    </div>
  </div>

  <!-- Medewerkers -->
  <div class="panel" id="page-people">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title" id="people-title">Medewerkers</div><div class="page-subtitle" id="people-count">0 medewerkers</div></div>
        <div id="people-header-actions">
          <button class="btn btn-sm btn-primary-outline" onclick="openPersonModal()" id="btn-new-person">â• Medewerker toevoegen</button>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="showPeopleTab('employees',this)">ğŸ‘¥ Medewerkers</button>
        <button class="tab" onclick="showPeopleTab('candidates',this)">ğŸ“„ Kandidaten <span id="cand-badge"></span></button>
      </div>
      <!-- Medewerkers tab -->
      <div id="people-tab-employees">
        <div class="card">
          <div style="display:flex;gap:12px;margin-bottom:16px;align-items:center">
            <div class="search-box" style="flex:1"><input class="form-input" placeholder="Zoek medewerker..." oninput="filterPeople(this.value)"/></div>
            <select class="form-input" style="width:180px" onchange="filterPeopleDept(this.value)">
              <option value="">Alle departments</option>
            </select>
            <select class="form-input" style="width:160px" id="people-status-filter" onchange="peopleStatusFilter=this.value;renderPeople()">
              <option value="active">Actieve medewerkers</option>
              <option value="archived">Gearchiveerd</option>
              <option value="all">Alle medewerkers</option>
            </select>
          </div>
          <div style="max-height:70vh;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius-sm)">
          <table class="tbl" style="margin:0">
            <thead style="position:sticky;top:0;z-index:2;background:var(--surface)"><tr>
              <th style="cursor:pointer;user-select:none" onclick="sortPeople('name')">Medewerker <span id="sort-name" style="opacity:.3;display:inline-block;width:12px;text-align:center">â†•</span></th>
              <th style="cursor:pointer;user-select:none" onclick="sortPeople('dept')">Department <span id="sort-dept" style="opacity:.3;display:inline-block;width:12px;text-align:center">â†•</span></th>
              <th style="cursor:pointer;user-select:none" onclick="sortPeople('role')">Rol <span id="sort-role" style="opacity:.3;display:inline-block;width:12px;text-align:center">â†•</span></th>
              <th>ğŸ“± GSM</th>
              <th style="cursor:pointer;user-select:none" onclick="sortPeople('schedule')">Rooster <span id="sort-schedule" style="opacity:.3;display:inline-block;width:12px;text-align:center">â†•</span></th>
              <th style="cursor:pointer;user-select:none" onclick="sortPeople('saldo')">Saldo <span id="sort-saldo" style="opacity:.3;display:inline-block;width:12px;text-align:center">â†•</span></th>
              <th>Saldo OV</th>
              <th class="interim-col" style="display:none">Interim dagen</th>
              <th class="interim-col" style="display:none">Interim counter</th>
              <th></th>
            </tr></thead>
            <tbody id="people-table"></tbody>
          </table>
          </div>
        </div>
      </div>
      <!-- Kandidaten tab -->
      <div id="people-tab-candidates" style="display:none">
        <div class="card-grid card-grid-4" style="margin-bottom:16px">
          <div class="card"><div class="stat"><div class="stat-value" id="cand-st-new" style="color:var(--accent)">0</div><div class="stat-label">Nieuw</div></div></div>
          <div class="card"><div class="stat"><div class="stat-value" id="cand-st-interview" style="color:var(--warn)">0</div><div class="stat-label">Gesprek gepland</div></div></div>
          <div class="card"><div class="stat"><div class="stat-value" id="cand-st-hired" style="color:var(--success)">0</div><div class="stat-label">Aangenomen</div></div></div>
          <div class="card"><div class="stat"><div class="stat-value" id="cand-st-rejected" style="color:var(--danger)">0</div><div class="stat-label">Afgewezen</div></div></div>
        </div>
        <div class="card">
          <div style="display:flex;gap:12px;margin-bottom:16px">
            <div class="search-box" style="flex:1"><input class="form-input" placeholder="Zoek kandidaat..." oninput="searchCandidates(this.value)"/></div>
            <select class="form-input" style="width:160px" id="cand-status-filter" onchange="renderCandidates()">
              <option value="">Alle statussen</option>
              <option value="nieuw">Nieuw</option>
              <option value="gesprek_gepland">Gesprek gepland</option>
              <option value="aangenomen">Aangenomen</option>
              <option value="afgewezen">Afgewezen</option>
            </select>
            <select class="form-input" style="width:160px" id="cand-channel-filter" onchange="renderCandidates()">
              <option value="">Alle kanalen</option>
            </select>
          </div>
          <table class="tbl">
            <thead><tr><th>Kandidaat</th><th>Kanaal</th><th>Positie</th><th>Status</th><th>CV</th><th>Gesprek</th><th></th></tr></thead>
            <tbody id="candidates-table"></tbody>
          </table>
          <button class="btn btn-sm" style="margin-top:12px;width:100%;justify-content:center;border-style:dashed;color:var(--text3)" onclick="openCandidateModal()">â• Kandidaat toevoegen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Departments -->
  <div class="panel" id="page-departments">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Departments</div><div class="page-subtitle" id="dept-count">0 departments</div></div>
        <button class="btn btn-sm btn-primary-outline" onclick="openDeptModal()">â• Department toevoegen</button>
      </div>
      <div class="card-grid card-grid-3" id="dept-grid"></div>
    </div>
  </div>

  <!-- Afwezigheidstypes -->
  <div class="panel" id="page-types">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Afwezigheidstypes</div><div class="page-subtitle">Configureer verlof- en afwezigheidstypes, kleuren en saldo-instellingen</div></div>
        <button class="btn btn-sm btn-primary-outline" onclick="openTypeModal()">â• Type toevoegen</button>
      </div>
      <div class="card">
        <table class="tbl">
          <thead><tr><th>Type</th><th>Categorie</th><th>Betaald</th><th title="Telt mee voor verlofsaldo">Verlofsaldo</th><th title="Telt mee voor afwezigheidssaldo">Afwez.saldo</th><th title="Zichtbaar in mobiele app">Mobiel</th><th>Standaard</th><th>Max/jaar</th><th></th></tr></thead>
          <tbody id="types-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Instellingen -->
  <div class="panel" id="page-settings">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Instellingen</div><div class="page-subtitle">Werkroosters, feestdagen en jaarovergang</div></div>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="showSettingsTab('schedules',this)">Werkroosters</button>
        <button class="tab" onclick="showSettingsTab('holidays',this)">Feestdagen</button>
        <button class="tab" onclick="showSettingsTab('yearend',this)">Jaarovergang</button>
        <button class="tab" onclick="showSettingsTab('notifications',this)">Notificaties</button>
        <button class="tab" onclick="showSettingsTab('barema',this)">ğŸ’° Barema PC 149.01</button>
        <button class="tab" onclick="showSettingsTab('ancienniteit',this)">ğŸ– AnciÃ«nniteit</button>
        <button class="tab" onclick="showSettingsTab('verlofregels',this)">ğŸ“ Verlofregels</button>
        <button class="tab" onclick="showSettingsTab('checklist',this)">â˜‘ï¸ Checklist</button>
      </div>
      <div id="settings-schedules" class="settings-panel">
        <div class="card">
          <div class="card-title">Werkroosters</div>
          <table class="tbl">
            <thead><tr><th>Naam</th><th>Dagen/week</th><th>Uren/dag</th><th>Halve dagen</th><th></th></tr></thead>
            <tbody id="schedules-table"></tbody>
          </table>
          <button class="btn btn-sm" style="margin-top:12px" onclick="openScheduleModal()">â• Rooster toevoegen</button>
        </div>
      </div>
      <div id="settings-holidays" class="settings-panel" style="display:none">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div class="card-title" style="margin-bottom:0">ğŸ‡§ğŸ‡ª Belgische feestdagen</div>
            <div style="display:flex;gap:8px;align-items:center">
              <label class="form-label" style="margin:0">Regio:</label>
              <select class="form-input" style="width:160px" onchange="setRegion(this.value)" id="region-select">
                <option value="vlaanderen">Vlaanderen</option>
                <option value="wallonie">WalloniÃ«</option>
                <option value="brussel">Brussel</option>
              </select>
            </div>
          </div>
          <table class="tbl">
            <thead><tr><th>Datum</th><th>Feestdag</th><th>Actief</th></tr></thead>
            <tbody id="holidays-table"></tbody>
          </table>
        </div>
      </div>
      <div id="settings-yearend" class="settings-panel" style="display:none">
        <div class="card">
          <div class="card-title">Jaarovergang instellingen</div>
          <div class="form-group">
            <label class="form-label">Overdracht restdagen</label>
            <select class="form-input" id="yearend-mode" onchange="saveSettings()">
              <option value="none">Geen overdracht â€” restdagen vervallen</option>
              <option value="unlimited">Volledige overdracht â€” alles gaat mee</option>
              <option value="max5">Maximum 5 dagen overdragen</option>
              <option value="max10">Maximum 10 dagen overdragen</option>
              <option value="custom">Aangepast maximum</option>
            </select>
          </div>
          <div class="form-group" id="yearend-custom-row" style="display:none">
            <label class="form-label">Maximum aantal dagen</label>
            <input type="number" class="form-input" id="yearend-custom-days" min="1" max="50" value="5" style="width:120px" onchange="saveSettings()"/>
          </div>
          <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
            <div style="font-weight:700;font-size:13px;margin-bottom:4px">Jaarovergang uitvoeren</div>
            <div style="font-size:11px;color:var(--text3);margin-bottom:12px">Berekent het restsaldo van het gekozen jaar per medewerker en voegt een overdracht-aanpassing toe aan het volgende jaar. Dit proces kan maar 1x per jaar uitgevoerd worden.</div>
            <div style="display:flex;gap:8px;align-items:center">
              <select class="form-input" id="yearend-year" style="width:120px"></select>
              <button class="btn btn-sm" onclick="previewYearend()">ğŸ“Š Preview</button>
              <button class="btn btn-sm btn-primary" onclick="executeYearend()">â–¶ Uitvoeren</button>
            </div>
            <div id="yearend-preview" style="margin-top:16px"></div>
          </div>
        </div>
      </div>
      <div id="settings-notifications" class="settings-panel" style="display:none">
        <div class="card">
          <div class="card-title">Notificatie-instellingen</div>
          <div class="form-group">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px">
              <input type="checkbox" id="notif-email" checked onchange="saveSettings()"/> E-mail notificaties bij nieuwe aanvraag
            </label>
          </div>
          <div class="form-group">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px">
              <input type="checkbox" id="notif-sick" checked onchange="saveSettings()"/> E-mail/SMS bij ziekmelding naar HR + divisie
            </label>
          </div>
        </div>
      </div>
      <div id="settings-barema" class="settings-panel" style="display:none">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div>
              <div class="card-title" style="margin-bottom:2px">ğŸ’° Barema â€” PC 149.01 Elektriciens</div>
              <div style="font-size:11px;color:var(--text3)">Minimumuurlonen per categorie Â· 40u/week</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-sm btn-primary-outline" onclick="addBaremaPeriod()">â• Nieuw barema</button>
              <button class="btn btn-sm btn-primary-outline" onclick="addBaremaIndexation()">â• Nieuwe indexatie</button>
              <button class="btn btn-sm" onclick="openBulkIndexation()" style="background:rgba(34,197,94,.12);color:#16a34a;border-color:#22c55e">ğŸ“ˆ Indexatie toepassen</button>
            </div>
          </div>
          <div style="overflow-x:auto">
            <table class="tbl" id="barema-table">
              <thead id="barema-thead"></thead>
              <tbody id="barema-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="settings-ancienniteit" class="settings-panel" style="display:none">
        <div class="card">
          <div style="margin-bottom:16px">
            <div class="card-title" style="margin-bottom:2px">ğŸ– AnciÃ«nniteitstoeslag â€” PC 149.01</div>
            <div style="font-size:11px;color:var(--text3)">Procentuele toeslag op minimumuurloon</div>
          </div>
          <table class="tbl" id="ancienniteit-table">
            <thead><tr><th style="width:100px">Toeslag</th><th>Omschrijving</th></tr></thead>
            <tbody id="ancienniteit-tbody"></tbody>
          </table>
        </div>
      </div>
      <div id="settings-verlofregels" class="settings-panel" style="display:none">
        <div class="card">
          <div style="margin-bottom:16px">
            <div class="card-title" style="margin-bottom:2px">ğŸ“ Verlofregels</div>
            <div style="font-size:11px;color:var(--text3)">Configureer beperkingen voor verlofaanvragen. Bij overschrijding verschijnt een waarschuwing (geen blokkering).</div>
          </div>
          <div id="verlofregels-content" style="max-height:400px;overflow-y:auto"></div>
        </div>
      </div>
      <div id="settings-checklist" class="settings-panel" style="display:none">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div>
              <div class="card-title" style="margin-bottom:2px">â˜‘ï¸ Onboarding Checklist</div>
              <div style="font-size:11px;color:var(--text3)">Beheer de onboarding checklists die aan nieuwe medewerkers worden toegekend. Klik op een checklist om de items te beheren.</div>
            </div>
            <button class="btn btn-sm btn-primary-outline" onclick="openNewChecklistModal()">â• Checklist toevoegen</button>
          </div>
          <div id="checklist-sections-container"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="panel" id="page-wallchart">
    <div class="page" style="max-width:1400px">
      <div class="page-header">
        <div><div class="page-title">Wallchart</div><div class="page-subtitle" id="wc-subtitle">Planningsoverzicht</div></div>
        <div style="display:flex;gap:8px;align-items:center">
          <select class="form-input" style="width:160px" id="wc-dept" onchange="renderWallchart()">
            <option value="">Alle departments</option>
          </select>
          <button class="btn btn-sm" onclick="wcPrev()">â—€</button>
          <button class="btn btn-sm" onclick="wcToday()">Vandaag</button>
          <button class="btn btn-sm" onclick="wcNext()">â–¶</button>
          <button class="btn btn-sm" id="wc-mode-btn" onclick="toggleWcMode()">Maand</button>
        </div>
      </div>
      <div class="card" style="overflow-x:auto;padding:12px">
        <div id="wc-legend" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;font-size:11px"></div>
        <table class="tbl" id="wc-table" style="font-size:11px;min-width:800px">
          <thead id="wc-thead"></thead>
          <tbody id="wc-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Aanvragen -->
  <div class="panel" id="page-requests">
    <div id="requests-app" style="min-height:100vh;background:#f0f4ff;font-family:'DM Sans',-apple-system,sans-serif"></div>
    <script>
    (function(){
      // â•â•â• ZELFSTANDIGE AANVRAGEN MODULE â•â•â•
      const RA_COLORS=["#3b82f6","#22c55e","#a855f7","#ef4444","#eab308","#ec4899","#06b6d4","#f97316","#8b5cf6","#10b981"];
      function raColor(n){let h=0;for(let i=0;i<n.length;i++)h=n.charCodeAt(i)+((h<<5)-h);return RA_COLORS[Math.abs(h)%RA_COLORS.length];}
      function raIni(n){return n.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);}
      function raFD(d){return new Date(d).toLocaleDateString('nl-BE',{day:'2-digit',month:'short'});}
      function raFmt(d){return d.toISOString().split('T')[0];}
      function raAddD(d,n){const r=new Date(d);r.setDate(r.getDate()+n);return r;}

      const raToday=new Date();
      const raTd=raFmt(raToday);

      // Gebruik app data als beschikbaar, anders eigen demo data
      function raPeople(){return(typeof people!=='undefined'&&people.length>0)?people:[
        {id:'x1',firstName:'Bert',lastName:'Resseler',departmentId:'dept-directie'},
        {id:'x2',firstName:'Enderson',lastName:'Molla',departmentId:'dept-install'},
        {id:'x3',firstName:'Jarno',lastName:'Vranckx',departmentId:'dept-install'},
        {id:'x4',firstName:'Jarne',lastName:'Boudt',departmentId:'dept-install'},
        {id:'x5',firstName:'GaÃ«tan',lastName:'Bosmans',departmentId:'dept-install'},
        {id:'x6',firstName:'Charly',lastName:'Vanderstappen',departmentId:'dept-service'},
        {id:'x7',firstName:'Chris',lastName:'Vanroelen',departmentId:'dept-verkoop'},
        {id:'x8',firstName:'Kinza',lastName:'Janssens',departmentId:'dept-install'},
        {id:'x9',firstName:'Lukas',lastName:'Cornet',departmentId:'dept-install'},
        {id:'x10',firstName:'Nicolas',lastName:'Voorspoels',departmentId:'dept-verkoop'},
        {id:'x11',firstName:'Rens',lastName:'Deschryver',departmentId:'dept-onderhoud'},
        {id:'x12',firstName:'Wout',lastName:'Verbaenen',departmentId:'dept-install'},
        {id:'x13',firstName:'Pieter-Jan',lastName:'De Clercq',departmentId:'dept-onderhoud'},
        {id:'x14',firstName:'Mien',lastName:'Puttemans',departmentId:'dept-back'},
        {id:'x15',firstName:'Amber',lastName:'Van Meerbeek',departmentId:'dept-back'},
        {id:'x16',firstName:'Cedric',lastName:'Bosteels',departmentId:'dept-install'},
        {id:'x17',firstName:'Glenn',lastName:'De Smedt',departmentId:'dept-service'},
        {id:'x18',firstName:'Kevin',lastName:'Janssen',departmentId:'dept-onderhoud'},
        {id:'x19',firstName:'Mohamed',lastName:'Vassallo',departmentId:'dept-install'},
        {id:'x20',firstName:'Stijn',lastName:'Vandenberghe',departmentId:'dept-verkoop'}
      ];}
      function raDepts(){return(typeof departments!=='undefined'&&departments.length>0)?departments:[
        {id:'dept-install',name:'Installatie'},{id:'dept-service',name:'Service'},
        {id:'dept-back',name:'Backoffice'},{id:'dept-directie',name:'Directie'},
        {id:'dept-verkoop',name:'Verkoop'},{id:'dept-onderhoud',name:'Onderhoud'}
      ];}
      function raTypes(){return(typeof leaveTypes!=='undefined'&&leaveTypes.length>0)?leaveTypes:[
        {id:'wettelijk',name:'Wettelijk verlof',symbol:'ğŸ–',color:'#3b82f6'},
        {id:'adv',name:'ADV',symbol:'ğŸ—',color:'#22c55e'},
        {id:'ziekte',name:'Ziekte',symbol:'ğŸ¤’',color:'#ef4444'},
        {id:'familiaal',name:'Familiaal verlof',symbol:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§',color:'#a855f7'},
        {id:'ancienniteit',name:'AnciÃ«nniteit',symbol:'â­',color:'#eab308'},
        {id:'dokter',name:'Doktersbezoek',symbol:'ğŸ©º',color:'#06b6d4'},
        {id:'hospitalisatie',name:'Hospitalisatie',symbol:'ğŸ¥',color:'#f97316'},
        {id:'opleiding',name:'Opleiding',symbol:'ğŸ“š',color:'#8b5cf6'},
        {id:'verhuizing',name:'Verhuizing',symbol:'ğŸ“¦',color:'#f472b6'},
        {id:'geboorte',name:'Geboorteverlof',symbol:'ğŸ‘¶',color:'#10b981'},
        {id:'tech-werkloos',name:'Tech. werkloosheid',symbol:'ğŸ­',color:'#78716c'},
        {id:'weerverlet',name:'Weerverlet',symbol:'ğŸŒ§',color:'#0ea5e9'},
        {id:'arbeidsongeval',name:'Arbeidsongeval',symbol:'âš ï¸',color:'#dc2626'},
        {id:'juridisch',name:'Juridisch verlof',symbol:'âš–ï¸',color:'#78716c'},
        {id:'communie',name:'Communie/feest',symbol:'â›ª',color:'#6366f1'}
      ];}

      function raRequests(){
        if(typeof requests!=='undefined'&&requests.length>0)return requests.map(r=>({...r}));
        const t=raToday;
        return[
          {id:'r1',personId:'x4',type:'wettelijk',startDate:raFmt(t),endDate:raFmt(raAddD(t,1)),days:2,halfDay:false,status:'approved',comment:'Gezinsuitstap'},
          {id:'r2',personId:'x6',type:'wettelijk',startDate:raFmt(t),endDate:raFmt(t),days:1,halfDay:false,status:'approved',comment:''},
          {id:'r3',personId:'x9',type:'ziekte',startDate:raFmt(raAddD(t,-2)),endDate:raFmt(raAddD(t,1)),days:4,halfDay:false,status:'approved',comment:'Griep'},
          {id:'r4',personId:'x3',type:'wettelijk',startDate:raFmt(raAddD(t,19)),endDate:raFmt(raAddD(t,20)),days:2,halfDay:false,status:'pending',comment:'Citytrip'},
          {id:'r5',personId:'x8',type:'wettelijk',startDate:raFmt(raAddD(t,11)),endDate:raFmt(raAddD(t,15)),days:5,halfDay:false,status:'pending',comment:'Vakantie'},
          {id:'r6',personId:'x7',type:'ancienniteit',startDate:raFmt(raAddD(t,4)),endDate:raFmt(raAddD(t,4)),days:1,halfDay:false,status:'pending',comment:''},
          {id:'r7',personId:'x10',type:'wettelijk',startDate:raFmt(raAddD(t,19)),endDate:raFmt(raAddD(t,19)),days:1,halfDay:false,status:'pending',comment:''},
          {id:'r8',personId:'x11',type:'wettelijk',startDate:raFmt(raAddD(t,19)),endDate:raFmt(raAddD(t,19)),days:1,halfDay:false,status:'pending',comment:''},
          {id:'r9',personId:'x1',type:'adv',startDate:raFmt(raAddD(t,7)),endDate:raFmt(raAddD(t,7)),days:1,halfDay:false,status:'pending',comment:''},
          {id:'r10',personId:'x12',type:'familiaal',startDate:raFmt(raAddD(t,-5)),endDate:raFmt(raAddD(t,-5)),days:1,halfDay:false,status:'approved',comment:'Ziek kind'},
          {id:'r11',personId:'x13',type:'wettelijk',startDate:raFmt(raAddD(t,-10)),endDate:raFmt(raAddD(t,-8)),days:3,halfDay:false,status:'approved',comment:''},
          {id:'r12',personId:'x2',type:'wettelijk',startDate:raFmt(raAddD(t,1)),endDate:raFmt(raAddD(t,1)),days:1,halfDay:false,status:'pending',comment:'Vakantie'},
          {id:'r13',personId:'x5',type:'wettelijk',startDate:raFmt(raAddD(t,-1)),endDate:raFmt(raAddD(t,3)),days:5,halfDay:false,status:'approved',comment:'Ski'},
          {id:'r14',personId:'x14',type:'dokter',startDate:raFmt(raAddD(t,8)),endDate:raFmt(raAddD(t,8)),days:1,halfDay:true,halfDayPeriod:'NM',status:'pending',comment:'Controle huisarts'},
          {id:'r15',personId:'x4',type:'wettelijk',startDate:raFmt(raAddD(t,-20)),endDate:raFmt(raAddD(t,-18)),days:3,halfDay:false,status:'rejected',comment:'Te veel overlap'},
          {id:'r16',personId:'x16',type:'adv',startDate:raFmt(raAddD(t,-3)),endDate:raFmt(raAddD(t,-3)),days:1,halfDay:false,status:'approved',comment:''},
          {id:'r17',personId:'x17',type:'wettelijk',startDate:raFmt(raAddD(t,5)),endDate:raFmt(raAddD(t,5)),days:1,halfDay:false,status:'approved',comment:''},
          {id:'r18',personId:'x18',type:'opleiding',startDate:raFmt(raAddD(t,14)),endDate:raFmt(raAddD(t,15)),days:2,halfDay:false,status:'approved',comment:'HVAC opleiding'},
          {id:'r19',personId:'x19',type:'wettelijk',startDate:raFmt(raAddD(t,21)),endDate:raFmt(raAddD(t,25)),days:5,halfDay:false,status:'pending',comment:'Zomervakantie'},
          {id:'r20',personId:'x20',type:'dokter',startDate:raFmt(raAddD(t,3)),endDate:raFmt(raAddD(t,3)),days:1,halfDay:true,halfDayPeriod:'VM',status:'pending',comment:'Tandarts'}
        ];
      }

      // State
      let raState={filter:'pending',tab:'aanvragen',search:'',dept:'',reqs:raRequests(),selected:new Set(),detail:null};

      function raGN(id){const p=raPeople().find(x=>x.id===id);return p?p.firstName+' '+p.lastName:'?';}
      function raGD(id){const p=raPeople().find(x=>x.id===id);if(!p)return'';const d=raDepts().find(x=>x.id===p.departmentId);return d?d.name:'';}
      function raGT(id){return raTypes().find(t=>t.id===id)||{name:id,symbol:'ğŸ“‹',color:'#94a3b8'};}

      function raConflicts(r){
        const p=raPeople().find(x=>x.id===r.personId);if(!p)return[];
        const same=raPeople().filter(x=>x.departmentId===p.departmentId&&x.id!==p.id);
        const c=[];
        same.forEach(s=>{
          raState.reqs.filter(x=>x.personId===s.id&&x.status==='approved'&&x.startDate<=r.endDate&&x.endDate>=r.startDate)
            .forEach(x=>{const t=raGT(x.type);c.push(raGN(s.id)+' ('+t.name+': '+raFD(x.startDate)+'â€“'+raFD(x.endDate)+')');});
        });
        return c;
      }

      function raAction(id,status){
        if(status==='rejected'){
          // Toon prompt voor reden van weigering
          var overlay=document.createElement('div');
          overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:10001';
          overlay.innerHTML='<div style="background:#fff;border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)">'
            +'<div style="font-size:14px;line-height:1.5;margin-bottom:12px;font-weight:600">âŒ Reden van weigering</div>'
            +'<textarea id="ra-reject-reason" class="form-input" rows="3" placeholder="Bv. onvoldoende bezetting, te veel overlap..." style="margin-bottom:16px;resize:vertical"></textarea>'
            +'<div style="display:flex;gap:8px;justify-content:flex-end">'
            +'<button class="btn" onclick="this.closest(\'div[style*=fixed]\').remove()">Annuleren</button>'
            +'<button class="btn btn-primary" style="background:var(--danger);border-color:var(--danger)" onclick="raDoReject(\''+id+'\',this.closest(\'div[style*=fixed]\'))">Weigeren</button>'
            +'</div></div>';
          document.body.appendChild(overlay);
          setTimeout(function(){var ta=document.getElementById('ra-reject-reason');if(ta)ta.focus();},50);
          return;
        }
        raDoAction(id,status,'','');
      }

      function raDoReject(id,overlay){
        var reason=document.getElementById('ra-reject-reason').value.trim();
        if(!reason){alert('Reden van weigering is verplicht');return;}
        if(overlay)overlay.remove();
        raDoAction(id,'rejected',reason);
      }

      function raDoAction(id,status,rejectReason){
        raState.reqs=raState.reqs.map(r=>r.id===id?Object.assign({},r,{status:status,rejectReason:rejectReason||r.rejectReason||'',decidedDate:new Date().toISOString().split('T')[0]}):r);
        if(typeof requests!=='undefined'){
          const idx=requests.findIndex(r=>r.id===id);
          if(idx>=0){
            requests[idx].status=status;
            requests[idx].decidedDate=new Date().toISOString().split('T')[0];
            if(rejectReason)requests[idx].rejectReason=rejectReason;
            // Log mutatie bij weigering
            if(status==='rejected'&&rejectReason){
              var req=requests[idx];
              var p=typeof people!=='undefined'?people.find(function(x){return x.id===req.personId;}):null;
              if(p){
                if(!p.mutations)p.mutations=[];
                var typeObj=typeof leaveTypes!=='undefined'?leaveTypes.find(function(t){return t.id===req.type;}):null;
                p.mutations.push({id:typeof uid==='function'?uid():'m'+Date.now(),timestamp:new Date().toISOString(),user:(typeof settings!=='undefined'&&settings.currentUser)||'Admin',field:'Aanvraag geweigerd',oldValue:(typeObj?typeObj.name:req.type)+' ('+req.startDate+' â†’ '+req.endDate+')',newValue:'Reden: '+rejectReason});
              }
            }
          }
          try{if(typeof autoSave==='function')autoSave();}catch(e){}
          try{if(typeof renderDashboard==='function')renderDashboard();}catch(e){}
        }
        raState.selected.delete(id);
        raShowToast((status==='approved'?'âœ… Goedgekeurd':'âŒ Geweigerd')+': '+raGN(raState.reqs.find(r=>r.id===id)?.personId||''));
        raRender();
      }

      function raBulk(status){
        if(status==='rejected'){
          var overlay=document.createElement('div');
          overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:10001';
          overlay.innerHTML='<div style="background:#fff;border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)">'
            +'<div style="font-size:14px;line-height:1.5;margin-bottom:12px;font-weight:600">âŒ Reden van weigering ('+raState.selected.size+' aanvragen)</div>'
            +'<textarea id="ra-bulk-reject-reason" class="form-input" rows="3" placeholder="Bv. onvoldoende bezetting..." style="margin-bottom:16px;resize:vertical"></textarea>'
            +'<div style="display:flex;gap:8px;justify-content:flex-end">'
            +'<button class="btn" onclick="this.closest(\'div[style*=fixed]\').remove()">Annuleren</button>'
            +'<button class="btn btn-primary" style="background:var(--danger);border-color:var(--danger)" onclick="raDoBulkReject(this.closest(\'div[style*=fixed]\'))">Weigeren</button>'
            +'</div></div>';
          document.body.appendChild(overlay);
          setTimeout(function(){var ta=document.getElementById('ra-bulk-reject-reason');if(ta)ta.focus();},50);
          return;
        }
        raState.selected.forEach(id=>raDoAction(id,'approved',''));
        raShowToast('âœ… '+raState.selected.size+' aanvragen goedgekeurd');
        raState.selected=new Set();
        raRender();
      }

      function raDoBulkReject(overlay){
        var reason=document.getElementById('ra-bulk-reject-reason').value.trim();
        if(!reason){alert('Reden van weigering is verplicht');return;}
        if(overlay)overlay.remove();
        var count=raState.selected.size;
        raState.selected.forEach(id=>raDoAction(id,'rejected',reason));
        raShowToast('âŒ '+count+' aanvragen geweigerd');
        raState.selected=new Set();
        raRender();
      }

      let raToastTimer;
      function raShowToast(msg){
        let el=document.getElementById('ra-toast');
        if(!el){el=document.createElement('div');el.id='ra-toast';document.getElementById('requests-app').appendChild(el);}
        el.style.cssText='position:fixed;top:16px;right:16px;background:#0f172a;color:#fff;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:999;box-shadow:0 4px 16px rgba(0,0,0,.2);animation:raSlide .3s ease';
        el.textContent=msg;
        clearTimeout(raToastTimer);
        raToastTimer=setTimeout(()=>{el.style.display='none';},2500);
      }

      function raRender(){
        const app=document.getElementById('requests-app');
        const S=raState;
        const pp=raPeople(),dd=raDepts();
        const nonS=S.reqs.filter(r=>r.type!=='ziekte'),sick=S.reqs.filter(r=>r.type==='ziekte');
        const pend=nonS.filter(r=>r.status==='pending').length;
        const absT=S.reqs.filter(r=>r.status==='approved'&&r.startDate<=raTd&&r.endDate>=raTd).length;
        const sickT=sick.filter(r=>r.startDate<=raTd&&r.endDate>=raTd).length;
        let fl=S.tab==='ziekte'?sick:nonS;
        if(S.filter!=='all')fl=fl.filter(r=>r.status===S.filter);
        if(S.dept)fl=fl.filter(r=>{const p=pp.find(x=>x.id===r.personId);return p&&p.departmentId===S.dept;});
        if(S.search){const q=S.search.toLowerCase();fl=fl.filter(r=>raGN(r.personId).toLowerCase().includes(q));}
        fl.sort((a,b)=>new Date(b.startDate)-new Date(a.startDate));
        const pendInView=fl.filter(r=>r.status==='pending');
        const showCheck=S.filter==='pending'&&pendInView.length>1;

        // Update sidebar badge
        try{const br=document.getElementById('badge-requests');if(br){if(pend>0){br.textContent=pend;br.style.display='';}else br.style.display='none';}}catch(e){}

        let h=`<style>
          @keyframes raSlide{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
          #requests-app table tr:hover td{background:#f8faff!important}
          #requests-app .ra-sel td{background:#eff6ff!important}
          #requests-app button:active{transform:scale(.97)}
          #requests-app *{box-sizing:border-box}
        </style>`;

        // Stats
        h+=`<div style="background:#fff;border-bottom:1px solid #e2e8f4;padding:16px 24px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
            <div style="font-size:20px">ğŸ“‹</div>
            <div><div style="font-size:17px;font-weight:700;color:#1e293b">Aanvragen</div>
            <div style="font-size:11px;color:#94a3b8">Verlofaanvragen beheren</div></div>
            <button onclick="try{openRequestModal()}catch(e){}" style="margin-left:auto;padding:7px 14px;border-radius:8px;border:1px solid rgba(59,130,246,.35);background:rgba(59,130,246,.08);color:#3b82f6;font-size:12px;font-weight:600;cursor:pointer">â• Nieuwe aanvraag</button>
          </div>
          <div style="display:flex;gap:10px">`;
        [{v:pend,l:'Openstaand',c:'#eab308',bg:'#fefce8',i:'â³'},
         {v:absT,l:'Afwezig vandaag',c:'#3b82f6',bg:'#eff6ff',i:'ğŸ–'},
         {v:sickT,l:'Ziek vandaag',c:'#ef4444',bg:'#fef2f2',i:'ğŸ¤’'},
         {v:(()=>{const active=pp.filter(x=>!x.archived);if(active.length===0)return 'â€”';const sum=active.reduce((s,p)=>s+getTotalAllowance(p)-getUsedDays(p.id),0);return (sum/active.length).toFixed(1)+'d';})(),l:'Resterend gem.',c:'#10b981',bg:'#ecfdf5',i:'ğŸ“Š'}
        ].forEach(s=>{
          h+=`<div style="flex:1;background:${s.bg};border-radius:10px;padding:10px 14px;border:1px solid ${s.c}18">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div style="font-size:22px;font-weight:700;color:${s.c}">${s.v}</div>
              <div style="font-size:18px;opacity:.5">${s.i}</div>
            </div>
            <div style="font-size:9px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;margin-top:1px">${s.l}</div>
          </div>`;
        });
        h+=`</div></div>`;

        // Tabs
        h+=`<div style="display:flex;background:#fff;border-bottom:1px solid #e2e8f4;padding:0 24px">`;
        [{id:'aanvragen',l:'ğŸ“¥ Aanvragen',b:pend},{id:'ziekte',l:'ğŸ¤’ Ziekte',b:sickT}].forEach(t=>{
          const act=S.tab===t.id;
          h+=`<button onclick="raSetTab('${t.id}')" style="padding:10px 16px;border:none;border-bottom:2px solid ${act?'#3b82f6':'transparent'};background:none;color:${act?'#3b82f6':'#64748b'};font-weight:600;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:6px">
            ${t.l}${t.b>0?`<span style="background:#ef4444;color:#fff;font-size:10px;font-weight:700;padding:1px 6px;border-radius:10px">${t.b}</span>`:''}
          </button>`;
        });
        h+=`</div>`;

        // Filters
        h+=`<div style="padding:12px 24px;display:flex;gap:6px;align-items:center;flex-wrap:wrap">`;
        const filters=S.tab==='aanvragen'?[
          {id:'pending',l:'â³ Openstaand'},{id:'approved',l:'âœ… Goedgekeurd'},{id:'rejected',l:'âŒ Geweigerd'},{id:'all',l:'Alles'}
        ]:[{id:'all',l:'Alle meldingen'},{id:'approved',l:'Actief'}];
        filters.forEach(f=>{
          const act=S.filter===f.id;
          h+=`<button onclick="raSetFilter('${f.id}')" style="padding:5px 12px;border-radius:8px;border:1px solid ${act?'#3b82f6':'#e2e8f0'};background:${act?'rgba(59,130,246,.08)':'#fff'};color:${act?'#3b82f6':'#475569'};font-size:12px;font-weight:500;cursor:pointer">${f.l}</button>`;
        });
        h+=`<select onchange="raSetDept(this.value)" style="padding:5px 10px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;font-size:12px;color:#475569;cursor:pointer;margin-left:4px">
          <option value="">Alle afdelingen</option>`;
        dd.forEach(d=>{h+=`<option value="${d.id}"${S.dept===d.id?' selected':''}>${d.name}</option>`;});
        h+=`</select>
          <input type="text" placeholder="ğŸ” Zoek op naam..." value="${S.search}" oninput="raSetSearch(this.value)" style="margin-left:auto;padding:6px 12px;border:1px solid #e2e8f0;border-radius:8px;font-size:12px;width:170px;outline:none;background:#fff"/>
        </div>`;

        // Bulk bar
        if(S.selected.size>0){
          h+=`<div style="margin:0 24px 8px;padding:10px 16px;background:#3b82f6;border-radius:10px;display:flex;align-items:center;gap:12px;color:#fff;font-size:13px">
            <span style="font-weight:700">${S.selected.size} geselecteerd</span>
            <div style="margin-left:auto;display:flex;gap:6px">
              <button onclick="raBulk('approved')" style="padding:5px 14px;border-radius:6px;border:none;background:#fff;color:#166534;font-size:12px;font-weight:600;cursor:pointer">âœ… Goedkeuren</button>
              <button onclick="raBulk('rejected')" style="padding:5px 14px;border-radius:6px;border:none;background:#fff;color:#991b1b;font-size:12px;font-weight:600;cursor:pointer">âŒ Weigeren</button>
              <button onclick="raClearSel()" style="padding:5px 14px;border-radius:6px;border:1px solid rgba(255,255,255,.4);background:transparent;color:#fff;font-size:12px;cursor:pointer">Annuleren</button>
            </div>
          </div>`;
        }

        // Table
        h+=`<div style="padding:0 24px 24px"><div style="background:#fff;border-radius:14px;border:1px solid #e2e8f4;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.04)">`;
        if(fl.length===0){
          h+=`<div style="text-align:center;padding:48px;color:#94a3b8"><div style="font-size:36px;margin-bottom:8px">ğŸ“­</div><div style="font-weight:500">Geen aanvragen gevonden</div></div>`;
        }else{
          h+=`<table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr style="border-bottom:2px solid #e2e8f4">`;
          if(showCheck)h+=`<th style="width:36px;padding:10px 0 10px 14px"><input type="checkbox" ${S.selected.size===pendInView.length&&pendInView.length>0?'checked':''} onchange="raToggleAll()" style="cursor:pointer"/></th>`;
          ['Medewerker','Afdeling','Saldo verlof','Saldo ADV','Afwezigheidstype','Periode','Dagen','Status','Conflicten',''].forEach((hd,i)=>{
            h+=`<th style="text-align:${i===9?'right':'left'};padding:10px 12px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#94a3b8">${hd}</th>`;
          });
          h+=`</tr></thead><tbody>`;
          fl.forEach(r=>{
            const n=raGN(r.personId),t=raGT(r.type),conflicts=raConflicts(r),isSel=S.selected.has(r.id);
            const stMap={pending:['#fef3c7','#92400e','â³ Openstaand'],approved:['#dcfce7','#166534','âœ… Goedgekeurd'],rejected:['#fee2e2','#991b1b','âŒ Geweigerd']};
            const[sbg,sc,sl]=stMap[r.status]||stMap.pending;
            // Saldo berekening
            const person=pp.find(x=>x.id===r.personId);
            let saldoVerlof='â€”',saldoAdv='â€”';
            if(person){
              const wettelijk=leaveTypes.find(x=>x.id==='wettelijk');
              const adv=leaveTypes.find(x=>x.id==='adv');
              if(wettelijk&&wettelijk.tracked){
                const tot=getAllowanceForType(person,wettelijk.id);
                const used=getUsedDays(person.id,wettelijk.id);
                saldoVerlof=(tot-used)+'d';
              }
              if(adv&&adv.tracked){
                const tot=getAllowanceForType(person,adv.id);
                const used=getUsedDays(person.id,adv.id);
                saldoAdv=(tot-used)+'d';
              }
            }
            h+=`<tr class="${isSel?'ra-sel':''}" style="border-bottom:1px solid #f1f5f9">`;
            if(showCheck)h+=`<td style="padding:10px 0 10px 14px">${r.status==='pending'?`<input type="checkbox" ${isSel?'checked':''} onchange="raToggle('${r.id}')" style="cursor:pointer"/>`:''}</td>`;
            h+=`<td style="padding:10px 12px;cursor:pointer" onclick="event.stopPropagation();window._fromRequests=true;openPersonModal('${r.personId}')"><div style="display:flex;align-items:center;gap:8px">
              <div style="width:30px;height:30px;border-radius:50%;background:${raColor(n)};display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;font-weight:700;flex-shrink:0">${raIni(n)}</div>
              <div><div style="font-weight:600;font-size:13px">${n}</div>${r.comment?`<div style="font-size:11px;color:#94a3b8;margin-top:1px">ğŸ’¬ ${r.comment}</div>`:''}</div>
            </div></td>`;
            h+=`<td style="padding:10px 12px;color:#64748b;font-size:12px">${raGD(r.personId)}</td>`;
            h+=`<td style="padding:10px 12px;font-size:12px;font-weight:600;color:${parseFloat(saldoVerlof)<=3?'#ef4444':parseFloat(saldoVerlof)<=10?'#eab308':'#22c55e'}">${saldoVerlof}</td>`;
            h+=`<td style="padding:10px 12px;font-size:12px;font-weight:600;color:${parseFloat(saldoAdv)<=1?'#ef4444':parseFloat(saldoAdv)<=3?'#eab308':'#22c55e'}">${saldoAdv}</td>`;
            h+=`<td style="padding:10px 12px"><span style="background:${t.color}15;color:${t.color};padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600">${t.symbol} ${t.name}</span></td>`;
            h+=`<td style="padding:10px 12px;font-size:12px;white-space:nowrap;color:#475569">${raFD(r.startDate)}${r.startDate!==r.endDate?' â†’ '+raFD(r.endDate):''}</td>`;
            h+=`<td style="padding:10px 12px;font-weight:600;font-size:13px">${r.halfDay?'Â½ dag ('+(r.halfDayPeriod||'')+')':((r.days||1)+'d')}</td>`;
            h+=`<td style="padding:10px 12px"><span style="background:${sbg};color:${sc};padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;white-space:nowrap">${sl}</span></td>`;
            h+=`<td style="padding:10px 12px">${conflicts.length>0?
              `<span onclick="event.stopPropagation();raDetail('${r.id}')" style="background:#fef3c7;color:#92400e;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;cursor:pointer">âš ï¸ ${conflicts.length}</span>`:
              '<span style="color:#cbd5e1;font-size:12px">â€”</span>'}</td>`;
            h+=`<td style="padding:10px 12px;text-align:right"><div style="display:flex;gap:4px;justify-content:flex-end">`;
            if(r.status==='pending'){
              h+=`<button onclick="raAction('${r.id}','approved')" title="Goedkeuren" style="width:30px;height:30px;border-radius:8px;border:none;background:#dcfce7;color:#166534;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center">âœ…</button>`;
              h+=`<button onclick="raAction('${r.id}','rejected')" title="Weigeren" style="width:30px;height:30px;border-radius:8px;border:none;background:#fee2e2;color:#991b1b;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center">âŒ</button>`;
            }
            h+=`<button onclick="raDetail('${r.id}')" title="Detail" style="width:30px;height:30px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center">ğŸ‘</button>`;
            h+=`</div></td></tr>`;
          });
          h+=`</tbody></table>`;
        }
        h+=`</div><div style="margin-top:8px;font-size:11px;color:#94a3b8;display:flex;justify-content:space-between">
          <span>${fl.length} aanvra${fl.length===1?'ag':'gen'}</span>
          <span style="display:flex;align-items:center;gap:6px">
            <span style="width:7px;height:7px;border-radius:50%;background:${typeof firebaseReady!=='undefined'&&firebaseReady?'#22c55e':'#eab308'}"></span>
            ${typeof firebaseReady!=='undefined'&&firebaseReady?'Firebase sync actief':'Verbinden...'}
            Â· Personeelbeheer Â· Advanced Energy
          </span>
        </div></div>`;

        // Detail modal
        if(S.detail){
          const r=S.reqs.find(x=>x.id===S.detail);
          if(r){
            const t=raGT(r.type),conflicts=raConflicts(r);
            const[sbg,sc,sl]=({pending:['#fef3c7','#92400e','â³ Openstaand'],approved:['#dcfce7','#166534','âœ… Goedgekeurd'],rejected:['#fee2e2','#991b1b','âŒ Geweigerd']})[r.status]||['#fef3c7','#92400e','â³'];
            h+=`<div onclick="raCloseDetail()" style="position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:500;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(2px)">
              <div onclick="event.stopPropagation()" style="background:#fff;border-radius:14px;padding:24px;width:420px;max-width:90vw;box-shadow:0 20px 60px rgba(0,0,0,.15)">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                  <h3 style="margin:0;font-size:16px;font-weight:700">Aanvraag detail</h3>
                  <button onclick="raCloseDetail()" style="width:28px;height:28px;border-radius:50%;border:1px solid #e2e8f0;background:#fff;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center">âœ•</button>
                </div>
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
                  <div style="width:40px;height:40px;border-radius:50%;background:${raColor(raGN(r.personId))};display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:700">${raIni(raGN(r.personId))}</div>
                  <div><div style="font-weight:600;font-size:15px">${raGN(r.personId)}</div><div style="font-size:12px;color:#64748b">${raGD(r.personId)}</div></div>
                  <div style="margin-left:auto"><span style="background:${sbg};color:${sc};padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600">${sl}</span></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
                  <div style="background:#f8fafc;border-radius:8px;padding:10px 12px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#94a3b8;margin-bottom:4px">Type</div><span style="background:${t.color}15;color:${t.color};padding:2px 8px;border-radius:6px;font-size:12px">${t.symbol} ${t.name}</span></div>
                  <div style="background:#f8fafc;border-radius:8px;padding:10px 12px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#94a3b8;margin-bottom:4px">Periode</div><span style="font-size:13px">${raFD(r.startDate)}${r.startDate!==r.endDate?' â†’ '+raFD(r.endDate):''}</span></div>
                  <div style="background:#f8fafc;border-radius:8px;padding:10px 12px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#94a3b8;margin-bottom:4px">Dagen</div><span style="font-weight:600">${r.halfDay?'Â½ dag ('+(r.halfDayPeriod||'')+')':((r.days||1)+'d')}</span></div>
                  <div style="background:#f8fafc;border-radius:8px;padding:10px 12px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#94a3b8;margin-bottom:4px">Opmerking</div><span style="font-size:12px;color:${r.comment?'#334155':'#94a3b8'}">${r.comment||'â€”'}</span></div>
                </div>`;
            if(conflicts.length>0){
              h+=`<div style="background:#fef3c7;border:1px solid #fde68a;border-radius:8px;padding:12px;margin-bottom:16px">
                <div style="font-size:11px;font-weight:700;color:#92400e;margin-bottom:6px">âš ï¸ ${conflicts.length} conflict${conflicts.length>1?'en':''}</div>
                ${conflicts.map(c=>`<div style="font-size:12px;color:#78350f;margin-bottom:2px">${c}</div>`).join('')}
              </div>`;
            }
            if(r.status==='pending'){
              h+=`<div style="display:flex;gap:8px">
                <button onclick="raAction('${r.id}','approved');raCloseDetail()" style="flex:1;padding:9px 0;border-radius:8px;border:none;background:#dcfce7;color:#166534;font-size:13px;font-weight:600;cursor:pointer">âœ… Goedkeuren</button>
                <button onclick="raCloseDetail();raAction('${r.id}','rejected')" style="flex:1;padding:9px 0;border-radius:8px;border:none;background:#fee2e2;color:#991b1b;font-size:13px;font-weight:600;cursor:pointer">âŒ Weigeren</button>
              </div>`;
            }
            h+=`</div></div>`;
          }
        }

        app.innerHTML=h;
      }

      // Global functions
      window.raSetTab=function(t){raState.tab=t;raState.filter=t==='ziekte'?'all':'pending';raState.search='';raState.dept='';raRender();};
      window.raSetFilter=function(f){raState.filter=f;raRender();};
      window.raSetDept=function(d){raState.dept=d;raRender();};
      window.raSetSearch=function(q){raState.search=q;raRender();};
      window.raToggle=function(id){if(raState.selected.has(id))raState.selected.delete(id);else raState.selected.add(id);raRender();};
      window.raToggleAll=function(){
        const pp=raPeople();const nonS=raState.reqs.filter(r=>r.type!=='ziekte');
        let fl=nonS;if(raState.filter!=='all')fl=fl.filter(r=>r.status===raState.filter);
        const pending=fl.filter(r=>r.status==='pending');
        if(raState.selected.size===pending.length)raState.selected=new Set();
        else raState.selected=new Set(pending.map(r=>r.id));
        raRender();
      };
      window.raClearSel=function(){raState.selected=new Set();raRender();};
      window.raAction=raAction;
      window.raBulk=raBulk;
      window.raDetail=function(id){raState.detail=id;raRender();};
      window.raCloseDetail=function(){raState.detail=null;raRender();};

      // Expose render for external calls
      window.renderRequests=function(){
        // Sync van globale requests als die bestaan
        if(typeof requests!=='undefined'&&requests.length>0)raState.reqs=requests.map(r=>({...r}));
        raRender();
      };

      // Initial render
      raRender();
    })();
    </script>
  </div>
  <!-- Ziekte -->
  <div class="panel" id="page-sickness">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Ziekte</div><div class="page-subtitle">Ziekmeldingen en doktersbriefjes</div></div>
        <button class="btn btn-sm btn-primary-outline" onclick="openSicknessModal()">â• Ziekmelding registreren</button>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="filterSickness('active',this)">ğŸ¤’ Actief ziek</button>
        <button class="tab" onclick="filterSickness('all',this)">Alle meldingen</button>
      </div>
      <div class="card">
        <table class="tbl">
          <thead><tr><th>Medewerker</th><th>Van</th><th>Tot</th><th>Dagen</th><th>Briefje</th><th>Notificaties</th><th></th></tr></thead>
          <tbody id="sickness-table"></tbody>
        </table>
      </div>
      <div class="card" style="margin-top:16px">
        <div class="card-title">ğŸ“Š Bradford Factor <span style="font-weight:400;font-size:11px;color:var(--text3)">(SÂ² Ã— D â€” rollende 52 weken)</span></div>
        <table class="tbl">
          <thead><tr>
            <th>Medewerker</th><th>Periodes (S)</th><th>Totaal dagen (D)</th>
            <th style="cursor:pointer;user-select:none" onclick="sortBradford()">Bradford Score <span id="sort-bradford" style="display:inline-block;width:12px;text-align:center">â†“</span></th>
            <th>Risico</th>
          </tr></thead>
          <tbody id="bradford-table"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Rapportage -->
  <div class="panel" id="page-organigram">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div><div class="page-title">Organigram</div><div class="page-subtitle">Organisatiestructuur</div></div>
      <button class="btn btn-sm btn-primary-outline" onclick="exportOrganigramPDF()">ğŸ“„ Export PDF</button>
    </div>
    <div class="card" id="organigram-container" style="padding:32px;overflow-x:auto;background:#fff;min-height:500px"></div>
  </div>

  <div class="panel" id="page-reports">
    <div class="page">
      <div class="page-header">
        <div><div class="page-title">Rapportage</div><div class="page-subtitle" id="rp-year-label">Overzichten 2026</div></div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-sm" onclick="exportReportCSV()">ğŸ“Š CSV Export</button>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="showReportTab('overview',this)">ğŸ“Š Jaaroverzicht</button>
        <button class="tab" onclick="showReportTab('perPerson',this)">ğŸ‘¤ Per medewerker</button>
        <button class="tab" onclick="showReportTab('perType',this)">ğŸ·ï¸ Per type</button>
        <span style="border-left:1px solid var(--border);margin:4px 8px"></span>
        <button class="tab" onclick="showReportTab('accidents',this)">âš ï¸ Arbeidsongevallen</button>
      </div>
      <!-- Jaaroverzicht -->
      <div id="report-overview" class="report-panel">
        <div class="card-grid card-grid-4" style="margin-bottom:16px">
          <div class="card"><div class="stat"><div class="stat-value" id="rp-total-days">0</div><div class="stat-label">Totaal opgenomen</div></div></div>
          <div class="card"><div class="stat"><div class="stat-value" id="rp-total-sick" style="color:var(--danger)">0</div><div class="stat-label">Ziektedagen</div></div></div>
          <div class="card"><div class="stat"><div class="stat-value" id="rp-total-extern" style="color:var(--warn)">0</div><div class="stat-label">Extern (opgelegd)</div></div></div>
          <div class="card"><div class="stat"><div class="stat-value" id="rp-avg-per-person" style="color:var(--accent)">0</div><div class="stat-label">Gem. per medewerker</div></div></div>
        </div>
        <div class="card-grid card-grid-2">
          <div class="card">
            <div class="card-title">ğŸ“Š Afwezigheden per maand</div>
            <div id="rp-chart-legend" style="display:flex;gap:12px;font-size:11px;margin-bottom:8px"></div>
            <div style="display:flex;gap:2px">
              <div id="rp-chart-axis" style="display:flex;flex-direction:column;justify-content:space-between;width:28px;font-size:9px;color:var(--text3);text-align:right;padding:0 4px 18px 0"></div>
              <div style="flex:1">
                <div id="rp-month-chart" style="display:flex;align-items:flex-end;gap:3px;height:140px;padding:0;border-bottom:1px solid var(--border);border-left:1px solid var(--border)"></div>
                <div id="rp-month-labels" style="display:flex;gap:3px;font-size:10px;color:var(--text3);padding-top:4px"></div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">ğŸ·ï¸ Verdeling per type</div>
            <div id="rp-type-donut"></div>
          </div>
        </div>
      </div>
      <!-- Per medewerker -->
      <div id="report-perPerson" class="report-panel" style="display:none">
        <div class="card">
          <table class="tbl">
            <thead>
              <tr>
                <th rowspan="2" style="vertical-align:bottom">Medewerker</th>
                <th rowspan="2" style="vertical-align:bottom">Department</th>
                <th colspan="4" style="text-align:center;border-bottom:2px solid var(--accent);color:var(--accent);font-size:11px">WETTELIJK VERLOF</th>
                <th rowspan="2" style="vertical-align:bottom;text-align:center">Afwezigheid</th>
                <th rowspan="2" style="vertical-align:bottom;text-align:center">Ziektedagen</th>
              </tr>
              <tr>
                <th style="text-align:center">Recht</th>
                <th style="text-align:center">Opgenomen</th>
                <th style="text-align:center">Gepland</th>
                <th style="text-align:center">Resterend</th>
              </tr>
            </thead>
            <tbody id="rp-person-table"></tbody>
          </table>
        </div>
      </div>
      <!-- Per type -->
      <div id="report-perType" class="report-panel" style="display:none">
        <div class="card">
          <table class="tbl">
            <thead><tr><th>Type</th><th>Categorie</th><th>Totaal dagen</th><th>Aantal aanvragen</th><th>Gem. duur</th></tr></thead>
            <tbody id="rp-type-table"></tbody>
          </table>
        </div>
      </div>
      <!-- Arbeidsongevallen -->
      <div id="report-accidents" class="report-panel" style="display:none">
        <div class="card" style="margin-bottom:16px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <div>
              <div class="card-title" style="margin-bottom:4px">âš ï¸ Arbeidsongevallen â€” FOD statistieken</div>
              <div style="font-size:11px;color:var(--text3)">Frequentiegraad en ernstgraad volgens de officiÃ«le FOD Werkgelegenheid formules</div>
            </div>
            <button class="btn btn-sm btn-primary-outline" onclick="openAccidentModal()">â• Ongeval registreren</button>
          </div>
          <div style="margin-bottom:16px;padding:12px;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid var(--border)">
            <div style="font-weight:700;font-size:12px;margin-bottom:8px">ğŸ“‹ Basisgegevens (van sociaal secretariaat)</div>
            <div class="form-row">
              <div class="form-group" style="flex:1">
                <label class="form-label">Totaal gepresteerde uren (jaar)</label>
                <input type="number" class="form-input" id="acc-total-hours" placeholder="Bv. 85000" value="" oninput="renderAccidentStats()"/>
              </div>
              <div class="form-group" style="flex:1">
                <label class="form-label">Jaar</label>
                <select class="form-input" id="acc-year" onchange="renderAccidentStats()" style="width:120px"></select>
              </div>
            </div>
          </div>
          <div class="card-grid card-grid-4" style="margin-bottom:16px" id="acc-stats-cards"></div>
          <div id="acc-table-container"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Modal container -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-title"><span id="modal-title-text"></span><span id="modal-title-actions" style="display:flex;gap:6px;margin-left:auto;margin-right:8px"></span><button class="modal-close" onclick="closeModal()">âœ•</button></div>
    <div id="modal-body" class="modal-body"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
// â•â•â• DATA & CONFIG â•â•â•

const AVATARCOLORS=['#3b82f6','#22c55e','#a855f7','#ef4444','#eab308','#ec4899','#06b6d4','#f97316'];

const DEFAULT_TYPES=[
  // Verlof (verlofsaldo)
  {id:'wettelijk',name:'Wettelijk verlof',color:'#3b82f6',symbol:'ğŸ–ï¸',paid:true,tracked:true,absenceTracked:false,mobile:true,defaultDays:20,maxDays:0,category:'verlof'},
  {id:'adv',name:'ADV',color:'#22c55e',symbol:'ğŸ“…',paid:true,tracked:true,absenceTracked:false,mobile:true,defaultDays:12,maxDays:0,category:'adv'},
  {id:'ancienniteit',name:'AnciÃ«nniteitsverlof',color:'#10b981',symbol:'ğŸ…',paid:true,tracked:true,absenceTracked:false,mobile:false,defaultDays:0,maxDays:0,category:'verlof'},
  // Afwezigheid (afwezigheidssaldo)
  {id:'onbetaald',name:'Onbetaald verlof',color:'#94a3b8',symbol:'âšª',paid:false,tracked:false,absenceTracked:true,mobile:false,defaultDays:0,maxDays:0,category:'afwezigheid'},
  {id:'opleiding',name:'Opleiding',color:'#a855f7',symbol:'ğŸ“š',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:0,maxDays:0,category:'afwezigheid'},
  {id:'huwelijk',name:'Huwelijk medewerker',color:'#ec4899',symbol:'ğŸ’’',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:2,maxDays:2,category:'afwezigheid'},
  {id:'huwelijk-kind',name:'Huwelijk kind',color:'#ec4899',symbol:'ğŸ’',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:1,maxDays:1,category:'afwezigheid'},
  {id:'overlijden-1',name:'Overlijden partner/kind',color:'#374151',symbol:'ğŸ•¯ï¸',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:10,maxDays:10,category:'afwezigheid'},
  {id:'overlijden-2',name:'Overlijden ouder/schoonouder',color:'#374151',symbol:'ğŸ•¯ï¸',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:3,maxDays:3,category:'afwezigheid'},
  {id:'overlijden-3',name:'Overlijden broer/zus/schoon-',color:'#6b7280',symbol:'ğŸ•¯ï¸',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:2,maxDays:2,category:'afwezigheid'},
  {id:'geboorte',name:'Geboorteverlof',color:'#06b6d4',symbol:'ğŸ‘¶',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:20,maxDays:20,category:'afwezigheid'},
  {id:'ouderschaps',name:'Ouderschapsverlof',color:'#0891b2',symbol:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§',paid:false,tracked:false,absenceTracked:true,mobile:false,defaultDays:0,maxDays:0,category:'afwezigheid'},
  {id:'communie',name:'Plechtige communie kind',color:'#8b5cf6',symbol:'â›ª',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:1,maxDays:1,category:'afwezigheid'},
  {id:'verhuizing',name:'Verhuizing',color:'#f59e0b',symbol:'ğŸ“¦',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:1,maxDays:1,category:'afwezigheid'},
  {id:'sollicitatie',name:'Sollicitatieverlof',color:'#64748b',symbol:'ğŸ¤',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:0,maxDays:0,category:'afwezigheid'},
  {id:'familiaal',name:'Familiaal verlof',color:'#f472b6',symbol:'ğŸ‘ª',paid:false,tracked:false,absenceTracked:true,mobile:false,defaultDays:10,maxDays:10,category:'afwezigheid'},
  {id:'dokter',name:'Doktersbezoek',color:'#14b8a6',symbol:'ğŸ©º',paid:true,tracked:false,absenceTracked:true,mobile:true,defaultDays:0,maxDays:0,category:'afwezigheid'},
  {id:'juridisch',name:'Juridische verplichting',color:'#78716c',symbol:'âš–ï¸',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:0,maxDays:0,category:'afwezigheid'},
  // Ziekte
  {id:'ziekte',name:'Ziekte',color:'#ef4444',symbol:'ğŸ¤’',paid:true,tracked:false,absenceTracked:true,mobile:true,defaultDays:0,maxDays:0,category:'ziekte'},
  {id:'arbeidsongeval',name:'Arbeidsongeval',color:'#dc2626',symbol:'ğŸš‘',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:0,maxDays:0,category:'ziekte'},
  {id:'hospitalisatie',name:'Hospitalisatie',color:'#b91c1c',symbol:'ğŸ¥',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:0,maxDays:0,category:'ziekte'},
  // Extern (opgelegd)
  {id:'tech-werkloos',name:'Technische werkloosheid',color:'#f97316',symbol:'ğŸ­',paid:false,tracked:false,absenceTracked:true,mobile:false,defaultDays:0,maxDays:0,category:'extern'},
  {id:'weerverlet',name:'Weerverlet',color:'#0369a1',symbol:'ğŸŒ§ï¸',paid:false,tracked:false,absenceTracked:true,mobile:false,defaultDays:0,maxDays:0,category:'extern'},
  {id:'economisch',name:'Economische werkloosheid',color:'#b45309',symbol:'ğŸ“‰',paid:false,tracked:false,absenceTracked:true,mobile:false,defaultDays:0,maxDays:0,category:'extern'},
  {id:'collectief',name:'Collectieve sluiting',color:'#7c3aed',symbol:'ğŸ”’',paid:true,tracked:false,absenceTracked:true,mobile:false,defaultDays:0,maxDays:0,category:'extern'}
];

// â•â•â• DYNAMISCHE BELGISCHE FEESTDAGEN GENERATOR â•â•â•
// Berekent Paaszondag via het Computus-algoritme (Butcher/Meeus)
// en leidt daaruit alle variabele feestdagen af.
// Vaste feestdagen zijn identiek elk jaar.
function computeEasterSunday(year){
  const a=year%19, b=Math.floor(year/100), c=year%100;
  const d=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25);
  const g=Math.floor((b-f+1)/3), h=(19*a+b-d-g+15)%30;
  const i=Math.floor(c/4), k=c%4;
  const l=(32+2*e+2*i-h-k)%7;
  const m=Math.floor((a+11*h+22*l)/451);
  const month=Math.floor((h+l-7*m+114)/31);
  const day=((h+l-7*m+114)%31)+1;
  return new Date(year,month-1,day);
}
function pad2(n){return String(n).padStart(2,'0');}
function isoDate(d){return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate());}
function addDays(d,n){const r=new Date(d);r.setDate(r.getDate()+n);return r;}

function generateBEHolidays(year){
  const easter=computeEasterSunday(year);
  const paasmaandag=addDays(easter,1);
  const hemelvaart=addDays(easter,39);
  const pinkstermaandag=addDays(easter,50);
  return [
    {date:year+'-01-01',name:'Nieuwjaar',all:true},
    {date:isoDate(paasmaandag),name:'Paasmaandag',all:true},
    {date:year+'-05-01',name:'Dag van de Arbeid',all:true},
    {date:isoDate(hemelvaart),name:'O.L.H. Hemelvaart',all:true},
    {date:isoDate(pinkstermaandag),name:'Pinkstermaandag',all:true},
    {date:year+'-07-11',name:'Vlaamse feestdag',regions:['vlaanderen']},
    {date:year+'-07-21',name:'Nationale feestdag',all:true},
    {date:year+'-08-15',name:'O.L.V. Hemelvaart',all:true},
    {date:year+'-09-27',name:'Franstalige Gemeenschapsdag',regions:['wallonie','brussel']},
    {date:year+'-11-01',name:'Allerheiligen',all:true},
    {date:year+'-11-11',name:'Wapenstilstand',all:true},
    {date:year+'-12-25',name:'Kerstmis',all:true}
  ];
}

// Retourneert altijd feestdagen voor het huidige jaar + vorig jaar
// Op 01/01/2027 verdwijnt 2025 automatisch en verschijnt 2027
function getBEHolidays(){
  const thisYear=new Date().getFullYear();
  return [...generateBEHolidays(thisYear-1),...generateBEHolidays(thisYear)];
}

// Backwards-compatible aliassen zodat bestaande code blijft werken
const BE_HOLIDAYS_2025=generateBEHolidays(2025);
const BE_HOLIDAYS_2026=generateBEHolidays(2026);

const DEFAULT_SCHEDULES=[
  {id:'fulltime',name:'Voltijds (5/5)',daysPerWeek:5,hoursPerDay:8,halfDays:true},
  {id:'fourfifths',name:'4/5 regime',daysPerWeek:4,hoursPerDay:8,halfDays:true},
  {id:'halftime',name:'Halftijds',daysPerWeek:5,hoursPerDay:4,halfDays:false}
];

let currentRole='admin';
let activePage='dashboard';

// Data stores (localStorage backed)
let departments=[];
let people=[];
let leaveTypes=[];
let schedules=[];
let requests=[];
let candidates=[];
let channels=[];

const DEFAULT_CHANNELS=[
  {id:'indeed',name:'Indeed',color:'#2164f3'},
  {id:'linkedin',name:'LinkedIn',color:'#0077b5'},
  {id:'spontaan',name:'Spontaan',color:'#22c55e'},
  {id:'referral',name:'Doorverwijzing',color:'#a855f7'},
  {id:'vdab',name:'VDAB',color:'#ef4444'},
  {id:'andere',name:'Andere',color:'#94a3b8'}
];
let settings={region:'vlaanderen',yearendMode:'max5',yearendCustomDays:5,
  notifEmail:true,notifSick:true};

// Verlofregels per department
let verlofregels=[];

// Onboarding checklist items (beheerbaar via Instellingen)
const DEFAULT_CHECKLIST_ITEMS=[
  {id:'cl_1',section:'IT & Hardware',name:'Toegangssleutel',active:true,order:1},
  {id:'cl_2',section:'IT & Hardware',name:'PC',active:true,order:2},
  {id:'cl_3',section:'IT & Hardware',name:'Schermen',active:true,order:3},
  {id:'cl_4',section:'IT & Hardware',name:'Muis en keyboard',active:true,order:4},
  {id:'cl_5',section:'Software & Accounts',name:'Plenion',active:true,order:5},
  {id:'cl_6',section:'Software & Accounts',name:'Keeper',active:true,order:6},
  {id:'cl_7',section:'Telefonie & hardware',name:'Extra schermen',active:true,order:7},
  {id:'cl_8',section:'Telefonie & hardware',name:'Aanpassing telefonie keuzemenu (planning â€“ verkoop â€“ technisch â€“ overig)',active:true,order:8},
  {id:'cl_9',section:'Teamtel',name:'Bestellen HP Elitebook',active:true,order:9},
  {id:'cl_10',section:'Teamtel',name:'Bestellen Jabra Headset + aansluiten op computer',active:true,order:10},
  {id:'cl_11',section:'Teamtel',name:'Microsoft licentie',active:true,order:11},
  {id:'cl_12',section:'Teamtel',name:'Aanmaken gebruiker in Outlook',active:true,order:12},
  {id:'cl_13',section:'Teamtel',name:'Configuratie Keeper',active:true,order:13},
  {id:'cl_14',section:'Teamtel',name:'Gebruiker + configuratie in 3CX telefooncentrale',active:true,order:14},
  {id:'cl_15',section:'Teamtel',name:'Configuratie HP printer - printen + scannen',active:true,order:15},
  {id:'cl_16',section:'Teamtel',name:'Installatie Acrobat Reader',active:true,order:16},
  {id:'cl_17',section:'Teamtel',name:'Directory AE',active:true,order:17},
  {id:'cl_18',section:'Outlook',name:'Sharen van de agenda',active:true,order:18},
  {id:'cl_19',section:'Outlook',name:'Handtekening',active:true,order:19},
  {id:'cl_20',section:'Keeper',name:'Wachtwoorden delen',active:true,order:20},
  {id:'cl_21',section:'Daikin',name:'Account aanmaken',active:true,order:21},
  {id:'cl_22',section:'Plenion',name:'Aanvraag Plenion licentie',active:true,order:22},
  {id:'cl_23',section:'Plenion',name:'Aanmaken personeelslid + toekennen juiste rol',active:true,order:23},
  {id:'cl_24',section:'Plenion',name:'Vakantiegoedkeuring',active:true,order:24},
  {id:'cl_25',section:'Plenion',name:'Linken met Outlook',active:true,order:25},
  {id:'cl_26',section:'Office',name:'Toekennen bureau',active:true,order:26},
  {id:'cl_27',section:'Office',name:'Aankoop bureau materiaal â€“ Schaar, balpen, fluo, nietjes machine + nietjes, perforator, tipp-ex, plakband, schriftje, lat/geodriehoek',active:true,order:27},
  {id:'cl_28',section:'HR',name:'Inlichtingenfiche',active:true,order:28},
  {id:'cl_29',section:'HR',name:'Verlofmap',active:true,order:29},
  {id:'cl_30',section:'HR',name:'Welkom kaartje opsturen "welkom in ons team â€¦ ! We kijken ernaar uit."',active:true,order:30},
  {id:'cl_31',section:'Administratie & verzekeringen',name:'Mensura werkpostfiche',active:true,order:31},
  {id:'cl_32',section:'Administratie & verzekeringen',name:'Payroll SDWorx',active:true,order:32},
  {id:'cl_33',section:'Administratie & verzekeringen',name:'Aansluiten DKV verzekering',active:true,order:33},
  {id:'cl_34',section:'Administratie & verzekeringen',name:'Aansluiten AXA verzekering',active:true,order:34},
  {id:'cl_35',section:'Administratie & verzekeringen',name:'Arbeidsovereenkomst',active:true,order:35}
];
let checklistItems=[];
let accidents=[];
let accidentSettings={totalHours:{}};
const DEFAULT_VERLOFREGELS=[
  {id:'max-afwezig',label:'Max. gelijktijdig afwezig',desc:'Maximum aantal medewerkers dat tegelijk afwezig mag zijn binnen een department',icon:'ğŸš«',perDept:true,defaults:{}},
  {id:'max-opeenvolgend',label:'Max. opeenvolgende verlofdagen',desc:'Maximum aantal aaneensluitende verlofdagen per aanvraag',icon:'ğŸ“…',perDept:false,value:15},
  {id:'min-vooraf',label:'Min. dagen op voorhand',desc:'Minimum aantal werkdagen dat een aanvraag op voorhand moet worden ingediend',icon:'â°',perDept:false,value:5}
];

// Barema PC 149.01 data
const BAREMA_CATEGORIES=[
  {id:'A',name:'Hulpwerkman',desc:'Geen of beperkte vakkennis. Voert eenvoudige taken uit onder toezicht.'},
  {id:'B',name:'Geoefend werkman 2e cat.',desc:'Bezit basisvaardigheden door ervaring of korte opleiding.'},
  {id:'C',name:'Geoefend werkman 1e cat.',desc:'Kan eenvoudige vakkundige werkzaamheden zelfstandig uitvoeren.'},
  {id:'D',name:'Geschoolde arbeider 3e cat.',desc:'Gekwalificeerd vakman. Voert vakkundige werken zelfstandig uit.'},
  {id:'E',name:'Geschoolde arbeider 2e cat.',desc:'Ervaren vakman. Werkt zelfstandig op basis van plan en lastenboek.'},
  {id:'F',name:'Geschoolde arbeider 1e cat.',desc:'Hoogst gekwalificeerd. Geeft leiding, controleert, past plannen aan.'}
];
let baremaData=[];  // [{date:'2026-01-01', rates:{A:15.82,B:16.41,...}}]

// AnciÃ«nniteit PC 149.01: +1% na 1j, +0.5%/j vanaf 2j, max 13%
let ancienniteitData=[];  // [{years:0,pct:0},{years:1,pct:1.00},...]

// Salaris mutatie-types (admin-uitbreidbaar)
let salaryReasonTypes=[
  {id:'start',name:'Startsalaris',icon:'ğŸŸ¢',system:true},
  {id:'index',name:'Indexatie',icon:'ğŸ“ˆ',system:true},
  {id:'ancienniteit',name:'AnciÃ«nniteit',icon:'ğŸ–',system:true},
  {id:'ervaring',name:'Ervaring',icon:'â­',system:false},
  {id:'promotie',name:'Promotie',icon:'ğŸš€',system:false},
  {id:'diploma',name:'Diploma',icon:'ğŸ“',system:false}
];

// Werkgeverskost componenten PC 149.01 arbeiders
let werkgeverskostData=[
  {id:'rsz',name:'RSZ werkgever',pct:30.57,editable:true},
  {id:'vakantie-trim',name:'Jaarlijkse vakantie (trimestrieel)',pct:5.57,editable:true},
  {id:'vakantie-jaar',name:'Jaarlijkse vakantie (jaarlijks)',pct:10.27,editable:true},
  {id:'eindejaar',name:'Eindejaarspremie',pct:8.33,editable:true},
  {id:'arbeidsongevallen',name:'Arbeidsongevallenverzekering',pct:2.50,editable:true},
  {id:'fbz',name:'FBZ (Fonds bestaanszekerheid)',pct:5.00,editable:true},
  {id:'sap',name:'Aanvullend pensioen (SAP)',pct:1.10,editable:true}
];

// Uurkost parameters
let uurkostParams={
  werkdagenJaar:260,
  verlofDagen:20,
  feestdagen:10,
  advDagen:12,
  urenPerDag:8
};

// â•â•â• CORE (data-helpers, autoSave, restore) â•â•â•


const SALARY_TYPE_START='start';

function formatPhone(val){
  if(!val)return '';
  var digits=val.replace(/[^\d+]/g,'');
  var hasPlus=digits.startsWith('+');
  digits=digits.replace(/\+/g,'');
  if(hasPlus&&digits.startsWith('32'))digits=digits.substring(2);
  else if(!hasPlus&&digits.startsWith('0032'))digits=digits.substring(4);
  if(digits.startsWith('0'))digits=digits.substring(1);
  if(digits.length===0)return '';
  // Belgische nummers: 9 cijfers (GSM 4xx) of 8 cijfers (vast)
  // 1-cijfer zonecodes: 2(Brussel),3(Antwerpen),4(Luik),9(Gent)
  var singleZone=['2','3','4','9'];
  var parts=[];
  if(digits.length===9&&digits.charAt(0)==='4'){
    // GSM: 4xx xx xx xx
    parts=[digits.substring(0,3),digits.substring(3,5),digits.substring(5,7),digits.substring(7,9)];
  } else if(digits.length===8&&singleZone.indexOf(digits.charAt(0))!==-1){
    // Vast 1-cijfer zone: x xxx xx xx
    parts=[digits.substring(0,1),digits.substring(1,4),digits.substring(4,6),digits.substring(6,8)];
  } else if(digits.length===8){
    // Vast 2-cijfer zone: xx xx xx xx
    parts=[digits.substring(0,2),digits.substring(2,4),digits.substring(4,6),digits.substring(6,8)];
  } else {
    // Onbekend formaat: groepeer van rechts per 2
    var i=digits.length;
    while(i>0){var take=Math.min(2,i);parts.unshift(digits.substring(i-take,i));i-=take;}
  }
  return '+32 '+parts.join(' ');
}

function sanitize(str){
  if(!str)return '';
  const d=document.createElement('div');d.textContent=str;return d.innerHTML;
}

function isValidDate(dateStr){
  if(!dateStr)return false;
  const d=new Date(dateStr);
  return d instanceof Date && !isNaN(d.getTime());
}

function disableBtnTemporarily(btn){
  if(!btn)return;
  btn.disabled=true;btn.style.opacity='.5';
  setTimeout(function(){btn.disabled=false;btn.style.opacity='1';},1000);
}

function uid(){return Date.now().toString(36)+'_'+Math.random().toString(36).substr(2,5);}

function autoSave(){
  try{
    if(typeof localStorage==='undefined')return;
    localStorage.setItem('vb_departments',JSON.stringify(departments));
    localStorage.setItem('vb_people',JSON.stringify(people));
    localStorage.setItem('vb_leaveTypes',JSON.stringify(leaveTypes));
    localStorage.setItem('vb_schedules',JSON.stringify(schedules));
    localStorage.setItem('vb_requests',JSON.stringify(requests));
    localStorage.setItem('vb_candidates',JSON.stringify(candidates));
    localStorage.setItem('vb_channels',JSON.stringify(channels));
    localStorage.setItem('vb_settings',JSON.stringify(settings));
    localStorage.setItem('vb_checklistItems',JSON.stringify(checklistItems));
    localStorage.setItem('vb_accidents',JSON.stringify(accidents));
    localStorage.setItem('vb_accidentSettings',JSON.stringify(accidentSettings));
    localStorage.setItem('vb_barema',JSON.stringify(baremaData));
    localStorage.setItem('vb_ancienniteit',JSON.stringify(ancienniteitData));
    localStorage.setItem('vb_salaryReasons',JSON.stringify(salaryReasonTypes));
    localStorage.setItem('vb_werkgeverskost',JSON.stringify(werkgeverskostData));
    localStorage.setItem('vb_uurkostParams',JSON.stringify(uurkostParams));
    localStorage.setItem('vb_verlofregels',JSON.stringify(verlofregels));
  }catch(e){}
}

function restore(){
  try{
    const d=localStorage.getItem('vb_departments');if(d)departments=JSON.parse(d);
    const p=localStorage.getItem('vb_people');if(p)people=JSON.parse(p);
    const t=localStorage.getItem('vb_leaveTypes');if(t)leaveTypes=JSON.parse(t);
    const s=localStorage.getItem('vb_schedules');if(s)schedules=JSON.parse(s);
    const r=localStorage.getItem('vb_requests');if(r)requests=JSON.parse(r);
    const ca=localStorage.getItem('vb_candidates');if(ca)candidates=JSON.parse(ca);
    const ch=localStorage.getItem('vb_channels');if(ch)channels=JSON.parse(ch);
    const st=localStorage.getItem('vb_settings');if(st)Object.assign(settings,JSON.parse(st));
    const ba=localStorage.getItem('vb_barema');if(ba)baremaData=JSON.parse(ba);
    const anc=localStorage.getItem('vb_ancienniteit');if(anc)ancienniteitData=JSON.parse(anc);
    const sr=localStorage.getItem('vb_salaryReasons');if(sr)salaryReasonTypes=JSON.parse(sr);
    const wk=localStorage.getItem('vb_werkgeverskost');if(wk)werkgeverskostData=JSON.parse(wk);
    const up=localStorage.getItem('vb_uurkostParams');if(up)uurkostParams=JSON.parse(up);
    const vr=localStorage.getItem('vb_verlofregels');if(vr)verlofregels=JSON.parse(vr);
    const cli=localStorage.getItem('vb_checklistItems');if(cli)checklistItems=JSON.parse(cli);
    const acc=localStorage.getItem('vb_accidents');if(acc)accidents=JSON.parse(acc);
    const acs=localStorage.getItem('vb_accidentSettings');if(acs)accidentSettings=JSON.parse(acs);
  }catch(e){console.error('Restore error:',e);}
  if(checklistItems.length===0)checklistItems=DEFAULT_CHECKLIST_ITEMS.map(i=>({...i}));
  // Upgrade path: approverId (string) â†’ approverIds (array)
  departments.forEach(d=>{if(!d.approverIds){d.approverIds=d.approverId?[d.approverId]:[];delete d.approverId;}});
  if(leaveTypes.length===0){leaveTypes=[...DEFAULT_TYPES];}
  else{
    // Add missing default types (upgrade path)
    DEFAULT_TYPES.forEach(dt=>{if(!leaveTypes.find(t=>t.id===dt.id))leaveTypes.push({...dt});});
    // Upgrade: voeg absenceTracked toe aan bestaande types die het nog niet hebben
    const maxDaysDefaults={'huwelijk':2,'huwelijk-kind':1,'overlijden-1':10,'overlijden-2':3,'overlijden-3':2,'geboorte':20,'communie':1,'verhuizing':1,'familiaal':10};
    leaveTypes.forEach(t=>{
      if(typeof t.absenceTracked==='undefined'){t.absenceTracked=!t.tracked;}
      if(typeof t.mobile==='undefined'){t.mobile=['wettelijk','adv','ziekte','dokter'].includes(t.id);}
      if(typeof t.maxDays==='undefined'){t.maxDays=maxDaysDefaults[t.id]||0;}
      // Corrigeer overlijden partner/kind naar 10d (wet 2021)
      if(t.id==='overlijden-1'&&t.defaultDays===3){t.defaultDays=10;t.maxDays=10;}
      // Corrigeer familiaal naar 10d max
      if(t.id==='familiaal'&&t.defaultDays===0){t.defaultDays=10;t.maxDays=10;}
      // Fix onbetaald
      if(t.id==='onbetaald'&&t.tracked){t.tracked=false;t.absenceTracked=true;}
      // Upgrade category: absenceTracked types met category 'verlof' â†’ 'afwezigheid'
      if(t.absenceTracked&&t.category==='verlof'){t.category='afwezigheid';}
    });
  }
  if(schedules.length===0)schedules=DEFAULT_SCHEDULES.map(s=>({...s}));
  if(channels.length===0){channels=[...DEFAULT_CHANNELS];}
  else{DEFAULT_CHANNELS.forEach(dc=>{if(!channels.find(c=>c.id===dc.id))channels.push({...dc});});}
}

function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast toast-'+type+' show';
  setTimeout(()=>t.classList.remove('show'),3000);
}

function fullName(p){return (p.firstName||'')+' '+(p.lastName||'');}
function getInitials(name){return name.split(' ').map(w=>w[0]).join('').toUpperCase().substr(0,2);}
function getChannelName(id){const ch=channels.find(c=>c.id===id);return ch?ch.name:id;}
function getChannelColor(id){const ch=channels.find(c=>c.id===id);return ch?ch.color:'#94a3b8';}
function getAvatarColor(name){let h=0;for(let i=0;i<name.length;i++)h=name.charCodeAt(i)+((h<<5)-h);return AVATARCOLORS[Math.abs(h)%AVATARCOLORS.length];}

function formatDate(d){return new Date(d).toLocaleDateString('nl-BE',{day:'2-digit',month:'2-digit',year:'numeric'});}
function formatDateShort(d){return new Date(d).toLocaleDateString('nl-BE',{day:'numeric',month:'short'});}

// â•â•â• HUB / NAVIGATIE â•â•â•

function highlightCard(cardId){
  var el=document.getElementById(cardId);
  if(!el)return;
  el.scrollIntoView({behavior:'smooth',block:'center'});
  el.style.transition='box-shadow .2s, transform .2s';
  el.style.boxShadow='0 0 0 3px var(--accent)';
  el.style.transform='scale(1.02)';
  setTimeout(function(){
    el.style.boxShadow='';
    el.style.transform='';
  },1500);
}

function showPage(page){
  // Always close any open modal first
  closeModal();
  // P8: Clear bulk selection state
  document.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
  activePage=page;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.querySelectorAll('.sb-item').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(b=>{
    if(b.onclick&&b.onclick.toString().includes("'"+page+"'"))b.classList.add('active');
  });
  if(page==='people'){renderPeople();const b=document.getElementById('btn-new-person');if(b)b.style.display=canCreate()?'':'none';}
  if(page==='departments')renderDepartments();
  if(page==='types')renderTypes();
  if(page==='settings')renderSettings();
  if(page==='dashboard')renderDashboard();
  if(page==='requests')renderRequests();
  if(page==='sickness')renderSickness();
  if(page==='wallchart')renderWallchart();
  if(page==='reports')renderReports();
}

function setRole(role,btn){
  currentRole=role;
  document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  showToast('Rol gewijzigd naar: '+role,'success');
}

function showSettingsTab(tab,btn){
  document.querySelectorAll('.settings-panel').forEach(p=>p.style.display='none');
  document.getElementById('settings-'+tab).style.display='block';
  btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  if(tab==='barema')renderBarema();
  if(tab==='ancienniteit')renderAncienniteit();
  if(tab==='checklist')renderChecklistSettings();
}

function closeModal(){document.getElementById('modal-overlay').classList.remove('show');}

let _confirmResolve=null;
function confirmDialog(msg){
  return new Promise(resolve=>{
    _confirmResolve=resolve;
    const overlay=document.createElement('div');
    overlay.id='confirm-overlay';
    overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:10001';
    overlay.innerHTML=`<div style="background:#fff;border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)">
      <div style="font-size:14px;line-height:1.5;margin-bottom:20px;white-space:pre-line">${msg}</div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" onclick="resolveConfirm(false)">Annuleren</button>
        <button class="btn btn-primary" onclick="resolveConfirm(true)">Bevestigen</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
  });
}
function resolveConfirm(val){
  const el=document.getElementById('confirm-overlay');
  if(el)el.remove();
  if(_confirmResolve)_confirmResolve(val);
  _confirmResolve=null;
}

let _promptResolve=null;
function promptDialog(msg,placeholder){
  return new Promise(resolve=>{
    _promptResolve=resolve;
    const overlay=document.createElement('div');
    overlay.id='prompt-overlay';
    overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:10001';
    overlay.innerHTML=`<div style="background:#fff;border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)">
      <div style="font-size:14px;line-height:1.5;margin-bottom:12px">${msg}</div>
      <input class="form-input" id="prompt-input" placeholder="${placeholder||''}" style="margin-bottom:16px"/>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" onclick="resolvePrompt(null)">Annuleren</button>
        <button class="btn btn-primary" onclick="resolvePrompt(document.getElementById('prompt-input').value)">OK</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
    setTimeout(()=>{const inp=document.getElementById('prompt-input');if(inp)inp.focus();},50);
  });
}
function resolvePrompt(val){
  const el=document.getElementById('prompt-overlay');
  if(el)el.remove();
  if(_promptResolve)_promptResolve(val);
  _promptResolve=null;
}

function openModal(title,html,wide){
  const modal=document.querySelector('.modal');
  modal.classList.toggle('modal-wide',!!wide);
  document.getElementById('modal-title-text').textContent=title;
  document.getElementById('modal-title-actions').innerHTML='';
  document.getElementById('modal-body').innerHTML=html;
  document.getElementById('modal-overlay').classList.add('show');
  const firstInput=document.querySelector('#modal-body input,#modal-body select');
  if(firstInput)setTimeout(()=>firstInput.focus(),100);
}

// â•â•â• RENDERING â•â•â•

let peopleTab='employees';
let candSearch='';

function showPeopleTab(tab,btn){
  peopleTab=tab;
  document.getElementById('people-tab-employees').style.display=tab==='employees'?'block':'none';
  document.getElementById('people-tab-candidates').style.display=tab==='candidates'?'block':'none';
  btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  const actions=document.getElementById('people-header-actions');
  if(tab==='employees'){
    actions.innerHTML=canCreate()?'<button class="btn btn-sm btn-primary-outline" onclick="openPersonModal()">â• Medewerker toevoegen</button>':'';
    document.getElementById('people-title').textContent='Medewerkers';
    renderPeople();
  }else{
    actions.innerHTML=canCreate()?'<button class="btn btn-sm btn-primary-outline" onclick="openCandidateModal()">â• Kandidaat toevoegen</button>':'';
    document.getElementById('people-title').textContent='Kandidaten';
    renderCandidates();
  }
}

function renderCandidates(){
  const tbody=document.getElementById('candidates-table');
  const statusFilter=document.getElementById('cand-status-filter').value;
  const channelFilter=document.getElementById('cand-channel-filter').value;
  
  let filtered=[...candidates];
  if(statusFilter)filtered=filtered.filter(c=>c.status===statusFilter);
  if(channelFilter)filtered=filtered.filter(c=>c.channel===channelFilter);
  if(candSearch){
    const q=candSearch.toLowerCase();
    filtered=filtered.filter(c=>c.name.toLowerCase().includes(q)||(c.position||'').toLowerCase().includes(q));
  }
  filtered.sort((a,b)=>new Date(b.createdDate)-new Date(a.createdDate));

  // Stats
  document.getElementById('cand-st-new').textContent=candidates.filter(c=>c.status==='nieuw').length;
  document.getElementById('cand-st-interview').textContent=candidates.filter(c=>c.status==='gesprek_gepland').length;
  document.getElementById('cand-st-hired').textContent=candidates.filter(c=>c.status==='aangenomen').length;
  document.getElementById('cand-st-rejected').textContent=candidates.filter(c=>c.status==='afgewezen').length;
  
  const newCount=candidates.filter(c=>c.status==='nieuw'||c.status==='gesprek_gepland').length;
  document.getElementById('cand-badge').textContent=newCount>0?` (${newCount})`:'';
  document.getElementById('people-count').textContent=peopleTab==='employees'?
    people.length+' medewerker'+(people.length!==1?'s':''):
    candidates.length+' kandidaat'+(candidates.length!==1?'kandidaten':'');

  // Populate channel filter dynamically
  const chFilter=document.getElementById('cand-channel-filter');
  const chFilterVal=chFilter.value;
  chFilter.innerHTML='<option value="">Alle kanalen</option>'+channels.map(ch=>`<option value="${ch.id}">${ch.name}</option>`).join('');
  chFilter.value=chFilterVal;

  const statusLabels={nieuw:'ğŸ†• Nieuw',gesprek_gepland:'ğŸ“… Gesprek gepland',aangenomen:'âœ… Aangenomen',afgewezen:'âŒ Afgewezen'};
  const statusBadges={nieuw:'badge-blue',gesprek_gepland:'badge-yellow',aangenomen:'badge-green',afgewezen:'badge-red'};

  if(filtered.length===0){
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3)">Geen kandidaten gevonden. Klik op "Kandidaat toevoegen" om te starten.</td></tr>';
    return;
  }
  tbody.innerHTML=filtered.map(c=>{
    const chColor=getChannelColor(c.channel);
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:10px">
        <div class="avatar" style="background:${getAvatarColor(c.name)};width:32px;height:32px;font-size:12px">${getInitials(c.name)}</div>
        <div><div style="font-weight:600">${c.name}</div>
        <div style="font-size:11px;color:var(--text3)">${c.email||'Geen e-mail'}</div></div>
      </div></td>
      <td><span class="badge" style="background:${chColor}1a;color:${chColor}">${getChannelName(c.channel)}</span></td>
      <td style="font-size:13px">${c.position||'â€”'}</td>
      <td><span class="badge ${statusBadges[c.status]||'badge-gray'}">${statusLabels[c.status]||c.status}</span></td>
      <td>${c.cvFile?'<span class="badge badge-green">ğŸ“„ CV</span>':'<span style="color:var(--text3);font-size:12px">â€”</span>'}</td>
      <td>${c.interviews&&c.interviews.length>0?`<span class="badge badge-blue">ğŸ’¬ ${c.interviews.length}</span>`:
        '<span style="color:var(--text3);font-size:12px">â€”</span>'}</td>
      <td style="text-align:right;white-space:nowrap">
        <button class="btn btn-sm" onclick="viewCandidate('${c.id}')" title="Details" aria-label="Details">ğŸ‘</button>
        <button class="btn btn-sm" onclick="openCandidateModal('${c.id}')" title="Bewerken" aria-label="Bewerken">âœï¸</button>
        ${c.status!=='aangenomen'?`<button class="btn btn-sm" onclick="hireCandidate('${c.id}')" title="Aannemen" aria-label="Aannemen" style="color:var(--success)">âœ…</button>`:''}
        <button class="btn btn-sm btn-danger" onclick="deleteCandidate('${c.id}')" title="Verwijderen" aria-label="Verwijderen">ğŸ—‘</button>
      </td>
    </tr>`;
  }).join('');
}

function searchCandidates(q){candSearch=q;renderCandidates();}

function openChannelsModal(returnCandidateId){
  const rows=channels.map(ch=>{
    const inUse=candidates.filter(c=>c.channel===ch.id).length;
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
      <span class="clr-dot" style="background:${ch.color};width:12px;height:12px"></span>
      <span style="flex:1;font-weight:600;font-size:13px">${ch.name}</span>
      <span style="font-size:11px;color:var(--text3)">${inUse} kandidaat${inUse!==1?'en':''}</span>
      <button class="btn btn-sm btn-icon" onclick="editChannel('${ch.id}','${returnCandidateId}')" title="Bewerken" aria-label="Bewerken">âœï¸</button>
      ${inUse===0?`<button class="btn btn-sm btn-icon btn-danger" onclick="deleteChannel('${ch.id}','${returnCandidateId}')" title="Verwijderen" aria-label="Verwijderen">ğŸ—‘</button>`
        :`<span style="font-size:11px;color:var(--text3);padding:0 6px" title="Kan niet verwijderd worden â€” ${inUse} kandidaat${inUse!==1?'en':''} gekoppeld">ğŸ”’</span>`}
    </div>`;
  }).join('');
  
  openModal('Kanalen beheren',`
    <div style="margin-bottom:16px">${rows||'<div style="color:var(--text3);font-size:13px;text-align:center;padding:16px">Nog geen kanalen</div>'}</div>
    <div style="border-top:1px solid var(--border);padding-top:16px">
      <div style="font-weight:700;font-size:13px;margin-bottom:10px">Kanaal toevoegen</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Naam <span class="req">*</span></label>
          <input class="form-input" id="mch-name" placeholder="Bv. StepStone" onkeydown="if(event.key==='Enter')addChannel('${returnCandidateId}')"/>
        </div>
        <div class="form-group">
          <label class="form-label">Kleur</label>
          <input type="color" class="form-input" id="mch-color" value="#3b82f6" style="width:60px;height:36px;padding:2px"/>
        </div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="addChannel('${returnCandidateId}')">â• Toevoegen</button>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="${returnCandidateId?`openCandidateModal('${returnCandidateId}')`:'closeModal()'}">Terug</button>
    </div>
  `);
}

function editChannel(chId,returnCandidateId){
  const ch=channels.find(c=>c.id===chId);if(!ch)return;
  openModal('Kanaal bewerken',`
    <div class="form-group">
      <label class="form-label">Naam <span class="req">*</span></label>
      <input class="form-input" id="mche-name" value="${ch.name}" onkeydown="if(event.key==='Enter')saveEditChannel('${chId}','${returnCandidateId}')"/>
    </div>
    <div class="form-group">
      <label class="form-label">Kleur</label>
      <input type="color" class="form-input" id="mche-color" value="${ch.color}" style="width:60px;height:36px;padding:2px"/>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="openChannelsModal('${returnCandidateId}')">Annuleren</button>
      <button class="btn btn-primary" onclick="saveEditChannel('${chId}','${returnCandidateId}')">Opslaan</button>
    </div>
  `);
}

function saveEditChannel(chId,returnCandidateId){
  const name=document.getElementById('mche-name').value.trim();
  const color=document.getElementById('mche-color').value;
  if(!name){showToast('Naam is verplicht','error');return;}
  const ch=channels.find(c=>c.id===chId);
  if(ch){ch.name=name;ch.color=color;}
  autoSave();
  showToast('Kanaal bijgewerkt');
  openChannelsModal(returnCandidateId);
}

function addChannel(returnCandidateId){
  const name=document.getElementById('mch-name').value.trim();
  const color=document.getElementById('mch-color').value;
  if(!name){showToast('Naam is verplicht','error');return;}
  const id=name.toLowerCase().replace(/[^a-z0-9]/g,'-');
  if(channels.find(c=>c.id===id)){showToast('Dit kanaal bestaat al','error');return;}
  channels.push({id,name,color});
  autoSave();
  showToast('Kanaal toegevoegd');
  openChannelsModal(returnCandidateId);
}

async function deleteChannel(id,returnCandidateId){
  const ch=channels.find(c=>c.id===id);
  const inUse=candidates.filter(c=>c.channel===id).length;
  if(inUse>0){showToast(`Kan niet verwijderen: ${inUse} kandidaat/kandidaten gebruiken dit kanaal`,'error');return;}
  if(!await confirmDialog(`Kanaal "${ch?ch.name:id}" verwijderen?`))return;
  channels=channels.filter(c=>c.id!==id);
  autoSave();
  showToast('Kanaal verwijderd');
  openChannelsModal(returnCandidateId);
}

function openCandidateModal(id){
  const c=id?candidates.find(x=>x.id===id):null;
  openModal(c?'Kandidaat bewerken':'Kandidaat toevoegen',`
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Naam <span class="req">*</span></label>
        <input class="form-input" id="mc-name" value="${c?c.name:''}"/>
      </div>
      <div class="form-group">
        <label class="form-label">E-mail</label>
        <input class="form-input" type="email" id="mc-email" value="${c?c.email||'':''}"/>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Telefoon</label>
        <input class="form-input" id="mc-phone" value="${c?c.phone||'':''}"/>
      </div>
      <div class="form-group">
        <label class="form-label">Positie / Functie</label>
        <input class="form-input" id="mc-position" value="${c?c.position||'':''}" placeholder="Bv. Installateur, Servicetechnicus"/>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Kanaal <span class="req">*</span> <button class="btn btn-sm btn-icon" onclick="openChannelsModal('${id||''}')" title="Kanalen beheren" aria-label="Kanalen beheren" style="margin-left:4px;vertical-align:middle;width:24px;height:24px;font-size:11px">âœï¸</button></label>
        <select class="form-input" id="mc-channel">
          ${channels.map(ch=>`<option value="${ch.id}" ${c&&c.channel===ch.id?'selected':''}>${ch.name}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-input" id="mc-status">
          <option value="nieuw" ${c&&c.status==='nieuw'?'selected':''}>ğŸ†• Nieuw</option>
          <option value="gesprek_gepland" ${c&&c.status==='gesprek_gepland'?'selected':''}>ğŸ“… Gesprek gepland</option>
          <option value="aangenomen" ${c&&c.status==='aangenomen'?'selected':''}>âœ… Aangenomen</option>
          <option value="afgewezen" ${c&&c.status==='afgewezen'?'selected':''}>âŒ Afgewezen</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">CV uploaden (PDF/afbeelding)</label>
      <input type="file" accept=".pdf,image/*" class="form-input" id="mc-cv" style="padding:6px"/>
      ${c&&c.cvFile?`<div style="margin-top:6px;font-size:12px;color:var(--success)">ğŸ“„ CV reeds geÃ¼pload (${c.cvFileName||'bestand'})</div>`:''}
    </div>
    <div class="form-group">
      <label class="form-label">Notities</label>
      <textarea class="form-input" id="mc-notes" rows="3" style="resize:vertical" placeholder="Eerste indruk, opmerkingen...">${c?c.notes||'':''}</textarea>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveCandidate('${id||''}')">Opslaan</button>
    </div>
  `);
  // Handle CV upload
  document.getElementById('mc-cv').addEventListener('change',function(e){
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=function(ev){
      document.getElementById('mc-cv').dataset.fileData=ev.target.result;
      document.getElementById('mc-cv').dataset.fileName=file.name;
    };
    reader.readAsDataURL(file);
  });
}

function saveCandidate(id){
  const name=document.getElementById('mc-name').value.trim();
  const email=document.getElementById('mc-email').value.trim();
  const phone=document.getElementById('mc-phone').value.trim();
  const position=document.getElementById('mc-position').value.trim();
  const channel=document.getElementById('mc-channel').value;
  const status=document.getElementById('mc-status').value;
  const notes=document.getElementById('mc-notes').value.trim();
  const cvInput=document.getElementById('mc-cv');
  
  if(!name){showToast('Naam is verplicht','error');return;}
  
  const data={name,email,phone,position,channel,status,notes};
  
  if(cvInput.dataset.fileData){
    data.cvFile=cvInput.dataset.fileData;
    data.cvFileName=cvInput.dataset.fileName;
  }
  
  if(id){
    const c=candidates.find(x=>x.id===id);
    if(c){
      // Preserve existing CV if no new one uploaded
      if(!data.cvFile&&c.cvFile){data.cvFile=c.cvFile;data.cvFileName=c.cvFileName;}
      if(!data.cvFile){data.cvFile=c.cvFile;data.cvFileName=c.cvFileName;}
      Object.assign(c,data);
    }
  }else{
    candidates.push({id:uid(),...data,interviews:[],createdDate:new Date().toISOString().split('T')[0]});
  }
  closeModal();autoSave();renderCandidates();
  showToast('Kandidaat opgeslagen');
}

function viewCandidate(id){
  const c=candidates.find(x=>x.id===id);if(!c)return;
  const statusLabels={nieuw:'ğŸ†• Nieuw',gesprek_gepland:'ğŸ“… Gesprek gepland',aangenomen:'âœ… Aangenomen',afgewezen:'âŒ Afgewezen'};
  
  let interviewHtml='';
  if(c.interviews&&c.interviews.length>0){
    interviewHtml=c.interviews.map((iv,i)=>`
      <div style="padding:12px;background:var(--surface2);border-radius:var(--radius-xs);margin-bottom:8px;border-left:3px solid var(--accent)">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <span style="font-weight:700;font-size:13px">ğŸ’¬ Gesprek ${i+1} â€” ${formatDate(iv.date)}</span>
          <button class="btn btn-sm btn-danger" onclick="deleteInterview('${c.id}',${i})">ğŸ—‘</button>
        </div>
        ${iv.interviewer?`<div style="font-size:12px;color:var(--text3);margin-bottom:4px">Interviewer: ${iv.interviewer}</div>`:''}
        <div style="font-size:13px;white-space:pre-wrap">${iv.summary}</div>
        ${iv.rating?`<div style="margin-top:6px">${'â­'.repeat(iv.rating)}${'â˜†'.repeat(5-iv.rating)}</div>`:''}
      </div>
    `).join('');
  }
  
  openModal(`ğŸ“„ ${c.name}`,`
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:12px;background:var(--surface2);border-radius:var(--radius-sm)">
      <div class="avatar" style="background:${getAvatarColor(c.name)}">${getInitials(c.name)}</div>
      <div style="flex:1">
        <div style="font-weight:700">${c.name}</div>
        <div style="font-size:12px;color:var(--text3)">${c.position||'Geen positie opgegeven'}</div>
      </div>
      <span class="badge ${c.status==='aangenomen'?'badge-green':c.status==='afgewezen'?'badge-red':'badge-blue'}">${statusLabels[c.status]||c.status}</span>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:13px;margin-bottom:20px">
      <div><span style="color:var(--text3)">E-mail:</span> <strong>${c.email||'â€”'}</strong></div>
      <div><span style="color:var(--text3)">Telefoon:</span> <strong>${c.phone||'â€”'}</strong></div>
      <div><span style="color:var(--text3)">Kanaal:</span> <strong>${getChannelName(c.channel)}</strong></div>
      <div><span style="color:var(--text3)">Ontvangen:</span> <strong>${c.createdDate?formatDate(c.createdDate):'â€”'}</strong></div>
    </div>
    ${c.cvFile?`<div style="margin-bottom:16px"><a href="${c.cvFile}" download="${c.cvFileName||'cv.pdf'}" class="btn btn-sm">ğŸ“„ CV downloaden (${c.cvFileName||'bestand'})</a></div>`:''}
    ${c.notes?`<div style="padding:10px;background:var(--surface2);border-radius:var(--radius-xs);font-size:13px;margin-bottom:16px"><strong>Notities:</strong><div style="margin-top:4px;white-space:pre-wrap">${c.notes}</div></div>`:''}
    <div style="margin-bottom:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <span style="font-weight:700;font-size:14px">ğŸ’¬ Sollicitatiegesprekken (${c.interviews?c.interviews.length:0})</span>
        <button class="btn btn-sm btn-primary-outline" onclick="openInterviewModal('${c.id}')">â• Gesprek toevoegen</button>
      </div>
      ${interviewHtml||'<div style="font-size:13px;color:var(--text3);padding:12px;text-align:center">Nog geen gesprekken geregistreerd</div>'}
    </div>
    <div class="modal-actions">
      ${c.status!=='aangenomen'?`<button class="btn" onclick="hireCandidate('${c.id}');closeModal()" style="color:var(--success)">âœ… Aannemen</button>`:''}
      <button class="btn" onclick="closeModal()">Sluiten</button>
    </div>
  `);
}

function openInterviewModal(candidateId){
  const c=candidates.find(x=>x.id===candidateId);if(!c)return;
  const today=new Date().toISOString().split('T')[0];
  openModal(`ğŸ’¬ Gesprek toevoegen â€” ${c.name}`,`
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Datum <span class="req">*</span></label>
        <input class="form-input" type="date" id="mi-date" value="${today}"/>
      </div>
      <div class="form-group">
        <label class="form-label">Interviewer</label>
        <select class="form-input" id="mi-interviewer">
          <option value="">Selecteer...</option>
          ${people.filter(p=>p.role==='admin'||p.isApprover).map(p=>`<option value="${fullName(p)}">${fullName(p)}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Beoordeling</label>
      <div style="display:flex;gap:8px" id="mi-rating-btns">
        ${[1,2,3,4,5].map(n=>`<button class="btn btn-sm" onclick="setInterviewRating(${n},this)">${'â­'.repeat(n)}</button>`).join('')}
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Samenvatting gesprek <span class="req">*</span></label>
      <textarea class="form-input" id="mi-summary" rows="6" style="resize:vertical" placeholder="Indruk, sterke punten, aandachtspunten, conclusie..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="viewCandidate('${candidateId}')">Terug</button>
      <button class="btn btn-primary" onclick="saveInterview('${candidateId}')">Opslaan</button>
    </div>
  `);
}

let interviewRating=0;
function setInterviewRating(n,btn){
  interviewRating=n;
  btn.parentElement.querySelectorAll('.btn').forEach((b,i)=>{
    b.classList.toggle('btn-primary',i<n);
  });
}

function saveInterview(candidateId){
  const date=document.getElementById('mi-date').value;
  const interviewer=document.getElementById('mi-interviewer').value;
  const summary=document.getElementById('mi-summary').value.trim();
  if(!date){showToast('Datum is verplicht','error');return;}
  if(!summary){showToast('Samenvatting is verplicht','error');return;}
  const c=candidates.find(x=>x.id===candidateId);if(!c)return;
  if(!c.interviews)c.interviews=[];
  c.interviews.push({date,interviewer,summary,rating:interviewRating});
  if(c.status==='nieuw')c.status='gesprek_gepland';
  interviewRating=0;
  autoSave();viewCandidate(candidateId);
  showToast('Gesprek opgeslagen');
}

async function deleteInterview(candidateId,idx){
  if(!await confirmDialog('Gespreknotitie verwijderen?'))return;
  const c=candidates.find(x=>x.id===candidateId);
  if(c&&c.interviews){c.interviews.splice(idx,1);autoSave();viewCandidate(candidateId);}
}

async function deleteCandidate(id){
  if(!await confirmDialog('Kandidaat verwijderen?'))return;
  candidates=candidates.filter(c=>c.id!==id);
  autoSave();renderCandidates();showToast('Kandidaat verwijderd');
}

async function hireCandidate(id){
  const c=candidates.find(x=>x.id===id);if(!c)return;
  if(!await confirmDialog(`${c.name} aannemen en omzetten naar medewerker?`))return;
  // Open a modal to fill in employee-specific fields
  openModal(`âœ… ${c.name} aannemen`,`
    <div style="padding:12px;background:var(--success-bg);border-radius:var(--radius-xs);margin-bottom:16px;font-size:13px">
      <strong>ğŸ“„ ${c.name}</strong> wordt omgezet naar medewerker. Vul de ontbrekende gegevens aan.
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Naam</label>
        <input class="form-input" id="mh-name" value="${c.name}" readonly style="background:var(--surface2)"/>
      </div>
      <div class="form-group">
        <label class="form-label">E-mail <span class="req">*</span></label>
        <input class="form-input" type="email" id="mh-email" value="${c.email||''}"/>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Department <span class="req">*</span></label>
        <select class="form-input" id="mh-dept">
          <option value="">Selecteer...</option>
          ${departments.map(d=>`<option value="${d.id}">${d.name}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Rol</label>
        <select class="form-input" id="mh-role">
          <option value="user">User</option>
          <option value="approver">Approver</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Startdatum <span class="req">*</span></label>
        <input class="form-input" type="date" id="mh-start"/>
      </div>
      <div class="form-group">
        <label class="form-label">Werkrooster</label>
        <select class="form-input" id="mh-schedule">
          ${schedules.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="confirmHire('${c.id}')">âœ… Bevestigen & aannemen</button>
    </div>
  `);
}

function confirmHire(candidateId){
  const c=candidates.find(x=>x.id===candidateId);if(!c)return;
  const email=document.getElementById('mh-email').value.trim();
  const departmentId=document.getElementById('mh-dept').value;
  const role=document.getElementById('mh-role').value;
  const startDate=document.getElementById('mh-start').value;
  const scheduleId=document.getElementById('mh-schedule').value;
  
  if(!email){showToast('E-mail is verplicht','error');return;}
  if(!departmentId){showToast('Department is verplicht','error');return;}
  if(!startDate){showToast('Startdatum is verplicht','error');return;}
  
  // Create employee from candidate - split candidate name
  const nameParts=c.name.split(' ');
  const firstName=nameParts[0]||'';
  const lastName=nameParts.slice(1).join(' ')||'';
  people.push({
    id:uid(),firstName,lastName,email,departmentId,role,isApprover:false,statuut:'bediende',paritairComite:'',startDate,scheduleId,
    gsm:'',tel:'',iban:'',birthDate:'',werkGsm:'',noodNaam:'',noodRelatie:'',noodGsm:'',
    allowanceAdjustments:[],candidateId:c.id
  });
  
  // Update candidate status
  c.status='aangenomen';
  c.hiredDate=new Date().toISOString().split('T')[0];
  
  closeModal();autoSave();renderCandidates();renderPeople();renderDepartments();
  showToast(`${c.name} is aangenomen en toegevoegd als medewerker ğŸ‰`);
}

function renderDepartments(){
  const grid=document.getElementById('dept-grid');
  if(departments.length===0){
    grid.innerHTML='<div class="card" style="grid-column:1/-1;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px">ğŸ“‚</div><div style="color:var(--text3);font-size:13px">Nog geen departments. Klik op "Department toevoegen" om te starten.</div></div>';
  }else{
    grid.innerHTML=departments.map(d=>{
      const count=people.filter(p=>p.departmentId===d.id&&!p.archived).length;
      const approverNames=getApproverNames(d);
      return `<div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div style="font-weight:700;font-size:15px">${d.name}</div>
          <div style="display:flex;gap:4px">
            <button class="btn btn-sm btn-icon" onclick="openDeptModal('${d.id}')" title="Bewerken" aria-label="Bewerken">âœï¸</button>
            <button class="btn btn-sm btn-icon btn-danger" onclick="deleteDept('${d.id}')" title="Verwijderen" aria-label="Verwijderen">ğŸ—‘</button>
          </div>
        </div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:6px">ğŸ‘¥ ${count} medewerker${count!==1?'s':''}</div>
        <div style="font-size:12px;color:var(--text2)">Goedkeurder${approverNames.length!==1?'s':''}: ${approverNames.length>0?`<span style="font-weight:600">${approverNames.map(n=>n.split(' ')[0]).join(', ')}</span>`:'<span style="color:var(--danger)">Niet toegewezen</span>'}</div>
      </div>`;
    }).join('');
  }
  document.getElementById('dept-count').textContent=departments.length+' department'+(departments.length!==1?'s':'');
}

let peopleSortKey='name', peopleSortAsc=true;

function sortPeople(key){
  if(peopleSortKey===key)peopleSortAsc=!peopleSortAsc;
  else{peopleSortKey=key;peopleSortAsc=true;}
  renderPeople();
}

function renderPeople(){
  // Update sort indicators
  ['name','dept','role','schedule','saldo'].forEach(k=>{
    const el=document.getElementById('sort-'+k);
    if(el)el.textContent=peopleSortKey===k?(peopleSortAsc?'â†‘':'â†“'):'â†•';
    if(el)el.style.opacity=peopleSortKey===k?'1':'.3';
  });

  const tbody=document.getElementById('people-table');
  const deptSelect=document.querySelector('#people-tab-employees select');
  deptSelect.innerHTML='<option value="">Alle departments</option>'+departments.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
  
  const activePeople=people.filter(p=>peopleStatusFilter==='all'?true:peopleStatusFilter==='archived'?p.archived:!p.archived);
  const activeCount=people.filter(p=>!p.archived).length;
  const archivedCount=people.filter(p=>p.archived).length;

  if(activePeople.length===0){
    tbody.innerHTML='<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text3)">Nog geen medewerkers. Klik op "Medewerker toevoegen" om te starten.</td></tr>';
  }else{
    const sorted=[...activePeople].sort((a,b)=>{
      // Archived always at bottom
      if(a.archived&&!b.archived)return 1;
      if(!a.archived&&b.archived)return -1;
      let va,vb;
      if(peopleSortKey==='name'){va=fullName(a).toLowerCase();vb=fullName(b).toLowerCase();}
      else if(peopleSortKey==='dept'){const da=departments.find(d=>d.id===a.departmentId);const db=departments.find(d=>d.id===b.departmentId);va=(da?da.name:'').toLowerCase();vb=(db?db.name:'').toLowerCase();}
      else if(peopleSortKey==='role'){const order=p=>(p.role==='admin'?0:2)-(p.isApprover?1:0);va=order(a);vb=order(b);}
      else if(peopleSortKey==='schedule'){const sa=schedules.find(s=>s.id===a.scheduleId);const sb=schedules.find(s=>s.id===b.scheduleId);va=(sa?sa.name:'').toLowerCase();vb=(sb?sb.name:'').toLowerCase();}
      else if(peopleSortKey==='saldo'){va=getTotalAllowance(a)-getUsedDays(a.id);vb=getTotalAllowance(b)-getUsedDays(b.id);}
      else{va=0;vb=0;}
      if(va<vb)return peopleSortAsc?-1:1;
      if(va>vb)return peopleSortAsc?1:-1;
      return 0;
    });
    tbody.innerHTML=sorted.map(p=>{
      const isArchived=p.archived;
      const dept=departments.find(d=>d.id===p.departmentId);
      const schedule=schedules.find(s=>s.id===p.scheduleId);
      const roleBadge=p.role==='admin'?'badge-red':'badge-gray';
      const roleBadges=`<div style="display:flex;flex-direction:column;align-items:center;gap:3px"><span class="badge ${roleBadge}" style="min-width:70px;text-align:center;display:inline-block">${p.role}</span>${p.isApprover?'<span class="badge badge-purple" style="min-width:70px;text-align:center;display:inline-block">approver</span>':''}</div>`;
      const totalDays=getTotalAllowance(p);
      const usedDays=getUsedDays(p.id);
      const remaining=totalDays-usedDays;
      const phone=p.werkGsm||p.gsm||p.tel||'';
      return `<tr style="cursor:pointer;${isArchived?'opacity:.5;background:var(--surface2);':''}" onclick="if(!event.target.closest('button,a'))openPersonModal('${p.id}')">
        <td><div style="display:flex;align-items:center;gap:10px">
          <div class="avatar" style="background:${isArchived?'#aaa':getAvatarColor(fullName(p))}">${getInitials(fullName(p))}</div>
          <div><div style="font-weight:600">${fullName(p)}${isArchived?' <span class="badge badge-gray" style="font-size:10px;margin-left:4px">ğŸ“¦ Archief'+(p.archivedReason==='contract verlopen'?' (contract verlopen)':'')+'</span>':''}${!isArchived&&p.endDate?` <span style="font-size:10px;color:var(--text3);margin-left:4px">â° ${formatDate(p.endDate)}</span>`:''}</div><div style="font-size:11px;color:var(--text3)">${p.email}</div></div>
        </div></td>
        <td>${dept?dept.name:'â€”'}</td>
        <td>${roleBadges}</td>
        <td style="font-size:12px">${phone?`<a href="tel:${phone}" style="color:var(--text);text-decoration:none">${phone}</a>`:'<span style="color:var(--text3)">â€”</span>'}</td>
        <td>${schedule?schedule.name:'â€”'}</td>
        <td style="text-align:center">
          ${isArchived?'<span style="font-size:12px;color:var(--text3)">â€”</span>':`
          <span style="font-size:12px;font-weight:600;color:${remaining>5?'var(--text)':remaining>0?'var(--warn)':'var(--danger)'}">${remaining}/${totalDays}d</span>`}
        </td>
        <td style="text-align:center">
          ${isArchived?'<span style="font-size:12px;color:var(--text3)">â€”</span>':`
          <span style="font-size:12px;font-weight:600;cursor:pointer;color:var(--accent);text-decoration:underline dotted" onclick="openPersonModal('${p.id}');setTimeout(function(){var f=document.getElementById('mp-saldo-ov');if(f){f.scrollIntoView({block:'center'});f.focus();}},200)" title="Klik om aan te passen">${p.saldoOV!=null?p.saldoOV+'u':'â€”'}</span>`}
        </td>
        <td class="interim-col" style="text-align:center;display:none">
          ${p.statuut==='interim'&&p.interimDagen!=null?`<span style="font-size:12px;font-weight:600">${p.interimDagen}d</span>`:'<span style="font-size:12px;color:var(--text3)">â€”</span>'}
        </td>
        <td class="interim-col" style="text-align:center;display:none">
          ${p.statuut==='interim'&&p.interimDagen!=null?(()=>{const c=calcInterimCounter(p);return `<span style="font-size:12px;font-weight:600;color:${c>10?'var(--text)':c>0?'var(--warn)':'var(--danger)'}">${c<=10?'âš ï¸ ':''}${c}d</span>`;})():'<span style="font-size:12px;color:var(--text3)">â€”</span>'}
        </td>
        <td style="text-align:right">
          ${isArchived?`
            <button class="btn btn-sm" onclick="unarchivePerson('${p.id}')" title="Heractiveren" aria-label="Heractiveren">â™»ï¸</button>
          `:`
            <button class="btn btn-sm" onclick="openPersonModal('${p.id}')">âœï¸</button>
            <button class="btn btn-sm" onclick="openSaldoModal('${p.id}')">ğŸ“Š</button>
            <button class="btn btn-sm" onclick="openChecklist('${p.id}')" title="Onboarding checklist" aria-label="Onboarding checklist" style="color:var(--accent)">â˜‘ï¸</button>
            <button class="btn btn-sm" onclick="archivePerson('${p.id}')" title="Archiveren" aria-label="Archiveren" style="color:var(--text3)">ğŸ“¦</button>
          `}
        </td>
      </tr>`;
    }).join('');
  }
  document.getElementById('people-count').textContent=activeCount+' medewerker'+(activeCount!==1?'s':'')+(archivedCount>0?' Â· '+archivedCount+' gearchiveerd':'');

  // Toon interim kolommen alleen als er minstens 1 actieve interim-medewerker is
  const hasInterim=people.some(p=>!p.archived&&p.statuut==='interim');
  document.querySelectorAll('.interim-col').forEach(el=>{el.style.display=hasInterim?'':'none';});
}

function renderTypes(){
  const tbody=document.getElementById('types-table');
  const catLabels={verlof:'ğŸ–ï¸ Verlof (verlofsaldo)',adv:'ğŸ“… ADV',afwezigheid:'ğŸ“‹ Afwezigheid (afwezigheidssaldo)',ziekte:'ğŸ¤’ Ziekte',extern:'ğŸ­ Extern (opgelegd)'};
  const catOrder=['verlof','adv','afwezigheid','ziekte','extern'];
  const protectedIds=['wettelijk','adv','ziekte','tech-werkloos','weerverlet'];
  let html='';
  catOrder.forEach(cat=>{
    const types=leaveTypes.filter(t=>t.category===cat);
    if(types.length===0)return;
    const catBadge=cat==='extern'?'badge-yellow':cat==='ziekte'?'badge-red':cat==='afwezigheid'?'badge-orange':'badge-blue';
    html+=`<tr><td colspan="10" style="background:var(--surface2);font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);padding:8px 12px">${catLabels[cat]||cat}</td></tr>`;
    html+=types.map(t=>`<tr>
      <td><div style="display:flex;align-items:center;gap:8px">
        <span class="clr-dot" style="background:${t.color}"></span>
        <span>${t.symbol}</span>
        <span style="font-weight:600">${t.name}</span>
      </div></td>
      <td><span class="badge ${catBadge}">${cat==='extern'?'Extern':cat==='ziekte'?'Ziekte':cat==='afwezigheid'?'Afwezigheid':'Verlof'}</span></td>
      <td>${t.paid?'âœ… Betaald':'âŒ Onbetaald'}</td>
      <td>${t.tracked?'âœ…':''}</td>
      <td>${t.absenceTracked?'âœ…':''}</td>
      <td style="text-align:center"><input type="checkbox" ${t.mobile?'checked':''} onchange="toggleMobile('${t.id}',this.checked)" style="cursor:pointer;width:16px;height:16px"/></td>
      <td>${t.tracked?t.defaultDays+' dagen':'â€”'}</td>
      <td>${t.maxDays>0?t.maxDays+' dagen':'â€”'}</td>
      <td style="text-align:right">
        <button class="btn btn-sm" onclick="openTypeModal('${t.id}')">âœï¸</button>
        ${!protectedIds.includes(t.id)?`<button class="btn btn-sm btn-danger" onclick="deleteType('${t.id}')">ğŸ—‘</button>`:''}
      </td>
    </tr>`).join('');
  });
  tbody.innerHTML=html;
}

function renderSettings(){
  // Schedules
  const stbl=document.getElementById('schedules-table');
  stbl.innerHTML=schedules.map(s=>`<tr>
    <td style="font-weight:600">${s.name}</td>
    <td>${s.daysPerWeek} dagen</td>
    <td>${s.hoursPerDay}u</td>
    <td>${s.halfDays?'âœ… Ja':'âŒ Nee'}</td>
    <td style="text-align:right">
      <button class="btn btn-sm" onclick="openScheduleModal('${s.id}')">âœï¸</button>
      <button class="btn btn-sm btn-danger" onclick="deleteSchedule('${s.id}')">ğŸ—‘</button>
    </td>
  </tr>`).join('');

  // Holidays
  const holidays=getBEHolidays();
  const htbl=document.getElementById('holidays-table');
  const region=settings.region||'vlaanderen';
  document.getElementById('region-select').value=region;
  htbl.innerHTML=holidays.filter(h=>h.all||h.regions&&h.regions.includes(region)).map(h=>`<tr>
    <td style="font-weight:600">${formatDate(h.date)}</td>
    <td>${h.name}</td>
    <td>âœ…</td>
  </tr>`).join('');

  // Year end
  document.getElementById('yearend-mode').value=settings.yearendMode||'max5';
  document.getElementById('yearend-custom-days').value=settings.yearendCustomDays||5;
  document.getElementById('yearend-custom-row').style.display=settings.yearendMode==='custom'?'block':'none';
  const yeSelect=document.getElementById('yearend-year');
  if(yeSelect){
    const curYear=new Date().getFullYear();
    yeSelect.innerHTML='';
    for(let y=curYear;y>=curYear-3;y--){
      const done=settings.yearendDone&&settings.yearendDone.includes(y);
      yeSelect.innerHTML+=`<option value="${y}" ${y===curYear-1?'selected':''}>${y} ${done?'âœ…':''}</option>`;
    }
  }

  // Notifications
  document.getElementById('notif-email').checked=settings.notifEmail!==false;
  document.getElementById('notif-sick').checked=settings.notifSick!==false;

  // Verlofregels
  renderVerlofregels();
}

function renderVerlofregels(){
  // Init defaults if empty
  if(verlofregels.length===0)verlofregels=JSON.parse(JSON.stringify(DEFAULT_VERLOFREGELS));
  // Upgrade: verwijder min-bezetting uit bestaande data
  verlofregels=verlofregels.filter(r=>r.id!=='min-bezetting');
  const container=document.getElementById('verlofregels-content');
  if(!container)return;
  const activeDepts=departments.filter(d=>people.some(p=>p.departmentId===d.id&&!p.archived));
  let html='';

  verlofregels.forEach(rule=>{
    html+='<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px">';
    html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
    html+='<div><span style="font-size:16px;margin-right:6px">'+rule.icon+'</span><strong style="font-size:14px">'+rule.label+'</strong></div>';
    html+='</div>';
    html+='<div style="font-size:12px;color:var(--text3);margin-bottom:12px">'+rule.desc+'</div>';

    if(rule.perDept){
      // Per department tabel
      html+='<table class="tbl" style="font-size:12px"><thead><tr><th>Department</th><th style="width:80px">Medewerkers</th><th style="width:120px">Waarde</th></tr></thead><tbody>';
      activeDepts.forEach(dept=>{
        const empCount=people.filter(p=>p.departmentId===dept.id&&!p.archived).length;
        const val=rule.defaults&&rule.defaults[dept.id]!==undefined?rule.defaults[dept.id]:'';
        html+='<tr>';
        html+='<td style="font-weight:600">'+dept.name+'</td>';
        html+='<td style="text-align:center"><span class="badge badge-blue">'+empCount+'</span></td>';
        html+='<td><input type="number" min="0" class="form-input" style="padding:4px 8px;font-size:12px;text-align:center" value="'+(val!==''?val:'')+'" placeholder="â€”" onblur="saveVerlofRegel(\''+rule.id+'\',\''+dept.id+'\',this.value)"/></td>';
        html+='</tr>';
      });
      html+='</tbody></table>';
    } else {
      // Globale waarde
      html+='<div style="display:flex;align-items:center;gap:12px">';
      html+='<label style="font-size:13px;font-weight:600">Waarde:</label>';
      html+='<input type="number" min="0" class="form-input" style="width:80px;padding:4px 8px;font-size:13px;text-align:center" value="'+(rule.value||'')+'" onblur="saveVerlofRegel(\''+rule.id+'\',null,this.value)"/>';
      html+='<span style="font-size:12px;color:var(--text3)">dagen</span>';
      html+='</div>';
    }
    html+='</div>';
  });

  container.innerHTML=html;
}

function saveVerlofRegel(ruleId,deptId,value){
  const rule=verlofregels.find(r=>r.id===ruleId);
  if(!rule)return;
  const num=value===''?'':parseInt(value);
  if(deptId){
    if(!rule.defaults)rule.defaults={};
    if(num===''||isNaN(num))delete rule.defaults[deptId];
    else rule.defaults[deptId]=num;
  } else {
    rule.value=num===''||isNaN(num)?'':num;
  }
  autoSave();
}

function checkVerlofregels(personId,startDate,endDate,days){
  // Returns array of warnings (not blocking)
  const warnings=[];
  const p=people.find(x=>x.id===personId);
  if(!p||verlofregels.length===0)return warnings;
  const dept=departments.find(d=>d.id===p.departmentId);

  verlofregels.forEach(rule=>{
    if(rule.id==='max-afwezig'&&rule.defaults&&dept){
      const maxVal=rule.defaults[dept.id];
      if(maxVal!==undefined&&maxVal!==''){
        // Count approved absences overlapping with this period
        const overlapping=requests.filter(r=>r.personId!==personId&&r.status==='approved'
          &&r.startDate<=endDate&&r.endDate>=startDate
          &&people.find(px=>px.id===r.personId&&px.departmentId===p.departmentId));
        if(overlapping.length>=maxVal){
          warnings.push({icon:'ğŸš«',msg:'Max. gelijktijdig afwezig ('+maxVal+') in '+dept.name+' bereikt: '+overlapping.length+' collega\u2019s al afwezig'});
        }
      }
    }
    if(rule.id==='max-opeenvolgend'&&rule.value){
      if(days>rule.value){
        warnings.push({icon:'ğŸ“…',msg:'Max. '+rule.value+' opeenvolgende verlofdagen overschreden ('+days+' aangevraagd)'});
      }
    }
    if(rule.id==='min-vooraf'&&rule.value){
      const today=new Date();
      const start=new Date(startDate);
      const diffDays=Math.floor((start-today)/(1000*60*60*24));
      if(diffDays<rule.value){
        warnings.push({icon:'â°',msg:'Min. '+rule.value+' dagen op voorhand aanvragen (nog '+diffDays+' dagen)'});
      }
    }
  });
  return warnings;
}

function updateInterimBadge(){
  const interimWarnings=people.filter(p=>!p.archived&&p.statuut==='interim'&&p.interimDagen).filter(p=>{
    const remaining=calcInterimCounter(p);
    return remaining!==null&&remaining<=10;
  });
  const badge=document.getElementById('badge-interim');
  if(badge){
    if(interimWarnings.length>0){badge.textContent='âš  '+interimWarnings.length;badge.style.display='';}
    else{badge.style.display='none';}
  }
}

function renderDashboard(){
  updateInterimBadge();
  // Today's absent
  const today=new Date().toISOString().split('T')[0];
  const absent=requests.filter(r=>r.status==='approved'&&r.type!=='ziekte'&&r.startDate<=today&&r.endDate>=today);
  const sick=requests.filter(r=>r.type==='ziekte'&&r.startDate<=today&&r.endDate>=today);
  const pending=requests.filter(r=>r.status==='pending');
  const next7=new Date();next7.setDate(next7.getDate()+7);
  const next7Str=next7.toISOString().split('T')[0];
  const upcoming=requests.filter(r=>r.status==='approved'&&r.startDate>today&&r.startDate<=next7Str);

  document.getElementById('st-absent').textContent=absent.length;
  document.getElementById('st-pending').textContent=pending.length;
  document.getElementById('st-sick').textContent=sick.length;

  // Absent list
  const absentDiv=document.getElementById('dash-absent');
  if(absent.length===0){
    absentDiv.innerHTML='<span style="font-size:13px;color:var(--text3)">Niemand afwezig vandaag ğŸ‰</span>';
  }else{
    absentDiv.innerHTML=absent.map(r=>{
      const person=people.find(p=>p.id===r.personId);
      const type=leaveTypes.find(t=>t.id===r.type);
      return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="viewRequest('${r.id}')">
        <div class="avatar" style="background:${person?getAvatarColor(fullName(person)):'#ccc'};width:28px;height:28px;font-size:11px">${person?getInitials(fullName(person)):'?'}</div>
        <div style="flex:1"><div style="font-size:13px;font-weight:600">${person?fullName(person):'Onbekend'}</div></div>
        <span class="badge" style="background:${type?type.color+'1a':'#eee'};color:${type?type.color:'#999'}">${type?type.symbol+' '+type.name:'?'}</span>
      </div>`;
    }).join('');
  }

  // Pending
  const pendDiv=document.getElementById('dash-pending');
  if(pending.length===0){
    pendDiv.innerHTML='<span style="font-size:13px;color:var(--text3)">Geen openstaande aanvragen âœ…</span>';
  }else{
    pendDiv.innerHTML=pending.slice(0,5).map(r=>{
      const person=people.find(p=>p.id===r.personId);
      const type=leaveTypes.find(t=>t.id===r.type);
      const dept=person?departments.find(d=>d.id===person.departmentId):null;
      const approverNames=dept?getApproverNames(dept):[];
      const approverLabel=approverNames.length>0?approverNames[0].split(' ')[0]:'';
      const approverColor=approverLabel?getAvatarColor(approverNames[0]):'#999';
      return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="viewRequest('${r.id}')">
        <div style="flex:1"><div style="font-size:13px;font-weight:600">${person?fullName(person):'Onbekend'}</div>
        <div style="font-size:11px;color:var(--text3)">${formatDateShort(r.startDate)} â†’ ${formatDateShort(r.endDate)}</div></div>
        ${approverLabel?`<span class="badge" style="background:${approverColor}18;color:${approverColor};font-size:10px;min-width:64px;text-align:center;display:inline-block">${approverLabel}</span>`:''}
        <span class="badge" style="background:${type?type.color+'1a':'#eee'};color:${type?type.color:'#999'}">${type?type.symbol:'?'}</span>
      </div>`;
    }).join('');
  }

  // Sick today list â€” inside absent card
  const sickSection=document.getElementById('dash-sick-section');
  if(sick.length===0){
    sickSection.innerHTML='';
  }else{
    sickSection.innerHTML=`<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--danger);margin-bottom:8px">ğŸ¤’ Ziek vandaag</div>
      ${sick.map(r=>{
        const person=people.find(p=>p.id===r.personId);
        const dept=person?departments.find(d=>d.id===person.departmentId):null;
        return `<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--surface3);cursor:pointer" onclick="viewRequest('${r.id}')">
          <div class="avatar" style="background:${person?getAvatarColor(fullName(person)):'#ccc'};width:26px;height:26px;font-size:10px">${person?getInitials(fullName(person)):'?'}</div>
          <div style="flex:1"><div style="font-size:13px;font-weight:600">${person?fullName(person):'Onbekend'}</div>
          <div style="font-size:11px;color:var(--text3)">${dept?dept.name:''} Â· sinds ${formatDateShort(r.startDate)}</div></div>
          <span style="font-size:12px;font-weight:600;color:var(--text3)">${r.days}d</span>
        </div>`;
      }).join('')}
    </div>`;
  }

  // Upcoming holidays
  const holidays=getBEHolidays().filter(h=>h.date>=today&&(h.all||(h.regions&&h.regions.includes(settings.region))));
  const holDiv=document.getElementById('dash-holidays');
  holDiv.innerHTML=holidays.slice(0,5).map(h=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
    <span style="font-size:18px">ğŸ‡§ğŸ‡ª</span>
    <div style="flex:1"><div style="font-size:13px;font-weight:600">${h.name}</div></div>
    <span style="font-size:12px;color:var(--text3);font-weight:600">${formatDate(h.date)}</span>
  </div>`).join('');

  // Badge counts
  const br=document.getElementById('badge-requests');
  if(pending.length>0){br.textContent=pending.length;br.style.display='';}
  else{br.style.display='none';}
}

// Old request functions removed â€” now handled by the self-contained requests-app module

function getConflicts(request){
  const person=people.find(p=>p.id===request.personId);
  if(!person)return[];
  const sameDept=people.filter(p=>p.departmentId===person.departmentId&&p.id!==person.id);
  const conflicts=[];
  sameDept.forEach(p=>{
    const overlapping=requests.filter(r=>r.personId===p.id&&r.status==='approved'&&
      r.startDate<=request.endDate&&r.endDate>=request.startDate);
    overlapping.forEach(r=>{
      const type=leaveTypes.find(t=>t.id===r.type);
      conflicts.push(`${fullName(p)} (${type?type.name:'?'}: ${formatDateShort(r.startDate)}â€“${formatDateShort(r.endDate)})`);
    });
  });
  return conflicts;
}

function calcWorkDays(start,end){
  // Bouw set van feestdagen (YYYY-MM-DD) op basis van regio
  const region=settings.region||'vlaanderen';
  const allHolidays=getBEHolidays();
  const holidaySet=new Set(
    allHolidays
      .filter(h=>h.all||(h.regions&&h.regions.includes(region)))
      .map(h=>h.date)
  );
  let count=0;
  const d=new Date(start);
  const e=new Date(end);
  while(d<=e){
    const dow=d.getDay();
    // Sla weekenden en feestdagen over
    if(dow!==0&&dow!==6){
      const iso=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
      if(!holidaySet.has(iso))count++;
    }
    d.setDate(d.getDate()+1);
  }
  return count;
}

function openRequestModal(id){
  const r=id?requests.find(x=>x.id===id):null;
  const isEdit=!!r;
  const editType=r?leaveTypes.find(t=>t.id===r.type):null;
  const initCat=(editType&&(editType.category==='afwezigheid'||editType.category==='ziekte'||editType.category==='extern'))?'afwezigheid':'verlof';
  openModal(isEdit?'Aanvraag bewerken':'Nieuwe aanvraag',`
    <div class="form-group">
      <label class="form-label">Medewerker <span class="req">*</span></label>
      <select class="form-input" id="mr-person" ${isEdit?'disabled':''}>
        <option value="">Selecteer...</option>
        ${people.filter(p=>!p.archived).map(p=>`<option value="${p.id}" ${r&&r.personId===p.id?'selected':''}>${fullName(p)}</option>`).join('')}
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Type aanvraag <span class="req">*</span></label>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button type="button" id="mr-btn-verlof" onclick="setRequestCategory('verlof')" style="flex:1;border:2px solid var(--border);border-radius:var(--radius-sm);padding:10px;font-weight:600;cursor:pointer;font-size:13px;transition:all .2s;background:var(--surface)">ğŸ–ï¸ Verlofaanvraag</button>
        <button type="button" id="mr-btn-afwezigheid" onclick="setRequestCategory('afwezigheid')" style="flex:1;border:2px solid var(--border);border-radius:var(--radius-sm);padding:10px;font-weight:600;cursor:pointer;font-size:13px;transition:all .2s;background:var(--surface)">ğŸ“‹ Afwezigheid</button>
      </div>
      <select class="form-input" id="mr-type" onchange="updateDayCount()" style="position:relative;z-index:1">
      </select>
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px">
        <input type="checkbox" id="mr-half" ${r&&r.halfDay?'checked':''} onchange="toggleHalfDay()"/> Halve dag
      </label>
    </div>
    <div id="mr-halfday-opts" style="display:${r&&r.halfDay?'block':'none'};margin-bottom:16px">
      <div class="form-group">
        <label class="form-label">Periode</label>
        <div style="display:flex;gap:8px">
          <button class="btn btn-sm ${r&&r.halfDayPeriod==='VM'?'btn-primary':''}" onclick="setHalfDayPeriod('VM',this)" id="mr-half-vm">â˜€ï¸ Voormiddag</button>
          <button class="btn btn-sm ${r&&r.halfDayPeriod==='NM'?'btn-primary':''}" onclick="setHalfDayPeriod('NM',this)" id="mr-half-nm">ğŸŒ™ Namiddag</button>
        </div>
      </div>
    </div>
    <div class="form-row" id="mr-date-row">
      <div class="form-group">
        <label class="form-label">Van <span class="req">*</span></label>
        <input class="form-input" type="date" id="mr-start" value="${r?r.startDate:''}" onchange="updateDayCount()"/>
      </div>
      <div class="form-group" id="mr-end-group">
        <label class="form-label">Tot <span class="req">*</span></label>
        <input class="form-input" type="date" id="mr-end" value="${r?r.endDate:''}" onchange="updateDayCount()"/>
      </div>
    </div>
    <div id="mr-daycount" style="font-size:12px;color:var(--text3);margin-bottom:12px"></div>
    <div id="mr-conflicts" style="margin-bottom:12px"></div>
    <div class="form-group">
      <label class="form-label">Opmerking</label>
      <textarea class="form-input" id="mr-comment" rows="2" style="resize:vertical">${r?r.comment||'':''}</textarea>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveRequest('${id||''}')">Opslaan</button>
    </div>
  `);
  setRequestCategory(initCat, r?r.type:'');
  if(r)updateDayCount();
}

let _requestCategory='verlof';
function setRequestCategory(cat, preselect){
  _requestCategory=cat;
  var btnV=document.getElementById('mr-btn-verlof');
  var btnA=document.getElementById('mr-btn-afwezigheid');
  if(btnV){btnV.style.background=cat==='verlof'?'var(--accent)':'var(--surface)';btnV.style.color=cat==='verlof'?'white':'var(--text2)';btnV.style.borderColor=cat==='verlof'?'var(--accent)':'var(--border)';}
  if(btnA){btnA.style.background=cat==='afwezigheid'?'var(--accent)':'var(--surface)';btnA.style.color=cat==='afwezigheid'?'white':'var(--text2)';btnA.style.borderColor=cat==='afwezigheid'?'var(--accent)':'var(--border)';}
  var sel=document.getElementById('mr-type');
  if(!sel)return;
  var h='';
  if(cat==='verlof'){
    leaveTypes.filter(function(t){return t.category==='verlof'||t.category==='adv';}).forEach(function(t){
      h+='<option value="'+t.id+'"'+(preselect===t.id?' selected':'')+'>'+t.symbol+' '+t.name+'</option>';
    });
  }else{
    var groups=[{label:'Afwezigheid',cats:['afwezigheid']},{label:'Ziekte',cats:['ziekte']},{label:'Extern (opgelegd)',cats:['extern']}];
    groups.forEach(function(g){
      var types=leaveTypes.filter(function(t){return g.cats.indexOf(t.category)>=0;});
      if(types.length){
        h+='<optgroup label="'+g.label+'">';
        types.forEach(function(t){h+='<option value="'+t.id+'"'+(preselect===t.id?' selected':'')+'>'+t.symbol+' '+t.name+'</option>';});
        h+='</optgroup>';
      }
    });
  }
  sel.innerHTML=h;
}

let selectedHalfDayPeriod='VM';

function toggleHalfDay(){
  const half=document.getElementById('mr-half').checked;
  document.getElementById('mr-halfday-opts').style.display=half?'block':'none';
  document.getElementById('mr-end-group').style.display=half?'none':'';
  if(half){
    document.getElementById('mr-end').value=document.getElementById('mr-start').value;
    selectedHalfDayPeriod='VM';
    document.getElementById('mr-half-vm').classList.add('btn-primary');
    document.getElementById('mr-half-nm').classList.remove('btn-primary');
  }
  updateDayCount();
}

function setHalfDayPeriod(period,btn){
  selectedHalfDayPeriod=period;
  document.getElementById('mr-half-vm').classList.toggle('btn-primary',period==='VM');
  document.getElementById('mr-half-nm').classList.toggle('btn-primary',period==='NM');
}

function updateDayCount(){
  const start=document.getElementById('mr-start').value;
  const end=document.getElementById('mr-end').value;
  const half=document.getElementById('mr-half').checked;
  const dcDiv=document.getElementById('mr-daycount');
  const cfDiv=document.getElementById('mr-conflicts');
  
  if(!start){dcDiv.textContent='';cfDiv.innerHTML='';return;}
  
  const effectiveEnd=half?start:end;
  if(!effectiveEnd){dcDiv.textContent='';cfDiv.innerHTML='';return;}
  
  const days=half?0.5:calcWorkDays(start,effectiveEnd);
  dcDiv.innerHTML=`<span style="font-weight:600;color:var(--accent)">${days} werkdag${days!==1?'en':''}</span>`;
  
  // Check saldo
  const personId=document.getElementById('mr-person').value;
  const typeId=document.getElementById('mr-type').value;
  if(personId){
    const person=people.find(p=>p.id===personId);
    const type=leaveTypes.find(t=>t.id===typeId);
    if(person&&type&&type.tracked){
      const typeAllowance=getAllowanceForType(person,typeId);
      const typeUsed=getUsedDays(person.id,typeId);
      const typeRemaining=typeAllowance-typeUsed;
      if(days>typeRemaining){
        dcDiv.innerHTML+=` <span style="color:var(--danger);font-weight:600">âš ï¸ Onvoldoende ${type.name} saldo (rest: ${typeRemaining}d)</span>`;
      }
    }
  }
  
  // Check conflicts
  if(personId){
    const fakeReq={personId,startDate:start,endDate:effectiveEnd};
    const conflicts=getConflicts(fakeReq);
    if(conflicts.length>0){
      cfDiv.innerHTML=`<div style="padding:10px;border-radius:var(--radius-xs);background:var(--warn-bg);border:1px solid rgba(245,158,11,.2);font-size:12px">
        <div style="font-weight:700;color:var(--warn);margin-bottom:4px">âš ï¸ Conflicten gedetecteerd:</div>
        ${conflicts.map(c=>`<div style="color:var(--text2);padding:2px 0">â€¢ ${c}</div>`).join('')}
      </div>`;
    }else{
      cfDiv.innerHTML='';
    }
  }
}

async function saveRequest(id){
  const personId=document.getElementById('mr-person').value;
  const type=document.getElementById('mr-type').value;
  const startDate=document.getElementById('mr-start').value;
  const half=document.getElementById('mr-half').checked;
  const endDate=half?startDate:document.getElementById('mr-end').value;
  const comment=document.getElementById('mr-comment').value.trim();
  
  if(!personId){showToast('Selecteer een medewerker','error');return;}
  if(!startDate){showToast('Startdatum is verplicht','error');return;}
  if(!half&&!endDate){showToast('Einddatum is verplicht','error');return;}
  if(!half&&endDate<startDate){showToast('Einddatum moet na startdatum liggen','error');return;}
  
  const days=half?0.5:calcWorkDays(startDate,endDate);
  
  // Check max dagen per type (wettelijk maximum klein verlet)
  const typeObj=leaveTypes.find(t=>t.id===type);
  if(typeObj&&typeObj.maxDays>0){
    const year=startDate.substring(0,4);
    const usedThisYear=requests
      .filter(r=>r.personId===personId&&r.type===type&&r.status!=='rejected'&&r.id!==(id||'')&&r.startDate.startsWith(year))
      .reduce((sum,r)=>sum+(r.halfDay?0.5:r.days||0),0);
    const totalAfter=usedThisYear+days;
    if(totalAfter>typeObj.maxDays){
      const msg=`âš ï¸ Maximum ${typeObj.maxDays} dagen ${typeObj.name} per jaar.\n\nAl opgenomen in ${year}: ${usedThisYear}d\nDeze aanvraag: ${days}d\nTotaal: ${totalAfter}d (${totalAfter-typeObj.maxDays}d te veel)\n\nToch doorgaan?`;
      if(!await confirmDialog(msg))return;
    }
  }
  
  // Check verlofregels
  const warnings=checkVerlofregels(personId,startDate,endDate,days);
  if(warnings.length>0&&!id){
    const warnMsg=warnings.map(w=>w.icon+' '+w.msg).join('\n');
    if(!await confirmDialog('âš ï¸ Verlofregels:\n\n'+warnMsg+'\n\nToch doorgaan?'))return;
  }
  
  const isExtern=typeObj&&typeObj.category==='extern';
  
  const data={personId,type,startDate,endDate,days,
    halfDay:half,halfDayPeriod:half?selectedHalfDayPeriod:'',
    comment,status:isExtern?'approved':'pending'};
  
  if(id){
    const r=requests.find(x=>x.id===id);
    if(r)Object.assign(r,data);
  }else{
    requests.push({id:uid(),...data});
  }
  closeModal();autoSave();renderRequests();renderDashboard();
  showToast(isExtern?'Externe afwezigheid geregistreerd (geen goedkeuring nodig)':'Aanvraag opgeslagen');
}

async function approveRequest(id){
  const r=requests.find(x=>x.id===id);
  if(!r)return;
  const conflicts=getConflicts(r);
  if(conflicts.length>0){
    if(!await confirmDialog(`âš ï¸ Er zijn ${conflicts.length} conflict(en):\n\n${conflicts.join('\n')}\n\nToch goedkeuren?`))return;
  }
  r.status='approved';r.decidedDate=new Date().toISOString().split('T')[0];r.decidedBy=settings.currentUser||'Admin';
  // Log approver info
  const person=people.find(x=>x.id===r.personId);
  const dept=person?departments.find(d=>d.id===person.departmentId):null;
  const approverNames=dept?getApproverNames(dept):[];
  if(approverNames.length>0&&!approverNames.includes(r.decidedBy)){
    r.approverNote='Goedgekeurd door '+r.decidedBy+' (verantwoordelijke: '+approverNames.join(', ')+')';
  }
  autoSave();renderRequests();renderDashboard();
  showToast('Aanvraag goedgekeurd âœ…');
}

async function rejectRequest(id){
  const comment=await promptDialog('Reden van weigering (verplicht):','Bv. onvoldoende bezetting');
  if(comment===null)return;
  if(!comment.trim()){showToast('Reden van weigering is verplicht','error');return;}
  const r=requests.find(x=>x.id===id);
  if(!r)return;
  r.status='rejected';r.rejectReason=comment.trim();r.decidedDate=new Date().toISOString().split('T')[0];r.decidedBy=settings.currentUser||'Admin';
  const p=people.find(x=>x.id===r.personId);
  if(p){
    if(!p.mutations)p.mutations=[];
    const typeObj=leaveTypes.find(t=>t.id===r.type);
    p.mutations.push({id:uid(),timestamp:new Date().toISOString(),user:settings.currentUser||'Admin',field:'Aanvraag geweigerd',oldValue:(typeObj?typeObj.name:r.type)+' ('+formatDate(r.startDate)+' \u2192 '+formatDate(r.endDate)+')',newValue:'Reden: '+comment.trim()});
  }
  closeModal();autoSave();renderRequests();renderDashboard();
  showToast('Aanvraag geweigerd');
}

function viewRequest(id){
  const r=requests.find(x=>x.id===id);if(!r)return;
  const person=people.find(p=>p.id===r.personId);
  const type=leaveTypes.find(t=>t.id===r.type);
  const dept=person?departments.find(d=>d.id===person.departmentId):null;
  const approverNames=dept?getApproverNames(dept):[];
  const conflicts=getConflicts(r);
  const dayLabel=r.halfDay?'Â½ dag ('+r.halfDayPeriod+')':r.days+' werkdag'+(r.days!==1?'en':'');
  
  // Saldo berekening per type
  let saldoHtml='';
  if(person){
    const trackedTypes=leaveTypes.filter(t=>t.tracked&&t.category!=='extern');
    const pendingTotal=requests.filter(x=>x.personId===person.id&&x.status==='pending')
      .reduce((s,x)=>{const t=leaveTypes.find(lt=>lt.id===x.type);return s+((t&&t.tracked)?(x.halfDay?0.5:x.days||0):0);},0);
    
    const rows=trackedTypes.map(t=>{
      const total=getAllowanceForType(person,t.id);
      if(total===0&&t.id!=='wettelijk'&&t.id!=='adv')return '';
      const used=getUsedDays(person.id,t.id);
      const pending=requests.filter(x=>x.personId===person.id&&x.type===t.id&&x.status==='pending')
        .reduce((s,x)=>s+(x.halfDay?0.5:x.days||0),0);
      const remaining=total-used;
      const isCurrentType=t.id===r.type;
      return `<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;${isCurrentType?'background:'+t.color+'0d;border-radius:var(--radius-xs);font-weight:600;':''}" >
        <span class="clr-dot" style="background:${t.color}"></span>
        <span style="flex:1;font-size:12px">${t.symbol} ${t.name}</span>
        <span style="font-size:12px;color:${remaining>5?'var(--success)':remaining>0?'var(--warn)':'var(--danger)'};font-weight:700">${remaining}d</span>
        <span style="font-size:10px;color:var(--text3)">/ ${total}d</span>
      </div>`;
    }).filter(Boolean).join('');

    saldoHtml=`<div style="padding:12px;background:var(--surface2);border-radius:var(--radius-sm);margin-bottom:16px">
      <div style="font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">Saldo ${fullName(person)}</div>
      ${rows}
      ${pendingTotal>0?`<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);display:flex;align-items:center;gap:8px;font-size:12px">
        <span style="flex:1;color:var(--warn)">â³ In behandeling</span>
        <span style="font-weight:700;color:var(--warn)">${pendingTotal}d</span>
      </div>`:''}
    </div>`;
  }

  openModal('Aanvraag details',`
    <div style="max-height:80vh;overflow-y:auto">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:12px;background:var(--surface2);border-radius:var(--radius-sm)">
      <div class="avatar" style="background:${person?getAvatarColor(fullName(person)):'#ccc'}">${person?getInitials(fullName(person)):'?'}</div>
      <div><div style="font-weight:700">${person?fullName(person):'Onbekend'}</div><div style="font-size:12px;color:var(--text3)">${dept?dept.name:''}</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:13px;margin-bottom:16px">
      <div><span style="color:var(--text3)">Type:</span> <span class="badge" style="background:${type?type.color+'1a':'#eee'};color:${type?type.color:'#999'}">${type?type.symbol+' '+type.name:'?'}</span></div>
      <div><span style="color:var(--text3)">Dagen:</span> <strong>${dayLabel}</strong></div>
      <div><span style="color:var(--text3)">Van:</span> <strong>${formatDate(r.startDate)}</strong></div>
      <div><span style="color:var(--text3)">Tot:</span> <strong>${formatDate(r.endDate)}</strong></div>
      <div><span style="color:var(--text3)">Status:</span> <span class="badge ${r.status==='approved'?'badge-green':r.status==='rejected'?'badge-red':'badge-yellow'}">${r.status==='approved'?'âœ… Goedgekeurd':r.status==='rejected'?'âŒ Geweigerd':'â³ Openstaand'}</span></div>
      ${r.decidedDate?`<div><span style="color:var(--text3)">Beslist op:</span> <strong>${formatDate(r.decidedDate)}</strong></div>`:''}
      ${r.decidedBy?`<div><span style="color:var(--text3)">Beslist door:</span> <strong>${r.decidedBy}</strong></div>`:''}
      ${approverNames.length>0&&r.status==='pending'?`<div><span style="color:var(--text3)">Goedkeurder${approverNames.length>1?'s':''}:</span> <strong>${approverNames.join(', ')}</strong></div>`:''}
    </div>
    ${saldoHtml}
    ${r.comment?`<div style="padding:10px;background:var(--surface2);border-radius:var(--radius-xs);font-size:12px;margin-bottom:12px"><strong>Opmerking:</strong> ${r.comment}</div>`:''}
    ${r.rejectReason?`<div style="padding:10px;background:var(--danger-bg);border-radius:var(--radius-xs);font-size:12px;margin-bottom:12px;border:1px solid var(--danger-border)"><strong>Reden weigering:</strong> ${r.rejectReason}</div>`:''}
    ${conflicts.length>0?`<div style="padding:10px;border-radius:var(--radius-xs);background:var(--warn-bg);border:1px solid rgba(245,158,11,.2);font-size:12px;margin-bottom:12px">
      <div style="font-weight:700;color:var(--warn);margin-bottom:4px">âš ï¸ Conflicten:</div>
      ${conflicts.map(c=>`<div style="color:var(--text2);padding:2px 0">â€¢ ${c}</div>`).join('')}
    </div>`:''}
    </div>
    ${r.status==='pending'?`<div class="modal-actions">
      <button class="btn" onclick="deleteRequest('${r.id}')" style="color:var(--text3);margin-right:auto">ğŸ—‘ Verwijderen</button>
      <button class="btn btn-danger" onclick="rejectRequest('${r.id}')">âŒ Weigeren</button>
      <button class="btn btn-primary" onclick="approveRequest('${r.id}');closeModal()" style="background:var(--success);border-color:var(--success)">âœ… Goedkeuren</button>
    </div>`:`<div class="modal-actions">
      <button class="btn" onclick="deleteRequest('${r.id}')" style="color:var(--text3)">ğŸ—‘ Verwijderen</button>
      <button class="btn" onclick="closeModal()">Sluiten</button>
    </div>`}
  `);
}

async function deleteRequest(id){
  if(!await confirmDialog('Aanvraag definitief verwijderen? Dit kan niet ongedaan gemaakt worden.'))return;
  const r=requests.find(x=>x.id===id);
  if(r){
    const p=people.find(x=>x.id===r.personId);
    const typeObj=leaveTypes.find(t=>t.id===r.type);
    if(p){
      if(!p.mutations)p.mutations=[];
      p.mutations.push({id:uid(),timestamp:new Date().toISOString(),user:settings.currentUser||'Admin',field:'Aanvraag verwijderd',oldValue:(typeObj?typeObj.name:r.type)+' ('+formatDate(r.startDate)+' \u2192 '+formatDate(r.endDate)+')',newValue:'Status was: '+(r.status==='approved'?'goedgekeurd':r.status==='rejected'?'geweigerd':'openstaand')});
    }
  }
  requests=requests.filter(x=>x.id!==id);
  closeModal();autoSave();renderRequests();renderDashboard();
  showToast('Aanvraag verwijderd');
}

// --- Sickness ---
let sickFilter='active';

function renderSickness(){
  const tbody=document.getElementById('sickness-table');
  const today=new Date().toISOString().split('T')[0];
  let sickRequests=requests.filter(r=>r.type==='ziekte');
  if(sickFilter==='active'){
    sickRequests=sickRequests.filter(r=>r.endDate>=today);
  }
  sickRequests.sort((a,b)=>new Date(b.startDate)-new Date(a.startDate));
  
  if(sickRequests.length===0){
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3)">Geen ziekmeldingen gevonden</td></tr>';
    return;
  }
  tbody.innerHTML=sickRequests.map(r=>{
    const person=people.find(p=>p.id===r.personId);
    const dept=person?departments.find(d=>d.id===person.departmentId):null;
    const isActive=r.endDate>=today;
    const hasCert=r.sickCertificate;
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:10px">
        <div class="avatar" style="background:${person?getAvatarColor(fullName(person)):'#ccc'};width:28px;height:28px;font-size:11px">${person?getInitials(fullName(person)):'?'}</div>
        <div><div style="font-weight:600;font-size:13px">${person?fullName(person):'Onbekend'}</div>
        <div style="font-size:11px;color:var(--text3)">${dept?dept.name:''}</div></div>
      </div></td>
      <td style="font-size:12px;font-weight:600">${formatDate(r.startDate)}</td>
      <td style="font-size:12px;font-weight:600">${formatDate(r.endDate)}</td>
      <td style="font-weight:600">${r.days}d</td>
      <td>${hasCert?'<span class="badge badge-green">âœ… Ontvangen</span>':'<span class="badge badge-yellow">âš ï¸ Ontbreekt</span>'}</td>
      <td>
        ${r.notifiedHR?'<span class="badge badge-green" style="font-size:10px">HR âœ…</span>':''}
        ${r.notifiedDept?'<span class="badge badge-green" style="font-size:10px">Divisie âœ…</span>':''}
        ${!r.notifiedHR&&!r.notifiedDept?'<span style="color:var(--text3);font-size:12px">â€”</span>':''}
      </td>
      <td style="text-align:right">
        ${!hasCert?`<button class="btn btn-sm" onclick="uploadCertificate('${r.id}')">ğŸ“„ Briefje</button>`:''}
        <button class="btn btn-sm" onclick="editSickness('${r.id}')">âœï¸</button>
        ${!r.notifiedHR?`<button class="btn btn-sm" onclick="notifySickness('${r.id}')" title="Mail/SMS versturen" aria-label="Mail/SMS versturen">ğŸ“§</button>`:''}
        <button class="btn btn-sm btn-danger" onclick="deleteSickness('${r.id}')">ğŸ—‘</button>
      </td>
    </tr>`;
  }).join('');

  // Bradford Factor calculation
  renderBradford();
}

let bradfordAsc=false;
function sortBradford(){bradfordAsc=!bradfordAsc;renderBradford();}

function renderBradford(){
  const tbody=document.getElementById('bradford-table');
  const now=new Date();
  const yearAgo=new Date(now);yearAgo.setFullYear(yearAgo.getFullYear()-1);
  const yearAgoStr=yearAgo.toISOString().split('T')[0];

  let scores=people.map(p=>{
    const sickReqs=requests.filter(r=>r.type==='ziekte'&&r.personId===p.id&&r.startDate>=yearAgoStr);
    const S=sickReqs.length; // number of spells
    const D=sickReqs.reduce((sum,r)=>sum+(r.halfDay?0.5:r.days||0),0); // total days
    const B=S*S*D; // Bradford Factor
    return {person:p,S,D,B};
  }).filter(x=>x.S>0);

  scores.sort((a,b)=>bradfordAsc?a.B-b.B:b.B-a.B);
  document.getElementById('sort-bradford').textContent=bradfordAsc?'â†‘':'â†“';

  if(scores.length===0){
    tbody.innerHTML='<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text3)">Geen ziekteverzuim in de afgelopen 52 weken</td></tr>';
    return;
  }

  tbody.innerHTML=scores.map(x=>{
    const riskColor=x.B>=900?'var(--danger)':x.B>=200?'var(--warn)':x.B>=50?'#f59e0b':'var(--success)';
    const riskLabel=x.B>=900?'Kritiek':x.B>=200?'Hoog':x.B>=50?'Aandacht':'Laag';
    const riskBadge=x.B>=900?'badge-red':x.B>=200?'badge-yellow':x.B>=50?'badge-yellow':'badge-green';
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:8px">
        <div class="avatar" style="background:${getAvatarColor(fullName(x.person))};width:26px;height:26px;font-size:10px">${getInitials(fullName(x.person))}</div>
        <span style="font-weight:600">${fullName(x.person)}</span>
      </div></td>
      <td style="text-align:center;font-weight:600">${x.S}</td>
      <td style="text-align:center;font-weight:600">${x.D}d</td>
      <td style="text-align:center;font-weight:700;font-size:15px;color:${riskColor}">${Math.round(x.B)}</td>
      <td><span class="badge ${riskBadge}">${riskLabel}</span></td>
    </tr>`;
  }).join('');
}

function filterSickness(filter,btn){
  sickFilter=filter;
  btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  renderSickness();
}

function openSicknessModal(id){
  const r=id?requests.find(x=>x.id===id):null;
  const today=new Date().toISOString().split('T')[0];
  openModal(r?'Ziekmelding bewerken':'Ziekmelding registreren',`
    <div class="form-group">
      <label class="form-label">Medewerker <span class="req">*</span></label>
      <select class="form-input" id="ms-person" ${r?'disabled':''}>
        <option value="">Selecteer...</option>
        ${people.map(p=>`<option value="${p.id}" ${r&&r.personId===p.id?'selected':''}>${fullName(p)}</option>`).join('')}
      </select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Van <span class="req">*</span></label>
        <input class="form-input" type="date" id="ms-start" value="${r?r.startDate:today}"/>
      </div>
      <div class="form-group">
        <label class="form-label">Tot (verwacht) <span class="req">*</span></label>
        <input class="form-input" type="date" id="ms-end" value="${r?r.endDate:today}"/>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Opmerking</label>
      <textarea class="form-input" id="ms-comment" rows="2" style="resize:vertical">${r?r.comment||'':''}</textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Doktersbriefje (afbeelding)</label>
      <input type="file" accept="image/*" class="form-input" id="ms-cert" style="padding:6px"/>
    </div>
    <div id="ms-ocr-result" style="display:none;margin-bottom:12px;padding:10px;background:var(--accent-bg);border-radius:var(--radius-xs);font-size:12px"></div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px">
        <input type="checkbox" id="ms-notify" checked/> Mail/SMS versturen naar HR + divisie-verantwoordelijke
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveSickness('${id||''}')">Registreren</button>
    </div>
  `);
  // OCR on file select
  document.getElementById('ms-cert').addEventListener('change',handleCertUpload);
}

function handleCertUpload(e){
  const file=e.target.files[0];
  if(!file)return;
  const resultDiv=document.getElementById('ms-ocr-result');
  resultDiv.style.display='block';
  resultDiv.innerHTML='<span style="color:var(--accent)">ğŸ”„ Briefje wordt verwerkt (OCR)...</span>';
  
  const reader=new FileReader();
  reader.onload=function(ev){
    // Simple OCR simulation â€” in production, use Tesseract.js
    // For now we extract what we can from the filename and show the image
    const img=ev.target.result;
    resultDiv.innerHTML=`
      <div style="font-weight:700;margin-bottom:6px">ğŸ“„ Doktersbriefje ontvangen</div>
      <div style="color:var(--text2)">OCR-analyse: voor volledige OCR-functionaliteit is Tesseract.js vereist (wordt geladen bij eerste gebruik).</div>
      <div style="margin-top:8px"><img src="${img}" style="max-width:200px;border-radius:var(--radius-xs);border:1px solid var(--border)" alt="Kandidaat foto"/></div>
    `;
    // Store the image data
    resultDiv.dataset.certImage=img;
  };
  reader.readAsDataURL(file);
}

function saveSickness(id){
  const personId=document.getElementById('ms-person').value;
  const startDate=document.getElementById('ms-start').value;
  const endDate=document.getElementById('ms-end').value;
  const comment=document.getElementById('ms-comment').value.trim();
  const notify=document.getElementById('ms-notify').checked;
  const certResult=document.getElementById('ms-ocr-result');
  const hasCert=certResult.dataset&&certResult.dataset.certImage;
  
  if(!personId){showToast('Selecteer een medewerker','error');return;}
  if(!startDate){showToast('Startdatum is verplicht','error');return;}
  if(!endDate){showToast('Einddatum is verplicht','error');return;}
  
  const days=calcWorkDays(startDate,endDate);
  const person=people.find(p=>p.id===personId);
  const dept=person?departments.find(d=>d.id===person.departmentId):null;
  const approvers=dept?getApproverIds(dept).map(id=>people.find(p=>p.id===id)).filter(Boolean):[];
  
  const data={personId,type:'ziekte',startDate,endDate,days,halfDay:false,halfDayPeriod:'',
    comment,status:'approved',sickCertificate:!!hasCert,certImage:hasCert||'',
    notifiedHR:false,notifiedDept:false};
  
  if(id){
    const r=requests.find(x=>x.id===id);
    if(r)Object.assign(r,data);
  }else{
    requests.push({id:uid(),...data});
  }
  
  // Send notifications
  if(notify){
    const r=requests[requests.length-1]||requests.find(x=>x.id===id);
    if(r){
      r.notifiedHR=true;r.notifiedDept=true;
      const subject=encodeURIComponent(`Ziekmelding: ${person?fullName(person):'Medewerker'} â€” ${formatDate(startDate)} t/m ${formatDate(endDate)}`);
      const body=encodeURIComponent(`Beste,\n\n${person?fullName(person):'Een medewerker'} is ziek gemeld van ${formatDate(startDate)} tot ${formatDate(endDate)}.\n${comment?'Opmerking: '+comment+'\n':''}\nMet vriendelijke groeten,\nPersoneelbeheer Advanced Energy`);
      const approverEmails=approvers.map(a=>a.email).filter(Boolean).join(',');
      window.open(`mailto:hr@advancedenergy.be${approverEmails?','+approverEmails:''}?subject=${subject}&body=${body}`,'_blank');
      showToast('Ziekmelding geregistreerd â€” mail geopend ğŸ“§');
    }
  }else{
    showToast('Ziekmelding geregistreerd');
  }
  
  closeModal();autoSave();renderSickness();renderDashboard();
}

function editSickness(id){openSicknessModal(id);}

function uploadCertificate(id){
  const r=requests.find(x=>x.id===id);if(!r)return;
  openModal('Doktersbriefje uploaden',`
    <div class="form-group">
      <label class="form-label">Selecteer afbeelding van doktersbriefje</label>
      <input type="file" accept="image/*" class="form-input" id="uc-file" style="padding:6px"/>
    </div>
    <div id="uc-preview" style="margin-bottom:12px"></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveCertificate('${id}')">Opslaan</button>
    </div>
  `);
  document.getElementById('uc-file').addEventListener('change',function(e){
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=function(ev){
      document.getElementById('uc-preview').innerHTML=`<img src="${ev.target.result}" style="max-width:300px;border-radius:var(--radius-xs);border:1px solid var(--border)" alt="Foto preview"/>`;
      document.getElementById('uc-preview').dataset.img=ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function saveCertificate(id){
  const preview=document.getElementById('uc-preview');
  if(!preview.dataset.img){showToast('Selecteer eerst een afbeelding','error');return;}
  const r=requests.find(x=>x.id===id);
  if(r){r.sickCertificate=true;r.certImage=preview.dataset.img;}
  closeModal();autoSave();renderSickness();
  showToast('Doktersbriefje opgeslagen âœ…');
}

function notifySickness(id){
  const r=requests.find(x=>x.id===id);if(!r)return;
  const person=people.find(p=>p.id===r.personId);
  const dept=person?departments.find(d=>d.id===person.departmentId):null;
  const approvers=dept?getApproverIds(dept).map(id=>people.find(p=>p.id===id)).filter(Boolean):[];
  
  const subject=encodeURIComponent(`Ziekmelding: ${person?fullName(person):'Medewerker'} â€” ${formatDate(r.startDate)} t/m ${formatDate(r.endDate)}`);
  const body=encodeURIComponent(`Beste,\n\n${person?fullName(person):'Een medewerker'} is ziek gemeld van ${formatDate(r.startDate)} tot ${formatDate(r.endDate)}.\n${r.comment?'Opmerking: '+r.comment+'\n':''}\nMet vriendelijke groeten,\nPersoneelbeheer Advanced Energy`);
  const approverEmails=approvers.map(a=>a.email).filter(Boolean).join(',');
  window.open(`mailto:hr@advancedenergy.be${approverEmails?','+approverEmails:''}?subject=${subject}&body=${body}`,'_blank');
  r.notifiedHR=true;r.notifiedDept=true;
  autoSave();renderSickness();
  showToast('Mail geopend â€” notificatie verstuurd ğŸ“§');
}

async function deleteSickness(id){
  if(!await confirmDialog('Ziekmelding verwijderen?'))return;
  requests=requests.filter(x=>x.id!==id);
  autoSave();renderSickness();renderDashboard();
  showToast('Ziekmelding verwijderd');
}

// â•â•â• SAVE FUNCTIONS â•â•â•

// --- Departments ---
function openDeptModal(id){
  const d=id?departments.find(x=>x.id===id):null;
  const parentOpts=departments.filter(x=>x.id!==id).map(x=>`<option value="${x.id}" ${d&&d.parentDeptId===x.id?'selected':''}>${x.name}</option>`).join('');
  const managerOpts=people.filter(p=>!p.archived).map(p=>`<option value="${p.id}" ${d&&d.managerId===p.id?'selected':''}>${fullName(p)}</option>`).join('');
  const approverIds=d?getApproverIds(d):[];
  const approverChecks=people.filter(p=>!p.archived&&(p.isApprover||p.role==='admin')).map(p=>{
    const checked=approverIds.includes(p.id)?'checked':'';
    return `<label style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:12px;cursor:pointer"><input type="checkbox" class="md-approver-cb" value="${p.id}" ${checked} style="width:14px;height:14px;accent-color:var(--accent)"/> ${fullName(p)}</label>`;
  }).join('');
  openModal(d?'Department bewerken':'Department toevoegen',`
    <div class="form-group">
      <label class="form-label">Naam <span class="req">*</span></label>
      <input class="form-input" id="md-name" value="${d?d.name:''}" onkeydown="if(event.key==='Enter')saveDept('${id||''}')"/>
    </div>
    <div class="form-row">
      <div class="form-group" style="flex:1">
        <label class="form-label">Verlofgoedkeurder(s) <span class="fi" onclick="toggleFieldInfo('info-dept-approver')">â“˜</span></label>
        <div style="max-height:150px;overflow-y:auto;padding:6px 8px;border:1px solid var(--border);border-radius:var(--radius-xs);background:var(--surface)">
          ${approverChecks||'<span style="font-size:11px;color:var(--text3)">Geen medewerkers met approver-rechten</span>'}
        </div>
        <div class="fi-box" id="info-dept-approver" style="display:none">EÃ©n of meerdere personen die verlofaanvragen goedkeuren voor dit department. EÃ©n goedkeuring volstaat.</div>
      </div>
      <div class="form-group" style="flex:1">
        <label class="form-label">Manager <span class="fi" onclick="toggleFieldInfo('info-dept-manager')">â“˜</span></label>
        <select class="form-input" id="md-manager">
          <option value="">Geen manager</option>
          ${managerOpts}
        </select>
        <div class="fi-box" id="info-dept-manager" style="display:none">De verantwoordelijke voor dit department. Wordt getoond als hoofd in het organigram. Dit is niet noodzakelijk dezelfde persoon als de approver.</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Parent department <span class="fi" onclick="toggleFieldInfo('info-dept-parent')">â“˜</span></label>
      <select class="form-input" id="md-parent">
        <option value="">Geen (top-level)</option>
        ${parentOpts}
      </select>
      <div class="fi-box" id="info-dept-parent" style="display:none">Optioneel: als dit department onder een ander department valt, selecteer dan het bovenliggende department. Dit creÃ«ert een extra niveau in het organigram.</div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveDept('${id||''}')">Opslaan</button>
    </div>
  `);
}

function getApproverIds(d){
  if(!d)return [];
  if(Array.isArray(d.approverIds))return d.approverIds;
  // Upgrade path: oud formaat approverId (string) â†’ array
  if(d.approverId)return [d.approverId];
  return [];
}

function getApproverNames(d){
  return getApproverIds(d).map(id=>people.find(p=>p.id===id)).filter(Boolean).map(p=>fullName(p));
}

function saveDept(id){
  const name=document.getElementById('md-name').value.trim();
  const approverIds=[...document.querySelectorAll('.md-approver-cb:checked')].map(cb=>cb.value);
  const managerId=document.getElementById('md-manager').value;
  const parentDeptId=document.getElementById('md-parent').value;
  if(!name){showToast('Naam is verplicht','error');return;}
  if(id){
    const d=departments.find(x=>x.id===id);
    if(d){d.name=name;d.approverIds=approverIds;d.managerId=managerId;d.parentDeptId=parentDeptId;delete d.approverId;}
  }else{
    departments.push({id:uid(),name,approverIds,managerId,parentDeptId});
  }
  closeModal();autoSave();renderDepartments();
  showToast('Department opgeslagen');
}

async function deleteDept(id){
  if(!await confirmDialog('Department verwijderen?'))return;
  const count=people.filter(p=>p.departmentId===id&&!p.archived).length;
  if(count>0){showToast(`Kan niet verwijderen: ${count} medewerker(s) toegewezen`,'error');return;}
  departments=departments.filter(d=>d.id!==id);
  autoSave();renderDepartments();showToast('Department verwijderd');
}

// --- People ---
function openPersonModal(id){
  const p=id?people.find(x=>x.id===id):null;
  openModal(p?'Medewerker bewerken':'Medewerker toevoegen',`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <!-- LINKS: Persoonlijk -->
      <div>
        <div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">Persoonlijke gegevens</div>
        <div class="form-group"><label class="form-label">Voornaam <span class="req">*</span></label><input class="form-input" id="mp-firstname" value="${p?p.firstName:''}"/></div>
        <div class="form-group"><label class="form-label">Naam <span class="req">*</span></label><input class="form-input" id="mp-lastname" value="${p?p.lastName:''}"/></div>
        <div class="form-group"><label class="form-label">E-mail <span class="req">*</span></label><input class="form-input" type="email" id="mp-email" value="${p?p.email:''}"/></div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ğŸ“± GSM</label><input class="form-input" type="tel" onblur="this.value=formatPhone(this.value)" id="mp-gsm" value="${p?p.gsm||'':''}" placeholder="+32 4xx xx xx xx"/></div>
          <div class="form-group"><label class="form-label">ğŸ“ Telefoon</label><input class="form-input" type="tel" onblur="this.value=formatPhone(this.value)" id="mp-tel" value="${p?p.tel||'':''}" placeholder="+32 xx xx xx xx"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ğŸ¦ Bankrekeningnummer</label><input class="form-input" type="text" id="mp-iban" value="${p?p.iban||'':''}" placeholder="BE00 0000 0000 0000"/></div>
          <div class="form-group"><label class="form-label">ğŸ‚ Geboortedatum</label><input class="form-input" type="date" id="mp-birthdate" value="${p?p.birthDate||'':''}"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ğŸ†” Rijksregisternummer</label><input class="form-input" type="text" id="mp-rrn" value="${p?p.rrn||'':''}" placeholder="00.00.00-000.00"/></div>
          <div class="form-group"></div>
        </div>
      </div>
      <!-- RECHTS: Bedrijfsgegevens -->
      <div>
        <div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">Bedrijfsgegevens</div>
        <div class="form-group"><label class="form-label">Department <span class="req">*</span></label>
          <select class="form-input" id="mp-dept" onchange="syncPersonFields()"><option value="">Selecteer...</option>
            ${departments.map(d=>`<option value="${d.id}" ${p&&p.departmentId===d.id?'selected':''}>${d.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group" id="mp-cat-group" style="display:none"><label class="form-label">Categorie <span class="fi" onclick="toggleFieldInfo('info-cat')">â“˜</span></label>
          <select class="form-input" id="mp-cat">
            <option value="">Selecteer...</option>
            ${BAREMA_CATEGORIES.map(c=>`<option value="${c.id}" ${p&&p.baremaCategory===c.id?'selected':''}>${c.id} â€” ${c.name}</option>`).join('')}
          </select>
          <div class="fi-box" id="info-cat" style="display:none">De baremacategorie bepaalt het minimumloon volgens PC 149.01. Hogere categorie = hoger minimumloon. CategorieÃ«n gaan van A (hulpwerkman) tot F (geschoolde werkman).</div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Statuut</label>
            <select class="form-input" id="mp-statuut" onchange="syncPersonFields()">
              <option value="bediende" ${p&&p.statuut==='bediende'?'selected':''}>Bediende</option>
              <option value="arbeider" ${p&&p.statuut==='arbeider'?'selected':''}>Arbeider</option>
              <option value="interim" ${p&&p.statuut==='interim'?'selected':''}>Interim</option>
              <option value="zelfstandige" ${p&&p.statuut==='zelfstandige'?'selected':''}>Zelfstandige</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">Paritair comitÃ© <span class="fi" onclick="toggleFieldInfo('info-pc')">â“˜</span></label>
            <select class="form-input" id="mp-pc" onchange="syncPersonFields()">
              <option value="" ${!p||!p.paritairComite?'selected':''}>Selecteer...</option>
              <option value="200" ${p&&p.paritairComite==='200'?'selected':''}>200 â€” Bedienden</option>
              <option value="201" ${p&&p.paritairComite==='201'?'selected':''}>201 â€” Bedienden</option>
              <option value="149.01" ${p&&p.paritairComite==='149.01'?'selected':''}>149.01 â€” Arbeiders</option>
              <option value="nvt" ${p&&p.paritairComite==='nvt'?'selected':''}>N.v.t.</option>
            </select>
            <div class="fi-box" id="info-pc" style="display:none">Het paritair comitÃ© bepaalt de loon- en arbeidsvoorwaarden. PC 149.01 activeert het baremasysteem met automatische loonberekening.</div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Rol <span class="fi" onclick="toggleFieldInfo('info-role')">â“˜</span></label>
            <select class="form-input" id="mp-role" onchange="syncPersonFields()">
              <option value="user" ${p&&p.role==='user'?'selected':''}>User</option>
              <option value="admin" ${p&&p.role==='admin'?'selected':''}>Admin</option>
            </select>
            <div class="fi-box" id="info-role" style="display:none">Systeemrol: Admin heeft toegang tot alle instellingen en data. User ziet enkel eigen gegevens.</div>
          </div>
          <div class="form-group"><label class="form-label">Approver <span class="fi" onclick="toggleFieldInfo('info-approver')">â“˜</span></label>
            <div style="display:flex;align-items:center;gap:8px;height:36px">
              <input type="checkbox" id="mp-approver" ${p&&p.isApprover?'checked':''} style="width:16px;height:16px;cursor:pointer"/>
              <label for="mp-approver" style="font-size:12px;color:var(--text2);cursor:pointer">Kan verlof goedkeuren</label>
            </div>
            <div class="fi-box" id="info-approver" style="display:none">Bepaalt wie verlofaanvragen goedkeurt of weigert voor dit department. Dit is niet hetzelfde als de Manager (verantwoordelijke).</div>
          </div>
          <div class="form-group"><label class="form-label">Werkrooster</label>
            <select class="form-input" id="mp-schedule">
              ${schedules.map(s=>`<option value="${s.id}" ${p&&p.scheduleId===s.id?'selected':''}>${s.name}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="form-group"><label class="form-label">Teamrol <span class="fi" onclick="toggleFieldInfo('info-teamrole')">â“˜</span></label>
          <select class="form-input" id="mp-teamrole" onchange="if(this.value==='__other__'){this.style.display='none';document.getElementById('mp-teamrole-custom').style.display=''}">
            <option value="" ${!p||!p.teamRole?'selected':''}>â€” Niet ingesteld â€”</option>
            <option value="Zaakvoerder" ${p&&p.teamRole==='Zaakvoerder'?'selected':''}>Zaakvoerder</option>
            <option value="Manager" ${p&&p.teamRole==='Manager'?'selected':''}>Manager</option>
            <option value="Ploegleider" ${p&&p.teamRole==='Ploegleider'?'selected':''}>Ploegleider</option>
            <option value="Technieker" ${p&&p.teamRole==='Technieker'?'selected':''}>Technieker</option>
            <option value="Senior technieker" ${p&&p.teamRole==='Senior technieker'?'selected':''}>Senior technieker</option>
            <option value="Administratief" ${p&&p.teamRole==='Administratief'?'selected':''}>Administratief</option>
            <option value="Stagiair" ${p&&p.teamRole==='Stagiair'?'selected':''}>Stagiair</option>
            <option value="__other__" ${p&&p.teamRole&&!['Zaakvoerder','Manager','Ploegleider','Technieker','Senior technieker','Administratief','Stagiair'].includes(p.teamRole)?'selected':''}>Andere...</option>
          </select>
          <input class="form-input" id="mp-teamrole-custom" placeholder="Vul je eigen rol in..." value="${p&&p.teamRole&&!['Zaakvoerder','Manager','Ploegleider','Technieker','Senior technieker','Administratief','Stagiair'].includes(p.teamRole)?p.teamRole:''}" style="display:${p&&p.teamRole&&!['Zaakvoerder','Manager','Ploegleider','Technieker','Senior technieker','Administratief','Stagiair'].includes(p.teamRole)?'':'none'};margin-top:4px"/>
          <div class="fi-box" id="info-teamrole" style="display:none">De operationele functie binnen het team (bv. Ploegleider, Technieker). Dit bepaalt de positie in het organigram. Heeft geen invloed op systeemrechten of verlofgoedkeuring.</div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Startdatum</label><input class="form-input" type="date" id="mp-start" value="${p?p.startDate:''}"/></div>
          <div class="form-group"><label class="form-label">Einddatum <span style="font-weight:400;color:var(--text3)">(einde contract)</span></label><input class="form-input" type="date" id="mp-end-contract" value="${p?p.endDate||'':''}"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ğŸ“± Werk GSM</label><input class="form-input" type="tel" onblur="this.value=formatPhone(this.value)" id="mp-werkgsm" value="${p?p.werkGsm||'':''}" placeholder="+32 4xx xx xx xx"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">ğŸ“‹ Saldo OV (uren)</label><input class="form-input" type="number" step="0.5" min="0" id="mp-saldo-ov" value="${p&&p.saldoOV!=null?p.saldoOV:''}" placeholder="0"/></div>
          <div class="form-group"></div>
        </div>
        <div id="mp-interim-fields" style="display:${p&&p.statuut==='interim'?'block':'none'}">
          <div class="form-row">
            <div class="form-group"><label class="form-label">ğŸ“‹ Interim dagen</label><input class="form-input" type="number" step="1" min="0" id="mp-interim-dagen" value="${p&&p.interimDagen!=null?p.interimDagen:''}" placeholder="Aantal werkdagen interim contract"/></div>
            <div class="form-group"><label class="form-label">â³ Interim counter</label><div class="form-input" style="background:var(--surface2);cursor:default" id="mp-interim-counter">${p&&p.statuut==='interim'&&p.interimDagen?calcInterimCounter(p)+'d resterend':'â€”'}</div></div>
          </div>
        </div>
      </div>
    </div>
    <div style="margin-top:12px;padding-top:12px;border-top:2px dashed var(--border)">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
        <div>
          <div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">ğŸš¨ Noodnummer</div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Contactpersoon</label><input class="form-input" id="mp-nood-naam" value="${p?p.noodNaam||'':''}" placeholder="Naam"/></div>
            <div class="form-group"><label class="form-label">Relatie</label>
              <select class="form-input" id="mp-nood-relatie">
                <option value="" ${!p||!p.noodRelatie?'selected':''}>Selecteer...</option>
                <option value="partner" ${p&&p.noodRelatie==='partner'?'selected':''}>Partner</option>
                <option value="echtgeno(o)t(e)" ${p&&p.noodRelatie==='echtgeno(o)t(e)'?'selected':''}>Echtgeno(o)t(e)</option>
                <option value="mama" ${p&&p.noodRelatie==='mama'?'selected':''}>Mama</option>
                <option value="papa" ${p&&p.noodRelatie==='papa'?'selected':''}>Papa</option>
                <option value="broer" ${p&&p.noodRelatie==='broer'?'selected':''}>Broer</option>
                <option value="zus" ${p&&p.noodRelatie==='zus'?'selected':''}>Zus</option>
                <option value="vriend(in)" ${p&&p.noodRelatie==='vriend(in)'?'selected':''}>Vriend(in)</option>
                <option value="andere" ${p&&p.noodRelatie==='andere'?'selected':''}>Andere</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label class="form-label">ğŸ“± GSM noodcontact</label><input class="form-input" type="tel" onblur="this.value=formatPhone(this.value)" id="mp-nood-gsm" value="${p?p.noodGsm||'':''}" placeholder="+32 4xx xx xx xx"/></div>
        </div>
        <div></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="savePerson('${id||''}')">Opslaan</button>
    </div>
  `,true);
  if(p){
    const showSalary=p.paritairComite==='149.01';
    const showChecklist=true;
    const clCompleted=p.checklistState&&p.checklistState._completed;
    const fromReport=window._fromReport;window._fromReport=false;
    const fromRequests=window._fromRequests;window._fromRequests=false;
    document.getElementById('modal-title-actions').innerHTML=`
      ${fromReport?`<button class="btn btn-sm" onclick="closeModal();navigate('reports');renderReports()" style="font-size:11px;border-color:var(--accent);color:var(--accent)">â† Rapport</button>`:''}
      ${fromRequests?`<button class="btn btn-sm" onclick="closeModal();navigate('requests')" style="font-size:11px;border-color:var(--accent);color:var(--accent)">â† Aanvragen</button>`:''}
      <button class="btn btn-sm" onclick="closeModal();openSaldoModal('${id}')" style="font-size:11px">ğŸ“Š Saldo</button>
      <button class="btn btn-sm" onclick="closeModal();openMutationsModal('${id}')" style="font-size:11px">ğŸ“ Mutaties</button>
      <button class="btn btn-sm" onclick="closeModal();openPersonCalendar('${id}')" style="font-size:11px">ğŸ“… Kalender</button>
      <button class="btn btn-sm" onclick="closeModal();openDocumentsModal('${id}')" style="font-size:11px">ğŸ“ Documenten</button>
      ${showChecklist?`<button class="btn btn-sm" onclick="closeModal();openChecklist('${id}')" style="font-size:11px;color:${clCompleted?'var(--success)':'var(--accent)'}">${clCompleted?'âœ…':'â˜‘ï¸'} Checklist</button>`:''}
      ${showSalary?`<button class="btn btn-sm" onclick="closeModal();openSalaryModal('${id}')" style="font-size:11px">ğŸ’¶ Salaris</button>`:''}
      <button class="btn btn-sm" onclick="archivePerson('${id}')" style="font-size:11px;color:var(--text3)">ğŸ“¦ Archief</button>`;
  }
  setTimeout(syncPersonFields,50);
}

function syncPersonFields(){
  const dept=document.getElementById('mp-dept').value;
  const statuut=document.getElementById('mp-statuut');
  const pc=document.getElementById('mp-pc');
  const role=document.getElementById('mp-role');

  const arbeiderDepts=['dept-install','dept-service','dept-onderhoud'];
  const bediendeDepts=['dept-back','dept-verkoop'];
  const opts=statuut.querySelectorAll('option');
  // opts[0]=bediende, opts[1]=arbeider, opts[2]=interim, opts[3]=zelfstandige

  // Zelfstandige is altijd beschikbaar in elk department
  opts[3].disabled=false;

  if(arbeiderDepts.includes(dept)){
    opts[0].disabled=true;  // bediende niet
    opts[1].disabled=false; // arbeider wel
    opts[2].disabled=false; // interim wel
    if(statuut.value==='bediende')statuut.value='arbeider';
  }else if(bediendeDepts.includes(dept)){
    opts[0].disabled=false; // bediende wel
    opts[1].disabled=true;  // arbeider niet
    opts[2].disabled=false; // interim wel
    if(statuut.value==='arbeider')statuut.value='bediende';
  }else if(dept==='dept-directie'){
    opts[0].disabled=true;  // bediende niet
    opts[1].disabled=true;  // arbeider niet
    opts[2].disabled=true;  // interim niet
    if(statuut.value!=='zelfstandige')statuut.value='zelfstandige';
  }else{
    opts.forEach(o=>o.disabled=false);
  }

  // PC op basis van statuut
  if(statuut.value==='arbeider'){
    pc.value='149.01';pc.disabled=true;
  }else if(statuut.value==='interim'){
    // Interim kan arbeider (149.01) of bediende PC hebben â€” vrij te kiezen
    pc.disabled=false;
    if(pc.value==='nvt'||pc.value==='')pc.value='149.01';
  }else if(statuut.value==='zelfstandige'){
    pc.value='nvt';pc.disabled=true;
  }else if(statuut.value==='bediende'){
    pc.disabled=false;
    if(pc.value==='149.01'||pc.value==='nvt'||pc.value==='')pc.value='200';
  }

  // Categorie alleen bij PC 149.01
  const catGroup=document.getElementById('mp-cat-group');
  if(catGroup)catGroup.style.display=pc.value==='149.01'?'':'none';

  // Interim velden tonen/verbergen
  const interimFields=document.getElementById('mp-interim-fields');
  if(interimFields){
    interimFields.style.display=statuut.value==='interim'?'block':'none';
    // Als statuut net naar interim is gezet en interimDagen nog leeg is, toon popup-achtige highlight
    if(statuut.value==='interim'&&statuut.dataset.prev!=='interim'){
      const dagenInput=document.getElementById('mp-interim-dagen');
      if(dagenInput&&!dagenInput.value){
        // Scroll naar en highlight het interim veld
        setTimeout(function(){
          dagenInput.scrollIntoView({block:'center',behavior:'smooth'});
          dagenInput.style.boxShadow='0 0 0 3px rgba(168,85,247,.35)';
          dagenInput.style.borderColor='#a855f7';
          dagenInput.focus();
          dagenInput.placeholder='â¬… Hoeveel werkdagen interim contract? (optioneel)';
          setTimeout(function(){
            dagenInput.style.boxShadow='';
            dagenInput.style.borderColor='';
            dagenInput.placeholder='Aantal werkdagen interim contract';
          },3000);
        },100);
      }
    }
    // Als statuut weg van interim gaat, wis de interim-velden
    if(statuut.value!=='interim'){
      const dagenInput=document.getElementById('mp-interim-dagen');
      if(dagenInput)dagenInput.value='';
    }
  }
  statuut.dataset.prev=statuut.value;
}

function savePerson(id){
  const firstName=document.getElementById('mp-firstname').value.trim();
  const lastName=document.getElementById('mp-lastname').value.trim();
  const email=document.getElementById('mp-email').value.trim();
  const departmentId=document.getElementById('mp-dept').value;
  const role=document.getElementById('mp-role').value;
  const isApprover=document.getElementById('mp-approver').checked;
  const startDate=document.getElementById('mp-start').value;
  const scheduleId=document.getElementById('mp-schedule').value;
  const statuut=document.getElementById('mp-statuut').value;
  const paritairComite=document.getElementById('mp-pc').value;
  const baremaCategory=paritairComite==='149.01'?document.getElementById('mp-cat').value:'';
  const gsm=formatPhone(document.getElementById('mp-gsm').value.trim());
  const tel=formatPhone(document.getElementById('mp-tel').value.trim());
  const iban=document.getElementById('mp-iban').value.trim();
  const birthDate=document.getElementById('mp-birthdate').value;
  const rrn=document.getElementById('mp-rrn').value.trim();
  const saldoOVval=document.getElementById('mp-saldo-ov').value;
  const saldoOV=saldoOVval!==''?parseFloat(saldoOVval):null;
  const interimDagenVal=document.getElementById('mp-interim-dagen').value;
  const interimDagen=statuut==='interim'&&interimDagenVal!==''?parseInt(interimDagenVal):null;
  const werkGsm=formatPhone(document.getElementById('mp-werkgsm').value.trim());
  const teamRoleSel=document.getElementById('mp-teamrole').value;
  const teamRoleCustom=document.getElementById('mp-teamrole-custom').value.trim();
  const teamRole=teamRoleSel==='__other__'?teamRoleCustom:(teamRoleSel||'');
  const endDate=document.getElementById('mp-end-contract').value||'';
  const noodNaam=document.getElementById('mp-nood-naam').value.trim();
  const noodRelatie=document.getElementById('mp-nood-relatie').value;
  const noodGsm=formatPhone(document.getElementById('mp-nood-gsm').value.trim());
  if(!firstName){showToast('Voornaam is verplicht','error');return;}
  if(!lastName){showToast('Naam is verplicht','error');return;}
  if(!email){showToast('E-mail is verplicht','error');return;}
  if(!departmentId){showToast('Department is verplicht','error');return;}
  const data={firstName,lastName,email,departmentId,role,isApprover,statuut,paritairComite,baremaCategory,startDate,endDate,scheduleId,gsm,tel,iban,birthDate,rrn,saldoOV,interimDagen,werkGsm,teamRole,noodNaam,noodRelatie,noodGsm};
  if(id){
    const p=people.find(x=>x.id===id);
    if(p){
      // Log mutaties voor gewijzigde velden
      if(!p.mutations)p.mutations=[];
      const fieldLabels={firstName:'Voornaam',lastName:'Naam',email:'E-mail',departmentId:'Department',role:'Rol',isApprover:'Approver',statuut:'Statuut',paritairComite:'Paritair ComitÃ©',baremaCategory:'Baremacategorie',startDate:'Startdatum',endDate:'Einddatum',scheduleId:'Werkrooster',gsm:'GSM',tel:'Telefoon',iban:'IBAN',birthDate:'Geboortedatum',rrn:'Rijksregisternr',saldoOV:'Saldo OV',interimDagen:'Interim dagen',werkGsm:'Werk GSM',teamRole:'Teamrol',noodNaam:'Noodcontact naam',noodRelatie:'Noodcontact relatie',noodGsm:'Noodcontact GSM'};
      const now=new Date();
      const timestamp=now.toISOString();
      const user=settings.currentUser||'Admin';
      Object.keys(data).forEach(key=>{
        let oldVal=p[key];
        let newVal=data[key];
        // Normaliseer voor vergelijking
        if(oldVal===undefined||oldVal===null)oldVal='';
        if(newVal===undefined||newVal===null)newVal='';
        if(String(oldVal)!==String(newVal)){
          // Vertaal IDs naar leesbare namen
          let oldDisplay=String(oldVal),newDisplay=String(newVal);
          if(key==='departmentId'){
            const od=departments.find(d=>d.id===oldVal);
            const nd=departments.find(d=>d.id===newVal);
            oldDisplay=od?od.name:oldVal||'(leeg)';
            newDisplay=nd?nd.name:newVal||'(leeg)';
          }else if(key==='scheduleId'){
            const os=schedules.find(s=>s.id===oldVal);
            const ns=schedules.find(s=>s.id===newVal);
            oldDisplay=os?os.name:oldVal||'(leeg)';
            newDisplay=ns?ns.name:newVal||'(leeg)';
          }else if(key==='isApprover'){
            oldDisplay=oldVal?'Ja':'Nee';newDisplay=newVal?'Ja':'Nee';
          }else if(key==='startDate'||key==='endDate'||key==='birthDate'){
            oldDisplay=oldVal?formatDate(oldVal):'(leeg)';
            newDisplay=newVal?formatDate(newVal):'(leeg)';
          }
          if(!oldDisplay)oldDisplay='(leeg)';
          if(!newDisplay)newDisplay='(leeg)';
          p.mutations.push({id:uid(),timestamp,user,field:fieldLabels[key]||key,oldValue:oldDisplay,newValue:newDisplay});
        }
      });
      // Als statuut niet meer interim is, wis interimDagen
      if(statuut!=='interim'){data.interimDagen=null;}
      Object.assign(p,data);
    }
  }else{
    const newData={id:uid(),...data,allowanceAdjustments:[],mutations:[{id:uid(),timestamp:new Date().toISOString(),user:settings.currentUser||'Admin',field:'Aangemaakt',oldValue:'',newValue:'Nieuwe medewerker'}]};
    // Als statuut niet interim is, wis interimDagen
    if(statuut!=='interim'){newData.interimDagen=null;}
    people.push(newData);
  }
  closeModal();autoSave();renderPeople();renderDepartments();
  showToast('Medewerker opgeslagen');
}

// â•â•â• INTERIM COUNTER LOGICA â•â•â•
// Berekent hoeveel werkdagen (geen weekenden, feestdagen, verlof, ziekte) er verstreken zijn
// sinds de startdatum van de medewerker, en trekt dat af van interimDagen.
function calcInterimCounter(p){
  if(!p||p.statuut!=='interim'||!p.interimDagen||!p.startDate)return null;
  const today=new Date().toISOString().split('T')[0];
  // VÃ³Ã³r startdatum: saldo = interimDagen (nog niet begonnen)
  if(today<p.startDate)return p.interimDagen;
  // Na startdatum: tel werkdagen (excl. weekenden, feestdagen) en trek afwezigheden af
  const endDate=today;
  const totalWorkDays=calcWorkDays(p.startDate,endDate);
  const absentDays=requests
    .filter(r=>r.personId===p.id&&r.status==='approved'&&r.startDate<=endDate&&r.endDate>=p.startDate)
    .reduce((sum,r)=>sum+(r.halfDay?0.5:(r.days||0)),0);
  const workedDays=Math.max(0,totalWorkDays-absentDays);
  const remaining=Math.max(0,p.interimDagen-workedDays);
  return remaining;
}

function promptInterimDagen(personId){
  openModal('ğŸ“‹ Interim werkdagen',`
    <div style="margin-bottom:16px;color:var(--text2);font-size:13px;line-height:1.6">
      Deze medewerker heeft het statuut <strong>interim</strong>.<br/>
      Hoeveel werkdagen bevat het interim contract?<br/>
      <span style="font-size:12px;color:var(--text3)">(Dit veld is optioneel â€” je kan het later nog invullen)</span>
    </div>
    <div class="form-group">
      <label class="form-label">Aantal interim werkdagen</label>
      <input class="form-input" type="number" step="1" min="1" id="prompt-interim-dagen" placeholder="bv. 60" autofocus/>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Overslaan</button>
      <button class="btn btn-primary" onclick="saveInterimDagenPrompt('${personId}')">Opslaan</button>
    </div>
  `);
}

function saveInterimDagenPrompt(personId){
  const val=document.getElementById('prompt-interim-dagen').value;
  if(val!==''){
    const p=people.find(x=>x.id===personId);
    if(p){
      p.interimDagen=parseInt(val);
      autoSave();renderPeople();
      showToast('Interim dagen opgeslagen');
    }
  }
  closeModal();
}
async function archivePerson(id){
  if(!await confirmDialog('Medewerker archiveren? De medewerker verdwijnt uit de actieve lijst maar blijft beschikbaar in het archief.'))return;
  const p=people.find(x=>x.id===id);
  if(!p)return;
  if(!p.mutations)p.mutations=[];
  p.mutations.push({id:uid(),timestamp:new Date().toISOString(),user:settings.currentUser||'Admin',field:'Status',oldValue:'Actief',newValue:'Gearchiveerd'});
  p.archived=true;
  p.archivedDate=new Date().toISOString().split('T')[0];
  closeModal();autoSave();renderPeople();renderDepartments();showToast('Medewerker gearchiveerd ğŸ“¦');
}

async function unarchivePerson(id){
  const p=people.find(x=>x.id===id);
  if(!p)return;
  const today=new Date().toISOString().split('T')[0];
  if(p.endDate&&p.endDate<today){
    if(!await confirmDialog(`De einddatum van dit contract (${formatDate(p.endDate)}) ligt in het verleden.\n\nDe einddatum wordt gewist bij heractivering. Doorgaan?`))return;
    p.endDate='';
  }else{
    if(!await confirmDialog('Medewerker heractiveren?'))return;
  }
  if(!p.mutations)p.mutations=[];
  p.mutations.push({id:uid(),timestamp:new Date().toISOString(),user:settings.currentUser||'Admin',field:'Status',oldValue:'Gearchiveerd',newValue:'Actief (heractiveerd)'});
  p.archived=false;
  p.archivedDate=null;
  p.archivedReason='';
  autoSave();renderPeople();renderDepartments();showToast('Medewerker heractiveerd âœ…');
}

// Automatische archivering: medewerkers met einddatum in het verleden â†’ archief
function autoArchiveExpiredContracts(){
  const today=new Date().toISOString().split('T')[0];
  let count=0;
  people.forEach(p=>{
    if(p.endDate&&p.endDate<today&&!p.archived){
      p.archived=true;
      p.archivedDate=today;
      p.archivedReason='contract verlopen';
      if(!p.mutations)p.mutations=[];
      p.mutations.push({id:uid(),timestamp:new Date().toISOString(),user:'Systeem',field:'Status',oldValue:'Actief',newValue:'Gearchiveerd (contract verlopen op '+formatDate(p.endDate)+')'});
      count++;
    }
  });
  if(count>0){
    autoSave();
    showToast(`${count} medewerker${count>1?'s':''} automatisch gearchiveerd (contract verlopen)`,'info');
  }
}

let peopleStatusFilter='active';

function filterPeople(query){
  const q=query.toLowerCase();
  document.querySelectorAll('#people-table tr').forEach(tr=>{
    tr.style.display=tr.textContent.toLowerCase().includes(q)?'':'none';
  });
}

function filterPeopleDept(deptId){
  if(!deptId){document.querySelectorAll('#people-table tr').forEach(tr=>tr.style.display='');return;}
  people.forEach((p,i)=>{
    const tr=document.querySelectorAll('#people-table tr')[i];
    if(tr)tr.style.display=p.departmentId===deptId?'':'none';
  });
}

// --- Saldo ---
function getAllowanceForType(person,typeId){
  const t=leaveTypes.find(x=>x.id===typeId);
  if(!t||!t.tracked)return 0;
  let days=t.defaultDays||0;
  if(person.allowanceAdjustments){
    person.allowanceAdjustments.forEach(a=>{
      if(a.typeId===typeId)days+=a.days;
    });
  }
  return days;
}

function getTotalAllowance(person){
  return leaveTypes.filter(t=>t.tracked).reduce((total,t)=>total+getAllowanceForType(person,t.id),0);
}

function getUsedDays(personId,typeId){
  return requests.filter(r=>r.personId===personId&&(r.status==='approved'||r.type==='ziekte')&&(typeId?r.type===typeId:true))
    .reduce((sum,r)=>{
      const type=leaveTypes.find(t=>t.id===r.type);
      if(!type||!type.tracked)return sum;
      return sum+(r.halfDay?0.5:r.days||0);
    },0);
}

function openChecklist(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  if(!p.checklistState)p.checklistState={};

  // Bouw secties op basis van actieve checklistItems
  const activeItems=checklistItems.filter(i=>i.active).sort((a,b)=>a.order-b.order);
  const sections={};
  activeItems.forEach(item=>{
    if(!sections[item.section])sections[item.section]=[];
    sections[item.section].push(item);
  });

  const totalItems=activeItems.length;
  const checkedCount=activeItems.filter(i=>p.checklistState[i.id]).length;
  const statuutLabel=p.statuut?p.statuut.charAt(0).toUpperCase()+p.statuut.slice(1):'';
  const dept=departments.find(d=>d.id===p.departmentId);
  const deptLabel=dept?dept.name:'';
  const startFormatted=p.startDate?formatDate(p.startDate):'\u2014';

  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">'
    +'<div style="font-size:12px;color:var(--text3)">Startdatum: <strong style="color:var(--text)">'+startFormatted+'</strong>'
    +' &nbsp;\u2022&nbsp; '+statuutLabel+' \u2014 '+deptLabel
    +' &nbsp;\u2022&nbsp; <span id="checklist-progress">'+checkedCount+'/'+totalItems+' afgevinkt</span></div>'
    +'<button class="btn btn-sm btn-danger" onclick="confirmDeleteChecklist(\''+personId+'\')">\uD83D\uDDD1 Checklist resetten</button>'
    +'</div>';

  if(totalItems===0){
    html+='<div style="text-align:center;padding:40px;color:var(--text3)">Geen actieve checklist-items. Ga naar Instellingen â†’ Checklist om items te beheren.</div>';
  } else {
    html+='<div style="margin-bottom:12px;background:var(--accent-bg);border-radius:var(--radius-sm);overflow:hidden"><div id="checklist-bar" style="height:6px;background:var(--accent);border-radius:var(--radius-sm);transition:width .3s;width:'+(totalItems>0?Math.round(checkedCount/totalItems*100):0)+'%"></div></div>';
    html+='<div id="checklist-container" style="max-height:60vh;overflow-y:auto">';
    Object.keys(sections).forEach(function(secName){
      html+='<div style="font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin:16px 0 8px;padding-bottom:4px;border-bottom:1px solid var(--border)">'+secName+'</div>';
      sections[secName].forEach(function(item){
        const checked=p.checklistState[item.id]?'checked':'';
        html+='<label style="display:flex;align-items:flex-start;gap:10px;padding:6px 0;cursor:pointer;font-size:13px;'+(p.checklistState[item.id]?'opacity:.5;text-decoration:line-through':'')+'" id="cl-label-'+item.id+'">'
          +'<input type="checkbox" class="checklist-cb" data-item-id="'+item.id+'" '+checked+' style="margin-top:2px;flex-shrink:0;width:16px;height:16px;accent-color:var(--accent)" onchange="toggleChecklistItem(\''+personId+'\',\''+item.id+'\',this.checked)"/>'
          +'<span>'+item.name+'</span></label>';
      });
    });
    html+='</div>';
  }
  openModal('\u2611\uFE0F Onboarding Checklist \u2014 '+fullName(p),html);
  document.getElementById('modal-title-actions').innerHTML='<button class="btn btn-sm" onclick="closeModal();openPersonModal(\''+personId+'\')" style="font-size:11px">â† Fiche</button>';
}

function toggleChecklistItem(personId,itemId,checked){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  if(!p.checklistState)p.checklistState={};
  p.checklistState[itemId]=checked;
  autoSave();

  // Update visueel
  const label=document.getElementById('cl-label-'+itemId);
  if(label){label.style.opacity=checked?'.5':'1';label.style.textDecoration=checked?'line-through':'none';}

  // Update progress
  const activeItems=checklistItems.filter(i=>i.active);
  const total=activeItems.length;
  const done=activeItems.filter(i=>p.checklistState[i.id]).length;
  const prog=document.getElementById('checklist-progress');
  if(prog)prog.innerHTML=done+'/'+total+' afgevinkt'+(done===total?' &nbsp;<span style="color:var(--success);font-weight:700">\u2705 Volledig!</span>':'');
  const bar=document.getElementById('checklist-bar');
  if(bar)bar.style.width=Math.round(done/total*100)+'%';

  if(done===total){
    setTimeout(async function(){
      if(await confirmDialog('Alle items zijn afgevinkt! Checklist definitief voltooien?')){
        p.checklistState={_completed:true,_completedDate:new Date().toISOString().split('T')[0]};
        autoSave();closeModal();
        showToast('Onboarding checklist voltooid \u2705','success');
      }
    },400);
  }
}

async function confirmDeleteChecklist(personId){
  if(!await confirmDialog('Checklist resetten voor deze medewerker? Alle afgevinkte items worden ongedaan gemaakt.'))return;
  const p=people.find(x=>x.id===personId);
  if(p){p.checklistState={};autoSave();}
  closeModal();
  showToast('Checklist gereset');
}

// â•â•â• CHECKLIST INSTELLINGEN â•â•â•
function renderChecklistSettings(){
  var container=document.getElementById('checklist-sections-container');
  if(!container)return;
  var sections={};
  checklistItems.sort(function(a,b){return a.order-b.order;}).forEach(function(item){
    if(!sections[item.section])sections[item.section]=[];
    sections[item.section].push(item);
  });
  var html='';
  Object.keys(sections).forEach(function(secName){
    var esc=secName.replace(/'/g,"\\'");
    var items=sections[secName];
    var activeCount=items.filter(function(i){return i.active;}).length;
    html+='<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface);border-radius:var(--radius-xs);margin-bottom:4px;border:1px solid var(--border);cursor:pointer" onclick="openChecklistSection(\''+esc+'\')">';
    html+='<span style="font-size:16px">ğŸ“‹</span>';
    html+='<div style="flex:1"><div style="font-weight:700;font-size:13px">'+secName+'</div>';
    html+='<div style="font-size:11px;color:var(--text3)">'+items.length+' item'+(items.length!==1?'s':'')+' &middot; '+activeCount+' actief</div></div>';
    html+='<button class="btn btn-sm" onclick="event.stopPropagation();renameChecklistSection(\''+esc+'\')" title="Hernoemen" style="font-size:11px">âœï¸</button>';
    html+='<button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteChecklistSection(\''+esc+'\')" title="Verwijderen" style="font-size:11px">ğŸ—‘</button>';
    html+='</div>';
  });
  var totalActive=checklistItems.filter(function(i){return i.active;}).length;
  html+='<div style="margin-top:12px;padding:10px;background:var(--surface2);border-radius:var(--radius-sm);font-size:12px;color:var(--text3)">';
  html+=Object.keys(sections).length+' checklist'+(Object.keys(sections).length!==1?'s':'')+' &middot; '+checklistItems.length+' items totaal &middot; '+totalActive+' actief</div>';
  container.innerHTML=html;
}

function openChecklistSection(secName){
  var items=checklistItems.filter(function(i){return i.section===secName;}).sort(function(a,b){return a.order-b.order;});
  var esc=secName.replace(/'/g,"\\'");
  var html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">';
  html+='<div style="font-size:12px;color:var(--text3)">'+items.length+' item'+(items.length!==1?'s':'')+'</div>';
  html+='<button class="btn btn-sm btn-primary-outline" onclick="closeModal();openChecklistItemModal(\'\',\''+esc+'\')">â• Item toevoegen</button>';
  html+='</div>';
  if(items.length===0){
    html+='<div style="text-align:center;padding:30px;color:var(--text3);font-size:13px">Nog geen items in deze checklist. Voeg er een toe.</div>';
  }else{
    items.forEach(function(item){
      html+='<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface);border-radius:var(--radius-xs);margin-bottom:4px;border:1px solid var(--border)">';
      html+='<input type="checkbox" '+(item.active?'checked':'')+' onchange="toggleChecklistActive(\''+item.id+'\',this.checked);openChecklistSection(\''+esc+'\')" style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer;flex-shrink:0"/>';
      html+='<span style="flex:1;font-size:13px;'+(item.active?'':'opacity:.5;text-decoration:line-through')+'">'+item.name+'</span>';
      html+='<button class="btn btn-sm" onclick="openChecklistItemModal(\''+item.id+'\',\'\')" style="font-size:11px">âœï¸</button>';
      html+='<button class="btn btn-sm btn-danger" onclick="deleteChecklistItemFromSection(\''+item.id+'\',\''+esc+'\')" style="font-size:11px">ğŸ—‘</button>';
      html+='</div>';
    });
  }
  // Check actief gebruik
  var inUseCount=people.filter(function(p){return p.checklistState&&!p.archived;}).filter(function(p){
    return items.some(function(i){return p.checklistState[i.id+'_completed'];});
  }).length;
  if(inUseCount>0){
    html+='<div style="margin-top:12px;padding:8px 12px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15);border-radius:var(--radius-xs);font-size:11px;color:var(--accent)">â„¹ï¸ Deze checklist is actief bij '+inUseCount+' medewerker'+(inUseCount!==1?'s':'')+'</div>';
  }
  openModal('ğŸ“‹ '+secName,html);
}

async function renameChecklistSection(oldName){
  const newName=await promptDialog('Nieuwe naam voor "'+oldName+'":',oldName);
  if(newName===null)return;
  const trimmed=newName.trim();
  if(!trimmed){showToast('Naam is verplicht','error');return;}
  if(trimmed===oldName)return;
  const existingSections=[...new Set(checklistItems.map(i=>i.section))];
  if(existingSections.some(s=>s.toLowerCase()===trimmed.toLowerCase())){
    showToast('Deze sectienaam bestaat al','error');return;
  }
  checklistItems.forEach(function(i){if(i.section===oldName)i.section=trimmed;});
  // Update checklistState bij medewerkers (sectienaam zit niet in state, alleen item IDs â€” geen actie nodig)
  autoSave();renderChecklistSettings();
  showToast('Checklist hernoemd naar "'+trimmed+'"');
}

async function deleteChecklistItemFromSection(itemId,secName){
  const item=checklistItems.find(i=>i.id===itemId);
  if(!item)return;
  // Check gebruik
  var inUseBy=people.filter(function(p){return p.checklistState&&p.checklistState[itemId+'_completed']&&!p.archived;});
  var msg='Item "'+item.name+'" verwijderen?';
  if(inUseBy.length>0)msg+='\n\nâš ï¸ Dit item is afgevinkt bij '+inUseBy.length+' medewerker'+(inUseBy.length!==1?'s':'')+'. Hun voortgang wordt aangepast.';
  if(!await confirmDialog(msg))return;
  checklistItems=checklistItems.filter(i=>i.id!==itemId);
  autoSave();openChecklistSection(secName);
  showToast('Item verwijderd');
}

function toggleChecklistActive(itemId,active){
  const item=checklistItems.find(i=>i.id===itemId);
  if(item){item.active=active;autoSave();renderChecklistSettings();}
}

function openNewChecklistModal(){
  openModal('â• Nieuwe checklist toevoegen',`
    <div class="form-group">
      <label class="form-label">Sectienaam <span class="req">*</span></label>
      <input type="text" class="form-input" id="cli-new-checklist-name" placeholder="Bijv. Backoffice, Veiligheid, Onboarding IT..." autofocus/>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveNewChecklist()">Opslaan</button>
    </div>
  `);
}

function saveNewChecklist(){
  const name=document.getElementById('cli-new-checklist-name').value.trim();
  if(!name){showToast('Sectienaam is verplicht','error');return;}
  const existingSections=[...new Set(checklistItems.map(i=>i.section))];
  if(existingSections.some(s=>s.toLowerCase()===name.toLowerCase())){
    alert('Deze sectienaam bestaat al. Kies een andere naam.');
    document.getElementById('cli-new-checklist-name').value='';
    document.getElementById('cli-new-checklist-name').focus();
    return;
  }
  closeModal();
  // Open direct item-toevoegen voor de nieuwe sectie
  openChecklistItemModal('', name);
}

function openChecklistItemModal(itemId, preSection){
  const item=itemId?checklistItems.find(i=>i.id===itemId):null;
  const selSection=item?item.section:(preSection||'');
  const existingSections=[...new Set(checklistItems.map(i=>i.section))];
  const isNewInSection=!item&&selSection;

  let sectionHtml='';
  if(item){
    // Edit mode: dropdown om sectie te wijzigen
    const sectionOptions=existingSections.map(s=>`<option value="${s}" ${s===selSection?'selected':''}>${s}</option>`).join('');
    sectionHtml=`<div class="form-group">
      <label class="form-label">Sectie</label>
      <select class="form-input" id="cli-section">${sectionOptions}</select>
    </div>`;
  }else if(selSection){
    // Nieuw item in bestaande/nieuwe sectie: sectie vast tonen
    sectionHtml=`<div class="form-group">
      <label class="form-label">Sectie</label>
      <div style="padding:8px 12px;background:var(--surface2);border-radius:var(--radius-xs);font-weight:600;font-size:13px">${selSection}</div>
      <input type="hidden" id="cli-section" value="${selSection}"/>
    </div>`;
  }

  openModal(item?'âœï¸ Item bewerken':'â• Item toevoegen'+(selSection?' â€” '+selSection:''),`
    ${sectionHtml}
    <div class="form-group">
      <label class="form-label">Item naam <span class="req">*</span></label>
      <input type="text" class="form-input" id="cli-name" value="${item?item.name:''}" placeholder="Bijv. Toegangsbadge aanvragen" autofocus/>
    </div>
    <div class="form-group">
      <label class="form-label">Actief</label>
      <select class="form-input" id="cli-active" style="width:120px">
        <option value="true" ${!item||item.active?'selected':''}>Ja</option>
        <option value="false" ${item&&!item.active?'selected':''}>Nee</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveChecklistItem('${itemId||''}')">Opslaan</button>
    </div>
  `);
}

function saveChecklistItem(itemId){
  const name=document.getElementById('cli-name').value.trim();
  if(!name){showToast('Item naam is verplicht','error');return;}
  const sectionEl=document.getElementById('cli-section');
  let section=sectionEl?sectionEl.value:'';
  if(!section){showToast('Sectie is verplicht','error');return;}
  const active=document.getElementById('cli-active').value==='true';

  if(itemId){
    const item=checklistItems.find(i=>i.id===itemId);
    if(item){item.name=name;item.section=section;item.active=active;}
  }else{
    const maxOrder=checklistItems.reduce((m,i)=>Math.max(m,i.order||0),0);
    checklistItems.push({id:'cl_'+uid(),section,name,active,order:maxOrder+1});
  }
  closeModal();autoSave();renderChecklistSettings();
  showToast('Checklist-item opgeslagen');
}

async function deleteChecklistItem(itemId){
  if(!await confirmDialog('Dit checklist-item verwijderen?'))return;
  checklistItems=checklistItems.filter(i=>i.id!==itemId);
  autoSave();renderChecklistSettings();showToast('Item verwijderd');
}

async function deleteChecklistSection(secName){
  const items=checklistItems.filter(i=>i.section===secName);
  var inUseBy=people.filter(function(p){return p.checklistState&&!p.archived;}).filter(function(p){
    return items.some(function(i){return p.checklistState[i.id+'_completed'];});
  });
  var msg='Checklist "'+secName+'" verwijderen ('+items.length+' item'+(items.length!==1?'s':'')+')?\n\nDit kan niet ongedaan gemaakt worden.';
  if(inUseBy.length>0)msg+='\n\nâš ï¸ Deze checklist is actief bij '+inUseBy.length+' medewerker'+(inUseBy.length!==1?'s':'')+'. Hun voortgang voor deze items gaat verloren.';
  if(!await confirmDialog(msg))return;
  checklistItems=checklistItems.filter(i=>i.section!==secName);
  autoSave();renderChecklistSettings();showToast('Checklist "'+secName+'" verwijderd');
}

// â•â•â• MUTATIES MODAL â•â•â•
function openMutationsModal(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  if(!p.mutations)p.mutations=[];

  const muts=[...p.mutations].sort((a,b)=>b.timestamp.localeCompare(a.timestamp));

  let html=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
    <div style="font-size:12px;color:var(--text3)">${muts.length} mutatie${muts.length!==1?'s':''} geregistreerd</div>
    <div style="display:flex;gap:6px">
      <button class="btn btn-sm btn-primary" onclick="openAddMutationModal('${personId}')" style="font-size:11px">â• Manuele mutatie</button>
      <button class="btn btn-sm" onclick="openSaldoAdjustmentModal('${personId}')" style="font-size:11px;border-color:var(--success);color:var(--success)">ğŸ“Š Saldo aanpassen</button>
    </div>
  </div>`;

  if(muts.length===0){
    html+='<div style="text-align:center;padding:40px;color:var(--text3)">Nog geen mutaties geregistreerd voor deze medewerker.</div>';
  }else{
    html+='<div style="max-height:60vh;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius-sm)"><table class="tbl" style="margin:0"><thead><tr><th style="width:140px">Datum & tijd</th><th style="width:90px">Gebruiker</th><th>Veld</th><th>Oude waarde</th><th>Nieuwe waarde</th><th style="width:40px"></th></tr></thead><tbody>';
    muts.forEach(m=>{
      const dt=new Date(m.timestamp);
      const dateStr=formatDate(m.timestamp.split('T')[0])+' '+String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');
      html+=`<tr>
        <td style="font-size:11px;white-space:nowrap;color:var(--text3)">${dateStr}</td>
        <td style="font-size:11px;font-weight:600">${m.user||'â€”'}</td>
        <td style="font-size:12px;font-weight:600">${m.field}</td>
        <td style="font-size:12px;${m.oldValue?'color:var(--danger)':'color:var(--text3)'}">${m.oldValue||'(leeg)'}</td>
        <td style="font-size:12px;${m.newValue?'color:var(--success)':'color:var(--text3)'}">${m.newValue||'(leeg)'}</td>
        <td><button class="btn btn-sm btn-danger" onclick="deleteMutation('${personId}','${m.id}')" style="font-size:10px" title="Verwijderen">ğŸ—‘</button></td>
      </tr>`;
    });
    html+='</tbody></table></div>';
  }

  openModal('ğŸ“ Mutaties â€” '+fullName(p),html);
  document.getElementById('modal-title-actions').innerHTML=`<button class="btn btn-sm" onclick="closeModal();openPersonModal('${personId}')" style="font-size:11px">â† Fiche</button>`;
}

async function deleteMutation(personId,mutId){
  if(!await confirmDialog('Deze mutatie verwijderen uit het logboek?'))return;
  const p=people.find(x=>x.id===personId);
  if(!p||!p.mutations)return;
  p.mutations=p.mutations.filter(m=>m.id!==mutId);
  autoSave();
  openMutationsModal(personId);
  showToast('Mutatie verwijderd');
}

function openAddMutationModal(personId){
  openModal('â• Manuele mutatie toevoegen',`
    <div class="form-group">
      <label class="form-label">Veld / onderwerp</label>
      <input type="text" class="form-input" id="mut-field" placeholder="Bijv. Opleiding, Opmerking, Evaluatie, ..."/>
    </div>
    <div class="form-row">
      <div class="form-group" style="flex:1">
        <label class="form-label">Oude waarde <span style="font-weight:400;color:var(--text3)">(optioneel)</span></label>
        <input type="text" class="form-input" id="mut-old" placeholder=""/>
      </div>
      <div class="form-group" style="flex:1">
        <label class="form-label">Nieuwe waarde</label>
        <input type="text" class="form-input" id="mut-new" placeholder=""/>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Opmerking <span style="font-weight:400;color:var(--text3)">(optioneel)</span></label>
      <textarea class="form-input" id="mut-comment" rows="2" placeholder="Extra toelichting..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal();openMutationsModal('${personId}')">Annuleren</button>
      <button class="btn btn-primary" onclick="saveManualMutation('${personId}')">Opslaan</button>
    </div>
  `);
}

function saveManualMutation(personId){
  const field=document.getElementById('mut-field').value.trim();
  const oldVal=document.getElementById('mut-old').value.trim();
  const newVal=document.getElementById('mut-new').value.trim();
  const comment=document.getElementById('mut-comment').value.trim();
  if(!field){showToast('Veld/onderwerp is verplicht','error');return;}
  if(!newVal&&!oldVal){showToast('Vul minstens een waarde in','error');return;}
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  if(!p.mutations)p.mutations=[];
  p.mutations.push({
    id:uid(),
    timestamp:new Date().toISOString(),
    user:settings.currentUser||'Admin',
    field:field+(comment?' ('+comment+')':''),
    oldValue:oldVal||'',
    newValue:newVal||'',
    manual:true
  });
  autoSave();
  closeModal();openMutationsModal(personId);
  showToast('Manuele mutatie toegevoegd');
}

function openSaldoModal(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  const totalDays=getTotalAllowance(p);
  const usedDays=getUsedDays(p.id);
  const remaining=totalDays-usedDays;

  let typeSummary=leaveTypes.filter(t=>t.tracked).filter(t=>{
    const allowance=getAllowanceForType(p,t.id);
    const used=getUsedDays(p.id,t.id);
    const hasAdj=(p.allowanceAdjustments||[]).some(a=>a.typeId===t.id);
    return allowance>0||used>0||hasAdj;
  }).map(t=>{
    const allowance=getAllowanceForType(p,t.id);
    const used=getUsedDays(p.id,t.id);
    const rem=allowance-used;
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:6px"><span class="clr-dot" style="background:${t.color}"></span>${t.symbol} ${t.name}</div></td>
      <td style="text-align:center;font-weight:600">${allowance}</td>
      <td style="text-align:center;font-weight:600">${used}</td>
      <td style="text-align:center;font-weight:700;color:${rem>0?'var(--success)':rem===0?'var(--text3)':'var(--danger)'}">${rem}</td>
    </tr>`;
  }).join('');

  let adjustments='';
  if(p.allowanceAdjustments&&p.allowanceAdjustments.length>0){
    adjustments=p.allowanceAdjustments.map((a,i)=>{
      const t=leaveTypes.find(x=>x.id===a.typeId);
      return `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
      <span style="font-weight:600;color:${a.days>0?'var(--success)':'var(--danger)'};">${a.days>0?'+':''}\u200B${a.days}d</span>
      <span style="color:var(--text2)">${t?t.symbol+' '+t.name:''}</span>
      <span style="flex:1;color:var(--text3)">${a.reason||''}</span>
      <span style="color:var(--text3)">${formatDate(a.date)}</span>
    </div>`;
    }).join('');
    adjustments+=`<div style="margin-top:8px;font-size:11px;color:var(--text3)">Saldo-aanpassingen worden beheerd via <a href="#" onclick="closeModal();openMutationsModal('${personId}');return false" style="color:var(--accent)">ğŸ“ Mutaties</a></div>`;
  }

  // Build mutation history: all approved requests + adjustments, chronological
  const year=new Date().getFullYear();
  const mutations=[];
  // Start saldo
  const baseSaldo=leaveTypes.filter(t=>t.tracked).reduce((s,t)=>s+(t.defaultDays||0),0);
  mutations.push({date:''+year+'-01-01',label:'Startsaldo '+year,type:'start',days:baseSaldo,delta:0});
  // Adjustments
  (p.allowanceAdjustments||[]).forEach(a=>{
    const t=leaveTypes.find(x=>x.id===a.typeId);
    mutations.push({date:a.date,label:'Aanpassing'+(a.reason?' â€” '+a.reason:'')+(t?' ('+t.name+')':''),type:'adjust',days:0,delta:a.days});
  });
  // Approved tracked requests
  requests.filter(r=>r.personId===p.id&&(r.status==='approved'||r.type==='ziekte')).forEach(r=>{
    const t=leaveTypes.find(x=>x.id===r.type);
    if(!t||!t.tracked)return;
    const d=r.halfDay?0.5:r.days||0;
    mutations.push({date:r.startDate,label:`${t.symbol} ${t.name} â€” ${formatDateShort(r.startDate)}${r.startDate!==r.endDate?' â†’ '+formatDateShort(r.endDate):''}`,type:'used',days:0,delta:-d,color:t.color});
  });
  // Pending requests
  requests.filter(r=>r.personId===p.id&&r.status==='pending').forEach(r=>{
    const t=leaveTypes.find(x=>x.id===r.type);
    if(!t||!t.tracked)return;
    const d=r.halfDay?0.5:r.days||0;
    mutations.push({date:r.startDate,label:`â³ ${t.symbol} ${t.name} â€” ${formatDateShort(r.startDate)}${r.startDate!==r.endDate?' â†’ '+formatDateShort(r.endDate):''} (pending)`,type:'pending',days:0,delta:-d,color:t.color});
  });
  mutations.sort((a,b)=>a.date.localeCompare(b.date));

  // Calculate running balance
  let runBalance=0;
  const mutHtml=mutations.map(m=>{
    if(m.type==='start')runBalance=m.days;
    else runBalance+=m.delta;
    const isPending=m.type==='pending';
    const deltaStr=m.type==='start'?`${m.days}d`:m.delta>0?`<span style="color:var(--success)">+${m.delta}d</span>`:`<span style="color:var(--danger)">${m.delta}d</span>`;
    return `<tr style="${isPending?'opacity:.5;font-style:italic':''}">
      <td style="font-size:11px;color:var(--text3);white-space:nowrap">${formatDate(m.date)}</td>
      <td style="font-size:12px">${m.color?`<span class="clr-dot" style="background:${m.color};margin-right:4px"></span>`:''}${m.label}</td>
      <td style="text-align:right;font-size:12px;font-weight:600">${deltaStr}</td>
      <td style="text-align:right;font-size:12px;font-weight:700;color:${runBalance>5?'var(--success)':runBalance>0?'var(--warn)':'var(--danger)'}">${runBalance}d</td>
    </tr>`;
  }).join('');

  // Extra opgenomen dagen: alle goedgekeurde niet-tracked afwezigheden (klein verlet, ziekte, extern, etc.)
  const extraDays=requests
    .filter(r=>r.personId===p.id&&(r.status==='approved'||r.type==='ziekte'))
    .reduce((sum,r)=>{
      const t=leaveTypes.find(x=>x.id===r.type);
      if(!t||!t.absenceTracked)return sum;
      return sum+(r.halfDay?0.5:r.days||0);
    },0);

  // Afwezigheidsteller per type (voor types met maxDays > 0 of met opgenomen dagen)
  let absTypeSummary=leaveTypes.filter(t=>t.absenceTracked).filter(t=>{
    const used=requests.filter(r=>r.personId===p.id&&r.type===t.id&&r.status!=='rejected'&&r.startDate.startsWith(''+year)).reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
    return t.maxDays>0||used>0;
  }).map(t=>{
    const used=requests.filter(r=>r.personId===p.id&&r.type===t.id&&r.status!=='rejected'&&r.startDate.startsWith(''+year)).reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
    const max=t.maxDays||0;
    const over=max>0&&used>max;
    const remTxt=max>0?(max-used):'âˆ';
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:6px"><span class="clr-dot" style="background:${t.color}"></span>${t.symbol} ${t.name}</div></td>
      <td style="text-align:center;font-weight:600">${max>0?max:'â€”'}</td>
      <td style="text-align:center;font-weight:600;${over?'color:var(--danger)':''}">${used||'â€”'}</td>
      <td style="text-align:center;font-weight:700;color:${over?'var(--danger)':max>0?'var(--success)':'var(--text3)'}">${max>0?remTxt:'â€”'}</td>
    </tr>`;
  }).join('');

  openModal(`ğŸ“Š Saldo â€” ${fullName(p)}`,`
    ${p.statuut==='interim'?`<div style="margin-bottom:16px;padding:14px;background:rgba(168,85,247,.06);border:1px solid rgba(168,85,247,.2);border-radius:var(--radius-sm)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <span style="font-size:16px">â³</span>
        <span style="font-weight:700;font-size:13px;color:#a855f7">Interim contract</span>
      </div>
      <div style="display:flex;gap:16px">
        <div style="text-align:center;flex:1;padding:8px;background:var(--surface);border-radius:var(--radius-xs)">
          <div style="font-size:20px;font-weight:700">${p.interimDagen!=null?p.interimDagen+'d':'â€”'}</div>
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase">Interim dagen</div>
        </div>
        <div style="text-align:center;flex:1;padding:8px;background:var(--surface);border-radius:var(--radius-xs)">
          <div style="font-size:20px;font-weight:700;color:${(()=>{const c=calcInterimCounter(p);return c==null?'var(--text3)':c>10?'var(--success)':c>0?'var(--warn)':'var(--danger)';})()}">${p.interimDagen!=null?calcInterimCounter(p)+'d':'â€”'}</div>
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase">Resterend</div>
        </div>
        <div style="text-align:center;flex:1;padding:8px;background:var(--surface);border-radius:var(--radius-xs)">
          <div style="font-size:20px;font-weight:700">${p.interimDagen!=null?Math.max(0,p.interimDagen-calcInterimCounter(p))+'d':'â€”'}</div>
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase">Gewerkt</div>
        </div>
      </div>
    </div>`:``}
    <div style="display:flex;gap:12px;margin-bottom:20px">
      <div style="flex:1;text-align:center;padding:12px;background:var(--accent-bg);border-radius:var(--radius-sm)">
        <div style="font-size:24px;font-weight:700;color:var(--accent)">${totalDays}</div>
        <div style="font-size:11px;color:var(--text3);font-weight:600">TOTAAL VERLOF</div>
      </div>
      <div style="flex:1;text-align:center;padding:12px;background:var(--warn-bg);border-radius:var(--radius-sm)">
        <div style="font-size:24px;font-weight:700;color:var(--warn)">${usedDays}</div>
        <div style="font-size:11px;color:var(--text3);font-weight:600">OPGENOMEN VERLOF</div>
      </div>
      <div style="flex:1;text-align:center;padding:12px;background:${remaining>0?'var(--success-bg)':'var(--danger-bg)'};border-radius:var(--radius-sm)">
        <div style="font-size:24px;font-weight:700;color:${remaining>0?'var(--success)':'var(--danger)'}">${remaining}</div>
        <div style="font-size:11px;color:var(--text3);font-weight:600">RESTEREND VERLOF</div>
      </div>
      <div style="flex:1;text-align:center;padding:12px;background:rgba(148,163,184,.08);border:1px dashed var(--border);border-radius:var(--radius-sm)">
        <div style="font-size:24px;font-weight:700;color:#64748b">${extraDays}</div>
        <div style="font-size:11px;color:var(--text3);font-weight:600">EXTRA OPGENOMEN</div>
      </div>
    </div>
    <table class="tbl" style="margin-bottom:16px">
      <thead><tr><th>Type</th><th style="text-align:center">Recht</th><th style="text-align:center">Opgenomen</th><th style="text-align:center">Rest</th></tr></thead>
      <tbody>${typeSummary}</tbody>
    </table>
    ${absTypeSummary?`<div style="font-weight:700;font-size:13px;margin-bottom:8px">ğŸ“‹ Afwezigheidsteller ${year}</div>
    <table class="tbl" style="margin-bottom:16px">
      <thead><tr><th>Type</th><th style="text-align:center">Max/jaar</th><th style="text-align:center">Opgenomen</th><th style="text-align:center">Rest</th></tr></thead>
      <tbody>${absTypeSummary}</tbody>
    </table>`:''}
    <div style="margin-bottom:16px">
      <div style="font-weight:700;font-size:13px;margin-bottom:8px">ğŸ“‹ Mutatiehistoriek</div>
      <div style="max-height:180px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius-sm)">
        <table class="tbl" style="margin:0">
          <thead><tr><th>Datum</th><th>Omschrijving</th><th style="text-align:right">Mutatie</th><th style="text-align:right">Saldo</th></tr></thead>
          <tbody>${mutHtml}</tbody>
        </table>
      </div>
    </div>
    ${adjustments?`<div style="margin-bottom:16px"><div style="font-weight:700;font-size:13px;margin-bottom:8px">Aanpassingen</div>${adjustments}</div>`:''}
  `,true);
  document.getElementById('modal-title-actions').innerHTML=`<button class="btn btn-sm" onclick="closeModal();openPersonModal('${personId}')" style="font-size:11px">â† Fiche</button>`;
}

function openSaldoAdjustmentModal(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  const typeOpts=leaveTypes.filter(t=>t.tracked).map(t=>`<option value="${t.id}">${t.symbol} ${t.name}</option>`).join('');
  openModal('ğŸ“Š Saldo aanpassen â€” '+fullName(p),`
    <div style="margin-bottom:16px;font-size:12px;color:var(--text3);line-height:1.6">
      Pas het verlofsaldo aan. De aanpassing wordt opgeslagen als mutatie in het logboek.
    </div>
    <div class="form-row">
      <div class="form-group" style="flex:1">
        <label class="form-label">Verloftype</label>
        <select class="form-input" id="adj-type">${typeOpts}</select>
      </div>
      <div class="form-group" style="width:120px">
        <label class="form-label">Dagen (+/-)</label>
        <input type="number" class="form-input" id="adj-days" placeholder="+2 of -1"/>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Reden <span class="req">*</span></label>
      <input class="form-input" id="adj-reason" placeholder="Bv. correctie, overdracht vorig jaar, extra toegekend"/>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal();openMutationsModal('${personId}')">Annuleren</button>
      <button class="btn btn-primary" onclick="saveSaldoAdjustment('${personId}')">Opslaan</button>
    </div>
  `);
}

function saveSaldoAdjustment(personId){
  const days=parseFloat(document.getElementById('adj-days').value);
  const reason=document.getElementById('adj-reason').value.trim();
  const typeId=document.getElementById('adj-type').value;
  if(isNaN(days)||days===0){showToast('Voer een geldig aantal dagen in','error');return;}
  if(!reason){showToast('Reden is verplicht','error');return;}
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  const t=leaveTypes.find(x=>x.id===typeId);
  if(!p.allowanceAdjustments)p.allowanceAdjustments=[];
  p.allowanceAdjustments.push({typeId,days,reason,date:new Date().toISOString().split('T')[0]});
  if(!p.mutations)p.mutations=[];
  p.mutations.push({
    id:uid(),
    timestamp:new Date().toISOString(),
    user:settings.currentUser||'Admin',
    field:'Saldo aanpassing',
    oldValue:t?t.symbol+' '+t.name:'',
    newValue:(days>0?'+':'')+days+'d â€” '+reason
  });
  autoSave();closeModal();openMutationsModal(personId);
  showToast('Saldo aangepast ('+(days>0?'+':'')+days+'d)');
}


// --- Leave Types ---
function openTypeModal(id){
  const t=id?leaveTypes.find(x=>x.id===id):null;
  openModal(t?'Verloftype bewerken':'Verloftype toevoegen',`
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Naam <span class="req">*</span></label>
        <input class="form-input" id="mt-name" value="${t?t.name:''}"/>
      </div>
      <div class="form-group">
        <label class="form-label">Symbool</label>
        <input class="form-input" id="mt-symbol" value="${t?t.symbol:'ğŸ“‹'}" style="width:60px"/>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Kleur</label>
        <input type="color" class="form-input" id="mt-color" value="${t?t.color:'#3b82f6'}" style="width:60px;height:36px;padding:2px"/>
      </div>
      <div class="form-group">
        <label class="form-label">Categorie</label>
        <select class="form-input" id="mt-cat">
          <option value="verlof" ${t&&t.category==='verlof'?'selected':''}>Verlof (verlofsaldo)</option>
          <option value="adv" ${t&&t.category==='adv'?'selected':''}>ADV</option>
          <option value="afwezigheid" ${t&&t.category==='afwezigheid'?'selected':''}>Afwezigheid (afwezigheidssaldo)</option>
          <option value="ziekte" ${t&&t.category==='ziekte'?'selected':''}>Ziekte</option>
          <option value="extern" ${t&&t.category==='extern'?'selected':''}>Extern (opgelegd)</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Betaald</label>
        <select class="form-input" id="mt-paid">
          <option value="true" ${t&&t.paid?'selected':''}>Ja</option>
          <option value="false" ${t&&!t.paid?'selected':''}>Nee</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Saldo-type</label>
        <select class="form-input" id="mt-saldo-type" onchange="document.getElementById('mt-days-row').style.display=this.value==='verlof'?'block':'none'">
          <option value="verlof" ${t&&t.tracked?'selected':''}>Verlofsaldo (telt af van verlofdagen)</option>
          <option value="afwezigheid" ${t&&!t.tracked?'selected':''}>Afwezigheidssaldo (telt als extra afwezigheid)</option>
        </select>
      </div>
    </div>
    <div class="form-group" id="mt-days-row" style="display:${t&&t.tracked?'block':'none'}">
      <label class="form-label">Standaard dagen per jaar</label>
      <input type="number" class="form-input" id="mt-days" value="${t?t.defaultDays:0}" min="0" style="width:120px"/>
    </div>
    <div class="form-group">
      <label class="form-label">Max dagen per jaar <span style="font-weight:400;color:var(--text3)">(0 = geen limiet)</span></label>
      <input type="number" class="form-input" id="mt-maxdays" value="${t?t.maxDays||0:0}" min="0" style="width:120px"/>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveType('${id||''}')">Opslaan</button>
    </div>
  `);
}

function saveType(id){
  const name=document.getElementById('mt-name').value.trim();
  if(!name){showToast('Naam is verplicht','error');return;}
  const saldoType=document.getElementById('mt-saldo-type').value;
  const data={
    name,symbol:document.getElementById('mt-symbol').value,
    color:document.getElementById('mt-color').value,
    category:document.getElementById('mt-cat').value,
    paid:document.getElementById('mt-paid').value==='true',
    tracked:saldoType==='verlof',
    absenceTracked:saldoType==='afwezigheid',
    defaultDays:saldoType==='verlof'?(parseInt(document.getElementById('mt-days').value)||0):0,
    maxDays:parseInt(document.getElementById('mt-maxdays').value)||0
  };
  if(id){
    const t=leaveTypes.find(x=>x.id===id);
    if(t)Object.assign(t,data);
  }else{
    leaveTypes.push({id:uid(),...data});
  }
  closeModal();autoSave();renderTypes();showToast('Verloftype opgeslagen');
}

function toggleMobile(id,checked){
  const t=leaveTypes.find(x=>x.id===id);
  if(t){t.mobile=checked;autoSave();}
}

async function deleteType(id){
  if(!await confirmDialog('Verloftype verwijderen?'))return;
  leaveTypes=leaveTypes.filter(t=>t.id!==id);
  autoSave();renderTypes();showToast('Verloftype verwijderd');
}

// --- Schedules ---
function openScheduleModal(id){
  const s=id?schedules.find(x=>x.id===id):null;
  openModal(s?'Rooster bewerken':'Rooster toevoegen',`
    <div class="form-group">
      <label class="form-label">Naam <span class="req">*</span></label>
      <input class="form-input" id="ms-name" value="${s?s.name:''}"/>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Dagen per week</label>
        <input type="number" class="form-input" id="ms-days" value="${s?s.daysPerWeek:5}" min="1" max="7"/>
      </div>
      <div class="form-group">
        <label class="form-label">Uren per dag</label>
        <input type="number" class="form-input" id="ms-hours" value="${s?s.hoursPerDay:8}" min="1" max="12"/>
      </div>
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px">
        <input type="checkbox" id="ms-half" ${s&&s.halfDays?'checked':''}/> Halve dagen toestaan
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveSchedule('${id||''}')">Opslaan</button>
    </div>
  `);
}

function saveSchedule(id){
  const name=document.getElementById('ms-name').value.trim();
  if(!name){showToast('Naam is verplicht','error');return;}
  const data={name,daysPerWeek:parseInt(document.getElementById('ms-days').value)||5,
    hoursPerDay:parseInt(document.getElementById('ms-hours').value)||8,
    halfDays:document.getElementById('ms-half').checked};
  if(id){
    const s=schedules.find(x=>x.id===id);
    if(s)Object.assign(s,data);
  }else{
    schedules.push({id:uid(),...data});
  }
  closeModal();autoSave();renderSettings();showToast('Rooster opgeslagen');
}

async function deleteSchedule(id){
  if(!await confirmDialog('Rooster verwijderen?'))return;
  const inUse=people.filter(p=>p.scheduleId===id).length;
  if(inUse>0){showToast(`Kan niet verwijderen: ${inUse} medewerker(s) gebruiken dit rooster`,'error');return;}
  schedules=schedules.filter(s=>s.id!==id);
  autoSave();renderSettings();showToast('Rooster verwijderd');
}

// --- Settings ---
function setRegion(v){settings.region=v;autoSave();renderSettings();}
function saveSettings(){
  settings.yearendMode=document.getElementById('yearend-mode').value;
  settings.yearendCustomDays=parseInt(document.getElementById('yearend-custom-days').value)||5;
  settings.notifEmail=document.getElementById('notif-email').checked;
  settings.notifSick=document.getElementById('notif-sick').checked;
  document.getElementById('yearend-custom-row').style.display=settings.yearendMode==='custom'?'block':'none';
  autoSave();showToast('Instellingen opgeslagen');
}

// â•â•â• JAAROVERGANG â•â•â•
function getYearendMax(){
  const mode=settings.yearendMode||'max5';
  if(mode==='none')return 0;
  if(mode==='unlimited')return 999;
  if(mode==='max5')return 5;
  if(mode==='max10')return 10;
  if(mode==='custom')return settings.yearendCustomDays||5;
  return 5;
}

function calcYearendData(year){
  const maxCarry=getYearendMax();
  const nextYear=year+1;
  const results=[];
  people.filter(p=>!p.archived).forEach(p=>{
    const trackedTypes=leaveTypes.filter(t=>t.tracked&&(t.category==='verlof'||t.category==='adv'));
    trackedTypes.forEach(t=>{
      const total=getAllowanceForType(p,t.id);
      const used=requests.filter(r=>r.personId===p.id&&r.type===t.id&&(r.status==='approved')&&r.startDate.startsWith(''+year))
        .reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
      const remaining=total-used;
      if(remaining>0){
        const carry=maxCarry===0?0:Math.min(remaining,maxCarry);
        const lost=remaining-carry;
        results.push({personId:p.id,name:fullName(p),typeId:t.id,typeName:t.symbol+' '+t.name,total,used,remaining,carry,lost});
      }
    });
  });
  return results;
}

function previewYearend(){
  const year=parseInt(document.getElementById('yearend-year').value);
  const data=calcYearendData(year);
  const div=document.getElementById('yearend-preview');
  if(data.length===0){
    div.innerHTML='<div style="padding:12px;background:var(--surface2);border-radius:var(--radius-sm);font-size:12px;color:var(--text3)">Geen restdagen gevonden voor '+year+'.</div>';
    return;
  }
  const done=settings.yearendDone&&settings.yearendDone.includes(year);
  let html='<div style="border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden">';
  if(done)html+='<div style="background:var(--success-bg,#dcfce7);padding:8px 12px;font-size:12px;color:var(--success)">âœ… Jaarovergang '+year+' â†’ '+(year+1)+' is al uitgevoerd</div>';
  html+='<table class="tbl" style="margin:0"><thead><tr><th>Medewerker</th><th>Type</th><th>Recht</th><th>Gebruikt</th><th>Rest</th><th>Overdracht</th><th>Verloren</th></tr></thead><tbody>';
  data.forEach(d=>{
    html+=`<tr>
      <td style="font-weight:600;font-size:12px">${d.name}</td>
      <td style="font-size:12px">${d.typeName}</td>
      <td style="text-align:center;font-size:12px">${d.total}d</td>
      <td style="text-align:center;font-size:12px">${d.used}d</td>
      <td style="text-align:center;font-size:12px;font-weight:600">${d.remaining}d</td>
      <td style="text-align:center;font-size:12px;color:var(--success);font-weight:600">${d.carry>0?'+'+d.carry+'d':'â€”'}</td>
      <td style="text-align:center;font-size:12px;color:${d.lost>0?'var(--danger)':'var(--text3)'}">${d.lost>0?'-'+d.lost+'d':'â€”'}</td>
    </tr>`;
  });
  html+='</tbody></table></div>';
  const totalCarry=data.reduce((s,d)=>s+d.carry,0);
  const totalLost=data.reduce((s,d)=>s+d.lost,0);
  html+=`<div style="margin-top:8px;font-size:12px;color:var(--text3)">Totaal: ${totalCarry}d overdracht, ${totalLost}d verloren</div>`;
  div.innerHTML=html;
}

async function executeYearend(){
  const year=parseInt(document.getElementById('yearend-year').value);
  if(!settings.yearendDone)settings.yearendDone=[];
  if(settings.yearendDone.includes(year)){
    showToast('Jaarovergang '+year+' is al uitgevoerd','error');return;
  }
  const data=calcYearendData(year);
  if(data.length===0){
    showToast('Geen restdagen om over te dragen voor '+year,'error');return;
  }
  const totalCarry=data.reduce((s,d)=>s+d.carry,0);
  const totalLost=data.reduce((s,d)=>s+d.lost,0);
  if(!await confirmDialog(`Jaarovergang ${year} â†’ ${year+1} uitvoeren?\n\n${data.length} overdracht(en) voor ${new Set(data.map(d=>d.personId)).size} medewerker(s)\n+${totalCarry}d overdracht, -${totalLost}d verloren\n\nDit voegt een saldo-aanpassing toe per medewerker en kan niet automatisch ongedaan gemaakt worden.`))return;
  const nextYear=year+1;
  data.forEach(d=>{
    if(d.carry<=0)return;
    const p=people.find(x=>x.id===d.personId);
    if(!p)return;
    if(!p.allowanceAdjustments)p.allowanceAdjustments=[];
    p.allowanceAdjustments.push({typeId:d.typeId,days:d.carry,reason:'Overdracht '+year+' â†’ '+nextYear,date:nextYear+'-01-01'});
    if(!p.mutations)p.mutations=[];
    p.mutations.push({id:uid(),timestamp:new Date().toISOString(),user:'Systeem',field:'Jaarovergang '+year,oldValue:'Rest: '+d.remaining+'d '+d.typeName,newValue:'Overdracht: +'+d.carry+'d'+(d.lost>0?', verloren: -'+d.lost+'d':'')});
  });
  settings.yearendDone.push(year);
  autoSave();renderSettings();previewYearend();
  showToast(`Jaarovergang ${year} â†’ ${nextYear} uitgevoerd: ${totalCarry}d overgedragen`,'success');
}

// â•â•â• VALIDATION â•â•â•
// (handled inline in save functions with toast feedback)

// â•â•â• BEREKENINGEN â•â•â•
// (getTotalAllowance, getUsedDays defined in SAVE FUNCTIONS section above)

// â•â•â• PERSOONLIJKE VERLOFKALENDER â•â•â•
let _calPersonId='';
let _calYear=new Date().getFullYear();

function openPersonCalendar(personId){
  _calPersonId=personId;
  _calYear=new Date().getFullYear();
  renderPersonCalendar();
}

function renderPersonCalendar(){
  const p=people.find(x=>x.id===_calPersonId);
  if(!p)return;
  const year=_calYear;
  const myRequests=requests.filter(r=>r.personId===p.id&&(r.status==='approved'||r.status==='pending')&&(r.startDate.startsWith(''+year)||r.endDate.startsWith(''+year)))
    .sort((a,b)=>a.startDate.localeCompare(b.startDate));

  // Statistieken
  const approved=myRequests.filter(r=>r.status==='approved');
  const pending=myRequests.filter(r=>r.status==='pending');
  const totalApproved=approved.reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
  const totalPending=pending.reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);

  // Per-type breakdown
  const typeBreakdown={};
  approved.forEach(r=>{
    const t=leaveTypes.find(x=>x.id===r.type);
    const key=r.type;
    if(!typeBreakdown[key])typeBreakdown[key]={name:t?t.symbol+' '+t.name:r.type,color:t?t.color:'#999',days:0};
    typeBreakdown[key].days+=r.halfDay?0.5:r.days||0;
  });

  // Maand-grid
  const months=['Januari','Februari','Maart','April','Mei','Juni','Juli','Augustus','September','Oktober','November','December'];
  let gridHtml='';
  months.forEach((month,mi)=>{
    const monthRequests=myRequests.filter(r=>{
      const s=new Date(r.startDate),e=new Date(r.endDate);
      return (s.getFullYear()===year&&s.getMonth()===mi)||(e.getFullYear()===year&&e.getMonth()===mi);
    });
    if(monthRequests.length>0){
      gridHtml+=`<div style="margin-bottom:12px">
        <div style="font-weight:700;font-size:12px;color:var(--text2);margin-bottom:4px">${month}</div>`;
      monthRequests.forEach(r=>{
        const t=leaveTypes.find(x=>x.id===r.type);
        const isPending=r.status==='pending';
        const dayLabel=r.halfDay?'Â½ dag ('+r.halfDayPeriod+')':r.days+' dag'+(r.days!==1?'en':'');
        gridHtml+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;margin-bottom:2px;border-radius:var(--radius-xs);background:${t?t.color+'0d':'var(--surface)'};border-left:3px solid ${t?t.color:'var(--border)'}${isPending?';opacity:.6':''}">
          <span style="font-size:12px;min-width:120px">${formatDate(r.startDate)}${r.startDate!==r.endDate?' â†’ '+formatDate(r.endDate):''}</span>
          <span style="font-size:12px;color:${t?t.color:'var(--text2)'};font-weight:600">${t?t.symbol+' '+t.name:r.type}</span>
          <span style="font-size:11px;color:var(--text3);margin-left:auto">${dayLabel}</span>
          ${isPending?'<span class="badge badge-yellow" style="font-size:10px">â³</span>':''}
        </div>`;
      });
      gridHtml+='</div>';
    }
  });

  if(!gridHtml)gridHtml='<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px">Geen afwezigheden in '+year+'</div>';

  openModal('ğŸ“… Verlofkalender â€” '+fullName(p),`
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
      <button class="btn btn-sm" onclick="_calYear--;renderPersonCalendar()">â—€</button>
      <span style="font-weight:700;font-size:15px;min-width:50px;text-align:center">${year}</span>
      <button class="btn btn-sm" onclick="_calYear++;renderPersonCalendar()">â–¶</button>
      <div style="margin-left:auto;display:flex;gap:12px;font-size:12px">
        <span style="color:var(--success);font-weight:600">âœ… ${totalApproved}d goedgekeurd</span>
        ${totalPending>0?`<span style="color:var(--warn);font-weight:600">â³ ${totalPending}d in behandeling</span>`:''}
      </div>
    </div>
    ${Object.keys(typeBreakdown).length>0?`<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px">${Object.values(typeBreakdown).map(tb=>`<span class="badge" style="background:${tb.color}1a;color:${tb.color};font-size:11px">${tb.name}: ${tb.days}d</span>`).join('')}</div>`:''}
    <div style="max-height:400px;overflow-y:auto">${gridHtml}</div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal();openPersonModal('${_calPersonId}')">â† Fiche</button>
      <button class="btn" onclick="closeModal()">Sluiten</button>
    </div>
  `,true);
}

// â•â•â• DOCUMENTEN PER MEDEWERKER â•â•â•
function openDocumentsModal(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  if(!p.documents)p.documents=[];
  renderDocumentsModal(personId);
}

function renderDocumentsModal(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  if(!p.documents)p.documents=[];

  const docTypes=['Arbeidsovereenkomst','Loonbrief','Certificaat','Evaluatie','Bijlage contract','Opleiding','Identiteit','Rijbewijs','Andere'];
  const docs=p.documents.sort((a,b)=>(b.date||'').localeCompare(a.date||''));

  let docsHtml='';
  if(docs.length===0){
    docsHtml='<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px">Nog geen documenten toegevoegd</div>';
  }else{
    docsHtml=docs.map(d=>{
      const icon=d.type==='Arbeidsovereenkomst'?'ğŸ“„':d.type==='Loonbrief'?'ğŸ’¶':d.type==='Certificaat'?'ğŸ…':d.type==='Evaluatie'?'ğŸ“‹':d.type==='Opleiding'?'ğŸ“':d.type==='Identiteit'?'ğŸªª':d.type==='Rijbewijs'?'ğŸš—':'ğŸ“';
      return `<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:4px;border-radius:var(--radius-xs);background:var(--surface);border:1px solid var(--border)">
        <span style="font-size:18px">${icon}</span>
        <div style="flex:1">
          <div style="font-weight:600;font-size:13px">${d.name||d.type}</div>
          <div style="font-size:11px;color:var(--text3)">${d.type}${d.date?' Â· '+formatDate(d.date):''}${d.note?' Â· '+d.note:''}</div>
        </div>
        ${d.fileData?`<button class="btn btn-sm" onclick="downloadDocument('${personId}','${d.id}')" style="font-size:11px">â¬‡ Download</button>`:''}
        <button class="btn btn-sm btn-danger" onclick="deleteDocument('${personId}','${d.id}')" style="font-size:11px">ğŸ—‘</button>
      </div>`;
    }).join('');
  }

  openModal('ğŸ“ Documenten â€” '+fullName(p),`
    <div style="margin-bottom:16px;padding:12px;background:var(--surface2);border-radius:var(--radius-sm)">
      <div style="font-weight:700;font-size:12px;margin-bottom:8px">Nieuw document toevoegen</div>
      <div class="form-row" style="margin-bottom:8px">
        <div class="form-group" style="flex:1">
          <select class="form-input" id="doc-type" style="font-size:12px">
            ${docTypes.map(t=>`<option>${t}</option>`).join('')}
          </select>
        </div>
        <div class="form-group" style="flex:1">
          <input class="form-input" type="text" id="doc-name" placeholder="Documentnaam (optioneel)" style="font-size:12px"/>
        </div>
        <div class="form-group" style="flex:1">
          <input class="form-input" type="date" id="doc-date" value="${new Date().toISOString().split('T')[0]}" style="font-size:12px"/>
        </div>
      </div>
      <div class="form-row" style="margin-bottom:8px">
        <div class="form-group" style="flex:2">
          <input class="form-input" type="text" id="doc-note" placeholder="Opmerking (optioneel)" style="font-size:12px"/>
        </div>
        <div class="form-group" style="flex:1">
          <input type="file" id="doc-file" style="font-size:11px" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx"/>
        </div>
      </div>
      <button class="btn btn-sm btn-primary" onclick="addDocument('${personId}')">â• Toevoegen</button>
    </div>
    <div style="font-size:11px;color:var(--text3);margin-bottom:8px">${p.documents.length} document${p.documents.length!==1?'en':''}</div>
    <div style="max-height:350px;overflow-y:auto">${docsHtml}</div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal();openPersonModal('${personId}')">â† Fiche</button>
      <button class="btn" onclick="closeModal()">Sluiten</button>
    </div>
  `,true);
}

function addDocument(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  if(!p.documents)p.documents=[];
  const type=document.getElementById('doc-type').value;
  const name=document.getElementById('doc-name').value.trim();
  const date=document.getElementById('doc-date').value;
  const note=document.getElementById('doc-note').value.trim();
  const fileInput=document.getElementById('doc-file');
  const file=fileInput.files[0];

  const doc={id:'doc_'+uid(),type,name:name||type,date,note,addedDate:new Date().toISOString(),addedBy:settings.currentUser||'Admin'};

  if(file){
    if(file.size>2*1024*1024){showToast('Bestand is te groot (max 2MB). Gebruik kleinere bestanden of PDF.','error');return;}
    const reader=new FileReader();
    reader.onload=function(e){
      doc.fileData=e.target.result;
      doc.fileName=file.name;
      doc.fileSize=file.size;
      doc.fileType=file.type;
      p.documents.push(doc);
      if(!p.mutations)p.mutations=[];
      p.mutations.push({id:uid(),timestamp:new Date().toISOString(),user:settings.currentUser||'Admin',field:'Document toegevoegd',oldValue:'',newValue:doc.name+' ('+doc.type+')'});
      autoSave();renderDocumentsModal(personId);
      showToast('Document opgeslagen');
    };
    reader.readAsDataURL(file);
  }else{
    showToast('Selecteer een bijlage om een document toe te voegen','error');
    fileInput.focus();
    return;
  }
}

function downloadDocument(personId,docId){
  const p=people.find(x=>x.id===personId);
  if(!p||!p.documents)return;
  const doc=p.documents.find(d=>d.id===docId);
  if(!doc||!doc.fileData)return;
  const a=document.createElement('a');
  a.href=doc.fileData;
  a.download=doc.fileName||doc.name;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}

async function deleteDocument(personId,docId){
  if(!await confirmDialog('Document verwijderen?'))return;
  const p=people.find(x=>x.id===personId);
  if(!p||!p.documents)return;
  const doc=p.documents.find(d=>d.id===docId);
  if(doc){
    if(!p.mutations)p.mutations=[];
    p.mutations.push({id:uid(),timestamp:new Date().toISOString(),user:settings.currentUser||'Admin',field:'Document verwijderd',oldValue:doc.name+' ('+doc.type+')',newValue:''});
  }
  p.documents=p.documents.filter(d=>d.id!==docId);
  autoSave();renderDocumentsModal(personId);
  showToast('Document verwijderd');
}

// â•â•â• MEDIA â•â•â•
// (OCR for sick notes â€” Phase 2)

// â•â•â• EXPORT â•â•â•

// --- Wallchart ---
let wcDate=new Date();
let wcMode='month'; // 'month' or 'week'
let wcTypeFilter=null; // null = alles tonen, of een type id

function wcPrev(){
  if(wcMode==='month')wcDate.setMonth(wcDate.getMonth()-1);
  else wcDate.setDate(wcDate.getDate()-7);
  renderWallchart();
}
function wcNext(){
  if(wcMode==='month')wcDate.setMonth(wcDate.getMonth()+1);
  else wcDate.setDate(wcDate.getDate()+7);
  renderWallchart();
}
function wcToday(){wcDate=new Date();renderWallchart();}
function toggleWcMode(){
  wcMode=wcMode==='month'?'week':'month';
  document.getElementById('wc-mode-btn').textContent=wcMode==='month'?'Maand':'Week';
  renderWallchart();
}

function renderWallchart(){
  const deptFilter=document.getElementById('wc-dept').value;
  const deptSelect=document.getElementById('wc-dept');
  const curVal=deptSelect.value;
  deptSelect.innerHTML='<option value="">Alle departments</option>'+departments.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
  deptSelect.value=curVal;

  // Build date range
  let days=[];
  if(wcMode==='month'){
    const year=wcDate.getFullYear();
    const month=wcDate.getMonth();
    const daysInMonth=new Date(year,month+1,0).getDate();
    for(let i=1;i<=daysInMonth;i++)days.push(new Date(year,month,i));
    document.getElementById('wc-subtitle').textContent=wcDate.toLocaleDateString('nl-BE',{month:'long',year:'numeric'});
  }else{
    const start=new Date(wcDate);
    start.setDate(start.getDate()-start.getDay()+1);
    for(let i=0;i<7;i++){const d=new Date(start);d.setDate(start.getDate()+i);days.push(d);}
    document.getElementById('wc-subtitle').textContent=`Week ${getWeekNumber(days[0])} â€” ${days[0].toLocaleDateString('nl-BE',{day:'numeric',month:'short'})} t/m ${days[6].toLocaleDateString('nl-BE',{day:'numeric',month:'short',year:'numeric'})}`;
  }

  // Legend â€” alleen types die daadwerkelijk voorkomen in deze periode
  const legend=document.getElementById('wc-legend');
  const periodStart=days[0].toISOString().split('T')[0];
  const periodEnd=days[days.length-1].toISOString().split('T')[0];
  const periodPeople=deptFilter?people.filter(p=>p.departmentId===deptFilter):people;
  const usedTypeIds=new Set();
  requests.filter(r=>r.status==='approved'&&r.startDate<=periodEnd&&r.endDate>=periodStart&&periodPeople.some(p=>p.id===r.personId))
    .forEach(r=>usedTypeIds.add(r.type));
  const usedTypes=leaveTypes.filter(t=>usedTypeIds.has(t.id));
  legend.innerHTML=usedTypes.map(t=>{
    const isActive=wcTypeFilter===t.id;
    return `<span onclick="wcTypeFilter=${isActive?'null':"'"+t.id+"'"};renderWallchart()" style="display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:8px;cursor:pointer;border:2px solid ${isActive?t.color:'transparent'};background:${isActive?t.color+'18':'transparent'};font-weight:${isActive?'700':'400'};transition:all .15s"><span class="clr-dot" style="background:${t.color}"></span>${t.symbol} ${t.name}</span>`;
  }).join('')+(wcTypeFilter?`<span onclick="wcTypeFilter=null;renderWallchart()" style="padding:3px 8px;border-radius:8px;cursor:pointer;border:1px solid #e2e8f0;color:#94a3b8;font-size:10px">âœ• Filter wissen</span>`:'');

  // Header
  const thead=document.getElementById('wc-thead');
  const today=new Date().toISOString().split('T')[0];
  const dayNames=['Zo','Ma','Di','Wo','Do','Vr','Za'];
  thead.innerHTML=`<tr><th style="min-width:140px;position:sticky;left:0;background:var(--surface);z-index:1">Medewerker</th>${days.map(d=>{
    const ds=d.toISOString().split('T')[0];
    const isToday=ds===today;
    const isWeekend=d.getDay()===0||d.getDay()===6;
    const isHoliday=isPublicHoliday(ds);
    return `<th style="min-width:${wcMode==='week'?'80':'28'}px;text-align:center;padding:4px 2px;
      ${isToday?'background:var(--accent-bg);color:var(--accent);font-weight:700;':''}
      ${isWeekend?'background:#f1f1f5;color:var(--text3);':''}
      ${isHoliday?'background:rgba(239,68,68,.08);color:var(--danger);':''}
      font-size:10px">${d.getDate()}<br>${dayNames[d.getDay()]}</th>`;
  }).join('')}</tr>`;

  // Body
  let filteredPeople=[...people];
  if(deptFilter)filteredPeople=filteredPeople.filter(p=>p.departmentId===deptFilter);

  const tbody=document.getElementById('wc-tbody');
  tbody.innerHTML=filteredPeople.map(p=>{
    const dept=departments.find(d=>d.id===p.departmentId);
    return `<tr>
      <td style="position:sticky;left:0;background:var(--surface);z-index:1;white-space:nowrap">
        <div style="display:flex;align-items:center;gap:6px">
          <div class="avatar" style="background:${getAvatarColor(fullName(p))};width:22px;height:22px;font-size:9px">${getInitials(fullName(p))}</div>
          <div><div style="font-weight:600;font-size:11px">${fullName(p)}</div>
          <div style="font-size:9px;color:var(--text3)">${dept?dept.name:''}</div></div>
        </div>
      </td>
      ${days.map(d=>{
        const ds=d.toISOString().split('T')[0];
        const isWeekend=d.getDay()===0||d.getDay()===6;
        const isHoliday=isPublicHoliday(ds);
        const req=requests.find(r=>r.personId===p.id&&r.status==='approved'&&r.startDate<=ds&&r.endDate>=ds);
        const type=req?leaveTypes.find(t=>t.id===req.type):null;
        const isFiltered=wcTypeFilter&&type&&type.id!==wcTypeFilter;
        let bg=isWeekend?'#f1f1f5':isHoliday?'rgba(239,68,68,.06)':'';
        let content='';
        if(type){
          const half=req.halfDay;
          if(isFiltered){
            bg='#f8f8fa';
            content=`<span style="display:block;width:100%;height:100%;background:#e2e8f0;border-radius:3px;opacity:.3"></span>`;
          }else{
            bg=type.color+'33';
            content=`<span title="${type.name}${half?' ('+req.halfDayPeriod+')':''}: ${fullName(p)}" style="display:block;width:100%;height:100%;background:${type.color}${half?'66':'cc'};border-radius:3px;color:#fff;font-size:9px;line-height:${wcMode==='week'?'28':'22'}px;text-align:center">${type.symbol}</span>`;
          }
        }
        return `<td style="padding:2px;text-align:center;background:${bg};height:${wcMode==='week'?'32':'26'}px">${content}</td>`;
      }).join('')}
    </tr>`;
  }).join('');
}

function isPublicHoliday(dateStr){
  const allHolidays=getBEHolidays();
  const region=settings.region||'vlaanderen';
  return allHolidays.some(h=>h.date===dateStr&&(h.all||(h.regions&&h.regions.includes(region))));
}

function getWeekNumber(d){
  const date=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
  date.setUTCDate(date.getUTCDate()+4-(date.getUTCDay()||7));
  const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1));
  return Math.ceil((((date-yearStart)/86400000)+1)/7);
}

// --- Rapportage ---
let reportTab='overview';

function showReportTab(tab,btn){
  reportTab=tab;
  document.querySelectorAll('.report-panel').forEach(p=>p.style.display='none');
  document.getElementById('report-'+tab).style.display='block';
  if(btn){btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');}
  renderReports();
  if(tab==='accidents'){
    // Fill year selector
    const yearSel=document.getElementById('acc-year');
    if(yearSel&&yearSel.options.length===0){
      const curYear=new Date().getFullYear();
      for(let y=curYear;y>=curYear-5;y--)yearSel.innerHTML+=`<option value="${y}">${y}</option>`;
    }
    // Restore hours from settings
    const year=parseInt(document.getElementById('acc-year').value)||new Date().getFullYear();
    const hoursInput=document.getElementById('acc-total-hours');
    if(hoursInput&&accidentSettings.totalHours[year])hoursInput.value=accidentSettings.totalHours[year];
    renderAccidentStats();
  }
}

function openPersonFromReport(personId){
  window._fromReport=true;
  openPersonModal(personId);
}

function renderReports(){
  const year=new Date().getFullYear();
  document.getElementById('rp-year-label').textContent='Overzichten '+year;
  const approvedReqs=requests.filter(r=>r.status==='approved'&&r.startDate.startsWith(year));

  // Overview stats
  const totalDays=approvedReqs.reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
  const sickDays=approvedReqs.filter(r=>r.type==='ziekte').reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
  const externDays=approvedReqs.filter(r=>{const t=leaveTypes.find(x=>x.id===r.type);return t&&t.category==='extern';}).reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
  document.getElementById('rp-total-days').textContent=totalDays;
  document.getElementById('rp-total-sick').textContent=sickDays;
  document.getElementById('rp-total-extern').textContent=externDays;
  document.getElementById('rp-avg-per-person').textContent=people.length>0?(totalDays/people.length).toFixed(1):'0';

  // Stacked bar chart per month, split by type
  const trackedTypes=leaveTypes.filter(t=>t.tracked||t.id==='ziekte');
  const monthData=Array.from({length:12},()=>({}));
  approvedReqs.forEach(r=>{
    const m=parseInt(r.startDate.split('-')[1])-1;
    const d=r.halfDay?0.5:r.days||0;
    monthData[m][r.type]=(monthData[m][r.type]||0)+d;
  });
  const monthTotals=monthData.map(m=>Object.values(m).reduce((s,v)=>s+v,0));
  const maxVal=Math.max(...monthTotals,1);

  // Legend
  const usedTypes=leaveTypes.filter(t=>approvedReqs.some(r=>r.type===t.id));
  document.getElementById('rp-chart-legend').innerHTML=usedTypes.map(t=>
    `<span style="display:flex;align-items:center;gap:4px"><span class="clr-dot" style="background:${t.color}"></span>${t.symbol} ${t.name}</span>`
  ).join('')||'<span style="color:var(--text3)">Geen data</span>';

  // Y-axis
  const steps=[0,Math.round(maxVal/2),Math.round(maxVal)];
  document.getElementById('rp-chart-axis').innerHTML=steps.reverse().map(v=>`<div>${v}d</div>`).join('');

  // Bars
  const monthNames=['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];
  const curMonth=new Date().getMonth();
  document.getElementById('rp-month-chart').innerHTML=monthData.map((m,i)=>{
    const total=monthTotals[i];
    const isCur=i===curMonth;
    const segments=leaveTypes.filter(t=>m[t.id]>0).map(t=>{
      const h=Math.max(1,(m[t.id]/maxVal)*130);
      return `<div title="${t.symbol} ${t.name}: ${m[t.id]}d" style="width:100%;height:${h}px;background:${t.color};opacity:${isCur?1:.7}"></div>`;
    }).join('');
    return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;gap:0">
      <div style="font-size:9px;font-weight:700;margin-bottom:2px;color:${isCur?'var(--accent)':'var(--text3)'}">${total>0?total:''}</div>
      <div style="width:100%;display:flex;flex-direction:column;border-radius:3px 3px 0 0;overflow:hidden">${segments||`<div style="width:100%;height:2px;background:var(--surface3)"></div>`}</div>
    </div>`;
  }).join('');
  document.getElementById('rp-month-labels').innerHTML=monthNames.map((m,i)=>
    `<div style="flex:1;text-align:center;${i===curMonth?'font-weight:700;color:var(--accent)':''}">${m}</div>`
  ).join('');

  // Type donut (horizontal bars as visual representation)
  const typeStats=leaveTypes.map(t=>{
    const d=approvedReqs.filter(r=>r.type===t.id).reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
    return {type:t,days:d};
  }).filter(x=>x.days>0).sort((a,b)=>b.days-a.days);
  const maxType=typeStats.length>0?typeStats[0].days:1;

  document.getElementById('rp-type-donut').innerHTML=typeStats.length===0
    ?'<div style="color:var(--text3);padding:20px;text-align:center">Geen data voor dit jaar</div>'
    :typeStats.map(x=>{
      const pct=Math.max(5,(x.days/maxType)*100);
      const share=totalDays>0?Math.round(x.days/totalDays*100):0;
      return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <div style="min-width:100px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px">
          <span class="clr-dot" style="background:${x.type.color}"></span>${x.type.symbol} ${x.type.name}
        </div>
        <div style="flex:1;height:22px;background:var(--surface3);border-radius:4px;overflow:hidden;position:relative">
          <div style="height:100%;width:${pct}%;background:${x.type.color};border-radius:4px;opacity:.8;transition:width .3s"></div>
        </div>
        <div style="min-width:60px;text-align:right;font-size:12px"><strong>${x.days}d</strong> <span style="color:var(--text3)">(${share}%)</span></div>
      </div>`;
    }).join('');

  // Per person table
  const ptBody=document.getElementById('rp-person-table');
  ptBody.innerHTML=people.map(p=>{
    const dept=departments.find(d=>d.id===p.departmentId);
    const total=getTotalAllowance(p);
    const used=getUsedDays(p.id);
    const today=new Date().toISOString().split('T')[0];
    const planned=requests.filter(r=>r.personId===p.id&&r.status==='approved'&&r.startDate>today)
      .reduce((s,r)=>{const t=leaveTypes.find(x=>x.id===r.type);return s+((t&&t.tracked)?(r.halfDay?0.5:r.days||0):0);},0);
    const sick=requests.filter(r=>r.personId===p.id&&r.type==='ziekte'&&r.startDate.startsWith(year))
      .reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
    const absence=requests.filter(r=>r.personId===p.id&&r.status==='approved'&&r.startDate.startsWith(year))
      .reduce((s,r)=>{const t=leaveTypes.find(x=>x.id===r.type);return s+((t&&t.absenceTracked)?(r.halfDay?0.5:r.days||0):0);},0);
    const remaining=total-used-planned;
    return `<tr style="cursor:pointer" onclick="openPersonFromReport('${p.id}')" title="Klik om fiche te openen">
      <td><div style="display:flex;align-items:center;gap:8px">
        <div class="avatar" style="background:${getAvatarColor(fullName(p))};width:26px;height:26px;font-size:10px">${getInitials(fullName(p))}</div>
        <span style="font-weight:600">${fullName(p)}</span>
      </div></td>
      <td>${dept?dept.name:'â€”'}</td>
      <td style="font-weight:600;text-align:center">${total}d</td>
      <td style="text-align:center">${used}d</td>
      <td style="text-align:center;color:${planned>0?'var(--warn)':'var(--text3)'}">${planned}d</td>
      <td style="font-weight:700;text-align:center;color:${remaining>5?'var(--success)':remaining>0?'var(--warn)':'var(--danger)'}">${remaining}d</td>
      <td style="text-align:center;color:${absence>0?'var(--text2)':'var(--text3)'}">${absence}d</td>
      <td style="text-align:center;color:${sick>0?'var(--danger)':'var(--text3)'}">${sick}d</td>
    </tr>`;
  }).join('');

  // Per type table
  const ttBody=document.getElementById('rp-type-table');
  ttBody.innerHTML=leaveTypes.map(t=>{
    const typeReqs=approvedReqs.filter(r=>r.type===t.id);
    const totalD=typeReqs.reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
    const avgD=typeReqs.length>0?(totalD/typeReqs.length).toFixed(1):'â€”';
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:6px"><span class="clr-dot" style="background:${t.color}"></span>${t.symbol} <span style="font-weight:600">${t.name}</span></div></td>
      <td><span class="badge badge-gray">${t.category}</span></td>
      <td style="font-weight:600">${totalD}d</td>
      <td>${typeReqs.length}</td>
      <td>${avgD}d</td>
    </tr>`;
  }).join('');
}

// â•â•â• FIELD INFO TOGGLE â•â•â•
function toggleFieldInfo(id){
  const el=document.getElementById(id);
  if(!el)return;
  // Close all others
  document.querySelectorAll('.fi-box').forEach(b=>{if(b.id!==id)b.style.display='none';});
  el.style.display=el.style.display==='none'?'block':'none';
}

// â•â•â• ORGANIGRAM â•â•â•
function renderOrganigram(){
  const container=document.getElementById('organigram-container');
  if(!container)return;
  const activePeople=people.filter(p=>!p.archived);
  const activeDepts=departments.filter(d=>activePeople.some(p=>p.departmentId===d.id));

  // Build hierarchy: top-level depts (no parent), then children
  const topDepts=activeDepts.filter(d=>!d.parentDeptId||!activeDepts.find(x=>x.id===d.parentDeptId));
  const childDepts=activeDepts.filter(d=>d.parentDeptId&&activeDepts.find(x=>x.id===d.parentDeptId));

  // Directie / zaakvoerders at top
  const directie=activeDepts.find(d=>d.id==='dept-directie')||topDepts[0];
  const zaakvoerders=directie?activePeople.filter(p=>p.departmentId===directie.id):[];
  const otherTopDepts=topDepts.filter(d=>d!==directie);

  const deptColor={
    'dept-directie':'#1e293b','dept-install':'#1e40af','dept-service':'#065f46',
    'dept-back':'#6b21a8','dept-verkoop':'#c2410c','dept-onderhoud':'#0e7490'
  };
  const deptColorLight={
    'dept-directie':'#f8fafc','dept-install':'#eff6ff','dept-service':'#ecfdf5',
    'dept-back':'#faf5ff','dept-verkoop':'#fff7ed','dept-onderhoud':'#ecfeff'
  };
  function getColor(dId){return deptColor[dId]||'#334155';}
  function getColorLight(dId){return deptColorLight[dId]||'#f8fafc';}
  function avatarBg(n){let h=0;for(let i=0;i<n.length;i++)h=n.charCodeAt(i)+((h<<5)-h);return 'hsl('+Math.abs(h)%360+',45%,42%)';}
  function ini(n){return n.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();}

  function renderPersonCard(p,showRole){
    const role=p.teamRole||'';
    const isLead=role==='Ploegleider'||role==='Manager'||role==='Zaakvoerder';
    return `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;background:${isLead?'rgba(59,130,246,.04)':'#fff'};border:1px solid ${isLead?'rgba(59,130,246,.15)':'#f1f5f9'}">
      <div style="width:26px;height:26px;border-radius:50%;background:${avatarBg(fullName(p))};display:flex;align-items:center;justify-content:center;color:#fff;font-size:9px;font-weight:700;flex-shrink:0">${ini(fullName(p))}</div>
      <div style="flex:1;min-width:0"><div style="font-weight:600;font-size:12px;color:#1e293b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${fullName(p)}</div>
      ${role?`<div style="font-size:10px;color:#64748b">${role}</div>`:''}</div>
      ${isLead?'<div style="font-size:10px;padding:1px 6px;border-radius:4px;background:rgba(59,130,246,.1);color:#2563eb;font-weight:600;white-space:nowrap">'+role+'</div>':''}
    </div>`;
  }

  function renderDeptBlock(d){
    const dPeople=activePeople.filter(p=>p.departmentId===d.id);
    const manager=d.managerId?dPeople.find(p=>p.id===d.managerId)||activePeople.find(p=>p.id===d.managerId):null;
    const leads=dPeople.filter(p=>p.teamRole==='Ploegleider'&&p!==manager);
    const others=dPeople.filter(p=>p!==manager&&!leads.includes(p));
    const children=childDepts.filter(c=>c.parentDeptId===d.id);
    const color=getColor(d.id);
    const colorLight=getColorLight(d.id);

    let html=`<div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;border-top:3px solid ${color};overflow:hidden">
      <div style="padding:12px 14px;background:${colorLight}">
        <div style="font-weight:700;font-size:14px;color:${color}">${d.name}</div>
        <div style="font-size:11px;color:#94a3b8">${dPeople.length} medewerker${dPeople.length!==1?'s':''}</div>
        ${manager?`<div style="display:flex;align-items:center;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid rgba(0,0,0,.06)">
          <div style="width:28px;height:28px;border-radius:50%;background:${avatarBg(fullName(manager))};display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:700">${ini(fullName(manager))}</div>
          <div><div style="font-weight:600;font-size:12px;color:#1e293b">${fullName(manager)}</div><div style="font-size:10px;color:#64748b">${manager.teamRole||'Manager'}</div></div>
        </div>`:''}
      </div>
      <div style="padding:8px;display:flex;flex-direction:column;gap:3px">`;
    leads.forEach(p=>{html+=renderPersonCard(p,true);});
    others.forEach(p=>{html+=renderPersonCard(p,false);});
    html+=`</div>`;

    // Child departments
    if(children.length>0){
      html+=`<div style="padding:8px;border-top:1px dashed #e2e8f0;display:flex;gap:10px;flex-wrap:wrap">`;
      children.forEach(c=>{html+=`<div style="flex:1;min-width:200px">${renderDeptBlock(c)}</div>`;});
      html+=`</div>`;
    }

    html+=`</div>`;
    return html;
  }

  // Build full organigram
  let html=`<div style="text-align:center;margin-bottom:32px">
    <div style="font-size:20px;font-weight:700;color:#1e293b">Advanced Energy</div>
    <div style="font-size:12px;color:#94a3b8;margin-top:2px">Organisatiestructuur Â· ${activePeople.length} medewerkers Â· ${activeDepts.length} departments</div>
  </div>`;

  // Zaakvoerders block
  if(zaakvoerders.length>0){
    html+=`<div style="display:flex;justify-content:center;margin-bottom:24px">
      <div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;border-top:3px solid #1e293b;padding:16px 20px;min-width:280px">
        <div style="font-weight:700;font-size:13px;color:#1e293b;text-align:center;margin-bottom:10px">${directie?directie.name:'Directie'}</div>
        <div style="display:flex;flex-direction:column;gap:4px">`;
    zaakvoerders.forEach(p=>{html+=renderPersonCard(p,true);});
    html+=`</div></div></div>`;

    // Connector line
    html+=`<div style="display:flex;justify-content:center;margin-bottom:24px"><div style="width:2px;height:32px;background:linear-gradient(to bottom,#cbd5e1,#e2e8f0)"></div></div>`;

    // Horizontal connector
    if(otherTopDepts.length>1){
      html+=`<div style="display:flex;justify-content:center;margin-bottom:0"><div style="height:2px;background:#e2e8f0;width:${Math.min(otherTopDepts.length*220,900)}px"></div></div>`;
    }
  }

  // Department blocks
  html+=`<div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;align-items:flex-start">`;
  otherTopDepts.forEach(d=>{
    html+=`<div style="flex:0 1 220px;min-width:200px">
      <div style="display:flex;justify-content:center;margin-bottom:12px"><div style="width:2px;height:20px;background:#e2e8f0"></div></div>
      ${renderDeptBlock(d)}
    </div>`;
  });
  html+=`</div>`;

  container.innerHTML=html;
}

async function exportOrganigramPDF(){
  showToast('PDF wordt gegenereerd...');
  const container=document.getElementById('organigram-container');
  if(!container)return;
  // Use html2canvas + jsPDF approach via canvas
  const {jsPDF}=await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js').catch(()=>({}));
  // Fallback: print-friendly approach
  const printWin=window.open('','_blank');
  printWin.document.write(`<!DOCTYPE html><html><head><title>Organigram â€” Advanced Energy</title><style>
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;padding:24px;background:#fff}
    @media print{body{padding:10mm}@page{size:A3 landscape;margin:10mm}}
  </style></head><body>${container.innerHTML}
  <script>setTimeout(function(){window.print();},300)<\/script></body></html>`);
  printWin.document.close();
}

// â•â•â• ARBEIDSONGEVALLEN â•â•â•
function renderAccidentStats(){
  const yearSel=document.getElementById('acc-year');
  if(!yearSel)return;
  const year=parseInt(yearSel.value)||new Date().getFullYear();
  const hoursInput=document.getElementById('acc-total-hours');
  const hours=parseFloat(hoursInput?hoursInput.value:0)||0;
  // Persist hours per year
  if(hours>0){accidentSettings.totalHours[year]=hours;autoSave();}
  else if(accidentSettings.totalHours[year]&&hoursInput){hoursInput.value=accidentSettings.totalHours[year];}

  const yearAccidents=accidents.filter(a=>a.date&&a.date.startsWith(''+year)&&!a.deleted);
  const werkplek=yearAccidents.filter(a=>a.locatie==='werkplek');
  const woonwerk=yearAccidents.filter(a=>a.locatie==='woon-werk');
  const totalLostDays=yearAccidents.reduce((s,a)=>s+(a.verlorenDagen||0),0);
  const werkplekLostDays=werkplek.reduce((s,a)=>s+(a.verlorenDagen||0),0);
  const forfaitDays=yearAccidents.reduce((s,a)=>s+(a.forfaitDagen||0),0);

  const totalHours=hours||accidentSettings.totalHours[year]||0;
  // FOD formules â€” enkel werkplek ongevallen voor Fg
  const fg=totalHours>0?(werkplek.length/totalHours*1000000):0;
  const egWerkelijk=totalHours>0?(werkplekLostDays/totalHours*1000):0;
  const egGlobaal=totalHours>0?((werkplekLostDays+forfaitDays)/totalHours*1000):0;

  const cards=document.getElementById('acc-stats-cards');
  if(cards){
    cards.innerHTML=`
      <div class="card"><div class="stat"><div class="stat-value" style="color:var(--danger)">${yearAccidents.length}</div><div class="stat-label">Ongevallen ${year}</div></div></div>
      <div class="card"><div class="stat"><div class="stat-value" style="color:${fg>25?'var(--danger)':fg>10?'var(--warn)':'var(--success)'}">${totalHours>0?fg.toFixed(2):'â€”'}</div><div class="stat-label">Frequentiegraad (Fg)</div><div style="font-size:10px;color:var(--text3);margin-top:2px">per 1.000.000 uren</div></div></div>
      <div class="card"><div class="stat"><div class="stat-value" style="color:${egWerkelijk>1?'var(--danger)':egWerkelijk>0.3?'var(--warn)':'var(--success)'}">${totalHours>0?egWerkelijk.toFixed(3):'â€”'}</div><div class="stat-label">Werkelijke ernstgraad</div><div style="font-size:10px;color:var(--text3);margin-top:2px">per 1.000 uren</div></div></div>
      <div class="card"><div class="stat"><div class="stat-value" style="color:${egGlobaal>1.5?'var(--danger)':egGlobaal>0.5?'var(--warn)':'var(--success)'}">${totalHours>0?egGlobaal.toFixed(3):'â€”'}</div><div class="stat-label">Globale ernstgraad</div><div style="font-size:10px;color:var(--text3);margin-top:2px">incl. forfait</div></div></div>
    `;
  }

  const container=document.getElementById('acc-table-container');
  if(!container)return;
  if(yearAccidents.length===0){
    container.innerHTML='<div style="text-align:center;padding:30px;color:var(--text3);font-size:13px">Geen arbeidsongevallen geregistreerd in '+year+'.</div>';
    return;
  }
  let html='<div style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius-sm)"><table class="tbl" style="margin:0"><thead><tr><th>Datum</th><th>Medewerker</th><th>Locatie</th><th>Ernst</th><th>Verloren dagen</th><th>Forfait</th><th>Omschrijving</th><th></th></tr></thead><tbody>';
  yearAccidents.sort((a,b)=>b.date.localeCompare(a.date)).forEach(a=>{
    const p=people.find(x=>x.id===a.personId);
    const locLabel=a.locatie==='werkplek'?'ğŸ­ Werkplek':'ğŸš— Woon-werk';
    const ernstLabel=a.ernst==='dodelijk'?'ğŸ’€ Dodelijk':a.ernst==='blijvend'?'ğŸ”´ Blijvend':a.ernst==='tijdelijk'?'ğŸŸ¡ Tijdelijk':'ğŸŸ¢ Geen verzuim';
    html+=`<tr>
      <td style="white-space:nowrap;font-size:12px">${formatDate(a.date)}</td>
      <td style="font-weight:600;font-size:12px">${p?fullName(p):'Onbekend'}</td>
      <td style="font-size:12px">${locLabel}</td>
      <td style="font-size:12px">${ernstLabel}</td>
      <td style="text-align:center;font-weight:600">${a.verlorenDagen||0}d</td>
      <td style="text-align:center;font-weight:600;color:${a.forfaitDagen>0?'var(--danger)':'var(--text3)'}">${a.forfaitDagen||0}d</td>
      <td style="font-size:12px;color:var(--text2)">${a.omschrijving||'â€”'}</td>
      <td><div style="display:flex;gap:4px">
        <button class="btn btn-sm" onclick="openAccidentModal('${a.id}')" style="font-size:10px">âœï¸</button>
        <button class="btn btn-sm btn-danger" onclick="deleteAccident('${a.id}')" style="font-size:10px">ğŸ—‘</button>
      </div></td>
    </tr>`;
  });
  html+='</tbody></table></div>';

  // Formule toelichting
  html+=`<div style="margin-top:16px;padding:12px;background:var(--surface2);border-radius:var(--radius-sm);font-size:11px;color:var(--text3);line-height:1.7">
    <strong>FOD formules:</strong><br/>
    Fg = (${werkplek.length} werkplekongevallen Ã· ${totalHours||'?'} uren) Ã— 1.000.000 = <strong>${totalHours>0?fg.toFixed(2):'â€”'}</strong><br/>
    Eg werkelijk = (${werkplekLostDays} verloren dagen Ã· ${totalHours||'?'} uren) Ã— 1.000 = <strong>${totalHours>0?egWerkelijk.toFixed(3):'â€”'}</strong><br/>
    Eg globaal = ((${werkplekLostDays} + ${forfaitDays} forfait) Ã· ${totalHours||'?'} uren) Ã— 1.000 = <strong>${totalHours>0?egGlobaal.toFixed(3):'â€”'}</strong>
  </div>`;

  container.innerHTML=html;
}

function openAccidentModal(accId){
  const acc=accId?accidents.find(a=>a.id===accId):null;
  const personOpts=people.filter(p=>!p.archived).map(p=>`<option value="${p.id}" ${acc&&acc.personId===p.id?'selected':''}>${fullName(p)}</option>`).join('');

  openModal(acc?'âœï¸ Ongeval bewerken':'â• Arbeidsongeval registreren',`
    <div class="form-row">
      <div class="form-group" style="flex:1">
        <label class="form-label">Medewerker <span class="req">*</span></label>
        <select class="form-input" id="acc-person">${personOpts}</select>
      </div>
      <div class="form-group" style="flex:1">
        <label class="form-label">Datum ongeval <span class="req">*</span></label>
        <input type="date" class="form-input" id="acc-date" value="${acc?acc.date:new Date().toISOString().split('T')[0]}"/>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group" style="flex:1">
        <label class="form-label">Locatie</label>
        <select class="form-input" id="acc-locatie">
          <option value="werkplek" ${!acc||acc.locatie==='werkplek'?'selected':''}>ğŸ­ Op de werkplek</option>
          <option value="woon-werk" ${acc&&acc.locatie==='woon-werk'?'selected':''}>ğŸš— Woon-werkverkeer</option>
        </select>
      </div>
      <div class="form-group" style="flex:1">
        <label class="form-label">Ernst</label>
        <select class="form-input" id="acc-ernst" onchange="updateForfait()">
          <option value="geen" ${acc&&acc.ernst==='geen'?'selected':''}>Geen verzuim</option>
          <option value="tijdelijk" ${!acc||acc.ernst==='tijdelijk'?'selected':''}>Tijdelijk letsel</option>
          <option value="blijvend" ${acc&&acc.ernst==='blijvend'?'selected':''}>Blijvende ongeschiktheid</option>
          <option value="dodelijk" ${acc&&acc.ernst==='dodelijk'?'selected':''}>Dodelijk</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group" style="flex:1">
        <label class="form-label">Verloren kalenderdagen</label>
        <input type="number" class="form-input" id="acc-lost-days" min="0" value="${acc?acc.verlorenDagen||0:0}" placeholder="0"/>
        <div style="font-size:10px;color:var(--text3);margin-top:2px">Kalenderdagen van dag na ongeval tot werkhervatting</div>
      </div>
      <div class="form-group" style="flex:1">
        <label class="form-label">Forfait dagen</label>
        <input type="number" class="form-input" id="acc-forfait" min="0" value="${acc?acc.forfaitDagen||0:0}" placeholder="0"/>
        <div style="font-size:10px;color:var(--text3);margin-top:2px">7.500d bij dodelijk of 100% blijvend</div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group" style="flex:1">
        <label class="form-label">Datum werkhervatting</label>
        <input type="date" class="form-input" id="acc-return-date" value="${acc?acc.returnDate||'':''}"/>
      </div>
      <div class="form-group" style="flex:1">
        <label class="form-label">% Blijvende ongeschiktheid</label>
        <input type="number" class="form-input" id="acc-pct-invalid" min="0" max="100" step="1" value="${acc?acc.pctInvalid||0:0}" placeholder="0"/>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Omschrijving</label>
      <textarea class="form-input" id="acc-desc" rows="2" placeholder="Korte beschrijving van het ongeval...">${acc?acc.omschrijving||'':''}</textarea>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="saveAccident('${accId||''}')">Opslaan</button>
    </div>
  `);
}

function updateForfait(){
  const ernst=document.getElementById('acc-ernst').value;
  const forfaitEl=document.getElementById('acc-forfait');
  if(ernst==='dodelijk')forfaitEl.value=7500;
  else if(ernst==='blijvend'){
    const pct=parseInt(document.getElementById('acc-pct-invalid').value)||0;
    forfaitEl.value=pct===100?7500:Math.round(7500*pct/100);
  }else forfaitEl.value=0;
}

function saveAccident(accId){
  const personId=document.getElementById('acc-person').value;
  const date=document.getElementById('acc-date').value;
  if(!personId||!date){showToast('Medewerker en datum zijn verplicht','error');return;}
  const data={
    personId,date,
    locatie:document.getElementById('acc-locatie').value,
    ernst:document.getElementById('acc-ernst').value,
    verlorenDagen:parseInt(document.getElementById('acc-lost-days').value)||0,
    forfaitDagen:parseInt(document.getElementById('acc-forfait').value)||0,
    returnDate:document.getElementById('acc-return-date').value||'',
    pctInvalid:parseInt(document.getElementById('acc-pct-invalid').value)||0,
    omschrijving:document.getElementById('acc-desc').value.trim()
  };
  if(accId){
    const acc=accidents.find(a=>a.id===accId);
    if(acc)Object.assign(acc,data);
  }else{
    data.id='acc_'+uid();
    data.createdAt=new Date().toISOString();
    accidents.push(data);
  }
  // Log mutatie bij medewerker
  const p=people.find(x=>x.id===personId);
  if(p){
    if(!p.mutations)p.mutations=[];
    const locLabel=data.locatie==='werkplek'?'werkplek':'woon-werk';
    p.mutations.push({id:uid(),timestamp:new Date().toISOString(),user:settings.currentUser||'Admin',field:accId?'Arbeidsongeval gewijzigd':'Arbeidsongeval geregistreerd',oldValue:'',newValue:formatDate(data.date)+' â€” '+locLabel+', '+data.verlorenDagen+'d verloren'});
  }
  closeModal();autoSave();renderAccidentStats();
  showToast('Arbeidsongeval '+(accId?'bijgewerkt':'geregistreerd'));
}

async function deleteAccident(accId){
  if(!await confirmDialog('Arbeidsongeval verwijderen?'))return;
  accidents=accidents.filter(a=>a.id!==accId);
  autoSave();renderAccidentStats();
  showToast('Ongeval verwijderd');
}

// --- Export functies ---
function exportReportCSV(){
  const year=new Date().getFullYear();
  let csv='Medewerker;Department;Recht;Opgenomen;Gepland;Resterend;Afwezigheid;Ziektedagen\n';
  const today=new Date().toISOString().split('T')[0];
  people.forEach(p=>{
    const dept=departments.find(d=>d.id===p.departmentId);
    const total=getTotalAllowance(p);
    const used=getUsedDays(p.id);
    const planned=requests.filter(r=>r.personId===p.id&&r.status==='approved'&&r.startDate>today)
      .reduce((s,r)=>{const t=leaveTypes.find(x=>x.id===r.type);return s+((t&&t.tracked)?(r.halfDay?0.5:r.days||0):0);},0);
    const sick=requests.filter(r=>r.personId===p.id&&r.type==='ziekte'&&r.startDate.startsWith(year))
      .reduce((s,r)=>s+(r.halfDay?0.5:r.days||0),0);
    const absence=requests.filter(r=>r.personId===p.id&&r.status==='approved'&&r.startDate.startsWith(year))
      .reduce((s,r)=>{const t=leaveTypes.find(x=>x.id===r.type);return s+((t&&t.absenceTracked)?(r.halfDay?0.5:r.days||0):0);},0);
    csv+=`${fullName(p)};${dept?dept.name:''};${total};${used};${planned};${total-used-planned};${absence};${sick}\n`;
  });
  downloadFile('verlofoverzicht_'+year+'.csv',csv,'text/csv');
  showToast('CSV geÃ«xporteerd ğŸ“Š');
}

function downloadFile(filename,content,type){
  const blob=new Blob([content],{type:type+';charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

// â•â•â• SALARIS â•â•â•

function getBaremaRate(catId,date){
  // Get the applicable rate for a category at a given date
  const sorted=[...baremaData].sort((a,b)=>a.date.localeCompare(b.date));
  let rate=0;
  for(const p of sorted){
    if(p.date<=date)rate=p.rates[catId]||0;
  }
  return rate;
}

function getAncienniteitPct(startDate,atDate){
  if(!startDate||!atDate)return 0;
  const start=new Date(startDate);
  const at=new Date(atDate);
  let years=at.getFullYear()-start.getFullYear();
  if(at.getMonth()<start.getMonth()||(at.getMonth()===start.getMonth()&&at.getDate()<start.getDate()))years--;
  if(years<0)years=0;
  // Calculate from rules
  const rule1=ancienniteitData.find(a=>a.id==='anc1');
  const rule2=ancienniteitData.find(a=>a.id==='anc2');
  const rule3=ancienniteitData.find(a=>a.id==='anc3');
  const pct1=rule1?rule1.pct:1;
  const pctPerYear=rule2?rule2.pct:0.5;
  const maxPct=rule3?rule3.pct:13;
  if(years<1)return 0;
  if(years===1)return pct1;
  return Math.min(pct1+(years-1)*pctPerYear,maxPct);
}

function calcCurrentSalary(person){
  if(!person||!person.salaryHistory)return null;
  const today=new Date().toISOString().split('T')[0];
  const startMutation=person.salaryHistory.find(m=>m.type===SALARY_TYPE_START);
  if(!startMutation)return null;
  const startLoon=startMutation.amount;
  // Sum all non-start mutations up to today
  let totalMutations=0;
  person.salaryHistory.forEach(m=>{
    if(m.type!==SALARY_TYPE_START&&!m.deleted&&m.date<=today)totalMutations+=m.amount;
  });
  const currentRate=Math.round((startLoon+totalMutations)*100)/100;
  return {startLoon,totalMutations,currentRate};
}

function openSalaryModal(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;

  // Check if startsalaris exists, if not ask for it first
  if(!p.salaryHistory||!p.salaryHistory.find(m=>m.type===SALARY_TYPE_START)){
    openModal('ğŸ’¶ Startloon invullen',`
      <div style="max-width:400px">
        <div style="font-size:12px;color:var(--text2);margin-bottom:16px">Vul het startloon in voor <strong>${p.firstName} ${p.lastName}</strong>. Dit wordt het vaste referentiepunt voor de salaris-evolutie.</div>
        <div class="form-group">
          <label class="form-label">Startdatum</label>
          <input type="date" class="form-input" value="${p.startDate||''}" disabled style="background:var(--surface2);color:var(--text2)"/>
          <div style="font-size:10px;color:var(--text3);margin-top:4px">Overgenomen uit personeelsfiche</div>
        </div>
        <div class="form-group">
          <label class="form-label">Startloon (â‚¬/uur) <span class="req">*</span></label>
          <input type="number" step="0.01" min="0" class="form-input" id="start-salary-amount" placeholder="bv. 18.45" style="width:160px"/>
        </div>
        <div class="modal-actions">
          <button class="btn" onclick="closeModal();openPersonModal('${personId}')">Annuleren</button>
          <button class="btn btn-primary" onclick="saveStartSalary('${personId}')">Opslaan</button>
        </div>
      </div>
    `);
    return;
  }

  const cat=BAREMA_CATEGORIES.find(c=>c.id===p.baremaCategory);
  const catLabel=cat?`${cat.id} â€” ${cat.name}`:'Geen categorie';
  const today=new Date().toISOString().split('T')[0];
  const sal=calcCurrentSalary(p);
  const ancPct=getAncienniteitPct(p.startDate,today);
  // Calculate dienstjaren
  let dienstjaren=0;
  if(p.startDate){
    const start=new Date(p.startDate);const now=new Date(today);
    dienstjaren=now.getFullYear()-start.getFullYear();
    if(now.getMonth()<start.getMonth()||(now.getMonth()===start.getMonth()&&now.getDate()<start.getDate()))dienstjaren--;
    if(dienstjaren<0)dienstjaren=0;
  }

  // Build salary history timeline
  const history=p.salaryHistory||[];
  const sortedHistory=[...history].sort((a,b)=>b.date.localeCompare(a.date));

  // Non-system reason types for the add dropdown
  const addableTypes=salaryReasonTypes.filter(t=>t.id!=='start');

  openModal(`ğŸ’¶ Salaris â€” ${p.firstName} ${p.lastName}`,`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm" onclick="manageSalaryReasonTypes('${personId}')">âš™ï¸ Types beheren</button>
        <button class="btn btn-sm" onclick="openLoonberekening('${personId}')">ğŸ§® Loonberekening</button>
      </div>
      <button class="btn btn-sm" onclick="closeModal();openPersonModal('${personId}')">â† Fiche</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
      <div>
        <div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:12px">Huidig overzicht</div>
        <div class="card" style="padding:16px;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:12px;color:var(--text2)">Startloon</span>
            <span style="font-weight:600;font-size:13px">â‚¬ ${sal?sal.startLoon.toFixed(2):'â€”'} <span style="font-size:10px;color:var(--text3)">(${p.startDate?formatDate(p.startDate):'â€”'})</span></span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:12px;color:var(--text2)">Categorie</span>
            <span class="badge badge-purple" style="font-weight:700">${catLabel}</span>
          </div>
          ${sal&&sal.totalMutations!==0?`<div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:12px;color:var(--text2)">Mutaties</span>
            <span style="font-weight:600;font-size:12px;color:${sal.totalMutations>=0?'#0d9668':'var(--danger)'}">â‚¬ ${sal.totalMutations>0?'+':''}${sal.totalMutations.toFixed(2)}</span>
          </div>`:''}
          <div style="border-top:2px solid var(--border);padding-top:8px;margin-top:4px;display:flex;justify-content:space-between">
            <span style="font-weight:700;font-size:13px">Huidig uurloon</span>
            <span style="font-weight:700;font-size:16px;color:var(--accent)">â‚¬ ${sal?sal.currentRate.toFixed(2):'â€”'}</span>
          </div>
          ${sal&&sal.totalMutations!==0?`<div style="display:flex;justify-content:space-between;margin-top:6px">
            <span style="font-size:11px;color:var(--text3)">Groei t.o.v. startloon</span>
            <span style="font-size:11px;font-weight:600;color:${sal.totalMutations>=0?'#0d9668':'var(--danger)'}">â‚¬ ${sal.totalMutations>0?'+':''}${sal.totalMutations.toFixed(2)} (${sal.startLoon>0?(sal.totalMutations>0?'+':'')+(sal.totalMutations/sal.startLoon*100).toFixed(1):'0'}%)</span>
          </div>`:''}
        </div>
        <div style="font-size:11px;color:var(--text3)">
          Startdatum: ${p.startDate?formatDate(p.startDate):'â€”'} Â· ${dienstjaren} dienstjaar${dienstjaren!==1?'en':''}
        </div>
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3)">Salaris-historiek</div>
          <button class="btn btn-sm btn-primary-outline" onclick="addSalaryMutation('${personId}')">â• Mutatie</button>
        </div>
        <div style="max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius-sm)">
          <table class="tbl" style="font-size:12px">
            <thead><tr><th>Datum</th><th>Type</th><th style="text-align:right">Uurloon</th><th style="text-align:right">Verschil</th><th></th></tr></thead>
            <tbody>
              ${sortedHistory.length===0?'<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:16px">Nog geen mutaties</td></tr>'
              :(() => {
                // Calculate running totals in chronological order (exclude deleted)
                const chrono=[...history].sort((a,b)=>a.date.localeCompare(b.date));
                const runningMap={};let running=0;
                chrono.forEach(m=>{
                  if(m.deleted)return;
                  if(m.type===SALARY_TYPE_START)running=m.amount; else running=Math.round((running+m.amount)*100)/100;
                  runningMap[m.id]=running;
                });
                // Display newest first
                return sortedHistory.map(m=>{
                  const rt=salaryReasonTypes.find(t=>t.id===m.type);
                  const icon=rt?rt.icon:'ğŸ’°';
                  const typeName=rt?rt.name:m.type;
                  const isStart=m.type===SALARY_TYPE_START;
                  const isDel=!!m.deleted;
                  const rowStyle=isDel?'opacity:.45;text-decoration:line-through':'';
                  const delInfo=isDel?' <span style="text-decoration:none;font-size:9px;color:var(--danger);font-style:italic"> âœ• '+m.deleteReason+'</span>':'';
                  return '<tr style="'+rowStyle+'">'
                    +'<td>'+formatDate(m.date)+'</td>'
                    +'<td>'+icon+' '+typeName+(m.comment?' <span style="color:var(--text3);font-size:10px">â€” '+m.comment+'</span>':'')+delInfo+'</td>'
                    +'<td style="text-align:right;font-weight:700">'+(isDel?'â€”':'â‚¬ '+(runningMap[m.id]||0).toFixed(2))+'</td>'
                    +'<td style="text-align:right;font-weight:600;color:'+(isStart?'var(--text3)':m.amount>=0?'#0d9668':'var(--danger)')+'">'+
                      (isStart?'â€”':'â‚¬ '+(m.amount>=0?'+':'')+m.amount.toFixed(2))+'</td>'
                    +'<td style="width:30px">'+(isDel?'<span style="text-decoration:none;font-size:10px" title="Geannuleerd">âœ•</span>'
                      :m.locked?'<span title="Verwerkt â€” kan niet verwijderd worden" style="font-size:10px">ğŸ”’</span>'
                      :'<button class="btn-icon" style="width:24px;height:24px;font-size:11px;border:none;background:none;cursor:pointer;color:var(--danger)" onclick="deleteSalaryMutation(\''+personId+'\',\''+m.id+'\')" title="Annuleren" aria-label="Annuleren">ğŸ—‘</button>')+'</td>'
                    +'</tr>';
                }).join('');
              })()}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `);
}

function saveStartSalary(personId){
  const amount=parseFloat(document.getElementById('start-salary-amount').value);
  if(isNaN(amount)||amount<=0){showToast('Vul een geldig startloon in','error');return;}
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  if(!p.salaryHistory)p.salaryHistory=[];
  p.salaryHistory.push({id:uid(),date:p.startDate||new Date().toISOString().split('T')[0],type:'start',amount,comment:'Startloon',locked:true});
  autoSave();
  closeModal();openSalaryModal(personId);
  showToast('Startloon opgeslagen');
}

function addSalaryMutation(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  const sal=calcCurrentSalary(p);
  const currentRate=sal?sal.currentRate:0;
  const addableTypes=salaryReasonTypes.filter(t=>t.id!=='start');
  openModal('â• Salarismutatie toevoegen',`
    <div style="max-width:400px">
      <div class="form-group">
        <label class="form-label">Huidig uurloon</label>
        <div style="font-weight:700;font-size:16px;color:var(--accent);padding:4px 0">â‚¬ ${currentRate.toFixed(2)}</div>
      </div>
      <div class="form-group"><label class="form-label">Datum <span class="req">*</span></label>
        <input type="date" class="form-input" id="sm-date" value="${new Date().toISOString().split('T')[0]}"/>
      </div>
      <div class="form-group"><label class="form-label">Type <span class="req">*</span></label>
        <select class="form-input" id="sm-type">
          ${addableTypes.map(t=>`<option value="${t.id}">${t.icon} ${t.name}</option>`).join('')}
        </select>
      </div>
      <div class="form-group"><label class="form-label">Nieuw uurtarief (â‚¬/uur) <span class="req">*</span></label>
        <input type="number" step="0.01" min="0" class="form-input" id="sm-newrate" placeholder="bv. 19.50" style="width:160px" value="" oninput="updateMutationDiff(${currentRate})"/>
        <div id="sm-diff" style="font-size:11px;margin-top:4px;color:var(--text3)"></div>
      </div>
      <div class="form-group"><label class="form-label">Omschrijving <span class="req">*</span></label>
        <input type="text" class="form-input" id="sm-comment" placeholder="Reden voor loonwijziging"/>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal();openSalaryModal('${personId}')">Annuleren</button>
        <button class="btn btn-primary" onclick="confirmSalaryMutation('${personId}',${currentRate})">Toevoegen</button>
      </div>
    </div>
  `);
}

function updateMutationDiff(currentRate){
  const newRate=parseFloat(document.getElementById('sm-newrate').value);
  const el=document.getElementById('sm-diff');
  if(isNaN(newRate)||!el)return;
  const diff=Math.round((newRate-currentRate)*100)/100;
  el.innerHTML=diff>=0
    ?'<span style="color:#0d9668;font-weight:600">+â‚¬ '+diff.toFixed(2)+' verhoging</span>'
    :'<span style="color:var(--danger);font-weight:600">â‚¬ '+diff.toFixed(2)+' verlaging</span>';
}

function confirmSalaryMutation(personId,currentRate){
  const date=document.getElementById('sm-date').value;
  const type=document.getElementById('sm-type').value;
  const newRate=parseFloat(document.getElementById('sm-newrate').value);
  const comment=document.getElementById('sm-comment').value.trim();
  if(!date){showToast('Datum is verplicht','error');return;}
  if(!type){showToast('Type is verplicht','error');return;}
  if(!comment){showToast('Omschrijving is verplicht','error');return;}
  if(isNaN(newRate)||newRate<=0){showToast('Vul een geldig uurtarief in','error');return;}
  const amount=Math.round((newRate-currentRate)*100)/100;
  if(amount===0){showToast('Nieuw tarief is gelijk aan huidig tarief','error');return;}
  if(newRate<0){showToast('Uurloon kan niet negatief zijn','error');return;}
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  if(!p.salaryHistory)p.salaryHistory=[];
  p.salaryHistory.push({id:uid(),date,type,amount,comment,locked:false});
  autoSave();
  closeModal();openSalaryModal(personId);
  showToast('Salarismutatie toegevoegd');
}

async function deleteSalaryMutation(personId,mutationId){
  const p=people.find(x=>x.id===personId);
  if(!p||!p.salaryHistory)return;
  const m=p.salaryHistory.find(x=>x.id===mutationId);
  if(!m)return;
  // Ask for reason via custom dialog
  closeModal();
  openModal('ğŸ—‘ Mutatie annuleren','<div style="max-width:400px">'
    +'<div style="font-size:12px;color:var(--text2);margin-bottom:12px">Je staat op het punt een loonmutatie te annuleren. De mutatie blijft zichtbaar in de historiek als doorgestreept item.</div>'
    +'<div class="form-group"><label class="form-label">Reden voor annulering <span class="req">*</span></label>'
    +'<input type="text" class="form-input" id="sd-reason" placeholder="Waarom wordt deze mutatie geannuleerd?"/></div>'
    +'<div class="modal-actions">'
    +'<button class="btn" onclick="closeModal();openSalaryModal(\''+personId+'\')">Annuleren</button>'
    +'<button class="btn btn-primary" style="background:var(--danger);border-color:var(--danger)" onclick="confirmSoftDelete(\''+personId+'\',\''+mutationId+'\')">Annuleer mutatie</button>'
    +'</div></div>');
}

function confirmSoftDelete(personId,mutationId){
  const reason=document.getElementById('sd-reason').value.trim();
  if(!reason){showToast('Reden is verplicht','error');return;}
  const p=people.find(x=>x.id===personId);
  if(!p||!p.salaryHistory)return;
  const m=p.salaryHistory.find(x=>x.id===mutationId);
  if(!m)return;
  m.deleted=true;
  m.deletedDate=new Date().toISOString().split('T')[0];
  m.deleteReason=reason;
  autoSave();
  closeModal();openSalaryModal(personId);
  showToast('Mutatie geannuleerd');
}

function manageSalaryReasonTypes(personId){
  const custom=salaryReasonTypes.filter(t=>!t.system);
  openModal('âš™ï¸ Mutatie-types beheren',`
    <div style="max-width:400px">
      <div style="font-size:12px;color:var(--text2);margin-bottom:12px">Systeem-types (niet verwijderbaar): ${salaryReasonTypes.filter(t=>t.system).map(t=>t.icon+' '+t.name).join(', ')}</div>
      <table class="tbl" style="font-size:12px">
        <thead><tr><th>Icon</th><th>Naam</th><th></th></tr></thead>
        <tbody>
          ${custom.map(t=>`<tr>
            <td>${t.icon}</td>
            <td>${t.name}</td>
            <td style="width:30px"><button class="btn-icon" style="width:24px;height:24px;font-size:11px;border:none;background:none;cursor:pointer;color:var(--danger)" onclick="deleteSalaryReasonType('${t.id}','${personId}')" title="Verwijderen" aria-label="Verwijderen">ğŸ—‘</button></td>
          </tr>`).join('')}
          ${custom.length===0?'<tr><td colspan="3" style="text-align:center;color:var(--text3);padding:12px">Geen aangepaste types</td></tr>':''}
        </tbody>
      </table>
      <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
        <div style="font-weight:600;font-size:12px;margin-bottom:8px">Nieuw type toevoegen</div>
        <div class="form-row">
          <div class="form-group" style="flex:0 0 60px"><label class="form-label">Icon</label><input class="form-input" id="srt-icon" value="ğŸ’°" style="text-align:center"/></div>
          <div class="form-group"><label class="form-label">Naam</label><input class="form-input" id="srt-name" placeholder="bv. Certificaat"/></div>
        </div>
        <button class="btn btn-sm btn-primary-outline" onclick="addSalaryReasonType('${personId}')" style="width:100%">â• Toevoegen</button>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal();openSalaryModal('${personId}')">â† Terug</button>
      </div>
    </div>
  `);
}

function addSalaryReasonType(personId){
  const icon=document.getElementById('srt-icon').value.trim()||'ğŸ’°';
  const name=document.getElementById('srt-name').value.trim();
  if(!name){showToast('Naam is verplicht','error');return;}
  const id=name.toLowerCase().replace(/[^a-z0-9]/g,'-');
  if(salaryReasonTypes.find(t=>t.id===id)){showToast('Type bestaat al','error');return;}
  salaryReasonTypes.push({id,name,icon,system:false});
  autoSave();
  closeModal();manageSalaryReasonTypes(personId);
  showToast('Type toegevoegd');
}

async function deleteSalaryReasonType(typeId,personId){
  // Check if in use
  const inUse=people.some(p=>p.salaryHistory&&p.salaryHistory.some(m=>m.type===typeId));
  if(inUse){showToast('Type is in gebruik en kan niet verwijderd worden','error');return;}
  if(!await confirmDialog('Mutatie-type verwijderen?'))return;
  salaryReasonTypes=salaryReasonTypes.filter(t=>t.id!==typeId);
  autoSave();
  closeModal();manageSalaryReasonTypes(personId);
  showToast('Type verwijderd');
}

function openLoonberekening(personId){
  const p=people.find(x=>x.id===personId);
  if(!p)return;
  const sal=calcCurrentSalary(p);
  const currentRate=sal?sal.currentRate:0;
  const cat=BAREMA_CATEGORIES.find(c=>c.id===p.baremaCategory);
  const catLabel=cat?cat.id+' \u2014 '+cat.name:'\u2014';
  const today=new Date().toISOString().split('T')[0];

  // Detect loonsimulatie: geen startdatum of < 4 maanden geleden
  let isSimulatie=false;
  if(!p.startDate){
    isSimulatie=true;
  } else {
    const start=new Date(p.startDate);
    const maanden=(new Date().getFullYear()-start.getFullYear())*12+(new Date().getMonth()-start.getMonth());
    if(maanden<4)isSimulatie=true;
  }

  // Get latest indexed barema rate
  const sortedBarema=[...baremaData].sort((a,b)=>b.date.localeCompare(a.date));
  const latestIndexed=sortedBarema.find(b=>b.indexed);
  const latestBarema=sortedBarema[0];
  const useBarema=latestIndexed||latestBarema;
  const baremaRate=useBarema&&p.baremaCategory?useBarema.rates[p.baremaCategory]||0:0;
  const baremaDate=useBarema?useBarema.date:'';
  const baremaIndexPct=useBarema&&useBarema.indexed?useBarema.indexPct:0;

  // AnciÃ«nniteit (0 bij simulatie)
  let dienstjaren=0;
  if(!isSimulatie&&p.startDate){
    const start=new Date(p.startDate);const now=new Date(today);
    dienstjaren=now.getFullYear()-start.getFullYear();
    if(now.getMonth()<start.getMonth()||(now.getMonth()===start.getMonth()&&now.getDate()<start.getDate()))dienstjaren--;
    if(dienstjaren<0)dienstjaren=0;
  }
  const ancPct=isSimulatie?0:getAncienniteitPct(p.startDate,today);
  const ancAmount=Math.round(baremaRate*ancPct)/100;
  const berekendMin=Math.round((baremaRate+ancAmount)*100)/100;
  const useRate=isSimulatie?baremaRate:currentRate;
  const verschil=Math.round((useRate-berekendMin)*100)/100;
  const isAbove=verschil>=0;
  const totalWgPct=werkgeverskostData.reduce((s,c)=>s+c.pct,0);
  const effectieveDagen=uurkostParams.werkdagenJaar-uurkostParams.verlofDagen-uurkostParams.feestdagen-uurkostParams.advDagen;
  const effectieveUren=effectieveDagen*uurkostParams.urenPerDag;

  // Uren/week uit werkrooster
  const schedule=schedules.find(s=>s.id===p.scheduleId);
  const urenPerWeek=schedule?(schedule.daysPerWeek*schedule.hoursPerDay):40;
  const wekenPerMaand=4.33;
  const scheduleLabel=schedule?schedule.name:'Voltijds (5/5)';

  const simBanner=isSimulatie?'<div style="background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.25);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:8px">'
    +'<span style="font-size:16px">\uD83D\uDD2E</span><div>'
    +'<div style="font-weight:700;font-size:12px;color:#3b82f6">Loonsimulatie</div>'
    +'<div style="font-size:10px;color:var(--text3)">'+(!p.startDate?'Geen startdatum ingevuld':'Minder dan 4 maanden in dienst')+' \u2014 berekening op basis van barema zonder anci\u00EBnniteit</div>'
    +'</div></div>':'';

  const vergelijkHtml=isSimulatie
    ?'<div style="display:flex;justify-content:space-between;margin-bottom:10px"><span style="font-size:12px;color:var(--text2)">Barema uurloon</span><span style="font-weight:700;font-size:16px;color:var(--accent)">\u20AC '+useRate.toFixed(2)+'</span></div>'
    :'<div style="display:flex;justify-content:space-between;margin-bottom:10px"><span style="font-size:12px;color:var(--text2)">Huidig uurloon</span><span style="font-weight:700;font-size:16px;color:var(--accent)">\u20AC '+currentRate.toFixed(2)+'</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:10px"><span style="font-size:12px;color:var(--text2)">Berekend minimum</span><span style="font-weight:700;font-size:16px">\u20AC '+berekendMin.toFixed(2)+'</span></div>'
    +'<div style="border-top:2px solid var(--border);padding-top:8px;display:flex;justify-content:space-between"><span style="font-weight:700;font-size:13px">Verschil</span><span style="font-weight:700;font-size:16px;color:'+(isAbove?'#0d9668':'var(--danger)')+'">\u20AC '+(verschil>0?'+':'')+verschil.toFixed(2)+'</span></div>';

  const formuleAncHtml=isSimulatie
    ?'<span style="font-size:10px;font-style:italic">Geen anci\u00EBnniteit (simulatie)</span><br/>'
    :'\u00D7 (1 + '+ancPct.toFixed(2)+'% anci\u00EBnniteit)<br/><span style="font-size:10px">('+dienstjaren+' dienstjaar'+(dienstjaren!==1?'en':'')+' \u2192 +\u20AC '+ancAmount.toFixed(2)+')</span><br/>';

  const formuleResult=isSimulatie?baremaRate.toFixed(2)+' barema startloon':berekendMin.toFixed(2)+' sectoraal minimum';

  let wgRows='';
  werkgeverskostData.forEach(function(c){
    wgRows+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:4px 0;color:var(--text2)">'+c.name+'</td>'
      +'<td style="padding:4px 0;text-align:right;width:70px"><input type="number" step="0.01" value="'+c.pct+'" style="width:60px;text-align:right;border:1px solid var(--border);border-radius:4px;padding:2px 4px;font-size:11px" onchange="updateWgKost(\''+c.id+'\',this.value,\''+personId+'\')"/> %</td></tr>';
  });

  openModal((isSimulatie?'\uD83D\uDD2E Loonsimulatie':'\uD83E\uDDEE Loonberekening')+' \u2014 '+p.firstName+' '+p.lastName,
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">'
    +'<button class="btn btn-sm" onclick="closeModal();openSalaryModal(\''+personId+'\')">\u2190 Terug naar salaris</button>'
    +'<button class="btn btn-sm btn-primary-outline" onclick="openLoonSimulatieVergelijk(\''+personId+'\')">\uD83D\uDCCA Loonsimulatie vergelijken</button>'
    +'</div>'
    +simBanner
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:24px"><div>'
    +'<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:12px">Vergelijking</div>'
    +'<div class="card" style="padding:16px;margin-bottom:12px">'+vergelijkHtml+'</div>'
    +'<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;font-size:11px;color:var(--text3);line-height:1.6;margin-bottom:12px">'
    +'<div style="font-weight:600;color:var(--text2);margin-bottom:4px">\uD83D\uDCD0 Formule '+(isSimulatie?'loonsimulatie':'berekend minimum')+':</div>'
    +'Barema '+catLabel+'<br/>\u20AC '+baremaRate.toFixed(2)+' <span style="font-size:10px">('+( baremaDate?formatDate(baremaDate):'\u2014')+(baremaIndexPct?' \u00B7 +'+baremaIndexPct+'% ge\u00EFndexeerd':'')+')</span><br/>'
    +formuleAncHtml
    +'<div style="border-top:1px dashed var(--border);margin-top:6px;padding-top:6px;font-weight:600;color:var(--text)">= \u20AC '+formuleResult+'</div></div>'
    +'<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px;margin-top:16px">Werkgeverskost componenten</div>'
    +'<div class="card" style="padding:12px"><table style="width:100%;font-size:11px;border-collapse:collapse">'
    +wgRows
    +'<tr style="font-weight:700"><td style="padding:6px 0">Totaal werkgeversbijdrage</td><td style="padding:6px 0;text-align:right" id="lb-wg-total">'+totalWgPct.toFixed(2)+' %</td></tr>'
    +'</table></div></div>'
    +'<div>'
    +'<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:12px">Bruto loonberekening</div>'
    +'<div class="card" style="padding:16px;margin-bottom:12px">'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text2)">Categorie</span><span class="badge badge-purple" style="font-weight:700">'+catLabel+'</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-size:12px;color:var(--text2)">Werkrooster</span><span style="font-size:12px;font-weight:600">'+scheduleLabel+' \u00B7 '+urenPerWeek+'u/week</span></div>'
    +'<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text2)">Bruto per week</span><span style="font-weight:600" id="lb-week">\u20AC 0.00</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text2)">Bruto per maand</span><span style="font-weight:700;font-size:14px;color:var(--accent)" id="lb-maand">\u20AC 0.00</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text2)">Werkelijke kost/uur</span><span style="font-weight:700;font-size:14px;color:var(--danger)" id="lb-uurkost-inline">\u20AC 0.00</span></div>'
    +'<div style="display:flex;justify-content:space-between"><span style="font-size:12px;color:var(--text2)">Bruto per jaar</span><span style="font-weight:600" id="lb-jaar">\u20AC 0.00</span></div></div></div>'
    +'<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">Werkelijke kost werkgever</div>'
    +'<div class="card" style="padding:16px">'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text2)">Bruto jaarloon</span><span style="font-weight:600" id="lb-bruto-jaar2">\u20AC 0.00</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text2)">Werkgeversbijdrage (<span id="lb-wg-pct2">'+totalWgPct.toFixed(1)+'</span>%)</span><span style="font-weight:600;color:var(--danger)" id="lb-wg-bedrag">\u20AC 0.00</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px;border-top:2px solid var(--border);padding-top:6px"><span style="font-weight:700;font-size:13px">Totale jaarkost</span><span style="font-weight:700;font-size:15px;color:var(--danger)" id="lb-totaal-jaar">\u20AC 0.00</span></div>'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:6px;border-top:2px solid var(--border);padding-top:6px"><span style="font-weight:700;font-size:13px">Werkelijke uurkost</span><span style="font-weight:700;font-size:16px;color:var(--danger)" id="lb-uurkost">\u20AC 0.00</span></div></div>'
    +'<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;font-size:10px;color:var(--text3);line-height:1.5;margin-top:8px">'
    +'<div style="font-weight:600;color:var(--text2);margin-bottom:2px">\uD83D\uDCD0 Formule uurkost:</div>'
    +uurkostParams.werkdagenJaar+'d - '+uurkostParams.verlofDagen+' verlof - '+uurkostParams.feestdagen+' feest - '+uurkostParams.advDagen+' ADV = <strong>'+effectieveDagen+' werkdagen</strong><br/>'
    +effectieveDagen+'d \u00D7 '+uurkostParams.urenPerDag+'u = <strong>'+effectieveUren+' effectieve uren/jaar</strong><br/>'
    +'Uurkost = Totale jaarkost / '+effectieveUren+' uur</div></div></div>'
    +'<input type="hidden" id="lb-uren" value="'+urenPerWeek+'"/>'
    +'<input type="hidden" id="lb-weken" value="'+wekenPerMaand+'"/>'
  );
  setTimeout(function(){calcLoon(useRate)},50);
}

function updateWgKost(id,value,personId){
  const c=werkgeverskostData.find(x=>x.id===id);
  if(c)c.pct=parseFloat(value)||0;
  autoSave();
  const total=werkgeverskostData.reduce((s,c)=>s+c.pct,0);
  const el=document.getElementById('lb-wg-total');if(el)el.textContent=total.toFixed(2)+' %';
  const el2=document.getElementById('lb-wg-pct2');if(el2)el2.textContent=total.toFixed(1);
  // Recalc
  const p=people.find(x=>x.id===personId);
  if(p){const sal=calcCurrentSalary(p);if(sal)calcLoon(sal.currentRate);}
}

function calcLoon(uurloon){
  const uren=parseFloat(document.getElementById('lb-uren').value)||0;
  const weken=parseFloat(document.getElementById('lb-weken').value)||0;
  const week=Math.round(uurloon*uren*100)/100;
  const maand=Math.round(week*weken*100)/100;
  const jaar=Math.round(maand*12*100)/100;
  document.getElementById('lb-week').textContent='â‚¬ '+week.toFixed(2);
  document.getElementById('lb-maand').textContent='â‚¬ '+maand.toFixed(2);
  document.getElementById('lb-jaar').textContent='â‚¬ '+jaar.toFixed(2);

  // Werkgeverskost
  const totalWgPct=werkgeverskostData.reduce((s,c)=>s+c.pct,0);
  const wgBedrag=Math.round(jaar*totalWgPct)/100;
  const totaalJaar=Math.round((jaar+wgBedrag)*100)/100;
  const effectieveDagen=uurkostParams.werkdagenJaar-uurkostParams.verlofDagen-uurkostParams.feestdagen-uurkostParams.advDagen;
  const effectieveUren=effectieveDagen*uurkostParams.urenPerDag;
  const uurkost=effectieveUren>0?Math.round(totaalJaar/effectieveUren*100)/100:0;

  const el1=document.getElementById('lb-bruto-jaar2');if(el1)el1.textContent='â‚¬ '+jaar.toFixed(2);
  const el2=document.getElementById('lb-wg-bedrag');if(el2)el2.textContent='â‚¬ '+wgBedrag.toFixed(2);
  const el3=document.getElementById('lb-totaal-jaar');if(el3)el3.textContent='â‚¬ '+totaalJaar.toFixed(2);
  const el4=document.getElementById('lb-uurkost');if(el4)el4.textContent='â‚¬ '+uurkost.toFixed(2);
  const el5=document.getElementById('lb-uurkost-inline');if(el5)el5.textContent='â‚¬ '+uurkost.toFixed(2);
}

function openLoonSimulatieVergelijk(personId){
  var p=people.find(function(x){return x.id===personId});
  if(!p)return;
  var sal=calcCurrentSalary(p);
  var currentRate=sal?sal.currentRate:0;
  var cat=BAREMA_CATEGORIES.find(function(c){return c.id===p.baremaCategory});
  var catLabel=cat?cat.id+' \u2014 '+cat.name:'\u2014';
  var today=new Date().toISOString().split('T')[0];

  // Barema + anciÃ«nniteit = berekend minimum
  if(!baremaData||baremaData.length===0){showToast('Geen barema-data beschikbaar','warn');return;}
  var sortedBarema=baremaData.slice().sort(function(a,b){return b.date.localeCompare(a.date)});
  var latestIndexed=sortedBarema.find(function(b){return b.indexed});
  var useBarema=latestIndexed||sortedBarema[0];
  var baremaRate=useBarema&&p.baremaCategory?useBarema.rates[p.baremaCategory]||0:0;
  if(!p.baremaCategory){showToast('Categorie niet ingevuld voor deze medewerker','warn');}
  var ancPct=getAncienniteitPct(p.startDate,today);
  var ancAmount=Math.round(baremaRate*ancPct)/100;
  var berekendMin=Math.round((baremaRate+ancAmount)*100)/100;

  // Schedule
  var schedule=schedules.find(function(s){return s.id===p.scheduleId});
  var urenPerWeek=schedule?(schedule.daysPerWeek*schedule.hoursPerDay):40;
  var wekenPerMaand=4.33;
  var totalWgPct=werkgeverskostData.reduce(function(s,c){return s+c.pct},0);
  var effectieveDagen=uurkostParams.werkdagenJaar-uurkostParams.verlofDagen-uurkostParams.feestdagen-uurkostParams.advDagen;
  var effectieveUren=effectieveDagen*uurkostParams.urenPerDag;

  function calcCol(uurloon){
    var week=Math.round(uurloon*urenPerWeek*100)/100;
    var maand=Math.round(week*wekenPerMaand*100)/100;
    var jaar=Math.round(maand*12*100)/100;
    var wgBedrag=Math.round(jaar*totalWgPct)/100;
    var totaalJaar=Math.round((jaar+wgBedrag)*100)/100;
    var uurkost=effectieveUren>0?Math.round(totaalJaar/effectieveUren*100)/100:0;
    return {week:week,maand:maand,jaar:jaar,wgBedrag:wgBedrag,totaalJaar:totaalJaar,uurkost:uurkost};
  }

  var c1=calcCol(currentRate);
  var c2=calcCol(berekendMin);

  function colHtml(label,color,uurloon,c,id){
    return '<div style="flex:1;min-width:180px;display:flex;flex-direction:column">'
      +'<div style="text-align:center;height:80px;display:flex;flex-direction:column;justify-content:center;align-items:center">'
      +'<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3)">'+label+'</div>'
      +'<div style="font-weight:700;font-size:20px;color:'+color+';margin-top:4px"'+(id?' id="sim-uurloon-'+id+'"':'')+'>'+'\u20AC '+uurloon.toFixed(2)+'</div>'
      +(id?'<input type="number" step="0.01" min="0" value="'+uurloon.toFixed(2)+'" style="width:100px;text-align:center;border:1px solid var(--border);border-radius:4px;padding:3px;font-size:12px;margin-top:4px" id="sim-input-'+id+'" oninput="updateSimCol(\''+id+'\',\''+personId+'\')"/>':'')
      +'</div>'
      +'<div class="card" style="padding:12px;font-size:11px;flex:1">'
      +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text3)">Bruto/week</span><span style="font-weight:600"'+(id?' id="sim-week-'+id+'"':'')+'>\u20AC '+c.week.toFixed(2)+'</span></div>'
      +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text3)">Bruto/maand</span><span style="font-weight:700;color:'+color+'"'+(id?' id="sim-maand-'+id+'"':'')+'>\u20AC '+c.maand.toFixed(2)+'</span></div>'
      +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text3)">Bruto/jaar</span><span style="font-weight:600"'+(id?' id="sim-jaar-'+id+'"':'')+'>\u20AC '+c.jaar.toFixed(2)+'</span></div>'
      +'<div style="border-top:1px solid var(--border);margin:6px 0;padding-top:6px">'
      +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text3)">WG-bijdrage</span><span style="font-weight:600;color:var(--text2)"'+(id?' id="sim-wg-'+id+'"':'')+'>\u20AC '+c.wgBedrag.toFixed(2)+'</span></div>'
      +'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text3)">Totale jaarkost</span><span style="font-weight:700;color:var(--danger)"'+(id?' id="sim-totaal-'+id+'"':'')+'>\u20AC '+c.totaalJaar.toFixed(2)+'</span></div>'
      +'<div style="display:flex;justify-content:space-between"><span style="font-weight:700;color:var(--text)">Uurkost</span><span style="font-weight:700;font-size:13px;color:var(--danger)"'+(id?' id="sim-uurkost-'+id+'"':'')+'>\u20AC '+c.uurkost.toFixed(2)+'</span></div>'
      +'</div></div></div>';
  }

  // Store calc params globally for live update
  window._simParams={urenPerWeek:urenPerWeek,wekenPerMaand:wekenPerMaand,totalWgPct:totalWgPct,effectieveUren:effectieveUren};

  openModal('\uD83D\uDCCA Loonsimulatie vergelijken \u2014 '+p.firstName+' '+p.lastName,
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">'
    +'<button class="btn btn-sm" onclick="closeModal();openLoonberekening(\''+personId+'\')">\u2190 Terug naar loonberekening</button>'
    +'</div>'
    +'<div style="font-size:11px;color:var(--text3);margin-bottom:12px">'+catLabel+' \u00B7 '+urenPerWeek+'u/week \u00B7 WG-bijdrage '+totalWgPct.toFixed(1)+'% \u00B7 '+effectieveUren+' effectieve uren/jaar</div>'
    +'<div style="display:flex;gap:16px;align-items:stretch">'
    +colHtml('Huidig loon','var(--accent)',currentRate,c1,null)
    +colHtml('Berekend minimum','var(--text)',berekendMin,c2,null)
    +colHtml('Aangepast loon','#8b5cf6',currentRate,c1,'custom')
    +'</div>'
  );
}

function updateSimCol(id,personId){
  var input=document.getElementById('sim-input-'+id);
  if(!input)return;
  var uurloon=parseFloat(input.value)||0;
  var sp=window._simParams;
  var week=Math.round(uurloon*sp.urenPerWeek*100)/100;
  var maand=Math.round(week*sp.wekenPerMaand*100)/100;
  var jaar=Math.round(maand*12*100)/100;
  var wgBedrag=Math.round(jaar*sp.totalWgPct)/100;
  var totaalJaar=Math.round((jaar+wgBedrag)*100)/100;
  var uurkost=sp.effectieveUren>0?Math.round(totaalJaar/sp.effectieveUren*100)/100:0;

  var el=document.getElementById('sim-uurloon-'+id);if(el)el.textContent='\u20AC '+uurloon.toFixed(2);
  el=document.getElementById('sim-week-'+id);if(el)el.textContent='\u20AC '+week.toFixed(2);
  el=document.getElementById('sim-maand-'+id);if(el)el.textContent='\u20AC '+maand.toFixed(2);
  el=document.getElementById('sim-jaar-'+id);if(el)el.textContent='\u20AC '+jaar.toFixed(2);
  el=document.getElementById('sim-wg-'+id);if(el)el.textContent='\u20AC '+wgBedrag.toFixed(2);
  el=document.getElementById('sim-totaal-'+id);if(el)el.textContent='\u20AC '+totaalJaar.toFixed(2);
  el=document.getElementById('sim-uurkost-'+id);if(el)el.textContent='\u20AC '+uurkost.toFixed(2);
}


// â•â•â• BAREMA â•â•â•

function renderBarema(){
  const thead=document.getElementById('barema-thead');
  const tbody=document.getElementById('barema-tbody');
  if(!thead||!tbody)return;

  // Sort periods by date
  const sorted=[...baremaData].sort((a,b)=>a.date.localeCompare(b.date));

  // Check which indexed periods are fully applied
  const eligible=people.filter(function(p){
    return !p.archived&&p.paritairComite==='149.01'&&p.salaryHistory&&p.salaryHistory.find(function(m){return m.type===SALARY_TYPE_START;});
  });

  sorted.forEach(function(p){
    if(!p.indexed){p._applied=true;return;}
    var notApplied=eligible.filter(function(pe){
      return !pe.salaryHistory.some(function(m){return m.type==='index'&&m.date===p.date&&!m.deleted;});
    });
    p._applied=notApplied.length===0;
    p._remaining=notApplied.length;
  });

  // Header
  thead.innerHTML=`<tr>
    <th style="width:60px">Cat.</th>
    <th>Omschrijving</th>
    ${sorted.map(p=>{
      const isIdx=p.indexed;
      const notApplied=isIdx&&!p._applied;
      return `<th style="text-align:center;min-width:110px;${notApplied?'background:rgba(34,197,94,.10);':''}">
        ${notApplied?'<div style="margin-bottom:4px"><span style="display:inline-block;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;font-size:9px;font-weight:800;letter-spacing:1px;padding:2px 8px;border-radius:10px;text-transform:uppercase;box-shadow:0 1px 3px rgba(34,197,94,.4)">NEW</span></div>':''}
        <div style="font-weight:700;${notApplied?'color:#16a34a;':''}">${formatDate(p.date)}</div>
        <div style="font-size:10px;color:var(--text3);font-weight:400">â‚¬/uur Â· 40u${isIdx?' Â· <span style="color:#0d9668;font-weight:600">+'+p.indexPct+'%</span>':''}</div>
        ${notApplied?'<div style="font-size:9px;color:#16a34a;margin-top:2px">'+p._remaining+' medewerker'+(p._remaining>1?'s':'')+' nog toe te passen</div>':''}
      </th>`;
    }).join('')}
  </tr>`;

  // Body: one row per category
  tbody.innerHTML=BAREMA_CATEGORIES.map(cat=>{
    return `<tr>
      <td><span class="badge badge-purple" style="min-width:28px;text-align:center;font-weight:700">${cat.id}</span></td>
      <td><div style="font-weight:600;font-size:12px">${cat.name}</div><div style="font-size:10px;color:var(--text3)">${cat.desc}</div></td>
      ${sorted.map(p=>{
        const rate=p.rates[cat.id]||'';
        const notApplied=p.indexed&&!p._applied;
        return `<td style="text-align:center;${notApplied?'background:rgba(34,197,94,.06);':''}">
          <input type="number" step="0.01" min="0" value="${rate}" 
            style="width:80px;text-align:center;border:1px solid ${notApplied?'#22c55e':'var(--border)'};border-radius:var(--radius-sm);padding:4px 6px;font-size:13px;font-weight:600;${notApplied?'color:#16a34a;':''}"
            onchange="updateBaremaRate('${p.id}','${cat.id}',this.value)"/>
        </td>`;
      }).join('')}
    </tr>`;
  }).join('')

  // Footer row with delete buttons
  + `<tr style="border-top:2px solid var(--border)">
    <td colspan="2" style="font-size:11px;color:var(--text3);padding-top:8px">Periodes verwijderen:</td>
    ${sorted.map(p=>{
      const isUsed=people.some(pe=>pe.salaryHistory&&pe.salaryHistory.some(s=>s.baremaId===p.id));
      return `<td style="text-align:center;padding-top:8px">
        ${isUsed?`<span style="font-size:10px;color:var(--text3)" title="In gebruik â€” kan niet verwijderd worden">ğŸ”’</span>`
        :`<button class="btn btn-sm" style="font-size:10px;color:var(--danger)" onclick="deleteBaremaPeriod('${p.id}')" title="Verwijderen" aria-label="Verwijderen">ğŸ—‘</button>`}
      </td>`;
    }).join('')}
  </tr>`;
}

function updateBaremaRate(periodId,catId,value){
  const p=baremaData.find(x=>x.id===periodId);
  if(!p)return;
  p.rates[catId]=parseFloat(value)||0;
  autoSave();
}

async function addBaremaPeriod(){
  // Open modal asking for date
  openModal('Nieuwe barema-periode','<div class="form-group"><label class="form-label">Ingangsdatum</label><input type="date" class="form-input" id="barema-new-date" value="'+new Date().toISOString().split('T')[0]+'"/></div><div style="font-size:12px;color:var(--text3);margin-top:8px">De kolom wordt toegevoegd met lege uurlonen die je zelf invult.</div><div class="modal-actions"><button class="btn" onclick="closeModal()">Annuleren</button><button class="btn btn-primary" onclick="confirmAddBaremaPeriod()">Toevoegen</button></div>');
}

function confirmAddBaremaPeriod(){
  const dateInput=document.getElementById('barema-new-date');
  if(!dateInput||!dateInput.value){showToast('Kies een datum','error');return;}
  const date=dateInput.value;
  // Check duplicate
  if(baremaData.some(b=>b.date===date)){showToast('Er bestaat al een periode met deze datum','error');return;}
  const rates={};
  BAREMA_CATEGORIES.forEach(c=>rates[c.id]=0);
  // Pre-fill with last known rates + 2.23% index
  const sorted=[...baremaData].sort((a,b)=>b.date.localeCompare(a.date));
  if(sorted.length>0){
    const last=sorted[0].rates;
    BAREMA_CATEGORIES.forEach(c=>{rates[c.id]=last[c.id]||0;});
  }
  baremaData.push({id:uid(),date:date,rates:rates});
  autoSave();closeModal();renderBarema();
  showToast('Barema-periode toegevoegd');
}

async function deleteBaremaPeriod(id){
  if(!await confirmDialog('Barema-periode verwijderen?'))return;
  baremaData=baremaData.filter(b=>b.id!==id);
  autoSave();renderBarema();
  showToast('Barema-periode verwijderd');
}

function addBaremaIndexation(){
  // Check of de laatste indexatie al is toegepast op medewerkers
  const sorted=[...baremaData].sort((a,b)=>b.date.localeCompare(a.date));
  const lastIndexed=sorted.find(b=>b.indexed);
  if(lastIndexed){
    const eligible=people.filter(function(p){
      return !p.archived&&p.paritairComite==='149.01'&&p.salaryHistory&&p.salaryHistory.find(function(m){return m.type===SALARY_TYPE_START;});
    });
    const notApplied=eligible.filter(function(p){
      return !p.salaryHistory.some(function(m){return m.type==='index'&&m.date===lastIndexed.date&&!m.deleted;});
    });
    if(notApplied.length>0){
      showToast('De indexatie van '+formatDate(lastIndexed.date)+' (+'+lastIndexed.indexPct+'%) is nog niet toegepast op '+notApplied.length+' medewerker'+(notApplied.length>1?'s':'')+'. Pas eerst de huidige indexatie toe via "Indexatie toepassen".','error');
      return;
    }
  }
  openModal('â• Nieuwe indexatie',`
    <div class="form-group">
      <label class="form-label">Gaat in vanaf</label>
      <input type="date" class="form-input" id="barema-idx-date" value="${new Date().toISOString().split('T')[0]}"/>
    </div>
    <div class="form-group">
      <label class="form-label">Indexatie percentage (%)</label>
      <input type="number" step="0.01" min="0" class="form-input" id="barema-idx-pct" placeholder="bv. 2.23" style="width:160px"/>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">bv. 2.23 = +2,23% verhoging</div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Annuleren</button>
      <button class="btn btn-primary" onclick="confirmBaremaIndexation()" style="background:#0d9668">Toepassen</button>
    </div>
  `);
}

function confirmBaremaIndexation(){
  const dateInput=document.getElementById('barema-idx-date');
  const pctInput=document.getElementById('barema-idx-pct');
  if(!dateInput||!dateInput.value){showToast('Kies een datum','error');return;}
  if(!pctInput||!pctInput.value||parseFloat(pctInput.value)===0){showToast('Vul een percentage in','error');return;}
  const date=dateInput.value;
  const pct=parseFloat(pctInput.value);
  if(baremaData.some(b=>b.date===date)){showToast('Er bestaat al een periode met deze datum','error');return;}
  // Get latest rates
  const sorted=[...baremaData].sort((a,b)=>b.date.localeCompare(a.date));
  const rates={};
  if(sorted.length>0){
    const last=sorted[0].rates;
    BAREMA_CATEGORIES.forEach(c=>{rates[c.id]=Math.round((last[c.id]||0)*(1+pct/100)*100)/100;});
  }else{
    BAREMA_CATEGORIES.forEach(c=>{rates[c.id]=0;});
  }
  baremaData.push({id:uid(),date:date,rates:rates,indexed:true,indexPct:pct});
  autoSave();closeModal();renderBarema();
  showToast('Indexatie +'+pct+'% toegepast âœ…');
}

function openBulkIndexation(){
  // Get all arbeiders/interim with PC 149.01 and salaryHistory
  const eligible=people.filter(function(p){
    return !p.archived&&p.paritairComite==='149.01'&&p.salaryHistory&&p.salaryHistory.find(function(m){return m.type===SALARY_TYPE_START;});
  });
  if(eligible.length===0){showToast('Geen medewerkers met PC 149.01 en actief startloon gevonden','warn');return;}

  let html='<div class="form-row"><div class="form-group">'
    +'<label class="form-label">Ingangsdatum</label>'
    +'<input type="date" class="form-input" id="bulk-idx-date" value="'+new Date().toISOString().split('T')[0]+'"/>'
    +'</div><div class="form-group">'
    +'<label class="form-label">Indexatie percentage (%)</label>'
    +'<input type="number" step="0.01" min="0" class="form-input" id="bulk-idx-pct" placeholder="bv. 2.23" oninput="previewBulkIndexation()"/>'
    +'<div style="font-size:11px;color:var(--text3);margin-top:4px">Op huidig uurloon per medewerker</div>'
    +'</div></div>';
  html+='<div id="bulk-idx-preview" style="margin-top:16px"></div>';
  html+='<div class="modal-actions">'
    +'<button class="btn" onclick="closeModal()">Annuleren</button>'
    +'<button class="btn btn-primary" id="bulk-idx-confirm" onclick="confirmBulkIndexation()" disabled style="background:#0d9668">Toepassen op <span id="bulk-idx-count">0</span> medewerkers</button>'
    +'</div>';
  openModal('ğŸ“ˆ Indexatie toepassen â€” PC 149.01',html);
  previewBulkIndexation();
}

function previewBulkIndexation(){
  const pctInput=document.getElementById('bulk-idx-pct');
  const pct=pctInput?parseFloat(pctInput.value):0;
  const dateInput=document.getElementById('bulk-idx-date');
  const date=dateInput?dateInput.value:'';
  const preview=document.getElementById('bulk-idx-preview');
  const confirmBtn=document.getElementById('bulk-idx-confirm');
  if(!preview)return;

  const eligible=people.filter(function(p){
    return !p.archived&&p.paritairComite==='149.01'&&p.salaryHistory&&p.salaryHistory.find(function(m){return m.type===SALARY_TYPE_START;});
  });

  // Check for duplicates: skip if person already has index mutation on this date
  const toApply=eligible.filter(function(p){
    return !p.salaryHistory.some(function(m){return m.type==='index'&&m.date===date&&!m.deleted;});
  });

  let html='<table class="tbl" style="font-size:12px"><thead><tr>'
    +'<th style="text-align:left">Medewerker</th><th>Cat.</th><th>Dept.</th>'
    +'<th style="text-align:right">Huidig â‚¬/u</th>';
  if(pct>0)html+='<th style="text-align:right">Verhoging</th><th style="text-align:right">Nieuw â‚¬/u</th>';
  html+='<th>Status</th></tr></thead><tbody>';

  var applyCount=0;
  eligible.forEach(function(p){
    const sal=calcCurrentSalary(p);
    if(!sal)return;
    const dept=departments.find(function(d){return d.id===p.departmentId;});
    const alreadyHas=p.salaryHistory.some(function(m){return m.type==='index'&&m.date===date&&!m.deleted;});
    const raise=pct>0?Math.round(sal.currentRate*pct)/100:0;
    const newRate=Math.round((sal.currentRate+raise)*100)/100;
    const status=alreadyHas
      ?'<span style="color:var(--warn);font-weight:600">âš ï¸ Al geÃ¯ndexeerd op deze datum</span>'
      :'<span style="color:var(--success)">âœ… Toe te passen</span>';
    if(!alreadyHas)applyCount++;
    html+='<tr'+(alreadyHas?' style="opacity:.5"':'')+'>';
    html+='<td style="font-weight:600">'+fullName(p)+'</td>';
    html+='<td style="text-align:center"><span class="badge badge-blue">'+( p.baremaCategory||'â€”')+'</span></td>';
    html+='<td>'+(dept?dept.name:'â€”')+'</td>';
    html+='<td style="text-align:right;font-weight:600">â‚¬ '+sal.currentRate.toFixed(2)+'</td>';
    if(pct>0){
      html+='<td style="text-align:right;color:var(--success);font-weight:600">+â‚¬ '+raise.toFixed(2)+'</td>';
      html+='<td style="text-align:right;font-weight:700;color:var(--accent)">â‚¬ '+newRate.toFixed(2)+'</td>';
    }
    html+='<td>'+status+'</td>';
    html+='</tr>';
  });
  html+='</tbody></table>';

  if(applyCount===0&&pct>0){
    html+='<div style="margin-top:12px;padding:10px;background:var(--warn-bg);border-radius:var(--radius-sm);font-size:12px;color:var(--warn)">âš ï¸ Alle medewerkers zijn al geÃ¯ndexeerd op deze datum.</div>';
  }

  preview.innerHTML=html;
  var countSpan=document.getElementById('bulk-idx-count');
  if(countSpan)countSpan.textContent=applyCount;
  if(confirmBtn){confirmBtn.disabled=!(pct>0&&date&&applyCount>0);}
}

async function confirmBulkIndexation(){
  const pct=parseFloat(document.getElementById('bulk-idx-pct').value);
  const date=document.getElementById('bulk-idx-date').value;
  if(!pct||!date)return;

  const eligible=people.filter(function(p){
    return !p.archived&&p.paritairComite==='149.01'&&p.salaryHistory&&p.salaryHistory.find(function(m){return m.type===SALARY_TYPE_START;});
  });
  const toApply=eligible.filter(function(p){
    return !p.salaryHistory.some(function(m){return m.type==='index'&&m.date===date&&!m.deleted;});
  });

  if(!await confirmDialog('Indexatie +'+pct+'% toepassen op '+toApply.length+' medewerkers per '+formatDate(date)+'?'))return;

  var count=0;
  toApply.forEach(function(p){
    const sal=calcCurrentSalary(p);
    if(!sal)return;
    const raise=Math.round(sal.currentRate*pct)/100;
    const newRate=Math.round((sal.currentRate+raise)*100)/100;
    p.salaryHistory.push({
      id:uid(),
      type:'index',
      amount:raise,
      date:date,
      comment:'Indexatie +'+pct+'%',
      locked:true
    });
    // Log mutatie
    if(!p.mutations)p.mutations=[];
    p.mutations.push({
      id:uid(),
      timestamp:new Date().toISOString(),
      user:settings.currentUser||'Admin',
      field:'Loonindexatie',
      oldValue:'â‚¬ '+sal.currentRate.toFixed(2)+'/u',
      newValue:'â‚¬ '+newRate.toFixed(2)+'/u (+'+pct+'% = +â‚¬ '+raise.toFixed(2)+')'
    });
    count++;
  });

  closeModal();autoSave();
  showToast('Loonindexatie +'+pct+'% toegepast op '+count+' medewerkers âœ…');
}

// â•â•â• ANCIÃ‹NNITEIT â•â•â•

function renderAncienniteit(){
  const tbody=document.getElementById('ancienniteit-tbody');
  if(!tbody)return;
  tbody.innerHTML=ancienniteitData.map(a=>`<tr>
    <td><input type="number" step="0.01" min="0" value="${a.pct}"
      style="width:70px;text-align:center;border:1px solid var(--border);border-radius:var(--radius-sm);padding:4px 6px;font-size:13px;font-weight:600"
      onchange="updateAncienniteit('${a.id}',this.value)"/> %</td>
    <td><input type="text" value="${a.desc}" class="form-input" style="border:none;background:transparent;padding:4px 0;font-size:13px"
      onchange="updateAncienniteitDesc('${a.id}',this.value)"/></td>
  </tr>`).join('');
}

function updateAncienniteit(id,value){
  const a=ancienniteitData.find(x=>x.id===id);
  if(a){a.pct=parseFloat(value)||0;}
  autoSave();
}

function updateAncienniteitDesc(id,value){
  const a=ancienniteitData.find(x=>x.id===id);
  if(a){a.desc=value;}
  autoSave();
}

// â•â•â• INIT â•â•â•

// Keyboard shortcuts
document.addEventListener('keydown',e=>{
  if(e.key==='Escape')closeModal();
});

async function resetData(){
  if(!await confirmDialog('âš ï¸ Alle data resetten naar standaardwaarden?\n\nDit verwijdert al je wijzigingen.'))return;
  localStorage.removeItem('vb_departments');
  localStorage.removeItem('vb_people');
  localStorage.removeItem('vb_types');
  localStorage.removeItem('vb_schedules');
  localStorage.removeItem('vb_requests');
  localStorage.removeItem('vb_candidates');
  localStorage.removeItem('vb_channels');
  localStorage.removeItem('vb_settings');
  localStorage.removeItem('vb_barema');
  localStorage.removeItem('vb_ancienniteit');
  localStorage.removeItem('vb_salaryReasons');
  localStorage.removeItem('vb_werkgeverskost');
  localStorage.removeItem('vb_uurkostParams');
  localStorage.removeItem('vb_verlofregels');
  localStorage.removeItem('vb_checklistItems');localStorage.removeItem('vb_accidents');localStorage.removeItem('vb_accidentSettings');
  location.reload();
}

restore();

try{
// Force fresh data load once (version flag prevents repeat resets)
const SEED_VERSION='v18.0';
if(localStorage.getItem('vb_seed_version')!==SEED_VERSION){
  localStorage.removeItem('vb_departments');
  localStorage.removeItem('vb_people');
  localStorage.removeItem('vb_types');
  localStorage.removeItem('vb_schedules');
  localStorage.removeItem('vb_requests');
  localStorage.removeItem('vb_candidates');
  localStorage.removeItem('vb_channels');
  localStorage.removeItem('vb_settings');
  localStorage.removeItem('vb_barema');
  localStorage.removeItem('vb_ancienniteit');
  localStorage.removeItem('vb_salaryReasons');
  localStorage.removeItem('vb_werkgeverskost');
  localStorage.removeItem('vb_uurkostParams');
  localStorage.removeItem('vb_verlofregels');
  localStorage.removeItem('vb_checklistItems');localStorage.removeItem('vb_accidents');localStorage.removeItem('vb_accidentSettings');
  localStorage.setItem('vb_seed_version',SEED_VERSION);
  departments=[];people=[];leaveTypes=[];schedules=[];requests=[];candidates=[];channels=[];baremaData=[];ancienniteitData=[];verlofregels=[];checklistItems=[];
}
}catch(e){
  departments=[];people=[];leaveTypes=[];schedules=[];requests=[];candidates=[];channels=[];baremaData=[];ancienniteitData=[];verlofregels=[];checklistItems=[];
}

// Seed demo data
if(departments.length===0&&people.length===0){
  departments=[
    {id:'dept-install',name:'Installatie',approverIds:[],parentDeptId:'',managerId:''},
    {id:'dept-service',name:'Service',approverIds:[],parentDeptId:'',managerId:''},
    {id:'dept-back',name:'Backoffice',approverIds:[],parentDeptId:'',managerId:''},
    {id:'dept-directie',name:'Directie',approverIds:[],parentDeptId:'',managerId:''},
    {id:'dept-verkoop',name:'Verkoop',approverIds:[],parentDeptId:'',managerId:''},
    {id:'dept-onderhoud',name:'Onderhoud',approverIds:[],parentDeptId:'',managerId:''}
  ];
  people=[
    // Bestaande demo medewerkers â€” VERWIJDERD (vervangen door echte data)
    // XLS medewerkers met volledige gegevens
    {id:'x1',firstName:'Enderson',lastName:'Molla',email:'enderson@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2020-03-15',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'D',gsm:'+32 467 70 90 49',tel:'',werkGsm:'',iban:'BE71 0000 1234 5678',birthDate:'1995-08-22',noodNaam:'Greet Lemmens',noodRelatie:'vriend(in)',noodGsm:'+32 467 70 90 49',allowanceAdjustments:[],
      salaryHistory:[{id:'s1a',type:'start',amount:18.50,date:'2020-03-15',comment:'Startloon cat. D',locked:true},{id:'s1b',type:'index',amount:0.55,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s1c',type:'index',amount:0.44,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x2',firstName:'Jarno',lastName:'Vranckx',email:'jarno@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2021-06-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'D',gsm:'+32 472 99 48 07',tel:'',werkGsm:'',iban:'BE42 3631 0954 7162',birthDate:'1998-03-14',noodNaam:'Els Vranckx',noodRelatie:'mama',noodGsm:'+32 478 55 12 30',allowanceAdjustments:[],
      salaryHistory:[{id:'s2a',type:'start',amount:17.80,date:'2021-06-01',comment:'Startloon cat. D',locked:true},{id:'s2b',type:'index',amount:0.55,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s2c',type:'index',amount:0.44,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x3',firstName:'Rens',lastName:'Deschryver',email:'rens@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2019-09-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'E',gsm:'+32 468 25 48 25',tel:'',werkGsm:'',iban:'BE68 5390 0754 7034',birthDate:'1992-11-07',noodNaam:'Martine Van Meerbeek',noodRelatie:'mama',noodGsm:'+32 486 86 97 82',allowanceAdjustments:[],
      salaryHistory:[{id:'s3a',type:'start',amount:19.85,date:'2019-09-01',comment:'Startloon cat. E',locked:true},{id:'s3b',type:'ancienniteit',amount:0.40,date:'2021-09-01',comment:'2 jaar anciÃ«nniteit',locked:false},{id:'s3c',type:'index',amount:0.60,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s3d',type:'index',amount:0.46,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x4',firstName:'Amber',lastName:'Van Meerbeek',email:'amber@advancedenergy.be',departmentId:'dept-back',role:'user',isApprover:false,startDate:'2023-02-01',scheduleId:'fulltime',statuut:'bediende',gsm:'+32 479 14 88 23',tel:'',werkGsm:'',iban:'BE15 0017 5469 3921',birthDate:'2000-05-30',noodNaam:'Indy Bombeke',noodRelatie:'partner',noodGsm:'+32 479 38 17 94',allowanceAdjustments:[{typeId:'wettelijk',days:20,reason:'Saldo aanpassing',date:'2026-01-01'}]},
    {id:'x5',firstName:'Bert',lastName:'Resseler',email:'bert@advancedenergy.be',departmentId:'dept-directie',role:'admin',isApprover:true,startDate:'2015-01-15',scheduleId:'fulltime',statuut:'zelfstandige',gsm:'+32 495 56 06 07',tel:'+32 16 15 24 24',werkGsm:'+32 495 56 06 07',iban:'BE62 5100 0754 7061',birthDate:'1970-09-18',noodNaam:'Katja Kestens',noodRelatie:'echtgeno(o)t(e)',noodGsm:'+32 496 57 74 26',allowanceAdjustments:[]},
    {id:'x6',firstName:'Cedric',lastName:'Bosteels',email:'cedric@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2022-01-10',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'C',gsm:'+32 491 20 07 09',tel:'',werkGsm:'',iban:'BE91 7340 2162 8049',birthDate:'1997-01-25',noodNaam:'Ann Van Dun',noodRelatie:'mama',noodGsm:'+32 472 81 42 88',allowanceAdjustments:[],
      salaryHistory:[{id:'s6a',type:'start',amount:17.20,date:'2022-01-10',comment:'Startloon cat. C',locked:true},{id:'s6b',type:'index',amount:0.50,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s6c',type:'correctie',amount:0.35,date:'2025-06-01',comment:'Correctie na evaluatie',locked:false},{id:'s6d',type:'index',amount:0.40,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x7',firstName:'Charly',lastName:'Vanderstappen',email:'charly@advancedenergy.be',departmentId:'dept-onderhoud',role:'user',isApprover:false,startDate:'2023-09-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'C',gsm:'+32 492 61 95 99',tel:'',werkGsm:'',iban:'BE47 0016 5924 7856',birthDate:'2001-06-12',noodNaam:'Nina Elskens',noodRelatie:'vriend(in)',noodGsm:'+32 497 50 24 26',allowanceAdjustments:[],
      salaryHistory:[{id:'s7a',type:'start',amount:17.50,date:'2023-09-01',comment:'Startloon cat. C',locked:true},{id:'s7b',type:'index',amount:0.50,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s7c',type:'index',amount:0.40,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x8',firstName:'Chris',lastName:'Vanroelen',email:'chris@advancedenergy.be',departmentId:'dept-verkoop',role:'user',isApprover:false,startDate:'2022-06-01',scheduleId:'fulltime',statuut:'bediende',gsm:'+32 473 95 96 38',tel:'',werkGsm:'+32 473 95 96 38',iban:'BE03 2200 5468 7712',birthDate:'1988-12-03',noodNaam:'Lies Peeters',noodRelatie:'echtgeno(o)t(e)',noodGsm:'+32 486 21 30 57',allowanceAdjustments:[]},
    {id:'x9',firstName:'Jarne',lastName:'Boudt',email:'jarne@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2021-11-15',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'D',gsm:'+32 465 66 42 68',tel:'',werkGsm:'',iban:'BE56 7370 3209 4815',birthDate:'1999-04-09',noodNaam:'Ulrika Coussement',noodRelatie:'partner',noodGsm:'+32 499 72 49 67',allowanceAdjustments:[],
      salaryHistory:[{id:'s9a',type:'start',amount:18.00,date:'2021-11-15',comment:'Startloon cat. D',locked:true},{id:'s9b',type:'ancienniteit',amount:0.20,date:'2023-11-15',comment:'2 jaar anciÃ«nniteit',locked:false},{id:'s9c',type:'index',amount:0.55,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s9d',type:'index',amount:0.44,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x10',firstName:'Kinza',lastName:'Janssens',email:'kinza@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2024-03-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'B',gsm:'+32 468 92 31 50',tel:'',werkGsm:'',iban:'BE29 3630 5184 7720',birthDate:'2002-10-17',noodNaam:'Assimina Grammenidis',noodRelatie:'mama',noodGsm:'+32 499 11 94 69',allowanceAdjustments:[],
      salaryHistory:[{id:'s10a',type:'start',amount:16.63,date:'2024-03-01',comment:'Startloon cat. B barema',locked:true},{id:'s10b',type:'index',amount:0.37,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x11',firstName:'Lander',lastName:'Resseler',email:'lander@advancedenergy.be',departmentId:'dept-directie',role:'admin',isApprover:true,startDate:'2017-03-01',scheduleId:'fulltime',statuut:'zelfstandige',gsm:'+32 491 50 98 32',tel:'',werkGsm:'+32 491 50 98 32',iban:'BE84 3200 6845 9030',birthDate:'1993-07-21',noodNaam:'Katja Kestens',noodRelatie:'mama',noodGsm:'+32 496 57 74 26',allowanceAdjustments:[]},
    {id:'x12',firstName:'Lukas',lastName:'Cornet',email:'lukas@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2018-04-15',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'E',gsm:'+32 490 40 67 78',tel:'',werkGsm:'',iban:'BE78 0014 7895 2134',birthDate:'1994-02-28',noodNaam:'Judit Kechtermans',noodRelatie:'mama',noodGsm:'+32 485 16 44 17',allowanceAdjustments:[],
      salaryHistory:[{id:'s12a',type:'start',amount:19.50,date:'2018-04-15',comment:'Startloon cat. E',locked:true},{id:'s12b',type:'ancienniteit',amount:0.35,date:'2020-04-15',comment:'2 jaar anciÃ«nniteit',locked:false},{id:'s12c',type:'ancienniteit',amount:0.25,date:'2022-04-15',comment:'4 jaar anciÃ«nniteit',locked:false},{id:'s12d',type:'index',amount:0.60,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s12e',type:'index',amount:0.46,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x13',firstName:'Luca',lastName:'Crocket',email:'luca@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2025-06-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'A',gsm:'+32 489 30 11 42',tel:'',werkGsm:'',iban:'BE55 0013 9028 5577',birthDate:'2003-09-05',noodNaam:'Nathalie Crocket',noodRelatie:'mama',noodGsm:'+32 476 90 12 55',allowanceAdjustments:[],archived:true,archivedDate:'2025-12-01',
      salaryHistory:[{id:'s13a',type:'start',amount:15.69,date:'2025-06-01',comment:'Startloon cat. A barema',locked:true}]},
    {id:'x14',firstName:'Mien',lastName:'Puttemans',email:'mien@advancedenergy.be',departmentId:'dept-back',role:'user',isApprover:false,startDate:'2021-09-01',scheduleId:'fulltime',statuut:'bediende',gsm:'+32 493 02 04 25',tel:'',werkGsm:'',iban:'BE10 7310 4598 0126',birthDate:'1996-12-11',noodNaam:'Jan Puttemans',noodRelatie:'papa',noodGsm:'+32 495 25 32 50',allowanceAdjustments:[]},
    {id:'x15',firstName:'Nick',lastName:'de Ridder',email:'nick@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2019-04-01',scheduleId:'fulltime',statuut:'zelfstandige',gsm:'+32 493 56 12 91',tel:'',werkGsm:'',iban:'BE67 0689 0514 8012',birthDate:'1990-03-29',noodNaam:'Jitske',noodRelatie:'vriend(in)',noodGsm:'+32 476 38 98 31',allowanceAdjustments:[]},
    {id:'x16',firstName:'Nicolas',lastName:'Voorspoels',email:'nicolas@advancedenergy.be',departmentId:'dept-verkoop',role:'user',isApprover:false,startDate:'2023-11-01',scheduleId:'fulltime',statuut:'bediende',gsm:'+32 476 44 89 05',tel:'',werkGsm:'',iban:'BE21 3751 0098 4465',birthDate:'1991-08-15',noodNaam:'Laura De Hondt',noodRelatie:'echtgeno(o)t(e)',noodGsm:'+32 499 30 78 38',allowanceAdjustments:[]},
    {id:'x17',firstName:'Pieter-Jan',lastName:'De Clercq',email:'pietjan@advancedenergy.be',departmentId:'dept-onderhoud',role:'user',isApprover:false,startDate:'2022-08-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'C',gsm:'+32 472 55 14 14',tel:'',werkGsm:'',iban:'BE39 0018 2076 3142',birthDate:'1997-11-02',noodNaam:'Jo de Clercq',noodRelatie:'papa',noodGsm:'+32 475 85 75 00',allowanceAdjustments:[],
      salaryHistory:[{id:'s17a',type:'start',amount:17.50,date:'2022-08-01',comment:'Startloon cat. C',locked:true},{id:'s17b',type:'index',amount:0.50,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s17c',type:'ancienniteit',amount:0.30,date:'2025-08-01',comment:'3 jaar anciÃ«nniteit',locked:false},{id:'s17d',type:'index',amount:0.40,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x18',firstName:'Robbe',lastName:'Resseler',email:'robbe@advancedenergy.be',departmentId:'dept-directie',role:'admin',isApprover:true,startDate:'2016-06-01',scheduleId:'fulltime',statuut:'zelfstandige',gsm:'+32 471 65 80 37',tel:'',werkGsm:'+32 471 65 80 37',iban:'BE85 3200 6845 9047',birthDate:'1991-04-14',noodNaam:'Katja Kestens',noodRelatie:'mama',noodGsm:'+32 496 57 74 26',allowanceAdjustments:[]},
    {id:'x19',firstName:'Wout',lastName:'Verbaenen',email:'wout@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2020-11-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'D',gsm:'+32 477 76 23 02',tel:'',werkGsm:'',iban:'BE44 2100 4185 6033',birthDate:'1996-07-04',noodNaam:'Sandra',noodRelatie:'andere',noodGsm:'+32 494 24 14 72',allowanceAdjustments:[],
      salaryHistory:[{id:'s19a',type:'start',amount:18.20,date:'2020-11-01',comment:'Startloon cat. D',locked:true},{id:'s19b',type:'ancienniteit',amount:0.30,date:'2022-11-01',comment:'2 jaar anciÃ«nniteit',locked:false},{id:'s19c',type:'index',amount:0.55,date:'2025-01-01',comment:'Indexatie 2025',locked:true},{id:'s19d',type:'index',amount:0.44,date:'2026-01-01',comment:'Indexatie 2026',locked:true}]},
    {id:'x20',firstName:'Stef',lastName:'Aerts',email:'stef@advancedenergy.be',departmentId:'dept-install',role:'user',isApprover:false,startDate:'2026-04-01',scheduleId:'fulltime',statuut:'arbeider',paritairComite:'149.01',baremaCategory:'C',gsm:'+32 485 33 20 17',tel:'',werkGsm:'',iban:'BE23 7340 5512 0098',birthDate:'1999-02-10',noodNaam:'Karolien Aerts',noodRelatie:'mama',noodGsm:'+32 478 60 11 34',allowanceAdjustments:[],
      salaryHistory:[{id:'s20a',type:'start',amount:18.45,date:'2026-04-01',comment:'Startloon cat. C barema 2026',locked:true}]}
  ];
  departments[0].approverIds=['x5'];  // Installatie -> Bert Resseler
  departments[1].approverIds=['x5'];  // Service -> Bert Resseler
  departments[2].approverIds=['x14']; // Backoffice -> Mien Puttemans
  departments[3].approverIds=['x5'];  // Directie -> Bert Resseler
  departments[4].approverIds=['x8'];  // Verkoop -> Chris Vanroelen
  departments[5].approverIds=['x17']; // Onderhoud -> Pieter-Jan De Clercq
  
  const today=new Date();
  const todayStr=today.toISOString().split('T')[0];
  const tomorrow=new Date(today);tomorrow.setDate(today.getDate()+1);
  const nextWeek=new Date(today);nextWeek.setDate(today.getDate()+5);
  const nextWeekStr=nextWeek.toISOString().split('T')[0];
  const lastWeek=new Date(today);lastWeek.setDate(today.getDate()-5);
  const lastWeekStr=lastWeek.toISOString().split('T')[0];
  const lastWeekEnd=new Date(today);lastWeekEnd.setDate(today.getDate()-3);
  const lastWeekEndStr=lastWeekEnd.toISOString().split('T')[0];
  const twoWeeks=new Date(today);twoWeeks.setDate(today.getDate()+12);
  const twoWeeksStr=twoWeeks.toISOString().split('T')[0];
  const twoWeeksEnd=new Date(today);twoWeeksEnd.setDate(today.getDate()+16);
  const twoWeeksEndStr=twoWeeksEnd.toISOString().split('T')[0];
  const threeWeeks=new Date(today);threeWeeks.setDate(today.getDate()+20);
  const threeWeeksStr=threeWeeks.toISOString().split('T')[0];
  const threeWeeksEnd=new Date(today);threeWeeksEnd.setDate(today.getDate()+21);
  const threeWeeksEndStr=threeWeeksEnd.toISOString().split('T')[0];
  const jan6='2026-01-06',jan9='2026-01-09';
  const jan19='2026-01-19',jan20='2026-01-20';
  const feb2='2026-02-02',feb6='2026-02-06';

  requests=[
    // Goedgekeurd - vandaag afwezig
    {id:'r1',personId:'x9',type:'wettelijk',startDate:todayStr,endDate:tomorrow.toISOString().split('T')[0],days:2,halfDay:false,status:'approved',comment:'Gezinsuitstap'},
    {id:'r2',personId:'x12',type:'ziekte',startDate:todayStr,endDate:tomorrow.toISOString().split('T')[0],days:2,halfDay:false,status:'approved',comment:'Griep'},
    {id:'r3',personId:'x7',type:'wettelijk',startDate:todayStr,endDate:todayStr,days:1,halfDay:true,halfDayPeriod:'VM',status:'approved',comment:'Doktersbezoek'},
    // Goedgekeurd - afgelopen week
    {id:'r4',personId:'x5',type:'wettelijk',startDate:lastWeekStr,endDate:lastWeekEndStr,days:3,halfDay:false,status:'approved',comment:'Familiebezoek'},
    {id:'r5',personId:'x6',type:'adv',startDate:lastWeekStr,endDate:lastWeekStr,days:1,halfDay:false,status:'approved',comment:''},
    {id:'r6',personId:'x14',type:'wettelijk',startDate:lastWeekStr,endDate:lastWeekEndStr,days:3,halfDay:false,status:'approved',comment:'Verhuizing'},
    // Goedgekeurd - komende week
    {id:'r7',personId:'x19',type:'wettelijk',startDate:nextWeekStr,endDate:nextWeekStr,days:1,halfDay:false,status:'approved',comment:''},
    {id:'r8',personId:'x17',type:'adv',startDate:nextWeekStr,endDate:nextWeekStr,days:1,halfDay:false,status:'approved',comment:''},
    // Goedgekeurd - over 2 weken
    {id:'r9',personId:'x1',type:'wettelijk',startDate:twoWeeksStr,endDate:twoWeeksEndStr,days:5,halfDay:false,status:'approved',comment:'Vakantie'},
    {id:'r10',personId:'x3',type:'wettelijk',startDate:twoWeeksStr,endDate:twoWeeksStr,days:1,halfDay:false,status:'approved',comment:''},
    // Openstaand (pending) - te beoordelen
    {id:'r11',personId:'x2',type:'wettelijk',startDate:threeWeeksStr,endDate:threeWeeksEndStr,days:2,halfDay:false,status:'pending',comment:'Weekendje weg'},
    {id:'r12',personId:'x10',type:'wettelijk',startDate:twoWeeksStr,endDate:twoWeeksEndStr,days:5,halfDay:false,status:'pending',comment:'Skivakantie'},
    {id:'r13',personId:'x8',type:'adv',startDate:nextWeekStr,endDate:nextWeekStr,days:1,halfDay:false,status:'pending',comment:''},
    {id:'r14',personId:'x16',type:'wettelijk',startDate:threeWeeksStr,endDate:threeWeeksStr,days:1,halfDay:false,status:'pending',comment:'Huwelijksfeest'},
    // Geweigerd
    {id:'r15',personId:'x15',type:'wettelijk',startDate:nextWeekStr,endDate:nextWeekStr,days:1,halfDay:false,status:'rejected',rejectReason:'Te veel collega\'s afwezig die dag',comment:''},
    // Eerdere ziekte
    {id:'r16',personId:'x6',type:'ziekte',startDate:jan6,endDate:jan9,days:4,halfDay:false,status:'approved',comment:'Covid'},
    {id:'r17',personId:'x19',type:'ziekte',startDate:jan19,endDate:jan20,days:2,halfDay:false,status:'approved',comment:'Buikgriep'},
    // Eerder verlof (jan/feb) voor rapportage
    {id:'r18',personId:'x5',type:'wettelijk',startDate:jan6,endDate:jan9,days:4,halfDay:false,status:'approved',comment:''},
    {id:'r19',personId:'x11',type:'wettelijk',startDate:feb2,endDate:feb6,days:5,halfDay:false,status:'approved',comment:'Krokusvakantie'},
    {id:'r20',personId:'x18',type:'wettelijk',startDate:feb2,endDate:feb6,days:5,halfDay:false,status:'approved',comment:'Krokusvakantie'},
    {id:'r21',personId:'x4',type:'adv',startDate:jan6,endDate:jan6,days:1,halfDay:false,status:'approved',comment:''},
    // Extern (tech werkloosheid)
    {id:'r22',personId:'x1',type:'tech-werkloos',startDate:jan19,endDate:jan20,days:2,halfDay:false,status:'approved',comment:'Geen werk beschikbaar'},
    {id:'r23',personId:'x2',type:'tech-werkloos',startDate:jan19,endDate:jan20,days:2,halfDay:false,status:'approved',comment:'Geen werk beschikbaar'},
    // Klein verlet
    {id:'r24',personId:'x17',type:'verhuizing',startDate:'2025-10-15',endDate:'2025-10-15',days:1,halfDay:false,status:'approved',comment:'Verhuis naar Mechelen'},
    {id:'r25',personId:'x9',type:'geboorte',startDate:'2025-09-08',endDate:'2025-10-03',days:20,halfDay:false,status:'approved',comment:'Geboorte dochter'},
    {id:'r26',personId:'x12',type:'communie',startDate:'2025-05-10',endDate:'2025-05-10',days:1,halfDay:false,status:'approved',comment:'Communie neefje'},
    {id:'r27',personId:'x6',type:'arbeidsongeval',startDate:'2025-07-14',endDate:'2025-07-25',days:10,halfDay:false,status:'approved',comment:'Val van ladder op werf'},
    // Weerverlet
    {id:'r28',personId:'x1',type:'weerverlet',startDate:'2025-12-22',endDate:'2025-12-23',days:2,halfDay:false,status:'approved',comment:'Sneeuwval - werf ontoegankelijk'},
    {id:'r29',personId:'x3',type:'weerverlet',startDate:'2025-12-22',endDate:'2025-12-23',days:2,halfDay:false,status:'approved',comment:'Sneeuwval - werf ontoegankelijk'},
    {id:'r30',personId:'x19',type:'opleiding',startDate:'2025-11-17',endDate:'2025-11-18',days:2,halfDay:false,status:'approved',comment:'HVAC opleiding Daikin'},
    {id:'r31',personId:'x7',type:'opleiding',startDate:'2025-11-17',endDate:'2025-11-18',days:2,halfDay:false,status:'approved',comment:'HVAC opleiding Daikin'},
    // Nieuwe types in gebruik
    {id:'r32',personId:'x14',type:'dokter',startDate:nextWeekStr,endDate:nextWeekStr,days:1,halfDay:true,halfDayPeriod:'VM',status:'approved',comment:'Tandarts'},
    {id:'r33',personId:'x12',type:'familiaal',startDate:lastWeekStr,endDate:lastWeekStr,days:1,halfDay:false,status:'approved',comment:'Ziek kind ophalen crÃ¨che'},
    {id:'r34',personId:'x3',type:'ancienniteit',startDate:threeWeeksStr,endDate:threeWeeksStr,days:1,halfDay:false,status:'pending',comment:''},
    {id:'r35',personId:'x6',type:'hospitalisatie',startDate:'2025-08-04',endDate:'2025-08-08',days:5,halfDay:false,status:'approved',comment:'Knie-operatie na arbeidsongeval'},
    {id:'r36',personId:'x10',type:'dokter',startDate:twoWeeksStr,endDate:twoWeeksStr,days:1,halfDay:true,halfDayPeriod:'NM',status:'pending',comment:'Controle huisarts'},
    {id:'r37',personId:'x8',type:'juridisch',startDate:'2025-06-20',endDate:'2025-06-20',days:1,halfDay:false,status:'approved',comment:'Oproep vredegerecht'},
    // TEST medewerker requests â€” Enderson Molla (x1) extra afwezigheden voor saldo-test
    {id:'rt1',personId:'x1',type:'wettelijk',startDate:'2026-01-12',endDate:'2026-01-16',days:5,halfDay:false,status:'approved',comment:'Wintervakantie'},
    {id:'rt2',personId:'x1',type:'adv',startDate:'2026-02-09',endDate:'2026-02-10',days:2,halfDay:false,status:'approved',comment:'ADV opname'},
    {id:'rt3',personId:'x1',type:'huwelijk',startDate:'2026-02-20',endDate:'2026-02-21',days:2,halfDay:false,status:'approved',comment:'Eigen huwelijk'},
    {id:'rt4',personId:'x1',type:'ziekte',startDate:'2026-01-26',endDate:'2026-01-30',days:5,halfDay:false,status:'approved',comment:'Griep'},
    {id:'rt5',personId:'x1',type:'dokter',startDate:'2026-02-16',endDate:'2026-02-16',days:1,halfDay:true,halfDayPeriod:'VM',status:'approved',comment:'Controle huisarts'},
    {id:'rt6',personId:'x1',type:'opleiding',startDate:'2026-02-23',endDate:'2026-02-24',days:2,halfDay:false,status:'approved',comment:'VCA opleiding'}
  ];
  autoSave();
}

// Seed barema data
if(baremaData.length===0){
  baremaData=[
    {id:'bar1',date:'2025-01-01',rates:{A:15.69,B:16.63,C:18.05,D:19.61,E:20.71,F:21.97}},
    {id:'bar2',date:'2026-01-01',rates:{A:16.04,B:17.00,C:18.45,D:20.05,E:21.17,F:22.46}}
  ];
  autoSave();
}

// Seed anciÃ«nniteit data
if(ancienniteitData.length===0){
  ancienniteitData=[
    {id:'anc1',pct:1,desc:'na 1 jaar dienst'},
    {id:'anc2',pct:0.50,desc:'per extra jaar dienst'},
    {id:'anc3',pct:13,desc:'maximale anciÃ«nniteit'}
  ];
  autoSave();
}

// â•â•â• SHELL INTEGRATIE â•â•â•

const shellPermissions={canCreate:true,canEdit:true,canDelete:true,role:'admin'};
const isInIframe=window.self!==window.top;

function detectShell(){
  if(isInIframe){
    const rb=document.querySelector('.role-bar');if(rb)rb.style.display='none';
    const main=document.querySelector('.main');if(main)main.style.paddingTop='0';
  }
}

window.addEventListener('message',e=>{
  if(e.data&&e.data.type==='shell:permissions'){
    shellPermissions.canCreate=!!e.data.canCreate;
    shellPermissions.canEdit=!!e.data.canEdit;
    shellPermissions.canDelete=!!e.data.canDelete;
    shellPermissions.role=e.data.role||'gebruiker';
    if(e.data.allowedSections)shellPermissions.allowedSections=e.data.allowedSections;
    applyPermissions();
  }
});

function applyPermissions(){
  if(isInIframe&&shellPermissions.allowedSections){
    document.querySelectorAll('.sb-item[data-page]').forEach(el=>{
      const page=el.getAttribute('data-page');
      el.style.display=shellPermissions.allowedSections.includes(page)?'':'none';
    });
    // Check of huidige pagina nog toegankelijk is
    const page=document.querySelector('.panel.active');
    if(page){
      const id=page.id.replace('page-','');
      if(shellPermissions.allowedSections.indexOf(id)===-1&&id!=='dashboard'){
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById('page-dashboard').classList.add('active');
        renderDashboard();return;
      }
    }
  }
  const page=document.querySelector('.panel.active');
  if(page){
    const id=page.id.replace('page-','');
    if(id==='dashboard')renderDashboard();
    if(id==='people')renderPeople();
    if(id==='departments')renderDepartments();
  }
}

function canCreate(){return shellPermissions.canCreate;}
function canEdit(){return shellPermissions.canEdit;}
function canDelete(){return shellPermissions.canDelete;}
function isAdmin(){return shellPermissions.role==='admin';}

detectShell();
autoArchiveExpiredContracts();
renderDashboard();
// Pre-render all pages so tables are filled even before user navigates
try{renderRequests();}catch(e){}
try{renderSickness();}catch(e){}

// â•â•â• FIREBASE (dynamisch geladen, blokkeert NIETS) â•â•â•
var firebaseReady=false;
var firebaseDb=null;
(function(){
  function loadScript(url,cb){var s=document.createElement('script');s.src=url;s.async=true;s.onload=cb;s.onerror=function(){console.warn('Firebase script load failed:',url);};document.head.appendChild(s);}
  loadScript('https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js',function(){
    loadScript('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js',function(){
      try{
        if(!firebase.apps.length)firebase.initializeApp({apiKey:"AIzaSyBKU-wCjV4Au4ngRG52Zmmxbzc3N3D8VBU",authDomain:"advanced-intranet.firebaseapp.com",projectId:"advanced-intranet",storageBucket:"advanced-intranet.firebasestorage.app",messagingSenderId:"309856938024",appId:"1:309856938024:web:2108715f92c5dea2da2d1d"});
        var db=firebase.firestore();
        firebaseDb=db;
        firebaseReady=true;
        console.log('ğŸ”¥ Firebase connected');

        // Refresh alle zichtbare pagina's
        function refresh(){
          var p=document.querySelector('.panel.active');
          if(p){
            var id=p.id.replace('page-','');
            try{if(id==='dashboard'&&typeof renderDashboard==='function')renderDashboard();}catch(e){}
            try{if(id==='requests'&&typeof renderRequests==='function')renderRequests();}catch(e){}
            try{if(id==='people'&&typeof renderPeople==='function')renderPeople();}catch(e){}
            try{if(id==='departments'&&typeof renderDepartments==='function')renderDepartments();}catch(e){}
            try{if(id==='sickness'&&typeof renderSickness==='function')renderSickness();}catch(e){}
            try{if(id==='wallchart'&&typeof renderWallchart==='function')renderWallchart();}catch(e){}
            try{if(id==='reports'&&typeof renderReports==='function')renderReports();}catch(e){}
          }
        }

        // Parse Firestore data veilig
        function parseField(d,field,current){
          try{
            if(!d[field])return null;
            var v=JSON.parse(d[field]);
            if(!Array.isArray(v)||v.length===0)return null;
            if(JSON.stringify(v)===JSON.stringify(current))return null;
            return v;
          }catch(e){return null;}
        }

        function applyFirestoreData(d){
          var ch=false;
          var v;
          v=parseField(d,'requests',requests);if(v){requests=v;ch=true;}
          v=parseField(d,'people',people);if(v){people=v;ch=true;}
          v=parseField(d,'departments',departments);if(v){departments=v;ch=true;}
          v=parseField(d,'leaveTypes',leaveTypes);if(v){leaveTypes=v;ch=true;}
          v=parseField(d,'schedules',schedules);if(v){schedules=v;ch=true;}
          // Niet-array velden
          try{if(d.candidates){var cv=JSON.parse(d.candidates);if(cv.length>0)candidates=cv;}}catch(e){}
          try{if(d.channels){var cv=JSON.parse(d.channels);if(cv.length>0)channels=cv;}}catch(e){}
          try{if(d.settings){Object.assign(settings,JSON.parse(d.settings));}}catch(e){}
          try{if(d.baremaData){var cv=JSON.parse(d.baremaData);if(cv.length>0)baremaData=cv;}}catch(e){}
          try{if(d.ancienniteitData){var cv=JSON.parse(d.ancienniteitData);if(cv.length>0)ancienniteitData=cv;}}catch(e){}
          try{if(d.verlofregels){var cv=JSON.parse(d.verlofregels);if(Array.isArray(cv))verlofregels=cv;}}catch(e){}
          try{if(d.checklistItems){var cv=JSON.parse(d.checklistItems);if(Array.isArray(cv))checklistItems=cv;}}catch(e){}
          try{if(d.accidents){var av=JSON.parse(d.accidents);if(Array.isArray(av))accidents=av;}}catch(e){}
          try{if(d.accidentSettings){var asv=JSON.parse(d.accidentSettings);if(typeof asv==='object')accidentSettings=asv;}}catch(e){}
          return ch;
        }

        // Eerste keer: lees Firestore data
        db.collection('platform').doc('personeelbeheer').get().then(function(doc){
          if(!doc.exists){
            console.log('ğŸ”¥ Geen bestaande data in Firestore, seed data uploaden...');
            autoSave(); // Push seed data naar Firestore
            return;
          }
          var d=doc.data();
          if(applyFirestoreData(d)){
            console.log('ğŸ”¥ Data geladen uit Firestore');
            refresh();
          }
        }).catch(function(e){console.warn('ğŸ”¥ Firestore read failed:',e);});

        // Real-time listener voor live sync
        db.collection('platform').doc('personeelbeheer').onSnapshot(function(doc){
          if(!doc.exists)return;
          var d=doc.data();
          if(applyFirestoreData(d)){
            console.log('ğŸ”¥ Live update ontvangen');
            refresh();
          }
        },function(e){console.warn('ğŸ”¥ Snapshot listener error:',e);});

        // AutoSave override â€” schrijf naar Firestore bij elke wijziging
        var _orig=autoSave;
        autoSave=function(){
          _orig(); // localStorage backup
          if(!firebaseReady)return;
          db.collection('platform').doc('personeelbeheer').set({
            departments:JSON.stringify(departments),
            people:JSON.stringify(people),
            leaveTypes:JSON.stringify(leaveTypes),
            schedules:JSON.stringify(schedules),
            requests:JSON.stringify(requests),
            candidates:JSON.stringify(candidates),
            channels:JSON.stringify(channels),
            settings:JSON.stringify(settings),
            baremaData:JSON.stringify(baremaData),
            ancienniteitData:JSON.stringify(ancienniteitData),
            salaryReasonTypes:JSON.stringify(typeof salaryReasonTypes!=='undefined'?salaryReasonTypes:[]),
            werkgeverskostData:JSON.stringify(typeof werkgeverskostData!=='undefined'?werkgeverskostData:[]),
            uurkostParams:JSON.stringify(typeof uurkostParams!=='undefined'?uurkostParams:{}),
            verlofregels:JSON.stringify(typeof verlofregels!=='undefined'?verlofregels:[]),
            checklistItems:JSON.stringify(typeof checklistItems!=='undefined'?checklistItems:[]),
            accidents:JSON.stringify(typeof accidents!=='undefined'?accidents:[]),
            accidentSettings:JSON.stringify(typeof accidentSettings!=='undefined'?accidentSettings:{totalHours:{}}),
            updatedAt:new Date().toISOString()
          }).then(function(){
            console.log('ğŸ”¥ Firestore saved');
          }).catch(function(e){console.warn('ğŸ”¥ Firestore save failed:',e);});
        };

        console.log('ğŸ”¥ Firebase real-time sync actief');
      }catch(e){console.error('ğŸ”¥ Firebase init error:',e);}
    });
  });
})();
</script>
</body>
</html>
