<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Bezoekrapport">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQmV6b2VrcmFwcG9ydCIsInNob3J0X25hbWUiOiJCZXpvZWsiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBmMTExNyIsInRoZW1lX2NvbG9yIjoiIzAwMDAwMCJ9">
<title>Bezoekrapport</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyBKU-wCjV4Au4ngRG52Zmmxbzc3N3D8VBU",
  authDomain:"advanced-intranet.firebaseapp.com",
  projectId:"advanced-intranet",
  storageBucket:"advanced-intranet.firebasestorage.app",
  messagingSenderId:"309856938024",
  appId:"1:309856938024:web:2108715f92c5dea2da2d1d"
});
const db=firebase.firestore();
const storage=firebase.storage();
</script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap');
  :root {
    --bg:#0f1117; --surface:#181c27; --surface2:#1e2336;
    --border:#2a2f45; --border-hover:#3d4460;
    --accent:#4f8ef7; --accent2:#38d9a9; --accent3:#ff8c42;
    --text:#e8ecf5; --text2:#8b92b0; --text3:#555e7d;
    --success:#38d9a9; --solar:#f7c948; --battery:#4f8ef7; --air:#ff8c42;
    --radius:12px; --radius-sm:8px;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  html{height:100%;-webkit-text-size-adjust:100%;}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;
    padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);}

  header{display:flex;align-items:center;justify-content:space-between;
    padding:10px 20px;background:#000;border-bottom:1px solid var(--border);
    position:sticky;top:0;z-index:100;}
  .logo{display:flex;align-items:center;gap:12px;}
  .logo img{height:32px;width:32px;object-fit:contain;}
  .logo-text{display:flex;flex-direction:column;gap:1px;}
  .logo-title{font-size:17px;font-weight:700;letter-spacing:-.3px;color:#fff;}
  .logo-datetime{font-size:11px;font-weight:400;color:rgba(255,255,255,.7);letter-spacing:.2px;}
  .hstep{font-size:12px;color:var(--text2);background:var(--surface2);
    border:1px solid var(--border);padding:5px 12px;border-radius:20px;}

  main{max-width:680px;margin:0 auto;padding:28px 16px 60px;}

  .panel{display:none;animation:fadeUp .3s ease;}
  .panel.active{display:block;}
  @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .ptitle{font-size:24px;font-weight:700;letter-spacing:-.5px;margin-bottom:6px;}
  .psub{color:var(--text2);font-size:13px;margin-bottom:28px;line-height:1.5;}

  /* Hub grid - all 6 types */
  .tgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:28px;}
  .tcard{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);
    padding:22px 16px;cursor:pointer;transition:all .2s;text-align:center;position:relative;user-select:none;
    opacity:0.35;}
  .tcard:hover:not(.disabled){border-color:var(--border-hover);transform:translateY(-2px);}
  .tcard.disabled{cursor:not-allowed;pointer-events:none;}
  .tcard.clickable{cursor:pointer;pointer-events:auto;}
  .tcard.completed{opacity:1;border-color:var(--success);background:rgba(56,217,169,.07);}
  .tck{position:absolute;top:10px;right:10px;width:20px;height:20px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;font-size:11px;opacity:0;transition:opacity .2s;}
  .tcard.completed .tck{opacity:1;background:var(--success);color:#0f2a22;}
  .ticon{font-size:32px;margin-bottom:10px;}
  .tname{font-size:14px;font-weight:600;}
  .tsoon{font-size:10px;color:var(--text3);margin-top:3px;}

  /* Score badges on hub cards */
  .score-badges{display:flex;gap:8px;justify-content:center;margin-top:8px;}
  .score-badge{font-size:11px;font-weight:600;display:flex;align-items:center;gap:3px;position:relative;}
  .score-badge .score-val{color:var(--text3);}
  .score-badge .score-val.red{color:#ff5c5c;}
  .score-badge .score-val.green{color:var(--success);}
  /* Custom instant tooltip */
  .score-badge[data-tip]{position:relative;}
  .score-badge[data-tip]::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
    background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:10px;font-weight:500;
    padding:3px 8px;border-radius:4px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .05s;}
  .score-badge[data-tip]:hover::after{opacity:1;}

  .sel-tags{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:24px;min-height:20px;}
  .stag{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;
    border-radius:20px;font-size:12px;font-weight:500;}
  .stag.solar{background:rgba(247,201,72,.15);color:var(--solar);border:1px solid rgba(247,201,72,.3);}
  .stag.battery{background:rgba(79,142,247,.15);color:var(--battery);border:1px solid rgba(79,142,247,.3);}

  .brow{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .btn{padding:12px 24px;border:none;border-radius:var(--radius-sm);
    font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;}
  .btn-p{background:linear-gradient(135deg,var(--accent),#3a7de8);color:#fff;}
  .btn-p:hover:not(:disabled){opacity:.88;transform:translateY(-1px);}
  .btn-p:disabled{opacity:.35;cursor:not-allowed;}
  .btn-s{background:var(--surface2);border:1px solid var(--border);color:var(--text);}
  .btn-s:hover{border-color:var(--border-hover);}
  .btn-g{background:linear-gradient(135deg,var(--success),#2ab990);color:#0f2a22;}

  .rtabs{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap;}
  .rtab{padding:8px 16px;border-radius:20px;border:2px solid var(--border);
    background:var(--surface2);color:var(--text2);font-size:13px;font-weight:600;
    cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;}
  .rtab.solar.active{background:rgba(247,201,72,.15);border-color:var(--solar);color:var(--solar);}
  .rtab.battery.active{background:rgba(79,142,247,.15);border-color:var(--battery);color:var(--battery);}
  .rtab.airmo.active,.rtab.airmu.active{background:rgba(255,140,66,.15);border-color:var(--air);color:var(--air);}
  .rtab.charge.active{background:rgba(79,142,247,.15);border-color:#a78bfa;color:#a78bfa;}
  .rtab.airwater.active{background:rgba(56,182,255,.15);border-color:#38b6ff;color:#38b6ff;}
  .rtab.geo.active{background:rgba(76,175,80,.15);border-color:#4caf50;color:#4caf50;}

  .progwrap{margin-bottom:24px;}
  .progmeta{display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-bottom:6px;}
  .progtrack{height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
  .progfill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .4s ease;}
  .prog-scores{display:flex;gap:12px;font-size:11px;margin-top:4px;}
  .prog-scores span{display:flex;align-items:center;gap:3px;}

  .shared-note{display:none;} /* Hidden */

  .clist{display:flex;flex-direction:column;gap:10px;}
  .ci{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:border-color .25s;}
  .ci.completed{border-color:rgba(56,217,169,.35);}
  .ci-head{display:flex;align-items:center;gap:10px;padding:14px 16px;cursor:pointer;user-select:none;}
  .ci-head:hover{background:rgba(255,255,255,.02);}
  .cnum{width:28px;height:28px;border-radius:50%;flex-shrink:0;background:var(--surface2);
    border:1px solid var(--border);display:flex;align-items:center;justify-content:center;
    font-size:11px;font-weight:700;font-family:'DM Mono',monospace;transition:all .25s;}
  .ci.completed .cnum{background:var(--success);border-color:var(--success);color:#0f2a22;}
  .clabel{flex:1;font-size:14px;font-weight:600;}
  .sbadge{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;
    padding:2px 7px;border-radius:20px;background:rgba(56,217,169,.12);
    color:var(--success);border:1px solid rgba(56,217,169,.25);flex-shrink:0;}
  .sbadge.nok{background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.3);}
  .sbadge.ok{background:rgba(56,217,169,.12);color:var(--success);border-color:rgba(56,217,169,.25);}
  .carrow{color:var(--text3);font-size:12px;transition:transform .25s;flex-shrink:0;}
  .ci.open .carrow{transform:rotate(180deg);}
  .ci-body{max-height:0;overflow:hidden;transition:max-height .35s ease;padding:0 16px;}
  .ci.open .ci-body{max-height:900px;padding:0 16px 16px;}

  .ci.deleted{opacity:0.25;pointer-events:none;}
  .ci.deleted .ci-head{pointer-events:auto;cursor:default;}
  .ci-actions{display:flex;gap:6px;flex-shrink:0;}
  .ci-trash,.ci-restore{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);
    background:var(--surface2);display:flex;align-items:center;justify-content:center;
    font-size:13px;cursor:pointer;transition:all .15s;flex-shrink:0;color:#fff;}
  .ci-trash:hover{border-color:#ff5c5c;background:rgba(255,92,92,.12);}
  .ci-restore{border-color:var(--success);background:rgba(56,217,169,.1);pointer-events:auto;color:#fff;}
  .ci-restore:hover{background:rgba(56,217,169,.2);}
  .ci-add{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);
    background:var(--surface2);display:flex;align-items:center;justify-content:center;
    font-size:16px;font-weight:700;cursor:pointer;transition:all .15s;flex-shrink:0;color:#fff;}
  .ci-add:hover{border-color:var(--border-hover);background:rgba(255,255,255,.08);}

  /* Inline toast */
  .toast-inline{display:none;background:#ff5c5c;color:#fff;font-size:13px;font-weight:600;
    padding:10px 18px;border-radius:12px;text-align:center;
    position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:9999;
    max-width:90vw;box-shadow:0 4px 20px rgba(0,0,0,.4);}
  .toast-inline.show{display:block;animation:fadeUp .2s ease;}
  .toast-inline.warn{background:#f39c12;}

  .thumbrow{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;}
  .twrap{position:relative;width:80px;height:80px;border-radius:var(--radius-sm);
    overflow:hidden;border:2px solid var(--border);cursor:pointer;transition:border-color .2s;}
  .twrap:hover{border-color:var(--accent);}
  .twrap img{width:100%;height:100%;object-fit:cover;display:block;}
  .edit-badge{position:absolute;bottom:0;left:0;right:0;background:rgba(79,142,247,.85);
    color:#fff;font-size:9px;font-weight:700;text-align:center;padding:3px 0;letter-spacing:.3px;}
  .tdel{position:absolute;top:3px;right:3px;width:18px;height:18px;border-radius:50%;
    background:rgba(0,0,0,.8);border:none;color:#fff;font-size:11px;cursor:pointer;
    display:flex;align-items:center;justify-content:center;z-index:2;}

  .photoarea{border:2px dashed var(--border);border-radius:var(--radius-sm);
    padding:22px 16px;text-align:center;cursor:pointer;transition:all .2s;
    position:relative;margin-bottom:10px;}
  .photoarea:hover{border-color:var(--accent);background:rgba(79,142,247,.04);}
  .photoarea input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
  .picon{font-size:24px;margin-bottom:5px;}
  .ptxt{font-size:13px;color:var(--text2);}

  textarea.note{width:100%;padding:10px 12px;background:var(--surface2);
    border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);
    font-family:'DM Sans',sans-serif;font-size:13px;resize:vertical;
    min-height:68px;outline:none;transition:border .2s;line-height:1.5;}
  textarea.note:focus{border-color:var(--accent);}
  textarea.note::placeholder{color:var(--text3);}

  /* Fields row (strings + mpp) */
  .fields-row{display:flex;gap:10px;margin-bottom:10px;}
  .fields-row>div{flex:1;}

  /* Location buttons */
  .loc-row{margin-bottom:10px;}
  .loc-row label{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;display:block;}
  .loc-btns{display:flex;gap:8px;width:100%;}
  .loc-btn{flex:1;padding:9px 10px;border-radius:var(--radius-sm);border:1px solid var(--border);
    background:var(--surface2);color:var(--text2);font-size:12px;font-weight:600;text-align:center;
    cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif;}
  .loc-btn:hover{border-color:var(--border-hover);}
  .loc-btn.active{background:rgba(56,217,169,.15);border-color:var(--success);color:var(--success);}
  .board-btns{display:flex;gap:8px;width:100%;}
  .board-btn{flex:1;padding:9px 10px;border-radius:var(--radius-sm);border:1px solid var(--border);
    background:var(--surface2);color:var(--text2);font-size:12px;font-weight:600;text-align:center;
    cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif;}
  .board-btn:hover{border-color:var(--border-hover);}
  .board-btn.active{background:rgba(56,217,169,.15);border-color:var(--success);color:var(--success);}
  .mount-btns{display:flex;gap:8px;width:100%;}
  .mount-btn{flex:1;padding:9px 10px;border-radius:var(--radius-sm);border:1px solid var(--border);
    background:var(--surface2);color:var(--text2);font-size:12px;font-weight:600;text-align:center;
    cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif;}
  .mount-btn:hover{border-color:var(--border-hover);}
  .mount-btn.active{background:rgba(56,217,169,.15);border-color:var(--success);color:var(--success);}

  /* ‚ïê‚ïê EDITOR OVERLAY ‚ïê‚ïê */
  #editor-overlay{position:fixed;inset:0;z-index:999;background:#0a0c14;
    display:none;flex-direction:column;}
  #editor-overlay.open{display:flex;}

  .ed-topbar{display:flex;align-items:center;gap:8px;padding:10px 14px;
    background:var(--surface);border-bottom:1px solid var(--border);flex-wrap:wrap;}
  .ed-title{font-size:13px;font-weight:700;color:var(--text);margin-right:4px;}

  .tool-sep{width:1px;height:26px;background:var(--border);margin:0 3px;flex-shrink:0;}
  .tbtn{width:36px;height:36px;border-radius:var(--radius-sm);border:1px solid var(--border);
    background:var(--surface2);color:var(--text);font-size:15px;cursor:pointer;
    display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
  .tbtn:hover{border-color:var(--border-hover);}
  .tbtn.active{background:var(--accent);border-color:var(--accent);}
  .tbtn.danger{border-color:rgba(255,92,92,.4);color:#ff5c5c;}
  .tbtn.danger:hover{background:rgba(255,92,92,.15);}

  .cswatch{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;
    transition:border .15s;flex-shrink:0;}
  .cswatch.active{border-color:#fff;box-shadow:0 0 0 2px rgba(255,255,255,.3);}

  .szb{padding:0 10px;height:32px;border-radius:var(--radius-sm);border:1px solid var(--border);
    background:var(--surface2);color:var(--text2);font-size:11px;font-weight:700;
    cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif;}
  .szb.active{background:var(--accent);border-color:var(--accent);color:#fff;}

  .ed-actions{display:flex;gap:6px;margin-left:auto;flex-shrink:0;}

  /* stamp tray */
  .stamp-tray{background:var(--surface);border-bottom:1px solid var(--border);
    padding:8px 14px;display:none;gap:8px;flex-wrap:wrap;align-items:center;}
  .stamp-tray.open{display:flex;}
  .stamp-tray-lbl{font-size:10px;font-weight:700;text-transform:uppercase;
    letter-spacing:.6px;color:var(--text2);}
  .sitem{display:flex;flex-direction:column;align-items:center;gap:3px;
    padding:6px 10px;border-radius:var(--radius-sm);border:1px solid var(--border);
    background:var(--surface2);cursor:pointer;transition:all .15s;}
  .sitem:hover{border-color:var(--accent);}
  .sitem.active{border-color:var(--accent);background:rgba(79,142,247,.15);}
  .sitem-img{width:48px;height:36px;display:flex;align-items:center;justify-content:center;}
  .sitem-lbl{font-size:9px;color:var(--text2);font-weight:600;text-align:center;line-height:1.3;}

  .ed-canvas-wrap{flex:1;display:flex;align-items:center;justify-content:center;
    overflow:auto;background:#0a0c14;padding:8px;}
  #ed-canvas{max-width:100%;touch-action:none;cursor:crosshair;display:block;border-radius:4px;}

  /* overview */
  .ov-block{background:var(--surface);border:1px solid var(--border);
    border-radius:var(--radius);margin-bottom:14px;overflow:hidden;}
  .ov-btitle{padding:14px 18px;border-bottom:1px solid var(--border);
    font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px;}
  .ov-row{display:flex;gap:12px;padding:12px 18px;border-bottom:1px solid var(--border);}
  .ov-row:last-child{border-bottom:none;}
  .ov-n{width:24px;height:24px;border-radius:50%;flex-shrink:0;background:var(--surface2);
    border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;}
  .ov-c{flex:1;}
  .ov-lbl{font-size:13px;font-weight:600;margin-bottom:4px;}
  .ov-note{font-size:12px;color:var(--text2);margin-bottom:6px;}
  .ov-photos{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:5px;}
  .ov-ph{width:54px;height:54px;object-fit:cover;border-radius:6px;border:1px solid var(--border);}
  .ov-st{font-size:11px;display:flex;align-items:center;gap:4px;}
  .stdot{width:7px;height:7px;border-radius:50%;}

  .suc{text-align:center;padding:60px 20px;animation:fadeUp .4s ease;}
  .suc-em{font-size:60px;display:block;margin-bottom:18px;
    animation:pop .5s cubic-bezier(.175,.885,.32,1.275);}
  @keyframes pop{0%{transform:scale(0)}100%{transform:scale(1)}}
  .suc-t{font-size:24px;font-weight:700;margin-bottom:8px;}
  .suc-s{color:var(--text2);font-size:13px;margin-bottom:28px;}

  @media(max-width:500px){.fields-row{flex-direction:column;}}
</style>
</head>
<body>

<header>
  <div class="logo" onclick="goBackToHub()" style="cursor:pointer">
    <img src="data:image/png;base64,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" alt="AE"/>
    <div class="logo-text">
      <span class="logo-title">Bezoekrapport</span>
      <span class="logo-datetime" id="header-datetime"></span>
    </div>
  </div>
  <div class="hstep" id="hstep"></div>
  <div id="cloud-status" style="display:none;font-size:11px;padding:4px 10px;border-radius:20px;font-weight:600;letter-spacing:.3px;margin-left:6px"></div>
</header>

<!-- ‚ïê‚ïê EDITOR ‚ïê‚ïê -->
<div id="editor-overlay">

  <div class="ed-topbar">
    <span class="ed-title">Foto bewerken</span>

    <!-- draw tools -->
    <button class="tbtn active" id="tool-arrow"  onclick="setTool('arrow')"  title="Pijl">‚û§</button>
    <button class="tbtn"        id="tool-line"   onclick="setTool('line')"   title="Lijn" style="font-size:18px;font-weight:700">‚ï±</button>
    <button class="tbtn"        id="tool-pen"    onclick="setTool('pen')"    title="Vrij tekenen">‚úèÔ∏è</button>
    <button class="tbtn"        id="tool-rect"   onclick="setTool('rect')"   title="Rechthoek" style="font-size:18px;font-weight:700">‚ñ°</button>
    <button class="tbtn"        id="tool-circle" onclick="setTool('circle')" title="Cirkel" style="font-size:20px;font-weight:700">‚óã</button>
    <button class="tbtn"        id="tool-text"   onclick="setTool('text')"   title="Tekst" style="font-size:16px;font-weight:700">T</button>
    <button class="tbtn"        id="tool-stamp"  onclick="toggleTray()"      title="Stempel">üè∑Ô∏è</button>
    <button class="tbtn"        id="tool-select" onclick="setTool('select')" title="Selecteren & Verplaatsen">üëÜ</button>

    <div class="tool-sep"></div>

    <!-- colours -->
    <div class="cswatch active" style="background:#ff3b30" onclick="setColor('#ff3b30',this)"></div>
    <div class="cswatch"        style="background:#f7c948" onclick="setColor('#f7c948',this)"></div>
    <div class="cswatch"        style="background:#34c759" onclick="setColor('#34c759',this)"></div>
    <div class="cswatch"        style="background:#0a84ff" onclick="setColor('#0a84ff',this)"></div>
    <div class="cswatch"        style="background:#ffffff" onclick="setColor('#ffffff',this)"></div>
    <div class="cswatch"        style="background:#000000;border:1px solid rgba(255,255,255,.3)" onclick="setColor('#000000',this)"></div>

    <div class="tool-sep"></div>
    <button class="tbtn" onclick="undoLast()" title="Ongedaan">‚Ü©Ô∏è</button>
    <button class="tbtn danger" id="tool-del-sel" onclick="deleteSelected()" title="Selectie verwijderen" style="display:none">‚úï</button>
    <div id="ed-font-ctrl" style="display:none">
      <button class="tbtn" onclick="changeFontSize(-4)" title="Kleiner" style="font-size:14px;width:32px;height:32px;font-weight:700">A-</button>
      <span id="ed-font-size" style="font-size:13px;color:var(--text);font-family:'DM Mono',monospace;min-width:28px;text-align:center;font-weight:700">18</span>
      <button class="tbtn" onclick="changeFontSize(4)" title="Groter" style="font-size:14px;width:32px;height:32px;font-weight:700">A+</button>
    </div>

    <div class="ed-actions">
      <button class="btn btn-p" onclick="saveEditor()" style="padding:8px 16px;font-size:13px">‚úÖ Opslaan</button>
      <button class="btn btn-s" onclick="closeEditor()" style="padding:8px 16px;font-size:13px;font-weight:600">Back</button>
    </div>
  </div>

  <!-- stamp tray -->
  <div class="stamp-tray" id="stamp-tray">
    <span class="stamp-tray-lbl">Stempels:</span>
    <div class="sitem" id="si-daikin-binnen" onclick="pickStamp('daikin-binnen',this)">
      <div class="sitem-img"><canvas id="prev-daikin-binnen" width="48" height="36"></canvas></div>
      <div class="sitem-lbl">Daikin<br>Binnenunit</div>
    </div>
    <div class="sitem" id="si-daikin-buiten" onclick="pickStamp('daikin-buiten',this)">
      <div class="sitem-img"><canvas id="prev-daikin-buiten" width="48" height="36"></canvas></div>
      <div class="sitem-lbl">Daikin<br>Buitenunit</div>
    </div>
  </div>

  <div class="ed-canvas-wrap">
    <canvas id="ed-canvas"></canvas>
    
    <!-- TEXT INPUT OVERLAY -->
    <div id="text-overlay" style="display:none;position:absolute;background:rgba(0,0,0,0.7);
      border:2px solid var(--accent);border-radius:var(--radius-sm);padding:8px;min-width:200px">
      <div style="display:flex;gap:6px;margin-bottom:8px;align-items:center">
        <label style="font-size:11px;color:var(--text2)">Grootte:</label>
        <select id="text-size" style="flex:1;padding:4px;background:var(--surface2);border:1px solid var(--border);
          color:var(--text);border-radius:4px;font-size:12px">
          <option value="14">Klein (14px)</option>
          <option value="18" selected>Normaal (18px)</option>
          <option value="24">Groot (24px)</option>
          <option value="32">Extra groot (32px)</option>
          <option value="48">Zeer groot (48px)</option>
        </select>
      </div>
      <textarea id="text-input" placeholder="Typ hier je tekst..."
        style="width:100%;min-height:80px;padding:8px;background:var(--surface);
        border:1px solid var(--border);border-radius:4px;color:var(--text);
        font-family:'DM Sans',sans-serif;font-size:14px;resize:vertical;outline:none"></textarea>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button onclick="cancelTextInput()" style="flex:1;padding:6px;background:var(--surface2);
          border:1px solid var(--border);border-radius:4px;color:var(--text);cursor:pointer;font-size:12px;font-weight:600">
          Back
        </button>
        <button onclick="confirmTextInput()" style="flex:1;padding:6px;background:var(--accent);
          border:none;border-radius:4px;color:#fff;cursor:pointer;font-weight:600;font-size:12px">
          OK
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê APP ‚ïê‚ïê -->
<main>
  <!-- STEP 1: HUB -->
  <div class="panel active" id="panel-1">
    <div class="ptitle">Verslag plaatsbezoek</div>
    <div class="psub">Klantgegevens</div>
    <div style="display:flex;gap:10px;margin-bottom:20px">
      <input type="text" id="klant-naam" class="note" placeholder="Naam klant" style="min-height:auto;padding:10px 12px;flex:1">
      <input type="text" id="klant-adres" class="note" placeholder="Adres" style="min-height:auto;padding:10px 12px;flex:1">
    </div>
    <div class="psub">Klik op een type om de checklist te starten</div>
    <div class="tgrid" id="hub-grid"></div>
    <!-- Save all button - appears when at least 1 checklist is done -->
    <div id="hub-save-row" style="display:none;margin-top:12px">
      <button class="btn btn-g" onclick="finalizeAllReports()" style="width:100%;padding:14px">‚úÖ Alles opslaan</button>
    </div>
  </div>

  <!-- STEP 2: CHECKLIST -->
  <div class="panel" id="panel-2">
    <div class="ptitle" id="checklist-title">Checklist</div>
    <div class="psub">Maak foto's, bewerk ze en voeg toelichting toe</div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">
      <div class="rtabs" id="rtabs" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap"></div>
    </div>
    <div class="progwrap">
      <div class="progmeta"><span id="prog-txt">0 van 0</span><span id="prog-pct">0%</span></div>
      <div class="progtrack"><div class="progfill" id="prog-fill" style="width:0%"></div></div>
      <div class="prog-scores" id="prog-scores"></div>
    </div>
    <div class="clist" id="clist"></div>
    <div class="brow" style="margin-top:24px">
      <button class="btn btn-s" onclick="goBackToHub()">‚Üê Terug</button>
      <button class="btn btn-p" onclick="saveChecklistAndReturn()">üíæ Bewaar</button>
      <button class="btn btn-s" id="btn-extra-split" onclick="addExtraSplit()" style="display:none">+ Extra monosplit</button>
      <button class="btn btn-s" id="btn-extra-multi-split" onclick="addExtraMultiSplit()" style="display:none">+ Extra multisplit</button>
    </div>
  </div>

  <!-- STEP 3: OVERVIEW -->
  <div class="panel" id="panel-3">
    <div class="ptitle">Overzicht</div>
    <div class="psub">Controleer alles voor je naar de AI controle gaat</div>
    <div id="overview"></div>
    <div class="brow" style="margin-top:24px">
      <button class="btn btn-s" onclick="goStep(2)">‚Üê Terug</button>
      <button class="btn btn-p" onclick="showAICheck()" style="background:linear-gradient(135deg,#f7c948,#e8b738);color:#3a2800">
        ü§ñ AI Controle
      </button>
    </div>
  </div>

  <!-- STEP 3.5: AI CHECK -->
  <div class="panel" id="panel-ai">
    <div class="ptitle">ü§ñ AI Controle</div>
    <div class="psub">Controleren of alle info compleet is voor de technieker</div>
    
    <div id="ai-result" style="background:var(--surface);border:1px solid var(--border);
      border-radius:var(--radius);padding:24px;margin-bottom:24px;min-height:200px">
      <div style="text-align:center;padding:40px 20px">
        <div style="color:var(--text2);font-size:14px">Klik op "Controle uitvoeren" om te beginnen</div>
      </div>
    </div>

    <div class="brow">
      <button class="btn btn-s" onclick="goStep(3)">‚Üê Terug</button>
      <button class="btn btn-p" id="btn-run-ai" onclick="runAICheck()" style="background:linear-gradient(135deg,#f7c948,#e8b738);color:#3a2800">
        ‚ñ∂Ô∏è Controle uitvoeren
      </button>
      <button class="btn btn-p" id="btn-after-ai" onclick="finalizeAllReports()" style="display:none">
        ‚úÖ Alles opslaan
      </button>
    </div>
  </div>

  <!-- SUCCESS -->
  <div class="panel" id="panel-4">
    <div class="suc">
      <span class="suc-em">‚úÖ</span>
      <div class="suc-t">Rapport opgeslagen!</div>
      <div class="suc-s" id="suc-msg"></div>
      <button class="btn btn-p" onclick="generatePDF()" style="margin-bottom:10px">üìÑ Download PDF</button>
      <div id="sync-status-panel" style="margin-bottom:12px;font-size:13px;color:var(--text2)"></div>
      <button class="btn btn-s" onclick="backToHub()" style="margin-bottom:10px">‚Üê Terug</button>
      <button class="btn btn-s" onclick="reset()">+ Nieuw rapport</button>
    </div>
  </div>
</main>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TYPES = {
  solar: { label:'Zon / Thuisbatterij', icon:'‚òÄÔ∏èüîã', cls:'solar', items:[
    {key:'woning',    label:'Woning',                     shared:true, optional:true},
    {key:'dak',       label:'Dak ‚òÄÔ∏è',                     shared:false, optional:true},
    {key:'traject',   label:'Kabelroute DC kabels',       shared:false, optional:true},
    {key:'omvormer',  label:'Omvormer',                   shared:true, hasStrings:true, hasMppTrackers:true, hasLocation:true, hasMeterType:true},
    {key:'loc-bat',   label:'Locatie thuisbatterij üîã',   shared:false, hasLocation:true, hasBatCalc:true, optional:true},
    {key:'internet',  label:'Internet locatie üîã',        shared:false, optional:true},
    {key:'elek-bord', label:'Elektrisch bord',            shared:true, hasPhaseType:true, hasBoardType:true},
    {key:'hoofdzek',  label:'Zekering digitale meter',  shared:true},
  ]},
  airmo: { label:'Lucht/Lucht Mono', icon:'üå°Ô∏è', cls:'airmo', items:[
    {key:'woning',       label:'Woning',                  shared:true, optional:true},
    {key:'buitenunit',   label:'Buitenunit',              shared:false, hasFixType:true},
    {key:'binnenunit',   label:'Binnenunit',              shared:false, hasUnitType:true},
    {key:'elek-aansl',   label:'Elektrische aansluiting', shared:false, hasConnType:true},
    {key:'beschrijving', label:'Beschrijving project',    shared:false, noPhoto:true},
  ]},
  airmu: { label:'Lucht/Lucht Multi', icon:'üå°Ô∏è', cls:'airmu', items:[
    {key:'woning',          label:'Woning',                  shared:true, optional:true},
    {key:'buitenunit-m',    label:'Buitenunit',              shared:false, hasFixType:true},
    {key:'binnenunit-m-1',  label:'Binnenunit 1/2',          shared:false, hasUnitType:true},
    {key:'binnenunit-m-2',  label:'Binnenunit 2/2',          shared:false, hasUnitType:true},
    {key:'elek-aansl-m',    label:'Elektrische aansluiting', shared:false, hasConnType:true},
    {key:'beschrijving-m',  label:'Beschrijving project',    shared:false, noPhoto:true},
  ]},
  airwater: { label:'Lucht/Water', icon:'üíß', cls:'airwater', items:[
    {key:'woning',            label:'Woning',                  shared:true, optional:true, hasFuelType:true},
    {key:'vloervw-w',         label:'Vloerverwarming',         shared:false, hasSqm:true, optional:true},
    {key:'radiatoren-w',      label:'Radiatoren',              shared:false, hasRadRows:true, optional:true},
    {key:'buitenunit-w',      label:'Buitenunit',              shared:false, hasFixType:true, hasPowerCalc:true},
    {key:'binnenunit-w',      label:'Binnenunit',              shared:false, hasUnitType:true},
    {key:'elek-bord',        label:'Elektrisch bord',         shared:true, hasPhaseType:true, hasBoardType:true},
    {key:'hoofdzek',         label:'Zekering digitale meter', shared:true},
    {key:'beschrijving-w',    label:'Beschrijving project',    shared:false, noPhoto:true},
  ]},
  geo: { label:'Geothermie', icon:'üåç', cls:'geo', items:[
    {key:'woning',            label:'Woning',                  shared:true, optional:true, hasFuelType:true},
    {key:'vloervw-g',         label:'Vloerverwarming',         shared:false, hasSqm:true, optional:true},
    {key:'radiatoren-g',      label:'Radiatoren',              shared:false, hasRadRows:true, optional:true},
    {key:'binnenunit-g',      label:'Binnenunit',              shared:false, hasUnitType:true},
    {key:'geo-info',           label:'Geothermische info',      shared:false, hint:"Foto's van locatie waar putten komen en waar leidingen binnen komen.", noteHint:"Beschrijf het traject van aan de geothermische toegang tot aan warmtepomp."},
    {key:'wifi-voelers-g',     label:'Wifi en voelers',         shared:false, hint:"Foto's van locatie wifi, binnenvoeler en buitenvoeler.", noteHint:"Omschrijving van kabeltraject voor wifi, binnenvoeler en buitenvoeler."},
    {key:'elek-bord',        label:'Elektrisch bord',         shared:true, hasPhaseType:true, hasBoardType:true},
    {key:'hoofdzek',         label:'Zekering digitale meter', shared:true},
    {key:'beschrijving-g',    label:'Beschrijving project',    shared:false, noPhoto:true},
  ]},
  charge: { label:'Laadpaal', icon:'‚ö°', cls:'charge', items:[
    {key:'woning',          label:'Woning',                shared:true, optional:true},
    {key:'loc-laadpunt',    label:'Locatie laadpunt',      shared:false, hasMountType:true},
    {key:'internet',        label:'Internet locatie',      shared:false},
    {key:'elek-bord',       label:'Elektrisch bord',       shared:true, hasPhaseType:true, hasBoardType:true},
    {key:'hoofdzek',        label:'Zekering digitale meter', shared:true},
    {key:'kabelroute',      label:'Kabelroute',            shared:false},
    {key:'beschrijving-c',  label:'Beschrijving project',  shared:false, noPhoto:true},
  ]}
};

const STAMPS = {
  'daikin-binnen':{ label:'Daikin Binnenunit', emoji:null, draw: drawBinnen },
  'daikin-buiten':{ label:'Daikin Buitenunit', emoji:null, draw: drawBuiten },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selected=[], activeTab='', itemData={}, completedTypes=new Set(), deletedItems=new Set(), extraSplitCount=0, extraMultiSplitCount=0;

// Always use shared key for shared items (data stored once)
function getSK(type,item){
  return item.shared ? item.key : type+'_'+item.key;
}
function sharedHasDataElsewhere(key,currentType){
  // Check if any OTHER completed checklist has data for this shared key
  for(const type of completedTypes){
    if(type===currentType) continue;
    const def=TYPES[type];
    if(!def) continue;
    const hasKey=def.items.some(i=>i.shared&&i.key===key);
    if(hasKey){
      const sk=key; // shared keys use just the key
      const d=itemData[sk];
      if(d&&(d.photos.length>0||d.notes.trim()!=='')) return true;
    }
  }
  return false;
}

function itemsForTab(type){
  const activeTypes=[...new Set([...selected,...completedTypes])];
  const both=activeTypes.length>1;
  // Find shared keys across all active types
  let sharedKeys=new Set();
  if(both){
    const allItems={};
    activeTypes.forEach(t=>{if(TYPES[t])TYPES[t].items.forEach(i=>{if(!allItems[i.key])allItems[i.key]=0;allItems[i.key]++;});});
    Object.entries(allItems).forEach(([k,c])=>{if(c>1)sharedKeys.add(k);});
  }
  return TYPES[type].items.map(item=>({...item,
    isShared:both&&item.shared&&sharedKeys.has(item.key),
    sk:getSK(type,item)
  }));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATE/TIME in header
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDateTime(){
  const now=new Date();
  const dd=String(now.getDate()).padStart(2,'0');
  const mm=String(now.getMonth()+1).padStart(2,'0');
  const yyyy=now.getFullYear();
  const hh=String(now.getHours()).padStart(2,'0');
  const mi=String(now.getMinutes()).padStart(2,'0');
  document.getElementById('header-datetime').textContent=`${dd}/${mm}/${yyyy} ‚Äî ${hh}:${mi}`;
}
updateDateTime();
setInterval(updateDateTime,60000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HUB (Step 1)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openChecklist(type){
  if(!selected.includes(type)) selected.push(type);
  activeTab=type;
  showPanel('panel-2');
  renderChecklist();
  window.scrollTo({top:0,behavior:'smooth'});
}

function goBackToHub(){
  showPanel('panel-1');
  updateHubCards();
  window.scrollTo({top:0,behavior:'smooth'});
}

function backToHub(){
  showPanel('panel-1');
  updateHubCards();
  window.scrollTo({top:0,behavior:'smooth'});
}

function showPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function calculateScores(type){
  const items=TYPES[type].items;
  // Filter out deleted items
  const activeItems=items.filter(item=>!deletedItems.has(getSK(type,item)));
  let photoScore=0, textScore=0;
  const total=activeItems.length;
  const photoItems=activeItems.filter(i=>!i.noPhoto);
  const photoTotal=photoItems.length;
  if(total===0) return {photo:0,text:0};
  const perTextItem=100/total;
  const perPhotoItem=photoTotal>0?100/photoTotal:0;
  activeItems.forEach(item=>{
    const sk=getSK(type,item);
    const d=itemData[sk]||{photos:[],notes:'',strings:'',mppTrackers:'',location:''};
    if(!item.noPhoto && d.photos.length>0) photoScore+=perPhotoItem;
    if(d.notes.trim().length>=10) textScore+=perTextItem;
    else if(d.notes.trim().length>0) textScore+=perTextItem*0.5;
  });
  return {photo:Math.round(photoScore),text:Math.round(textScore)};
}

function scoreColorClass(val){
  if(val>=100) return 'green';
  if(val<=50) return 'red';
  return '';
}

const HUB_ORDER=[
  {key:'solar'},{key:'charge'},
  {key:'airmo'},{key:'airmu'},
  {key:'airwater'},{key:'geo'}
];

function renderHubGrid(){
  const grid=document.getElementById('hub-grid');
  let html='';
  HUB_ORDER.forEach(h=>{
    if(h.disabled){
      html+=`<div class="tcard disabled"><div class="ticon">${h.icon}</div><div class="tname">Checklist ${h.label}</div><div class="tsoon">Binnenkort</div></div>`;
      return;
    }
    const def=TYPES[h.key];
    if(!def) return;
    html+=`<div class="tcard clickable ${def.cls}" id="hub-${h.key}" onclick="openChecklist('${h.key}')">
      <div class="tck">‚úì</div>
      <div class="ticon">${def.icon}</div>
      <div class="tname">Checklist ${def.label}</div>
      <div class="score-badges" id="scores-${h.key}"></div>
    </div>`;
  });
  // Add dynamic split cards
  for(let i=1;i<=extraSplitCount;i++){
    const key='airmo-'+i;
    if(TYPES[key]){
      html+=`<div class="tcard clickable airmo" id="hub-${key}" onclick="openChecklist('${key}')">
        <div class="tck">‚úì</div><div class="ticon">üå°Ô∏è</div>
        <div class="tname">Checklist ${TYPES[key].label}</div>
        <div class="score-badges" id="scores-${key}"></div>
      </div>`;
    }
  }
  for(let i=1;i<=extraMultiSplitCount;i++){
    const key='airmu-'+i;
    if(TYPES[key]){
      html+=`<div class="tcard clickable airmu" id="hub-${key}" onclick="openChecklist('${key}')">
        <div class="tck">‚úì</div><div class="ticon">üå°Ô∏è</div>
        <div class="tname">Checklist ${TYPES[key].label}</div>
        <div class="score-badges" id="scores-${key}"></div>
      </div>`;
    }
  }
  grid.innerHTML=html;
}

function updateHubCards(){
  renderHubGrid();
  const allTypes=['solar','airmo','airmu','airwater','geo','charge'];
  for(let i=1;i<=extraSplitCount;i++) allTypes.push('airmo-'+i);
  for(let i=1;i<=extraMultiSplitCount;i++) allTypes.push('airmu-'+i);
  allTypes.forEach(type=>{
    const card=document.getElementById('hub-'+type);
    const scoresEl=document.getElementById('scores-'+type);
    if(!card||!scoresEl) return;
    if(completedTypes.has(type)){
      card.classList.add('completed');
      const scores=calculateScores(type);
      scoresEl.innerHTML=`
        <span class="score-badge" data-tip="${scores.photo}% foto's">üì∑ <span class="score-val ${scoreColorClass(scores.photo)}">${scores.photo}%</span></span>
        <span class="score-badge" data-tip="${scores.text}% uitleg">üìù <span class="score-val ${scoreColorClass(scores.text)}">${scores.text}%</span></span>`;
    } else {
      card.classList.remove('completed');
      scoresEl.innerHTML='';
    }
  });
  document.getElementById('hub-save-row').style.display=completedTypes.size>0?'block':'none';
  document.getElementById('hstep').textContent='';
}

function discardChecklist(){
  if(!activeTab) return;
  const type=activeTab;
  const items=itemsForTab(type);
  // Check which other checklists are still active
  const otherActive=selected.filter(t=>t!==type);
  const otherSharedKeys=new Set();
  otherActive.forEach(t=>{
    if(TYPES[t]) TYPES[t].items.forEach(i=>{if(i.shared) otherSharedKeys.add(i.key);});
  });
  // Clear item data - only non-shared or shared not used elsewhere
  items.forEach(item=>{
    if(item.shared && otherSharedKeys.has(item.key)) return; // keep shared data for other checklists
    if(itemData[item.sk]){
      itemData[item.sk]={photos:[],notes:'',strings:'',mppTrackers:'',location:'',boardType:{},mountType:'',fixType:'',unitType:'',connType:'',sqm:'',floor:'',sqmRows:[],radRows:[],fuelType:'',fuelAmount:'',buildYear:'',meterType:[],phaseType:'',insulation:'',woningType:'',heatedFloors:'',totalSqm:'',boilerTemp:'',batType:'',batVerbruik:'',batProductie:'',batAfname:'',batInjectie:''};
    }
    deletedItems.delete(item.sk);
  });
  // Remove from completed and selected
  completedTypes.delete(type);
  const idx=selected.indexOf(type);
  if(idx>-1) selected.splice(idx,1);
  // Reset solar label if needed
  if(type==='solar'){
    TYPES['solar'].label='Zon / Thuisbatterij';
    TYPES['solar'].icon='‚òÄÔ∏èüîã';
  }
  // If other checklists remain, switch to previous one
  if(selected.length>0){
    activeTab=selected[selected.length-1];
    renderChecklist();
    window.scrollTo({top:0,behavior:'smooth'});
  } else {
    activeTab=null;
    showPanel('panel-1');
    updateHubCards();
    window.scrollTo({top:0,behavior:'smooth'});
  }
}

function saveChecklistAndReturn(){
  const items=itemsForTab(activeTab);
  const isExtraAirmo=activeTab==='airmo'||activeTab.startsWith('airmo-');
  const isExtraAirmu=activeTab==='airmu'||activeTab.startsWith('airmu-');
  const isSplitType=isExtraAirmo||isExtraAirmu;

  // Check if at least 1 item has data (photo or text)
  // For splits: only count non-shared (own) items
  const activeItems=items.filter(i=>!deletedItems.has(i.sk));
  const hasOwnData=activeItems.some(item=>{
    if(isSplitType && item.shared) return false; // shared data doesn't count for splits
    const d=itemData[item.sk];
    if(!d) return false;
    return d.photos.length>0 || d.notes.trim()!=='';
  });

  // For splits: empty split gets removed silently
  if(isExtraAirmo && !hasOwnData){
    removeEmptyAirmo(activeTab);
    goBackToHub();
    return;
  }
  if(isExtraAirmu && !hasOwnData){
    removeEmptyAirmu(activeTab);
    goBackToHub();
    return;
  }

  // For all types: need at least 1 filled item to complete
  if(!hasOwnData){
    goBackToHub();
    return;
  }

  for(const item of items){
    if(deletedItems.has(item.sk)) continue;
    if(item.hasStrings||item.hasMppTrackers){
      const d=itemData[item.sk]||{};
      if(item.hasStrings && (!d.strings||d.strings.trim()==='')){
        showToast(item.sk,'Aantal strings is verplicht');return;
      }
      if(item.hasMppTrackers && (!d.mppTrackers||d.mppTrackers.trim()==='')){
        showToast(item.sk,'Aantal MPP trackers is verplicht');return;
      }
    }
    if(item.hasLocation){
      const d=itemData[item.sk]||{};
      if(!d.location){
        showToast(item.sk,`Locatie ${item.label.toLowerCase()} is verplicht`);return;
      }
    }
    if(item.hasFixType){
      const d=itemData[item.sk]||{};
      if(!d.fixType){
        showToast(item.sk,'Bevestigingstechniek verplicht');return;
      }
    }
    if(item.hasUnitType){
      const d=itemData[item.sk]||{};
      if(!d.unitType){
        showToast(item.sk,'Type binnenunit verplicht');return;
      }
    }
    if(item.hasPhaseType){
      const d=itemData[item.sk]||{};
      if(!d.phaseType){
        showToast(item.sk,'Type aansluiting is verplicht');
        const ci=document.getElementById('ci-'+item.sk);
        if(ci) ci.classList.add('open');
        ci.scrollIntoView({behavior:'smooth',block:'center'});
        return;
      }
    }
  }
  completedTypes.add(activeTab);
  saveToLocalStorage();
  goBackToHub();
}

function removeEmptyAirmo(typeKey){
  // Remove from selected
  selected=selected.filter(t=>t!==typeKey);
  // Remove from completedTypes
  completedTypes.delete(typeKey);
  // If it's an extra (not the original airmo), remove hub card and type
  if(typeKey.startsWith('airmo-')){
    const card=document.getElementById('hub-'+typeKey);
    if(card) card.remove();
    delete TYPES[typeKey];
    extraSplitCount--;
    // Renumber remaining
    if(extraSplitCount>0){
      updateMonoLabels();
      updateMonoHubCards();
    } else {
      // Back to single mono ‚Äî reset name
      TYPES['airmo'].label='Lucht/Lucht Mono';
      const origName=document.querySelector('#hub-airmo .tname');
      if(origName) origName.textContent='Lucht/Lucht Mono';
    }
  }
}

function removeEmptyAirmu(typeKey){
  selected=selected.filter(t=>t!==typeKey);
  completedTypes.delete(typeKey);
  if(typeKey.startsWith('airmu-')){
    const card=document.getElementById('hub-'+typeKey);
    if(card) card.remove();
    delete TYPES[typeKey];
    extraMultiSplitCount--;
    if(extraMultiSplitCount>0){
      updateMultiLabels();
      updateMultiHubCards();
    } else {
      TYPES['airmu'].label='Lucht/Lucht Multi';
      const origName=document.querySelector('#hub-airmu .tname');
      if(origName) origName.textContent='Lucht/Lucht Multi';
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP 2: CHECKLIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addExtraSplit(){
  // Mark current mono as completed only if at least 1 non-shared item has data
  const curItems=itemsForTab(activeTab);
  const hasCurData=curItems.filter(i=>!deletedItems.has(i.sk)).some(item=>{
    if(item.shared) return false;
    const d=itemData[item.sk];
    return d && (d.photos.length>0 || d.notes.trim()!=='');
  });
  if(hasCurData) completedTypes.add(activeTab);
  extraSplitCount++;
  const newKey='airmo-'+extraSplitCount;
  const totalMono=extraSplitCount+1; // original airmo + extras
  // Create new type dynamically
  TYPES[newKey]={label:`Lucht/Lucht Mono ${totalMono}/${totalMono}`, icon:'üå°Ô∏è', cls:'airmo', items:[
    {key:'woning',                             label:'Woning',                  shared:true, optional:true},
    {key:'buitenunit-e'+extraSplitCount,       label:'Buitenunit',              shared:false, hasFixType:true},
    {key:'binnenunit-e'+extraSplitCount,       label:'Binnenunit',              shared:false, hasUnitType:true},
    {key:'elek-aansl-e'+extraSplitCount,       label:'Elektrische aansluiting', shared:false, hasConnType:true},
    {key:'beschrijving-e'+extraSplitCount,     label:'Beschrijving project',    shared:false, noPhoto:true},
  ]};
  // Rename all mono labels with n/total
  updateMonoLabels();
  // Add to selected and switch to it
  if(!selected.includes(newKey)) selected.push(newKey);
  activeTab=newKey;
  // Add hub card dynamically
  const hubGrid=document.getElementById('hub-grid');
  const disabledCards=hubGrid.querySelectorAll('.tcard.disabled');
  const newCard=document.createElement('div');
  newCard.className='tcard clickable airmo';
  newCard.id='hub-'+newKey;
  newCard.onclick=()=>openChecklist(newKey);
  newCard.innerHTML=`<div class="tck">‚úì</div><div class="ticon">üå°Ô∏è</div><div class="tname">${TYPES[newKey].label}</div><div class="score-badges" id="scores-${newKey}"></div>`;
  if(disabledCards.length>0) hubGrid.insertBefore(newCard,disabledCards[0]);
  else hubGrid.appendChild(newCard);
  // Update all hub card names
  updateMonoHubCards();
  renderChecklist();
  window.scrollTo({top:0,behavior:'smooth'});
}

function updateMonoLabels(){
  const total=extraSplitCount+1;
  // Rename original airmo
  TYPES['airmo'].label=`Lucht/Lucht Mono 1/${total}`;
  // Rename extras
  for(let i=1;i<=extraSplitCount;i++){
    TYPES['airmo-'+i].label=`Lucht/Lucht Mono ${i+1}/${total}`;
  }
}

function updateMonoHubCards(){
  const total=extraSplitCount+1;
  // Update original
  const origName=document.querySelector('#hub-airmo .tname');
  if(origName) origName.textContent=TYPES['airmo'].label;
  // Update extras
  for(let i=1;i<=extraSplitCount;i++){
    const name=document.querySelector('#hub-airmo-'+i+' .tname');
    if(name) name.textContent=TYPES['airmo-'+i].label;
  }
}

function addExtraMultiSplit(){
  const curItems=itemsForTab(activeTab);
  const hasCurData=curItems.filter(i=>!deletedItems.has(i.sk)).some(item=>{
    if(item.shared) return false;
    const d=itemData[item.sk];
    return d && (d.photos.length>0 || d.notes.trim()!=='');
  });
  if(hasCurData) completedTypes.add(activeTab);
  extraMultiSplitCount++;
  const newKey='airmu-'+extraMultiSplitCount;
  const totalMulti=extraMultiSplitCount+1;
  TYPES[newKey]={label:`Lucht/Lucht Multi ${totalMulti}/${totalMulti}`, icon:'üå°Ô∏è', cls:'airmu', items:[
    {key:'woning',                                  label:'Woning',                  shared:true, optional:true},
    {key:'buitenunit-mu'+extraMultiSplitCount,      label:'Buitenunit',              shared:false, hasFixType:true},
    {key:'binnenunit-mu'+extraMultiSplitCount+'-1', label:'Binnenunit 1/2',          shared:false, hasUnitType:true},
    {key:'binnenunit-mu'+extraMultiSplitCount+'-2', label:'Binnenunit 2/2',          shared:false, hasUnitType:true},
    {key:'elek-aansl-mu'+extraMultiSplitCount,      label:'Elektrische aansluiting', shared:false, hasConnType:true},
    {key:'beschrijving-mu'+extraMultiSplitCount,    label:'Beschrijving project',    shared:false, noPhoto:true},
  ]};
  updateMultiLabels();
  if(!selected.includes(newKey)) selected.push(newKey);
  activeTab=newKey;
  const hubGrid=document.getElementById('hub-grid');
  const disabledCards=hubGrid.querySelectorAll('.tcard.disabled');
  const newCard=document.createElement('div');
  newCard.className='tcard clickable airmu';
  newCard.id='hub-'+newKey;
  newCard.onclick=()=>openChecklist(newKey);
  newCard.innerHTML=`<div class="tck">‚úì</div><div class="ticon">üå°Ô∏è</div><div class="tname">${TYPES[newKey].label}</div><div class="score-badges" id="scores-${newKey}"></div>`;
  if(disabledCards.length>0) hubGrid.insertBefore(newCard,disabledCards[0]);
  else hubGrid.appendChild(newCard);
  updateMultiHubCards();
  renderChecklist();
  window.scrollTo({top:0,behavior:'smooth'});
}

function updateMultiLabels(){
  const total=extraMultiSplitCount+1;
  TYPES['airmu'].label=`Lucht/Lucht Multi 1/${total}`;
  for(let i=1;i<=extraMultiSplitCount;i++){
    TYPES['airmu-'+i].label=`Lucht/Lucht Multi ${i+1}/${total}`;
  }
}

function updateMultiHubCards(){
  const total=extraMultiSplitCount+1;
  const origName=document.querySelector('#hub-airmu .tname');
  if(origName) origName.textContent=TYPES['airmu'].label;
  for(let i=1;i<=extraMultiSplitCount;i++){
    const name=document.querySelector('#hub-airmu-'+i+' .tname');
    if(name) name.textContent=TYPES['airmu-'+i].label;
  }
}

function countInnerUnits(typeKey){
  if(!TYPES[typeKey]) return 0;
  return TYPES[typeKey].items.filter(i=>i.key.startsWith('binnenunit-')).length;
}

function getInnerKeyPrefix(typeKey){
  if(typeKey==='airmu') return 'binnenunit-m-';
  // airmu-1 -> binnenunit-mu1-, airmu-2 -> binnenunit-mu2-, etc.
  const num=typeKey.replace('airmu-','');
  return 'binnenunit-mu'+num+'-';
}

function addExtraInnerUnit(){
  const typeKey=activeTab;
  const current=countInnerUnits(typeKey);
  if(current>=5){
    // Find last binnenunit sk for toast
    const innerItems=TYPES[typeKey].items.filter(i=>i.key.startsWith('binnenunit-'));
    const lastInner=innerItems[innerItems.length-1];
    if(lastInner){
      const sk=getSK(typeKey,lastInner);
      showToast(sk,'Slechts 5 binnenunits mogelijk');
    }
    return;
  }
  const newCount=current+1;
  const prefix=getInnerKeyPrefix(typeKey);
  const newItem={key:prefix+newCount, label:`Binnenunit ${newCount}/${newCount}`, shared:false, hasUnitType:true};
  // Insert before elektrische aansluiting
  const items=TYPES[typeKey].items;
  const elekIdx=items.findIndex(i=>i.key.startsWith('elek-aansl'));
  if(elekIdx!==-1) items.splice(elekIdx,0,newItem);
  else items.push(newItem);
  // Renumber all binnenunit labels
  renumberInnerUnits(typeKey);
  renderItems();updateProgress();
  // Open the newly added binnenunit
  const newSk=getSK(typeKey,newItem);
  const ci=document.getElementById('ci-'+newSk);
  if(ci){
    document.querySelectorAll('.ci.open').forEach(e=>e.classList.remove('open'));
    ci.classList.add('open');
    ci.scrollIntoView({behavior:'smooth',block:'center'});
  }
}

function renumberInnerUnits(typeKey){
  const items=TYPES[typeKey].items;
  const innerItems=items.filter(i=>i.key.startsWith('binnenunit-'));
  const total=innerItems.length;
  innerItems.forEach((item,idx)=>{
    item.label=`Binnenunit ${idx+1}/${total}`;
  });
}

function removeLastInnerUnit(){
  const typeKey=activeTab;
  const current=countInnerUnits(typeKey);
  if(current<=2) return;
  const items=TYPES[typeKey].items;
  const innerItems=items.filter(i=>i.key.startsWith('binnenunit-'));
  const lastItem=innerItems[innerItems.length-1];
  // Remove from items array
  const idx=items.indexOf(lastItem);
  if(idx!==-1) items.splice(idx,1);
  // Clean up data
  const sk=getSK(typeKey,lastItem);
  delete itemData[sk];
  deletedItems.delete(sk);
  renumberInnerUnits(typeKey);
  renderItems();updateProgress();
}

function calcPowerEstimate(typeKey){
  // Get woning data (shared key)
  const woningSk='woning';
  const woningData=itemData[woningSk];
  if(!woningData) return null;
  const fuel=woningData.fuelType;
  const fuelAmount=parseFloat(woningData.fuelAmount);
  const buildYear=parseInt(woningData.buildYear);
  if(!fuel||isNaN(fuelAmount)||fuelAmount<=0||isNaN(buildYear)||buildYear<1900) return null;

  // Get vloerverwarming data - suffix depends on type
  const suffix=typeKey==='geo'?'-g':'-w';
  const vloerSk=getSK(typeKey,{shared:false,key:'vloervw'+suffix});
  const vloerData=itemData[vloerSk];
  const vloerDeleted=deletedItems.has(vloerSk);
  let totalSqm=0;
  if(vloerData&&vloerData.sqmRows&&!vloerDeleted){
    vloerData.sqmRows.forEach(r=>{if(r.sqm&&parseFloat(r.sqm)>0)totalSqm+=parseFloat(r.sqm);});
  }

  // Get radiatoren data
  const radSk=getSK(typeKey,{shared:false,key:'radiatoren'+suffix});
  const radData=itemData[radSk];
  const radDeleted=deletedItems.has(radSk);
  let totalRad=0;
  if(radData&&radData.radRows&&!radDeleted){
    radData.radRows.forEach(r=>{if(r.count&&parseInt(r.count)>0)totalRad+=parseInt(r.count);});
  }

  // Need at least one heat distribution system
  if(totalSqm===0&&totalRad===0) return null;

  // Get extra woning data
  const heatedFloors=parseInt(woningData.heatedFloors)||0;
  const woningTotalSqm=parseInt(woningData.totalSqm)||0;

  // 1. Convert fuel to kWh/year
  const kwhPerUnit=10; // 1m¬≥ gas ‚âà 10 kWh, 1L mazout ‚âà 10 kWh
  const brutokWh=fuelAmount*kwhPerUnit;

  // 2. Boiler efficiency based on build year
  let rendement;
  if(buildYear<1970) rendement=0.70;
  else if(buildYear<1990) rendement=0.80;
  else if(buildYear<2010) rendement=0.88;
  else rendement=0.95;

  // 3. Net heat demand
  const warmtebehoefte=brutokWh*rendement;

  // 4. Full load hours based on heat distribution
  // Estimate radiator coverage: each radiator ~15m¬≤
  const radSqmEstimate=totalRad*15;
  const totalCoverage=totalSqm+radSqmEstimate;
  let vollasturen;
  if(totalCoverage>0){
    const vloerFractie=totalSqm/totalCoverage;
    vollasturen=vloerFractie*1800+(1-vloerFractie)*1500;
  } else {
    vollasturen=1600;
  }

  // 4b. Boiler temperature correction
  // Higher boiler temp means lower COP for heat pump ‚Üí need more electrical power
  // Warmtepomp is meest effici√´nt bij lage watertemp (35¬∞C vloerverwarming)
  // Bij hogere temp (radiatoren 55-65¬∞C) daalt COP significant
  const ketelTemp=parseInt(woningData.boilerTemp)||0;
  let tempCorrectie=1.0;
  if(ketelTemp>0){
    if(ketelTemp<=35) tempCorrectie=0.90;       // lage temp = zeer effici√´nt
    else if(ketelTemp<=45) tempCorrectie=0.95;   // vloerverwarming standaard
    else if(ketelTemp<=55) tempCorrectie=1.05;   // gemiddelde radiatoren
    else if(ketelTemp<=65) tempCorrectie=1.15;   // hoge temp radiatoren
    else if(ketelTemp<=70) tempCorrectie=1.25;   // grens geschiktheid
    // >70 wordt afgevangen door popup
  }

  // 5. Insulation correction - use actual insulation data if available, fallback to buildYear
  const insulation=woningData.insulation||'';
  let correctie;
  if(insulation==='geen') correctie=1.25;
  else if(insulation==='origineel') correctie=1.10;
  else if(insulation==='goed') correctie=1.0;
  else if(insulation==='nieuwbouw') correctie=0.85;
  else if(buildYear<1970) correctie=1.15;
  else if(buildYear<1990) correctie=1.05;
  else correctie=1.0;

  // 5b. Housing type correction
  const wType=woningData.woningType||'';
  let woningCorrectie=1.0;
  if(wType==='vrijstaand') woningCorrectie=1.15;
  else if(wType==='halfopen') woningCorrectie=1.05;
  else if(wType==='rijwoning') woningCorrectie=0.95;
  else if(wType==='appartement') woningCorrectie=0.85;

  // 5c. Heated floors correction - more floors = more distribution loss
  let floorsCorrectie=1.0;
  if(heatedFloors===3) floorsCorrectie=1.05;
  else if(heatedFloors>=4) floorsCorrectie=1.10;

  // 5d. Cross-check with total heated area if available
  // Use woningTotalSqm to validate/adjust the estimate
  let oppCorrectie=1.0;
  if(woningTotalSqm>0&&totalCoverage>0){
    // If actual heated area is larger than estimated coverage, scale up
    const ratio=woningTotalSqm/totalCoverage;
    if(ratio>1.3) oppCorrectie=Math.min(ratio*0.85,1.3); // cap at 1.3
    else if(ratio<0.7) oppCorrectie=Math.max(ratio*1.1,0.8); // floor at 0.8
  }

  // 6. Calculate power
  let vermogen=(warmtebehoefte/vollasturen)*correctie*woningCorrectie*floorsCorrectie*oppCorrectie*tempCorrectie;
  vermogen=Math.round(vermogen*10)/10;

  // 7. Determine Daikin product types with capacity table
  const hasOnlyVloer=totalSqm>0&&totalRad===0;
  const hasRad=totalRad>0;

  // Model database from Daikin capacity tables (max kW at -7¬∞C buitentemp)
  // ERGA = split, only floor heating (max 55¬∞C water)
  // EPRA = monobloc, also radiators (up to 65¬∞C, larger models up to 70¬∞C)
  // Altherma 4 = E(D/B)LA, split, also radiators (up to 70¬∞C)
  const models=[
    {name:'ERGA 04EV',   type:'ERGA', maxKw:6,  maxTemp:55, onlyVloer:true},
    {name:'ERGA 06EVH',  type:'ERGA', maxKw:7,  maxTemp:55, onlyVloer:true},
    {name:'ERGA 08EVH',  type:'ERGA', maxKw:8,  maxTemp:55, onlyVloer:true},
    {name:'EPRA 08E',    type:'EPRA', maxKw:8,  maxTemp:65, onlyVloer:false},
    {name:'EPRA 10E',    type:'EPRA', maxKw:10, maxTemp:65, onlyVloer:false},
    {name:'EPRA 12E',    type:'EPRA', maxKw:12, maxTemp:65, onlyVloer:false},
    {name:'EPRA 14D',    type:'EPRA', maxKw:14, maxTemp:70, onlyVloer:false},
    {name:'EPRA 16D',    type:'EPRA', maxKw:16, maxTemp:70, onlyVloer:false},
    {name:'EPRA 18D',    type:'EPRA', maxKw:18, maxTemp:70, onlyVloer:false},
    {name:'Altherma4 04', type:'A4',  maxKw:6,  maxTemp:70, onlyVloer:false},
    {name:'Altherma4 06', type:'A4',  maxKw:7,  maxTemp:70, onlyVloer:false},
    {name:'Altherma4 08', type:'A4',  maxKw:8,  maxTemp:70, onlyVloer:false},
    {name:'Altherma4 09D',type:'A4',  maxKw:9,  maxTemp:70, onlyVloer:false},
    {name:'Altherma4 11D',type:'A4',  maxKw:11, maxTemp:70, onlyVloer:false},
    {name:'Altherma4 14D',type:'A4',  maxKw:14, maxTemp:70, onlyVloer:false},
    {name:'Altherma4 16D',type:'A4',  maxKw:16, maxTemp:70, onlyVloer:false},
  ];

  let modelRows='';
  // Group by type, find smallest suitable model per type
  const typeGroups={ERGA:[],EPRA:[],A4:[]};
  models.forEach(m=>{
    let ok=true;
    if(vermogen>m.maxKw) ok=false;
    if(m.onlyVloer&&hasRad) ok=false;
    if(ketelTemp>0&&ketelTemp>m.maxTemp) ok=false;
    if(ketelTemp>70) ok=false;
    if(ok) typeGroups[m.type].push(m);
  });

  const typeLabels={ERGA:'ERGA',EPRA:'EPRA',A4:'Altherma 4'};
  Object.keys(typeGroups).forEach(type=>{
    const arr=typeGroups[type];
    if(arr.length>0){
      // Smallest suitable = first match (models are sorted by size)
      const best=arr[0];
      modelRows+=`<span style="display:inline-block;padding:4px 10px;margin:2px;border-radius:6px;font-size:12px;font-weight:600;background:rgba(46,204,113,.15);color:#2ecc71;border:1px solid rgba(46,204,113,.3)">‚úì ${best.name} (vanaf ${best.maxKw}kW)</span> `;
    }
  });

  if(!modelRows){
    modelRows=`<span style="display:inline-block;padding:4px 10px;margin:2px;border-radius:6px;font-size:12px;font-weight:600;background:rgba(231,76,60,.15);color:#e74c3c;border:1px solid rgba(231,76,60,.3)">‚úó Geen geschikt model gevonden</span>`;
  }

  // Build details
  const fuelLabel=fuel==='gas'?`${fuelAmount} m¬≥ gas`:`${fuelAmount} L mazout`;
  const rendPct=Math.round(rendement*100);
  let distLabel=[];
  if(totalSqm>0) distLabel.push(`${totalSqm} m¬≤ vloerverwarming`);
  if(totalRad>0) distLabel.push(`${totalRad} radiator${totalRad>1?'en':''}`);

  const details=`Verbruik: ${fuelLabel} ‚Üí ${Math.round(brutokWh).toLocaleString('nl')} kWh bruto<br>`
    +`Ketelrendement: ${rendPct}% (bouwjaar ${buildYear}) ‚Üí ${Math.round(warmtebehoefte).toLocaleString('nl')} kWh netto<br>`
    +`Afgifte: ${distLabel.join(' + ')} ‚Üí ${Math.round(vollasturen)} vollasturen<br>`
    +`${insulation?`Isolatie: ${insulation} ‚Üí √ó${correctie}<br>`:(correctie!==1.0?`Isolatiecorrectie: √ó${correctie}<br>`:'')}`
    +`${wType?`Woningtype: ${wType} ‚Üí √ó${woningCorrectie}<br>`:''}`
    +`${heatedFloors>=3?`Bouwlagen: ${heatedFloors} ‚Üí √ó${floorsCorrectie}<br>`:''}`
    +`${oppCorrectie!==1.0?`Oppervlaktecorrectie: ${woningTotalSqm} m¬≤ vs ${Math.round(totalCoverage)} m¬≤ geschat ‚Üí √ó${Math.round(oppCorrectie*100)/100}<br>`:''}`
    +`${ketelTemp>0&&tempCorrectie!==1.0?`Watertemperatuur: ${ketelTemp}¬∞C ‚Üí √ó${tempCorrectie}<br>`:''}`
    +`<strong>Geschat vermogen: ${vermogen} kW</strong><br>`
    +`<div style="margin-top:8px;font-weight:600;font-size:13px">Geschikt model:</div>`
    +`<div style="margin-top:4px;line-height:1.8">${modelRows}</div>`;

  return {kw:vermogen, details};
}

function renderChecklist(){
  if(!activeTab||!selected.includes(activeTab))activeTab=selected[0];
  // Update title
  const def=TYPES[activeTab];
  if(def) document.getElementById('checklist-title').textContent='Checklist '+def.label;
  const homeBtn=`<button onclick="goBackToHub()" title="Hoofdscherm" style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:#fff;font-size:16px;cursor:pointer;border-radius:12px;width:42px;height:42px;display:inline-flex;align-items:center;justify-content:center;vertical-align:middle"><span style="filter:grayscale(1) brightness(2)">üè†</span></button>`;
  const trashBtn=`<button onclick="discardChecklist()" title="Checklist verwijderen" style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:#fff;font-size:16px;cursor:pointer;border-radius:12px;width:42px;height:42px;display:inline-flex;align-items:center;justify-content:center;vertical-align:middle">üóë</button>`;
  // Always show tab button(s) - at minimum the active one
  if(selected.length>1){
    document.getElementById('rtabs').innerHTML=selected.map(t=>{
      const d=TYPES[t];
      return `<button class="rtab ${d.cls} ${activeTab===t?'active':''}" onclick="switchTab('${t}',this)">${d.icon} ${d.label}</button>`;
    }).join('')+trashBtn+homeBtn;
  } else {
    document.getElementById('rtabs').innerHTML=`<button class="rtab ${def.cls} active">${def.icon} ${def.label}</button>`+trashBtn+homeBtn;
  }
  // Show extra split button for airmo or airmu type checklists
  const isAirmo=activeTab==='airmo'||activeTab.startsWith('airmo-');
  const isAirmu=activeTab==='airmu'||activeTab.startsWith('airmu-');
  document.getElementById('btn-extra-split').style.display=isAirmo?'inline-block':'none';
  document.getElementById('btn-extra-multi-split').style.display=isAirmu?'inline-block':'none';
  renderItems();updateProgress();
}

function switchTab(t,el){
  activeTab=t;
  const def=TYPES[t];
  if(def) document.getElementById('checklist-title').textContent='Checklist '+def.label;
  document.querySelectorAll('.rtab').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  renderItems();updateProgress();
}

function renderItems(){
  let num=0;
  const allItems=itemsForTab(activeTab);
  const isAirmu=activeTab==='airmu'||activeTab.startsWith('airmu-');
  // Find the last binnenunit key for this airmu type
  let lastInnerSk='';
  if(isAirmu){
    const innerItems=allItems.filter(i=>i.key.startsWith('binnenunit-')&&!deletedItems.has(i.sk));
    if(innerItems.length>0) lastInnerSk=innerItems[innerItems.length-1].sk;
  }
  document.getElementById('clist').innerHTML=allItems.map((item)=>{
    const d=itemData[item.sk]||{photos:[],notes:'',strings:'',mppTrackers:'',location:''};
    const done=d.photos.length>0||d.notes.trim()!=='';
    const isDeleted=deletedItems.has(item.sk);
    if(!isDeleted) num++;
    const displayNum=isDeleted?'‚Äî':num;
    const thumbs=d.photos.map((p,pi)=>`
      <div class="twrap" onclick="openEditor('${item.sk}',${pi})">
        <img src="${p}"/>
        <div class="edit-badge">‚úèÔ∏è EDIT</div>
        <button class="tdel" onclick="event.stopPropagation();delPhoto('${item.sk}',${pi})">√ó</button>
      </div>`).join('');
    
    let fieldsHtml='';
    if(item.hasStrings||item.hasMppTrackers||item.hasLocation||item.hasMeterType||item.hasPhaseType||item.hasBoardType||item.hasMountType||item.hasFixType||item.hasUnitType||item.hasConnType||item.hasSqm||item.hasRadRows||item.hasFuelType){
      fieldsHtml+=``;
    }
    if(item.hasStrings||item.hasMppTrackers){
      fieldsHtml+=`<div class="fields-row">`;
      if(item.hasStrings){
        fieldsHtml+=`<div>
          <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Aantal strings:</label>
          <input type="number" class="note" placeholder="Min 1" min="1" max="8"
            style="min-height:auto;padding:10px 12px;resize:none"
            value="${d.strings||''}"
            oninput="hideToast('${item.sk}')"
            onchange="saveStrings('${item.sk}',this.value)"/>
        </div>`;
      }
      if(item.hasMppTrackers){
        fieldsHtml+=`<div>
          <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Aantal MPP trackers:</label>
          <input type="number" class="note" placeholder="Max 4" min="1" max="4"
            style="min-height:auto;padding:10px 12px;resize:none"
            value="${d.mppTrackers||''}"
            oninput="hideToast('${item.sk}')"
            onchange="saveMppTrackers('${item.sk}',this.value)"/>
        </div>`;
      }
      fieldsHtml+=`</div>`;
    }
    if(item.hasSqm){
      ensureData(item.sk);
      if(!itemData[item.sk].sqmRows||itemData[item.sk].sqmRows.length===0){
        itemData[item.sk].sqmRows=[{floor:'',sqm:''}];
      }
      const rows=itemData[item.sk].sqmRows;
      fieldsHtml+=rows.map((row,ri)=>{
        const rowReady=row.floor!=='';
        return `<div class="fields-row" style="align-items:flex-end;gap:8px">
        <div style="flex:1">
          ${ri===0?'<label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Verdieping:</label>':''}
          <select class="note" style="min-height:auto;padding:10px 12px;resize:none;appearance:auto"
            onchange="saveSqmRow('${item.sk}',${ri},'floor',this.value)">
            <option value="" ${row.floor===''?'selected':''}>‚Äî Kies ‚Äî</option>
            <option value="kelder" ${row.floor==='kelder'?'selected':''}>Kelder</option>
            <option value="gelijkvloers" ${row.floor==='gelijkvloers'?'selected':''}>Gelijkvloers</option>
            <option value="1e verdiep" ${row.floor==='1e verdiep'?'selected':''}>1e verdiep</option>
            <option value="2e verdiep" ${row.floor==='2e verdiep'?'selected':''}>2e verdiep</option>
          </select>
        </div>
        <div style="flex:1">
          ${ri===0?'<label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Aantal m¬≤:</label>':''}
          <input type="number" class="note" placeholder="m¬≤" min="1" step="1"
            style="min-height:auto;padding:10px 12px;resize:none"
            value="${row.sqm||''}"
            oninput="saveSqmRowLive('${item.sk}',${ri},this.value)"
            onchange="saveSqmRow('${item.sk}',${ri},'sqm',this.value)"/>
        </div>
        <button class="ci-add" onclick="addSqmRow('${item.sk}',${ri})" title="Extra verdiep" style="color:#fff;margin-bottom:2px;flex-shrink:0;${rowReady?'':'opacity:0.3;pointer-events:none;'}">+</button>
        <button class="ci-add" onclick="removeSqmRow('${item.sk}',${ri})" title="Verwijderen" style="color:#fff;margin-bottom:2px;flex-shrink:0">üóë</button>
      </div>`;}).join('');
    }
    if(item.hasRadRows){
      ensureData(item.sk);
      if(!itemData[item.sk].radRows||itemData[item.sk].radRows.length===0){
        itemData[item.sk].radRows=[{floor:'',count:''}];
      }
      const rrows=itemData[item.sk].radRows;
      fieldsHtml+=rrows.map((row,ri)=>{
        const rowReady=row.floor!=='';
        return `<div class="fields-row" style="align-items:flex-end;gap:8px">
        <div style="flex:1">
          ${ri===0?'<label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Verdieping:</label>':''}
          <select class="note" style="min-height:auto;padding:10px 12px;resize:none;appearance:auto"
            onchange="saveRadRow('${item.sk}',${ri},'floor',this.value)">
            <option value="" ${row.floor===''?'selected':''}>‚Äî Kies ‚Äî</option>
            <option value="kelder" ${row.floor==='kelder'?'selected':''}>Kelder</option>
            <option value="gelijkvloers" ${row.floor==='gelijkvloers'?'selected':''}>Gelijkvloers</option>
            <option value="1e verdiep" ${row.floor==='1e verdiep'?'selected':''}>1e verdiep</option>
            <option value="2e verdiep" ${row.floor==='2e verdiep'?'selected':''}>2e verdiep</option>
          </select>
        </div>
        <div style="flex:1">
          ${ri===0?'<label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Aantal radiatoren:</label>':''}
          <input type="number" class="note" placeholder="Aantal" min="1" step="1"
            style="min-height:auto;padding:10px 12px;resize:none"
            value="${row.count||''}"
            oninput="saveRadRowLive('${item.sk}',${ri},this.value)"
            onchange="saveRadRow('${item.sk}',${ri},'count',this.value)"/>
        </div>
        <button class="ci-add" onclick="addRadRow('${item.sk}',${ri})" title="Extra verdiep" style="color:#fff;margin-bottom:2px;flex-shrink:0;${rowReady?'':'opacity:0.3;pointer-events:none;'}">+</button>
        <button class="ci-add" onclick="removeRadRow('${item.sk}',${ri})" title="Verwijderen" style="color:#fff;margin-bottom:2px;flex-shrink:0">üóë</button>
      </div>`;}).join('');
    }
    if(item.hasFuelType){
      ensureData(item.sk);
      const fuel=itemData[item.sk].fuelType||'';
      const fuelVal=itemData[item.sk].fuelAmount||'';
      fieldsHtml+=`<div class="loc-row"><div>
        <label>Verwarmingstype:</label>
        <div class="mount-btns">
          <button class="mount-btn ${fuel==='gas'?'active':''}" onclick="saveFuelType('${item.sk}','gas',this)">Gas</button>
          <button class="mount-btn ${fuel==='mazout'?'active':''}" onclick="saveFuelType('${item.sk}','mazout',this)">Mazout</button>
        </div>
      </div></div>`;
      if(fuel==='gas'){
        fieldsHtml+=`<div class="fields-row"><div style="flex:1">
          <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Aantal m¬≥ gas per jaar:</label>
          <input type="number" class="note" placeholder="m¬≥/jaar" min="1" step="1"
            style="min-height:auto;padding:10px 12px;resize:none"
            value="${fuelVal}"
            oninput="hideToast('${item.sk}')"
            onchange="saveFuelAmount('${item.sk}',this.value)"/>
        </div><div style="flex:1">
          <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Bouwjaar woning:</label>
          <input type="number" class="note" placeholder="Jaartal" min="1900" max="${new Date().getFullYear()}" step="1"
            style="min-height:auto;padding:10px 12px;resize:none"
            value="${itemData[item.sk].buildYear||''}"
            oninput="hideToast('${item.sk}')"
            onchange="saveBuildYear('${item.sk}',this.value)"/>
        </div><div style="flex:1">
          <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Verwarmde opp. (m¬≤):</label>
          <input type="number" class="note" placeholder="m¬≤" min="1" max="300" step="1"
            style="min-height:auto;padding:10px 12px;resize:none"
            value="${itemData[item.sk].totalSqm||''}"
            oninput="hideToast('${item.sk}')"
            onchange="saveTotalSqm('${item.sk}',this.value)"/>
        </div></div>`;
        fieldsHtml+=`<div class="fields-row"><div style="flex:1">
          <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Huidige keteltemperatuur (¬∞C):</label>
          <input type="number" class="note" placeholder="¬∞C" min="20" max="90" step="1"
            style="min-height:auto;padding:10px 12px;resize:none"
            value="${itemData[item.sk].boilerTemp||''}"
            oninput="hideToast('${item.sk}')"
            onchange="saveBoilerTemp('${item.sk}',this.value)"/>
        </div></div>`;
        // Extra woning velden
        const iso=itemData[item.sk].insulation||'';
        const wtype=itemData[item.sk].woningType||'';
        const hfloors=itemData[item.sk].heatedFloors||'';
        fieldsHtml+=`<div class="loc-row"><div>
          <label>Type woning:</label>
          <div class="mount-btns">
            <button class="mount-btn ${wtype==='vrijstaand'?'active':''}" onclick="saveWoningField('${item.sk}','woningType','vrijstaand',this)">Vrijstaand</button>
            <button class="mount-btn ${wtype==='halfopen'?'active':''}" onclick="saveWoningField('${item.sk}','woningType','halfopen',this)">Halfopen</button>
            <button class="mount-btn ${wtype==='rijwoning'?'active':''}" onclick="saveWoningField('${item.sk}','woningType','rijwoning',this)">Rijwoning</button>
            <button class="mount-btn ${wtype==='appartement'?'active':''}" onclick="saveWoningField('${item.sk}','woningType','appartement',this)">Appartement</button>
          </div>
        </div></div>`;
        fieldsHtml+=`<div class="loc-row"><div>
          <label>Aantal verwarmde bouwlagen:</label>
          <div class="mount-btns">
            <button class="mount-btn ${hfloors==='1'?'active':''}" onclick="saveWoningField('${item.sk}','heatedFloors','1',this)">1</button>
            <button class="mount-btn ${hfloors==='2'?'active':''}" onclick="saveWoningField('${item.sk}','heatedFloors','2',this)">2</button>
            <button class="mount-btn ${hfloors==='3'?'active':''}" onclick="saveWoningField('${item.sk}','heatedFloors','3',this)">3</button>
            <button class="mount-btn ${hfloors==='4'?'active':''}" onclick="saveWoningField('${item.sk}','heatedFloors','4',this)">4+</button>
          </div>
        </div></div>`;
        fieldsHtml+=`<div class="loc-row"><div>
          <label>Isolatiegraad:</label>
          <div class="mount-btns">
            <button class="mount-btn ${iso==='geen'?'active':''}" onclick="saveWoningField('${item.sk}','insulation','geen',this)">Geen isolatie</button>
            <button class="mount-btn ${iso==='origineel'?'active':''}" onclick="saveWoningField('${item.sk}','insulation','origineel',this)">Originele isolatie</button>
            <button class="mount-btn ${iso==='goed'?'active':''}" onclick="saveWoningField('${item.sk}','insulation','goed',this)">Goed ge√Øsoleerd</button>
            <button class="mount-btn ${iso==='nieuwbouw'?'active':''}" onclick="saveWoningField('${item.sk}','insulation','nieuwbouw',this)">Nieuwbouw/passief</button>
          </div>
        </div></div>`;
      } else if(fuel==='mazout'){
      } else if(fuel==='mazout'){
        fieldsHtml+=`<div class="fields-row"><div style="flex:1">
          <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Liter mazout per jaar:</label>
          <input type="number" class="note" placeholder="liter/jaar" min="1" step="1"
            style="min-height:auto;padding:10px 12px;resize:none"
            value="${fuelVal}"
            oninput="hideToast('${item.sk}')"
            onchange="saveFuelAmount('${item.sk}',this.value)"/>
        </div><div style="flex:1">
          <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Bouwjaar woning:</label>
          <input type="number" class="note" placeholder="Jaartal" min="1900" max="${new Date().getFullYear()}" step="1"
            style="min-height:auto;padding:10px 12px;resize:none"
            value="${itemData[item.sk].buildYear||''}"
            oninput="hideToast('${item.sk}')"
            onchange="saveBuildYear('${item.sk}',this.value)"/>
        </div><div style="flex:1">
          <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Verwarmde opp. (m¬≤):</label>
          <input type="number" class="note" placeholder="m¬≤" min="1" max="300" step="1"
            style="min-height:auto;padding:10px 12px;resize:none"
            value="${itemData[item.sk].totalSqm||''}"
            oninput="hideToast('${item.sk}')"
            onchange="saveTotalSqm('${item.sk}',this.value)"/>
        </div></div>`;
        fieldsHtml+=`<div class="fields-row"><div style="flex:1">
          <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Huidige keteltemperatuur (¬∞C):</label>
          <input type="number" class="note" placeholder="¬∞C" min="20" max="90" step="1"
            style="min-height:auto;padding:10px 12px;resize:none"
            value="${itemData[item.sk].boilerTemp||''}"
            oninput="hideToast('${item.sk}')"
            onchange="saveBoilerTemp('${item.sk}',this.value)"/>
        </div></div>`;
        // Extra woning velden (mazout)
        const isoM=itemData[item.sk].insulation||'';
        const wtypeM=itemData[item.sk].woningType||'';
        const hfloorsM=itemData[item.sk].heatedFloors||'';
        fieldsHtml+=`<div class="loc-row"><div>
          <label>Type woning:</label>
          <div class="mount-btns">
            <button class="mount-btn ${wtypeM==='vrijstaand'?'active':''}" onclick="saveWoningField('${item.sk}','woningType','vrijstaand',this)">Vrijstaand</button>
            <button class="mount-btn ${wtypeM==='halfopen'?'active':''}" onclick="saveWoningField('${item.sk}','woningType','halfopen',this)">Halfopen</button>
            <button class="mount-btn ${wtypeM==='rijwoning'?'active':''}" onclick="saveWoningField('${item.sk}','woningType','rijwoning',this)">Rijwoning</button>
            <button class="mount-btn ${wtypeM==='appartement'?'active':''}" onclick="saveWoningField('${item.sk}','woningType','appartement',this)">Appartement</button>
          </div>
        </div></div>`;
        fieldsHtml+=`<div class="loc-row"><div>
          <label>Aantal verwarmde bouwlagen:</label>
          <div class="mount-btns">
            <button class="mount-btn ${hfloorsM==='1'?'active':''}" onclick="saveWoningField('${item.sk}','heatedFloors','1',this)">1</button>
            <button class="mount-btn ${hfloorsM==='2'?'active':''}" onclick="saveWoningField('${item.sk}','heatedFloors','2',this)">2</button>
            <button class="mount-btn ${hfloorsM==='3'?'active':''}" onclick="saveWoningField('${item.sk}','heatedFloors','3',this)">3</button>
            <button class="mount-btn ${hfloorsM==='4'?'active':''}" onclick="saveWoningField('${item.sk}','heatedFloors','4',this)">4+</button>
          </div>
        </div></div>`;
        fieldsHtml+=`<div class="loc-row"><div>
          <label>Isolatiegraad:</label>
          <div class="mount-btns">
            <button class="mount-btn ${isoM==='geen'?'active':''}" onclick="saveWoningField('${item.sk}','insulation','geen',this)">Geen isolatie</button>
            <button class="mount-btn ${isoM==='origineel'?'active':''}" onclick="saveWoningField('${item.sk}','insulation','origineel',this)">Originele isolatie</button>
            <button class="mount-btn ${isoM==='goed'?'active':''}" onclick="saveWoningField('${item.sk}','insulation','goed',this)">Goed ge√Øsoleerd</button>
            <button class="mount-btn ${isoM==='nieuwbouw'?'active':''}" onclick="saveWoningField('${item.sk}','insulation','nieuwbouw',this)">Nieuwbouw/passief</button>
          </div>
        </div></div>`;
      }
    }
    if(item.hasLocation){
      // For loc-bat: inherit location from omvormer if not yet set
      if(item.key==='loc-bat' && !d.location){
        const omvSk=getSK(activeTab,{shared:true,key:'omvormer'});
        const omvData=itemData[omvSk];
        if(omvData && omvData.location){
          ensureData(item.sk);
          itemData[item.sk].location=omvData.location;
          d.location=omvData.location;
        }
      }
      fieldsHtml+=`<div class="loc-row"><div>
        <label>Locatie:</label>
        <div class="loc-btns">
          <button class="loc-btn ${d.location==='kelder'?'active':''}" onclick="saveLocation('${item.sk}','kelder',this)">Kelder</button>
          <button class="loc-btn ${d.location==='gelijkvloers'?'active':''}" onclick="saveLocation('${item.sk}','gelijkvloers',this)">Gelijkvloers</button>
          <button class="loc-btn ${d.location==='verdieping'?'active':''}" onclick="saveLocation('${item.sk}','verdieping',this)">Verdieping</button>
        </div>
      </div></div>`;
    }
    if(item.hasBatCalc){
      ensureData(item.sk);
      const bc=itemData[item.sk];
      if(!bc.batType) bc.batType='';
      if(!bc.batVerbruik) bc.batVerbruik='';
      if(!bc.batProductie) bc.batProductie='';
      if(!bc.batAfname) bc.batAfname='';
      if(!bc.batInjectie) bc.batInjectie='';
      fieldsHtml+=`<div id="batcalc-wrap-${item.sk}" style="margin-top:12px;padding:12px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1)${bc.batCalcSkipped?';display:none':''}">
        <div style="display:flex;align-items:center;margin-bottom:10px;justify-content:space-between">
          <div style="display:flex;align-items:center;gap:8px">
            <span style="display:inline-flex;gap:4px;align-items:center"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="6" width="18" height="12" rx="2"/><line x1="22" y1="11" x2="22" y2="13"/><line x1="6" y1="10" x2="6" y2="14"/><line x1="10" y1="10" x2="10" y2="14"/><line x1="14" y1="10" x2="14" y2="14"/></svg><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="10" y2="10"/><line x1="14" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="10" y2="14"/><line x1="14" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="16" y2="18"/></svg></span>
            <strong style="color:var(--text1);font-size:14px">Batterij Configurator</strong>
            <button class="ci-add" onclick="skipBatCalc('${item.sk}')" title="Overslaan" style="color:#fff;flex-shrink:0">üóë</button>
          </div>
        </div>
        <div class="loc-row"><div>
          <label>Type batterij:</label>
          <div class="mount-btns">
            <button class="mount-btn ${bc.batType==='h3'?'active':''}" onclick="saveBatField('${item.sk}','batType','h3',this)">Pylontech H3</button>
            <button class="mount-btn ${bc.batType==='pelio'?'active':''}" onclick="saveBatField('${item.sk}','batType','pelio',this)">Pylontech Pelio</button>
            <button class="mount-btn ${bc.batType==='fidus'?'active':''}" onclick="saveBatField('${item.sk}','batType','fidus',this)">Pylontech Fidus</button>
          </div>
        </div></div>
        <div class="fields-row">
          <div style="flex:1">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Productie (kWh/jaar):</label>
            <input type="number" class="note" placeholder="kWh" min="1" step="1"
              style="min-height:auto;padding:10px 12px;resize:none"
              value="${bc.batProductie||''}"
              oninput="saveBatField('${item.sk}','batProductie',this.value)"
              onchange="calcBattery('${item.sk}')"
              onkeydown="if(event.key==='Enter'){this.blur();if(validateBatCalc('${item.sk}'))nextItem('${item.sk}')}"/>
          </div>
          <div style="flex:1">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Injectie (kWh/jaar):</label>
            <input type="number" class="note" placeholder="kWh" min="0" step="1"
              style="min-height:auto;padding:10px 12px;resize:none"
              value="${bc.batInjectie||''}"
              oninput="saveBatField('${item.sk}','batInjectie',this.value)"
              onchange="calcBattery('${item.sk}')"
              onkeydown="if(event.key==='Enter'){this.blur();if(validateBatCalc('${item.sk}'))nextItem('${item.sk}')}"/>
          </div>
          <div style="flex:1">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px">Afname (kWh/jaar):</label>
            <input type="number" class="note" placeholder="kWh" min="0" step="1"
              style="min-height:auto;padding:10px 12px;resize:none"
              value="${bc.batAfname||''}"
              oninput="saveBatField('${item.sk}','batAfname',this.value)"
              onchange="calcBattery('${item.sk}')"
              onkeydown="if(event.key==='Enter'){this.blur();if(validateBatCalc('${item.sk}'))nextItem('${item.sk}')}"/>
          </div>
        </div>
        <div id="bat-result-${item.sk}" style="margin-top:10px"></div>
      </div>
      <div id="batcalc-skipped-${item.sk}" style="margin-top:12px;padding:12px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);display:${bc.batCalcSkipped?'flex':'none'};align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="display:inline-flex;gap:4px;align-items:center"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="6" width="18" height="12" rx="2"/><line x1="22" y1="11" x2="22" y2="13"/><line x1="6" y1="10" x2="6" y2="14"/><line x1="10" y1="10" x2="10" y2="14"/><line x1="14" y1="10" x2="14" y2="14"/></svg><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="10" y2="10"/><line x1="14" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="10" y2="14"/><line x1="14" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="16" y2="18"/></svg></span>
          <span style="color:var(--text2);font-size:13px">Batterij Configurator <em>(overgeslagen)</em></span>
        </div>
        <button onclick="unskipBatCalc('${item.sk}')" title="Toch invullen" style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:#fff;font-size:18px;font-weight:700;cursor:pointer;border-radius:8px;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;line-height:1">+</button>
      </div>`;
    }
    if(item.hasMeterType){
      ensureData(item.sk);
      if(!itemData[item.sk].meterType) itemData[item.sk].meterType=[];
      const mt=itemData[item.sk].meterType;
      fieldsHtml+=`<div class="loc-row"><div>
        <label>Energiemeter:</label>
        <div class="board-btns">
          <button class="board-btn ${mt.includes('Bidirectionele meter')?'active':''}" onclick="toggleMeterType('${item.sk}','Bidirectionele meter',this)">Bidirectionele meter</button>
          <button class="board-btn ${mt.includes('3-fasige energiemeter')?'active':''}" onclick="toggleMeterType('${item.sk}','3-fasige energiemeter',this)">3-fasige energiemeter</button>
        </div>
      </div></div>`;
    }
    if(item.hasPhaseType){
      ensureData(item.sk);
      const pt=itemData[item.sk].phaseType||'';
      fieldsHtml+=`<div class="loc-row"><div>
        <label>Type aansluiting:</label>
        <div class="mount-btns">
          <button class="mount-btn ${pt==='2-fase'?'active':''}" onclick="savePhaseType('${item.sk}','2-fase',this)">2-fase</button>
          <button class="mount-btn ${pt==='3-fase'?'active':''}" onclick="savePhaseType('${item.sk}','3-fase',this)">3-fase</button>
          <button class="mount-btn ${pt==='3x230V'?'active':''}" onclick="savePhaseType('${item.sk}','3x230V',this)">3x230V</button>
        </div>
      </div></div>`;
    }
    if(item.hasBoardType){
      ensureData(item.sk);
      const bt=itemData[item.sk].boardType||{};
      fieldsHtml+=`<div class="loc-row"><div>
        <label>Type bord:</label>
        <div class="board-btns">
          <button class="board-btn ${bt.moeilijk?'active':''}" onclick="toggleBoardType('${item.sk}','moeilijk',this)">Moeilijk bord</button>
          <button class="board-btn ${bt.extra?'active':''}" onclick="toggleBoardType('${item.sk}','extra',this)">Extra bord plaatsen</button>
        </div>
      </div></div>`;
    }
    if(item.hasMountType){
      ensureData(item.sk);
      const mt=itemData[item.sk].mountType||'';
      fieldsHtml+=`<div class="loc-row"><div>
        <label>Type montage:</label>
        <div class="mount-btns">
          <button class="mount-btn ${mt==='muurmontage'?'active':''}" onclick="saveMountType('${item.sk}','muurmontage',this)">Muurmontage</button>
          <button class="mount-btn ${mt==='paal'?'active':''}" onclick="saveMountType('${item.sk}','paal',this)">Paal</button>
        </div>
      </div></div>`;
    }
    if(item.hasFixType){
      ensureData(item.sk);
      const ft=itemData[item.sk].fixType||'';
      fieldsHtml+=`<div class="loc-row"><div>
        <label>Bevestigingstechniek:</label>
        <div class="mount-btns">
          <button class="mount-btn ${ft==='vloerblokken'?'active':''}" onclick="saveFixType('${item.sk}','vloerblokken',this)">Vloerblokken</button>
          <button class="mount-btn ${ft==='muurbeugel'?'active':''}" onclick="saveFixType('${item.sk}','muurbeugel',this)">Muurbeugel</button>
        </div>
      </div></div>`;
    }
    if(item.hasPowerCalc){
      const calc=calcPowerEstimate(activeTab);
      if(calc){
        fieldsHtml+=`<div style="background:rgba(56,182,255,.08);border:1px solid rgba(56,182,255,.25);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:10px">
          <div style="font-size:12px;font-weight:700;color:#38b6ff;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">‚ö° Vermogensvoorstel</div>
          <div style="font-size:28px;font-weight:700;color:var(--text);margin-bottom:4px">${calc.kw} kW</div>
          <div style="font-size:12px;color:var(--text2);line-height:1.6">
            ${calc.details}
          </div>
        </div>`;
      } else {
        fieldsHtml+=`<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:10px">
          <div style="font-size:12px;font-weight:700;color:var(--text3);margin-bottom:4px">‚ö° Vermogensvoorstel</div>
          <div style="font-size:12px;color:var(--text3)">Vul woning (gas/mazout + bouwjaar) en vloerverwarming of radiatoren in voor een schatting.</div>
        </div>`;
      }
    }
    if(item.hasUnitType){
      ensureData(item.sk);
      const ut=itemData[item.sk].unitType||'';
      fieldsHtml+=`<div class="loc-row"><div>
        <label>Type binnenunit:</label>
        <div class="mount-btns">
          <button class="mount-btn ${ut==='wandmodel'?'active':''}" onclick="saveUnitType('${item.sk}','wandmodel',this)">Wandmodel</button>
          <button class="mount-btn ${ut==='vloermodel'?'active':''}" onclick="saveUnitType('${item.sk}','vloermodel',this)">Vloermodel</button>
        </div>
      </div></div>`;
    }
    if(item.hasConnType){
      ensureData(item.sk);
      const ct=itemData[item.sk].connType||'';
      fieldsHtml+=`<div class="loc-row"><div>
        <label>Type aansluiting:</label>
        <div class="mount-btns">
          <button class="mount-btn ${ct==='stekker'?'active':''}" onclick="saveConnType('${item.sk}','stekker',this)">Aansluiting via stekker</button>
          <button class="mount-btn ${ct==='bord'?'active':''}" onclick="saveConnType('${item.sk}','bord',this)">Aansluiting via bord</button>
        </div>
      </div></div>`;
    }

    // Action button: trash or restore
    // Don't show trash if item is shared, or if item is done (OK)
    let actionBtn='';
    if(item.optional && isDeleted){
      actionBtn=`<button class="ci-restore" onclick="event.stopPropagation();restoreItem('${item.sk}')" title="Herstellen">‚Ü©</button>`;
    } else if(item.optional && !isDeleted && !item.isShared && !done){
      actionBtn=`<button class="ci-trash" onclick="event.stopPropagation();deleteItem('${item.sk}')" title="Verwijderen">üóë</button>`;
    }
    // Show + button on last binnenunit of airmu, with trash if >2 inner units
    if(isAirmu && item.sk===lastInnerSk && !isDeleted){
      const innerCount=countInnerUnits(activeTab);
      if(innerCount>2){
        actionBtn+=`<button class="ci-add" onclick="event.stopPropagation();removeLastInnerUnit()" title="Binnenunit verwijderen" style="color:#fff">üóë</button>`;
      }
      actionBtn+=`<button class="ci-add" onclick="event.stopPropagation();addExtraInnerUnit()" title="Extra binnenunit">+</button>`;
    }
    
    return `
    <div class="ci ${done&&!isDeleted?'completed':''} ${isDeleted?'deleted':''}" id="ci-${item.sk}">
      <div class="ci-head" ${!isDeleted?`onclick="toggleItem('${item.sk}')"`:''}>
        <div class="cnum">${displayNum}</div>
        <div class="clabel">${item.label.replace(/([\u{2600}-\u{27BF}\u{1F300}-\u{1F9FF}]\u{FE0F}?)/gu,'<span style="filter:grayscale(1) brightness(2)">$1</span>')}</div>
        ${item.isShared&&!isDeleted?`<span class="sbadge ${sharedHasDataElsewhere(item.key,activeTab)?'ok':'nok'}">Gedeeld</span>`:''}
        <div class="ci-actions">${actionBtn}</div>
        ${!isDeleted?`<span class="sbadge ${done?'ok':'nok'}">${done?'OK':'NOK'}</span>`:''}
        ${!isDeleted?'<div class="carrow">‚ñº</div>':''}
      </div>
      <div class="ci-body">
        ${!item.noPhoto?`${item.hint?`<div style="font-size:11px;color:var(--text3);padding:0 4px;margin-bottom:6px">${item.hint}</div>`:''}
        <div class="thumbrow" id="thumbs-${item.sk}">${thumbs}</div>
        <div class="photoarea">
          <input type="file" accept="image/*" capture="environment" multiple onchange="addPhotos('${item.sk}',this)"/>
          <div class="picon">üì∑</div>
          <div class="ptxt">Foto toevoegen</div>
          <div class="psub" style="font-size:11px;color:var(--text3);margin-top:3px">Na het toevoegen kan je de foto bewerken</div>
        </div>`:''}
        ${fieldsHtml}
        ${item.noteHint?`<div style="font-size:11px;color:var(--text3);padding:0 4px;margin-bottom:4px">${item.noteHint}</div>`:''}
        <textarea class="note" placeholder="${item.noPhoto?'Beschrijving‚Ä¶':'Toelichting‚Ä¶'}" oninput="hideToast('${item.sk}')" onchange="saveNote('${item.sk}',this.value)">${d.notes||''}</textarea>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST (inline validation)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer=null;
const blockingErrors={};
function showToast(sk,msg,blocking,warn){
  // Open the item first
  const ci=document.getElementById('ci-'+sk);
  if(ci && !ci.classList.contains('open')){
    document.querySelectorAll('.ci.open').forEach(e=>e.classList.remove('open'));
    ci.classList.add('open');
  }
  if(blocking) blockingErrors[sk]=msg;
  const el=document.getElementById('global-toast');
  if(el){
    el.textContent=msg;
    el.classList.add('show');
    if(warn) el.classList.add('warn'); else el.classList.remove('warn');
    if(!blocking){
      if(toastTimer)clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>hideToast(sk),3000);
    }
  }
}
function hideToast(sk){
  delete blockingErrors[sk];
  const el=document.getElementById('global-toast');
  if(el){el.classList.remove('show');el.classList.remove('warn');}
}
function hasBlockingError(sk){
  if(blockingErrors[sk]){
    showToast(sk,blockingErrors[sk],true);
    return true;
  }
  return false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VALIDATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function validateCurrentItem(sk){
  const items=itemsForTab(activeTab);
  const item=items.find(i=>i.sk===sk);
  if(!item) return true;
  const d=itemData[sk]||{};
  if(item.hasStrings && (!d.strings||d.strings.trim()==='')){
    showToast(sk,'Aantal strings is verplicht');return false;
  }
  if(item.hasMppTrackers && (!d.mppTrackers||d.mppTrackers.trim()==='')){
    showToast(sk,'Aantal MPP trackers is verplicht');return false;
  }
  if(item.hasStrings && item.hasMppTrackers){
    const s=parseInt(d.strings)||0, m=parseInt(d.mppTrackers)||0;
    if(s<1){showToast(sk,'Fout configuratie: minimaal 1 string');return false;}
    if(m<1){showToast(sk,'Fout configuratie: minimaal 1 MPP tracker');return false;}
    if(m>4){showToast(sk,'Fout configuratie: maximaal 4 MPP trackers');return false;}
    if(s<m){showToast(sk,'Foute string/ MPP config');return false;}
  }
  if(item.hasLocation && !d.location){
    showToast(sk,`Locatie ${item.label.toLowerCase()} is verplicht`);return false;
  }
  if(item.hasFixType && !d.fixType){
    showToast(sk,'Bevestigingstechniek verplicht');return false;
  }
  if(item.hasUnitType && !d.unitType){
    showToast(sk,'Type binnenunit verplicht');return false;
  }
  if(item.hasPhaseType && !d.phaseType){
    showToast(sk,'Type aansluiting is verplicht');return false;
  }
  if(item.hasFuelType){
    if(!d.fuelType){showToast(sk,'Verwarmingstype is verplicht',true);return false;}
    if(!d.fuelAmount||parseFloat(d.fuelAmount)<=0){showToast(sk,d.fuelType==='gas'?'Aantal m¬≥ gas is verplicht':'Liter mazout is verplicht',true);return false;}
    if(!d.buildYear||parseInt(d.buildYear)<1900){showToast(sk,'Bouwjaar woning is verplicht',true);return false;}
    if(!d.woningType){showToast(sk,'Type woning is verplicht',true);return false;}
    if(!d.heatedFloors){showToast(sk,'Aantal verwarmde bouwlagen is verplicht',true);return false;}
    if(!d.insulation){showToast(sk,'Isolatiegraad is verplicht',true);return false;}
    if(!d.totalSqm||parseFloat(d.totalSqm)<=0){showToast(sk,'Verwarmde oppervlakte is verplicht',true);return false;}
    if(!d.boilerTemp||parseInt(d.boilerTemp)<=0){showToast(sk,'Keteltemperatuur is verplicht',true);return false;}
  }
  if(item.hasSqm && d.sqmRows && d.sqmRows.length>0){
    for(const r of d.sqmRows){
      const hasFloor=r.floor&&r.floor!=='';
      const hasSqm=r.sqm&&parseFloat(r.sqm)>0;
      if(hasFloor&&!hasSqm){showToast(sk,'Oppervlakte vloerverwarming is verplicht');return false;}
      if(!hasFloor&&hasSqm){showToast(sk,'Verdieping is verplicht');return false;}
    }
  }
  if(item.hasRadRows && d.radRows && d.radRows.length>0){
    for(const r of d.radRows){
      const hasFloor=r.floor&&r.floor!=='';
      const hasCount=r.count&&parseInt(r.count)>0;
      if(hasFloor&&!hasCount){showToast(sk,'Aantal radiatoren is verplicht');return false;}
      if(!hasFloor&&hasCount){showToast(sk,'Verdieping is verplicht');return false;}
    }
  }
  if(item.hasBatCalc && !d.batCalcSkipped){
    const bt=d.batType||'';
    const bp=d.batProductie||'';
    const ba=d.batAfname||'';
    const bi=d.batInjectie||'';
    const filled=[bt,bp,ba,bi].filter(v=>v!=='').length;
    if(filled>0&&filled<4){
      const missing=[];
      if(!bt) missing.push('Type batterij');
      if(!bp) missing.push('Productie');
      if(!ba) missing.push('Afname');
      if(!bi) missing.push('Injectie');
      showToast(sk,'Ontbrekend: '+missing.join(', '),true);
      return false;
    }
    if(filled===0){
      // Niets ingevuld: skip automatisch
      itemData[sk].batCalcSkipped=true;
    }
  }
  return true;
}

function deleteItem(sk){
  deletedItems.add(sk);
  // Close if open
  const ci=document.getElementById('ci-'+sk);
  if(ci)ci.classList.remove('open');
  renderItems();updateProgress();
}

function restoreItem(sk){
  deletedItems.delete(sk);
  renderItems();updateProgress();
}

function toggleItem(sk){
  const ci=document.getElementById('ci-'+sk);
  const was=ci.classList.contains('open');
  // If closing current item, validate
  const openEl=document.querySelector('.ci.open');
  if(openEl && openEl.id!=='ci-'+sk){
    const openSk=openEl.id.replace('ci-','');
    if(!validateCurrentItem(openSk)) return;
  }
  document.querySelectorAll('.ci.open').forEach(e=>e.classList.remove('open'));
  if(!was)ci.classList.add('open');
}

function nextItem(sk){
  // Find next visible item and open it
  const items=itemsForTab(activeTab);
  const idx=items.findIndex(i=>i.sk===sk);
  if(idx<0) return;
  for(let i=idx+1;i<items.length;i++){
    if(!deletedItems.has(items[i].sk)){
      toggleItem(items[i].sk);
      const el=document.getElementById('ci-'+items[i].sk);
      if(el) el.scrollIntoView({behavior:'smooth',block:'center'});
      return;
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA OPERATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ensureData(sk){
  if(!itemData[sk]) itemData[sk]={photos:[],notes:'',strings:'',mppTrackers:'',location:'',boardType:{},mountType:'',fixType:'',unitType:'',connType:'',sqm:'',floor:'',sqmRows:[],radRows:[],fuelType:'',fuelAmount:'',buildYear:'',meterType:[],phaseType:'',insulation:'',woningType:'',heatedFloors:'',totalSqm:'',boilerTemp:'',batType:'',batVerbruik:'',batProductie:'',batAfname:'',batInjectie:''};
  if(!itemData[sk].boardType) itemData[sk].boardType={};
  if(!itemData[sk].sqmRows) itemData[sk].sqmRows=[];
  if(!itemData[sk].radRows) itemData[sk].radRows=[];
  if(!itemData[sk].meterType) itemData[sk].meterType=[];
  if(!itemData[sk].mountType && itemData[sk].mountType!=='') itemData[sk].mountType='';
  if(!itemData[sk].fixType && itemData[sk].fixType!=='') itemData[sk].fixType='';
  if(!itemData[sk].unitType && itemData[sk].unitType!=='') itemData[sk].unitType='';
  if(!itemData[sk].connType && itemData[sk].connType!=='') itemData[sk].connType='';
}

function addPhotos(sk,input){
  ensureData(sk);
  const files=Array.from(input.files);let pending=files.length;
  files.forEach(f=>{
    const r=new FileReader();
    r.onload=e=>{itemData[sk].photos.push(e.target.result);pending--;if(pending===0){refreshItem(sk);updateProgress();}};
    r.readAsDataURL(f);
  });
}
function delPhoto(sk,idx){if(itemData[sk]){itemData[sk].photos.splice(idx,1);refreshItem(sk);updateProgress();}}
function saveNote(sk,v){ensureData(sk);itemData[sk].notes=v;refreshItem(sk);updateProgress();}

function saveStrings(sk,v){
  ensureData(sk);
  const val=parseInt(v);
  if(isNaN(val)||val<1){showToast(sk,'Fout configuratie: minimaal 1 string');return;}
  const mpp=parseInt(itemData[sk].mppTrackers)||0;
  if(mpp>0 && val<mpp){showToast(sk,'Foute string/ MPP config');return;}
  itemData[sk].strings=v;
  hideToast(sk);
  refreshItem(sk);updateProgress();
}

function saveMppTrackers(sk,v){
  ensureData(sk);
  const val=parseInt(v);
  if(isNaN(val)||val<1){showToast(sk,'Fout configuratie: minimaal 1 MPP tracker');return;}
  if(val>4){showToast(sk,'Fout configuratie: maximaal 4 MPP trackers');return;}
  const strings=parseInt(itemData[sk].strings)||0;
  if(strings>0 && val>strings){showToast(sk,'Foute string/ MPP config');return;}
  itemData[sk].mppTrackers=v;
  hideToast(sk);
  refreshItem(sk);updateProgress();
}

function saveSqm(sk,v){
  ensureData(sk);
  const val=parseFloat(v);
  if(isNaN(val)||val<=0){
    showToast(sk,'Aantal m¬≤ mag niet 0 zijn');
    itemData[sk].sqm='';
    return;
  }
  itemData[sk].sqm=v;
  hideToast(sk);
  refreshItem(sk);updateProgress();
}

function saveFloor(sk,v){
  ensureData(sk);
  itemData[sk].floor=v;
}

function saveSqmRow(sk,idx,field,v){
  ensureData(sk);
  if(!itemData[sk].sqmRows) itemData[sk].sqmRows=[{floor:'',sqm:''}];
  if(field==='sqm'){
    if(hasBlockingError(sk)&&blockingErrors[sk]!=='Aantal m¬≤ is verplicht') return;
    const val=parseFloat(v);
    if(isNaN(val)||val<=0){
      showToast(sk,'Aantal m¬≤ mag niet 0 zijn');
      itemData[sk].sqmRows[idx].sqm='';
      return;
    }
    itemData[sk].sqmRows[idx].sqm=v;
    if(!itemData[sk].sqmRows[idx].floor){
      showToast(sk,'Verdieping is verplicht',true);
    } else { hideToast(sk); }
    return;
  }
  if(hasBlockingError(sk)&&blockingErrors[sk]!=='Verdieping is verplicht') return;
  itemData[sk].sqmRows[idx][field]=v;
  if(v && (!itemData[sk].sqmRows[idx].sqm || parseFloat(itemData[sk].sqmRows[idx].sqm)<=0)){
    showToast(sk,'Aantal m¬≤ is verplicht',true);
  } else { hideToast(sk); }
  renderItems();updateProgress();
  const ci=document.getElementById('ci-'+sk);
  if(ci) ci.classList.add('open');
}

function saveSqmRowLive(sk,idx,v){
  if(hasBlockingError(sk)&&blockingErrors[sk]!=='Aantal m¬≤ is verplicht') return;
  ensureData(sk);
  if(!itemData[sk].sqmRows) itemData[sk].sqmRows=[{floor:'',sqm:''}];
  itemData[sk].sqmRows[idx].sqm=v;
}

function addSqmRow(sk,ri){
  ensureData(sk);
  if(!itemData[sk].sqmRows) itemData[sk].sqmRows=[{floor:'',sqm:''}];
  const row=itemData[sk].sqmRows[ri];
  if(!row||row.floor===''||row.sqm===''||parseFloat(row.sqm)<=0){
    showToast(sk,'Vul verdieping en m¬≤ in voor een extra rij toe te voegen');
    return;
  }
  itemData[sk].sqmRows.push({floor:'',sqm:''});
  renderItems();updateProgress();
  const ci=document.getElementById('ci-'+sk);
  if(ci) ci.classList.add('open');
}

function removeSqmRow(sk,idx){
  ensureData(sk);
  if(!itemData[sk].sqmRows||itemData[sk].sqmRows.length<=1) return;
  itemData[sk].sqmRows.splice(idx,1);
  renderItems();updateProgress();
  const ci=document.getElementById('ci-'+sk);
  if(ci) ci.classList.add('open');
}

function saveRadRow(sk,idx,field,v){
  ensureData(sk);
  if(!itemData[sk].radRows) itemData[sk].radRows=[{floor:'',count:''}];
  if(field==='count'){
    const val=parseInt(v);
    if(isNaN(val)||val<=0){
      showToast(sk,'Aantal radiatoren mag niet 0 zijn');
      itemData[sk].radRows[idx].count='';
      return;
    }
    itemData[sk].radRows[idx].count=v;
    if(!itemData[sk].radRows[idx].floor){
      showToast(sk,'Verdieping is verplicht');
    } else { hideToast(sk); }
    return;
  }
  itemData[sk].radRows[idx][field]=v;
  if(v && (!itemData[sk].radRows[idx].count || parseInt(itemData[sk].radRows[idx].count)<=0)){
    showToast(sk,'Aantal radiatoren is verplicht');
  } else { hideToast(sk); }
  renderItems();updateProgress();
  const ci=document.getElementById('ci-'+sk);
  if(ci) ci.classList.add('open');
}

function saveRadRowLive(sk,idx,v){
  if(hasBlockingError(sk)&&blockingErrors[sk]!=='Aantal radiatoren is verplicht') return;
  ensureData(sk);
  if(!itemData[sk].radRows) itemData[sk].radRows=[{floor:'',count:''}];
  itemData[sk].radRows[idx].count=v;
}

function addRadRow(sk,ri){
  ensureData(sk);
  if(!itemData[sk].radRows) itemData[sk].radRows=[{floor:'',count:''}];
  const row=itemData[sk].radRows[ri];
  if(!row||row.floor===''||row.count===''||parseInt(row.count)<=0){
    showToast(sk,'Vul verdieping en aantal in voor een extra rij toe te voegen');
    return;
  }
  itemData[sk].radRows.push({floor:'',count:''});
  renderItems();updateProgress();
  const ci=document.getElementById('ci-'+sk);
  if(ci) ci.classList.add('open');
}

function removeRadRow(sk,idx){
  ensureData(sk);
  if(!itemData[sk].radRows||itemData[sk].radRows.length<=1) return;
  itemData[sk].radRows.splice(idx,1);
  renderItems();updateProgress();
  const ci=document.getElementById('ci-'+sk);
  if(ci) ci.classList.add('open');
}

function saveFuelType(sk,type,btn){
  ensureData(sk);
  if(itemData[sk].fuelType===type){
    itemData[sk].fuelType='';
  } else {
    itemData[sk].fuelType=type;
    itemData[sk].fuelAmount='';
  }
  hideToast(sk);
  renderItems();updateProgress();
  const ci=document.getElementById('ci-'+sk);
  if(ci) ci.classList.add('open');
}

function saveFuelAmount(sk,v){
  ensureData(sk);
  const val=parseFloat(v);
  if(isNaN(val)||val<=0){
    const label=itemData[sk].fuelType==='gas'?'m¬≥ gas':'liter mazout';
    showToast(sk,`Aantal ${label} mag niet 0 zijn`);
    itemData[sk].fuelAmount='';
    return;
  }
  itemData[sk].fuelAmount=v;
  hideToast(sk);
}

function saveBuildYear(sk,v){
  ensureData(sk);
  const val=parseInt(v);
  const currentYear=new Date().getFullYear();
  if(isNaN(val)||val<1900||val>currentYear){
    showToast(sk,`Bouwjaar moet tussen 1900 en ${currentYear} liggen`);
    itemData[sk].buildYear='';
    return;
  }
  itemData[sk].buildYear=v;
  hideToast(sk);
}

function saveWoningField(sk,field,value,btn){
  ensureData(sk);
  if(itemData[sk][field]===value){
    itemData[sk][field]='';
  } else {
    itemData[sk][field]=value;
  }
  const parent=btn.parentElement;
  parent.querySelectorAll('.mount-btn').forEach(b=>b.classList.remove('active'));
  if(itemData[sk][field]) btn.classList.add('active');
}

function saveTotalSqm(sk,v){
  ensureData(sk);
  const val=parseInt(v);
  if(isNaN(val)||val<1||val>300){
    showToast(sk,'Oppervlakte moet tussen 1 en 300 m¬≤ liggen');
    itemData[sk].totalSqm='';
    return;
  }
  itemData[sk].totalSqm=v;
  hideToast(sk);
}

function saveBoilerTemp(sk,v){
  ensureData(sk);
  const val=parseInt(v);
  if(isNaN(val)||val<20||val>90){
    showToast(sk,'Keteltemperatuur moet tussen 20 en 90¬∞C liggen');
    itemData[sk].boilerTemp='';
    return;
  }
  itemData[sk].boilerTemp=v;
  hideToast(sk);
  if(val>70){
    alert('‚ö†Ô∏è Keteltemperatuur hoger dan 70¬∞C!\n\nEen warmtepomp is niet geschikt bij deze watertemperatuur. Eerst de afgiftelichamen (radiatoren) aanpassen of isolatie verbeteren.');
  }
}

function skipBatCalc(sk){
  ensureData(sk);
  itemData[sk].batCalcSkipped=true;
  hideToast(sk);
  const wrap=document.getElementById('batcalc-wrap-'+sk);
  const skipped=document.getElementById('batcalc-skipped-'+sk);
  if(wrap) wrap.style.display='none';
  if(skipped) skipped.style.display='flex';
}

function unskipBatCalc(sk){
  ensureData(sk);
  delete itemData[sk].batCalcSkipped;
  const wrap=document.getElementById('batcalc-wrap-'+sk);
  const skipped=document.getElementById('batcalc-skipped-'+sk);
  if(wrap) wrap.style.display='';
  if(skipped) skipped.style.display='none';
}

function saveBatField(sk,field,value,btn){
  ensureData(sk);
  if(itemData[sk].batCalcSkipped) delete itemData[sk].batCalcSkipped;
  hideToast(sk);
  if(btn){
    // Toggle button
    if(itemData[sk][field]===value) itemData[sk][field]='';
    else itemData[sk][field]=value;
    const p=btn.parentElement;
    p.querySelectorAll('.mount-btn').forEach(b=>b.classList.remove('active'));
    if(itemData[sk][field]) btn.classList.add('active');
  } else {
    itemData[sk][field]=value;
  }
  calcBattery(sk);
}

function validateBatCalc(sk){
  const d=itemData[sk]||{};
  if(d.batCalcSkipped){ calcBattery(sk); return true; }
  const bt=d.batType||'';
  const bp=d.batProductie||'';
  const ba=d.batAfname||'';
  const bi=d.batInjectie||'';
  const filled=[bt,bp,ba,bi].filter(v=>v!=='').length;
  if(filled>=1&&filled<4){
    const missing=[];
    if(!bt) missing.push('Type batterij');
    if(!bp) missing.push('Productie');
    if(!ba) missing.push('Afname');
    if(!bi) missing.push('Injectie');
    showToast(sk,'Ontbrekend: '+missing.join(', '));
    calcBattery(sk);
    return false;
  } else if(filled===0){
    showToast(sk,'Vul batterij configurator in of druk op üóë om over te slaan');
    calcBattery(sk);
    return false;
  } else if(filled===4){
    const productie=parseFloat(bp)||0;
    const injectie=parseFloat(bi)||0;
    if(injectie>productie){
      showToast(sk,'‚ö†Ô∏è Injectie kan niet hoger zijn dan Productie');
      calcBattery(sk);
      return false;
    }
  }
  calcBattery(sk);
  return true;
}

function calcBattery(sk){
  const d=itemData[sk];
  if(!d) return;
  const el=document.getElementById('bat-result-'+sk);
  if(!el) return;

  const productie=parseFloat(d.batProductie)||0;
  const afname=parseFloat(d.batAfname)||0;
  const injectie=parseFloat(d.batInjectie)||0;
  const batType=d.batType||'';

  if(!productie||!afname||!injectie||!batType){
    el.innerHTML='';
    return;
  }

  // Verbruik = eigen verbruik + afname = (productie - injectie) + afname
  const eigenZonder=productie-injectie;

  if(eigenZonder<0){
    el.innerHTML=`<div style="padding:10px;border-radius:8px;background:rgba(231,76,60,.12);border:1px solid rgba(231,76,60,.3);font-size:12px;color:#e74c3c">
      ‚ö†Ô∏è <strong>Ongeldige combinatie:</strong> Injectie (${injectie.toLocaleString('nl')}) kan niet hoger zijn dan Productie (${productie.toLocaleString('nl')})
    </div>`;
    return;
  }

  const verbruik=eigenZonder+afname;

  const specs={
    h3:   {moduleKwh:5.12, dod:0.95, minMod:2, maxMod:7, name:'Force H3',   voltage:'HV', omvormer:'Solis S6 3-fase'},
    pelio:{moduleKwh:5.12, dod:0.95, minMod:1, maxMod:4, name:'Pelio',       voltage:'LV 48V', omvormer:'Solis S5 1-fase'},
    fidus:{moduleKwh:5.12, dod:0.97, minMod:1, maxMod:4, name:'Fidus',       voltage:'LV 48V', omvormer:'Solis S5 1-fase'},
  };
  const sp=specs[batType];

  // Kerngetallen
  const eigenPctZonder=Math.round((eigenZonder/productie)*1000)/10;
  const dagVerbruik=Math.round((verbruik/365)*100)/100;
  const dagAfname=afname/365;
  const dagInjectie=injectie/365;

  // Batterij model: exponenti√´le saturatiecurve
  // shiftRatio: fractie avond/nachtverbruik dat batterij kan bedienen (~54%)
  const shiftRatio=0.54;
  const dagMaxCapture=Math.min(dagAfname,dagInjectie)*shiftRatio;
  const k=3.85, p=1.5;

  let rows='';
  let bestAantal=sp.minMod;
  let prevEigen=0;

  for(let n=sp.minMod;n<=sp.maxMod;n++){
    const totKwh=n*sp.moduleKwh;
    const usable=totKwh*sp.dod;
    const ratio=usable/dagAfname;
    const pct=1-Math.exp(-k*Math.pow(ratio,p));
    const dagCapture=dagMaxCapture*pct;
    const jaarCapture=dagCapture*365;
    const nettoAfname=Math.max(afname-jaarCapture,0);
    const eigenNieuw=Math.min(Math.round(((eigenZonder+jaarCapture)/productie)*1000)/10,100);
    const laadcycli=Math.round(jaarCapture/totKwh);

    if(n===sp.minMod||eigenNieuw-prevEigen>0.3) bestAantal=n;
    prevEigen=eigenNieuw;

    const isBest=n===bestAantal;
    const bestStyle=isBest?'background:rgba(46,204,113,.15);font-weight:600;color:#2ecc71':'';
    rows+=`<tr style="${bestStyle}">
      <td style="padding:5px 8px;text-align:center">${n}</td>
      <td style="padding:5px 8px;text-align:center">${sp.moduleKwh.toFixed(2)}</td>
      <td style="padding:5px 8px;text-align:center">${totKwh.toFixed(2)}</td>
      <td style="padding:5px 8px;text-align:right">${nettoAfname.toLocaleString('nl',{minimumFractionDigits:0,maximumFractionDigits:0})}</td>
      <td style="padding:5px 8px;text-align:center">${eigenPctZonder}%</td>
      <td style="padding:5px 8px;text-align:center">${eigenNieuw}%</td>
      <td style="padding:5px 8px;text-align:center">${laadcycli}</td>
    </tr>`;
  }

  // Aanbevolen model details
  const bestTot=bestAantal*sp.moduleKwh;
  const bestUsable=bestTot*sp.dod;
  const bestR=bestUsable/dagAfname;
  const bestPct=1-Math.exp(-k*Math.pow(bestR,p));
  const bestJaar=dagMaxCapture*bestPct*365;
  const bestNetto=Math.max(afname-bestJaar,0);
  const bestEigen=Math.min(((eigenZonder+bestJaar)/productie*100),100);
  const bestBespaard=Math.round(afname-bestNetto);

  el.innerHTML=`
    <div style="margin-bottom:10px;padding:10px;border-radius:8px;background:rgba(255,255,255,.06);font-size:12px;color:var(--text2);line-height:1.8">
      <div><strong>VERBRUIK:</strong> ${verbruik.toLocaleString('nl')} kWh | <strong style="color:#4caf50">PRODUCTIE:</strong> ${productie.toLocaleString('nl')} kWh</div>
      <div><strong>AFNAME:</strong> ${afname.toLocaleString('nl')} kWh | <strong style="color:#2196f3">INJECTIE:</strong> ${injectie.toLocaleString('nl')} kWh</div>
      <div>Gem. verbruik/dag: <strong>${dagVerbruik}</strong> kWh | Eigen verbruik zonder batterij: <strong>${eigenPctZonder}%</strong></div>
      <div>Type: <strong>Pylontech ${sp.name}</strong> (${sp.moduleKwh} kWh, ${sp.voltage}) + <strong>${sp.omvormer}</strong></div>
    </div>
    <div style="overflow-x:auto">
    <table style="width:100%;font-size:12px;border-collapse:collapse;color:var(--text1)">
      <thead><tr style="border-bottom:2px solid rgba(255,255,255,.15)">
        <th style="padding:5px 8px">Aantal</th>
        <th style="padding:5px 8px">Grootte</th>
        <th style="padding:5px 8px">Totaal</th>
        <th style="padding:5px 8px;text-align:right">Netto Afname</th>
        <th style="padding:5px 8px">Eigen</th>
        <th style="padding:5px 8px">Verbeterd</th>
        <th style="padding:5px 8px">Laadcycli</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
    </div>
    <div style="margin-top:10px;padding:10px;border-radius:8px;background:rgba(46,204,113,.08);border:1px solid rgba(46,204,113,.2);font-size:12px;color:var(--text1);line-height:1.8">
      <div><strong style="color:#2ecc71">‚úì Aanbevolen: ${bestAantal}√ó Pylontech ${sp.name} (${bestTot.toFixed(2)} kWh)</strong></div>
      <div>Bruikbaar: ${bestUsable.toFixed(1)} kWh (${(sp.dod*100).toFixed(0)}% DoD) | Bespaard van net: ~${bestBespaard.toLocaleString('nl')} kWh/jaar</div>
      <div>Eigen verbruik: ${eigenPctZonder}% ‚Üí <strong>${bestEigen.toFixed(1)}%</strong> | Netto afname: ${Math.round(bestNetto).toLocaleString('nl')} kWh/jaar</div>
    </div>
  `;
}


function saveLocation(sk,loc,btn){
  ensureData(sk);
  // Toggle: if same location clicked, deselect
  if(itemData[sk].location===loc){
    itemData[sk].location='';
  } else {
    itemData[sk].location=loc;
  }
  hideToast(sk);

  // Cross-check between omvormer and loc-bat locations
  if(itemData[sk].location){
    const omvSk='omvormer'; // shared key
    const batSk='solar_loc-bat';
    const locNames={kelder:'kelder',gelijkvloers:'gelijkvloers',verdieping:'verdieping'};

    if(sk===omvSk){
      // Omvormer changed ‚Äî check if loc-bat has a different location
      const batData=itemData[batSk];
      if(batData && batData.location && batData.location!==itemData[sk].location){
        showToast(sk,`Thuisbatterij staat in ${locNames[batData.location]}`);
      }
    } else if(sk===batSk){
      // Loc-bat changed ‚Äî check if omvormer has a different location
      const omvData=itemData[omvSk];
      if(omvData && omvData.location && omvData.location!==itemData[sk].location){
        showToast(sk,`Omvormer staat in ${locNames[omvData.location]}`);
      }
    }
  }

  // Update button states
  const parent=btn.parentElement;
  parent.querySelectorAll('.loc-btn').forEach(b=>b.classList.remove('active'));
  if(itemData[sk].location){
    parent.querySelectorAll('.loc-btn').forEach(b=>{
      if(b.textContent.toLowerCase()===itemData[sk].location) b.classList.add('active');
    });
  }
}

function toggleBoardType(sk,type,btn){
  ensureData(sk);
  if(!itemData[sk].boardType) itemData[sk].boardType={};
  // Toggle: both can be selected independently
  itemData[sk].boardType[type]=!itemData[sk].boardType[type];
  btn.classList.toggle('active',itemData[sk].boardType[type]);
}

function toggleMeterType(sk,type,btn){
  ensureData(sk);
  if(!itemData[sk].meterType) itemData[sk].meterType=[];
  const idx=itemData[sk].meterType.indexOf(type);
  if(idx===-1) itemData[sk].meterType.push(type);
  else itemData[sk].meterType.splice(idx,1);
  btn.classList.toggle('active',itemData[sk].meterType.includes(type));
}

function savePhaseType(sk,type,btn){
  ensureData(sk);
  if(itemData[sk].phaseType===type){
    itemData[sk].phaseType='';
  } else {
    itemData[sk].phaseType=type;
  }
  hideToast(sk);
  const parent=btn.parentElement;
  parent.querySelectorAll('.mount-btn').forEach(b=>b.classList.remove('active'));
  if(itemData[sk].phaseType) btn.classList.add('active');
}

function saveMountType(sk,type,btn){
  ensureData(sk);
  // Toggle: if same type clicked, deselect
  if(itemData[sk].mountType===type){
    itemData[sk].mountType='';
  } else {
    itemData[sk].mountType=type;
  }
  const parent=btn.parentElement;
  parent.querySelectorAll('.mount-btn').forEach(b=>b.classList.remove('active'));
  if(itemData[sk].mountType){
    parent.querySelectorAll('.mount-btn').forEach(b=>{
      if(b.textContent.toLowerCase()===itemData[sk].mountType) b.classList.add('active');
    });
  }
}

function saveFixType(sk,type,btn){
  ensureData(sk);
  if(itemData[sk].fixType===type){
    itemData[sk].fixType='';
  } else {
    itemData[sk].fixType=type;
  }
  hideToast(sk);
  const parent=btn.parentElement;
  parent.querySelectorAll('.mount-btn').forEach(b=>b.classList.remove('active'));
  if(itemData[sk].fixType){
    parent.querySelectorAll('.mount-btn').forEach(b=>{
      if(b.textContent.toLowerCase()===itemData[sk].fixType) b.classList.add('active');
    });
  }
}

function saveUnitType(sk,type,btn){
  ensureData(sk);
  if(itemData[sk].unitType===type){
    itemData[sk].unitType='';
  } else {
    itemData[sk].unitType=type;
  }
  hideToast(sk);
  const parent=btn.parentElement;
  parent.querySelectorAll('.mount-btn').forEach(b=>b.classList.remove('active'));
  if(itemData[sk].unitType){
    parent.querySelectorAll('.mount-btn').forEach(b=>{
      if(b.textContent.toLowerCase()===itemData[sk].unitType) b.classList.add('active');
    });
  }
}

function saveConnType(sk,type,btn){
  ensureData(sk);
  if(itemData[sk].connType===type){
    itemData[sk].connType='';
  } else {
    itemData[sk].connType=type;
  }
  hideToast(sk);
  const parent=btn.parentElement;
  parent.querySelectorAll('.mount-btn').forEach(b=>b.classList.remove('active'));
  if(itemData[sk].connType){
    btn.classList.add('active');
  }
}

function refreshItem(sk){
  // Re-render all items to update OK/NOK badges and trash visibility
  renderItems();
  // Re-open the item that was being edited
  const ci=document.getElementById('ci-'+sk);
  if(ci && !ci.classList.contains('deleted')) ci.classList.add('open');
}

function updateProgress(){
  const items=itemsForTab(activeTab).filter(i=>!deletedItems.has(i.sk));
  const done=items.filter(i=>{const d=itemData[i.sk];return d&&(d.photos.length>0||d.notes.trim()!=='');}).length;
  const pct=items.length?Math.round(done/items.length*100):0;
  document.getElementById('prog-txt').textContent=`${done} van ${items.length} ingevuld`;
  document.getElementById('prog-pct').textContent=pct+'%';
  document.getElementById('prog-fill').style.width=pct+'%';
  // Dynamic solar label
  if(activeTab==='solar'){
    const dakSk=getSK('solar',{shared:false,key:'dak'});
    const batSk=getSK('solar',{shared:false,key:'loc-bat'});
    const intSk=getSK('solar',{shared:false,key:'internet'});
    const dakDel=deletedItems.has(dakSk);
    const batDel=deletedItems.has(batSk);
    const intDel=deletedItems.has(intSk);
    const dakD=itemData[dakSk];
    const batD=itemData[batSk];
    const intD=itemData[intSk];
    const dakActive=!dakDel;
    const batActive=!batDel;
    const intActive=!intDel;
    const hasDakData=dakActive&&dakD&&(dakD.photos.length>0||dakD.notes.trim()!=='');
    const hasBatData=batActive&&batD&&(batD.photos.length>0||batD.notes.trim()!=='');
    const hasIntData=intActive&&intD&&(intD.photos.length>0||intD.notes.trim()!=='');
    let newLabel='Zon / Thuisbatterij';
    let newIcon='‚òÄÔ∏èüîã';
    // Deleted = niet meer in checklist = niet van toepassing
    if(dakDel&&(!batDel||!intDel)){newLabel='Thuisbatterij';newIcon='üîã';}
    else if((batDel&&intDel)&&!dakDel){newLabel='Zonnepanelen';newIcon='‚òÄÔ∏è';}
    else if(hasDakData&&!hasBatData&&!hasIntData){newLabel='Zonnepanelen';newIcon='‚òÄÔ∏è';}
    else if(!hasDakData&&(hasBatData||hasIntData)){newLabel='Thuisbatterij';newIcon='üîã';}
    TYPES['solar'].label=newLabel;
    TYPES['solar'].icon=newIcon;
    const hubName=document.querySelector('#hub-solar .tname');
    if(hubName) hubName.textContent='Checklist '+newLabel;
    const hubIcon=document.querySelector('#hub-solar .ticon');
    if(hubIcon) hubIcon.textContent=newIcon;
    // Also update checklist title
    document.getElementById('checklist-title').textContent='Checklist '+newLabel;
  }
  // Show photo/text scores
  const scores=calculateScores(activeTab);
  const pEl=document.getElementById('prog-scores');
  if(pEl){
    pEl.innerHTML=`
      <span>üì∑ <span style="color:${scores.photo>=100?'var(--success)':scores.photo<=50?'#ff5c5c':'var(--text2)'}">${scores.photo}%</span></span>
      <span>üìù <span style="color:${scores.text>=100?'var(--success)':scores.text<=50?'#ff5c5c':'var(--text2)'}">${scores.text}%</span></span>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV helpers
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goStep(n){
  if(n===1){goBackToHub();return;}
  if(n===2){showPanel('panel-2');renderChecklist();return;}
  if(n===3){showPanel('panel-3');renderOverview();return;}
  window.scrollTo({top:0,behavior:'smooth'});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDITOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const edCanvas=document.getElementById('ed-canvas');
const edCtx=edCanvas.getContext('2d');
let baseImg=null, annotations=[], penPath=[];
let drawing=false, startX=0, startY=0;
let curTool='arrow', curColor='#ff3b30', curSize=5, curStamp=null;
let edSK='', edIdx=-1;
const stampCache={};
let selectedIdx=-1, transformMode=null, transformHandle=null, origAnnotation=null;

function openEditor(sk,idx){
  edSK=sk; edIdx=idx;
  selectedIdx=-1; transformMode=null;
  const photoData=itemData[sk].photos[idx];
  // Restore saved annotations if they exist
  const photoMeta=itemData[sk].photoMeta||{};
  const meta=photoMeta[idx]||{};
  annotations=meta.annotations?JSON.parse(JSON.stringify(meta.annotations)):[];
  const img=new Image();
  img.onload=()=>{
    const maxW=window.innerWidth-16;
    const maxH=window.innerHeight-180;
    let w=img.width,h=img.height;
    if(w>maxW){h=Math.round(h*maxW/w);w=maxW;}
    if(h>maxH){w=Math.round(w*maxH/h);h=maxH;}
    edCanvas.width=w; edCanvas.height=h;
    baseImg=img; redraw();
    document.getElementById('editor-overlay').classList.add('open');
  };
  // Load original unannotated image if available
  img.src=meta.originalData||photoData;
}

function updateSelectionUI(){
  const delBtn=document.getElementById('tool-del-sel');
  const fontCtrl=document.getElementById('ed-font-ctrl');
  if(selectedIdx>=0){
    if(delBtn)delBtn.style.display='flex';
    if(fontCtrl&&annotations[selectedIdx]&&annotations[selectedIdx].type==='textbox'){
      fontCtrl.style.display='flex';fontCtrl.style.alignItems='center';fontCtrl.style.gap='6px';
      document.getElementById('ed-font-size').textContent=annotations[selectedIdx].fontSize;
    } else if(fontCtrl){fontCtrl.style.display='none';}
  } else {
    if(delBtn)delBtn.style.display='none';
    if(fontCtrl)fontCtrl.style.display='none';
  }
}
function deleteSelected(){if(selectedIdx>=0){annotations.splice(selectedIdx,1);selectedIdx=-1;updateSelectionUI();redraw();}}
function changeFontSize(delta){
  if(selectedIdx<0)return;const a=annotations[selectedIdx];
  if(a&&a.type==='textbox'){a.fontSize=Math.max(10,Math.min(72,a.fontSize+delta));
    document.getElementById('ed-font-size').textContent=a.fontSize;redraw();}
}

function redraw(){
  if(!baseImg)return;
  edCtx.drawImage(baseImg,0,0,edCanvas.width,edCanvas.height);
  annotations.forEach((a,i)=>{
    paintAnnotation(a);
    if(i===selectedIdx && curTool==='select') drawSelectionBox(a);
  });
  updateSelectionUI();
}

function drawSelectionBox(a){
  const b=getBounds(a); if(!b) return;
  edCtx.save();
  edCtx.strokeStyle='#4f8ef7'; edCtx.lineWidth=2; edCtx.setLineDash([5,5]);
  edCtx.strokeRect(b.x,b.y,b.w,b.h);
  const hs=10;
  [[b.x,b.y],[b.x+b.w,b.y],[b.x,b.y+b.h],[b.x+b.w,b.y+b.h]].forEach(([hx,hy])=>{
    edCtx.fillStyle='#4f8ef7';
    edCtx.fillRect(hx-hs/2,hy-hs/2,hs,hs);
  });
  const cx=b.x+b.w/2, cy=b.y-25;
  edCtx.beginPath();edCtx.arc(cx,cy,8,0,Math.PI*2);edCtx.fillStyle='#38d9a9';edCtx.fill();
  edCtx.strokeStyle='#fff';edCtx.lineWidth=2;edCtx.setLineDash([]);edCtx.stroke();
  edCtx.beginPath();edCtx.moveTo(b.x+b.w/2,b.y);edCtx.lineTo(cx,cy);
  edCtx.strokeStyle='#38d9a9';edCtx.lineWidth=2;edCtx.setLineDash([3,3]);edCtx.stroke();
  edCtx.restore();
}

function getBounds(a){
  if(a.type==='stamp'||a.type==='text'){
    const s=a.scale||1, w=80*s, h=60*s;
    return {x:a.x-w/2, y:a.y-h/2, w:w, h:h};
  }
  if(a.type==='textbox') return {x:a.x, y:a.y, w:a.w, h:a.h};
  if(['rect','circle','arrow','line'].includes(a.type))
    return {x:Math.min(a.x1,a.x2),y:Math.min(a.y1,a.y2),w:Math.abs(a.x2-a.x1)||4,h:Math.abs(a.y2-a.y1)||4};
  if(a.type==='pen'&&a.path&&a.path.length>0){
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
    a.path.forEach(p=>{if(p.x<minX)minX=p.x;if(p.y<minY)minY=p.y;if(p.x>maxX)maxX=p.x;if(p.y>maxY)maxY=p.y;});
    const pad=5;
    return {x:minX-pad, y:minY-pad, w:(maxX-minX)+pad*2, h:(maxY-minY)+pad*2};
  }
  return null;
}

function hitTest(p,a){
  const b=getBounds(a); if(!b) return false;
  return p.x>=b.x && p.x<=b.x+b.w && p.y>=b.y && p.y<=b.y+b.h;
}

function getHandle(p,a){
  const b=getBounds(a); if(!b) return null;
  const cx=b.x+b.w/2, cy=b.y-25;
  if(Math.sqrt(Math.pow(p.x-cx,2)+Math.pow(p.y-cy,2))<12) return 'rotate';
  const hs=14;
  const handles=[{n:'tl',x:b.x,y:b.y},{n:'tr',x:b.x+b.w,y:b.y},
                 {n:'bl',x:b.x,y:b.y+b.h},{n:'br',x:b.x+b.w,y:b.y+b.h}];
  for(let h of handles) if(Math.abs(p.x-h.x)<hs && Math.abs(p.y-h.y)<hs) return h.n;
  return null;
}

function paintAnnotation(a){
  edCtx.save();
  edCtx.strokeStyle=a.color;edCtx.fillStyle=a.color;
  edCtx.lineWidth=a.size;edCtx.lineCap='round';edCtx.lineJoin='round';
  
  if(a.rotation && (a.type==='stamp'||a.type==='text'||a.type==='rect'||a.type==='circle')){
    const b=getBounds(a);
    const cx=a.type==='stamp'||a.type==='text' ? a.x : b.x+b.w/2;
    const cy=a.type==='stamp'||a.type==='text' ? a.y : b.y+b.h/2;
    edCtx.translate(cx,cy);edCtx.rotate(a.rotation);edCtx.translate(-cx,-cy);
  }
  
  if(a.type==='pen'&&a.path){
    edCtx.beginPath();
    a.path.forEach((p,i)=>i===0?edCtx.moveTo(p.x,p.y):edCtx.lineTo(p.x,p.y));
    edCtx.stroke();
  } else if(a.type==='line'){
    edCtx.lineWidth=4;edCtx.beginPath();edCtx.moveTo(a.x1,a.y1);edCtx.lineTo(a.x2,a.y2);edCtx.stroke();
  } else if(a.type==='arrow'){
    edCtx.lineWidth=4;edCtx.beginPath();edCtx.moveTo(a.x1,a.y1);edCtx.lineTo(a.x2,a.y2);edCtx.stroke();
    const angle=Math.atan2(a.y2-a.y1,a.x2-a.x1),hl=18;
    edCtx.beginPath();edCtx.moveTo(a.x2,a.y2);
    edCtx.lineTo(a.x2-hl*Math.cos(angle-Math.PI/6),a.y2-hl*Math.sin(angle-Math.PI/6));
    edCtx.moveTo(a.x2,a.y2);
    edCtx.lineTo(a.x2-hl*Math.cos(angle+Math.PI/6),a.y2-hl*Math.sin(angle+Math.PI/6));
    edCtx.stroke();
  } else if(a.type==='rect'){
    edCtx.lineWidth=8;
    edCtx.strokeRect(a.x1,a.y1,a.x2-a.x1,a.y2-a.y1);
  } else if(a.type==='circle'){
    edCtx.lineWidth=8;
    const rx=Math.abs(a.x2-a.x1)/2,ry=Math.abs(a.y2-a.y1)/2;
    const cx=(a.x1+a.x2)/2,cy=(a.y1+a.y2)/2;
    edCtx.beginPath();edCtx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2);edCtx.stroke();
  } else if(a.type==='text'){
    edCtx.font=`bold ${22}px sans-serif`;
    edCtx.fillText(a.text,a.x1,a.y1);
  } else if(a.type==='textbox'){
    edCtx.font=`bold ${a.fontSize}px 'DM Sans',sans-serif`;
    edCtx.textBaseline='top';
    edCtx.shadowColor='rgba(0,0,0,.6)';edCtx.shadowBlur=3;edCtx.shadowOffsetX=1;edCtx.shadowOffsetY=1;
    const words=a.text.split(' ');
    let line='', lines=[];
    const maxWidth=a.w-10;
    words.forEach(word=>{
      const testLine=line+word+' ';
      const metrics=edCtx.measureText(testLine);
      if(metrics.width>maxWidth && line!==''){lines.push(line);line=word+' ';}
      else line=testLine;
    });
    if(line) lines.push(line);
    const lineHeight=a.fontSize*1.3;
    lines.forEach((l,i)=>edCtx.fillText(l.trim(),a.x+5,a.y+5+i*lineHeight));
  } else if(a.type==='stamp'){
    const s=STAMPS[a.stampId], scale=a.scale||1, w=80*scale, h=56*scale;
    if(stampCache[a.stampId]){
      edCtx.drawImage(stampCache[a.stampId],a.x-w/2,a.y-h/2,w,h);
    } else if(s.emoji){
      edCtx.font=`${Math.round(36*scale)}px serif`;edCtx.fillText(s.emoji,a.x-18*scale,a.y+12*scale);
    }
    edCtx.font=`bold ${Math.round(11*scale)}px sans-serif`;edCtx.fillStyle=a.color;
    edCtx.fillText(s.label,a.x-30*scale,a.y+36*scale);
  }
  edCtx.restore();
}

function getPos(e){
  const r=edCanvas.getBoundingClientRect(),src=e.touches?e.touches[0]:e;
  return {x:(src.clientX-r.left)*(edCanvas.width/r.width),
          y:(src.clientY-r.top)*(edCanvas.height/r.height)};
}

edCanvas.addEventListener('pointerdown',e=>{
  e.preventDefault();const p=getPos(e);startX=p.x;startY=p.y;
  if(curTool==='select'){
    drawing=true;
    if(selectedIdx>=0){
      transformHandle=getHandle(p,annotations[selectedIdx]);
      if(transformHandle){transformMode='resize';origAnnotation=JSON.parse(JSON.stringify(annotations[selectedIdx]));return;}
    }
    for(let i=annotations.length-1;i>=0;i--){
      if(hitTest(p,annotations[i])){
        selectedIdx=i; transformMode='move';
        origAnnotation=JSON.parse(JSON.stringify(annotations[i]));
        redraw(); return;
      }
    }
    selectedIdx=-1; transformMode=null; redraw(); return;
  }
  drawing=true;
  if(curTool==='pen') penPath=[{x:p.x,y:p.y}];
  if(curTool==='stamp'&&curStamp){
    annotations.push({type:'stamp',stampId:curStamp,x:p.x,y:p.y,color:curColor,size:curSize,scale:1,rotation:0});
    redraw();drawing=false;
  }
},{passive:false});

edCanvas.addEventListener('pointermove',e=>{
  if(!drawing)return;e.preventDefault();const p=getPos(e);
  if(curTool==='select' && transformMode==='move' && selectedIdx>=0){
    const a=annotations[selectedIdx], dx=p.x-startX, dy=p.y-startY;
    if(a.type==='stamp'||a.type==='text'){ a.x=origAnnotation.x+dx; a.y=origAnnotation.y+dy; }
    else if(['rect','circle','arrow','line'].includes(a.type)){
      a.x1=origAnnotation.x1+dx; a.y1=origAnnotation.y1+dy;
      a.x2=origAnnotation.x2+dx; a.y2=origAnnotation.y2+dy;
    }
    else if(a.type==='textbox'){ a.x=origAnnotation.x+dx; a.y=origAnnotation.y+dy; }
    else if(a.type==='pen'&&a.path){
      a.path=origAnnotation.path.map(pt=>({x:pt.x+dx,y:pt.y+dy}));
    }
    redraw(); return;
  }
  if(curTool==='select' && transformMode==='resize' && selectedIdx>=0){
    const a=annotations[selectedIdx];
    if(transformHandle==='rotate'){
      const b=getBounds(origAnnotation);
      const cx=b.x+b.w/2, cy=b.y+b.h/2;
      const startAngle=Math.atan2(startY-cy,startX-cx);
      const currAngle=Math.atan2(p.y-cy,p.x-cx);
      a.rotation=(origAnnotation.rotation||0)+(currAngle-startAngle);
    } else if(a.type==='stamp'||a.type==='text'){
      const origB=getBounds(origAnnotation);
      const origDist=Math.sqrt(Math.pow(origB.w/2,2)+Math.pow(origB.h/2,2));
      const newDist=Math.sqrt(Math.pow(p.x-a.x,2)+Math.pow(p.y-a.y,2));
      a.scale=(origAnnotation.scale||1)*(newDist/origDist);
      a.scale=Math.max(0.3,Math.min(3,a.scale));
    } else if(['rect','circle','arrow','line'].includes(a.type)){
      if(transformHandle==='tl'){ a.x1=p.x; a.y1=p.y; }
      else if(transformHandle==='tr'){ a.x2=p.x; a.y1=p.y; }
      else if(transformHandle==='bl'){ a.x1=p.x; a.y2=p.y; }
      else if(transformHandle==='br'){ a.x2=p.x; a.y2=p.y; }
    } else if(a.type==='textbox'){
      const ob=origAnnotation;
      if(transformHandle==='tl'){ a.w=ob.x+ob.w-p.x; a.h=ob.y+ob.h-p.y; a.x=p.x; a.y=p.y; }
      else if(transformHandle==='tr'){ a.w=p.x-ob.x; a.h=ob.y+ob.h-p.y; a.y=p.y; }
      else if(transformHandle==='bl'){ a.w=ob.x+ob.w-p.x; a.h=p.y-ob.y; a.x=p.x; }
      else if(transformHandle==='br'){ a.w=p.x-ob.x; a.h=p.y-ob.y; }
    }
    redraw(); return;
  }
  if(curTool==='pen'){
    penPath.push({x:p.x,y:p.y});
    edCtx.save();edCtx.strokeStyle=curColor;edCtx.lineWidth=curSize;edCtx.lineCap='round';edCtx.lineJoin='round';
    edCtx.beginPath();penPath.forEach((pt,i)=>i===0?edCtx.moveTo(pt.x,pt.y):edCtx.lineTo(pt.x,pt.y));
    edCtx.stroke();edCtx.restore();
  } else if(['rect','circle','arrow','line'].includes(curTool)) {
    redraw();
    paintAnnotation({type:curTool,x1:startX,y1:startY,x2:p.x,y2:p.y,color:curColor,size:curSize});
  } else if(curTool==='text') {
    redraw();
    edCtx.save();edCtx.strokeStyle=curColor;edCtx.lineWidth=2;edCtx.setLineDash([5,5]);
    edCtx.strokeRect(startX,startY,p.x-startX,p.y-startY);edCtx.restore();
  }
},{passive:false});

edCanvas.addEventListener('pointerup',e=>{
  if(!drawing)return;e.preventDefault();const p=getPos(e);
  if(curTool==='select'){
    transformMode=null; transformHandle=null; origAnnotation=null;
    drawing=false; return;
  }
  if(curTool==='pen') annotations.push({type:'pen',path:[...penPath],color:curColor,size:curSize});
  else if(['rect','circle','arrow','line'].includes(curTool))
    annotations.push({type:curTool,x1:startX,y1:startY,x2:p.x,y2:p.y,color:curColor,size:curSize,rotation:0});
  else if(curTool==='text') showTextInput(startX,startY,p.x,p.y);
  drawing=false;redraw();
},{passive:false});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEXT INPUT OVERLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let textBoxBounds = null;

function showTextInput(x1,y1,x2,y2) {
  const w=Math.abs(x2-x1), h=Math.abs(y2-y1);
  if(w<20 || h<20) return;
  textBoxBounds = {x:Math.min(x1,x2), y:Math.min(y1,y2), w:w, h:h};
  const overlay=document.getElementById('text-overlay');
  const canvasRect=edCanvas.getBoundingClientRect();
  overlay.style.display='block';
  overlay.style.left=(canvasRect.left + textBoxBounds.x)+'px';
  overlay.style.top=(canvasRect.top + textBoxBounds.y + textBoxBounds.h + 10)+'px';
  document.getElementById('text-input').value='';
  document.getElementById('text-input').focus();
}

function confirmTextInput() {
  const text=document.getElementById('text-input').value.trim();
  const fontSize=parseInt(document.getElementById('text-size').value);
  if(text && textBoxBounds) {
    annotations.push({type:'textbox',text:text,x:textBoxBounds.x,y:textBoxBounds.y,
      w:textBoxBounds.w,h:textBoxBounds.h,fontSize:fontSize,color:curColor,rotation:0});
    redraw();
  }
  document.getElementById('text-overlay').style.display='none';
  textBoxBounds=null;
}

function cancelTextInput() {
  document.getElementById('text-overlay').style.display='none';
  textBoxBounds=null;redraw();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOOLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTool(t){
  curTool=t; selectedIdx=-1; updateSelectionUI();
  document.querySelectorAll('.tbtn[id^="tool-"]').forEach(b=>b.classList.remove('active'));
  const el=document.getElementById('tool-'+t);if(el)el.classList.add('active');
  if(t!=='stamp')document.getElementById('stamp-tray').classList.remove('open');
  if(t==='select') edCanvas.style.cursor='default'; else edCanvas.style.cursor='crosshair';
  redraw();
}
function setColor(c,el){
  curColor=c;
  document.querySelectorAll('.cswatch').forEach(s=>s.classList.remove('active'));
  el.classList.add('active');
  // Update selected annotation color too
  if(selectedIdx>=0){annotations[selectedIdx].color=c;redraw();}
}
function setSize(s,el){curSize=s;document.querySelectorAll('.szb').forEach(b=>b.classList.remove('active'));el.classList.add('active');}
function undoLast(){if(annotations.length){annotations.pop();selectedIdx=-1;updateSelectionUI();redraw();}}
function clearAll(){annotations=[];selectedIdx=-1;updateSelectionUI();redraw();}
function toggleTray(){document.getElementById('stamp-tray').classList.toggle('open');curTool='stamp';}
function pickStamp(id,el){curStamp=id;document.querySelectorAll('.sitem').forEach(s=>s.classList.remove('active'));el.classList.add('active');}

function saveEditor(){
  const photoData=itemData[edSK].photos[edIdx];
  // Initialize photoMeta if needed
  if(!itemData[edSK].photoMeta)itemData[edSK].photoMeta={};
  if(!itemData[edSK].photoMeta[edIdx])itemData[edSK].photoMeta[edIdx]={};
  const meta=itemData[edSK].photoMeta[edIdx];
  // Save original unannotated image (only first time)
  if(!meta.originalData)meta.originalData=photoData;
  // Save annotations as editable objects
  meta.annotations=JSON.parse(JSON.stringify(annotations));
  // Save flattened preview for display/export
  itemData[edSK].photos[edIdx]=edCanvas.toDataURL('image/jpeg',.92);
  refreshItem(edSK);closeEditor();
}
function closeEditor(){document.getElementById('editor-overlay').classList.remove('open');document.getElementById('stamp-tray').classList.remove('open');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAIKIN ILLUSTRATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawBinnen(ctx,w,h){
  ctx.fillStyle='#1e2336';ctx.beginPath();
  if(ctx.roundRect)ctx.roundRect(0,0,w,h,4);else ctx.rect(0,0,w,h);ctx.fill();
  ctx.fillStyle='#4f8ef7';ctx.fillRect(0,0,w,h*0.35);
  ctx.fillStyle='#e8ecf5';ctx.font=`bold ${Math.round(h*0.22)}px sans-serif`;
  ctx.fillText('DAIKIN',4,h*0.27);
  ctx.fillStyle='#38d9a9';ctx.beginPath();ctx.arc(w-8,h*0.17,4,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#2a2f45';
  for(let i=0;i<4;i++)ctx.fillRect(4+i*(w/4-1),h*0.42,w/4-3,h*0.12);
}
function drawBuiten(ctx,w,h){
  ctx.fillStyle='#1e2336';ctx.beginPath();
  if(ctx.roundRect)ctx.roundRect(0,0,w,h,4);else ctx.rect(0,0,w,h);ctx.fill();
  ctx.strokeStyle='#3d4460';ctx.lineWidth=1;ctx.strokeRect(.5,.5,w-1,h-1);
  ctx.fillStyle='#e8ecf5';ctx.font=`bold ${Math.round(h*0.2)}px sans-serif`;ctx.fillText('DAIKIN',4,h*0.22);
  ctx.strokeStyle='#4f8ef7';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.arc(w/2,h*0.62,h*0.28,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.arc(w/2,h*0.62,h*0.1,0,Math.PI*2);ctx.stroke();
  for(let i=0;i<4;i++){
    const a=i*Math.PI/2;const r1=h*0.1,r2=h*0.28,cx=w/2,cy=h*0.62;
    ctx.beginPath();ctx.moveTo(cx+Math.cos(a)*r1,cy+Math.sin(a)*r1);ctx.lineTo(cx+Math.cos(a)*r2,cy+Math.sin(a)*r2);ctx.stroke();
  }
}

function initStamps(){
  ['daikin-binnen','daikin-buiten'].forEach(id=>{
    const prev=document.getElementById('prev-'+id);
    const fn=id==='daikin-binnen'?drawBinnen:drawBuiten;
    if(prev){const ctx=prev.getContext('2d');fn(ctx,48,36);}
    const c=document.createElement('canvas');c.width=80;c.height=56;
    fn(c.getContext('2d'),80,56);
    const img=new Image();img.src=c.toDataURL();stampCache[id]=img;
  });
  document.getElementById('tool-rect').style.color='#ff3b30';
  document.getElementById('tool-circle').style.color='#ff3b30';
  document.getElementById('tool-text').style.color='#ff3b30';
  const arrowEl=document.getElementById('tool-arrow');if(arrowEl)arrowEl.style.color='#ff3b30';
  const lineEl=document.getElementById('tool-line');if(lineEl)lineEl.style.color='#ff3b30';
}

if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded',initStamps);
} else {
  initStamps();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP 3: OVERVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderOverview(){
  let html='';
  const activeTypes=[...completedTypes];
  activeTypes.forEach(t=>{
    const def=TYPES[t],items=itemsForTab(t);
    html+=`<div class="ov-block"><div class="ov-btitle">${def.icon} ${def.label}</div>
    ${items.map((item,idx)=>{
      const d=itemData[item.sk]||{photos:[],notes:''};
      const done=d.photos.length>0||d.notes.trim()!=='';
      return `<div class="ov-row">
        <div class="ov-n">${idx+1}</div>
        <div class="ov-c">
          <div class="ov-lbl">${item.label}${item.isShared?'<span class="sbadge" style="margin-left:6px">Gedeeld</span>':''}</div>
          ${d.notes?`<div class="ov-note">üí¨ ${d.notes}</div>`:''}
          ${d.photos.length?`<div class="ov-photos">${d.photos.map(p=>`<img class="ov-ph" src="${p}"/>`).join('')}</div>`:''}
          <div class="ov-st"><div class="stdot" style="background:${done?'var(--success)':'var(--text3)'}"></div>
            <span style="color:${done?'var(--success)':'var(--text3)'}">${done?'Ingevuld':'Leeg'}</span></div>
        </div></div>`;
    }).join('')}</div>`;
  });
  document.getElementById('overview').innerHTML=html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI CHECK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showAICheck(){
  showPanel('panel-ai');
  document.getElementById('btn-run-ai').style.display='inline-block';
  document.getElementById('btn-after-ai').style.display='none';
  document.getElementById('ai-result').innerHTML=`
    <div style="text-align:center;padding:40px 20px">
      <div style="color:var(--text2);font-size:14px">Klik op "Controle uitvoeren" om te beginnen</div>
    </div>`;
  window.scrollTo({top:0,behavior:'smooth'});
}

function runAICheck(){
  document.getElementById('ai-result').innerHTML=`
    <div style="text-align:center;padding:40px 20px">
      <div style="color:var(--text2);font-size:14px">Checklist analyseren...</div>
    </div>`;
  
  setTimeout(()=>{
    const issues=checkCompleteness();
    document.getElementById('btn-run-ai').style.display='none';
    document.getElementById('btn-after-ai').style.display='inline-block';
    
    if(issues.length===0){
      document.getElementById('ai-result').innerHTML=`
        <div style="text-align:center;padding:32px 20px">
          <div style="font-size:48px;margin-bottom:16px">‚úÖ</div>
          <div style="font-size:18px;font-weight:700;color:var(--success);margin-bottom:8px">
            Checklist compleet!
          </div>
          <div style="font-size:14px;color:var(--text2)">
            Alle benodigde informatie is aanwezig voor de technieker.
          </div>
        </div>`;
    } else {
      document.getElementById('ai-result').innerHTML=`
        <div style="padding:20px">
          <div style="font-size:18px;font-weight:700;margin-bottom:16px;color:var(--accent3)">
            ‚ö†Ô∏è Let op: ${issues.length} item${issues.length>1?'s':''} ontbre${issues.length>1?'ken':'ekt'}
          </div>
          <div style="background:var(--surface2);border-radius:var(--radius-sm);padding:16px">
            ${issues.map(i=>`<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:start">
              <div style="color:var(--accent3);font-size:18px;line-height:1">‚Ä¢</div>
              <div style="flex:1">
                <div style="font-size:13px;font-weight:600;margin-bottom:2px">${i.label}</div>
                <div style="font-size:12px;color:var(--text2)">${i.issue}</div>
              </div>
            </div>`).join('')}
          </div>
          <div style="margin-top:16px;padding:12px;background:rgba(247,201,72,0.1);border-radius:var(--radius-sm);
            border:1px solid rgba(247,201,72,0.3);font-size:12px;color:var(--text2)">
            üí° <strong>Tip:</strong> Ga terug en vul de ontbrekende items in voor een complete werkopdracht.
          </div>
        </div>`;
    }
  },1500);
}

function checkCompleteness(){
  const issues=[];
  [...completedTypes].forEach(type=>{
    itemsForTab(type).forEach(item=>{
      const d=itemData[item.sk];
      if(!d || (d.photos.length===0 && d.notes.trim()==='')) {
        issues.push({label:`${TYPES[type].label} - ${item.label}`,issue:'Geen foto\'s of toelichting toegevoegd'});
      }
      if(item.hasStrings && (!d || !d.strings || d.strings.trim()==='')) {
        issues.push({label:`${TYPES[type].label} - ${item.label}`,issue:'Aantal strings niet ingevuld'});
      }
      if(item.hasMppTrackers && (!d || !d.mppTrackers || d.mppTrackers.trim()==='')) {
        issues.push({label:`${TYPES[type].label} - ${item.label}`,issue:'Aantal MPP trackers niet ingevuld'});
      }
    });
  });
  return issues;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generatePDF(){
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF('p','mm','a4');
  const pw=210,ph=297,ml=15,mr=15,mt=20,mb=20;
  const cw=pw-ml-mr;
  let y=mt;

  function addPage(){doc.addPage();y=mt;}
  function checkSpace(need){if(y+need>ph-mb) addPage();}

  // ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ
  function drawHeader(){
    doc.setDrawColor(0,0,0);doc.setLineWidth(0.5);
    doc.line(ml,38,pw-mr,38);
    doc.setTextColor(0,0,0);
    doc.setFontSize(20);doc.setFont('helvetica','bold');
    doc.text('Bezoekrapport',ml,18);
    doc.setFontSize(9);doc.setFont('helvetica','normal');
    doc.setTextColor(100,100,100);
    const now=new Date();
    const dateStr=now.toLocaleDateString('nl-BE',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'});
    doc.text(dateStr,ml,28);
    const klant=document.getElementById('klant-naam');
    const adres=document.getElementById('klant-adres');
    if(klant&&klant.value){
      doc.setTextColor(0,0,0);doc.setFontSize(11);doc.setFont('helvetica','bold');
      doc.text(klant.value,pw-mr,18,{align:'right'});
    }
    if(adres&&adres.value){
      doc.setTextColor(100,100,100);doc.setFontSize(9);doc.setFont('helvetica','normal');
      doc.text(adres.value,pw-mr,28,{align:'right'});
    }
    y=44;
  }

  // ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ
  function drawSection(label){
    checkSpace(16);
    doc.setFillColor(230,230,230);
    doc.roundedRect(ml,y,cw,10,1.5,1.5,'F');
    doc.setTextColor(0,0,0);doc.setFontSize(11);doc.setFont('helvetica','bold');
    doc.text(label,ml+5,y+7);
    y+=14;
  }

  // ‚îÄ‚îÄ ITEM ROW ‚îÄ‚îÄ
  function drawItem(label,data,item){
    const hasPhotos=data.photos&&data.photos.length>0;
    const hasNotes=data.notes&&data.notes.trim()!=='';
    const fields=[];

    if(item.hasFuelType&&data.fuelType){
      const fuelLabel=data.fuelType==='gas'?`Gas: ${data.fuelAmount||'?'} m3/jaar`:`Mazout: ${data.fuelAmount||'?'} L/jaar`;
      fields.push(fuelLabel);
      if(data.buildYear) fields.push(`Bouwjaar: ${data.buildYear}`);
      if(data.insulation) fields.push(`Isolatie: ${data.insulation}`);
      if(data.woningType) fields.push(`Type woning: ${data.woningType}`);
      if(data.heatedFloors) fields.push(`Verwarmde bouwlagen: ${data.heatedFloors}`);
      if(data.totalSqm) fields.push(`Verwarmde oppervlakte: ${data.totalSqm} m¬≤`);
      if(data.boilerTemp) fields.push(`Keteltemperatuur: ${data.boilerTemp}¬∞C`);
    }
    if(item.hasSqm&&data.sqmRows&&data.sqmRows.length>0){
      data.sqmRows.forEach(r=>{if(r.floor&&r.sqm) fields.push(`${r.floor}: ${r.sqm} m2`);});
    }
    if(item.hasRadRows&&data.radRows&&data.radRows.length>0){
      data.radRows.forEach(r=>{if(r.floor&&r.count) fields.push(`${r.floor}: ${r.count} radiator${parseInt(r.count)>1?'en':''}`);});
    }
    if(item.hasFixType&&data.fixType) fields.push(`Bevestiging: ${data.fixType}`);
    if(item.hasUnitType&&data.unitType) fields.push(`Type: ${data.unitType}`);
    if(item.hasConnType&&data.connType) fields.push(`Aansluiting: via ${data.connType}`);
    if(item.hasLocation&&data.location) fields.push(`Locatie: ${data.location}`);
    if(item.hasBoardType&&data.boardType){
      if(data.boardType.moeilijk) fields.push('Moeilijk bord');
      if(data.boardType.extra) fields.push('Extra bord plaatsen');
    }
    if(item.hasStrings&&data.strings) fields.push(`Strings: ${data.strings}`);
    if(item.hasMppTrackers&&data.mppTrackers) fields.push(`MPP trackers: ${data.mppTrackers}`);
    if(item.hasMountType&&data.mountType) fields.push(`Montage: ${data.mountType}`);
    if(item.hasMeterType&&data.meterType){
      data.meterType.forEach(m=>fields.push(m));
    }
    if(item.hasPhaseType&&data.phaseType) fields.push(`Aansluiting: ${data.phaseType}`);

    let blockH=8;
    if(fields.length>0) blockH+=fields.length*5+2;
    if(hasNotes) blockH+=Math.ceil(doc.splitTextToSize(data.notes,cw-12).length*4.5)+4;
    if(hasPhotos) blockH+=42;
    checkSpace(blockH+4);

    // Label bar
    const done=hasPhotos||hasNotes||fields.length>0;
    doc.setFillColor(done?240:250,done?240:250,done?240:250);
    doc.roundedRect(ml,y,cw,7,1,1,'F');
    doc.setFontSize(9);doc.setFont('helvetica','bold');doc.setTextColor(0,0,0);
    doc.text(label,ml+4,y+5);
    doc.setFontSize(8);doc.setFont('helvetica','normal');
    doc.setTextColor(done?0:150,done?150:150,done?0:150);
    doc.text(done?'OK':'NOK',pw-mr-4,y+5,{align:'right'});
    y+=9;

    // Fields
    if(fields.length>0){
      fields.forEach(f=>{
        checkSpace(6);
        doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(60,60,60);
        doc.text(`- ${f}`,ml+6,y+3);
        y+=5;
      });
      y+=1;
    }

    // Notes
    if(hasNotes){
      checkSpace(10);
      doc.setFillColor(245,245,245);
      const lines=doc.splitTextToSize(data.notes,cw-16);
      const noteH=lines.length*4.5+6;
      doc.roundedRect(ml+4,y,cw-8,noteH,1,1,'F');
      doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(40,40,40);
      doc.text(lines,ml+8,y+5);
      y+=noteH+2;
    }

    // Photos - rotated 90 degrees clockwise
    if(hasPhotos){
      const maxPerRow=3;
      const gap=3;
      const imgW=(cw-8-(maxPerRow-1)*gap)/maxPerRow;
      const imgH=38;
      let px=ml+4;
      data.photos.forEach((photo,pi)=>{
        if(pi>0&&pi%maxPerRow===0){
          y+=imgH+gap;px=ml+4;
          checkSpace(imgH+gap);
        }
        try{
          // Rotate image 90 degrees CW by using a canvas
          const img=new Image();
          img.src=photo;
          const c=document.createElement('canvas');
          c.width=img.naturalHeight||img.height||300;
          c.height=img.naturalWidth||img.width||400;
          const ctx=c.getContext('2d');
          ctx.translate(c.width,0);
          ctx.rotate(Math.PI/2);
          ctx.drawImage(img,0,0);
          const rotated=c.toDataURL('image/jpeg',0.8);
          doc.addImage(rotated,'JPEG',px,y,imgW,imgH);
        }catch(e){
          try{doc.addImage(photo,'JPEG',px,y,imgW,imgH);}catch(e2){}
        }
        doc.setDrawColor(200,200,200);doc.rect(px,y,imgW,imgH);
        px+=imgW+gap;
      });
      y+=imgH+4;
    }
    y+=2;
  }

  // ‚îÄ‚îÄ POWER ESTIMATE BOX ‚îÄ‚îÄ
  function drawPowerEstimate(typeKey){
    const calc=calcPowerEstimate(typeKey);
    if(!calc) return;
    checkSpace(32);
    doc.setFillColor(240,248,255);
    doc.roundedRect(ml,y,cw,28,2,2,'F');
    doc.setDrawColor(100,100,100);doc.setLineWidth(0.3);
    doc.roundedRect(ml,y,cw,28,2,2,'S');
    doc.setTextColor(0,0,0);doc.setFontSize(8);doc.setFont('helvetica','bold');
    doc.text('VERMOGENSVOORSTEL',ml+6,y+7);
    doc.setFontSize(18);
    doc.text(`${calc.kw} kW`,ml+6,y+19);
    const detailLines=calc.details.replace(/<br>/g,'\n').replace(/<[^>]+>/g,'').split('\n').filter(l=>l.trim());
    doc.setFontSize(7);doc.setFont('helvetica','normal');doc.setTextColor(60,60,60);
    detailLines.forEach((l,i)=>{doc.text(l.trim(),ml+45,y+7+i*3.5);});
    y+=32;
  }

  // ‚îÄ‚îÄ BUILD PDF ‚îÄ‚îÄ
  drawHeader();
  const activeTypes=[...completedTypes];
  activeTypes.forEach(t=>{
    const def=TYPES[t];
    const items=itemsForTab(t);
    drawSection(def.label);
    items.forEach(item=>{
      if(deletedItems.has(item.sk)) return;
      const d=itemData[item.sk]||{photos:[],notes:''};
      drawItem(item.label,d,item);
      if(item.hasPowerCalc) drawPowerEstimate(t);
    });
    y+=4;
  });

  // ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ
  const pageCount=doc.internal.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setDrawColor(0,0,0);doc.setLineWidth(0.3);
    doc.line(ml,ph-10,pw-mr,ph-10);
    doc.setFontSize(7);doc.setFont('helvetica','normal');doc.setTextColor(120,120,120);
    doc.text(`Pagina ${i} / ${pageCount}`,pw/2,ph-6,{align:'center'});
    doc.text('Plenion Bezoekrapport',ml,ph-6);
    doc.text(new Date().toLocaleDateString('nl-BE'),pw-mr,ph-6,{align:'right'});
  }

  const klantNaam=document.getElementById('klant-naam');
  const filename=klantNaam&&klantNaam.value?`Bezoekrapport_${klantNaam.value.replace(/[^a-zA-Z0-9]/g,'_')}.pdf`:'Bezoekrapport.pdf';
  doc.save(filename);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FINALIZE & RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function finalizeAllReports(){
  const types=[...completedTypes].map(t=>TYPES[t].label).join(', ');
  document.getElementById('suc-msg').textContent=`Alle rapporten (${types}) zijn opgeslagen.`;
  const syncPanel=document.getElementById('sync-status-panel');
  if(syncPanel) syncPanel.innerHTML='‚òÅÔ∏è <strong>Bezig met opslaan naar cloud...</strong>';
  showPanel('panel-4');
  window.scrollTo({top:0,behavior:'smooth'});
  // Firebase: eerst data opslaan, dan foto's uploaden
  saveDataToFirebase().then(()=>{
    if(syncPanel) syncPanel.innerHTML='üì∑ <strong>Foto\'s uploaden...</strong><br><small>Sluit deze pagina niet!</small>';
    return syncPhotosToCloud();
  }).then(()=>{
    if(syncPanel){syncPanel.innerHTML='‚úÖ <strong>Alles gesynchroniseerd!</strong>';syncPanel.style.color='#38d9a9';}
  }).catch(err=>{
    console.error('Sync error:',err);
    if(syncPanel){syncPanel.innerHTML='‚ö†Ô∏è <strong>Sync mislukt</strong><br><small>'+err.message+'</small>';syncPanel.style.color='#ff5c5c';}
  });
}

function reset(){
  // Remove extra split hub cards and types
  for(let i=1;i<=extraSplitCount;i++){
    const key='airmo-'+i;
    const card=document.getElementById('hub-'+key);
    if(card) card.remove();
    delete TYPES[key];
  }
  for(let i=1;i<=extraMultiSplitCount;i++){
    const key='airmu-'+i;
    const card=document.getElementById('hub-'+key);
    if(card) card.remove();
    delete TYPES[key];
  }
  extraSplitCount=0;
  extraMultiSplitCount=0;
  // Reset mono/multi labels
  TYPES['airmo'].label='Lucht/Lucht Mono';
  const monoName=document.querySelector('#hub-airmo .tname');
  if(monoName) monoName.textContent='Lucht/Lucht Mono';
  TYPES['airmu'].label='Lucht/Lucht Multi';
  // Reset airmu items to default 2 binnenunits
  TYPES['airmu'].items=[
    {key:'woning',          label:'Woning',                  shared:true, optional:true},
    {key:'buitenunit-m',    label:'Buitenunit',              shared:false, hasFixType:true},
    {key:'binnenunit-m-1',  label:'Binnenunit 1/2',          shared:false, hasUnitType:true},
    {key:'binnenunit-m-2',  label:'Binnenunit 2/2',          shared:false, hasUnitType:true},
    {key:'elek-aansl-m',    label:'Elektrische aansluiting', shared:false, hasConnType:true},
    {key:'beschrijving-m',  label:'Beschrijving project',    shared:false, noPhoto:true},
  ];
  const multiName=document.querySelector('#hub-airmu .tname');
  if(multiName) multiName.textContent='Lucht/Lucht Multi';
  selected=[];activeTab='';itemData={};completedTypes=new Set();deletedItems=new Set();
  currentDocId=null;
  localStorage.removeItem(LS_KEY);
  const cs=document.getElementById('cloud-status');if(cs)cs.style.display='none';
  ['solar','airmo','airmu','airwater','geo','charge'].forEach(t=>{
    const card=document.getElementById('hub-'+t);
    if(card) card.classList.remove('completed');
    const sc=document.getElementById('scores-'+t);
    if(sc) sc.innerHTML='';
  });
  document.getElementById('hub-save-row').style.display='none';
  showPanel('panel-1');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LS_KEY='bezoekrapport_data';
let currentDocId=null;

function generateDocId(){
  return 'br_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);
}

function setCloudStatus(status,msg){
  const el=document.getElementById('cloud-status');
  if(!el)return;
  el.style.display='inline-block';
  if(status==='syncing'){el.style.background='rgba(247,201,72,.2)';el.style.color='#f7c948';el.style.border='1px solid rgba(247,201,72,.3)';el.textContent='‚òÅÔ∏è '+(msg||'Synchroniseren...');}
  else if(status==='done'){el.style.background='rgba(56,217,169,.15)';el.style.color='#38d9a9';el.style.border='1px solid rgba(56,217,169,.3)';el.textContent='‚òÅÔ∏è '+(msg||'Opgeslagen');setTimeout(()=>{el.style.display='none';},4000);}
  else if(status==='error'){el.style.background='rgba(255,92,92,.15)';el.style.color='#ff5c5c';el.style.border='1px solid rgba(255,92,92,.3)';el.textContent='‚ö†Ô∏è '+(msg||'Sync fout');}
}

function buildSavePayload(){
  const cleanData={};
  for(const [sk,d] of Object.entries(itemData)){
    cleanData[sk]={
      notes:d.notes||'',
      strings:d.strings||'',
      mppTrackers:d.mppTrackers||'',
      location:d.location||'',
      boardType:d.boardType||{},
      mountType:d.mountType||'',
      fixType:d.fixType||'',
      unitType:d.unitType||'',
      connType:d.connType||'',
      sqm:d.sqm||'',
      floor:d.floor||'',
      sqmRows:d.sqmRows||[],
      radRows:d.radRows||[],
      fuelType:d.fuelType||'',
      fuelAmount:d.fuelAmount||'',
      buildYear:d.buildYear||'',
      meterType:d.meterType||[],
      phaseType:d.phaseType||'',
      insulation:d.insulation||'',
      woningType:d.woningType||'',
      heatedFloors:d.heatedFloors||'',
      totalSqm:d.totalSqm||'',
      boilerTemp:d.boilerTemp||'',
      batType:d.batType||'',
      batVerbruik:d.batVerbruik||'',
      batProductie:d.batProductie||'',
      batAfname:d.batAfname||'',
      batInjectie:d.batInjectie||'',
      batCalcSkipped:d.batCalcSkipped||false,
      photoCount:(d.photos||[]).length,
      storageUrls:(d.storageUrls||[]).filter(u=>u&&u.startsWith('http'))
    };
  }
  return {
    klantNaam:document.getElementById('klant-naam')?.value||'',
    klantAdres:document.getElementById('klant-adres')?.value||'',
    completedTypes:[...completedTypes],
    deletedItems:[...deletedItems],
    selected:selected,
    itemData:JSON.stringify(cleanData),
    extraSplitCount:extraSplitCount,
    extraMultiSplitCount:extraMultiSplitCount,
    updatedAt:new Date().toISOString(),
    createdAt:currentDocId?undefined:new Date().toISOString()
  };
}

async function saveDataToFirebase(){
  try{
    setCloudStatus('syncing','Opslaan naar cloud...');
    if(!currentDocId)currentDocId=generateDocId();
    const payload=buildSavePayload();
    Object.keys(payload).forEach(k=>payload[k]===undefined&&delete payload[k]);
    await db.collection('bezoekrapport').doc(currentDocId).set(payload,{merge:true});
    saveToLocalStorage();
    setCloudStatus('done','Opgeslagen in cloud');
    return true;
  }catch(err){
    console.error('Firebase save error:',err);
    setCloudStatus('error','Cloud opslaan mislukt');
    saveToLocalStorage();
    return false;
  }
}

function saveToLocalStorage(){
  try{
    const data={
      docId:currentDocId,
      klantNaam:document.getElementById('klant-naam')?.value||'',
      klantAdres:document.getElementById('klant-adres')?.value||'',
      completedTypes:[...completedTypes],
      deletedItems:[...deletedItems],
      selected:selected,
      itemData:itemData,
      extraSplitCount:extraSplitCount,
      extraMultiSplitCount:extraMultiSplitCount,
      savedAt:new Date().toISOString()
    };
    localStorage.setItem(LS_KEY,JSON.stringify(data));
  }catch(e){console.warn('localStorage save error:',e);}
}

function loadFromLocalStorage(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(!raw)return false;
    const data=JSON.parse(raw);
    if(!data||!data.itemData)return false;
    if(data.docId)currentDocId=data.docId;
    if(data.klantNaam){const el=document.getElementById('klant-naam');if(el)el.value=data.klantNaam;}
    if(data.klantAdres){const el=document.getElementById('klant-adres');if(el)el.value=data.klantAdres;}
    if(data.completedTypes)completedTypes=new Set(data.completedTypes);
    if(data.deletedItems)deletedItems=new Set(data.deletedItems);
    if(data.selected)selected=data.selected;
    if(data.extraSplitCount)extraSplitCount=data.extraSplitCount;
    if(data.extraMultiSplitCount)extraMultiSplitCount=data.extraMultiSplitCount;
    itemData=data.itemData;
    return true;
  }catch(e){console.warn('localStorage load error:',e);return false;}
}

async function syncPhotosToCloud(){
  if(!currentDocId)return;
  let uploadCount=0,errorCount=0,totalPhotos=0;
  const syncPanel=document.getElementById('sync-status-panel');

  // Tel totaal foto's
  for(const [sk,d] of Object.entries(itemData)){
    if(!d||!d.photos)continue;
    for(let i=0;i<d.photos.length;i++){
      if(typeof d.photos[i]==='string'&&d.photos[i].startsWith('data:'))totalPhotos++;
    }
  }
  if(totalPhotos===0){
    if(syncPanel){syncPanel.innerHTML='‚úÖ <strong>Opgeslagen!</strong>';syncPanel.style.color='#38d9a9';}
    return;
  }
  if(syncPanel)syncPanel.innerHTML=`üì∑ <strong>Foto's uploaden: 0/${totalPhotos}</strong><br><small>Niet sluiten!</small>`;

  for(const [sk,d] of Object.entries(itemData)){
    if(!d||!d.photos||d.photos.length===0)continue;
    if(!d.storageUrls)d.storageUrls=[];

    for(let i=0;i<d.photos.length;i++){
      const photo=d.photos[i];
      if(typeof photo==='string'&&photo.startsWith('http'))continue;
      if(d.storageUrls[i]&&d.storageUrls[i].startsWith('http'))continue;
      if(typeof photo!=='string'||!photo.startsWith('data:'))continue;

      try{
        const ts=Date.now()+'_'+Math.random().toString(36).substr(2,5)+'_'+i;
        const safeSk=sk.replace(/[^a-zA-Z0-9_-]/g,'_');
        const path=`bezoekrapport/${currentDocId}/${safeSk}/${ts}.jpg`;
        const ref=storage.ref(path);

        // Base64 naar blob
        const parts=photo.split(',');
        const mime=parts[0].match(/:(.*?);/)?.[1]||'image/jpeg';
        const byteString=atob(parts[1]);
        const ab=new ArrayBuffer(byteString.length);
        const ia=new Uint8Array(ab);
        for(let j=0;j<byteString.length;j++)ia[j]=byteString.charCodeAt(j);
        const blob=new Blob([ab],{type:mime});

        const snapshot=await ref.put(blob,{contentType:mime});
        const url=await snapshot.ref.getDownloadURL();
        d.storageUrls[i]=url;
        uploadCount++;

        setCloudStatus('syncing',`${uploadCount}/${totalPhotos} foto's...`);
        if(syncPanel)syncPanel.innerHTML=`üì∑ <strong>Foto's uploaden: ${uploadCount}/${totalPhotos}</strong><br><small>Niet sluiten!</small>`;
      }catch(err){
        console.error(`FOTO UPLOAD FOUT [${sk}][${i}]:`,err.code,err.message);
        errorCount++;
      }
    }
  }

  // Update Firestore met storageUrls
  if(uploadCount>0){
    try{
      const payload=buildSavePayload();
      await db.collection('bezoekrapport').doc(currentDocId).update({
        itemData:payload.itemData,
        updatedAt:new Date().toISOString()
      });
    }catch(err){console.error('Firestore update na foto upload:',err);}
  }
  saveToLocalStorage();

  if(errorCount>0){
    setCloudStatus('error',`${uploadCount} OK, ${errorCount} mislukt`);
    if(syncPanel){syncPanel.innerHTML=`‚ö†Ô∏è <strong>${uploadCount} ge√ºpload, ${errorCount} mislukt</strong>`;syncPanel.style.color='#ff5c5c';}
  }else{
    setCloudStatus('done',`${uploadCount} foto's ge√ºpload`);
    if(syncPanel){syncPanel.innerHTML=`‚úÖ <strong>Alles gesynchroniseerd! (${uploadCount} foto's)</strong>`;syncPanel.style.color='#38d9a9';}
  }
}

// ‚îÄ‚îÄ INIT: LAAD DATA ‚îÄ‚îÄ
(function(){loadFromLocalStorage();})();

// Init
updateHubCards();
</script>
<div class="toast-inline" id="global-toast"></div>
</body>
</html>
